<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - NewCo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #10b981;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .form-toggle-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-toggle-group .form-label {
            margin: 0;
            flex: 1;
        }
        
        .form-toggle-group .toggle-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
    </style>
    
    <!-- 
    ╔═══════════════════════════════════════════════════════════════════╗
    ║              NEWCO ADMIN PANEL - COMPLETE CONTROL CENTER            ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║ FILE: bms-admin-new.html (13,543 lines)                          ║
    ║ PURPOSE: Central administration for entire NewCo ecosystem          ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║                                                                   ║
    ║ FILE STRUCTURE:                                                   ║
    ║ • Lines 9-73:       Toggle switch styles (critical inline CSS)   ║
    ║ • Lines 75-500:     NewcoData storage system                  ║
    ║ • Line 500:         Link to newco-admin.css (1,098 lines)          ║
    ║ • Lines 501-2800:   HTML structure & sidebar                     ║
    ║ • Lines 2800-8200:  Content sections (all modules)               ║
    ║ • Lines 8200-13543: JavaScript functions & event handlers        ║
    ║                                                                   ║
    ║ EXTERNAL DEPENDENCIES:                                            ║
    ║ • newco-admin.css     - All component styles (1,098 lines)         ║
    ║ • Google Fonts      - Inter font family                          ║
    ║ • No frameworks     - Pure vanilla JS/HTML/CSS                   ║
    ║                                                                   ║
    ║ KEY SECTIONS (use Ctrl+F to navigate):                           ║
    ║ • [VANGUARD-DATA]   - LocalStorage data layer (Line 123)         ║
    ║ • [DASHBOARD]       - Stats & quick actions                      ║
    ║ • [ORGANIZATION]    - Branding & basic settings                  ║
    ║ • [STAFF-MGMT]      - Staff users & permissions                  ║
    ║ • [MEMBERS-MGMT]    - Customer database                          ║
    ║ • [HALLS-LAYOUT]    - Hall configuration & seat designer         ║
    ║ • [SESSION-WIZARD]  - Session creation wizard                    ║
    ║ • [SCHEDULE-MGMT]   - Calendar & scheduling                      ║
    ║ • [PACKAGES-ITEMS]  - Products & pricing                         ║
    ║ • [REWARDS-SYSTEM]  - Loyalty points & tiers                     ║
    ║ • [TRANSACTIONS]    - Sales & transaction logs                   ║
    ║ • [REPORTS]         - Analytics & reporting                      ║
    ║ • [WEB-BUILDER]     - Customer website generator                 ║
    ║ • [ACTIONS-LOG]     - Audit trail & history                      ║
    ║                                                                   ║
    ║ DATA FLOW:                                                        ║
    ║ • WRITES TO: All newco_ localStorage keys                     ║
    ║ • CONSUMED BY:                                                    ║
    ║   - newco-customer-demo-v2.2.html (public website)               ║
    ║   - newco-redemption-v2.2.html (POS system)                      ║
    ║   - newco-floor-runner-v2.2.html (cash rewards)                  ║
    ║                                                                   ║
    ║ TECHNICAL STATUS:                                                 ║
    ║ ✅ COMPLETED:                                                     ║
    ║ • CSS extracted to external file                                 ║
    ║ • Full CRUD operations for all entities                          ║
    ║ • Real-time preview for website builder                          ║
    ║ • Comprehensive audit logging                                    ║
    ║                                                                   ║
    ║ 🔴 CRITICAL IMPROVEMENTS NEEDED:                                 ║
    ║ • Split into modules (too monolithic at 13K+ lines)              ║
    ║ • Add authentication system                                      ║
    ║ • Migrate to IndexedDB (localStorage limits)                     ║
    ║                                                                   ║
    ║ 🟡 ENHANCEMENTS:                                                 ║
    ║ • Add TypeScript for type safety                                 ║
    ║ • Implement lazy loading for sections                            ║
    ║ • Add data validation layer                                      ║
    ║ • Create reusable components                                     ║
    ║ • Add unit tests                                                 ║
    ║                                                                   ║
    ║ DEVELOPER NOTES:                                                  ║
    ║ • Each section is self-contained with its own load function      ║
    ║ • NewcoData handles all localStorage operations               ║
    ║ • Actions are logged automatically via NewcoData.set()        ║
    ║ • Theme colors are CSS variables, updated dynamically            ║
    ╚═══════════════════════════════════════════════════════════════════╝
    -->

    <script src="newco-supabase.js"></script>
    <script>
        /*
        // [VANGUARD-DATA] - Embedded NewcoData - REPLACED WITH SUPABASE VERSION
        const NewcoData = {
            DB_PREFIX: 'newco_',
            
            init() {
                const defaults = {
                    organization: {
                        name: '',
                        logo: '',
                        address: '',
                        phone: '',
                        email: '',
                        website: '',
                        tagline: 'Your Premier Bingo Destination',
                        colors: {
                            primary: '#667eea',
                            secondary: '#f59e0b',
                            accent: '#48bb78'
                        }
                    },
                    halls: [],
                    sessions: [],
                    packages: [],
                    rewards: {
                        items: [],
                        coupons: [],
                        pointsConfig: {
                            dollarToPoints: 10,
                            bonusRules: []
                        }
                    },
                    schedule: {
                        weekly: {},
                        special: []
                    },
                    settings: {
                        timezone: 'America/Los_Angeles',
                        currency: 'USD',
                        dateFormat: 'MM/DD/YYYY'
                    }
                };
                
                Object.keys(defaults).forEach(key => {
                    if (!this.get(key)) {
                        this.set(key, defaults[key]);
                    }
                });
            },
            
            get(key) {
                try {
                    const data = localStorage.getItem(this.DB_PREFIX + key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Error reading data:', e);
                    return null;
                }
            },
            
            set(key, value, skipLogging = false, detailMessage = null) {
                try {
                    const jsonString = JSON.stringify(value);
                    
                    // Art data should not be stored in localStorage - it's kept in memory only
                    // If data is still too large after removing art data, it indicates a problem
                    if (jsonString.length > 2000000) {
                        console.warn('Data too large for localStorage even without art data:', key, jsonString.length);
                        throw new Error('Data too large for localStorage');
                    } else {
                        // Get old value for comparison
                        const oldValue = this.get(key);
                        
                        localStorage.setItem(this.DB_PREFIX + key, jsonString);
                        
                        // Log the action unless explicitly skipped
                        if (!skipLogging && key !== 'actionsLog') {
                            let details = detailMessage || `Updated ${key}`;
                            
                            // Try to be more specific based on what changed
                            if (!detailMessage) {
                                details = this.getChangeDetails(key, oldValue, value);
                            }
                            
                            this.logAction('update', key, details);
                        }
                    }
                    return true;
                } catch (e) {
                    console.error('Error saving data:', e);
                    
                    // Try to clear old/unused data
                    this.clearOldData();
                    
                    // Try one more time
                    try {
                        localStorage.setItem(this.DB_PREFIX + key, JSON.stringify(value));
                        return true;
                    } catch (e2) {
                        // Silently fail - data just won't persist
                        console.warn('Could not save to localStorage');
                        return false;
                    }
                }
            },
            
            clearOldData() {
                // Clear old or temporary data to free up space
                const keysToCheck = ['temp_', 'backup_', 'old_', 'logo_data'];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && keysToCheck.some(prefix => key.includes(prefix))) {
                        localStorage.removeItem(key);
                    }
                }
            },
            
            getOrganization() {
                return this.get('organization');
            },
            
            updateOrganization(updates) {
                const org = this.getOrganization() || {};
                return this.set('organization', { ...org, ...updates });
            },
            
            getHalls() {
                return this.get('halls') || [];
            },
            
            getSessions() {
                return this.get('sessions') || [];
            },
            
            getPackages() {
                const packages = this.get('packages') || [];
                return packages.sort((a, b) => (a.order || 0) - (b.order || 0));
            },
            
            addPackage(pkg) {
                const packages = this.getPackages();
                pkg.id = pkg.id || Date.now().toString();
                packages.push(pkg);
                return this.set('packages', packages);
            },
            
            updatePackage(id, updates) {
                const packages = this.getPackages();
                const index = packages.findIndex(p => p.id === id);
                if (index !== -1) {
                    packages[index] = { ...packages[index], ...updates };
                    return this.set('packages', packages);
                }
                return false;
            },
            
            removePackage(id) {
                const packages = this.getPackages();
                const filtered = packages.filter(p => p.id !== id);
                return this.set('packages', filtered);
            },
            
            // Get detailed change description
            getChangeDetails(key, oldValue, newValue) {
                try {
                    switch(key) {
                        case 'organization':
                            const changes = [];
                            if (!oldValue) return 'Initial organization setup';
                            
                            if (oldValue.name !== newValue.name) {
                                changes.push(`Changed name from "${oldValue.name || 'none'}" to "${newValue.name}"`);
                            }
                            if (oldValue.tagline !== newValue.tagline) {
                                changes.push(`Updated tagline to "${newValue.tagline}"`);
                            }
                            if (oldValue.email !== newValue.email) {
                                changes.push(`Changed email to "${newValue.email}"`);
                            }
                            if (oldValue.phone !== newValue.phone) {
                                changes.push(`Changed phone to "${newValue.phone}"`);
                            }
                            if (oldValue.address !== newValue.address) {
                                changes.push(`Updated address`);
                            }
                            if (JSON.stringify(oldValue.colors) !== JSON.stringify(newValue.colors)) {
                                changes.push(`Changed theme colors`);
                            }
                            if (oldValue.logo !== newValue.logo) {
                                changes.push(`Updated logo`);
                            }
                            
                            return changes.length > 0 ? changes.join(', ') : 'Updated organization settings';
                            
                        case 'staff':
                            if (!oldValue || oldValue.length === 0) return 'Added first staff member';
                            if (newValue.length > oldValue.length) {
                                const newStaff = newValue[newValue.length - 1];
                                return `Added staff member: ${newStaff.name} (${newStaff.role})`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed staff member`;
                            }
                            return 'Updated staff information';
                            
                        case 'members':
                            if (!oldValue || oldValue.length === 0) return 'Added first member';
                            if (newValue.length > oldValue.length) {
                                const newMember = newValue[newValue.length - 1];
                                return `Added member: ${newMember.firstName} ${newMember.lastName}`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed member`;
                            }
                            return 'Updated member information';
                            
                        case 'packages':
                            if (!oldValue || oldValue.length === 0) return 'Created first package';
                            if (newValue.length > oldValue.length) {
                                const newPkg = newValue[newValue.length - 1];
                                return `Added package: ${newPkg.name} ($${newPkg.price})`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed package`;
                            }
                            return 'Modified package details';
                            
                        case 'salesItems':
                            if (!oldValue || oldValue.length === 0) return 'Added first sales item';
                            if (newValue.length > oldValue.length) {
                                const newItem = newValue[newValue.length - 1];
                                return `Added item: ${newItem.name} ($${newItem.price})`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed sales item`;
                            }
                            return 'Updated sales item';
                            
                        case 'halls':
                            if (!oldValue || oldValue.length === 0) return 'Created first hall';
                            if (newValue.length > oldValue.length) {
                                const newHall = newValue[newValue.length - 1];
                                return `Added hall: ${newHall.name}`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed hall`;
                            }
                            // Check for layout changes
                            for (let i = 0; i < newValue.length; i++) {
                                if (oldValue[i] && JSON.stringify(oldValue[i].layout) !== JSON.stringify(newValue[i].layout)) {
                                    return `Modified layout for ${newValue[i].name}`;
                                }
                            }
                            return 'Updated hall configuration';
                            
                        case 'schedules':
                            return 'Updated session schedule times';
                            
                        case 'rewardsConfig':
                            const rewardChanges = [];
                            if (!oldValue) return 'Initial rewards configuration';
                            
                            if (oldValue.basicSettings?.pointsPerDollar !== newValue.basicSettings?.pointsPerDollar) {
                                rewardChanges.push(`Changed points per dollar to ${newValue.basicSettings?.pointsPerDollar}`);
                            }
                            if (oldValue.basicSettings?.pointsCurrencyName !== newValue.basicSettings?.pointsCurrencyName) {
                                rewardChanges.push(`Renamed points to "${newValue.basicSettings?.pointsCurrencyName}"`);
                            }
                            
                            return rewardChanges.length > 0 ? rewardChanges.join(', ') : 'Updated rewards configuration';
                            
                        case 'settings':
                            const settingChanges = [];
                            if (!oldValue) return 'Initial settings configuration';
                            
                            if (oldValue.timezone !== newValue.timezone) {
                                settingChanges.push(`Changed timezone to ${newValue.timezone}`);
                            }
                            if (oldValue.currency !== newValue.currency) {
                                settingChanges.push(`Changed currency to ${newValue.currency}`);
                            }
                            if (oldValue.maxSeatsPerUser !== newValue.maxSeatsPerUser) {
                                settingChanges.push(`Changed max seats per user to ${newValue.maxSeatsPerUser}`);
                            }
                            
                            return settingChanges.length > 0 ? settingChanges.join(', ') : 'Updated system settings';
                            
                        case 'transactions':
                            if (!oldValue || oldValue.length === 0) return 'First transaction recorded';
                            if (newValue.length > oldValue.length) {
                                const newTrans = newValue[newValue.length - 1];
                                return `New transaction: $${newTrans.amount} from ${newTrans.memberName || 'Guest'}`;
                            }
                            return 'Transaction status updated';
                            
                        default:
                            return `Updated ${key}`;
                    }
                } catch (e) {
                    console.error('Error getting change details:', e);
                    return `Updated ${key}`;
                }
            },
            
            // Actions Log functions
            logAction(actionType, section, details) {
                try {
                    const actionsLog = this.get('actionsLog') || [];
                    const currentUser = sessionStorage.getItem('newco_current_user') || 'Admin';
                    
                    const action = {
                        id: 'action_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        user: currentUser,
                        actionType: actionType,
                        section: section,
                        details: details
                    };
                    
                    actionsLog.unshift(action); // Add to beginning
                    
                    // Keep only last 1000 actions
                    if (actionsLog.length > 1000) {
                        actionsLog.splice(1000);
                    }
                    
                    // Save without triggering another log
                    localStorage.setItem(this.DB_PREFIX + 'actionsLog', JSON.stringify(actionsLog));
                } catch (e) {
                    console.error('Error logging action:', e);
                }
            }
        };
        */

        // Initialize NewcoData (async)
        (async () => {
            await NewcoData.init();
            console.log('NewcoData initialized');

            // Update org name in sidebar after init completes
            const org = NewcoData.get('organization');
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName && org && org.name) {
                sidebarOrgName.textContent = org.name;
                document.title = org.name + ' - Management System';
            }
        })();

        // Apply saved branding on load
        function applyBrandingColors() {
            const org = NewcoData.get('organization') || {};
            
            // Apply colors
            if (org?.colors) {
                document.documentElement.style.setProperty('--primary', org.colors.primary || '#2ea3f2');
                document.documentElement.style.setProperty('--primary-dark', adjustColor(org.colors.primary || '#2ea3f2', -30));
                document.documentElement.style.setProperty('--primary-light', adjustColor(org.colors.primary || '#2ea3f2', 80));
                document.documentElement.style.setProperty('--secondary', org.colors.secondary || '#9c27b0');
                document.documentElement.style.setProperty('--accent', org.colors.accent || org.colors.secondary || '#9c27b0');
            }
            
            // Apply logo to sidebar
            const sidebarLogo = document.getElementById('sidebarLogo');
            if (sidebarLogo) {
                if (org?.logo) {
                    sidebarLogo.innerHTML = `<img src="${org.logo}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                } else {
                    sidebarLogo.innerHTML = '🎱';
                }
            }
            
            // Apply organization name to sidebar
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName && org?.name) {
                sidebarOrgName.textContent = org.name;
            }
        }
        
        // Helper to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16),
                amt = Math.round(2.55 * percent),
                R = (num >> 16) + amt,
                G = (num >> 8 & 0x00FF) + amt,
                B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
        }
    </script>
    <!-- External CSS -->
    <link rel="stylesheet" href="newco-admin.css">
    <style>
        /* Fix for content width - override to use full available space */
        .main-content {
            width: calc(100% - 280px) !important;
            max-width: 100% !important;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="adminLoginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 450px; width: 100%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🔐</div>
                <h1 style="margin: 0; font-size: 1.75rem; color: #1f2937;">Admin Portal</h1>
                <p id="orgNameDisplay" style="margin: 0.5rem 0 0 0; color: #6b7280; font-weight: 500;">Loading...</p>
            </div>

            <!-- First-time login hint -->
            <div id="firstTimeHint" style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: none;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <span style="font-size: 1.25rem;">💡</span>
                    <div style="font-size: 0.875rem; color: #92400e;">
                        <strong style="display: block; margin-bottom: 0.25rem;">First time logging in?</strong>
                        Use your email as both the username and password. You'll be prompted to set a secure password after login.
                    </div>
                </div>
            </div>

            <form id="adminLoginForm" onsubmit="return checkAdminPassword(event);" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Email</label>
                    <input
                        type="email"
                        id="adminEmailInput"
                        placeholder="admin@example.com"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                        required
                        autofocus
                    >
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Password</label>
                    <input
                        type="password"
                        id="adminPasswordInput"
                        placeholder="Enter your password"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                        required
                    >
                    <small id="passwordHint" style="color: #6b7280; font-size: 0.75rem; display: none; margin-top: 0.25rem;">First time? Use your email as password</small>
                </div>
                <div id="loginError" style="color: #dc2626; font-size: 0.875rem; text-align: center; display: none;"></div>
                <button
                    type="submit"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.875rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'"
                >
                    Sign In
                </button>
            </form>
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 0.875rem;">
                Powered by NewCo
            </div>
        </div>
    </div>

    <!-- Main Admin Panel (hidden until login) -->
    <div id="adminMainPanel" style="display: none; flex-direction: row; width: 100%; min-height: 100vh;">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon" id="sidebarLogo">
                    🎱
                </div>
                <span id="sidebarOrgName">Admin Panel</span>
            </div>
            <div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">
                Powered by NewCo
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    📊 Dashboard
                </a>
                <a href="#branding" class="nav-item" data-section="branding" style="position: relative;">
                    🎨 Branding
                    <span class="start-here-indicator" style="top: -8px; right: -85px;">Start Here!</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Store Operations</div>
                <a href="#halls" class="nav-item" data-section="halls" style="position: relative;">
                    🏛️ Hall & Layout
                    <span class="start-here-indicator" style="top: -8px; right: -85px;">Start Here!</span>
                </a>
                <a href="#schedule" class="nav-item" data-section="schedule">
                    📅 Schedule
                </a>
                <a href="#redemption" class="nav-item" data-section="redemption">
                    🎟️ Redemption
                </a>
                <a href="#purchasing" class="nav-item" data-section="purchasing">
                    🛍️ Purchasing
                </a>
                <a href="#floor-rewards" class="nav-item" data-section="floor-rewards" style="display: none;">
                    ⭐ Floor Rewards
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Offerings</div>
                <a href="#salesItems" class="nav-item" data-section="salesItems" style="position: relative;">
                    🛒 Basic Offerings
                    <span style="position: absolute; left: -30px; top: 50%; transform: translateY(-50%); color: var(--warning); font-size: 1.2rem; animation: pulse 2s infinite;">→</span>
                    <span style="position: absolute; left: -80px; top: -25px; background: var(--warning); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; white-space: nowrap;">Start Here!</span>
                </a>
                <a href="#packages" class="nav-item" data-section="packages">
                    📦 Packages
                </a>
                <a href="#loyaltyItems" class="nav-item" data-section="loyaltyItems">
                    🎁 Loyalty Items
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Member Management</div>
                <a href="#members" class="nav-item" data-section="members">
                    👥 Members Database
                </a>
                <a href="#rewards" class="nav-item" data-section="rewards" style="position: relative;">
                    🎁 Rewards Program
                    <span class="start-here-indicator" style="top: -8px; right: -85px;">Start Here!</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Marketing Tools</div>
                <a href="#pagebuilder" class="nav-item" data-section="pagebuilder">
                    🌐 Web Templates
                </a>
                <a href="#webbuilder" class="nav-item" data-section="webbuilder" style="display: none;">
                    🔧 Web Builder
                </a>
                <a href="#socialmedia" class="nav-item" data-section="socialmedia">
                    📱 Social Media
                </a>
                <a href="#marketing" class="nav-item" data-section="marketing">
                    📢 Marketing
                </a>
                <a href="#marketing" class="nav-item" data-section="marketing" style="display: none;">
                    📧 Email Campaigns
                </a>
                <a href="#themes" class="nav-item" data-section="themes" style="display: none;">
                    🎭 Themes
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Operations</div>
                <a href="#staff" class="nav-item" data-section="staff">
                    👤 Staff
                </a>
                <a href="#artlibrary" class="nav-item" data-section="artlibrary" style="display: none;">
                    🎨 Art Library
                </a>
                <a href="#integrations" class="nav-item" data-section="integrations" style="display: none;">
                    🔗 Integrations
                </a>
                <a href="#transactions" class="nav-item" data-section="transactions">
                    💳 Transactions Log
                </a>
                <a href="#rewardstransactions" class="nav-item" data-section="rewardstransactions">
                    🏆 Rewards Transactions
                </a>
                <a href="javascript:void(0)" class="nav-item" data-section="actionslog" onclick="showComingSoon('Actions Log')">
                    📋 Actions Log
                </a>
                <a href="javascript:void(0)" class="nav-item" data-section="reports" onclick="showComingSoon('Reports')">
                    📈 Reports
                </a>
                <a href="#settings" class="nav-item" data-section="settings">
                    ⚙️ Settings
                </a>
            </div>
        </nav>
    </aside>

    <!-- ═══════════════════════════════════════════════════════════════════
         MAIN CONTENT AREA - All Admin Panel Sections
         ═══════════════════════════════════════════════════════════════════ -->
    <!-- Main Content Area -->
    <main class="main-content">
        <!-- ═══════════════════════════════════════════════════════════════════
             DASHBOARD SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-panel active">
            <div class="header-bar">
                <h1 class="header-title">Dashboard</h1>
                <div class="header-actions">
                    <span id="lastSaved" style="color: var(--gray); font-size: 0.875rem;">
                        Auto-save enabled
                    </span>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        🔄 Refresh
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-card" onclick="showSection('sessions')">
                    <div class="quick-action-icon">➕</div>
                    <div class="quick-action-label">New Session</div>
                </div>
                <div class="quick-action-card" onclick="showSection('bookings')">
                    <div class="quick-action-icon">🎟️</div>
                    <div class="quick-action-label">View Bookings</div>
                </div>
                <div class="quick-action-card" onclick="showSection('members')">
                    <div class="quick-action-icon">👤</div>
                    <div class="quick-action-label">Add Member</div>
                </div>
                <div class="quick-action-card" onclick="showSection('reports')">
                    <div class="quick-action-icon">📊</div>
                    <div class="quick-action-label">Run Report</div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today's Revenue</div>
                    <div class="stat-value">$0</div>
                    <div class="stat-change positive">↑ 0% from yesterday</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Sessions</div>
                    <div class="stat-value">0</div>
                    <div class="stat-change">0 upcoming today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Members</div>
                    <div class="stat-value">0</div>
                    <div class="stat-change positive">↑ 0 new this week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Occupancy Rate</div>
                    <div class="stat-value">0%</div>
                    <div class="stat-change">0 seats filled</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Activity</h2>
                    <p class="section-subtitle">Latest bookings and member activity</p>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable">
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--gray);">
                                No recent activity
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             BRANDING SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Branding Section -->
        <section id="branding" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Branding & Identity</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="saveBranding()">
                        💾 Save Branding
                    </button>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Logo</h2>
                    <p class="section-subtitle">Your organization's visual identity</p>
                </div>
                
                <div style="display: flex; gap: 2rem; align-items: center;">
                    <div id="logoPreview" style="width: 200px; height: 140px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                        🎱
                    </div>
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label class="form-label">Upload Logo</label>
                            <input type="file" class="form-input" id="logoUpload" accept="image/*" onchange="handleLogoUpload(event)">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                Recommended: Square image, at least 200x200px
                            </p>
                        </div>
                        <button class="btn btn-secondary" onclick="resetLogo()">
                            Remove Logo
                        </button>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Brand Colors</h2>
                    <p class="section-subtitle">Define your color scheme</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Primary Color</label>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="color" class="form-input" id="brandPrimaryColor" value="#2ea3f2" onchange="updateBrandPreview()" style="width: 80px; height: 50px;">
                            <input type="text" class="form-input" id="brandPrimaryHex" value="#2ea3f2" onchange="updateColorFromHex('primary')">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Secondary Color</label>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="color" class="form-input" id="brandSecondaryColor" value="#9c27b0" onchange="updateBrandPreview()" style="width: 80px; height: 50px;">
                            <input type="text" class="form-input" id="brandSecondaryHex" value="#9c27b0" onchange="updateColorFromHex('secondary')">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-lighter); border-radius: 8px;">
                    <p style="font-size: 0.875rem; color: var(--gray); margin-bottom: 1rem;">Preview:</p>
                    <div style="display: flex; gap: 1rem;">
                        <div id="primaryPreview" style="width: 60px; height: 60px; border-radius: 8px; background: var(--primary);"></div>
                        <div id="secondaryPreview" style="width: 60px; height: 60px; border-radius: 8px; background: var(--secondary);"></div>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Brand Messaging</h2>
                    <p class="section-subtitle">Your organization's voice</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Organization Name</label>
                        <input type="text" class="form-input" id="brandOrgName" placeholder="Your Charity Name">
                    </div>
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Tagline</label>
                        <input type="text" class="form-input" id="brandTagline" placeholder="Marketing tagline">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            This appears on your booking page and marketing materials
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             SCHEDULE SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Schedule Section -->
        <section id="schedule" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Schedule Management</h1>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Weekly Schedule</h2>
                    <p class="section-subtitle">Assign sessions to specific days</p>
                </div>
                
                <div id="scheduleContainer">
                    <!-- Schedule will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Redemption Section -->
        <section id="redemption" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Redemption Settings</h1>
            </div>
            
            <div class="content-main">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <strong>Enable Redemption System</strong>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableRedemption" onchange="toggleRedemptionSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                        <div id="redemptionSettings" style="display: flex; gap: 0.5rem; align-items: center; margin-left: 1rem;">
                            <span style="color: var(--gray); font-size: 0.875rem;">Minimum role:</span>
                            <select class="form-input" id="redemptionPermissionLevel" style="width: 150px;">
                                <option value="Cashier">Cashier</option>
                                <option value="Staff" selected>Staff</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 2rem; align-items: center; margin-top: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span>Require ID Verification</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="requireIdVerification" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span>Send SMS/Email when ready</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sendRedemptionNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <select class="form-input" id="redemptionMode" style="width: 160px;">
                                <option value="pickup">Customer Pickup</option>
                                <option value="willcall">Will Call Window</option>
                                <option value="delivery">Delivery Service</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <label class="form-label">Redemption Window Hours</label>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="time" class="form-input" id="redemptionStartTime" value="09:00" style="width: 120px;">
                            <span style="color: var(--gray);">to</span>
                            <input type="time" class="form-input" id="redemptionEndTime" value="17:00" style="width: 120px;">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--primary-light); border-radius: 12px; border: 2px solid var(--primary);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--primary);">Launch Redemption</h3>
                        <button class="btn btn-primary" onclick="openRedemptionApp()" style="width: 100%; padding: 1.25rem; font-size: 1.2rem; font-weight: 600; background: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            🎟️ Open Redemption
                        </button>
                        <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                            <label style="font-size: 0.875rem; color: var(--gray); display: block; margin-bottom: 0.5rem;">Direct Link (copy and share):</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="redemptionAppLink" value="file:///C:/Users/aring/NewCo/newco-redemption-v2.2.html?mode=redemption" readonly style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                                <button class="btn btn-outline" onclick="copyRedemptionLink()" style="padding: 0.5rem 1rem;">📋 Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Purchasing Section -->
        <section id="purchasing" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Purchasing Settings</h1>
            </div>
            
            <div class="content-main">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <strong>Enable In-Person Purchasing</strong>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enablePurchasing" onchange="togglePurchasingSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                        <div id="purchasingSettings" style="display: flex; gap: 0.5rem; align-items: center; margin-left: 1rem;">
                            <span style="color: var(--gray); font-size: 0.875rem;">Minimum role:</span>
                            <select class="form-input" id="purchasingPermissionLevel" style="width: 150px;">
                                <option value="Cashier" selected>Cashier</option>
                                <option value="Staff">Staff</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 2rem; align-items: center; margin-top: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span>Print Receipts Automatically</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="printReceipts" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span>Email Receipts</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="emailReceipts">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div style="padding: 1.5rem; background: var(--success-light); border-radius: 12px; border: 2px solid var(--success);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--success);">Launch Purchasing</h3>
                        <button class="btn" onclick="openPurchasingApp()" style="width: 100%; padding: 1.25rem; font-size: 1.2rem; font-weight: 600; background: var(--success); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            🛍️ Open Purchasing
                        </button>
                        <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                            <label style="font-size: 0.875rem; color: var(--gray); display: block; margin-bottom: 0.5rem;">Direct Link (copy and share):</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="purchasingAppLink" value="file:///C:/Users/aring/NewCo/newco-redemption-v2.2.html?mode=purchasing" readonly style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                                <button class="btn btn-outline" onclick="copyPurchasingLink()" style="padding: 0.5rem 1rem;">📋 Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Floor Rewards Section -->
        <section id="floor-rewards" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Floor Rewards</h1>
            </div>
            
            <div class="content-main">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                        <div class="form-label">Enable Floor Reward System</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableFloorRewards" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1.5rem;">
                        <div class="form-label">Enable Barcode Scanning</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableFloorScanning" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--warning-light); border-radius: 12px; border: 2px solid var(--warning);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--warning);">Launch Floor Rewards</h3>
                        <button class="btn" onclick="openFloorRewardsApp()" style="width: 100%; padding: 1.25rem; font-size: 1.2rem; font-weight: 600; background: var(--warning); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            ⭐ Open Floor Rewards
                        </button>
                        <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                            <label style="font-size: 0.875rem; color: var(--gray); display: block; margin-bottom: 0.5rem;">Direct Link (copy and share):</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="floorRewardsAppLink" value="file:///C:/Users/aring/NewCo/newco-floor-runner-vanguard.html" readonly style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                                <button class="btn btn-outline" onclick="copyFloorRewardsLink()" style="padding: 0.5rem 1rem;">📋 Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Halls Section -->
        <section id="halls" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Hall & Layout</h1>
            </div>

            <!-- Single Hall Configuration -->
            <div id="hallContent">
                <!-- Hall content will be generated here -->
            </div>
        </section>

        <!-- Staff Section -->
        <section id="staff" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Team Management</h1>
                <p class="content-subtitle">Manage staff members, roles, and permissions</p>
            </div>
            
            <!-- Staff Stats -->
            <div class="content-section">
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-light), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Total Staff</div>
                        <div class="stat-value" id="totalStaffCount" style="font-size: 2rem; font-weight: bold; color: var(--primary);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Active Today</div>
                        <div class="stat-value" id="activeStaffCount" style="font-size: 2rem; font-weight: bold; color: var(--success);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Managers</div>
                        <div class="stat-value" id="managerCount" style="font-size: 2rem; font-weight: bold; color: var(--warning);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Floor Staff</div>
                        <div class="stat-value" id="floorStaffCount" style="font-size: 2rem; font-weight: bold; color: #2196f3;">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Filters and Actions -->
            <div class="content-section">
                <div class="section-header">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="staffSearchInput" placeholder="Search by name or email..." 
                               style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;"
                               onkeyup="filterStaff()">
                        <select id="staffRoleFilter" onchange="filterStaff()" 
                                style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="">All Roles</option>
                            <option value="Admin">Admin</option>
                            <option value="Manager">Manager</option>
                            <option value="Floor Staff">Floor Staff</option>
                            <option value="Cashier">Cashier</option>
                            <option value="Caller">Caller</option>
                            <option value="Security">Security</option>
                        </select>
                        <select id="staffStatusFilter" onchange="filterStaff()" 
                                style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="on_leave">On Leave</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="exportStaff()">📥 Export</button>
                        <button class="btn btn-primary" onclick="addStaffMember()">+ Add Staff Member</button>
                    </div>
                </div>
                
                <!-- Staff Table -->
                <div style="overflow-x: auto; margin-top: 1.5rem;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark);">
                                    <input type="checkbox" id="selectAllStaff" onchange="toggleAllStaff()">
                                </th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortStaff('name')">
                                    Name <span id="sortArrowStaffName">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark);">Contact</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortStaff('role')">
                                    Role <span id="sortArrowStaffRole">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark);">Status</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortStaff('lastActive')">
                                    Last Active <span id="sortArrowStaffLastActive">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- Staff rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                <div id="bulkActionsBar" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 1rem 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="selectedCount" style="font-weight: 600;">0 selected</span>
                        <button class="btn btn-sm" onclick="bulkUpdateStatus('active')">Activate</button>
                        <button class="btn btn-sm" onclick="bulkUpdateStatus('inactive')">Deactivate</button>
                        <button class="btn btn-sm btn-danger" onclick="bulkDeleteStaff()">Delete</button>
                        <button class="btn btn-sm btn-secondary" onclick="clearStaffSelection()">Cancel</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             WEB TEMPLATES SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Web Templates Section -->
        <section id="pagebuilder" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Web Templates</h1>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="launchCustomerSite()">
                        🚀 Launch Site
                    </button>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Choose Your Template</h2>
                    <p class="section-subtitle">Select a template design for your booking page</p>
                </div>
                
                <!-- Template Carousel -->
                <div style="position: relative; overflow: hidden; border-radius: 12px; background: var(--gray-lighter); padding: 2rem 0;">
                    <div id="templateCarousel" style="display: flex; transition: transform 0.4s ease-in-out; align-items: center; justify-content: center;">
                        
                        <!-- Template 1: Classic -->
                        <div class="template-card" data-template="classic" onclick="showComingSoon('Web Templates')" style="min-width: 300px; margin: 0 1rem; cursor: pointer; transition: all 0.3s ease;">
                            <div style="background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; transform: scale(0.85); opacity: 0.6;">
                                <div style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; display: flex; align-items: center; justify-content: center;">
                                    <div style="text-align: center; color: white;">
                                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Classic Bingo</h3>
                                        <p style="margin: 0.5rem 0 0; opacity: 0.9;">Traditional Design</p>
                                    </div>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <div style="height: 8px; background: var(--gray-light); border-radius: 4px; margin-bottom: 0.5rem;"></div>
                                        <div style="height: 8px; background: var(--gray-light); border-radius: 4px; width: 80%;"></div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <div style="flex: 1; height: 40px; background: #667eea; border-radius: 6px; opacity: 0.8;"></div>
                                        <div style="flex: 1; height: 40px; background: #764ba2; border-radius: 6px; opacity: 0.8;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <h4 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Classic</h4>
                                <p style="margin: 0.25rem 0 0; color: var(--gray); font-size: 0.875rem;">Traditional purple & gold theme</p>
                            </div>
                        </div>

                        <!-- Template 2: Modern (Center - Featured) -->
                        <div class="template-card featured-template" data-template="modern" style="min-width: 350px; margin: 0 1rem; cursor: pointer; transition: all 0.3s ease;">
                            <div style="background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); overflow: hidden; transform: scale(1); border: 3px solid var(--primary);">
                                <div style="height: 240px; background: linear-gradient(135deg, #2ea3f2 0%, #1a5f8a 100%); position: relative; display: flex; align-items: center; justify-content: center;">
                                    <div style="text-align: center; color: white;">
                                        <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Modern Bingo</h3>
                                        <p style="margin: 0.5rem 0 0; opacity: 0.9;">Clean & Professional</p>
                                        <div style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">RECOMMENDED</div>
                                    </div>
                                </div>
                                <div style="padding: 2rem;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <div style="height: 10px; background: var(--gray-light); border-radius: 5px; margin-bottom: 0.75rem;"></div>
                                        <div style="height: 10px; background: var(--gray-light); border-radius: 5px; width: 85%;"></div>
                                    </div>
                                    <div style="display: flex; gap: 0.75rem;">
                                        <div style="flex: 1; height: 50px; background: #2ea3f2; border-radius: 8px;"></div>
                                        <div style="flex: 1; height: 50px; background: #1a5f8a; border-radius: 8px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <h4 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--primary);">Modern</h4>
                                <p style="margin: 0.25rem 0 0; color: var(--gray); font-size: 0.875rem;">Sleek blue design with clean lines</p>
                            </div>
                        </div>

                        <!-- Template 3: Vibrant -->
                        <div class="template-card" data-template="vibrant" onclick="showComingSoon('Web Templates')" style="min-width: 300px; margin: 0 1rem; cursor: pointer; transition: all 0.3s ease;">
                            <div style="background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; transform: scale(0.85); opacity: 0.6;">
                                <div style="height: 200px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); position: relative; display: flex; align-items: center; justify-content: center;">
                                    <div style="text-align: center; color: white;">
                                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Vibrant Bingo</h3>
                                        <p style="margin: 0.5rem 0 0; opacity: 0.9;">Bright & Fun</p>
                                    </div>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <div style="height: 8px; background: var(--gray-light); border-radius: 4px; margin-bottom: 0.5rem;"></div>
                                        <div style="height: 8px; background: var(--gray-light); border-radius: 4px; width: 75%;"></div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <div style="flex: 1; height: 40px; background: #fa709a; border-radius: 6px; opacity: 0.8;"></div>
                                        <div style="flex: 1; height: 40px; background: #fee140; border-radius: 6px; opacity: 0.8;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <h4 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Vibrant</h4>
                                <p style="margin: 0.25rem 0 0; color: var(--gray); font-size: 0.875rem;">Colorful pink & yellow theme</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carousel Navigation -->
                    <div style="position: absolute; top: 50%; left: 1rem; transform: translateY(-50%);">
                        <button onclick="rotateTemplateCarousel(-1)" style="background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 40px; height: 40px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            ←
                        </button>
                    </div>
                    <div style="position: absolute; top: 50%; right: 1rem; transform: translateY(-50%);">
                        <button onclick="rotateTemplateCarousel(1)" style="background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 40px; height: 40px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            →
                        </button>
                    </div>
                </div>
            </div>

        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             WEB BUILDER SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Web Builder Section -->
        <section id="webbuilder" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Web Builder</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="previewBuiltPage()">
                        👁️ Preview Page
                    </button>
                    <button class="btn btn-primary" onclick="exportBuiltPage()">
                        📥 Export HTML
                    </button>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Drag & Drop Page Builder</h2>
                    <p class="section-subtitle">Build your custom booking page with drag and drop components</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 200px 1fr 300px; gap: 1rem;">
                    <!-- Component Palette -->
                    <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px; height: fit-content;">
                        <h3 style="font-size: 0.875rem; margin-bottom: 1rem;">Components</h3>
                        <div class="component-list">
                            <div class="drag-component" draggable="true" data-component="header" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📄</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Header</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="session-selector" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📅</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Date/Time Picker</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="package-cards" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📦</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Package Cards</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="seat-selector" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>🪑</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Seat Selector</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="pricing" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>💰</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Pricing Display</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="checkout" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>🛒</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Checkout Form</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="text" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📝</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Text Block</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="image" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>🖼️</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Image</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="divider" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>➖</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Divider</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Canvas -->
                    <div style="background: white; border: 2px dashed #ddd; border-radius: 8px; padding: 1rem; min-height: 600px; position: relative;">
                        <div id="builderCanvas" style="min-height: 550px;" ondragover="allowDrop(event)" ondrop="dropComponent(event)">
                            <div style="text-align: center; color: var(--gray); margin-top: 200px; pointer-events: none;" id="canvasPlaceholder">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">🎨</div>
                                <h3>Drag components here to build your page</h3>
                                <p>Start by dragging a Header component to begin</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Properties Panel -->
                    <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px; height: fit-content;">
                        <h3 style="font-size: 0.875rem; margin-bottom: 1rem;">Properties</h3>
                        <div id="builderPropertyPanel">
                            <p style="color: var(--gray); font-size: 0.875rem;">
                                Select a component to edit its properties
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Page Settings</h2>
                    <p class="section-subtitle">Configure advanced page behavior and integrations</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Seat Selection Mode</label>
                        <select class="form-select" id="builderSeatMode">
                            <option value="simple">Simple (Quantity)</option>
                            <option value="visual">Visual (Grid Map)</option>
                            <option value="vip">VIP Sections</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pricing Display</label>
                        <select class="form-select" id="builderPricing">
                            <option value="dynamic">Dynamic (Live Update)</option>
                            <option value="static">Static</option>
                            <option value="tiered">Tiered Pricing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Enable Rewards Integration</label>
                        <select class="form-select" id="builderRewards">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Checkout Flow</label>
                        <select class="form-select" id="builderCheckout">
                            <option value="single">Single Page</option>
                            <option value="multi">Multi-Step Wizard</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Responsive</label>
                        <select class="form-select" id="builderMobile">
                            <option value="auto" selected>Auto-Responsive</option>
                            <option value="desktop">Desktop Only</option>
                            <option value="mobile">Mobile Optimized</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme Integration</label>
                        <select class="form-select" id="builderTheme">
                            <option value="template">Use Selected Template</option>
                            <option value="custom">Custom Styling</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Theme Presets Section (moved from Themes) -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Theme Presets</h2>
                    <p class="section-subtitle">Choose a starting theme for your brand</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="theme-card" onclick="applyTheme('classic')">
                        <div style="height: 100px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Classic Bingo</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Traditional purple & gold</p>
                        </div>
                    </div>
                    <div class="theme-card" onclick="applyTheme('modern')">
                        <div style="height: 100px; background: linear-gradient(135deg, #2ea3f2, #1a5f8a); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Modern Blue</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Clean and professional</p>
                        </div>
                    </div>
                    <div class="theme-card" onclick="applyTheme('fun')">
                        <div style="height: 100px; background: linear-gradient(135deg, #f093fb, #f5576c); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Fun & Vibrant</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Colorful and energetic</p>
                        </div>
                    </div>
                    <div class="theme-card" onclick="applyTheme('elegant')">
                        <div style="height: 100px; background: linear-gradient(135deg, #434343, #000000); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Elegant Dark</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Sophisticated black & gold</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typography Section (moved from Themes) -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Typography</h2>
                    <p class="section-subtitle">Choose your fonts for a consistent look</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Heading Font</label>
                        <select class="form-select" id="headingFont">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Playfair Display">Playfair Display</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Body Font</label>
                        <select class="form-select" id="bodyFont">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Lato">Lato</option>
                            <option value="Source Sans Pro">Source Sans Pro</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Settings</h1>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Organization Details</h2>
                    <p class="section-subtitle">Legal and contact information</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Organization Legal Name</label>
                        <input type="text" class="form-input" id="settingsOrgName" placeholder="Legal entity name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">License Number</label>
                        <input type="text" class="form-input" id="settingsLicense" placeholder="Gaming license #">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Primary Email</label>
                        <input type="email" class="form-input" id="settingsEmail" placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Primary Phone</label>
                        <input type="tel" class="form-input" id="settingsPhone" placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Main Address</label>
                        <input type="text" class="form-input" id="settingsAddress" placeholder="123 Main St">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="settingsWebsite" placeholder="https://example.com">
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">System Preferences</h2>
                    <p class="section-subtitle">Configure system behavior</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Time Zone</label>
                        <select class="form-select" id="settingsTimezone">
                            <option value="America/Los_Angeles">Pacific Time</option>
                            <option value="America/Denver">Mountain Time</option>
                            <option value="America/Chicago">Central Time</option>
                            <option value="America/New_York">Eastern Time</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-select" id="settingsCurrency">
                            <option value="USD">USD ($)</option>
                            <option value="CAD">CAD (C$)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Points Currency Name</label>
                        <input type="text" class="form-input" id="settingsPointsCurrency" value="Loyalty Points" placeholder="e.g., Stars, Tokens, Coins, Loyalty Points">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Name displayed for loyalty points throughout the system
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seat Limit Per User</label>
                        <input type="number" class="form-input" id="settingsSeatLimit" min="1" max="20" value="1" placeholder="1">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Maximum number of seats a single user can purchase (applies to packages with seat selection)
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tax Rate (%)</label>
                        <input type="number" class="form-input" id="settingsTaxRate" min="0" max="25" step="0.01" value="8.75" placeholder="8.75">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Sales tax percentage applied at checkout (when not exempt)
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Tax Exemption Settings</h2>
                    <p class="section-subtitle">Configure tax-exempt status for charitable gaming</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Bingo Packages are Tax-Exempt</div>
                            <div class="toggle-description">
                                Bingo games operated by qualified non-profits are typically tax-exempt in California
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsTaxExemptPackages" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Gaming Items are Tax-Exempt</div>
                            <div class="toggle-description">
                                Pull-tabs, paper cards, and other gaming items
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsTaxExemptItems" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Reward Redemptions are Tax-Exempt</div>
                            <div class="toggle-description">
                                Items redeemed with loyalty points
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsTaxExemptRewards" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border: 1px solid #ffc107;">
                            <strong style="color: #856404;">⚠️ Note on Taxable Items:</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #856404;">
                                Concessions, merchandise, and bingo supplies (daubers, seat cushions) sold separately are typically taxable. 
                                Consider creating a separate "Merchandise" category for these items.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Payment Options</h2>
                    <p class="section-subtitle">Configure accepted payment methods</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Accept Credit/Debit Cards</div>
                            <div class="toggle-description">
                                Enable online card payments through checkout
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsPaymentCard">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Accept Cash at Hall</div>
                            <div class="toggle-description">
                                Allow customers to reserve online and pay cash when they arrive
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsPaymentCash">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Accept Checks</div>
                            <div class="toggle-description">
                                Accept check payments at the hall
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsPaymentCheck">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Access Permissions</h2>
                    <p class="section-subtitle">Control who can modify different sections</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Required Permission for Offerings</label>
                        <select class="form-select" id="settingsOfferingsPermission" onchange="saveSettings()">
                            <option value="any">Any Role</option>
                            <option value="Admin">Admin Only</option>
                            <option value="Marketing Manager">Marketing Manager or Admin</option>
                            <option value="Manager">Manager or Higher</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Controls who can create/edit Basic Offerings, Packages, and Loyalty Items
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required Permission for Marketing Tools</label>
                        <select class="form-select" id="settingsMarketingPermission" onchange="saveSettings()">
                            <option value="any">Any Role</option>
                            <option value="Admin">Admin Only</option>
                            <option value="Marketing Manager">Marketing Manager or Admin</option>
                            <option value="Manager">Manager or Higher</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Controls who can modify Page Builder, Promotions, and Themes
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required Permission for Branding</label>
                        <select class="form-select" id="settingsBrandingPermission" onchange="saveSettings()">
                            <option value="any">Any Role</option>
                            <option value="Admin">Admin Only</option>
                            <option value="Marketing Manager">Marketing Manager or Admin</option>
                            <option value="Manager">Manager or Higher</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Controls who can modify logo, colors, and brand messaging
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             PACKAGES SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Packages Section -->
        <section id="packages" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Package Management</h1>
                <p class="content-subtitle">Create and manage bingo packages</p>
            </div>
            
            <!-- Package Examples Section -->
            <div class="content-section" style="background: var(--secondary); background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(156, 39, 176, 0.05) 100%); border-left: 4px solid var(--secondary);">
                <div class="section-header">
                    <h2 class="section-title" style="font-size: 1.1rem; color: var(--secondary);">📦 Popular Package Examples</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; font-size: 0.9rem;">
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--secondary); font-size: 1rem;">🌟 Early Bird Special</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$15 (Save $5!)</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>6-on Paper Regular Games</li>
                            <li>Early Bird Games</li>
                            <li>1 Special Game Sheet</li>
                            <li>Free Dauber</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">Available until 6:30 PM</div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                        <span style="position: absolute; top: -8px; right: 10px; background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">BEST VALUE</span>
                        <strong style="color: var(--secondary); font-size: 1rem;">💎 Premium Package</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$35 or 350 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Electronic Unit (48 cards)</li>
                            <li>All Special Games</li>
                            <li>Progressive Jackpot Entry</li>
                            <li>Reserved Seat Selection</li>
                            <li>Complimentary Snack</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">Includes loyalty points bonus</div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--secondary); font-size: 1rem;">👥 Group Bundle</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$100 (4 Players)</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>4x 6-on Paper Games</li>
                            <li>4x Special Game Sheets</li>
                            <li>Table Reservation</li>
                            <li>Shared Bonanza Pack</li>
                            <li>Group Photo</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">Perfect for parties!</div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--secondary); font-size: 1rem;">🎯 Beginner's Luck</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$10</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>3-on Paper (6 cards)</li>
                            <li>1 Special Game</li>
                            <li>Dauber Included</li>
                            <li>How-to-Play Guide</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">First-timers welcome!</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.8); border-radius: 8px;">
                    <p style="font-size: 0.85rem; color: var(--gray-dark); margin: 0;">
                        <strong>💡 Package Strategy Tips:</strong>
                    </p>
                    <ul style="font-size: 0.85rem; color: var(--gray); margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Create 3-4 packages at different price points to appeal to all players</li>
                        <li>Mark one package as "Best Value" to guide purchasing decisions</li>
                        <li>Include seat selection in premium packages as an incentive</li>
                        <li>Consider time-based packages (Early Bird) to manage crowd flow</li>
                        <li>Offer loyalty point redemption on higher-tier packages</li>
                    </ul>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Packages</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="create-examples-btn" onclick="createPackageExamples()">
                            ✨ Create Examples
                        </button>
                        <button class="btn btn-primary" onclick="addPackage()">+ Add Package</button>
                    </div>
                </div>
                
                <div id="packagesContainer">
                    <!-- Packages will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Loyalty Items Section -->
        <section id="loyaltyItems" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Loyalty Rewards</h1>
                <p class="content-subtitle">Create exclusive items that can only be redeemed with loyalty points</p>
            </div>
            
            <!-- Loyalty Examples Section -->
            <div class="content-section" style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%); border-left: 4px solid var(--warning);">
                <div class="section-header">
                    <h2 class="section-title" style="font-size: 1.1rem; color: var(--warning);">🏆 Loyalty Reward Examples</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; font-size: 0.9rem;">
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">🎟️ Free Play Vouchers</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">100-500 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Free Regular Session (500 pts)</li>
                            <li>Free Special Game (100 pts)</li>
                            <li>Free Electronic Upgrade (300 pts)</li>
                            <li>Buy-One-Get-One (250 pts)</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">🍔 Food & Beverage</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">50-200 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Free Snack Pack (50 pts)</li>
                            <li>Meal Voucher (150 pts)</li>
                            <li>Drink Credits (75 pts)</li>
                            <li>Birthday Cake Slice (100 pts)</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">🎁 Merchandise</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">200-1000 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Branded Dauber Set (200 pts)</li>
                            <li>Lucky Seat Cushion (400 pts)</li>
                            <li>Bingo Bag (600 pts)</li>
                            <li>VIP Jacket (1000 pts)</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">⭐ VIP Experiences</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">1000+ Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Reserved Table Month (2000 pts)</li>
                            <li>Private Party Package (5000 pts)</li>
                            <li>Caller for a Day (3000 pts)</li>
                            <li>VIP Parking Pass (1500 pts)</li>
                        </ul>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.8); border-radius: 8px;">
                    <p style="font-size: 0.85rem; color: var(--gray-dark); margin: 0;">
                        <strong>💡 Loyalty Program Tips:</strong>
                    </p>
                    <ul style="font-size: 0.85rem; color: var(--gray); margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Set point values that encourage repeat visits (e.g., 1 point per $1 spent)</li>
                        <li>Create tiers of rewards from small (50 pts) to aspirational (5000+ pts)</li>
                        <li>Include experiential rewards that money can't buy</li>
                        <li>Rotate seasonal items to keep the program fresh</li>
                        <li>Consider partner rewards with local businesses</li>
                    </ul>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Loyalty Items</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="create-examples-btn" onclick="createLoyaltyExamples()">
                            ✨ Create Examples
                        </button>
                        <button class="btn btn-primary" onclick="addLoyaltyItem()">+ Add Loyalty Item</button>
                    </div>
                </div>
                
                <div id="loyaltyItemsContainer">
                    <!-- Loyalty items will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             PROMOTIONS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Marketing Section -->
        <section id="marketing" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Marketing & Promotions</h1>
                <p class="content-subtitle">Manage flashy alerts, promotions, birthday offers, and special campaigns</p>
            </div>
            
            <!-- Flashy Alerts Configuration -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">⚡ Flashy Alerts</h2>
                </div>
                <div class="card">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Flashy Alerts</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableFlashyAlerts" onchange="toggleFlashyAlerts()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show rotating marketing messages to visitors every few seconds
                            </div>
                        </div>
                    </div>
                    
                    <div id="flashyAlertsSettings" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Time on Screen (seconds)</label>
                                <input type="number" class="form-input" id="alertTimeOnScreen" value="3" min="1" max="10">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    How long each message displays
                                </p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Delay Between Alerts (seconds)</label>
                                <input type="number" class="form-input" id="alertDelayBetween" value="6" min="3" max="60">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    Time between messages
                                </p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Message List</label>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <input type="radio" name="alertMessageSource" value="default" checked onchange="toggleMessageSource()">
                                    Use default list (100+ rotating messages)
                                </label>
                                <label style="display: block;">
                                    <input type="radio" name="alertMessageSource" value="custom" onchange="toggleMessageSource()">
                                    Use custom messages
                                </label>
                            </div>
                            
                            <div id="customMessagesSection" style="display: none;">
                                <label class="form-label">Custom Messages (one per line)</label>
                                <textarea class="form-input" id="customAlertMessages" rows="8" 
                                    placeholder="Enter your custom marketing messages, one per line..."></textarea>
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    Messages will be shown in random order
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="saveFlashyAlertsSettings()">
                                💾 Save Alert Settings
                            </button>
                            <button class="btn btn-secondary" onclick="previewFlashyAlert()">
                                👁️ Preview Alert
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Birthday Offer Configuration -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">🎂 Birthday Offer Configuration</h2>
                </div>
                <div id="birthdayOfferContainer">
                    <!-- Birthday offer settings will be loaded here -->
                </div>
            </div>

            <!-- Social Media Updates -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">📱 Social Media & Updates</h2>
                </div>
                <div class="card">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Social Media Button</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableSocialMediaButton" onchange="toggleSocialMediaSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show a button in the header for social media updates and SMS notifications
                            </div>
                        </div>
                    </div>

                    <div id="socialMediaSettings" style="display: none; margin-top: 1.5rem;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Button Text/Icon</label>
                                <input type="text" class="form-input" id="socialMediaButtonText" placeholder="📱 GET UPDATES!" maxlength="30">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    Text/emoji shown in header button (e.g., "📱 Updates", "🔔 Alerts")
                                </p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Modal Title</label>
                                <input type="text" class="form-input" id="socialMediaModalTitle" placeholder="GET UPDATES!" maxlength="50">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Modal Message</label>
                            <textarea class="form-input" id="socialMediaMessage" rows="4"
                                placeholder="To receive notifications when we're officially open as well as coupons, discounts, news and event announcements:&#10;&#10;Text &quot;MCB&quot; to 70503"></textarea>
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Main message shown in the popup modal
                            </p>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">SMS Keyword</label>
                                <input type="text" class="form-input" id="socialMediaSMSKeyword" placeholder="MCB" maxlength="20">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    Keyword to text (e.g., "MCB", "BINGO")
                                </p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">SMS Number</label>
                                <input type="text" class="form-input" id="socialMediaSMSNumber" placeholder="70503" maxlength="10">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    Short code or phone number to text
                                </p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Twitter/X Link (Optional)</label>
                            <input type="url" class="form-input" id="socialMediaTwitterLink" placeholder="https://twitter.com/yourpage">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Optional: Link to your Twitter/X page
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Facebook Link (Optional)</label>
                            <input type="url" class="form-input" id="socialMediaFacebookLink" placeholder="https://facebook.com/yourpage">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Instagram Link (Optional)</label>
                            <input type="url" class="form-input" id="socialMediaInstagramLink" placeholder="https://instagram.com/yourpage">
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="saveSocialMediaSettings()">
                                💾 Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="previewSocialMediaModal()">
                                👁️ Preview Modal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Welcome Popup -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">🎉 Welcome Popup</h2>
                </div>
                <div class="card">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Welcome Popup</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableWelcomePopup" onchange="toggleWelcomePopupSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show a welcome popup with custom image when visitors first arrive
                            </div>
                        </div>
                    </div>

                    <div id="welcomePopupSettings" style="display: none; margin-top: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Popup Image</label>
                            <input type="file" class="form-input" id="welcomePopupImage" accept="image/*" onchange="handleWelcomePopupImageUpload(this)">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Upload a banner image (recommended: 1200x400px or similar aspect ratio, max 500KB)
                            </p>
                            <div id="welcomePopupImagePreview" style="margin-top: 1rem;">
                                <!-- Image preview will appear here -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Welcome Message (Optional)</label>
                            <textarea class="form-input" id="welcomePopupMessage" rows="3"
                                placeholder="Enter a welcome message to display..."></textarea>
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Optional text message to show with the image
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Text Position</label>
                            <select class="form-select" id="welcomePopupTextPosition">
                                <option value="bottom">Bottom of image</option>
                                <option value="diagonal">Diagonal across image</option>
                                <option value="none">No text overlay (message below image)</option>
                            </select>
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Choose where to display the welcome message
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Show Frequency</label>
                            <select class="form-select" id="welcomePopupFrequency">
                                <option value="once-per-session">Once per browser session</option>
                                <option value="once-per-day">Once per day</option>
                                <option value="every-visit">Every visit</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="saveWelcomePopupSettings()">
                                💾 Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="previewWelcomePopup()">
                                👁️ Preview Popup
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Promotions -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Active Promotions</h2>
                    <button class="btn btn-primary" onclick="addPromotion()">+ Add Promotion</button>
                </div>
                
                <!-- Promotion Examples -->
                <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%); border-left: 4px solid var(--success); padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <h3 style="font-size: 1rem; color: var(--success); margin: 0 0 0.5rem 0;">💡 Promotion Ideas</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.85rem; color: var(--gray-dark);">
                        <div>
                            <strong>Time-Based:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1.25rem;">
                                <li>Happy Hour (2-4 PM)</li>
                                <li>Weekend Special</li>
                                <li>Month-End Bonus</li>
                            </ul>
                        </div>
                        <div>
                            <strong>Customer-Based:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1.25rem;">
                                <li>New Player Welcome</li>
                                <li>VIP Member Perks</li>
                                <li>Referral Rewards</li>
                            </ul>
                        </div>
                        <div>
                            <strong>Event-Based:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1.25rem;">
                                <li>Holiday Specials</li>
                                <li>Anniversary Sale</li>
                                <li>Tournament Qualifier</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div id="promotionsContainer">
                    <!-- Promotions will be loaded here -->
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             SOCIAL MEDIA SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Social Media Section -->
        <section id="socialmedia" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Social Media Management</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshSocialStats()">
                        🔄 Refresh Stats
                    </button>
                    <button class="btn btn-primary" onclick="schedulePost()">
                        📅 Schedule Post
                    </button>
                </div>
            </div>

            <!-- Hashtag Settings -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title"># Hashtag Settings</h2>
                    <button class="btn btn-primary btn-sm" onclick="saveHashtags()">Save Hashtags</button>
                </div>
                <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Default Hashtags</label>
                        <input type="text" class="form-input" id="defaultHashtags" placeholder="#bingo #vanguardbingo #bingonight #winners" value="#bingo #vanguardbingo">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            These hashtags will be automatically added to all posts
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Promotion Hashtags</label>
                        <input type="text" class="form-input" id="promotionHashtags" placeholder="#promotion #special #limitedtime" value="#special #promotion">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Added when including promotions in posts
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Event Hashtags</label>
                        <input type="text" class="form-input" id="eventHashtags" placeholder="#event #tournament #jackpot" value="#jackpot #tournament">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Used for special event announcements
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Twitter Analytics Dashboard -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">📊 Twitter Analytics</h2>
                    <select class="form-select" style="width: 200px;" onchange="updateTwitterTimeframe(this.value)">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #1DA1F2 0%, #0e71c8 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Posts</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterTotalPosts">247</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    <span style="color: #4ade80;">↑ 12%</span> from last period
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">📝</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Average Engagement</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterAvgEngagement">4.7%</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    <span style="color: #fbbf24;">↑ 0.3%</span> from last period
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">💬</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Impressions</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterImpressions">52.3K</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    <span style="color: #4ade80;">↑ 23%</span> from last period
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">👁️</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">New Followers</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterNewFollowers">189</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    Total: <strong>3,482</strong> followers
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">👥</div>
                        </div>
                    </div>
                </div>

                <!-- Engagement Chart -->
                <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">Engagement Timeline</h3>
                    <div style="height: 300px; background: linear-gradient(to bottom, rgba(29, 161, 242, 0.1) 0%, rgba(29, 161, 242, 0.02) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📈</div>
                            <div>Chart visualization would go here</div>
                            <div style="font-size: 0.875rem; margin-top: 0.5rem;">Showing likes, retweets, and replies over time</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Posts History -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">📜 Recent Posts History</h2>
                    <button class="btn btn-secondary btn-sm" onclick="exportTwitterHistory()">
                        📥 Export CSV
                    </button>
                </div>

                <div style="background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Post Content</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Likes</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Retweets</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Replies</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Engagement</th>
                            </tr>
                        </thead>
                        <tbody id="twitterHistoryTable">
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">Dec 28, 2024</td>
                                <td style="padding: 1rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    🎉 Join us tonight for MEGA BINGO! $5,000 jackpot up for grabs! Doors open at 5PM...
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #ef4444;">❤️ 47</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #10b981;">🔄 12</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #3b82f6;">💬 8</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="background: var(--success-light); color: var(--success); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">6.2%</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">Dec 27, 2024</td>
                                <td style="padding: 1rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    Don't forget - Early Bird Special tomorrow! First 50 players get a free dauber pack...
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #ef4444;">❤️ 31</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #10b981;">🔄 8</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #3b82f6;">💬 3</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="background: var(--warning-light); color: var(--warning); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">4.1%</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">Dec 26, 2024</td>
                                <td style="padding: 1rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    Congratulations to tonight's big winner - Mary S. took home $2,500! 🎊 #BingoWinner
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #ef4444;">❤️ 89</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #10b981;">🔄 23</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #3b82f6;">💬 15</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="background: var(--primary-light); color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">8.9%</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Schedule Posts -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">📅 Scheduled Posts</h2>
                    <button class="btn btn-primary" onclick="addScheduledPost()">
                        + Schedule New Post
                    </button>
                </div>

                <div id="scheduledPostsContainer">
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; position: relative;">
                            <div style="position: absolute; top: 1rem; right: 1rem;">
                                <span style="background: var(--warning-light); color: var(--warning); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600;">
                                    Scheduled
                                </span>
                            </div>
                            <div style="display: flex; gap: 1.5rem;">
                                <div style="flex-shrink: 0;">
                                    <div style="background: linear-gradient(135deg, #1DA1F2 0%, #0e71c8 100%); color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        📅
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Dec 30, 2024 - 10:00 AM</div>
                                    <div style="color: var(--gray-dark); margin-bottom: 1rem;">
                                        New Year's Eve Spectacular! 🎊 Join us for our biggest event of the year with $10,000 in prizes! Special midnight countdown bingo session. Reserve your seats now!
                                    </div>
                                    <div style="display: flex; gap: 1rem;">
                                        <button class="btn btn-sm btn-secondary" onclick="editScheduledPost(1)">
                                            ✏️ Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteScheduledPost(1)">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; position: relative;">
                            <div style="position: absolute; top: 1rem; right: 1rem;">
                                <span style="background: var(--warning-light); color: var(--warning); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600;">
                                    Scheduled
                                </span>
                            </div>
                            <div style="display: flex; gap: 1.5rem;">
                                <div style="flex-shrink: 0;">
                                    <div style="background: linear-gradient(135deg, #1DA1F2 0%, #0e71c8 100%); color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        📅
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Jan 1, 2025 - 9:00 AM</div>
                                    <div style="color: var(--gray-dark); margin-bottom: 1rem;">
                                        Happy New Year! 🎉 Start 2025 with us! January special: Buy 2 packs, get 1 FREE all month long. See you at the hall!
                                    </div>
                                    <div style="display: flex; gap: 1rem;">
                                        <button class="btn btn-sm btn-secondary" onclick="editScheduledPost(2)">
                                            ✏️ Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteScheduledPost(2)">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Best Performing Posts -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">🏆 Top Performing Posts</h2>
                    <select class="form-select" style="width: 150px;" onchange="updateTopPostsTimeframe(this.value)">
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>

                <div style="display: grid; gap: 1rem;">
                    <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%); border: 2px solid #fbbf24; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">🥇</div>
                            <div style="background: #fbbf24; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                12.3% Engagement
                            </div>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Winner Announcement Post</div>
                        <div style="color: var(--gray-dark); font-size: 0.95rem; margin-bottom: 1rem;">
                            "🎊 JACKPOT ALERT! Congratulations to Robert M. who just won our $5,000 progressive jackpot! This could be YOU next week!"
                        </div>
                        <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: var(--gray);">
                            <span>❤️ 234 likes</span>
                            <span>🔄 67 retweets</span>
                            <span>💬 45 replies</span>
                            <span>Dec 15, 2024</span>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(192, 192, 192, 0.1) 0%, rgba(192, 192, 192, 0.05) 100%); border: 2px solid #c0c0c0; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">🥈</div>
                            <div style="background: #c0c0c0; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                9.8% Engagement
                            </div>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Christmas Special Announcement</div>
                        <div style="color: var(--gray-dark); font-size: 0.95rem; margin-bottom: 1rem;">
                            "🎄 CHRISTMAS MEGA BINGO! Dec 23rd - $10,000 in prizes! Early bird gets free holiday meal. Limited seats - book now!"
                        </div>
                        <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: var(--gray);">
                            <span>❤️ 189 likes</span>
                            <span>🔄 52 retweets</span>
                            <span>💬 28 replies</span>
                            <span>Dec 10, 2024</span>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(205, 127, 50, 0.1) 0%, rgba(205, 127, 50, 0.05) 100%); border: 2px solid #cd7f32; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">🥉</div>
                            <div style="background: #cd7f32; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                8.4% Engagement
                            </div>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Free Dauber Friday</div>
                        <div style="color: var(--gray-dark); font-size: 0.95rem; margin-bottom: 1rem;">
                            "IT'S FRIDAY! 🎉 First 100 players get a FREE dauber set! Doors open at 4PM. Who's ready for some weekend bingo?"
                        </div>
                        <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: var(--gray);">
                            <span>❤️ 156 likes</span>
                            <span>🔄 41 retweets</span>
                            <span>💬 22 replies</span>
                            <span>Dec 8, 2024</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             BASIC OFFERINGS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Basic Offerings Section -->
        <section id="salesItems" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Basic Offerings</h1>
                <p class="content-subtitle">Define your basic bingo items that can be sold individually or included in packages</p>
            </div>
            
            <!-- Examples Section -->
            <div class="content-section" style="background: var(--primary-light); border-left: 4px solid var(--primary);">
                <div class="section-header">
                    <h2 class="section-title" style="font-size: 1.1rem; color: var(--primary-dark);">💡 Common Basic Offerings Examples</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                    <div>
                        <strong style="color: var(--primary);">Regular Cards:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>3-on Paper (6 cards) - $1</li>
                            <li>6-on Paper (18 cards) - $2</li>
                            <li>9-on Paper (27 cards) - $3</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: var(--primary);">Special Games:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Early Bird Special - $5</li>
                            <li>Warm-Up Games - $2</li>
                            <li>Progressive Jackpot - $1</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: var(--primary);">Electronic Options:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Electronic Unit (24 cards) - $20</li>
                            <li>Power Pack (48 cards) - $35</li>
                            <li>Max Pack (72 cards) - $50</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: var(--primary);">Extras & Add-ons:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Daubers - $2</li>
                            <li>Bonanza Cards - $1</li>
                            <li>Second Chance Drawing - $1</li>
                        </ul>
                    </div>
                </div>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--gray); font-style: italic;">
                    💡 Tip: Start by creating your most common items, then build packages that combine them for better value!
                </p>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Basic Items</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="create-examples-btn" onclick="createSalesItemExamples()">
                            ✨ Create Examples
                        </button>
                        <button class="btn btn-primary" onclick="addSalesItem()">+ Add Offering</button>
                    </div>
                </div>
                
                <div id="salesItemsContainer">
                    <!-- Sales items will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Members Database Section -->
        <section id="members" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Members Database</h1>
                <p class="content-subtitle">Manage and analyze your member base</p>
            </div>
            
            <!-- Members Filters -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">🔍 Filter Members</h2>
                    <button class="btn btn-primary" onclick="resetMemberFilters()">Reset Filters</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Search Name</label>
                        <input type="text" class="form-input" id="memberSearchName" placeholder="Search by name..." oninput="filterMembers()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Min Loyalty Points</label>
                        <input type="number" class="form-input" id="memberMinPoints" placeholder="0" oninput="filterMembers()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Min Lifetime Spend</label>
                        <input type="number" class="form-input" id="memberMinSpend" placeholder="0" oninput="filterMembers()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="memberDateRange" onchange="filterMembers()">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Activity Status</label>
                        <select class="form-select" id="memberActivity" onchange="filterMembers()">
                            <option value="all">All Members</option>
                            <option value="active">Active (30 days)</option>
                            <option value="inactive">Inactive</option>
                            <option value="new">New (7 days)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sort By</label>
                        <select class="form-select" id="memberSortBy" onchange="filterMembers()">
                            <option value="name">Name</option>
                            <option value="points">Loyalty Points</option>
                            <option value="lifetime">Lifetime Loyalty</option>
                            <option value="spend">Lifetime Spend</option>
                            <option value="average">Average Spend</option>
                            <option value="monthly">Monthly Spend</option>
                            <option value="created">Date Created</option>
                            <option value="lastLogin">Last Login</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Members Stats -->
            <div class="content-section">
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-light), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Total Members</div>
                        <div class="stat-value" id="totalMembersCount" style="font-size: 2rem; font-weight: bold; color: var(--primary);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Active This Month</div>
                        <div class="stat-value" id="activeMonthCount" style="font-size: 2rem; font-weight: bold; color: var(--success);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Avg Loyalty Points</div>
                        <div class="stat-value" id="avgPointsCount" style="font-size: 2rem; font-weight: bold; color: var(--warning);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Avg Monthly Spend</div>
                        <div class="stat-value" id="avgMonthlySpend" style="font-size: 2rem; font-weight: bold; color: #2196f3;">$0</div>
                    </div>
                </div>
            </div>
            
            <!-- Members Table -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Member List</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-warning" onclick="toggleTopPerformers()" id="topPerformersBtn">🏆 Top Performers</button>
                        <button class="btn btn-secondary" onclick="exportMembers()">📥 Export CSV</button>
                        <button class="btn btn-primary" onclick="addMember()">+ Add Member</button>
                    </div>
                </div>
                
                <!-- Top Performers Section (Hidden by default) -->
                <div id="topPerformersSection" style="display: none; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 255, 255, 0.95) 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--warning); margin-top: 1rem;">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--warning); font-size: 1.25rem; margin: 0;">🏆 Top Performers This Month</h3>
                            <select class="form-select" id="performersPeriod" onchange="loadTopPerformers()" style="width: 200px;">
                                <option value="month">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div>
                                <h4 style="font-size: 1rem; color: var(--gray); margin-bottom: 1rem;">💰 Most Points Earned</h4>
                                <div id="topEarners" style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <!-- Top earners will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h4 style="font-size: 1rem; color: var(--gray); margin-bottom: 1rem;">🎁 Most Points Redeemed</h4>
                                <div id="topRedeemers" style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <!-- Top redeemers will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h4 style="font-size: 1rem; color: var(--gray); margin-bottom: 1rem;">⭐ Most Active Members</h4>
                                <div id="mostActive" style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <!-- Most active members will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="members-table" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('name')">
                                    Name <span id="sortArrowName">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('points')">
                                    Loyalty Points <span id="sortArrowPoints">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('lifetime')">
                                    Lifetime Loyalty <span id="sortArrowLifetime">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('logins')">
                                    Logins <span id="sortArrowLogins">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('spend')">
                                    Lifetime Spend <span id="sortArrowSpend">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('average')">
                                    Avg Spend <span id="sortArrowAverage">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('monthly')">
                                    Monthly Spend <span id="sortArrowMonthly">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('created')">
                                    Created <span id="sortArrowCreated">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('lastLogin')">
                                    Last Login <span id="sortArrowLastLogin">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                            <!-- Members will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;">
                    <div id="membersPagination" style="display: flex; gap: 0.5rem;">
                        <!-- Pagination buttons will be here -->
                    </div>
                    <div style="color: var(--gray);">
                        Showing <span id="membersShowing">0</span> of <span id="membersTotal">0</span> members
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Rewards Program Section -->
        <section id="rewards" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Rewards Program</h1>
                <p class="content-subtitle">Monitor and manage your loyalty rewards program</p>
            </div>

            <!-- Enable/Disable Loyalty Program -->
            <div class="content-section" style="background: linear-gradient(135deg, var(--primary-light), #f0f8ff); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                    <input type="checkbox" id="enableLoyaltyProgram" onchange="toggleLoyaltyProgram()" style="width: 24px; height: 24px;">
                    <div>
                        <div style="font-weight: 700; color: var(--dark); font-size: 1.2rem;">Enable Loyalty/Rewards Program</div>
                        <div style="color: var(--gray); font-size: 0.95rem; margin-top: 0.25rem;">
                            When disabled, loyalty points will be hidden from customer site and no points will be earned or redeemed
                        </div>
                    </div>
                </label>
            </div>

            <div id="loyaltyProgramContent">
            <!-- Monthly Metrics -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">📊 Monthly Metrics</h2>
                    <select class="form-select" id="rewardsMonth" onchange="loadRewardsMetrics()" style="width: 200px;">
                        <option value="current">Current Month</option>
                        <option value="last">Last Month</option>
                        <option value="3months">Last 3 Months</option>
                        <option value="6months">Last 6 Months</option>
                        <option value="year">Last Year</option>
                    </select>
                </div>
                
                <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <div class="metric-card" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">💰</div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Monthly Points Earned</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="monthlyPointsEarned">0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">↑ 12% from last month</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card" style="background: linear-gradient(135deg, #ff9800, #ffb74d); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">🎁</div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Monthly Points Redeemed</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="monthlyPointsRedeemed">0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">↑ 8% from last month</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card" style="background: linear-gradient(135deg, #2196f3, #64b5f6); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">👥</div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Active Loyalty Members</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="activeLoyaltyUsers">0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">↑ 15% from last month</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rewards Program Type Selection -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">🎯 Rewards Program Type</h2>
                    <button class="btn btn-primary" onclick="saveRewardsConfig()">Save All Settings</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <label class="reward-type-card" style="position: relative; padding: 1.5rem; background: white; border: 2px solid var(--gray-light); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <input type="radio" name="rewardType" value="lifetime" checked onchange="updateRewardType('lifetime')" style="position: absolute; top: 1rem; right: 1rem;">
                        <div style="padding-right: 2rem;">
                            <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">🏆 Lifetime Tiers</div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Permanent Status Levels</div>
                            <div style="font-size: 0.875rem; color: var(--gray); line-height: 1.4;">Members advance through tiers based on lifetime spending and keep their status permanently</div>
                        </div>
                    </label>
                    
                    <label class="reward-type-card" style="position: relative; padding: 1.5rem; background: white; border: 2px solid var(--gray-light); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <input type="radio" name="rewardType" value="temporary" onchange="updateRewardType('temporary')" style="position: absolute; top: 1rem; right: 1rem;">
                        <div style="padding-right: 2rem;">
                            <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">⏰ Temporary Tiers</div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--warning); margin-bottom: 0.5rem;">Time-Limited Status</div>
                            <div style="font-size: 0.875rem; color: var(--gray); line-height: 1.4;">Members can purchase tier status for a limited time period with enhanced benefits</div>
                        </div>
                    </label>
                    
                    <label class="reward-type-card" style="position: relative; padding: 1.5rem; background: white; border: 2px solid var(--gray-light); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <input type="radio" name="rewardType" value="bonuses" onchange="updateRewardType('bonuses')" style="position: absolute; top: 1rem; right: 1rem;">
                        <div style="padding-right: 2rem;">
                            <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">🎁 Bonuses Only</div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--success); margin-bottom: 0.5rem;">Simple Points System</div>
                            <div style="font-size: 0.875rem; color: var(--gray); line-height: 1.4;">No tiers, just earn points on purchases and redeem for rewards</div>
                        </div>
                    </label>
                </div>
                
                <!-- Styles moved to newco-admin.css -->
            </div>
            
            <!-- Points Configuration -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">⚙️ Basic Points Settings</h2>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    <div>
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--gray-dark);">Points Currency</h3>
                        <div class="form-group" style="margin-bottom: 2rem;">
                            <label class="form-label">💰 Points Currency Name</label>
                            <input type="text" class="form-input" id="rewardsPointsCurrency" value="Loyalty Points" placeholder="e.g., Stars, Tokens, Coins, Loyalty Points">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                Name displayed for loyalty points throughout the system (e.g., "Stars", "Tokens", "Coins")
                            </p>
                        </div>
                        
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--gray-dark);">Earning Rules</h3>
                        <div class="form-group">
                            <label class="form-label">🌐 Web Earned Points per $</label>
                            <input type="number" class="form-input" id="webPointsPerDollar" value="10" min="0" step="1">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                Points earned for every dollar spent on web purchases
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">🏢 Floor Earned Points per $</label>
                            <input type="number" class="form-input" id="floorPointsPerDollar" value="10" min="0" step="1">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                Points earned for every dollar spent on floor purchases
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Birthday Bonus</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                <span>Enable Birthday Bonus</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="birthdayBonusEnabled" checked onchange="toggleBirthdayBonus()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div id="birthdayBonusConfig" style="padding-left: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                    <label style="width: 100px;">Points</label>
                                    <input type="number" class="form-input" id="birthdayBonusPoints" value="500" min="0" style="width: 150px;">
                                </div>
                                <div style="margin-top: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="radio" name="birthdayRequirement" id="birthdayRequiresPurchase" value="purchase">
                                        <span>Requires purchase on birthday</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="radio" name="birthdayRequirement" id="birthdayAutomatic" value="automatic" checked>
                                        <span>Automatically awarded</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="radio" name="birthdayRequirement" id="birthdayRequiresAttendance" value="attendance">
                                        <span>Requires attendance on birthday</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" id="birthdayTriggerEmail">
                                        <span>Trigger email notification</span>
                                    </label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; padding-left: 1.5rem;" id="emailDaysBeforeContainer">
                                        <label style="width: 120px;">Days before birthday</label>
                                        <input type="number" class="form-input" id="birthdayEmailDaysBefore" value="7" min="0" max="30" style="width: 80px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Sign-up Bonus</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                <span>Enable Sign-up Bonus</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="signupBonusEnabled" checked onchange="toggleSignupBonus()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div id="signupBonusConfig" style="padding-left: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label style="width: 100px;">Points</label>
                                    <input type="number" class="form-input" id="signupBonusPoints" value="100" min="0" style="width: 150px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--gray-dark);">Point Expiration</h3>
                        <div class="form-group">
                            <label class="form-label">Points Expire After</label>
                            <select class="form-select" id="pointsExpiration">
                                <option value="never">Never</option>
                                <option value="6months">6 Months</option>
                                <option value="1year">1 Year</option>
                                <option value="2years">2 Years</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tier Configuration (shown based on selection) -->
            <div class="content-section" id="tierConfiguration">
                <!-- Lifetime Tiers Configuration -->
                <div id="lifetimeTiersConfig" style="display: block;">
                    <div class="section-header">
                        <h2 class="section-title">🏆 Lifetime Tier Configuration</h2>
                    </div>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Tier 1 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #cd7f32;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier 1 Name</label>
                                    <input type="text" class="form-input" id="tier1Name" value="Bronze" placeholder="e.g., Bronze">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Required</label>
                                    <input type="number" class="form-input" id="tier1Points" value="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tier1DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all">All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tier1Discount" value="0" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tier1BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all">All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tier1Multiplier" value="1" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tier 2 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier 2 Name</label>
                                    <input type="text" class="form-input" id="tier2Name" value="Silver" placeholder="e.g., Silver">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Required</label>
                                    <input type="number" class="form-input" id="tier2Points" value="1000" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tier2DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all">All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tier2Discount" value="5" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tier2BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tier2Multiplier" value="1.25" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tier 3 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #ffd700;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier 3 Name</label>
                                    <input type="text" class="form-input" id="tier3Name" value="Gold" placeholder="e.g., Gold">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Required</label>
                                    <input type="number" class="form-input" id="tier3Points" value="5000" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tier3DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tier3Discount" value="10" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tier3BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tier3Multiplier" value="1.5" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Temporary Tiers Configuration -->
                <div id="temporaryTiersConfig" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">⏰ Temporary Tier Configuration</h2>
                    </div>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Temp Tier 1 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #9c27b0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier Name</label>
                                    <input type="text" class="form-input" id="tempTier1Name" value="VIP Pass" placeholder="e.g., VIP Pass">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Payment Options</label>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier1PayCash" checked onchange="toggleTempTierPayment(1)">
                                            <span style="font-size: 0.875rem;">Cash ($)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier1PayPoints" onchange="toggleTempTierPayment(1)">
                                            <span style="font-size: 0.875rem;">Loyalty Points</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" id="tempTier1CashCost">
                                    <label class="form-label">Cost ($)</label>
                                    <input type="number" class="form-input" id="tempTier1Cost" value="19.99" min="0" step="0.01">
                                </div>
                                <div class="form-group" id="tempTier1PointsCost" style="display: none;">
                                    <label class="form-label">Cost (Points)</label>
                                    <input type="number" class="form-input" id="tempTier1PointsPrice" value="2000" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration (Days)</label>
                                    <input type="number" class="form-input" id="tempTier1Duration" value="30" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tempTier1DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tempTier1Discount" value="15" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tempTier1BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tempTier1Multiplier" value="2" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Temp Tier 2 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #e91e63;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier Name</label>
                                    <input type="text" class="form-input" id="tempTier2Name" value="Premium Pass" placeholder="e.g., Premium Pass">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Payment Options</label>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier2PayCash" checked onchange="toggleTempTierPayment(2)">
                                            <span style="font-size: 0.875rem;">Cash ($)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier2PayPoints" onchange="toggleTempTierPayment(2)">
                                            <span style="font-size: 0.875rem;">Loyalty Points</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" id="tempTier2CashCost">
                                    <label class="form-label">Cost ($)</label>
                                    <input type="number" class="form-input" id="tempTier2Cost" value="49.99" min="0" step="0.01">
                                </div>
                                <div class="form-group" id="tempTier2PointsCost" style="display: none;">
                                    <label class="form-label">Cost (Points)</label>
                                    <input type="number" class="form-input" id="tempTier2PointsPrice" value="5000" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration (Days)</label>
                                    <input type="number" class="form-input" id="tempTier2Duration" value="90" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tempTier2DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tempTier2Discount" value="20" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tempTier2BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tempTier2Multiplier" value="3" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bonuses Only Configuration -->
                <div id="bonusesOnlyConfig" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">🎁 Bonuses Configuration</h2>
                    </div>
                    
                    <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <p style="color: var(--gray); margin-bottom: 1.5rem;">
                            With Bonuses Only mode, members earn points on purchases and can redeem them for rewards. 
                            No tier system is used - all members are treated equally.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Referral Bonus Points</label>
                                <input type="number" class="form-input" id="referralBonus" value="250" min="0">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                    Points awarded when referring a new member
                                </p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Review Bonus Points</label>
                                <input type="number" class="form-input" id="reviewBonus" value="50" min="0">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                    Points for leaving a review
                                </p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Social Share Bonus</label>
                                <input type="number" class="form-input" id="socialBonus" value="25" min="0">
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                    Points for sharing on social media
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div> <!-- End loyaltyProgramContent -->

        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             ART LIBRARY SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Art Library Section -->
        <section id="artlibrary" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Art Library</h1>
            </div>

            <div class="content-section">
                <div style="text-align: center; padding: 4rem 2rem; color: var(--gray);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🎨</div>
                    <h2 style="color: var(--gray-dark); margin-bottom: 1rem;">Art Library Coming Soon</h2>
                    <p style="max-width: 500px; margin: 0 auto; line-height: 1.6;">
                        The art library feature will be available in a future update. 
                        For now, packages and items will display with simple, clean designs.
                    </p>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             INTEGRATIONS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Integrations Section -->
        <section id="integrations" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Integrations</h1>
                <p class="content-subtitle">Connect with external systems and services</p>
            </div>
            
            <div class="content-section">
                <div class="integration-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem;">
                    
                    <!-- BMS1 Integration -->
                    <div class="integration-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #9c27b0;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #9c27b0, #ba68c8); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                🎲
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">BMS1 Legacy</h3>
                                <p style="margin: 0.25rem 0; color: var(--gray); font-size: 0.875rem;">NewCo v1</p>
                            </div>
                        </div>
                        <div style="margin: 1rem 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 8px; height: 8px; background: #ff9800; border-radius: 50%;"></span>
                                <span style="font-size: 0.875rem; color: #ff9800;">Disconnected</span>
                            </div>
                            <p style="color: var(--gray); font-size: 0.9rem; line-height: 1.5;">
                                Import data from your existing BMS1 system for migration.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Database Connection</label>
                            <input type="text" class="form-input" id="bms1Connection" placeholder="Connection string">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-input" id="bms1Username" placeholder="BMS1 username">
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" style="flex: 1;">Connect</button>
                            <button class="btn btn-secondary" style="flex: 1;">Import Data</button>
                        </div>
                    </div>
                    
                    <!-- BMS2 Integration -->
                    <div class="integration-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #4caf50;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #4caf50, #66bb6a); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                🎰
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">BMS2 Cloud</h3>
                                <p style="margin: 0.25rem 0; color: var(--gray); font-size: 0.875rem;">NewCo v2</p>
                            </div>
                        </div>
                        <div style="margin: 1rem 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%;"></span>
                                <span style="font-size: 0.875rem; color: #4caf50;">Connected</span>
                            </div>
                            <p style="color: var(--gray); font-size: 0.9rem; line-height: 1.5;">
                                Two-way sync with BMS2 Cloud for unified operations.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Endpoint</label>
                            <input type="text" class="form-input" id="bms2Endpoint" placeholder="https://api.bms2.com" value="https://api.bms2.com/v2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Access Token</label>
                            <input type="password" class="form-input" id="bms2Token" placeholder="BMS2 access token" value="••••••••••••••••">
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" style="flex: 1;">Refresh Token</button>
                            <button class="btn btn-success" style="flex: 1;">Sync All</button>
                        </div>
                    </div>
                    
                    <!-- Merchant Processing -->
                    <div class="integration-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ff9800;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #ff9800, #ffb74d); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                💳
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">Merchant Processing</h3>
                                <p style="margin: 0.25rem 0; color: var(--gray); font-size: 0.875rem;">Payment Gateway Integration</p>
                            </div>
                        </div>
                        <div style="margin: 1rem 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%;"></span>
                                <span style="font-size: 0.875rem; color: #4caf50;">Active</span>
                            </div>
                            <p style="color: var(--gray); font-size: 0.9rem; line-height: 1.5;">
                                Process credit card and ACH payments securely.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Processor</label>
                            <select class="form-select" id="merchantProcessor">
                                <option value="stripe">Stripe</option>
                                <option value="square">Square</option>
                                <option value="paypal">PayPal</option>
                                <option value="authorize">Authorize.net</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Merchant ID</label>
                            <input type="text" class="form-input" id="merchantId" placeholder="Your merchant ID" value="MERCH-789456">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Secret Key</label>
                            <input type="password" class="form-input" id="merchantSecret" placeholder="Secret key" value="••••••••••••••••">
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" style="flex: 1;">Verify</button>
                            <button class="btn btn-secondary" style="flex: 1;">Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             TRANSACTIONS LOG SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <section id="transactions" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Transactions Log</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportTransactions()">
                        📊 Export Data
                    </button>
                    <button class="btn btn-danger" onclick="deleteTestTransactions()" style="background: #dc3545; color: white;">
                        🗑️ Delete Test Transactions
                    </button>
                    <button class="btn btn-primary" onclick="loadTransactions()">
                        🔄 Refresh
                    </button>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">💳 Transaction Analytics</h2>
                    <p class="section-subtitle">View and analyze all transaction data</p>
                </div>
                
                <!-- Transaction Analytics Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #2196f3;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Daily Total</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #2196f3;" id="dailyTotal">$1,247.50</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">47 transactions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #4caf50;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Monthly Total</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #4caf50;" id="monthlyTotal">$28,945.75</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">1,234 transactions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ff9800;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Loyalty Earned</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ff9800;" id="loyaltyEarned">15,420</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">points today</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #9c27b0;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Floor vs Web</h3>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #9c27b0;">65% / 35%</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">Floor / Web split</div>
                    </div>
                </div>
                
                <!-- Transaction Filters -->
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                        <div class="form-group">
                            <label class="form-label">Transaction Source</label>
                            <select class="form-select" id="filterSource" onchange="filterTransactions()">
                                <option value="all">All Sources</option>
                                <option value="floor">Floor</option>
                                <option value="website">Website</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Type</label>
                            <select class="form-select" id="filterCustomerType" onchange="filterTransactions()">
                                <option value="all">All Customers</option>
                                <option value="identified">Identified</option>
                                <option value="headless">Headless (Anonymous)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salesperson</label>
                            <select class="form-select" id="filterSalesperson" onchange="filterTransactions()">
                                <option value="all">All</option>
                                <option value="Web">Web</option>
                                <option value="Paymaster">Paymaster</option>
                                <optgroup label="Staff">
                                    <option value="Alice Chen">Alice Chen</option>
                                    <option value="Bob Martinez">Bob Martinez</option>
                                    <option value="Carol White">Carol White</option>
                                    <option value="David Kim">David Kim</option>
                                    <option value="Emma Jones">Emma Jones</option>
                                    <option value="Frank Miller">Frank Miller</option>
                                    <option value="Grace Taylor">Grace Taylor</option>
                                    <option value="Henry Wilson">Henry Wilson</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="filterDateRange" onchange="filterTransactions()">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rewards Eligible</label>
                            <select class="form-select" id="filterRewardsEligible" onchange="filterTransactions()">
                                <option value="all">All Transactions</option>
                                <option value="eligible">Rewards Eligible</option>
                                <option value="not-eligible">Not Eligible</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="exportTransactions()" style="width: 100%;">
                                📊 Export Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;">
                    <div style="padding: 1.5rem 1.5rem 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Recent Transactions</h3>
                            <span style="color: var(--gray); font-size: 0.875rem;" id="transactionCount">Showing 50 of 1,234 transactions</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--gray-lighter);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('source')">Source <span id="sortArrowSource">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('customer')">Customer <span id="sortArrowCustomer">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('salesperson')">Salesperson <span id="sortArrowSalesperson">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('date')">Date/Time <span id="sortArrowDate">↓</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('type')">Type <span id="sortArrowType">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('amount')">Amount <span id="sortArrowAmount">↕️</span></th>
                                    <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('status')">Status <span id="sortArrowStatus">↕️</span></th>
                                    <th style="padding: 1rem; text-align: right; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" id="loyaltyPointsHeader" onclick="sortTransactions('loyalty')">Loyalty Points <span id="sortArrowLoyalty">↕️</span></th>
                                    <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- Transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-outline" onclick="loadTransactionPage('prev')">← Previous</button>
                        <span style="color: var(--gray); font-size: 0.875rem;">Page 1 of 25</span>
                        <button class="btn btn-outline" onclick="loadTransactionPage('next')">Next →</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             REWARDS TRANSACTIONS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <section id="rewardstransactions" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Rewards Transactions</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportRewardsTransactions()">
                        📊 Export Rewards Data
                    </button>
                    <button class="btn btn-primary" onclick="loadRewardsTransactions()">
                        🔄 Refresh
                    </button>
                </div>
            </div>
            
            <div class="content-section">
                <!-- Rewards Transaction Tabs -->
                <div style="border-bottom: 1px solid var(--gray-light); margin-bottom: 2rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" id="earnedTab" onclick="switchRewardsTab('earned')" style="border-radius: 8px 8px 0 0;">
                            ⭐ Points Earned
                        </button>
                        <button class="btn btn-outline" id="redeemedTab" onclick="switchRewardsTab('redeemed')" style="border-radius: 8px 8px 0 0;">
                            🎁 Points Redeemed
                        </button>
                    </div>
                </div>
                
                <!-- Rewards Analytics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ffa726;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Points Earned Today</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ffa726;" id="pointsEarnedToday">15,420</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">183 transactions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #26a69a;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Points Redeemed Today</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #26a69a;" id="pointsRedeemedToday">8,750</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">45 redemptions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ab47bc;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Net Points</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ab47bc;" id="netPointsToday">+6,670</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">earned - redeemed</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #5c6bc0;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Active Members</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #5c6bc0;" id="activeMembers">1,247</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">with activity today</div>
                    </div>
                </div>
                
                <!-- Rewards Transaction Filters -->
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                        <div class="form-group">
                            <label class="form-label">Transaction Type</label>
                            <select class="form-select" id="filterRewardsType" onchange="filterRewardsTransactions()">
                                <option value="all" id="filterAllOption">All Transactions</option>
                                <option value="earned" id="filterEarnedOption">Points Earned</option>
                                <option value="redeemed" id="filterRedeemedOption">Points Redeemed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select class="form-select" id="filterRewardsSource" onchange="filterRewardsTransactions()">
                                <option value="all">All Sources</option>
                                <option value="floor">Floor Purchase</option>
                                <option value="website">Website Purchase</option>
                                <option value="bonus">Bonus Points</option>
                                <option value="birthday">Birthday Bonus</option>
                                <option value="referral">Referral Bonus</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="filterRewardsDateRange" onchange="filterRewardsTransactions()">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Member Status</label>
                            <select class="form-select" id="filterMemberStatus" onchange="filterRewardsTransactions()">
                                <option value="all">All Members</option>
                                <option value="tier1">Tier 1</option>
                                <option value="tier2">Tier 2</option>
                                <option value="tier3">Tier 3</option>
                                <option value="vip">VIP</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Rewards Transactions Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;">
                    <div style="padding: 1.5rem 1.5rem 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;" id="rewardsTableTitle">Recent Rewards Transactions</h3>
                            <span style="color: var(--gray); font-size: 0.875rem;" id="rewardsTransactionCount">Showing 50 of 2,847 transactions</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--gray-lighter);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('date')">Date/Time <span id="sortArrowRewardsDate">↓</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('member')">Member <span id="sortArrowRewardsMember">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('type')">Type <span id="sortArrowRewardsType">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('source')">Source <span id="sortArrowRewardsSource">↕️</span></th>
                                    <th style="padding: 1rem; text-align: right; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('points')">Points <span id="sortArrowRewardsPoints">↕️</span></th>
                                    <th style="padding: 1rem; text-align: right; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('balance')">Balance <span id="sortArrowRewardsBalance">↕️</span></th>
                                    <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('status')">Status <span id="sortArrowRewardsStatus">↕️</span></th>
                                </tr>
                            </thead>
                            <tbody id="rewardsTransactionsTableBody">
                                <!-- Rewards transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-outline" onclick="loadRewardsTransactionPage('prev')">← Previous</button>
                        <span style="color: var(--gray); font-size: 0.875rem;" id="rewardsPagination">Page 1 of 58</span>
                        <button class="btn btn-outline" onclick="loadRewardsTransactionPage('next')">Next →</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Actions Log Section -->
        <section id="actionslog" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Actions Log</h1>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="clearActionsLog()">Clear Log</button>
                    <button class="btn btn-primary" onclick="exportActionsLog()">Export CSV</button>
                </div>
            </div>
            
            <div class="content-main">
                <!-- Filters -->
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label class="form-label">User</label>
                            <select class="form-select" id="filterActionUser" onchange="filterActionsLog()">
                                <option value="all">All Users</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Action Type</label>
                            <select class="form-select" id="filterActionType" onchange="filterActionsLog()">
                                <option value="all">All Actions</option>
                                <option value="create">Create</option>
                                <option value="update">Update</option>
                                <option value="delete">Delete</option>
                                <option value="save">Save Settings</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="filterActionDate" onchange="filterActionsLog()">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-input" id="searchActionDetails" placeholder="Search details..." oninput="filterActionsLog()">
                        </div>
                    </div>
                </div>
                
                <!-- Actions Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; margin-top: 1.5rem;">
                    <div style="padding: 1.5rem 1.5rem 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Recent Actions</h3>
                            <span style="color: var(--gray); font-size: 0.875rem;" id="actionsCount">Showing 0 actions</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--gray-lighter);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('timestamp')">Timestamp <span id="sortArrowActionTimestamp">↓</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('user')">User <span id="sortArrowActionUser">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('action')">Action <span id="sortArrowActionAction">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light);">Details</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('section')">Section <span id="sortArrowActionSection">↕️</span></th>
                                </tr>
                            </thead>
                            <tbody id="actionsLogTableBody">
                                <!-- Actions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-outline" onclick="loadActionsPage('prev')">← Previous</button>
                        <span style="color: var(--gray); font-size: 0.875rem;" id="actionsPageInfo">Page 1 of 1</span>
                        <button class="btn btn-outline" onclick="loadActionsPage('next')">Next →</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Reports Section -->
        <section id="reports" class="content-panel" style="display: none;">
            <div class="header-bar">
                <div>
                    <h1 class="header-title">📊 Reports & Analytics</h1>
                    <p style="color: var(--gray); margin-top: 0.25rem;">View and export detailed business reports</p>
                </div>
                <div class="header-actions">
                    <select class="form-select" id="reportDateRange" style="width: 200px;">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <button class="btn btn-primary" onclick="exportReports()">
                        📥 Export All
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="reportRevenue">$24,586</div>
                    <div class="stat-change positive">↑ 12.5% vs last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sessions Played</div>
                    <div class="stat-value" id="reportSessions">847</div>
                    <div class="stat-change positive">↑ 8.3% vs last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Revenue/Session</div>
                    <div class="stat-value" id="reportAvgRevenue">$29.03</div>
                    <div class="stat-change positive">↑ 3.9% vs last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Member Growth</div>
                    <div class="stat-value" id="reportMemberGrowth">+47</div>
                    <div class="stat-change positive">↑ 23% vs last month</div>
                </div>
            </div>

            <!-- Report Categories -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Available Reports</h2>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                    <!-- Financial Reports -->
                    <div class="report-card" style="border: 1px solid var(--success); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">💰</span>
                            <div>
                                <h3 style="margin: 0;">Financial Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Revenue, expenses, and profitability</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('revenue')">📈 Revenue Report</button>
                            <button class="btn btn-outline" onclick="viewReport('expenses')">📉 Expense Report</button>
                            <button class="btn btn-outline" onclick="viewReport('profit')">💵 Profit & Loss</button>
                            <button class="btn btn-outline" onclick="viewReport('tax')">📋 Tax Summary</button>
                        </div>
                    </div>

                    <!-- Session Reports -->
                    <div class="report-card" style="border: 1px solid var(--primary); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">🎯</span>
                            <div>
                                <h3 style="margin: 0;">Session Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Game performance and attendance</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('attendance')">👥 Attendance Report</button>
                            <button class="btn btn-outline" onclick="viewReport('winners')">🏆 Winners Report</button>
                            <button class="btn btn-outline" onclick="viewReport('payouts')">💸 Payout Analysis</button>
                            <button class="btn btn-outline" onclick="viewReport('popularity')">⭐ Game Popularity</button>
                        </div>
                    </div>

                    <!-- Member Reports -->
                    <div class="report-card" style="border: 1px solid var(--warning); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">👥</span>
                            <div>
                                <h3 style="margin: 0;">Member Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Customer insights and loyalty</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('demographics')">📊 Demographics</button>
                            <button class="btn btn-outline" onclick="viewReport('retention')">🔄 Retention Analysis</button>
                            <button class="btn btn-outline" onclick="viewReport('lifetime')">💎 Lifetime Value</button>
                            <button class="btn btn-outline" onclick="viewReport('loyalty')">⭐ Loyalty Points</button>
                        </div>
                    </div>

                    <!-- Sales Reports -->
                    <div class="report-card" style="border: 1px solid var(--secondary); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">🛍️</span>
                            <div>
                                <h3 style="margin: 0;">Sales Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Product and package performance</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('packages')">📦 Package Sales</button>
                            <button class="btn btn-outline" onclick="viewReport('concessions')">🍿 Concessions</button>
                            <button class="btn btn-outline" onclick="viewReport('merchandise')">👕 Merchandise</button>
                            <button class="btn btn-outline" onclick="viewReport('channels')">📱 Sales Channels</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Report Runs -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Reports</h2>
                </div>
                
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-lighter);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Report Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Date Range</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Generated</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentReportsTable">
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Monthly Revenue Report</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 1-30, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">2 hours ago</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="viewSavedReport(1)">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadReport(1)">Download</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Weekly Attendance Report</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 18-24, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Yesterday</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="viewSavedReport(2)">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadReport(2)">Download</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Member Demographics</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">All Time</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">3 days ago</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="viewSavedReport(3)">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadReport(3)">Download</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Emails Section -->
        <section id="emails" class="content-panel" style="display: none;">
            <div class="header-bar">
                <div>
                    <h1 class="header-title">✉️ Email Center</h1>
                    <p style="color: var(--gray); margin-top: 0.25rem;">Manage automated emails and campaigns</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="testEmailSetup()">
                        🧪 Test Email Setup
                    </button>
                    <button class="btn btn-primary" onclick="createEmailCampaign()">
                        ➕ New Campaign
                    </button>
                </div>
            </div>

            <!-- Email Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Emails Sent (30d)</div>
                    <div class="stat-value">3,847</div>
                    <div class="stat-change positive">↑ 15.2%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Open Rate</div>
                    <div class="stat-value">42.7%</div>
                    <div class="stat-change positive">↑ 3.1%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Click Rate</div>
                    <div class="stat-value">8.9%</div>
                    <div class="stat-change negative">↓ 0.5%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unsubscribe Rate</div>
                    <div class="stat-value">0.3%</div>
                    <div class="stat-change positive">↓ 0.1%</div>
                </div>
            </div>

            <!-- Email Templates -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Automated Email Templates</h2>
                    <p class="section-subtitle">Configure emails that are sent automatically based on triggers</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                    <!-- Welcome Email -->
                    <div class="email-template-card" style="border: 2px solid var(--primary); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">👋 Welcome Email</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent when new member signs up</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="welcomeEmailEnabled" checked>
                                <label for="welcomeEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> Welcome to Santa Clara Bingo!</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> 2 hours ago</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 247 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('welcome')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('welcome')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('welcome')">Send Test</button>
                        </div>
                    </div>

                    <!-- Birthday Email -->
                    <div class="email-template-card" style="border: 2px solid var(--warning); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">🎂 Birthday Bonus</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent 7 days before birthday</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="birthdayEmailEnabled" checked>
                                <label for="birthdayEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> 🎉 Your Birthday Bonus Awaits!</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> Yesterday</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 18 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('birthday')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('birthday')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('birthday')">Send Test</button>
                        </div>
                    </div>

                    <!-- Win Notification -->
                    <div class="email-template-card" style="border: 2px solid var(--success); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">🏆 Winner Notification</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent after winning a game</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="winnerEmailEnabled">
                                <label for="winnerEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> Congratulations on Your Win!</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> 3 hours ago</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 89 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('winner')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('winner')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('winner')">Send Test</button>
                        </div>
                    </div>

                    <!-- Inactive Member -->
                    <div class="email-template-card" style="border: 2px solid var(--danger); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">😴 Win-Back Campaign</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent after 30 days inactive</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="winbackEmailEnabled" checked>
                                <label for="winbackEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> We Miss You! Come Back for Free Credits</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> 5 days ago</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 34 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('winback')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('winback')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('winback')">Send Test</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Campaigns -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Email Campaigns</h2>
                    <p class="section-subtitle">One-time email blasts to your member list</p>
                </div>
                
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-lighter);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Campaign Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Recipients</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Sent Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Open Rate</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="emailCampaignsTableBody">
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎁 New Year's Eve Extravaganza</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--warning); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Scheduled</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">~1,300</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Dec 31, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">-</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="editCampaign(1)">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="cancelCampaign(1)">Cancel</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎅 December Holiday Jackpot Alert</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Draft</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">~1,300</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Dec 15, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">-</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="editCampaign(2)">Edit</button>
                                    <button class="btn btn-sm btn-primary" onclick="sendCampaign(2)">Send</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎄 Holiday Special Announcement</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,247</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 25, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">48.3%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(3)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(3)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🦃 Thanksgiving Week Schedule</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,189</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 20, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">52.1%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(4)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(4)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎃 Halloween Spooktacular</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,156</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Oct 25, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">55.8%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(5)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(5)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">💰 Double Points Weekend</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,098</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Oct 10, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">61.2%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(6)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(6)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🏆 VIP Member Exclusive</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">124</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Sep 28, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">72.5%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(7)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(7)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎯 Weekly Game Schedule</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--secondary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Recurring</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,247</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Every Monday</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">45.6%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="editRecurring(8)">Edit</button>
                                    <button class="btn btn-sm btn-outline" onclick="pauseRecurring(8)">Pause</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Email Settings -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Email Settings</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">From Name</label>
                        <input type="text" class="form-input" value="Santa Clara Bingo" id="emailFromName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">From Email</label>
                        <input type="email" class="form-input" value="hello@santaclarabingo.com" id="emailFromAddress">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reply-To Email</label>
                        <input type="email" class="form-input" value="support@santaclarabingo.com" id="emailReplyTo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Footer</label>
                        <textarea class="form-input" rows="3" id="emailFooter">Santa Clara Bingo | 123 Main St, Santa Clara, CA 95050 | (408) 555-0123</textarea>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="saveEmailSettings()">Save Email Settings</button>
                </div>
            </div>
        </section>
        
        <!-- Other sections will be added here -->
    </main>

    <!-- Auto-save indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <span class="loading"></span>
        <span>Saving...</span>
    </div>

    <!-- Modal for adding/editing -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Modal Title</h2>
            </div>
            <div id="modalBody">
                <!-- Modal content will be injected here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize NewcoData if not already initialized
        if (typeof NewcoData !== 'undefined') {
            NewcoData.init();

            // Initialize master admin user if not exists
            const staff = NewcoData.get('staff') || [];
            const masterAdminExists = staff.some(s => s.role === 'master-admin');

            if (!masterAdminExists) {
                // Create initial master admin
                staff.push({
                    id: 'master_admin_' + Date.now(),
                    name: 'Master Admin',
                    email: 'admin@newco.com',
                    role: 'master-admin',
                    status: 'Active',
                    permissions: ['all'],
                    createdAt: new Date().toISOString()
                });
                NewcoData.set('staff', staff);

                // Set initial password
                const adminUsers = NewcoData.get('adminUsers') || {};
                if (!adminUsers['admin@newco.com']) {
                    adminUsers['admin@newco.com'] = 'admin123';
                    NewcoData.set('adminUsers', adminUsers);
                }
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // HELPER FUNCTIONS - Reduce code duplication
        // ═══════════════════════════════════════════════════════════════════
        
        /**
         * Generic delete with confirmation
         */
        function deleteWithConfirm(array, index, message, displayFunc, saveFunc, useModal = false) {
            const doDelete = () => {
                array.splice(index, 1);
                if (displayFunc) displayFunc();
                if (saveFunc) saveFunc();
                return true;
            };
            
            if (useModal && typeof showConfirm === 'function') {
                showConfirm(message || 'Delete this item?', doDelete);
            } else if (confirm(message || 'Delete this item?')) {
                return doDelete();
            }
            return false;
        }
        
        /**
         * Generic duplicate item
         */
        function duplicateItem(array, index, idPrefix, displayFunc, saveFunc) {
            const original = array[index];
            const duplicate = {
                ...original,
                id: generateId(idPrefix),
                name: (original.name || '') + ' (Copy)'
            };
            array.push(duplicate);
            if (displayFunc) displayFunc();
            if (saveFunc) saveFunc();
            return duplicate;
        }
        
        /**
         * Generate unique ID
         */
        function generateId(prefix = 'id') {
            return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }
        
        /**
         * Get nested object value safely
         */
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current?.[key], obj);
        }
        
        /**
         * Generic table generator
         */
        function generateTable(data, columns, actions) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            ${columns.map(col => `<th>${col.label}</th>`).join('')}
                            ${actions ? '<th>Actions</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map((item, index) => `
                            <tr>
                                ${columns.map(col => `
                                    <td>${getNestedValue(item, col.key) || ''}</td>
                                `).join('')}
                                ${actions ? `
                                    <td>
                                        ${actions.map(action => `
                                            <button class="btn-small" onclick="${action.handler}(${index})">
                                                ${action.label}
                                            </button>
                                        `).join('')}
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        /**
         * Generic pagination controls
         */
        function generatePagination(currentPage, totalPages, changePageFunc) {
            return `
                <div class="pagination">
                    <button onclick="${changePageFunc}(1)" ${currentPage === 1 ? 'disabled' : ''}>
                        First
                    </button>
                    <button onclick="${changePageFunc}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                        Previous
                    </button>
                    <span>Page ${currentPage} of ${totalPages}</span>
                    <button onclick="${changePageFunc}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                        Next
                    </button>
                    <button onclick="${changePageFunc}(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                        Last
                    </button>
                </div>
            `;
        }
        
        /**
         * Generic CSV export
         */
        function exportToCSV(data, columns, filename) {
            const headers = columns.map(col => col.label);
            const rows = data.map(item => 
                columns.map(col => {
                    const value = getNestedValue(item, col.key) || '';
                    // Escape commas and quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                })
            );
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        /**
         * Safe DOM value setter
         */
        function setElementValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = !!value;
                } else {
                    element.value = value || '';
                }
            }
        }
        
        /**
         * Safe DOM value getter
         */
        function getElementValue(id) {
            const element = document.getElementById(id);
            if (!element) return '';
            return element.type === 'checkbox' ? element.checked : element.value;
        }
        
        /**
         * Generic form validation
         */
        function validateRequired(value, fieldName) {
            if (!value || value.toString().trim() === '') {
                showAlert(`${fieldName} is required`, 'error');
                return false;
            }
            return true;
        }

        // Auto-save functionality from wizard
        let autoSaveTimeout;
        let hasUnsavedChanges = false;

        function showAutoSave() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.innerHTML = '✓ Saved';
                setTimeout(() => {
                    indicator.classList.remove('show');
                    indicator.innerHTML = '<span class="loading"></span><span>Saving...</span>';
                }, 1000);
            }, 500);
        }

        function autoSave() {
            if (hasUnsavedChanges) {
                saveAllData();
                hasUnsavedChanges = false;
                showAutoSave();
                document.getElementById('lastSaved').textContent = `Last saved: ${new Date().toLocaleTimeString()}`;
            }
        }

        function markUnsaved() {
            hasUnsavedChanges = true;
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSave, 2000); // Auto-save after 2 seconds of inactivity
        }

        // Save all data to NewcoData
        function saveAllData() {
            // This will be expanded as we add more sections
            const org = NewcoData.get("organization");
            // Save any changes made in the UI
            NewcoData.updateOrganization(org);
        }

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Show selected section
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
            }
            
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Load section data
            loadSectionData(sectionId);
        }

        // Load data for each section
        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'organization':
                    loadOrganization();
                    break;
                case 'halls':
                    loadHalls();
                    break;
                case 'staff':
                    loadStaff();
                    break;
                case 'pagebuilder':
                    loadPageBuilder();
                    break;
                case 'themes':
                    loadThemes();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'branding':
                    loadBranding();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'packages':
                    loadPackages();
                    break;
                case 'salesItems':
                    loadSalesItems();
                    break;
                case 'redemption':
                case 'purchasing':
                case 'floor-rewards':
                    loadStoreOperationsSettings();
                    break;
                case 'loyaltyItems':
                    loadLoyaltyItems();
                    break;
                case 'artlibrary':
                    loadArtLibrary();
                    break;
                case 'marketing':
                    loadMarketing();
                    break;
                case 'members':
                    loadMembers();
                    break;
                case 'rewards':
                    loadRewards();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'actionslog':
                    loadActionsLog();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'emails':
                    loadEmails();
                    break;
                // Add more cases as we build out sections
            }
        }

        // Dashboard functions
        function loadDashboard() {
            const stats = calculateStats();
            updateDashboardStats(stats);
            loadRecentActivity();
        }

        function calculateStats() {
            const transactions = NewcoData.get('transactions') || [];
            const members = NewcoData.get('members') || [];
            const schedules = NewcoData.get('schedules') || {};
            const halls = NewcoData.get('halls') || [];

            // Calculate today's revenue
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => {
                const transDate = new Date(t.timestamp || t.date);
                return transDate.toDateString() === today;
            });
            const todayRevenue = todayTransactions.reduce((sum, t) => sum + (t.total || t.amount || 0), 0);

            // Calculate yesterday's revenue for comparison
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            const yesterdayTransactions = transactions.filter(t => {
                const transDate = new Date(t.timestamp || t.date);
                return transDate.toDateString() === yesterdayStr;
            });
            const yesterdayRevenue = yesterdayTransactions.reduce((sum, t) => sum + (t.total || t.amount || 0), 0);
            const revenueChange = yesterdayRevenue > 0 ? (((todayRevenue - yesterdayRevenue) / yesterdayRevenue) * 100).toFixed(1) : 0;

            // Count active sessions today
            const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const todayDay = daysOfWeek[new Date().getDay()];
            let activeSessions = 0;
            Object.values(schedules).forEach(schedule => {
                if (schedule[todayDay]) {
                    activeSessions++;
                }
            });

            // Count members added this week
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const newMembersThisWeek = members.filter(m => {
                const joinDate = new Date(m.joinDate || m.createdAt);
                return joinDate >= weekAgo;
            }).length;

            // Calculate occupancy rate
            const totalCapacity = halls.reduce((sum, h) => sum + (h.capacity || 0), 0);
            const totalBooked = todayTransactions.reduce((sum, t) => sum + (t.seats || 1), 0);
            const occupancyRate = totalCapacity > 0 ? Math.round((totalBooked / totalCapacity) * 100) : 0;

            return {
                revenue: todayRevenue,
                revenueChange: revenueChange,
                activeSessions: activeSessions,
                totalMembers: members.length,
                newMembersThisWeek: newMembersThisWeek,
                occupancyRate: occupancyRate,
                seatsBooked: totalBooked
            };
        }

        function updateDashboardStats(stats) {
            // Update stat cards with real data
            const statCards = document.querySelectorAll('.stat-value');
            const statChanges = document.querySelectorAll('.stat-change');

            if (statCards[0]) statCards[0].textContent = `$${stats.revenue.toFixed(2)}`;
            if (statChanges[0]) {
                const changeClass = stats.revenueChange >= 0 ? 'positive' : 'negative';
                const arrow = stats.revenueChange >= 0 ? '↑' : '↓';
                statChanges[0].className = `stat-change ${changeClass}`;
                statChanges[0].textContent = `${arrow} ${Math.abs(stats.revenueChange)}% from yesterday`;
            }

            if (statCards[1]) statCards[1].textContent = stats.activeSessions;
            if (statChanges[1]) {
                statChanges[1].textContent = `${stats.activeSessions} scheduled today`;
            }

            if (statCards[2]) statCards[2].textContent = stats.totalMembers;
            if (statChanges[2]) {
                const changeClass = stats.newMembersThisWeek > 0 ? 'positive' : '';
                statChanges[2].className = `stat-change ${changeClass}`;
                statChanges[2].textContent = `↑ ${stats.newMembersThisWeek} new this week`;
            }

            if (statCards[3]) statCards[3].textContent = `${stats.occupancyRate}%`;
            if (statChanges[3]) {
                statChanges[3].textContent = `${stats.seatsBooked} seats filled`;
            }
        }

        function loadRecentActivity() {
            const transactions = NewcoData.get('transactions') || [];
            const activityTable = document.getElementById('activityTable');

            if (!activityTable) return;

            // Get last 10 transactions
            const recentTransactions = transactions
                .sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date))
                .slice(0, 10);

            if (recentTransactions.length === 0) {
                activityTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--gray);">
                            No recent activity
                        </td>
                    </tr>
                `;
                return;
            }

            activityTable.innerHTML = recentTransactions.map(t => {
                const time = new Date(t.timestamp || t.date);
                const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const dateStr = time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <tr>
                        <td>${dateStr} ${timeStr}</td>
                        <td><span class="badge badge-success">Booking</span></td>
                        <td>${t.customerName || 'Guest'} - ${t.packageName || 'Package'}</td>
                        <td style="font-weight: 600; color: var(--success);">$${(t.total || t.amount || 0).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        function refreshDashboard() {
            loadDashboard();
            showAutoSave();
        }

        // Branding functions  
        function loadBranding() {
            const org = NewcoData.get("organization") || {};
            
            // Load logo or show initials
            if (org.logo) {
                document.getElementById('logoPreview').innerHTML = `<img src="${org.logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
            } else if (org.name) {
                // Show initials if no logo but have name
                const initials = org.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
                document.getElementById('logoPreview').innerHTML = initials;
            }
            
            // Load colors
            if (org.colors) {
                document.getElementById('brandPrimaryColor').value = org.colors.primary || '#2ea3f2';
                document.getElementById('brandPrimaryHex').value = org.colors.primary || '#2ea3f2';
                document.getElementById('brandSecondaryColor').value = org.colors.secondary || '#9c27b0';
                document.getElementById('brandSecondaryHex').value = org.colors.secondary || '#9c27b0';
            }
            
            // Load messaging
            document.getElementById('brandOrgName').value = org.name || '';
            document.getElementById('brandTagline').value = org.tagline || '';
        }
        
        function saveBranding() {
            const org = NewcoData.get("organization") || {};
            
            org.name = document.getElementById('brandOrgName').value;
            org.tagline = document.getElementById('brandTagline').value;
            org.colors = {
                primary: document.getElementById('brandPrimaryColor').value,
                secondary: document.getElementById('brandSecondaryColor').value
            };
            
            NewcoData.updateOrganization(org);
            
            // Refresh all branding elements
            applyBrandingColors();
            
            // Update sidebar name immediately
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName) {
                sidebarOrgName.textContent = org.name || 'Admin Panel';
                document.title = (org.name || 'Admin') + ' - Management System';
            }
            
            showAutoSave();
        }
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const org = NewcoData.get('organization') || {};
                    
                    // Store logo in memory to avoid quota issues
                    if (!window.artStorage) {
                        window.artStorage = {};
                    }
                    
                    const logoId = 'logo_' + Date.now();
                    window.artStorage[logoId] = e.target.result;
                    org.logoId = logoId;
                    
                    // Don't store the actual logo data in org object to avoid quota issues
                    // The logo will be retrieved from window.artStorage using logoId
                    
                    try {
                        NewcoData.set('organization', org);
                    } catch (error) {
                        console.warn('Could not save logo to localStorage, keeping in memory:', error);
                        // Still update the display even if save fails
                    }
                    
                    // Update preview in branding section
                    document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
                    
                    // Update sidebar logo immediately
                    const sidebarLogo = document.getElementById('sidebarLogo');
                    if (sidebarLogo) {
                        sidebarLogo.innerHTML = `<img src="${e.target.result}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                    }
                    
                    markUnsaved();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function resetLogo() {
            const org = NewcoData.get('organization') || {};
            org.logo = null;
            org.logoId = null;
            
            // Clear from memory storage
            if (window.artStorage && org.logoId) {
                delete window.artStorage[org.logoId];
            }
            
            try {
                NewcoData.set('organization', org);
            } catch (error) {
                console.warn('Could not update localStorage:', error);
            }
            
            // Reset preview in branding section
            document.getElementById('logoPreview').innerHTML = '🎱';
            document.getElementById('logoUpload').value = '';
            
            // Reset sidebar logo
            const sidebarLogo = document.getElementById('sidebarLogo');
            if (sidebarLogo) {
                sidebarLogo.innerHTML = '🎱';
            }
            
            markUnsaved();
        }
        
        function updateBrandPreview() {
            const primary = document.getElementById('brandPrimaryColor').value;
            const secondary = document.getElementById('brandSecondaryColor').value;
            
            document.getElementById('brandPrimaryHex').value = primary;
            document.getElementById('brandSecondaryHex').value = secondary;
            document.getElementById('primaryPreview').style.background = primary;
            document.getElementById('secondaryPreview').style.background = secondary;
            document.getElementById('logoPreview').style.background = primary;
            
            markUnsaved();
        }
        
        function updateColorFromHex(type) {
            const hexInput = document.getElementById(`brand${type.charAt(0).toUpperCase() + type.slice(1)}Hex`);
            const colorInput = document.getElementById(`brand${type.charAt(0).toUpperCase() + type.slice(1)}Color`);
            if (hexInput && colorInput) {
                colorInput.value = hexInput.value;
                updateBrandPreview();
            }
        }
        
        // Settings functions
        function loadSettings() {
            const org = NewcoData.get("organization") || {};
            const settings = NewcoData.get('settings') || {};
            
            document.getElementById('settingsOrgName').value = org.name || '';
            document.getElementById('settingsLicense').value = org.licenseNumber || org.license || '';
            document.getElementById('settingsEmail').value = org.email || '';
            document.getElementById('settingsPhone').value = org.phone || '';
            document.getElementById('settingsAddress').value = org.address || '';
            document.getElementById('settingsWebsite').value = org.website || '';
            
            if (settings.timezone) {
                document.getElementById('settingsTimezone').value = settings.timezone;
            }
            if (settings.currency) {
                document.getElementById('settingsCurrency').value = settings.currency;
            }
            
            // Load new settings
            document.getElementById('settingsSeatLimit').value = settings.seatLimit || 1;
            document.getElementById('settingsTaxRate').value = settings.taxRate || 8.75;
            
            // Initialize payment settings if not set
            if (settings.paymentCard === undefined) {
                settings.paymentCard = true; // Default to card enabled
                NewcoData.set('settings', settings);
            }
            if (settings.paymentCash === undefined) {
                settings.paymentCash = false; // Default to cash disabled
                NewcoData.set('settings', settings);
            }
            
            document.getElementById('settingsPaymentCard').checked = settings.paymentCard === true;
            document.getElementById('settingsPaymentCash').checked = settings.paymentCash === true;
            document.getElementById('settingsPaymentCheck').checked = settings.paymentCheck === true;
            
            // Load tax exemption settings (default to true for charitable bingo)
            document.getElementById('settingsTaxExemptPackages').checked = settings.taxExemptPackages !== false;
            document.getElementById('settingsTaxExemptItems').checked = settings.taxExemptItems !== false;
            document.getElementById('settingsTaxExemptRewards').checked = settings.taxExemptRewards !== false;
            
            // Load points currency name
            document.getElementById('settingsPointsCurrency').value = settings.pointsCurrencyName || 'Loyalty Points';
        }
        
        function saveSettings() {
            const org = NewcoData.get("organization") || {};
            const settings = NewcoData.get('settings') || {};
            
            // Save org details
            org.name = document.getElementById('settingsOrgName').value;
            org.licenseNumber = document.getElementById('settingsLicense').value;
            org.email = document.getElementById('settingsEmail').value;
            org.phone = document.getElementById('settingsPhone').value;
            org.address = document.getElementById('settingsAddress').value;
            org.website = document.getElementById('settingsWebsite').value;
            
            // Save system settings
            settings.timezone = document.getElementById('settingsTimezone').value;
            settings.currency = document.getElementById('settingsCurrency').value;
            settings.pointsCurrencyName = document.getElementById('settingsPointsCurrency').value || 'Loyalty Points';
            settings.seatLimit = parseInt(document.getElementById('settingsSeatLimit').value) || 1;
            settings.taxRate = parseFloat(document.getElementById('settingsTaxRate').value) || 8.75;
            settings.paymentCard = document.getElementById('settingsPaymentCard').checked;
            settings.paymentCash = document.getElementById('settingsPaymentCash').checked;
            settings.paymentCheck = document.getElementById('settingsPaymentCheck').checked;
            
            // Save tax exemption settings
            settings.taxExemptPackages = document.getElementById('settingsTaxExemptPackages').checked;
            settings.taxExemptItems = document.getElementById('settingsTaxExemptItems').checked;
            settings.taxExemptRewards = document.getElementById('settingsTaxExemptRewards').checked;
            
            // Save points currency name
            settings.pointsCurrencyName = document.getElementById('settingsPointsCurrency').value || 'Loyalty Points';
            
            NewcoData.updateOrganization(org);
            NewcoData.set('settings', settings);
            showAutoSave();
        }

        // Organization functions (DEPRECATED - moved to Branding and Settings)
        function loadOrganization() {
            const org = NewcoData.get("organization");
            if (org) {
                document.getElementById('orgName').value = org.name || '';
                document.getElementById('orgLicense').value = org.licenseNumber || org.license || '';
                document.getElementById('orgEmail').value = org.email || '';
                document.getElementById('orgPhone').value = org.phone || '';
                document.getElementById('orgTagline').value = org.tagline || '';
                if (org.colors) {
                    document.getElementById('orgPrimaryColor').value = org.colors.primary || '#2ea3f2';
                    document.getElementById('orgSecondaryColor').value = org.colors.secondary || org.colors.accent || '#9c27b0';
                }
            }
        }

        function saveOrganization() {
            const org = {
                name: document.getElementById('orgName').value,
                licenseNumber: document.getElementById('orgLicense').value,
                email: document.getElementById('orgEmail').value,
                phone: document.getElementById('orgPhone').value,
                tagline: document.getElementById('orgTagline').value,
                colors: {
                    primary: document.getElementById('orgPrimaryColor').value,
                    secondary: document.getElementById('orgSecondaryColor').value
                }
            };
            
            NewcoData.updateOrganization(org);
            
            // Apply the new colors to the UI immediately
            applyBrandingColors();
            
            showAutoSave();
        }

        // Halls functions with layout designer from wizard
        function loadHalls() {
            let halls = NewcoData.get('halls') || [];
            const hallContent = document.getElementById('hallContent');

            // Ensure only one hall exists
            if (halls.length === 0) {
                halls = [{
                    id: 'main-hall',
                    name: 'Main Hall',
                    address: '',
                    capacity: 0,
                    seatingMapType: 'none', // none, manual, prebuilt
                    layout: {
                        rows: 15,
                        cols: 20,
                        cells: {}
                    }
                }];
                NewcoData.set('halls', halls);
            } else if (halls.length > 1) {
                // Keep only the first hall
                halls = [halls[0]];
                NewcoData.set('halls', halls);
            }

            const hall = halls[0];
            const index = 0;

            hallContent.innerHTML = '';

            // Create single hall content
            const content = document.createElement('div');
            content.className = 'content-section';
            content.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">Hall Configuration</h2>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                        <label style="font-weight: 600;">Name:</label>
                        <input type="text" class="form-input" id="hall-name-${index}"
                               value="${hall.name || 'Main Hall'}"
                               placeholder="Hall name"
                               onchange="updateHallInfo(${index}, 'name')"
                               style="width: 200px;">
                        <label style="font-weight: 600;">Address:</label>
                        <input type="text" class="form-input" id="hall-address-${index}"
                               value="${hall.address || ''}"
                               placeholder="Enter address"
                               onchange="updateHallInfo(${index}, 'address')"
                               style="flex: 1;">
                        <label style="font-weight: 600;">Capacity:</label>
                        <input type="number" class="form-input" id="hall-capacity-${index}"
                               value="${hall.capacity || 0}"
                               placeholder="Capacity"
                               onchange="updateHallInfo(${index}, 'capacity')"
                               style="width: 120px;">
                        <div id="seat-count-${index}" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary-light); border-radius: 4px; font-size: 0.875rem; color: var(--primary-dark);">
                            <strong>Seats in Layout:</strong> <span id="seat-count-value-${index}">0</span>
                        </div>
                    </div>
                </div>

                <!-- Seating Map Type Selection -->
                <div class="section-header" style="margin-top: 2rem;">
                    <h3 class="section-title">Seating Map Configuration</h3>
                    <div style="margin-top: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Seating Map Type:</label>
                        <select id="seating-map-type-${index}" class="form-input" style="width: 300px;" onchange="changeSeatingMapType(${index})">
                            <option value="none" ${(hall.seatingMapType || 'none') === 'none' ? 'selected' : ''}>No Seating Map</option>
                            <option value="manual" ${hall.seatingMapType === 'manual' ? 'selected' : ''}>Manual Configuration (Grid Designer)</option>
                            <option value="prebuilt" ${hall.seatingMapType === 'prebuilt' ? 'selected' : ''}>Prebuilt Map (Import .js file)</option>
                        </select>
                    </div>
                </div>

                <!-- Seating Map Content (changes based on type) -->
                <div id="seating-map-content-${index}" style="margin-top: 2rem;">
                    <!-- Content will be loaded here based on type -->
                </div>
            `;
            hallContent.appendChild(content);

            // Load the appropriate seating map content
            loadSeatingMapContent(hall, index);
        }

        function changeSeatingMapType(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            const hall = halls[hallIndex];
            const newType = document.getElementById(`seating-map-type-${hallIndex}`).value;

            hall.seatingMapType = newType;
            NewcoData.set('halls', halls);

            loadSeatingMapContent(hall, hallIndex);
        }

        function loadSeatingMapContent(hall, hallIndex) {
            const container = document.getElementById(`seating-map-content-${hallIndex}`);
            if (!container) return;

            const mapType = hall.seatingMapType || 'none';

            if (mapType === 'none') {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; background: var(--gray-lighter); border-radius: 8px;">
                        <p style="color: var(--gray); font-size: 1.1rem;">
                            No seating map configured. Seat selection will not be available.
                        </p>
                    </div>
                `;
            } else if (mapType === 'manual') {
                // Show the grid designer
                container.innerHTML = `
                    <div class="layout-designer">
                        <div class="layout-tools" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <button class="tool-btn active" onclick="selectLayoutTool('seat', ${hallIndex})" title="Place seats">
                                    💺 Place Seat
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('directional', ${hallIndex})" title="Place directional seats">
                                    🪑 Place Directional Seat
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('blocked', ${hallIndex})" title="Block areas">
                                    🚫 Blocked
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('entrance', ${hallIndex})" title="Mark entrances">
                                    🚪 Entrance
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('restroom', ${hallIndex})" title="Mark restrooms">
                                    🚻 Restroom
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('vip', ${hallIndex})" title="VIP areas">
                                    ⭐ VIP
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('custom', ${hallIndex})" title="Create custom area">
                                    🎨 Custom Area
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('clear', ${hallIndex})" title="Clear cells">
                                    🗑️ Clear
                                </button>
                            </div>

                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem;">Width:</label>
                                <input type="number" id="grid-width-${hallIndex}" min="5" max="30" value="${hall.layout?.width || hall.layout?.cols || 20}"
                                       style="width: 60px; padding: 0.25rem;" onchange="updateGridSize(${hallIndex})">
                                <label style="font-size: 0.875rem;">Height:</label>
                                <input type="number" id="grid-height-${hallIndex}" min="5" max="30" value="${hall.layout?.height || hall.layout?.rows || 15}"
                                       style="width: 60px; padding: 0.25rem;" onchange="updateGridSize(${hallIndex})">
                            </div>
                        </div>

                        <div id="custom-area-info-${hallIndex}" style="padding: 1rem; background: var(--primary-light); border-radius: 8px; margin: 0.5rem 0; display: none;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Creating Custom Area</strong>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <input type="text" id="custom-area-name-${hallIndex}" placeholder="Area name" style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;" readonly>
                                <input type="color" id="custom-area-color-${hallIndex}" value="#ff6b6b" style="width: 60px; height: 38px; border: 1px solid var(--gray-light); border-radius: 4px;" disabled>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <span id="custom-area-count-${hallIndex}">0 cells selected</span>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong style="display: block; margin-bottom: 0.5rem;">Text Orientation:</strong>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button onclick="updateCustomAreaOrientation(${hallIndex}, 'horizontal')" id="orient-horizontal-${hallIndex}" class="btn btn-outline" style="padding: 0.35rem 0.75rem; font-size: 0.7rem;">
                                        →
                                    </button>
                                    <button onclick="updateCustomAreaOrientation(${hallIndex}, 'vertical-left')" id="orient-vertical-left-${hallIndex}" class="btn btn-outline" style="padding: 0.35rem 0.75rem; font-size: 0.7rem;">
                                        ↓
                                    </button>
                                    <button onclick="updateCustomAreaOrientation(${hallIndex}, 'vertical-right')" id="orient-vertical-right-${hallIndex}" class="btn btn-outline" style="padding: 0.35rem 0.75rem; font-size: 0.7rem;">
                                        ↑
                                    </button>
                                    <div id="orientation-example-${hallIndex}" style="width: 80px; padding: 0.35rem; background: white; border-radius: 4px; font-size: 0.65rem; text-align: center; border: 1px solid var(--gray-light); overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                                        Custom Area
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="cancelCustomArea(${hallIndex})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="confirmCustomArea(${hallIndex})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    ✓ Confirm Area
                                </button>
                            </div>
                        </div>

                        <div id="layout-grid-${hallIndex}" class="layout-grid">
                            <!-- Grid will be generated here -->
                        </div>
                    </div>
                `;
                // Initialize layout grid
                initializeLayoutGrid(hall, hallIndex);
            } else if (mapType === 'prebuilt') {
                // Show prebuilt map upload/selection
                container.innerHTML = `
                    <div style="padding: 2rem; background: var(--gray-lighter); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem;">Import Prebuilt Seating Map</h4>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Upload .js Map File:</label>
                            <input type="file" id="prebuilt-map-file-${hallIndex}" accept=".js" onchange="loadPrebuiltMapFile(${hallIndex})"
                                   style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px; width: 100%; max-width: 500px;">
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                                Select a JavaScript file containing a seating map function (e.g., milpitas-grid-map.js)
                            </p>
                        </div>

                        ${hall.prebuiltMapCode ? `
                            <div style="margin-top: 1.5rem;">
                                <h5 style="color: var(--success); margin-bottom: 0.5rem;">✅ Prebuilt Map Loaded</h5>
                                <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid var(--success);">
                                    <p style="margin-bottom: 0.5rem;"><strong>Function Name:</strong> ${hall.prebuiltMapFunction || 'Unknown'}</p>
                                    <p style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                                        Map file loaded successfully. This map will be used for seat selection.
                                    </p>
                                    <button class="btn btn-danger" onclick="removePrebuiltMap(${hallIndex})" style="margin-top: 0.5rem; padding: 0.5rem 1rem;">
                                        Remove Map
                                    </button>
                                </div>

                                <!-- Preview Container -->
                                <div style="margin-top: 1rem;">
                                    <h5>Preview:</h5>
                                    <div id="prebuilt-map-preview-${hallIndex}" style="margin-top: 0.5rem; max-height: 500px; overflow: auto;">
                                        <!-- Preview will render here -->
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Render preview if map exists
                if (hall.prebuiltMapCode && hall.prebuiltMapFunction) {
                    renderPrebuiltMapPreview(hall, hallIndex);
                }
            }
        }

        function loadPrebuiltMapFile(hallIndex) {
            const fileInput = document.getElementById(`prebuilt-map-file-${hallIndex}`);
            const file = fileInput.files[0];

            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const code = e.target.result;

                // Extract function name from code (look for pattern: function functionName() or window.functionName =)
                const functionMatch = code.match(/function\s+(\w+)\s*\(/) || code.match(/window\.(\w+)\s*=/);
                const functionName = functionMatch ? functionMatch[1] : null;

                if (!functionName) {
                    alert('Could not find a valid function in the uploaded file. Please ensure the file contains a seating map function.');
                    return;
                }

                const halls = NewcoData.get('halls') || [];
                halls[hallIndex].prebuiltMapCode = code;
                halls[hallIndex].prebuiltMapFunction = functionName;
                NewcoData.set('halls', halls);

                // Reload the content to show success message and preview
                loadSeatingMapContent(halls[hallIndex], hallIndex);
            };
            reader.readAsText(file);
        }

        function removePrebuiltMap(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            delete halls[hallIndex].prebuiltMapCode;
            delete halls[hallIndex].prebuiltMapFunction;
            NewcoData.set('halls', halls);

            loadSeatingMapContent(halls[hallIndex], hallIndex);
        }

        function renderPrebuiltMapPreview(hall, hallIndex) {
            try {
                // Create a temporary container ID
                const containerId = `prebuilt-map-preview-${hallIndex}`;

                // Execute the prebuilt map code in a safe way
                eval(hall.prebuiltMapCode);

                // Call the function to render the map
                if (window[hall.prebuiltMapFunction]) {
                    window[hall.prebuiltMapFunction](containerId);
                }
            } catch (error) {
                console.error('Error rendering prebuilt map preview:', error);
                document.getElementById(`prebuilt-map-preview-${hallIndex}`).innerHTML = `
                    <p style="color: var(--danger); padding: 1rem; background: #ffebee; border-radius: 8px;">
                        Error rendering map preview: ${error.message}
                    </p>
                `;
            }
        }

        function switchHallTab(index) {
            // No longer needed - single hall only
        }

        function addNewHall() {
            // No longer needed - single hall only
            alert('Only one hall is supported. Please configure the existing hall.');
        }

        function deleteHall(index) {
            // No longer needed - single hall only
            alert('Cannot delete the main hall. You can modify its configuration instead.');
        }

        function updateHallInfo(hallIndex, field) {
            const halls = NewcoData.get('halls') || [];
            if (halls[hallIndex]) {
                const value = document.getElementById(`hall-${field}-${hallIndex}`).value;
                halls[hallIndex][field] = field === 'capacity' ? parseInt(value) || 0 : value;
                NewcoData.set('halls', halls);
            }
        }

        // Layout designer functions from wizard
        let currentTool = {};  // Track tool per hall: {0: 'table', 1: 'select'}
        let selectedCells = {};  // Track selected cells per hall: {0: Set(), 1: Set()}
        let tableCount = {};

        function initializeLayoutGrid(hall, hallIndex) {
            const gridContainer = document.getElementById(`layout-grid-${hallIndex}`);
            if (!gridContainer) return;
            
            // Handle both wizard format (width/height) and admin format (rows/cols)
            const rows = hall.layout?.rows || hall.layout?.height || 15;
            const cols = hall.layout?.cols || hall.layout?.width || 20;
            
            gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            if (!window.seatCount) window.seatCount = {};
            seatCount[hallIndex] = 0;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.dataset.hallIndex = hallIndex;

                    // Load existing cell data if available
                    if (hall.layout?.cells?.[`${r}-${c}`]) {
                        const cellData = hall.layout.cells[`${r}-${c}`];

                        // Handle different data formats
                        if (cellData.type) {
                            cell.className = `grid-cell ${cellData.type}`;

                            // Set display text based on type
                            if (cellData.type === 'seat') {
                                cell.textContent = cellData.label || cellData.seatNumber || '';
                                if (cellData.seatNumber) {
                                    cell.dataset.seatNumber = cellData.seatNumber;
                                    if (cellData.seatNumber > seatCount[hallIndex]) {
                                        seatCount[hallIndex] = cellData.seatNumber;
                                    }
                                }
                            } else if (cellData.type === 'directional') {
                                const directionSymbols = {
                                    'up': '↑',
                                    'down': '↓',
                                    'left': '←',
                                    'right': '→'
                                };
                                const direction = cellData.direction || 'up';
                                cell.innerHTML = `
                                    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                        <div style="position: absolute; top: 2px; font-size: 0.7rem;">${directionSymbols[direction]}</div>
                                        <div style="font-size: 0.8rem; font-weight: bold;">${cellData.seatNumber || ''}</div>
                                    </div>
                                `;
                                if (cellData.seatNumber) {
                                    cell.dataset.seatNumber = cellData.seatNumber;
                                    cell.dataset.direction = direction;
                                    if (cellData.seatNumber > seatCount[hallIndex]) {
                                        seatCount[hallIndex] = cellData.seatNumber;
                                    }
                                }
                            } else if (cellData.type === 'custom') {
                                cell.dataset.customName = cellData.customName;
                                cell.dataset.customColor = cellData.customColor;
                                cell.dataset.customAreaId = cellData.customAreaId;
                                cell.dataset.textOrientation = cellData.textOrientation || 'horizontal';
                                cell.style.backgroundColor = cellData.customColor;
                                cell.style.color = '#fff';
                                cell.style.fontWeight = 'bold';

                                // We'll calculate borders after loading all cells
                                cell.textContent = '';
                            } else if (cellData.type === 'blocked') {
                                cell.textContent = '❌';
                            } else if (cellData.type === 'entrance') {
                                cell.textContent = '🚪';
                            } else if (cellData.type === 'restroom') {
                                cell.textContent = '🚻';
                            } else if (cellData.type === 'vip') {
                                cell.textContent = '⭐';
                            } else {
                                cell.textContent = cellData.label || cellData.name || '';
                            }

                            // Apply table styling if this is part of a table
                            if (cellData.isTable && cellData.tableId) {
                                cell.classList.add('table-group');
                                cell.dataset.tableId = cellData.tableId;
                                // Don't change background or text color - keep seat styling
                                // Borders will be applied by applyTableBorders function
                            }
                        } else if (cellData.marker) {
                            // Handle markers (entrance, restroom)
                            if (cellData.marker === 'entrance') {
                                cell.className = 'grid-cell entrance';
                                cell.textContent = '🚪';
                            } else if (cellData.marker === 'restroom') {
                                cell.className = 'grid-cell restroom';
                                cell.textContent = '🚻';
                            }
                        } else if (typeof cellData === 'string') {
                            // Handle legacy string format
                            cell.className = `grid-cell ${cellData}`;
                            cell.textContent = cellData;
                        }
                    }

                    cell.onclick = (e) => handleLayoutCellClick(e, hallIndex, r, c);
                    gridContainer.appendChild(cell);
                }
            }

            // After loading all cells, apply merged styling to custom areas
            applyCustomAreaMerging(hallIndex);

            // Apply borders to table groups
            applyTableBorders(hallIndex);

            // Update seat count display
            updateSeatCount(hallIndex);
        }

        function applyTableBorders(hallIndex) {
            // Group table cells by tableId
            const tableCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"].table-group`);
            const tableGroups = {};

            tableCells.forEach(cell => {
                const tableId = cell.dataset.tableId;
                if (!tableGroups[tableId]) {
                    tableGroups[tableId] = [];
                }
                tableGroups[tableId].push(cell);
            });

            // For each table, calculate bounds and apply borders
            Object.entries(tableGroups).forEach(([tableId, cells]) => {
                if (cells.length === 0) return;

                // Get all cell coordinates
                const coords = cells.map(cell => ({
                    row: parseInt(cell.dataset.row),
                    col: parseInt(cell.dataset.col),
                    cell: cell
                }));

                const minRow = Math.min(...coords.map(c => c.row));
                const maxRow = Math.max(...coords.map(c => c.row));
                const minCol = Math.min(...coords.map(c => c.col));
                const maxCol = Math.max(...coords.map(c => c.col));

                // Apply borders to each cell
                coords.forEach(({ row, col, cell }) => {
                    const isTopEdge = row === minRow;
                    const isBottomEdge = row === maxRow;
                    const isLeftEdge = col === minCol;
                    const isRightEdge = col === maxCol;

                    if (isTopEdge) cell.style.borderTop = '3px solid #4CAF50';
                    if (isBottomEdge) cell.style.borderBottom = '3px solid #4CAF50';
                    if (isLeftEdge) cell.style.borderLeft = '3px solid #4CAF50';
                    if (isRightEdge) cell.style.borderRight = '3px solid #4CAF50';

                    // Remove internal borders
                    if (!isTopEdge) cell.style.borderTop = 'none';
                    if (!isBottomEdge) cell.style.borderBottom = 'none';
                    if (!isLeftEdge) cell.style.borderLeft = 'none';
                    if (!isRightEdge) cell.style.borderRight = 'none';
                });
            });
        }

        function applyCustomAreaMerging(hallIndex) {
            // Group cells by customAreaId
            const customCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"].custom`);
            const areaGroups = {};

            customCells.forEach(cell => {
                const areaId = cell.dataset.customAreaId || `${cell.dataset.customName}-${cell.dataset.customColor}`;
                if (!areaGroups[areaId]) {
                    areaGroups[areaId] = [];
                }
                areaGroups[areaId].push(cell);
            });

            // For each custom area, calculate bounds and apply merged styling
            Object.entries(areaGroups).forEach(([areaId, cells]) => {
                if (cells.length === 0) return;

                const coords = cells.map(c => ({
                    row: parseInt(c.dataset.row),
                    col: parseInt(c.dataset.col),
                    cell: c
                }));

                const minRow = Math.min(...coords.map(c => c.row));
                const maxRow = Math.max(...coords.map(c => c.row));
                const minCol = Math.min(...coords.map(c => c.col));
                const maxCol = Math.max(...coords.map(c => c.col));

                const areaName = cells[0].dataset.customName;
                const areaColor = cells[0].dataset.customColor;

                // Apply borders and find top-left cell
                let topLeftCell = null;
                cells.forEach(cell => {
                    const r = parseInt(cell.dataset.row);
                    const c = parseInt(cell.dataset.col);

                    const isTopEdge = r === minRow;
                    const isBottomEdge = r === maxRow;
                    const isLeftEdge = c === minCol;
                    const isRightEdge = c === maxCol;

                    cell.style.borderTop = isTopEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderBottom = isBottomEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderLeft = isLeftEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderRight = isRightEdge ? `3px solid ${areaColor}` : 'none';

                    if (r === minRow && c === minCol) {
                        topLeftCell = cell;
                    }
                });

                // Add text overlay to top-left cell
                if (topLeftCell) {
                    const rowSpan = maxRow - minRow + 1;
                    const colSpan = maxCol - minCol + 1;
                    const orientation = topLeftCell.dataset.textOrientation || 'horizontal';

                    let transform = 'none';
                    if (orientation === 'vertical-left') {
                        transform = 'rotate(-90deg)';
                    } else if (orientation === 'vertical-right') {
                        transform = 'rotate(90deg)';
                    }

                    topLeftCell.style.position = 'relative';
                    topLeftCell.innerHTML = `
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: ${colSpan * 100}%;
                            height: ${rowSpan * 100}%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: ${Math.min(1.5, Math.max(0.75, colSpan * 0.4))}rem;
                            padding: 0.5rem;
                            pointer-events: none;
                            z-index: 1;
                            transform: ${transform};
                        ">${areaName}</div>
                    `;
                }
            });
        }

        function selectLayoutTool(tool, hallIndex, skipModal = false) {
            currentTool[hallIndex] = tool;

            // Remove active from all layout tool buttons
            const buttons = document.querySelectorAll('.layout-designer .tool-btn');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Add active to the clicked tool button
            const toolMap = {
                'seat': '💺',
                'directional': '🪑',
                'blocked': '🚫',
                'entrance': '🚪',
                'restroom': '🚻',
                'vip': '⭐',
                'custom': '🎨',
                'clear': '🗑️'
            };

            buttons.forEach(btn => {
                const btnText = btn.textContent.trim();
                if (toolMap[tool] && btnText.includes(toolMap[tool])) {
                    btn.classList.add('active');
                }
            });

            // Show modals only if not skipping
            if (!skipModal) {
                if (tool === 'custom') {
                    startCustomAreaSelection(hallIndex);
                } else if (tool === 'seat') {
                    showSeatNumberModal(hallIndex);
                } else if (tool === 'directional') {
                    showDirectionalSeatModal(hallIndex);
                } else if (tool === 'blocked') {
                    showBlockedColorModal(hallIndex);
                }
            }
        }

        function showBlockedColorModal(hallIndex) {
            if (!window.blockedColor) window.blockedColor = {};
            const currentColor = blockedColor[hallIndex] || '#f44336';

            showModal({
                title: '🚫 Blocked Area Color',
                message: `
                    <div style="padding: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Choose Blocked Color</label>
                        <input type="color" id="blockedColorPicker" value="${currentColor}"
                            style="width: 100%; height: 50px; border: 1px solid var(--gray-light); border-radius: 6px; cursor: pointer;">
                    </div>
                `,
                confirmText: 'OK',
                cancelText: 'Cancel',
                showCancel: true,
                autoClose: false,
                onConfirm: () => {
                    const color = document.getElementById('blockedColorPicker').value;
                    blockedColor[hallIndex] = color;
                },
                onCancel: () => {
                    selectLayoutTool('blocked', hallIndex, true);
                }
            });
        }

        function showSeatNumberModal(hallIndex) {
            // Get the next seat number
            if (!window.seatCount) window.seatCount = {};
            if (!seatCount[hallIndex]) seatCount[hallIndex] = 0;
            const nextNumber = seatCount[hallIndex] + 1;

            showModal({
                title: '💺 Place Seat',
                message: `
                    <div style="padding: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Start with what number?</label>
                        <input type="number" id="seatStartNumber" value="${nextNumber}" min="1"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1rem;">
                    </div>
                `,
                confirmText: 'OK',
                cancelText: 'Cancel',
                showCancel: true,
                autoClose: false,
                onConfirm: () => {
                    const startNumber = parseInt(document.getElementById('seatStartNumber').value) || nextNumber;
                    seatCount[hallIndex] = startNumber - 1; // Set to one before so next seat will be this number
                },
                onCancel: () => {
                    selectLayoutTool('seat', hallIndex, true); // Keep seat tool active, skip modal
                }
            });
        }

        function showDirectionalSeatModal(hallIndex) {
            // Get the next seat number
            if (!window.seatCount) window.seatCount = {};
            if (!seatCount[hallIndex]) seatCount[hallIndex] = 0;
            const nextNumber = seatCount[hallIndex] + 1;

            showModal({
                title: '🪑 Place Directional Seat',
                message: `
                    <div style="padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Seat Direction</label>
                            <select id="seatDirection" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1rem;">
                                <option value="up">↑ Up</option>
                                <option value="down">↓ Down</option>
                                <option value="left">← Left</option>
                                <option value="right">→ Right</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Start with what number?</label>
                            <input type="number" id="directionalStartNumber" value="${nextNumber}" min="1"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1rem;">
                        </div>
                    </div>
                `,
                confirmText: 'OK',
                cancelText: 'Cancel',
                showCancel: true,
                autoClose: false,
                onConfirm: () => {
                    const direction = document.getElementById('seatDirection').value;
                    const startNumber = parseInt(document.getElementById('directionalStartNumber').value) || nextNumber;

                    if (!window.directionalSeatConfig) {
                        window.directionalSeatConfig = {};
                    }
                    directionalSeatConfig[hallIndex] = {
                        direction: direction,
                        startNumber: startNumber
                    };
                    seatCount[hallIndex] = startNumber - 1; // Set to one before so next seat will be this number
                },
                onCancel: () => {
                    selectLayoutTool('seat', hallIndex, true); // Switch back to regular seat, skip modal
                }
            });
        }

        function startTableSelection(hallIndex) {
            // Initialize table selection cells if not exists
            if (!window.tableSelectionCells) {
                window.tableSelectionCells = {};
            }
            if (!tableSelectionCells[hallIndex]) {
                tableSelectionCells[hallIndex] = new Set();
            }
            tableSelectionCells[hallIndex].clear();

            // Show the table selection panel
            const panel = document.getElementById(`table-selection-panel-${hallIndex}`);
            if (panel) {
                panel.style.display = 'block';
            }

            // Clear any existing selections
            document.querySelectorAll(`[data-hall-index="${hallIndex}"].selected`).forEach(cell => {
                cell.classList.remove('selected');
            });

            updateTableSelectionCount(hallIndex);
        }

        function updateTableSelectionCount(hallIndex) {
            const countElement = document.getElementById(`table-selection-count-${hallIndex}`);
            if (countElement && tableSelectionCells[hallIndex]) {
                const count = tableSelectionCells[hallIndex].size;
                countElement.textContent = `${count} seat${count !== 1 ? 's' : ''} selected`;
            }
        }

        function isAdjacentToTableSelection(row, col, hallIndex) {
            if (!tableSelectionCells[hallIndex] || tableSelectionCells[hallIndex].size === 0) {
                return true; // First cell is always valid
            }

            const directions = [
                [-1, 0], [1, 0], [0, -1], [0, 1] // up, down, left, right
            ];

            for (let key of tableSelectionCells[hallIndex]) {
                const [r, c] = key.split('-').map(Number);
                for (let [dr, dc] of directions) {
                    if (r + dr === row && c + dc === col) {
                        return true;
                    }
                }
            }
            return false;
        }

        function confirmTableSelection(hallIndex) {
            if (!tableSelectionCells[hallIndex] || tableSelectionCells[hallIndex].size === 0) {
                showModal({
                    title: '⚠️ No Seats Selected',
                    message: 'Please select at least one seat to create a table.',
                    type: 'error'
                });
                return;
            }

            const tableId = `table-${hallIndex}-${Date.now()}`;

            // Find bounds of the table
            const coords = Array.from(tableSelectionCells[hallIndex]).map(key => {
                const [r, c] = key.split('-').map(Number);
                return { row: r, col: c };
            });

            const minRow = Math.min(...coords.map(c => c.row));
            const maxRow = Math.max(...coords.map(c => c.row));
            const minCol = Math.min(...coords.map(c => c.col));
            const maxCol = Math.max(...coords.map(c => c.col));

            // Apply table styling to all selected cells
            tableSelectionCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-').map(Number);
                const cell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`);

                if (cell) {
                    // Keep the existing seat class and styling
                    cell.classList.add('table-group');
                    cell.dataset.tableId = tableId;

                    // Apply green borders only on edges
                    const isTopEdge = r === minRow;
                    const isBottomEdge = r === maxRow;
                    const isLeftEdge = c === minCol;
                    const isRightEdge = c === maxCol;

                    if (isTopEdge) cell.style.borderTop = '3px solid #4CAF50';
                    if (isBottomEdge) cell.style.borderBottom = '3px solid #4CAF50';
                    if (isLeftEdge) cell.style.borderLeft = '3px solid #4CAF50';
                    if (isRightEdge) cell.style.borderRight = '3px solid #4CAF50';

                    // Remove internal borders
                    if (!isTopEdge) cell.style.borderTop = 'none';
                    if (!isBottomEdge) cell.style.borderBottom = 'none';
                    if (!isLeftEdge) cell.style.borderLeft = 'none';
                    if (!isRightEdge) cell.style.borderRight = 'none';
                }
            });

            // Clear selection and hide panel
            cancelTableSelection(hallIndex);
            saveHallLayout(hallIndex);
            markUnsaved();
        }

        function cancelTableSelection(hallIndex) {
            // Clear selections
            if (tableSelectionCells[hallIndex]) {
                tableSelectionCells[hallIndex].clear();
            }

            document.querySelectorAll(`[data-hall-index="${hallIndex}"].selected`).forEach(cell => {
                cell.classList.remove('selected');
            });

            // Hide panel
            const panel = document.getElementById(`table-selection-panel-${hallIndex}`);
            if (panel) {
                panel.style.display = 'none';
            }

            // Switch back to seat tool, skip modal
            selectLayoutTool('seat', hallIndex, true);
        }

        function startCustomAreaSelection(hallIndex) {
            // Initialize custom area cells if not exists
            if (!window.customAreaCells) {
                window.customAreaCells = {};
            }
            if (!customAreaCells[hallIndex]) {
                customAreaCells[hallIndex] = new Set();
            }
            customAreaCells[hallIndex].clear();

            // Initialize config with defaults
            if (!window.customAreaConfig) {
                window.customAreaConfig = {};
            }
            customAreaConfig[hallIndex] = {
                name: 'Custom Area',
                color: '#4A90E2',
                orientation: 'horizontal'
            };

            // Show the panel
            const customPanel = document.getElementById(`custom-area-info-${hallIndex}`);
            if (customPanel) {
                customPanel.style.display = 'block';
                document.getElementById(`custom-area-name-${hallIndex}`).value = customAreaConfig[hallIndex].name;
                document.getElementById(`custom-area-color-${hallIndex}`).value = customAreaConfig[hallIndex].color;
                // Make inputs editable
                document.getElementById(`custom-area-name-${hallIndex}`).removeAttribute('readonly');
                document.getElementById(`custom-area-color-${hallIndex}`).removeAttribute('disabled');
                // Add listeners to update config
                document.getElementById(`custom-area-name-${hallIndex}`).oninput = (e) => {
                    customAreaConfig[hallIndex].name = e.target.value;
                    previewCustomAreaText(hallIndex);
                    // Update example
                    const example = document.getElementById(`orientation-example-${hallIndex}`);
                    if (example) example.textContent = e.target.value || 'Custom Area';
                };
                document.getElementById(`custom-area-color-${hallIndex}`).oninput = (e) => {
                    customAreaConfig[hallIndex].color = e.target.value;
                    // Update selected cell colors
                    customAreaCells[hallIndex].forEach(cellKey => {
                        const [r, c] = cellKey.split('-').map(Number);
                        const cell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.backgroundColor = e.target.value;
                        }
                    });
                };
                updateCustomAreaInfo(hallIndex);
                // Highlight default orientation button
                updateOrientationButtons(hallIndex, 'horizontal');
            }
        }

        function updateCustomAreaOrientation(hallIndex, orientation) {
            if (!customAreaConfig[hallIndex]) return;

            // Update config
            customAreaConfig[hallIndex].orientation = orientation;

            // Update button states
            updateOrientationButtons(hallIndex, orientation);

            // Show live preview on selected cells
            previewCustomAreaText(hallIndex);
        }

        function updateOrientationButtons(hallIndex, activeOrientation) {
            // Remove active from all
            ['horizontal', 'vertical-left', 'vertical-right'].forEach(orient => {
                const btn = document.getElementById(`orient-${orient}-${hallIndex}`);
                if (btn) {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                }
            });

            // Add active to selected
            const activeBtn = document.getElementById(`orient-${activeOrientation}-${hallIndex}`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline');
                activeBtn.classList.add('btn-primary');
            }

            // Update example text
            const example = document.getElementById(`orientation-example-${hallIndex}`);
            if (example) {
                const areaName = customAreaConfig[hallIndex]?.name || 'Custom Area';
                let transform = 'none';
                if (activeOrientation === 'vertical-left') {
                    transform = 'rotate(-90deg)';
                } else if (activeOrientation === 'vertical-right') {
                    transform = 'rotate(90deg)';
                }
                example.style.transform = transform;
                example.textContent = areaName;
            }
        }

        function previewCustomAreaText(hallIndex) {
            if (!customAreaCells[hallIndex] || customAreaCells[hallIndex].size === 0) return;
            if (!customAreaConfig[hallIndex]) return;

            const config = customAreaConfig[hallIndex];
            const coords = Array.from(customAreaCells[hallIndex]).map(key => {
                const [r, c] = key.split('-').map(Number);
                return { row: r, col: c, key: key };
            });

            const minRow = Math.min(...coords.map(c => c.row));
            const minCol = Math.min(...coords.map(c => c.col));
            const maxRow = Math.max(...coords.map(c => c.row));
            const maxCol = Math.max(...coords.map(c => c.col));

            const rowSpan = maxRow - minRow + 1;
            const colSpan = maxCol - minCol + 1;

            let transform = 'none';
            if (config.orientation === 'vertical-left') {
                transform = 'rotate(-90deg)';
            } else if (config.orientation === 'vertical-right') {
                transform = 'rotate(90deg)';
            }

            // Clear all preview text first
            customAreaCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-').map(Number);
                const cell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`);
                if (cell) {
                    cell.innerHTML = '';
                }
            });

            // Add preview text to top-left cell
            const topLeftKey = `${minRow}-${minCol}`;
            const topLeftCell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${minRow}"][data-col="${minCol}"]`);

            if (topLeftCell) {
                topLeftCell.style.position = 'relative';
                topLeftCell.innerHTML = `
                    <div style="
                        position: absolute;
                        top: 0; left: 0;
                        width: ${colSpan * 100}%;
                        height: ${rowSpan * 100}%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: ${Math.min(1.5, Math.max(0.75, colSpan * 0.4))}rem;
                        font-weight: bold;
                        color: white;
                        transform: ${transform};
                        pointer-events: none;
                        z-index: 1;
                        opacity: 0.8;
                    ">${config.name}</div>
                `;
            }
        }

        function clearSelection(hallIndex) {
            if (selectedCells[hallIndex]) {
                selectedCells[hallIndex].clear();
            }
            document.querySelectorAll(`[data-hall-index="${hallIndex}"].selected`).forEach(cell => {
                cell.classList.remove('selected');
            });
            updateSelectionInfo(hallIndex);
        }
        
        function updateSelectionInfo(hallIndex) {
            const info = document.getElementById(`selection-info-${hallIndex}`);
            const count = document.getElementById(`selection-count-${hallIndex}`);
            if (!selectedCells[hallIndex]) {
                selectedCells[hallIndex] = new Set();
            }
            
            if (selectedCells[hallIndex].size > 0) {
                info.style.display = 'block';
                count.textContent = `${selectedCells[hallIndex].size} cells selected`;
            } else {
                info.style.display = 'none';
            }
        }

        function handleLayoutCellClick(event, hallIndex, row, col) {
            const cell = event.target;
            const tool = currentTool[hallIndex] || 'seat';
            const cellKey = `${row}-${col}`;

            if (tool === 'table-select') {
                // Table selection mode - only allow selecting existing seats
                const cellType = cell.className.replace('grid-cell', '').replace('selected', '').replace('table-group', '').trim();

                if (cellType !== 'seat' && cellType !== 'directional') {
                    showModal({
                        title: '⚠️ Invalid Selection',
                        message: 'You can only select existing seats to create a table.',
                        type: 'error'
                    });
                    return;
                }

                if (!tableSelectionCells[hallIndex]) {
                    tableSelectionCells[hallIndex] = new Set();
                }

                if (tableSelectionCells[hallIndex].has(cellKey)) {
                    // Deselect cell
                    tableSelectionCells[hallIndex].delete(cellKey);
                    cell.classList.remove('selected');
                } else {
                    // Check adjacency if not first cell
                    if (tableSelectionCells[hallIndex].size > 0) {
                        if (!isAdjacentToTableSelection(row, col, hallIndex)) {
                            showModal({
                                title: '⚠️ Invalid Selection',
                                message: 'All seats in a table must be adjacent to each other.',
                                type: 'error'
                            });
                            return;
                        }
                    }
                    tableSelectionCells[hallIndex].add(cellKey);
                    cell.classList.add('selected');
                }
                updateTableSelectionCount(hallIndex);
            } else if (tool === 'custom') {
                // Custom area selection mode with adjacency check
                if (!customAreaCells[hallIndex]) {
                    customAreaCells[hallIndex] = new Set();
                }

                if (customAreaCells[hallIndex].has(cellKey)) {
                    // Deselect cell
                    customAreaCells[hallIndex].delete(cellKey);
                    cell.classList.remove('selected');
                } else {
                    // Check adjacency if not first cell
                    if (customAreaCells[hallIndex].size > 0) {
                        if (!isAdjacentToCustomArea(row, col, hallIndex)) {
                            showModal({
                                title: '⚠️ Invalid Selection',
                                message: 'All custom area cells must be adjacent to each other.',
                                type: 'error'
                            });
                            return;
                        }
                    }
                    customAreaCells[hallIndex].add(cellKey);
                    cell.classList.add('selected');
                }
                updateCustomAreaInfo(hallIndex);
            } else if (tool === 'clear') {
                // Check if this is a table group cell
                if (cell.classList.contains('table-group') && cell.dataset.tableId) {
                    const tableId = cell.dataset.tableId;

                    // Find and clear all cells with the same table ID
                    const allCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"]`);
                    allCells.forEach(c => {
                        if (c.dataset.tableId === tableId) {
                            c.classList.remove('table-group');
                            delete c.dataset.tableId;
                            // Reset borders - remove all table borders
                            c.style.borderTop = '';
                            c.style.borderBottom = '';
                            c.style.borderLeft = '';
                            c.style.borderRight = '';
                            // Keep original background and color (seats stay blue)
                        }
                    });
                }
                // Check if this is a custom area cell
                else if (cell.classList.contains('custom') && cell.dataset.customName) {
                    const customName = cell.dataset.customName;
                    const customColor = cell.dataset.customColor;

                    // Find and clear all cells with the same custom area
                    const allCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"]`);
                    allCells.forEach(c => {
                        if (c.dataset.customName === customName && c.dataset.customColor === customColor) {
                            c.className = 'grid-cell';
                            c.textContent = '';
                            c.style.backgroundColor = '';
                            c.style.color = '';
                            c.style.fontWeight = '';
                            c.style.fontSize = '';
                            c.style.border = '';
                            c.style.display = '';
                            c.style.alignItems = '';
                            c.style.justifyContent = '';
                            delete c.dataset.customName;
                            delete c.dataset.customColor;
                        }
                    });
                } else {
                    // Clear single cell
                    cell.className = 'grid-cell';
                    cell.textContent = '';
                    cell.style.backgroundColor = '';
                    cell.style.color = '';
                    cell.style.fontWeight = '';
                    cell.style.fontSize = '';
                    cell.style.border = '';
                    delete cell.dataset.customName;
                    delete cell.dataset.customColor;
                    delete cell.dataset.seatNumber;
                }
                saveHallLayout(hallIndex);
                markUnsaved();
            } else {
                // Apply tool to cell immediately
                applyCellType(cell, tool, hallIndex, row, col);
                saveHallLayout(hallIndex);
                markUnsaved();
            }
        }
        
        function applyCellType(cell, type, hallIndex, row, col) {
            cell.className = `grid-cell ${type}`;

            if (type === 'seat') {
                if (!window.seatCount) window.seatCount = {};
                if (!seatCount[hallIndex]) seatCount[hallIndex] = 0;
                seatCount[hallIndex]++;
                cell.textContent = `${seatCount[hallIndex]}`;
                cell.dataset.seatNumber = seatCount[hallIndex];
            } else if (type === 'directional') {
                if (!window.seatCount) window.seatCount = {};
                if (!seatCount[hallIndex]) seatCount[hallIndex] = 0;
                seatCount[hallIndex]++;

                const config = window.directionalSeatConfig?.[hallIndex] || { direction: 'up' };
                const directionSymbols = {
                    'up': '↑',
                    'down': '↓',
                    'left': '←',
                    'right': '→'
                };

                cell.innerHTML = `
                    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <div style="position: absolute; top: 2px; font-size: 0.7rem;">${directionSymbols[config.direction]}</div>
                        <div style="font-size: 0.8rem; font-weight: bold;">${seatCount[hallIndex]}</div>
                    </div>
                `;
                cell.dataset.seatNumber = seatCount[hallIndex];
                cell.dataset.direction = config.direction;
            } else if (type === 'entrance') {
                cell.textContent = '🚪';
            } else if (type === 'restroom') {
                cell.textContent = '🚻';
            } else if (type === 'vip') {
                cell.textContent = '⭐';
            } else if (type === 'blocked') {
                cell.textContent = '❌';
                // Apply custom blocked color if set
                if (window.blockedColor && blockedColor[hallIndex]) {
                    cell.style.backgroundColor = blockedColor[hallIndex];
                }
            } else {
                cell.textContent = '';
            }
        }
        
        function applyToSelected(hallIndex) {
            if (!selectedCells[hallIndex] || selectedCells[hallIndex].size === 0) {
                showAlert('Please select cells first', 'Selection Required');
                return;
            }
            
            const tool = currentTool[hallIndex];
            if (!tool || tool === 'select') {
                showAlert('Please select a tool to apply', 'Tool Required');
                return;
            }
            
            if (tool === 'caller' || tool === 'vip') {
                // Prompt for custom name for special areas
                const name = prompt(`Enter name for ${tool === 'caller' ? 'caller station' : 'VIP area'}:`, 
                                   tool === 'caller' ? 'Caller Station' : 'VIP Section');
                if (!name) return;
                
                selectedCells[hallIndex].forEach(cellKey => {
                    const [r, c] = cellKey.split('-');
                    const cell = document.querySelector(
                        `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                    );
                    if (cell) {
                        cell.className = `grid-cell ${tool}`;
                        cell.textContent = tool === 'caller' ? '🎤' : '⭐';
                        cell.title = name;
                        cell.dataset.customName = name;
                    }
                });
            } else {
                // Apply tool to all selected cells
                selectedCells[hallIndex].forEach(cellKey => {
                    const [r, c] = cellKey.split('-');
                    const cell = document.querySelector(
                        `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                    );
                    if (cell) {
                        applyCellType(cell, tool, hallIndex);
                    }
                });
            }
            
            clearSelection(hallIndex);
            saveHallLayout(hallIndex);
            markUnsaved();
        }
        
        function updateGridSize(hallIndex) {
            const widthInput = document.getElementById(`grid-width-${hallIndex}`);
            const heightInput = document.getElementById(`grid-height-${hallIndex}`);
            
            if (!widthInput || !heightInput) return;
            
            const newWidth = parseInt(widthInput.value) || 20;
            const newHeight = parseInt(heightInput.value) || 15;
            
            // Clear and regenerate grid
            const halls = NewcoData.get('halls') || [];
            if (halls[hallIndex]) {
                // Save existing layout data
                const oldLayout = halls[hallIndex].layout || {};
                
                // Update dimensions
                halls[hallIndex].layout = {
                    ...oldLayout,
                    width: newWidth,
                    height: newHeight,
                    rows: newHeight,
                    cols: newWidth,
                    cells: oldLayout.cells || {}
                };
                
                NewcoData.set('halls', halls);
                
                // Regenerate grid display
                const gridContainer = document.getElementById(`layout-grid-${hallIndex}`);
                gridContainer.innerHTML = '';
                initializeLayoutGrid(halls[hallIndex], hallIndex);
            }
        }

        function saveHallLayout(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            if (!halls[hallIndex]) return;

            const cells = {};
            const gridCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"]`);

            gridCells.forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                const type = cell.className.replace('grid-cell', '').replace('selected', '').trim();

                if (type) {
                    const cellData = {
                        type: type,
                        label: cell.textContent
                    };

                    // Save custom area data
                    if (type === 'custom') {
                        cellData.customName = cell.dataset.customName;
                        cellData.customColor = cell.dataset.customColor;
                        cellData.customAreaId = cell.dataset.customAreaId;
                        cellData.textOrientation = cell.dataset.textOrientation || 'horizontal';
                        cellData.showText = cell.innerHTML.includes('position: absolute') ? true : false;
                    }

                    // Save seat number
                    if (type === 'seat' && cell.dataset.seatNumber) {
                        cellData.seatNumber = cell.dataset.seatNumber;
                    }

                    // Save directional seat data
                    if (type === 'directional' && cell.dataset.seatNumber) {
                        cellData.seatNumber = cell.dataset.seatNumber;
                        cellData.direction = cell.dataset.direction || 'up';
                    }

                    // Save table group data
                    if (cell.classList.contains('table-group') && cell.dataset.tableId) {
                        cellData.tableId = cell.dataset.tableId;
                        cellData.isTable = true;
                    }

                    cells[`${row}-${col}`] = cellData;
                }
            });

            const widthInput = document.getElementById(`grid-width-${hallIndex}`);
            const heightInput = document.getElementById(`grid-height-${hallIndex}`);

            halls[hallIndex].layout = {
                rows: heightInput ? parseInt(heightInput.value) : 15,
                cols: widthInput ? parseInt(widthInput.value) : 20,
                width: widthInput ? parseInt(widthInput.value) : 20,
                height: heightInput ? parseInt(heightInput.value) : 15,
                cells: cells
            };

            NewcoData.set('halls', halls);
            updateSeatCount(hallIndex);
        }

        function updateSeatCount(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            if (!halls[hallIndex] || !halls[hallIndex].layout || !halls[hallIndex].layout.cells) {
                return;
            }

            const cells = halls[hallIndex].layout.cells;
            let seatCount = 0;

            Object.values(cells).forEach(cellData => {
                if (cellData.type === 'seat' || cellData.type === 'vip' || cellData.type === 'directional') {
                    seatCount++;
                }
            });

            const countElement = document.getElementById(`seat-count-value-${hallIndex}`);
            if (countElement) {
                countElement.textContent = seatCount;
            }
        }

        // Custom Area Functions
        function updateCustomAreaInfo(hallIndex) {
            const count = document.getElementById(`custom-area-count-${hallIndex}`);
            if (count && customAreaCells[hallIndex]) {
                count.textContent = `${customAreaCells[hallIndex].size} cells selected`;
            }
            // Update preview when cells change
            previewCustomAreaText(hallIndex);
        }

        function isAdjacentToCustomArea(row, col, hallIndex) {
            // Check if the cell at (row, col) is adjacent to any cell in customAreaCells
            const directions = [
                [-1, 0], [1, 0], [0, -1], [0, 1] // up, down, left, right
            ];

            for (let key of customAreaCells[hallIndex]) {
                const [r, c] = key.split('-').map(Number);
                for (let [dr, dc] of directions) {
                    if (r + dr === row && c + dc === col) {
                        return true;
                    }
                }
            }
            return false;
        }

        function confirmCustomArea(hallIndex) {
            const nameInput = document.getElementById(`custom-area-name-${hallIndex}`);
            const colorInput = document.getElementById(`custom-area-color-${hallIndex}`);

            if (!nameInput.value.trim()) {
                showModal({
                    title: '⚠️ Name Required',
                    message: 'Please enter a name for the custom area.',
                    type: 'error'
                });
                return;
            }

            if (!customAreaCells[hallIndex] || customAreaCells[hallIndex].size === 0) {
                showModal({
                    title: '⚠️ No Cells Selected',
                    message: 'Please select cells for the custom area.',
                    type: 'error'
                });
                return;
            }

            const areaName = nameInput.value.trim();
            const areaColor = colorInput.value;
            const orientation = customAreaConfig[hallIndex]?.orientation || 'horizontal';

            // Find bounds of the custom area (min/max row and col)
            const cellArray = Array.from(customAreaCells[hallIndex]);
            const coords = cellArray.map(key => {
                const [r, c] = key.split('-').map(Number);
                return { row: r, col: c, key };
            });

            const minRow = Math.min(...coords.map(c => c.row));
            const maxRow = Math.max(...coords.map(c => c.row));
            const minCol = Math.min(...coords.map(c => c.col));
            const maxCol = Math.max(...coords.map(c => c.col));
            const topLeftCell = `${minRow}-${minCol}`;

            // Generate unique ID for this custom area
            const areaId = `custom-area-${hallIndex}-${Date.now()}`;

            // Apply custom area to all selected cells
            customAreaCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-').map(Number);
                const cell = document.querySelector(
                    `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                );
                if (cell) {
                    cell.className = 'grid-cell custom';
                    cell.style.backgroundColor = areaColor;
                    cell.style.color = '#fff';
                    cell.style.fontWeight = 'bold';
                    cell.dataset.customName = areaName;
                    cell.dataset.customColor = areaColor;
                    cell.dataset.customAreaId = areaId;
                    cell.classList.remove('selected');
                    cell.textContent = '';

                    // Remove borders between cells in same area, but keep outer border
                    const isTopEdge = r === minRow;
                    const isBottomEdge = r === maxRow;
                    const isLeftEdge = c === minCol;
                    const isRightEdge = c === maxCol;

                    cell.style.borderTop = isTopEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderBottom = isBottomEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderLeft = isLeftEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderRight = isRightEdge ? `3px solid ${areaColor}` : 'none';

                    // Create text overlay only in top-left cell
                    if (cellKey === topLeftCell) {
                        const rowSpan = maxRow - minRow + 1;
                        const colSpan = maxCol - minCol + 1;

                        let transform = 'none';
                        if (orientation === 'vertical-left') {
                            transform = 'rotate(-90deg)';
                        } else if (orientation === 'vertical-right') {
                            transform = 'rotate(90deg)';
                        }

                        cell.style.position = 'relative';
                        cell.innerHTML = `
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: ${colSpan * 100}%;
                                height: ${rowSpan * 100}%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: ${Math.min(1.5, Math.max(0.75, colSpan * 0.4))}rem;
                                padding: 0.5rem;
                                pointer-events: none;
                                z-index: 1;
                                transform: ${transform};
                            ">${areaName}</div>
                        `;

                        // Store orientation in dataset
                        cell.dataset.textOrientation = orientation;
                    }
                }
            });

            // Clear and reset
            customAreaCells[hallIndex].clear();
            nameInput.value = '';
            colorInput.value = '#ff6b6b';
            document.getElementById(`custom-area-info-${hallIndex}`).style.display = 'none';

            // Don't auto-select any tool
            currentTool[hallIndex] = null;
            // Remove active from all buttons
            document.querySelectorAll('.layout-designer .tool-btn').forEach(btn => btn.classList.remove('active'));

            saveHallLayout(hallIndex);
            markUnsaved();
        }

        function cancelCustomArea(hallIndex) {
            // Clear selection visuals
            customAreaCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-');
                const cell = document.querySelector(
                    `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                );
                if (cell) {
                    cell.classList.remove('selected');
                    cell.style.backgroundColor = '';
                    cell.innerHTML = '';
                }
            });

            // Clear data
            customAreaCells[hallIndex].clear();
            document.getElementById(`custom-area-name-${hallIndex}`).value = '';
            document.getElementById(`custom-area-color-${hallIndex}`).value = '#ff6b6b';
            document.getElementById(`custom-area-info-${hallIndex}`).style.display = 'none';

            // Don't auto-select any tool
            currentTool[hallIndex] = null;
            // Remove active from all buttons
            document.querySelectorAll('.layout-designer .tool-btn').forEach(btn => btn.classList.remove('active'));
        }

        function updateHallInfo(hallIndex, field) {
            const halls = NewcoData.get('halls') || [];
            if (!halls[hallIndex]) return;
            
            if (field === 'address') {
                halls[hallIndex].address = document.getElementById(`hall-address-${hallIndex}`).value;
            } else if (field === 'capacity') {
                halls[hallIndex].capacity = parseInt(document.getElementById(`hall-capacity-${hallIndex}`).value) || 0;
            }
            
            NewcoData.set('halls', halls);
            markUnsaved();
        }
        
        function deleteHall(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            deleteWithConfirm(
                halls,
                hallIndex,
                'Are you sure you want to delete this hall? This will also delete its layout and schedule.',
                () => {
                    // Also remove related schedules
                    const schedules = NewcoData.get('schedules') || {};
                    const deletedHall = halls[hallIndex];
                    
                    // Remove its schedule
                    if (deletedHall && schedules[deletedHall.id]) {
                        delete schedules[deletedHall.id];
                        NewcoData.set('schedules', schedules);
                    }
                    
                    NewcoData.set('halls', halls);
                    loadHalls();
                    showSuccess('Hall deleted successfully');
                },
                'Delete Hall'
            );
        }
        
        function addNewHall() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add New Hall';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Hall Name</label>
                    <input type="text" class="form-input" id="newHallName" placeholder="Main Hall">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="newHallAddress" placeholder="123 Main St">
                </div>
                <div class="form-group">
                    <label class="form-label">Capacity</label>
                    <input type="number" class="form-input" id="newHallCapacity" placeholder="200">
                </div>
            `;
            
            modalSaveBtn.onclick = () => {
                const halls = NewcoData.get('halls') || [];
                const newHall = {
                    id: Date.now().toString(),
                    name: document.getElementById('newHallName').value,
                    address: document.getElementById('newHallAddress').value,
                    capacity: parseInt(document.getElementById('newHallCapacity').value) || 0,
                    layout: {
                        rows: 15,
                        cols: 20,
                        cells: {}
                    }
                };
                
                halls.push(newHall);
                NewcoData.set('halls', halls);
                
                closeModal();
                loadHalls();
                showSuccess(`Hall "${newHall.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }

        // Staff functions from wizard
        // Staff Management - CRM Style Functions
        let currentStaffSort = { column: null, direction: 'asc' };
        let selectedStaff = new Set();
        
        function loadStaff() {
            const allStaff = NewcoData.get('staff') || [];
            // Filter out master admins from display
            const staff = allStaff.filter(s => s.role !== 'master-admin');
            const org = NewcoData.get("organization") || {};

            // Update statistics cards
            updateStaffStats(staff, org);

            // Load staff table
            loadStaffTable(staff, org);
        }
        
        function updateStaffStats(staff, org) {
            // Calculate stats
            const totalStaff = staff.length + (org.email ? 1 : 0); // Include super admin
            const today = new Date().toDateString();
            const activeToday = staff.filter(s => {
                const lastActive = s.lastActive ? new Date(s.lastActive).toDateString() : null;
                return lastActive === today;
            }).length;
            const managers = staff.filter(s => s.role === 'Manager' || s.role === 'Admin').length;
            const floorStaff = staff.filter(s => s.role === 'Floor Staff' || s.role === 'Caller' || s.role === 'Cashier').length;
            
            // Update the stat cards if they exist
            const statsContainer = document.querySelector('.content-section:has(.stat-value)');
            if (statsContainer) {
                const statValues = statsContainer.querySelectorAll('.stat-value');
                if (statValues[0]) statValues[0].textContent = totalStaff;
                if (statValues[1]) statValues[1].textContent = activeToday;
                if (statValues[2]) statValues[2].textContent = managers;
                if (statValues[3]) statValues[3].textContent = floorStaff;
            }
        }
        
        function loadStaffTable(staff, org) {
            const tbody = document.getElementById('staffTableBody');
            if (!tbody) {
                // Fallback to old style if new table doesn't exist
                loadStaffLegacy();
                return;
            }
            
            tbody.innerHTML = '';
            
            // Add Super Admin first if exists
            if (org.email) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" disabled></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${(org.name || 'SA').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${org.name || 'Super Admin'}</div>
                                <div style="font-size: 0.75rem; color: var(--gray);">ID: admin</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${org.email}</div>
                        <div style="font-size: 0.75rem; color: var(--gray);">${org.phone || 'No phone'}</div>
                    </td>
                    <td style="color: #6c5ce7; font-weight: 600;">SUPER ADMIN</td>
                    <td style="color: #27ae60; font-weight: 600;">Active</td>
                    <td>Always</td>
                    <td>
                        <button class="btn btn-sm" style="padding: 0.25rem 0.5rem;" disabled>
                            <span style="font-size: 1.25rem;">⋮</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            
            // Add other staff members
            staff.forEach((member, index) => {
                const tr = document.createElement('tr');
                const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const lastActive = member.lastActive ? new Date(member.lastActive).toLocaleDateString() : 'Never';
                const status = member.status || 'Active';
                const statusColor = status === 'Active' ? 'success' : status === 'Inactive' ? 'gray' : 'warning';
                
                tr.innerHTML = `
                    <td><input type="checkbox" onchange="toggleStaffSelection('${member.id || index}')" data-staff-id="${member.id || index}"></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: ${getColorForRole(member.role)}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${initials.substring(0, 2)}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${member.name}</div>
                                <div style="font-size: 0.75rem; color: var(--gray);">ID: ${member.id || 'staff-' + index}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${member.email}</div>
                        <div style="font-size: 0.75rem; color: var(--gray);">${member.phone || 'No phone'}</div>
                    </td>
                    <td style="color: ${getRoleTextColor(member.role)}; font-weight: 600;">${member.role}</td>
                    <td style="color: ${getStatusTextColor(status)}; font-weight: 600;">${status}</td>
                    <td>${lastActive}</td>
                    <td>
                        <button class="btn btn-sm" style="padding: 0.25rem 0.5rem;" onclick="showStaffActions(${index})">
                            <span style="font-size: 1.25rem;">⋮</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update selected count
            updateSelectedCount();
        }
        
        function loadStaffLegacy() {
            // Fallback to old card-based display if needed
            const staff = NewcoData.get('staff') || [];
            const org = NewcoData.get("organization") || {};
            const staffList = document.getElementById('staffList');
            
            if (!staffList) return;
            
            staffList.innerHTML = '';
            
            if (org.email) {
                const adminCard = document.createElement('div');
                adminCard.className = 'content-section';
                adminCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${org.name || 'Super Admin'}</strong><br>
                            <small style="color: var(--gray);">${org.email}</small><br>
                            <span class="btn btn-primary" style="margin-top: 0.5rem; display: inline-block; cursor: default;">
                                SUPER ADMIN
                            </span>
                        </div>
                        <div style="color: var(--gray); font-size: 0.875rem;">
                            <em>Primary Administrator</em>
                        </div>
                    </div>
                `;
                staffList.appendChild(adminCard);
            }
            
            staff.forEach((member, index) => {
                const card = document.createElement('div');
                card.className = 'content-section';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${member.name}</strong><br>
                            <small style="color: var(--gray);">${member.email}</small><br>
                            <span class="btn btn-secondary" style="margin-top: 0.5rem; display: inline-block;">
                                ${member.role}
                            </span>
                        </div>
                        <button class="btn btn-danger" onclick="removeStaff(${index})">
                            Remove
                        </button>
                    </div>
                `;
                staffList.appendChild(card);
            });
        }
        
        function getColorForRole(role) {
            const colors = {
                'Admin': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'Manager': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'Marketing Manager': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'Caller': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'Floor Staff': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'Cashier': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'Security': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            };
            return colors[role] || 'linear-gradient(135deg, #ccc 0%, #999 100%)';
        }
        
        function getRoleTextColor(role) {
            const colors = {
                'Admin': '#6c5ce7',
                'Manager': '#e74c3c',
                'Marketing Manager': '#3498db',
                'Caller': '#27ae60',
                'Floor Staff': '#f39c12',
                'Cashier': '#95a5a6',
                'Security': '#34495e'
            };
            return colors[role] || '#7f8c8d';
        }
        
        function getStatusTextColor(status) {
            const colors = {
                'Active': '#27ae60',
                'Inactive': '#95a5a6',
                'On Leave': '#f39c12'
            };
            return colors[status] || '#7f8c8d';
        }
        
        function toggleStaffSelection(staffId) {
            if (selectedStaff.has(staffId)) {
                selectedStaff.delete(staffId);
            } else {
                selectedStaff.add(staffId);
            }
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const bulkActions = document.querySelector('.bulk-actions');
            if (!bulkActions) return;
            
            const count = selectedStaff.size;
            if (count > 0) {
                bulkActions.style.display = 'flex';
                bulkActions.querySelector('span').textContent = `${count} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        function filterStaff() {
            const searchInput = document.getElementById('staffSearch');
            const roleFilter = document.getElementById('staffRoleFilter');
            const statusFilter = document.getElementById('staffStatusFilter');
            
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const roleValue = roleFilter ? roleFilter.value : '';
            const statusValue = statusFilter ? statusFilter.value : '';

            const allStaff = NewcoData.get('staff') || [];
            const org = NewcoData.get("organization") || {};

            const filtered = allStaff.filter(s => {
                // Filter out master admins
                if (s.role === 'master-admin') return false;

                const matchesSearch = !searchTerm ||
                    s.name.toLowerCase().includes(searchTerm) ||
                    s.email.toLowerCase().includes(searchTerm) ||
                    (s.role && s.role.toLowerCase().includes(searchTerm));

                const matchesRole = !roleValue || s.role === roleValue;
                const matchesStatus = !statusValue || (s.status || 'Active') === statusValue;

                return matchesSearch && matchesRole && matchesStatus;
            });
            
            loadStaffTable(filtered, org);
        }
        
        function sortStaff(column) {
            if (currentStaffSort.column === column) {
                currentStaffSort.direction = currentStaffSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentStaffSort.column = column;
                currentStaffSort.direction = 'asc';
            }

            const allStaff = NewcoData.get('staff') || [];
            // Filter out master admins before sorting
            const staff = allStaff.filter(s => s.role !== 'master-admin');
            const sorted = [...staff].sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (column === 'lastActive') {
                    aVal = a.lastActive ? new Date(a.lastActive).getTime() : 0;
                    bVal = b.lastActive ? new Date(b.lastActive).getTime() : 0;
                }
                
                if (currentStaffSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            const org = NewcoData.get("organization") || {};
            loadStaffTable(sorted, org);
        }
        
        function bulkUpdateStatus(status) {
            const staff = NewcoData.get('staff') || [];
            let updated = 0;
            
            staff.forEach(s => {
                if (selectedStaff.has(s.id)) {
                    s.status = status;
                    updated++;
                }
            });
            
            if (updated > 0) {
                NewcoData.set('staff', staff);
                selectedStaff.clear();
                loadStaff();
                showSuccess(`Updated status for ${updated} staff member(s)`);
            }
        }
        
        function exportStaff() {
            const staff = NewcoData.get('staff') || [];
            const org = NewcoData.get("organization") || {};
            
            // Add super admin to export
            const exportData = [];
            if (org.email) {
                exportData.push({
                    name: org.name || 'Super Admin',
                    email: org.email,
                    role: 'SUPER ADMIN',
                    phone: org.phone || '',
                    status: 'Active'
                });
            }
            
            staff.forEach(s => {
                exportData.push({
                    name: s.name,
                    email: s.email,
                    role: s.role,
                    phone: s.phone || '',
                    status: s.status || 'Active',
                    lastActive: s.lastActive || ''
                });
            });
            
            // Convert to CSV
            const csv = [
                'Name,Email,Role,Phone,Status,Last Active',
                ...exportData.map(s => 
                    `"${s.name}","${s.email}","${s.role}","${s.phone}","${s.status}","${s.lastActive}"`
                )
            ].join('\n');
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `staff-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Staff data exported successfully');
        }
        
        function showStaffActions(index) {
            const staff = NewcoData.get('staff') || [];
            const member = staff[index];
            
            if (!member) return;
            
            // Show action menu or modal
            showAlert(`Actions for ${member.name}: Edit, Delete, Send Email, Reset Password`, 'Staff Actions');
        }

        function addStaffMember() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Staff Member';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="staffName" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="staffEmail" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="staffRole">
                        <option value="Admin">Admin</option>
                        <option value="Manager">Manager</option>
                        <option value="Marketing Manager">Marketing Manager</option>
                        <option value="Caller">Caller</option>
                        <option value="Floor Staff">Floor Staff</option>
                        <option value="Cashier">Cashier</option>
                        <option value="Security">Security</option>
                    </select>
                </div>
                
                <!-- Welcome Email Section -->
                <div style="border-top: 1px solid var(--gray-lighter); margin-top: 1.5rem; padding-top: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--primary-dark); font-size: 1rem;">📧 Welcome Email Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="sendWelcomeEmail" checked onchange="toggleWelcomeEmailOptions(this)">
                            Send welcome email to new staff member
                        </label>
                    </div>
                    
                    <div id="welcomeEmailOptions">
                        <div class="form-group">
                            <label class="form-label">Welcome Email Template</label>
                            <select class="form-select" id="welcomeEmailTemplate" onchange="updateWelcomePreview()">
                                <option value="standard">Standard Welcome</option>
                                <option value="admin">Admin Welcome (includes admin guide)</option>
                                <option value="floor">Floor Staff Welcome (includes schedule info)</option>
                                <option value="custom">Custom Message</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="customWelcomeGroup" style="display: none;">
                            <label class="form-label">Custom Welcome Message</label>
                            <textarea class="form-input" id="customWelcomeText" rows="4" placeholder="Welcome to our team! We're excited to have you join us..."></textarea>
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                                Available placeholders: {name}, {role}, {email}, {organization}, {loginUrl}
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="includeCredentials" checked>
                                Include login credentials in email
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="requirePasswordReset" checked>
                                Require password reset on first login
                            </label>
                        </div>
                        
                        <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="font-size: 0.875rem; color: var(--gray-dark); margin: 0 0 0.5rem 0;"><strong>Preview:</strong></p>
                            <div id="welcomeEmailPreview" style="font-size: 0.875rem; color: var(--gray);">
                                Subject: Welcome to Santa Clara Bingo!<br>
                                <br>
                                Dear {name},<br>
                                <br>
                                Welcome to Santa Clara Bingo! You've been added as a {role}.<br>
                                <br>
                                Your login credentials will be sent in a separate email.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modalSaveBtn.onclick = () => {
                const staff = NewcoData.get('staff') || [];
                const newMember = {
                    id: Date.now().toString(),
                    name: document.getElementById('staffName').value,
                    email: document.getElementById('staffEmail').value,
                    role: document.getElementById('staffRole').value,
                    status: 'Active',
                    lastActive: null,
                    sendWelcomeEmail: document.getElementById('sendWelcomeEmail').checked,
                    welcomeEmailTemplate: document.getElementById('sendWelcomeEmail').checked ?
                        document.getElementById('welcomeEmailTemplate').value : null,
                    customWelcomeText: document.getElementById('welcomeEmailTemplate').value === 'custom' ?
                        document.getElementById('customWelcomeText').value : null,
                    includeCredentials: document.getElementById('includeCredentials').checked,
                    requirePasswordReset: document.getElementById('requirePasswordReset').checked
                };

                staff.push(newMember);
                NewcoData.set('staff', staff);
                
                // Simulate sending welcome email
                if (newMember.sendWelcomeEmail) {
                    setTimeout(() => {
                        showSuccess(`Welcome email sent to ${newMember.email}`);
                    }, 1000);
                }
                
                closeModal();
                loadStaff();
                showSuccess(`Staff member "${newMember.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }

        function removeStaff(index) {
            showConfirm(
                'Are you sure you want to remove this staff member?',
                () => {
                    const staff = NewcoData.get('staff') || [];
                    staff.splice(index, 1);
                    NewcoData.set('staff', staff);
                    loadStaff();
                    showSuccess('Staff member removed successfully');
                },
                'Remove Staff Member'
            );
        }

        // Package Management Functions
        function loadPackages() {
            const packages = NewcoData.get('packages') || [];
            const salesItems = NewcoData.get('salesItems') || [];
            const container = document.getElementById('packagesContainer');
            
            if (packages.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No packages created yet. Click "Add Package" to create your first package.</p>';
                return;
            }
            
            let html = '<div class="packages-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">';
            
            packages.forEach((pkg, index) => {
                const items = pkg.items || [];
                const itemsHtml = items.map(item => {
                    // Handle new schema: items are objects with {itemId, itemName, quantity}
                    if (typeof item === 'object' && item !== null) {
                        if (item.itemName) {
                            return `• ${item.itemName}${item.quantity > 1 ? ' x' + item.quantity : ''}`;
                        }
                        // Handle case where item is an object but missing itemName
                        if (item.itemId) {
                            const salesItem = salesItems.find(si => si.id === item.itemId);
                            return salesItem ? `• ${salesItem.name}${item.quantity > 1 ? ' x' + item.quantity : ''}` : `• Unknown item`;
                        }
                        // Object without expected properties
                        return `• [Invalid item]`;
                    }
                    // Legacy support: items are strings (item IDs or 'custom')
                    if (typeof item === 'string') {
                        if (item === 'custom') {
                            return pkg.customLineText ? `• ${pkg.customLineText}` : '• Custom selection';
                        }
                        const salesItem = salesItems.find(si => si.id === item);
                        return salesItem ? `• ${salesItem.name}` : `• ${item}`;
                    }
                    return `• [Unknown format]`;
                }).join('<br>');
                
                
                html += `
                    <div class="package-card" style="background: white; border: 2px solid var(--gray-light); border-radius: 12px; padding: 1.5rem; position: relative;">
                        ${pkg.bestValue ? '<span style="position: absolute; top: -10px; right: 10px; background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">Best Value!</span>' : ''}
                        <h3 style="margin: 0 0 0.5rem 0;">${pkg.name}</h3>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.5rem; font-weight: bold; color: var(--admin-primary);">$${pkg.price}</span>
                            ${pkg.canBuyWithLoyalty ? `<span style="color: var(--secondary);">or ${pkg.loyaltyPointsCost || 0} pts</span>` : ''}
                        </div>
                        ${pkg.givesBonus ? `<div style="font-size: 0.875rem; color: var(--warning); margin-bottom: 0.5rem;">🎁 Bonus: ${pkg.bonusType === 'fixed' ? `+${pkg.bonusFixed} pts` : `${pkg.bonusMultiplier}x points`}</div>` : ''}
                        <div style="font-size: 0.875rem; color: var(--gray-dark); margin-bottom: 1rem;">
                            ${itemsHtml || 'No items added'}
                        </div>
                        ${pkg.seatSelection ? '<div style="font-size: 0.875rem; color: var(--admin-primary);">✓ Seat Selection: On</div>' : '<div style="font-size: 0.875rem; color: var(--gray);">Seat Selection: Off</div>'}
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="editPackage(${index})" style="flex: 1;">Edit</button>
                            <button class="btn btn-danger" onclick="deletePackage(${index})" style="flex: 1;">Delete</button>
                            ${index > 0 ? `<button class="btn btn-secondary" onclick="movePackage(${index}, -1)">↑</button>` : ''}
                            ${index < packages.length - 1 ? `<button class="btn btn-secondary" onclick="movePackage(${index}, 1)">↓</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function addPackage() {
            const salesItems = NewcoData.get('salesItems') || [];
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Package';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Package Name</label>
                    <input type="text" class="form-input" id="packageName" placeholder="e.g., Premium Package">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-input" id="packagePrice" min="0" step="0.01" placeholder="25.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="packageCanBuyWithPoints" onchange="togglePackageLoyaltyPoints(this)"> Can buy with loyalty points
                        </label>
                    </div>
                </div>
                <div class="form-group" id="packageLoyaltyPointsCostGroup" style="display: none;">
                    <label class="form-label">Loyalty Points Cost</label>
                    <input type="number" class="form-input" id="packagePointsCost" min="0" placeholder="250">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="packageGivesBonus" onchange="togglePackageBonusPoints(this)"> Gives bonus loyalty points
                    </label>
                </div>
                <div class="form-grid" id="packageBonusPointsGroup" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Bonus Type</label>
                        <select class="form-select" id="packageBonusType" onchange="togglePackageBonusType(this)">
                            <option value="fixed">Fixed Amount</option>
                            <option value="multiplier">Multiplier</option>
                        </select>
                    </div>
                    <div class="form-group" id="packageFixedBonusGroup">
                        <label class="form-label">Bonus Points</label>
                        <input type="number" class="form-input" id="packageBonusFixed" min="0" placeholder="20">
                    </div>
                    <div class="form-group" id="packageMultiplierBonusGroup" style="display: none;">
                        <label class="form-label">Points Multiplier (e.g., 2 for double)</label>
                        <input type="number" class="form-input" id="packageBonusMultiplier" min="1" step="0.5" placeholder="2">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="packageBestValue"> Mark as Best Value
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="packageSeatSelection"> Include Seat Selection
                    </label>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Display Order #</label>
                        <input type="number" class="form-input" id="packageDisplayOrder" min="1" placeholder="1" value="${(NewcoData.get('packages') || []).length + 1}">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Order shown on website</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Limit Per Customer</label>
                        <input type="number" class="form-input" id="packageLimitPerCustomer" min="0" placeholder="0">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">0 = unlimited</p>
                    </div>
                </div>
                <!-- Availability Settings -->
                <div style="border-top: 1px solid var(--gray-light); margin-top: 1.5rem; padding-top: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--primary-dark);">📅 Availability Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Available Days</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <label><input type="checkbox" class="day-checkbox" value="Monday"> Monday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Tuesday"> Tuesday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Wednesday"> Wednesday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Thursday"> Thursday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Friday"> Friday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Saturday"> Saturday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Sunday"> Sunday</label>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Check days to LIMIT availability. Leave all unchecked for everyday availability.</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Specific Date Only (Optional)</label>
                        <input type="date" class="form-input" id="packageSpecificDate">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Use for special events or one-time offerings</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Package Items</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-light); border-radius: 8px; padding: 0.5rem;">
                        <label style="display: block; padding: 0.5rem; border-bottom: 1px solid var(--gray-lighter);">
                            <input type="checkbox" id="packageCustomLine" value="custom" onchange="toggleCustomLineInput(this)"> Custom Selection Line
                        </label>
                        <div id="customLineInputGroup" style="display: none; padding: 0.5rem; background: var(--gray-lighter); margin-bottom: 0.5rem;">
                            <input type="text" class="form-input" id="packageCustomLineText" placeholder="Enter custom line text (e.g., '2 Special Game Cards')" style="width: 100%;">
                        </div>
                        ${salesItems.map(item => `
                            <label style="display: block; padding: 0.5rem;">
                                <input type="checkbox" class="package-item-checkbox" value="${item.id}"> ${item.name} - $${item.price}
                            </label>
                        `).join('')}
                        ${salesItems.length === 0 ? '<p style="color: var(--gray); margin: 0.5rem;">No sales items available. Create items first.</p>' : ''}
                    </div>
                </div>
            `;
            
            // Add helper functions for toggling
            window.togglePackageLoyaltyPoints = function(checkbox) {
                document.getElementById('packageLoyaltyPointsCostGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.togglePackageBonusPoints = function(checkbox) {
                document.getElementById('packageBonusPointsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.togglePackageBonusType = function(select) {
                document.getElementById('packageFixedBonusGroup').style.display = select.value === 'fixed' ? 'block' : 'none';
                document.getElementById('packageMultiplierBonusGroup').style.display = select.value === 'multiplier' ? 'block' : 'none';
            };
            
            window.toggleCustomLineInput = function(checkbox) {
                document.getElementById('customLineInputGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            
            modalSaveBtn.onclick = () => {
                const salesItems = NewcoData.get('salesItems') || [];
                const selectedItems = [];
                modalBody.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    if (cb.id !== 'packageBestValue' && cb.id !== 'packageSeatSelection' && !cb.classList.contains('day-checkbox')) {
                        // Create proper object structure with itemId, itemName, quantity
                        const salesItem = salesItems.find(si => si.id === cb.value);
                        if (salesItem) {
                            selectedItems.push({
                                itemId: cb.value,
                                itemName: salesItem.name,
                                quantity: 1
                            });
                        } else if (cb.value === 'custom') {
                            selectedItems.push({
                                itemId: 'custom',
                                itemName: document.getElementById('packageCustomLineText')?.value || 'Custom selection',
                                quantity: 1
                            });
                        }
                    }
                });

                    const packages = NewcoData.get('packages') || [];
                    const packageId = Date.now().toString();
                    
                    
                    // Handle custom line text
                    const hasCustomLine = document.getElementById('packageCustomLine').checked;
                    const customLineText = hasCustomLine ? document.getElementById('packageCustomLineText').value : null;
                    
                    // Get selected days
                    const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                        .map(cb => cb.value.toLowerCase());

                    const newPackage = {
                        id: packageId,
                        name: document.getElementById('packageName').value,
                        price: parseFloat(document.getElementById('packagePrice').value) || 0,
                        canBuyWithLoyalty: document.getElementById('packageCanBuyWithPoints').checked,
                        loyaltyPointsCost: document.getElementById('packageCanBuyWithPoints').checked ?
                            parseInt(document.getElementById('packagePointsCost').value) || 0 : null,
                        givesBonus: document.getElementById('packageGivesBonus').checked,
                        bonusType: document.getElementById('packageGivesBonus').checked ?
                            document.getElementById('packageBonusType').value : null,
                        bonusFixed: document.getElementById('packageGivesBonus').checked && document.getElementById('packageBonusType').value === 'fixed' ?
                            parseInt(document.getElementById('packageBonusFixed').value) || 0 : null,
                        bonusMultiplier: document.getElementById('packageGivesBonus').checked && document.getElementById('packageBonusType').value === 'multiplier' ?
                            parseFloat(document.getElementById('packageBonusMultiplier').value) || 1 : null,
                        bestValue: document.getElementById('packageBestValue').checked,
                        seatSelection: document.getElementById('packageSeatSelection').checked,
                        displayOrder: parseInt(document.getElementById('packageDisplayOrder').value) || packages.length + 1,
                        limitPerCustomer: parseInt(document.getElementById('packageLimitPerCustomer').value) || 0,
                        items: selectedItems,
                        customLineText: customLineText,
                        validDays: selectedDays.length > 0 ? selectedDays : null,
                        dateEligibility: document.getElementById('packageSpecificDate').value || null,
                        order: packages.length
                    };
                    
                    // Strip any art fields to prevent storage issues
                    delete newPackage.bannerArt;
                    delete newPackage.backgroundArt;
                    delete newPackage.art;
                    delete newPackage.bannerArtId;
                    delete newPackage.backgroundArtId;
                    
                    packages.push(newPackage);
                    
                    try {
                        NewcoData.set('packages', packages);
                    } catch (e) {
                        console.warn('Could not save to localStorage, keeping in memory:', e);
                        window.tempPackages = packages;
                    }
                    
                    closeModal();
                    loadPackages();
                    showSuccess(`Package "${newPackage.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }
        
        function editPackage(index) {
            const packages = NewcoData.get('packages') || [];
            const pkg = packages[index];
            if (!pkg) return;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            // Copy the form from addPackage
            modalTitle.textContent = 'Edit Package';
            
            // Get the form HTML from addPackage function
            addPackage();
            
            // Change title to Edit
            setTimeout(() => {
                document.getElementById('modalTitle').textContent = 'Edit Package';
            }, 10);
            
            // Pre-fill values after a short delay
            setTimeout(() => {
                document.getElementById('packageName').value = pkg.name || '';
                document.getElementById('packagePrice').value = pkg.price || '';
                
                // Handle loyalty points option
                const canBuyWithPoints = document.getElementById('packageCanBuyWithPoints');
                const pointsCost = document.getElementById('packagePointsCost');
                if (canBuyWithPoints && pkg.canBuyWithLoyalty) {
                    canBuyWithPoints.checked = true;
                    document.getElementById('packageLoyaltyPointsCostGroup').style.display = 'block';
                    if (pointsCost) {
                        pointsCost.value = pkg.loyaltyPointsCost || '';
                    }
                }
                
                // Check the included items
                if (pkg.items && pkg.items.length > 0) {
                    const salesItems = NewcoData.get('salesItems') || [];
                    const checkboxes = document.querySelectorAll('.package-item-checkbox');

                    checkboxes.forEach(checkbox => {
                        // Get the sales item for this checkbox
                        const salesItem = salesItems.find(si => si.id === checkbox.value);
                        if (!salesItem) return;

                        // Handle new schema: items are objects with {itemId, itemName, quantity}
                        const hasItem = pkg.items.some(item => {
                            if (typeof item === 'object' && item.itemName) {
                                // Match by name (handles quantity variations like "Strip Pack x2")
                                const baseName = item.itemName.replace(/ x\d+$/, ''); // Remove " x2" suffix
                                return baseName === salesItem.name || item.itemName === salesItem.name;
                            }
                            // Legacy: items are strings (IDs)
                            return item === checkbox.value;
                        });

                        if (hasItem) {
                            checkbox.checked = true;
                        }
                    });

                    // Handle custom line
                    const hasCustom = pkg.items.some(item =>
                        (typeof item === 'object' && item.itemId === 'custom') || item === 'custom'
                    );
                    if (hasCustom && pkg.customLineText) {
                        document.getElementById('packageCustomLine').checked = true;
                        document.getElementById('customLineInputGroup').style.display = 'block';
                        document.getElementById('packageCustomLineText').value = pkg.customLineText;
                    }
                }
                
                // Handle Best Value
                if (pkg.bestValue) {
                    document.getElementById('packageBestValue').checked = true;
                }
                
                // Handle Seat Selection
                if (pkg.seatSelection) {
                    document.getElementById('packageSeatSelection').checked = true;
                }
                
                // Handle bonus points
                if (pkg.givesBonus) {
                    document.getElementById('packageGivesBonus').checked = true;
                    document.getElementById('packageBonusPointsGroup').style.display = 'block';
                    document.getElementById('packageBonusType').value = pkg.bonusType || 'fixed';
                    if (pkg.bonusType === 'multiplier') {
                        document.getElementById('packageMultiplierBonusGroup').style.display = 'block';
                        document.getElementById('packageFixedBonusGroup').style.display = 'none';
                        document.getElementById('packageBonusMultiplier').value = pkg.bonusMultiplier || 2;
                    } else {
                        document.getElementById('packageBonusFixed').value = pkg.bonusFixed || 0;
                    }
                }
                
                // Handle other fields
                document.getElementById('packageLimitPerCustomer').value = pkg.limitPerCustomer || 0;
                document.getElementById('packageDisplayOrder').value = pkg.displayOrder || index + 1;

                // Handle day eligibility
                if (pkg.dayEligibility && pkg.dayEligibility.length > 0) {
                    const dayCheckboxes = document.querySelectorAll('.day-checkbox');
                    dayCheckboxes.forEach(checkbox => {
                        if (pkg.dayEligibility.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                }

                // Handle specific date eligibility
                if (pkg.dateEligibility) {
                    const specificDateInput = document.getElementById('packageSpecificDate');
                    if (specificDateInput) {
                        specificDateInput.value = pkg.dateEligibility;
                    }
                }

                }, 100);
                
                // Override save function to update instead of create - with delay to ensure it works
                setTimeout(() => {
                    const modalSaveBtn = document.getElementById('modalSaveBtn');
                    modalSaveBtn.onclick = () => {
                    const bannerFileInput = document.getElementById('packageBannerArt');
                    const backgroundFileInput = document.getElementById('packageBackgroundArt');
                    const bannerFile = bannerFileInput ? bannerFileInput.files[0] : null;
                    const backgroundFile = backgroundFileInput ? backgroundFileInput.files[0] : null;
                    let bannerArtData = null;
                    let backgroundArtData = null;
                    let pendingUploads = 0;
                    
                    function checkAndSave() {
                        if (pendingUploads === 0) {
                            updatePackage();
                        }
                    }
                    
                    if (bannerFile) {
                        pendingUploads++;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            bannerArtData = e.target.result;
                            pendingUploads--;
                            checkAndSave();
                        };
                        reader.readAsDataURL(bannerFile);
                    }
                    
                    if (backgroundFile) {
                        pendingUploads++;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            backgroundArtData = e.target.result;
                            pendingUploads--;
                            checkAndSave();
                        };
                        reader.readAsDataURL(backgroundFile);
                    }
                    
                    if (pendingUploads === 0) {
                        checkAndSave();
                    }
                    
                    function updatePackage() {
                        // Rebuild items based on checked boxes, preserving quantities from original
                        const salesItems = NewcoData.get('salesItems') || [];
                        const updatedItems = [];

                        // Check if package uses new schema
                        const usesNewSchema = pkg.items && pkg.items.length > 0 &&
                            typeof pkg.items[0] === 'object' && pkg.items[0].itemId;

                        if (usesNewSchema) {
                            // New schema: rebuild items array matching checked boxes with original quantities
                            const checkboxes = document.querySelectorAll('.package-item-checkbox:checked');
                            checkboxes.forEach(cb => {
                                const salesItem = salesItems.find(si => si.id === cb.value);
                                if (salesItem) {
                                    // Find original item to preserve quantity
                                    const originalItem = pkg.items.find(item => {
                                        if (typeof item === 'object' && item.itemName) {
                                            const baseName = item.itemName.replace(/ x\d+$/, '');
                                            return baseName === salesItem.name || item.itemName === salesItem.name;
                                        }
                                        return false;
                                    });

                                    // Use original quantity if found, otherwise default to 1
                                    const quantity = originalItem ? originalItem.quantity : 1;

                                    updatedItems.push({
                                        itemId: cb.value, // Use the actual salesItem ID from checkbox
                                        itemName: salesItem.name,
                                        quantity: quantity
                                    });
                                }
                            });

                            // Check for custom line
                            if (document.getElementById('packageCustomLine').checked) {
                                updatedItems.push({
                                    itemId: 'custom',
                                    itemName: document.getElementById('packageCustomLineText').value || 'Custom',
                                    quantity: 1
                                });
                            }
                        } else {
                            // Legacy mode: collect item IDs as strings
                            const checkboxes = document.querySelectorAll('.package-item-checkbox:checked');
                            checkboxes.forEach(cb => updatedItems.push(cb.value));

                            // Check for custom line
                            if (document.getElementById('packageCustomLine').checked) {
                                updatedItems.push('custom');
                            }
                        }

                        // Get selected days
                        const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                            .map(cb => cb.value.toLowerCase());

                        // Update the package
                        packages[index] = {
                            id: pkg.id,
                            name: document.getElementById('packageName').value,
                            price: parseFloat(document.getElementById('packagePrice').value) || 0,
                            canBuyWithLoyalty: document.getElementById('packageCanBuyWithPoints').checked,
                            loyaltyPointsCost: document.getElementById('packageCanBuyWithPoints').checked ?
                                parseInt(document.getElementById('packagePointsCost').value) || 0 : null,
                            givesBonus: document.getElementById('packageGivesBonus').checked,
                            bonusType: document.getElementById('packageGivesBonus').checked ?
                                document.getElementById('packageBonusType').value : null,
                            bonusFixed: document.getElementById('packageBonusType')?.value === 'fixed' ?
                                parseInt(document.getElementById('packageBonusFixed').value) || 0 : null,
                            bonusMultiplier: document.getElementById('packageBonusType')?.value === 'multiplier' ?
                                parseFloat(document.getElementById('packageBonusMultiplier').value) || 1 : null,
                            bestValue: document.getElementById('packageBestValue').checked,
                            seatSelection: document.getElementById('packageSeatSelection').checked,
                            items: updatedItems,
                            customLineText: document.getElementById('packageCustomLine').checked ?
                                document.getElementById('packageCustomLineText').value : null,
                            limitPerCustomer: parseInt(document.getElementById('packageLimitPerCustomer').value) || 0,
                            displayOrder: parseInt(document.getElementById('packageDisplayOrder').value) || index + 1,
                            validDays: selectedDays.length > 0 ? selectedDays : null,
                            dateEligibility: document.getElementById('packageSpecificDate').value || null,
                            hasDateRestrictions: pkg.hasDateRestrictions || false,
                            availableDays: pkg.availableDays || [],
                            validFrom: pkg.validFrom || null,
                            validUntil: pkg.validUntil || null,
                            specialEventsOnly: pkg.specialEventsOnly || false,
                            category: pkg.category,
                            description: pkg.description
                        };
                        
                        NewcoData.set('packages', packages);
                        
                        // Clear selected art
                        window.selectedPackageBannerArt = null;
                        window.selectedPackageBackgroundArt = null;
                        
                        console.log('Closing modal after package update...');
                        closeModal();
                        loadPackages();
                        showSuccess(`Package "${packages[index].name}" updated successfully`);
                    }
                    };
                }, 200); // Longer delay to ensure the override takes effect
        }
        
        function deletePackage(index) {
            showConfirm(
                'Are you sure you want to delete this package?',
                () => {
                    const packages = NewcoData.get('packages') || [];
                    console.log('Before delete:', packages.length, 'packages');
                    const deleted = packages.splice(index, 1)[0];
                    console.log('After delete:', packages.length, 'packages');
                    NewcoData.set('packages', packages);
                    console.log('Saved to localStorage. New count:', NewcoData.get('packages').length);
                    loadPackages();
                    showSuccess(`Package "${deleted.name}" deleted successfully`);
                },
                'Delete Package'
            );
        }
        
        function clearAllPackages() {
            showConfirm(
                'This will delete ALL packages. Are you sure?',
                () => {
                    NewcoData.set('packages', []);
                    localStorage.removeItem('newco_packages');
                    console.log('All packages cleared');
                    loadPackages();
                    showSuccess('All packages have been deleted');
                },
                'Clear All Packages'
            );
        }
        
        function movePackage(index, direction) {
            const packages = NewcoData.get('packages') || [];
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < packages.length) {
                [packages[index], packages[newIndex]] = [packages[newIndex], packages[index]];
                packages.forEach((pkg, i) => pkg.order = i);
                NewcoData.set('packages', packages);
                loadPackages();
            }
        }
        
        // Package art selection functions
        function selectPackageBannerArt() {
            showArtSelector((artData) => { 
                window.selectedPackageBannerArt = artData; 
                const elem = document.getElementById('packageBannerArtSelected'); 
                if (elem) {
                    if (artData && artData.startsWith('data:')) {
                        elem.innerHTML = `<img src='${artData}' style='max-width: 200px; max-height: 100px; border-radius: 8px; margin-top: 0.5rem;'>`;
                    } else {
                        elem.textContent = 'Banner art selected';
                    }
                }
            });
        }

        function selectPackageBackgroundArt() {
            showArtSelector((artData) => { 
                window.selectedPackageBackgroundArt = artData; 
                const elem = document.getElementById('packageBackgroundArtSelected'); 
                if (elem) {
                    if (artData && artData.startsWith('data:')) {
                        elem.innerHTML = `<img src='${artData}' style='max-width: 200px; max-height: 120px; border-radius: 8px; margin-top: 0.5rem;'>`;
                    } else {
                        elem.textContent = 'Background art selected';
                    }
                }
            });
        }
        
        // Marketing Management Functions
        function loadMarketing() {
            loadFlashyAlerts();
            loadBirthdayOffer();
            loadSocialMediaSettings();
            loadWelcomePopupSettings();
            loadActivePromotions();
        }

        // Social Media Settings Functions
        function loadSocialMediaSettings() {
            const settings = NewcoData.get('socialMediaSettings') || {
                enabled: false,
                buttonText: '📱 GET UPDATES!',
                modalTitle: 'GET UPDATES!',
                message: '',
                smsKeyword: '',
                smsNumber: '',
                twitterLink: '',
                facebookLink: '',
                instagramLink: ''
            };

            document.getElementById('enableSocialMediaButton').checked = settings.enabled;
            document.getElementById('socialMediaButtonText').value = settings.buttonText || '';
            document.getElementById('socialMediaModalTitle').value = settings.modalTitle || '';
            document.getElementById('socialMediaMessage').value = settings.message || '';
            document.getElementById('socialMediaSMSKeyword').value = settings.smsKeyword || '';
            document.getElementById('socialMediaSMSNumber').value = settings.smsNumber || '';
            document.getElementById('socialMediaTwitterLink').value = settings.twitterLink || '';
            document.getElementById('socialMediaFacebookLink').value = settings.facebookLink || '';
            document.getElementById('socialMediaInstagramLink').value = settings.instagramLink || '';

            toggleSocialMediaSettings();
        }

        function toggleSocialMediaSettings() {
            const enabled = document.getElementById('enableSocialMediaButton').checked;
            document.getElementById('socialMediaSettings').style.display = enabled ? 'block' : 'none';
        }

        function saveSocialMediaSettings() {
            const settings = {
                enabled: document.getElementById('enableSocialMediaButton').checked,
                buttonText: document.getElementById('socialMediaButtonText').value,
                modalTitle: document.getElementById('socialMediaModalTitle').value,
                message: document.getElementById('socialMediaMessage').value,
                smsKeyword: document.getElementById('socialMediaSMSKeyword').value,
                smsNumber: document.getElementById('socialMediaSMSNumber').value,
                twitterLink: document.getElementById('socialMediaTwitterLink').value,
                facebookLink: document.getElementById('socialMediaFacebookLink').value,
                instagramLink: document.getElementById('socialMediaInstagramLink').value
            };

            NewcoData.set('socialMediaSettings', settings);
            showSuccess('Social media settings saved successfully!');
        }

        function previewSocialMediaModal() {
            const settings = {
                modalTitle: document.getElementById('socialMediaModalTitle').value || 'GET UPDATES!',
                message: document.getElementById('socialMediaMessage').value,
                smsKeyword: document.getElementById('socialMediaSMSKeyword').value,
                smsNumber: document.getElementById('socialMediaSMSNumber').value,
                twitterLink: document.getElementById('socialMediaTwitterLink').value,
                facebookLink: document.getElementById('socialMediaFacebookLink').value,
                instagramLink: document.getElementById('socialMediaInstagramLink').value
            };

            // Create preview modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; position: relative;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; right: 1rem; top: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>

                    <h2 style="margin: 0 0 1.5rem 0; color: #333;">${settings.modalTitle}</h2>

                    <div style="white-space: pre-line; line-height: 1.6; color: #666; margin-bottom: 1.5rem;">
                        ${settings.message || 'No message configured yet'}
                    </div>

                    ${settings.smsKeyword && settings.smsNumber ? `
                        <div style="background: #f0f0f0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                            <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Text this keyword:</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">${settings.smsKeyword}</div>
                            <div style="font-size: 0.875rem; color: #666;">to</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${settings.smsNumber}</div>
                        </div>
                    ` : ''}

                    ${(settings.twitterLink || settings.facebookLink || settings.instagramLink) ? `
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            ${settings.twitterLink ? `<a href="${settings.twitterLink}" target="_blank" style="background: #1DA1F2; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">🐦 Twitter/X</a>` : ''}
                            ${settings.facebookLink ? `<a href="${settings.facebookLink}" target="_blank" style="background: #4267B2; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">📘 Facebook</a>` : ''}
                            ${settings.instagramLink ? `<a href="${settings.instagramLink}" target="_blank" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">📷 Instagram</a>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Welcome Popup Functions
        function loadWelcomePopupSettings() {
            const settings = NewcoData.get('welcomePopupSettings') || {
                enabled: false,
                image: null,
                message: '',
                textPosition: 'bottom',
                frequency: 'once-per-session'
            };

            document.getElementById('enableWelcomePopup').checked = settings.enabled;
            document.getElementById('welcomePopupMessage').value = settings.message || '';
            document.getElementById('welcomePopupTextPosition').value = settings.textPosition || 'bottom';
            document.getElementById('welcomePopupFrequency').value = settings.frequency || 'once-per-session';

            if (settings.image) {
                document.getElementById('welcomePopupImagePreview').innerHTML = `
                    <img src="${settings.image}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                `;
            }

            toggleWelcomePopupSettings();
        }

        function toggleWelcomePopupSettings() {
            const enabled = document.getElementById('enableWelcomePopup').checked;
            document.getElementById('welcomePopupSettings').style.display = enabled ? 'block' : 'none';
        }

        function handleWelcomePopupImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (500KB max)
            if (file.size > 500000) {
                showModal({
                    title: '⚠️ File Too Large',
                    message: 'Image must be under 500KB. Please compress or resize your image.',
                    type: 'warning'
                });
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                document.getElementById('welcomePopupImagePreview').innerHTML = `
                    <img src="${imageData}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                `;
                // Store temporarily until saved
                window.tempWelcomePopupImage = imageData;
            };
            reader.readAsDataURL(file);
        }

        function saveWelcomePopupSettings() {
            const settings = {
                enabled: document.getElementById('enableWelcomePopup').checked,
                image: window.tempWelcomePopupImage || NewcoData.get('welcomePopupSettings')?.image || null,
                message: document.getElementById('welcomePopupMessage').value,
                textPosition: document.getElementById('welcomePopupTextPosition').value,
                frequency: document.getElementById('welcomePopupFrequency').value
            };

            NewcoData.set('welcomePopupSettings', settings);
            window.tempWelcomePopupImage = null;
            showSuccess('Welcome popup settings saved successfully!');
        }

        function previewWelcomePopup() {
            const settings = {
                image: window.tempWelcomePopupImage || NewcoData.get('welcomePopupSettings')?.image,
                message: document.getElementById('welcomePopupMessage').value,
                textPosition: document.getElementById('welcomePopupTextPosition').value
            };

            if (!settings.image) {
                showModal({
                    title: '⚠️ No Image',
                    message: 'Please upload an image first to preview the popup.',
                    type: 'warning'
                });
                return;
            }

            showWelcomePopupModal(settings);
        }

        function showWelcomePopupModal(settings) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            let imageHTML = '';
            if (settings.image) {
                imageHTML = `<img src="${settings.image}" style="width: 100%; border-radius: 12px 12px 0 0; display: block;">`;
            }

            let textHTML = '';
            if (settings.message) {
                if (settings.textPosition === 'diagonal') {
                    textHTML = `
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
                            font-size: 2rem; font-weight: bold; color: white; text-shadow: 2px 2px 8px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5);
                            text-align: center; white-space: nowrap; padding: 1rem;">
                            ${settings.message}
                        </div>
                    `;
                } else if (settings.textPosition === 'bottom') {
                    textHTML = `
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
                            padding: 2rem 1rem 1rem; color: white; font-size: 1.25rem; font-weight: 600; text-align: center;">
                            ${settings.message}
                        </div>
                    `;
                }
            }

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 800px; width: 90%; position: relative; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        width: 40px;
                        height: 40px;
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        font-size: 1.5rem;
                        cursor: pointer;
                        z-index: 10;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        transition: all 0.2s;
                    " onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">&times;</button>
                    <div style="position: relative;">
                        ${imageHTML}
                        ${textHTML}
                    </div>
                    ${settings.textPosition === 'none' && settings.message ? `
                        <div style="padding: 1.5rem; text-align: center; font-size: 1.1rem; color: #333;">
                            ${settings.message}
                        </div>
                    ` : ''}
                    <div style="padding: 1rem; text-align: center; font-size: 0.875rem; color: #999;">
                        Click anywhere or wait 3 seconds to close
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Auto-close after 3 seconds
            const autoCloseTimer = setTimeout(() => {
                modal.remove();
            }, 3000);

            // Close on click
            modal.addEventListener('click', () => {
                clearTimeout(autoCloseTimer);
                modal.remove();
            });
        }

        function loadFlashyAlerts() {
            const settings = NewcoData.get('marketingAlerts') || {
                enabled: false,
                timeOnScreen: 3000,
                delayBetween: 6000,
                messageSource: 'default',
                customMessages: []
            };
            
            document.getElementById('enableFlashyAlerts').checked = settings.enabled;
            document.getElementById('alertTimeOnScreen').value = settings.timeOnScreen / 1000;
            document.getElementById('alertDelayBetween').value = settings.delayBetween / 1000;
            
            const sourceRadio = document.querySelector(`input[name="alertMessageSource"][value="${settings.messageSource}"]`);
            if (sourceRadio) sourceRadio.checked = true;
            
            if (settings.customMessages && settings.customMessages.length > 0) {
                document.getElementById('customAlertMessages').value = settings.customMessages.join('\n');
            }

            toggleFlashyAlerts(false);
            toggleMessageSource();
        }
        
        function toggleFlashyAlerts(showToast = true) {
            const enabled = document.getElementById('enableFlashyAlerts').checked;
            document.getElementById('flashyAlertsSettings').style.display = enabled ? 'block' : 'none';

            // Auto-save the enabled state
            const currentSettings = NewcoData.get('marketingAlerts') || {
                enabled: false,
                timeOnScreen: 3000,
                delayBetween: 6000,
                messageSource: 'default',
                customMessages: []
            };

            currentSettings.enabled = enabled;
            NewcoData.set('marketingAlerts', currentSettings);

            if (showToast) {
                if (enabled) {
                    showSuccess('Flashy alerts enabled');
                } else {
                    showSuccess('Flashy alerts disabled');
                }
            }
        }
        
        function toggleMessageSource() {
            const source = document.querySelector('input[name="alertMessageSource"]:checked').value;
            document.getElementById('customMessagesSection').style.display = source === 'custom' ? 'block' : 'none';
        }
        
        function saveFlashyAlertsSettings() {
            const settings = {
                enabled: document.getElementById('enableFlashyAlerts').checked,
                timeOnScreen: parseInt(document.getElementById('alertTimeOnScreen').value) * 1000,
                delayBetween: parseInt(document.getElementById('alertDelayBetween').value) * 1000,
                messageSource: document.querySelector('input[name="alertMessageSource"]:checked').value,
                customMessages: []
            };
            
            if (settings.messageSource === 'custom') {
                const customText = document.getElementById('customAlertMessages').value;
                settings.customMessages = customText.split('\n').filter(line => line.trim());
            }
            
            NewcoData.set('marketingAlerts', settings);
            showSuccess('Flashy alerts settings saved successfully!');
        }
        
        function previewFlashyAlert() {
            const messages = [
                "Feel that excitement? Your winning moment is near!",
                "Tonight's energy is electric - something special awaits!",
                "Your lucky stars are aligning right now!"
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            // Create preview alert
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0.9);
                background: #1a1a2e;
                color: #eee;
                padding: 1rem 1.75rem;
                border-radius: 8px;
                border: 2px solid #f39c12;
                box-shadow: 0 0 30px rgba(243, 156, 18, 0.5);
                z-index: 10000;
                opacity: 0;
                transition: all 0.4s ease;
                max-width: 500px;
                text-align: center;
                font-size: 1.1rem;
                font-weight: 500;
                line-height: 1.5;
            `;
            alert.textContent = randomMessage;
            
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => {
                alert.style.opacity = '1';
                alert.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translate(-50%, -50%) scale(0.9)';
                setTimeout(() => alert.remove(), 400);
            }, 3000);
        }
        
        function loadBirthdayOffer() {
            const birthdayOffer = NewcoData.get('birthdayOffer') || {
                enabled: false,
                offerType: 'percentage',
                percentageOff: 0,
                dollarOff: 0,
                freeItem: '',
                validDaysBefore: 7,
                validDaysAfter: 7,
                requiresRegistration: true,
                minimumPurchase: 0
            };
            
            const container = document.getElementById('birthdayOfferContainer');
            container.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="birthdayEnabled" ${birthdayOffer.enabled ? 'checked' : ''} 
                                   onchange="toggleBirthdayOffer(this)"> Enable Birthday Offers
                        </label>
                    </div>
                </div>
                
                <div id="birthdaySettings" style="${birthdayOffer.enabled ? '' : 'display: none;'}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Offer Type</label>
                            <select class="form-select" id="birthdayOfferType" onchange="updateBirthdayOfferType(this)">
                                <option value="percentage" ${birthdayOffer.offerType === 'percentage' ? 'selected' : ''}>Percentage Discount</option>
                                <option value="dollar" ${birthdayOffer.offerType === 'dollar' ? 'selected' : ''}>Dollar Amount Off</option>
                                <option value="freeItem" ${birthdayOffer.offerType === 'freeItem' ? 'selected' : ''}>Free Item/Package</option>
                                <option value="bonusPoints" ${birthdayOffer.offerType === 'bonusPoints' ? 'selected' : ''}>Bonus Loyalty Points</option>
                                <option value="bogo" ${birthdayOffer.offerType === 'bogo' ? 'selected' : ''}>Buy One Get One</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="percentageGroup" style="${birthdayOffer.offerType === 'percentage' ? '' : 'display: none;'}">
                            <label class="form-label">Percentage Off (%)</label>
                            <input type="number" class="form-input" id="birthdayPercentage" 
                                   value="${birthdayOffer.percentageOff}" min="0" max="100">
                        </div>
                        
                        <div class="form-group" id="dollarGroup" style="${birthdayOffer.offerType === 'dollar' ? '' : 'display: none;'}">
                            <label class="form-label">Dollar Amount Off ($)</label>
                            <input type="number" class="form-input" id="birthdayDollar" 
                                   value="${birthdayOffer.dollarOff}" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group" id="freeItemGroup" style="${birthdayOffer.offerType === 'freeItem' ? '' : 'display: none;'}">
                            <label class="form-label">Free Item/Package</label>
                            <select class="form-select" id="birthdayFreeItem">
                                <option value="">Select item...</option>
                                ${getBirthdayItemOptions(birthdayOffer.freeItem)}
                            </select>
                        </div>
                        
                        <div class="form-group" id="bonusPointsGroup" style="${birthdayOffer.offerType === 'bonusPoints' ? '' : 'display: none;'}">
                            <label class="form-label">Bonus Points Amount</label>
                            <input type="number" class="form-input" id="birthdayBonusPoints" 
                                   value="${birthdayOffer.bonusPoints || 100}" min="0">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Valid Days Before Birthday</label>
                            <input type="number" class="form-input" id="birthdayDaysBefore" 
                                   value="${birthdayOffer.validDaysBefore}" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Valid Days After Birthday</label>
                            <input type="number" class="form-input" id="birthdayDaysAfter" 
                                   value="${birthdayOffer.validDaysAfter}" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Minimum Purchase Required ($)</label>
                            <input type="number" class="form-input" id="birthdayMinPurchase" 
                                   value="${birthdayOffer.minimumPurchase}" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="birthdayRequiresReg" ${birthdayOffer.requiresRegistration ? 'checked' : ''}> 
                                Requires Loyalty Registration
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveBirthdayOffer()">Save Birthday Offer Settings</button>
                </div>
            `;
        }
        
        function getBirthdayItemOptions(selectedItem) {
            const packages = NewcoData.get('packages') || [];
            const items = NewcoData.get('salesItems') || [];
            
            let options = '<optgroup label="Packages">';
            packages.forEach(pkg => {
                options += `<option value="package_${pkg.id}" ${selectedItem === `package_${pkg.id}` ? 'selected' : ''}>
                    ${pkg.name} ($${pkg.price})
                </option>`;
            });
            options += '</optgroup><optgroup label="Basic Offerings">';
            items.forEach(item => {
                options += `<option value="item_${item.id}" ${selectedItem === `item_${item.id}` ? 'selected' : ''}>
                    ${item.name} ($${item.price})
                </option>`;
            });
            options += '</optgroup>';
            
            return options;
        }
        
        function toggleBirthdayOffer(checkbox) {
            document.getElementById('birthdaySettings').style.display = checkbox.checked ? 'block' : 'none';
        }
        
        function updateBirthdayOfferType(select) {
            document.getElementById('percentageGroup').style.display = select.value === 'percentage' ? 'block' : 'none';
            document.getElementById('dollarGroup').style.display = select.value === 'dollar' ? 'block' : 'none';
            document.getElementById('freeItemGroup').style.display = select.value === 'freeItem' ? 'block' : 'none';
            document.getElementById('bonusPointsGroup').style.display = select.value === 'bonusPoints' ? 'block' : 'none';
        }
        
        function saveBirthdayOffer() {
            const offerType = document.getElementById('birthdayOfferType').value;
            
            // Get the selected radio button value for birthday requirement
            let birthdayRequirement = 'automatic';
            const requirementRadios = document.getElementsByName('birthdayRequirement');
            for (const radio of requirementRadios) {
                if (radio.checked) {
                    birthdayRequirement = radio.value;
                    break;
                }
            }
            
            const birthdayOffer = {
                enabled: document.getElementById('birthdayEnabled').checked,
                offerType: offerType,
                percentageOff: offerType === 'percentage' ? parseInt(document.getElementById('birthdayPercentage').value) || 0 : 0,
                dollarOff: offerType === 'dollar' ? parseFloat(document.getElementById('birthdayDollar').value) || 0 : 0,
                freeItem: offerType === 'freeItem' ? document.getElementById('birthdayFreeItem').value : '',
                bonusPoints: offerType === 'bonusPoints' ? parseInt(document.getElementById('birthdayBonusPoints').value) || 0 : 0,
                validDaysBefore: parseInt(document.getElementById('birthdayDaysBefore').value) || 0,
                validDaysAfter: parseInt(document.getElementById('birthdayDaysAfter').value) || 0,
                minimumPurchase: parseFloat(document.getElementById('birthdayMinPurchase').value) || 0,
                requiresRegistration: document.getElementById('birthdayRequiresReg').checked,
                requirement: birthdayRequirement,
                triggerEmail: document.getElementById('birthdayTriggerEmail').checked,
                emailDaysBefore: document.getElementById('birthdayTriggerEmail').checked ? 
                    parseInt(document.getElementById('emailDaysBefore')?.value) || 7 : 0
            };
            
            NewcoData.set('birthdayOffer', birthdayOffer);
            showSuccess('Birthday offer settings saved successfully');
        }
        
        function loadActivePromotions() {
            const promotions = NewcoData.get('promotions') || [];
            const container = document.getElementById('promotionsContainer');
            
            if (promotions.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No active promotions. Click "Add Promotion" to create your first promotion.</p>';
                return;
            }
            
            let html = '<div class="promotions-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));">';
            
            promotions.forEach((promo, index) => {
                const isActive = isPromotionActive(promo);
                html += `
                    <div class="promo-card" style="background: white; border: 2px solid ${isActive ? 'var(--success)' : 'var(--gray-light)'}; border-radius: 12px; padding: 1.5rem; position: relative;">
                        ${isActive ? '<span style="position: absolute; top: 10px; right: 10px; background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">ACTIVE</span>' : ''}
                        <h3 style="margin: 0 0 0.5rem 0;">${promo.name}</h3>
                        <div style="font-size: 0.875rem; color: var(--gray-dark); margin-bottom: 1rem;">
                            ${promo.description || 'No description'}
                        </div>
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <strong>Type:</strong> ${promo.type}
                        </div>
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <strong>Discount:</strong> ${formatPromoDiscount(promo)}
                        </div>
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <strong>Valid:</strong> ${promo.startDate} to ${promo.endDate}
                        </div>
                        ${promo.promoCode ? `<div style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Code:</strong> ${promo.promoCode}</div>` : ''}
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="editPromotion(${index})" style="flex: 1;">Edit</button>
                            <button class="btn btn-danger" onclick="deletePromotion(${index})" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function isPromotionActive(promo) {
            const now = new Date();
            const start = new Date(promo.startDate);
            const end = new Date(promo.endDate);
            return now >= start && now <= end;
        }
        
        function formatPromoDiscount(promo) {
            if (promo.discountType === 'percentage') {
                return `${promo.percentageOff}% off`;
            } else if (promo.discountType === 'dollar') {
                return `$${promo.dollarOff} off`;
            } else if (promo.discountType === 'bogo') {
                return 'Buy One Get One';
            }
            return 'Custom offer';
        }
        
        function addPromotion() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Promotion';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Promotion Name</label>
                    <input type="text" class="form-input" id="promoName" placeholder="e.g., Weekend Special">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="promoDescription" rows="2" placeholder="Brief description of the promotion"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Promotion Type</label>
                        <select class="form-select" id="promoType">
                            <option value="time-based">Time-Based</option>
                            <option value="customer-based">Customer-Based</option>
                            <option value="event-based">Event-Based</option>
                            <option value="code-based">Promo Code</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Discount Type</label>
                        <select class="form-select" id="promoDiscountType" onchange="updatePromoDiscountType(this)">
                            <option value="percentage">Percentage Off</option>
                            <option value="dollar">Dollar Amount Off</option>
                            <option value="bogo">Buy One Get One</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group" id="promoPercentageGroup">
                        <label class="form-label">Percentage Off (%)</label>
                        <input type="number" class="form-input" id="promoPercentage" min="0" max="100" placeholder="20">
                    </div>
                    <div class="form-group" id="promoDollarGroup" style="display: none;">
                        <label class="form-label">Dollar Amount Off ($)</label>
                        <input type="number" class="form-input" id="promoDollar" min="0" step="0.01" placeholder="5.00">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" id="promoStartDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" id="promoEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Promo Code (optional)</label>
                    <input type="text" class="form-input" id="promoCode" placeholder="e.g., SAVE20">
                </div>
                <div class="form-group">
                    <label class="form-label">Minimum Purchase ($)</label>
                    <input type="number" class="form-input" id="promoMinPurchase" min="0" step="0.01" placeholder="0">
                </div>
            `;
            
            window.updatePromoDiscountType = function(select) {
                document.getElementById('promoPercentageGroup').style.display = select.value === 'percentage' ? 'block' : 'none';
                document.getElementById('promoDollarGroup').style.display = select.value === 'dollar' ? 'block' : 'none';
            };
            
            modalSaveBtn.onclick = () => {
                const promotions = NewcoData.get('promotions') || [];
                const discountType = document.getElementById('promoDiscountType').value;
                const newPromo = {
                    id: Date.now().toString(),
                    name: document.getElementById('promoName').value,
                    description: document.getElementById('promoDescription').value,
                    type: document.getElementById('promoType').value,
                    discountType: discountType,
                    percentageOff: discountType === 'percentage' ? parseInt(document.getElementById('promoPercentage').value) || 0 : 0,
                    dollarOff: discountType === 'dollar' ? parseFloat(document.getElementById('promoDollar').value) || 0 : 0,
                    startDate: document.getElementById('promoStartDate').value,
                    endDate: document.getElementById('promoEndDate').value,
                    promoCode: document.getElementById('promoCode').value,
                    minimumPurchase: parseFloat(document.getElementById('promoMinPurchase').value) || 0
                };
                
                promotions.push(newPromo);
                NewcoData.set('promotions', promotions);
                closeModal();
                loadActivePromotions();
                showSuccess(`Promotion "${newPromo.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }
        
        function editPromotion(index) {
            showAlert('Edit functionality coming soon', 'Info');
        }
        
        function deletePromotion(index) {
            showConfirm(
                'Are you sure you want to delete this promotion?',
                () => {
                    const promotions = NewcoData.get('promotions') || [];
                    const deleted = promotions.splice(index, 1)[0];
                    NewcoData.set('promotions', promotions);
                    loadActivePromotions();
                    showSuccess(`Promotion "${deleted.name}" deleted successfully`);
                },
                'Delete Promotion'
            );
        }
        
        // Loyalty Items Management Functions
        function loadLoyaltyItems() {
            const loyaltyItems = window.tempLoyaltyItems || NewcoData.get('loyaltyItems') || [];
            const container = document.getElementById('loyaltyItemsContainer');
            
            if (loyaltyItems.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No loyalty items created yet. Click "Add Loyalty Item" to create rewards for your loyal customers.</p>';
                return;
            }
            
            let html = '<div class="packages-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">';
            
            loyaltyItems.forEach((item, index) => {
                // Retrieve art from memory using IDs
                let artDisplay = '';
                if (window.artStorage) {
                    const backgroundArt = item.backgroundArtId ? window.artStorage[item.backgroundArtId] : null;
                    const bannerArt = item.bannerArtId ? window.artStorage[item.bannerArtId] : null;
                    const displayArt = backgroundArt || bannerArt || item.backgroundArt || item.bannerArt || item.art;
                    
                    if (displayArt) {
                        artDisplay = `<div style="width: 100%; height: 120px; background: url('${displayArt}') center/contain no-repeat; margin-bottom: 1rem;"></div>`;
                    }
                } else if (item.art) {
                    artDisplay = `<div style="width: 100%; height: 120px; background: url('${item.art}') center/contain no-repeat; margin-bottom: 1rem;"></div>`;
                }
                
                html += `
                    <div class="package-card" style="background: white; border: 2px solid var(--warning); border-radius: 12px; padding: 1.5rem; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">
                            ${item.pointsCost} Points
                        </div>
                        <h3 style="margin: 0 0 0.5rem 0;">${item.name}</h3>
                        <div style="font-size: 0.875rem; color: var(--gray-dark); margin-bottom: 1rem;">
                            ${item.description || 'No description'}
                        </div>
                        ${item.category ? `<div style="font-size: 0.875rem; color: var(--secondary); margin-bottom: 0.5rem;">Category: ${item.category}</div>` : ''}
                        ${item.limitPerCustomer ? `<div style="font-size: 0.875rem; color: var(--danger);">Limit: ${item.limitPerCustomer} per customer</div>` : ''}
                        ${item.expiresAfterDays ? `<div style="font-size: 0.875rem; color: var(--gray);">Expires: ${item.expiresAfterDays} days after redemption</div>` : ''}
                        ${item.hasDateRestrictions ? `<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <span style="background: #f97316; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">📅 Date Restricted</span>
                        </div>` : ''}
                        ${item.specialEventsOnly ? `<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <span style="background: #8b5cf6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">🎉 Special Events Only</span>
                        </div>` : ''}
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="editLoyaltyItem(${index})" style="flex: 1;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteLoyaltyItem(${index})" style="flex: 1;">Delete</button>
                            ${index > 0 ? `<button class="btn btn-secondary" onclick="moveLoyaltyItem(${index}, -1)">↑</button>` : ''}
                            ${index < loyaltyItems.length - 1 ? `<button class="btn btn-secondary" onclick="moveLoyaltyItem(${index}, 1)">↓</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function addLoyaltyItem() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Loyalty Item';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input type="text" class="form-input" id="loyaltyName" placeholder="e.g., Free Session Voucher">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="loyaltyDescription" rows="2" placeholder="What does this reward include?"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Points Cost</label>
                        <input type="number" class="form-input" id="loyaltyPoints" min="0" placeholder="500">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="loyaltyCategory">
                            <option value="">Select Category</option>
                            <option value="vouchers">Free Play Vouchers</option>
                            <option value="food">Food & Beverage</option>
                            <option value="merchandise">Merchandise</option>
                            <option value="vip">VIP Experiences</option>
                            <option value="special">Special Offers</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Limit Per Customer (optional)</label>
                        <input type="number" class="form-input" id="loyaltyLimit" min="0" placeholder="e.g., 1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expires After (days, optional)</label>
                        <input type="number" class="form-input" id="loyaltyExpires" min="0" placeholder="e.g., 30">
                    </div>
                </div>
                
                <!-- Day/Date Eligibility Section -->
                <div class="form-group">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-dark); font-size: 1rem; border-bottom: 1px solid var(--gray-light); padding-bottom: 0.5rem;">📅 Day/Date Eligibility</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="loyaltyHasDateRestrictions" onchange="toggleLoyaltyDateRestrictions(this)"> Restrict to specific days/dates
                    </label>
                </div>
                
                <div id="loyaltyDateRestrictionsGroup" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Available Days</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayMon" value="monday"> Mon
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayTue" value="tuesday"> Tue
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayWed" value="wednesday"> Wed
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayThu" value="thursday"> Thu
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayFri" value="friday"> Fri
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDaySat" value="saturday"> Sat
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDaySun" value="sunday"> Sun
                                </label>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only available on selected days</p>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Valid From Date</label>
                            <input type="date" class="form-input" id="loyaltyValidFrom">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no start date</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valid Until Date</label>
                            <input type="date" class="form-input" id="loyaltyValidUntil">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no end date</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="loyaltySpecialEventsOnly"> Only available during special events
                        </label>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only shows when sessions are marked as special events</p>
                    </div>
                </div>
                
            `;
            
            // Add toggle function for date restrictions
            window.toggleLoyaltyDateRestrictions = function(checkbox) {
                document.getElementById('loyaltyDateRestrictionsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            modalSaveBtn.onclick = () => {
                const loyaltyItems = NewcoData.get('loyaltyItems') || [];
                const categorySelect = document.getElementById('loyaltyCategory');
                const itemId = Date.now().toString();
                    
                    // Collect selected days
                    const selectedDays = [];
                    if (document.getElementById('loyaltyHasDateRestrictions').checked) {
                        if (document.getElementById('loyaltyDayMon').checked) selectedDays.push('monday');
                        if (document.getElementById('loyaltyDayTue').checked) selectedDays.push('tuesday');
                        if (document.getElementById('loyaltyDayWed').checked) selectedDays.push('wednesday');
                        if (document.getElementById('loyaltyDayThu').checked) selectedDays.push('thursday');
                        if (document.getElementById('loyaltyDayFri').checked) selectedDays.push('friday');
                        if (document.getElementById('loyaltyDaySat').checked) selectedDays.push('saturday');
                        if (document.getElementById('loyaltyDaySun').checked) selectedDays.push('sunday');
                    }
                    
                    const newItem = {
                        id: itemId,
                        name: document.getElementById('loyaltyName').value,
                        description: document.getElementById('loyaltyDescription').value,
                        pointsCost: parseInt(document.getElementById('loyaltyPoints').value) || 0,
                        category: categorySelect ? categorySelect.value : 'merchandise',
                        limitPerCustomer: parseInt(document.getElementById('loyaltyLimit').value) || null,
                        expiresAfterDays: parseInt(document.getElementById('loyaltyExpires').value) || null,
                        order: loyaltyItems.length,
                        // Date/day restrictions
                        hasDateRestrictions: document.getElementById('loyaltyHasDateRestrictions').checked,
                        availableDays: selectedDays,
                        validFrom: document.getElementById('loyaltyValidFrom').value || null,
                        validUntil: document.getElementById('loyaltyValidUntil').value || null,
                        specialEventsOnly: document.getElementById('loyaltySpecialEventsOnly').checked || false
                    };
                    
                    loyaltyItems.push(newItem);
                    
                    try {
                        NewcoData.set('loyaltyItems', loyaltyItems);
                    } catch (e) {
                        console.warn('Could not save to localStorage, keeping in memory:', e);
                        // Keep the item in memory even if localStorage fails
                        window.tempLoyaltyItems = loyaltyItems;
                    }
                    
                    closeModal();
                    loadLoyaltyItems();
                    showSuccess(`Loyalty item "${newItem.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }
        
        function editLoyaltyItem(index) {
            const items = NewcoData.get('loyaltyItems') || [];
            const item = items[index];
            if (!item) return;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            // Copy the form from addLoyaltyItem
            modalTitle.textContent = 'Edit Loyalty Item';
            
            // Get the form HTML from addLoyaltyItem function
            addLoyaltyItem();
            
            // Change the title after addLoyaltyItem sets it
            modalTitle.textContent = 'Edit Loyalty Item';
            
            // Pre-fill values after a short delay
            setTimeout(() => {
                document.getElementById('loyaltyName').value = item.name || '';
                document.getElementById('loyaltyDescription').value = item.description || '';
                document.getElementById('loyaltyPoints').value = item.pointsCost || '';
                const categorySelect = document.getElementById('loyaltyCategory');
                if (categorySelect) {
                    categorySelect.value = item.category || 'merchandise';
                }
                const limitInput = document.getElementById('loyaltyLimit');
                if (limitInput) {
                    limitInput.value = item.limitPerCustomer || '';
                }
                const expiresInput = document.getElementById('loyaltyExpires');
                if (expiresInput) {
                    expiresInput.value = item.expiresAfterDays || '';
                }
                
                // Load date/day restrictions
                document.getElementById('loyaltyHasDateRestrictions').checked = item.hasDateRestrictions || false;
                if (item.hasDateRestrictions) {
                    document.getElementById('loyaltyDateRestrictionsGroup').style.display = 'block';
                    // Set available days
                    if (item.availableDays && item.availableDays.length > 0) {
                        document.getElementById('loyaltyDayMon').checked = item.availableDays.includes('monday');
                        document.getElementById('loyaltyDayTue').checked = item.availableDays.includes('tuesday');
                        document.getElementById('loyaltyDayWed').checked = item.availableDays.includes('wednesday');
                        document.getElementById('loyaltyDayThu').checked = item.availableDays.includes('thursday');
                        document.getElementById('loyaltyDayFri').checked = item.availableDays.includes('friday');
                        document.getElementById('loyaltyDaySat').checked = item.availableDays.includes('saturday');
                        document.getElementById('loyaltyDaySun').checked = item.availableDays.includes('sunday');
                    }
                    // Set date range
                    document.getElementById('loyaltyValidFrom').value = item.validFrom || '';
                    document.getElementById('loyaltyValidUntil').value = item.validUntil || '';
                    // Set special events only
                    document.getElementById('loyaltySpecialEventsOnly').checked = item.specialEventsOnly || false;
                }
                
                // Store current art - retrieve from memory if using IDs
                if (window.artStorage) {
                    window.selectedLoyaltyBannerArt = item.bannerArtId ? window.artStorage[item.bannerArtId] : item.bannerArt;
                    window.selectedLoyaltyBackgroundArt = item.backgroundArtId ? window.artStorage[item.backgroundArtId] : item.backgroundArt;
                } else {
                    window.selectedLoyaltyBannerArt = item.bannerArt;
                    window.selectedLoyaltyBackgroundArt = item.backgroundArt;
                }
                
                if (item.bannerArt) {
                    const preview = document.getElementById('loyaltyBannerArtSelected');
                    if (preview) preview.textContent = 'Current banner art saved';
                }
                if (item.backgroundArt) {
                    const preview = document.getElementById('loyaltyBackgroundArtSelected');
                    if (preview) preview.textContent = 'Current background art saved';
                }
                
                // Override save function to update instead of create
                modalSaveBtn.onclick = () => {
                    const bannerFileInput = document.getElementById('loyaltyBannerArt');
                    const backgroundFileInput = document.getElementById('loyaltyBackgroundArt');
                    const bannerFile = bannerFileInput ? bannerFileInput.files[0] : null;
                    const backgroundFile = backgroundFileInput ? backgroundFileInput.files[0] : null;
                    let bannerArtData = null;
                    let backgroundArtData = null;
                    let pendingUploads = 0;
                    
                    function checkAndSave() {
                        if (pendingUploads === 0) {
                            updateLoyaltyItem();
                        }
                    }
                    
                    if (bannerFile) {
                        pendingUploads++;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            bannerArtData = e.target.result;
                            pendingUploads--;
                            checkAndSave();
                        };
                        reader.readAsDataURL(bannerFile);
                    }
                    
                    if (backgroundFile) {
                        pendingUploads++;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            backgroundArtData = e.target.result;
                            pendingUploads--;
                            checkAndSave();
                        };
                        reader.readAsDataURL(backgroundFile);
                    }
                    
                    if (pendingUploads === 0) {
                        checkAndSave();
                    }
                    
                    function updateLoyaltyItem() {
                        const categorySelect = document.getElementById('loyaltyCategory');
                        
                        // Store images in memory instead of localStorage
                        if (!window.artStorage) {
                            window.artStorage = {};
                        }
                        
                        // Update art in memory with unique IDs
                        let bannerArtId = item.bannerArtId;
                        let backgroundArtId = item.backgroundArtId;
                        
                        if (bannerArtData || window.selectedLoyaltyBannerArt) {
                            bannerArtId = bannerArtId || 'banner_' + item.id;
                            window.artStorage[bannerArtId] = bannerArtData || window.selectedLoyaltyBannerArt;
                        }
                        
                        if (backgroundArtData || window.selectedLoyaltyBackgroundArt) {
                            backgroundArtId = backgroundArtId || 'bg_' + item.id;
                            window.artStorage[backgroundArtId] = backgroundArtData || window.selectedLoyaltyBackgroundArt;
                        }
                        
                        // Collect selected days
                        const selectedDays = [];
                        if (document.getElementById('loyaltyHasDateRestrictions').checked) {
                            if (document.getElementById('loyaltyDayMon').checked) selectedDays.push('monday');
                            if (document.getElementById('loyaltyDayTue').checked) selectedDays.push('tuesday');
                            if (document.getElementById('loyaltyDayWed').checked) selectedDays.push('wednesday');
                            if (document.getElementById('loyaltyDayThu').checked) selectedDays.push('thursday');
                            if (document.getElementById('loyaltyDayFri').checked) selectedDays.push('friday');
                            if (document.getElementById('loyaltyDaySat').checked) selectedDays.push('saturday');
                            if (document.getElementById('loyaltyDaySun').checked) selectedDays.push('sunday');
                        }
                        
                        items[index] = {
                            id: item.id,
                            name: document.getElementById('loyaltyName').value,
                            description: document.getElementById('loyaltyDescription').value,
                            pointsCost: parseInt(document.getElementById('loyaltyPoints').value) || 0,
                            category: categorySelect ? categorySelect.value : 'merchandise',
                            limitPerCustomer: parseInt(document.getElementById('loyaltyLimit').value) || null,
                            expiresAfterDays: parseInt(document.getElementById('loyaltyExpires').value) || null,
                            bannerArtId: bannerArtId,  // Store reference ID instead of data
                            backgroundArtId: backgroundArtId,  // Store reference ID instead of data
                            order: item.order || index,
                            // Date/day restrictions
                            hasDateRestrictions: document.getElementById('loyaltyHasDateRestrictions').checked,
                            availableDays: selectedDays,
                            validFrom: document.getElementById('loyaltyValidFrom').value || null,
                            validUntil: document.getElementById('loyaltyValidUntil').value || null,
                            specialEventsOnly: document.getElementById('loyaltySpecialEventsOnly').checked || false
                        };
                        
                        try {
                            NewcoData.set('loyaltyItems', items);
                        } catch (e) {
                            console.warn('Could not save to localStorage, keeping in memory:', e);
                            window.tempLoyaltyItems = items;
                        }
                        
                        // Clear selected art
                        window.selectedLoyaltyBannerArt = null;
                        window.selectedLoyaltyBackgroundArt = null;
                        
                        closeModal();
                        loadLoyaltyItems();
                        showSuccess(`Loyalty item "${items[index].name}" updated successfully`);
                    }
                };
            }, 100);
        }
        
        function deleteLoyaltyItem(index) {
            showConfirm(
                'Are you sure you want to delete this loyalty item?',
                () => {
                    const loyaltyItems = NewcoData.get('loyaltyItems') || [];
                    const deleted = loyaltyItems.splice(index, 1)[0];
                    NewcoData.set('loyaltyItems', loyaltyItems);
                    loadLoyaltyItems();
                    showSuccess(`Loyalty item "${deleted.name}" deleted successfully`);
                },
                'Delete Loyalty Item'
            );
        }
        
        function moveLoyaltyItem(index, direction) {
            const loyaltyItems = NewcoData.get('loyaltyItems') || [];
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < loyaltyItems.length) {
                [loyaltyItems[index], loyaltyItems[newIndex]] = [loyaltyItems[newIndex], loyaltyItems[index]];
                loyaltyItems.forEach((item, i) => item.order = i);
                NewcoData.set('loyaltyItems', loyaltyItems);
                loadLoyaltyItems();
            }
        }
        
        // Sales Items Management Functions
        function loadSalesItems() {
            const items = window.tempSalesItems || NewcoData.get('salesItems') || [];
            const container = document.getElementById('salesItemsContainer');
            
            if (items.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No basic offerings created yet. Click "Create Examples" for quick setup or "Add Offering" to create your first basic bingo item.</p>';
                return;
            }
            
            let html = '<div class="offerings-grid">';
            
            items.forEach((item, index) => {
                let loyaltyInfo = '';
                if (item.canBuyWithLoyalty) {
                    loyaltyInfo = `${item.loyaltyPointsCost || 0} pts`;
                }
                
                let bonusInfo = '';
                if (item.givesBonus) {
                    if (item.bonusType === 'fixed') {
                        bonusInfo = `+${item.bonusFixed || 0}`;
                    } else if (item.bonusType === 'multiplier') {
                        bonusInfo = `${item.bonusMultiplier || 1}x`;
                    }
                }
                
                
                html += `
                <div class="offering-card">
                    <div class="offering-card-header">
                        <div class="offering-card-title">
                            <span>${item.name}</span>
                        </div>
                    </div>
                    <div class="offering-card-body">
                        <div class="offering-card-description">
                            ${item.description || 'No description provided'}
                        </div>
                        <div class="offering-card-stats">
                            <div class="offering-stat">
                                <span class="offering-stat-label">Price</span>
                                <span class="offering-stat-value">$${item.price}</span>
                            </div>
                            <div class="offering-stat">
                                <span class="offering-stat-label">Loyalty Price</span>
                                <span class="offering-stat-value">${loyaltyInfo || 'N/A'}</span>
                            </div>
                            <div class="offering-stat">
                                <span class="offering-stat-label">Display #</span>
                                <span class="offering-stat-value">${item.displayOrder || index + 1}</span>
                            </div>
                            ${item.limitPerCustomer ? `<div class="offering-stat">
                                <span class="offering-stat-label">Limit</span>
                                <span class="offering-stat-value">${item.limitPerCustomer}/customer</span>
                            </div>` : ''}
                        </div>
                        <div class="offering-card-badges">
                            ${item.canBuyWithLoyalty ? '<span class="offering-badge loyalty">💳 Loyalty Option</span>' : ''}
                            ${item.givesBonus ? 
                                (item.bonusType === 'multiplier' ? 
                                    `<span class="offering-badge bonus">⭐ ${bonusInfo} Points</span>` : 
                                    `<span class="offering-badge bonus">⭐ ${bonusInfo} Bonus</span>`
                                ) : ''}
                            ${item.hasDateRestrictions ? '<span class="offering-badge" style="background: #f97316; color: white;">📅 Date Restricted</span>' : ''}
                            ${item.specialEventsOnly ? '<span class="offering-badge" style="background: #8b5cf6; color: white;">🎉 Special Events Only</span>' : ''}
                        </div>
                    </div>
                    <div class="offering-card-actions">
                        <button class="btn btn-secondary" onclick="editSalesItem(${index})">✏️ Edit</button>
                        <button class="btn btn-danger" onclick="deleteSalesItem(${index})">🗑️ Delete</button>
                        <div style="display: flex; gap: 0.25rem;">
                            <button class="btn btn-outline" onclick="moveSalesItem(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="btn btn-outline" onclick="moveSalesItem(${index}, 1)" ${index === items.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function addSalesItem() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Basic Offering';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input type="text" class="form-input" id="itemName" placeholder="e.g., Extra Card Pack">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="itemDescription" rows="2" placeholder="Brief description of the item"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-input" id="itemPrice" min="0" step="0.01" placeholder="5.00">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Used for package pricing calculations</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="itemPackageOnly"> Package Only (cannot buy individually)
                        </label>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only available as part of packages</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="itemLoyalty" onchange="toggleLoyaltyPoints(this)"> Can also buy with loyalty points
                    </label>
                </div>
                <div class="form-group" id="loyaltyPointsCostGroup" style="display: none;">
                    <label class="form-label">Loyalty Points Cost</label>
                    <input type="number" class="form-input" id="itemLoyaltyPointsCost" min="0" placeholder="50">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Display Order #</label>
                        <input type="number" class="form-input" id="itemDisplayOrder" min="1" placeholder="1" value="${(NewcoData.get('salesItems') || []).length + 1}">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Order shown on website</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Limit Per Customer</label>
                        <input type="number" class="form-input" id="itemLimitPerCustomer" min="0" placeholder="0">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">0 = unlimited</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="itemGivesBonus" onchange="toggleBonusPoints(this)"> Gives bonus loyalty points
                    </label>
                </div>
                <div class="form-grid" id="bonusPointsGroup" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Bonus Type</label>
                        <select class="form-select" id="itemBonusType" onchange="toggleBonusType(this)">
                            <option value="fixed">Fixed Amount</option>
                            <option value="multiplier">Multiplier</option>
                        </select>
                    </div>
                    <div class="form-group" id="fixedBonusGroup">
                        <label class="form-label">Bonus Points</label>
                        <input type="number" class="form-input" id="itemBonusFixed" min="0" placeholder="10">
                    </div>
                    <div class="form-group" id="multiplierBonusGroup" style="display: none;">
                        <label class="form-label">Points Multiplier (e.g., 2 for double)</label>
                        <input type="number" class="form-input" id="itemBonusMultiplier" min="1" step="0.5" placeholder="2">
                    </div>
                </div>
                
                <!-- Day/Date Eligibility Section -->
                <div class="form-group">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-dark); font-size: 1rem; border-bottom: 1px solid var(--gray-light); padding-bottom: 0.5rem;">📅 Day/Date Eligibility</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="itemHasDateRestrictions" onchange="toggleDateRestrictions(this)"> Restrict to specific days/dates
                    </label>
                </div>
                
                <div id="dateRestrictionsGroup" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Available Days</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayMon" value="monday"> Mon
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayTue" value="tuesday"> Tue
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayWed" value="wednesday"> Wed
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayThu" value="thursday"> Thu
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayFri" value="friday"> Fri
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDaySat" value="saturday"> Sat
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDaySun" value="sunday"> Sun
                                </label>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only available on selected days</p>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Valid From Date</label>
                            <input type="date" class="form-input" id="itemValidFrom">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no start date</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valid Until Date</label>
                            <input type="date" class="form-input" id="itemValidUntil">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no end date</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="itemSpecialEventsOnly"> Only available during special events
                        </label>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only shows when sessions are marked as special events</p>
                    </div>
                </div>
                
            `;
            
            // Add helper functions for toggling
            window.toggleLoyaltyPoints = function(checkbox) {
                document.getElementById('loyaltyPointsCostGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.toggleBonusPoints = function(checkbox) {
                document.getElementById('bonusPointsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.toggleBonusType = function(select) {
                document.getElementById('fixedBonusGroup').style.display = select.value === 'fixed' ? 'block' : 'none';
                document.getElementById('multiplierBonusGroup').style.display = select.value === 'multiplier' ? 'block' : 'none';
            };
            
            window.toggleDateRestrictions = function(checkbox) {
                document.getElementById('dateRestrictionsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            
            modalSaveBtn.onclick = () => {
                    const items = NewcoData.get('salesItems') || [];
                    const itemId = Date.now().toString();
                    
                    // Collect selected days
                    const selectedDays = [];
                    if (document.getElementById('itemHasDateRestrictions').checked) {
                        if (document.getElementById('itemDayMon').checked) selectedDays.push('monday');
                        if (document.getElementById('itemDayTue').checked) selectedDays.push('tuesday');
                        if (document.getElementById('itemDayWed').checked) selectedDays.push('wednesday');
                        if (document.getElementById('itemDayThu').checked) selectedDays.push('thursday');
                        if (document.getElementById('itemDayFri').checked) selectedDays.push('friday');
                        if (document.getElementById('itemDaySat').checked) selectedDays.push('saturday');
                        if (document.getElementById('itemDaySun').checked) selectedDays.push('sunday');
                    }
                    
                    const newItem = {
                        id: itemId,
                        name: document.getElementById('itemName').value,
                        description: document.getElementById('itemDescription').value,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        packageOnly: document.getElementById('itemPackageOnly').checked || false,
                        canBuyWithLoyalty: document.getElementById('itemLoyalty').checked,
                        loyaltyPointsCost: document.getElementById('itemLoyalty').checked ?
                            parseInt(document.getElementById('itemLoyaltyPointsCost').value) || 0 : null,
                        givesBonus: document.getElementById('itemGivesBonus').checked,
                        bonusType: document.getElementById('itemGivesBonus').checked ?
                            document.getElementById('itemBonusType').value : null,
                        bonusFixed: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'fixed' ?
                            parseInt(document.getElementById('itemBonusFixed').value) || 0 : null,
                        bonusMultiplier: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'multiplier' ?
                            parseFloat(document.getElementById('itemBonusMultiplier').value) || 1 : null,
                        displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || items.length + 1,
                        limitPerCustomer: parseInt(document.getElementById('itemLimitPerCustomer').value) || 0,
                        // Date/day restrictions
                        hasDateRestrictions: document.getElementById('itemHasDateRestrictions').checked,
                        availableDays: selectedDays,
                        validFrom: document.getElementById('itemValidFrom').value || null,
                        validUntil: document.getElementById('itemValidUntil').value || null,
                        specialEventsOnly: document.getElementById('itemSpecialEventsOnly').checked || false
                    };
                    
                    items.push(newItem);
                    
                    try {
                        NewcoData.set('salesItems', items);
                    } catch (e) {
                        console.warn('Could not save to localStorage, keeping in memory:', e);
                        window.tempSalesItems = items;
                    }
                    
                    closeModal();
                    loadSalesItems();
                    showSuccess(`Offering "${newItem.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }
        
        function editSalesItem(index) {
            const items = NewcoData.get('salesItems') || [];
            const item = items[index];
            if (!item) return;
            
            // Use the same form as addSalesItem but with pre-filled values
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Edit Basic Offering';
            
            // Copy the same form from addSalesItem
            modalBody.innerHTML = addSalesItem.toString().match(/modalBody\.innerHTML = `([\s\S]*?)`/)[1];
            
            // Pre-fill the form with existing values
            setTimeout(() => {
                document.getElementById('itemName').value = item.name || '';
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('itemPrice').value = item.price || '';
                document.getElementById('itemPackageOnly').checked = item.packageOnly || false;
                document.getElementById('itemLoyalty').checked = item.canBuyWithLoyalty || false;
                if (item.canBuyWithLoyalty) {
                    document.getElementById('loyaltyPointsCostGroup').style.display = 'block';
                    document.getElementById('itemLoyaltyPointsCost').value = item.loyaltyPointsCost || '';
                }
                document.getElementById('itemDisplayOrder').value = item.displayOrder || index + 1;
                document.getElementById('itemLimitPerCustomer').value = item.limitPerCustomer || 0;
                document.getElementById('itemGivesBonus').checked = item.givesBonus || false;
                if (item.givesBonus) {
                    document.getElementById('bonusPointsGroup').style.display = 'grid';
                    document.getElementById('itemBonusType').value = item.bonusType || 'fixed';
                    if (item.bonusType === 'fixed') {
                        document.getElementById('fixedBonusGroup').style.display = 'block';
                        document.getElementById('multiplierBonusGroup').style.display = 'none';
                        document.getElementById('itemBonusFixed').value = item.bonusFixed || '';
                    } else {
                        document.getElementById('fixedBonusGroup').style.display = 'none';
                        document.getElementById('multiplierBonusGroup').style.display = 'block';
                        document.getElementById('itemBonusMultiplier').value = item.bonusMultiplier || '';
                    }
                }
                
                // Load date/day restrictions
                document.getElementById('itemHasDateRestrictions').checked = item.hasDateRestrictions || false;
                if (item.hasDateRestrictions) {
                    document.getElementById('dateRestrictionsGroup').style.display = 'block';
                    // Set available days
                    if (item.availableDays && item.availableDays.length > 0) {
                        document.getElementById('itemDayMon').checked = item.availableDays.includes('monday');
                        document.getElementById('itemDayTue').checked = item.availableDays.includes('tuesday');
                        document.getElementById('itemDayWed').checked = item.availableDays.includes('wednesday');
                        document.getElementById('itemDayThu').checked = item.availableDays.includes('thursday');
                        document.getElementById('itemDayFri').checked = item.availableDays.includes('friday');
                        document.getElementById('itemDaySat').checked = item.availableDays.includes('saturday');
                        document.getElementById('itemDaySun').checked = item.availableDays.includes('sunday');
                    }
                    // Set date range
                    document.getElementById('itemValidFrom').value = item.validFrom || '';
                    document.getElementById('itemValidUntil').value = item.validUntil || '';
                    // Set special events only
                    document.getElementById('itemSpecialEventsOnly').checked = item.specialEventsOnly || false;
                }
            }, 100);
            
            // Override save function to update instead of create
            modalSaveBtn.onclick = () => {
                const bannerArtInput = document.getElementById('itemBannerArt');
                const backgroundArtInput = document.getElementById('itemBackgroundArt');
                let bannerArtData = null;
                let backgroundArtData = null;
                let pendingUploads = 0;
                
                function checkAndSave() {
                    if (pendingUploads === 0) {
                        updateItem();
                    }
                }
                
                if (bannerArtInput && bannerArtInput.files[0]) {
                    pendingUploads++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        bannerArtData = e.target.result;
                        pendingUploads--;
                        checkAndSave();
                    };
                    reader.readAsDataURL(bannerArtInput.files[0]);
                }
                
                if (backgroundArtInput && backgroundArtInput.files[0]) {
                    pendingUploads++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        backgroundArtData = e.target.result;
                        pendingUploads--;
                        checkAndSave();
                    };
                    reader.readAsDataURL(backgroundArtInput.files[0]);
                }
                
                if (pendingUploads === 0) {
                    checkAndSave();
                }
                
                function updateItem() {
                    const items = NewcoData.get('salesItems') || [];
                    
                    // Collect selected days
                    const selectedDays = [];
                    if (document.getElementById('itemHasDateRestrictions').checked) {
                        if (document.getElementById('itemDayMon').checked) selectedDays.push('monday');
                        if (document.getElementById('itemDayTue').checked) selectedDays.push('tuesday');
                        if (document.getElementById('itemDayWed').checked) selectedDays.push('wednesday');
                        if (document.getElementById('itemDayThu').checked) selectedDays.push('thursday');
                        if (document.getElementById('itemDayFri').checked) selectedDays.push('friday');
                        if (document.getElementById('itemDaySat').checked) selectedDays.push('saturday');
                        if (document.getElementById('itemDaySun').checked) selectedDays.push('sunday');
                    }
                    
                    items[index] = {
                        id: item.id,
                        name: document.getElementById('itemName').value,
                        description: document.getElementById('itemDescription').value,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        packageOnly: document.getElementById('itemPackageOnly').checked || false,
                        canBuyWithLoyalty: document.getElementById('itemLoyalty').checked,
                        loyaltyPointsCost: document.getElementById('itemLoyalty').checked ?
                            parseInt(document.getElementById('itemLoyaltyPointsCost').value) || 0 : null,
                        givesBonus: document.getElementById('itemGivesBonus').checked,
                        bonusType: document.getElementById('itemGivesBonus').checked ?
                            document.getElementById('itemBonusType').value : null,
                        bonusFixed: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'fixed' ?
                            parseInt(document.getElementById('itemBonusFixed').value) || 0 : null,
                        bonusMultiplier: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'multiplier' ?
                            parseFloat(document.getElementById('itemBonusMultiplier').value) || 1 : null,
                        displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || index + 1,
                        limitPerCustomer: parseInt(document.getElementById('itemLimitPerCustomer').value) || 0,
                        // Date/day restrictions
                        hasDateRestrictions: document.getElementById('itemHasDateRestrictions').checked,
                        availableDays: selectedDays,
                        validFrom: document.getElementById('itemValidFrom').value || null,
                        validUntil: document.getElementById('itemValidUntil').value || null,
                        specialEventsOnly: document.getElementById('itemSpecialEventsOnly').checked || false
                    };
                    
                    NewcoData.set('salesItems', items);
                    
                    closeModal();
                    loadSalesItems();
                    showSuccess(`Offering "${items[index].name}" updated successfully`);
                }
            };
            
            modal.classList.add('active');
        }
        
        function deleteSalesItem(index) {
            showConfirm(
                'Are you sure you want to delete this offering?',
                () => {
                    const items = NewcoData.get('salesItems') || [];
                    const deleted = items.splice(index, 1)[0];
                    NewcoData.set('salesItems', items);
                    loadSalesItems();
                    showSuccess(`Offering "${deleted.name}" deleted successfully`);
                },
                'Delete Item'
            );
        }
        
        function moveSalesItem(index, direction) {
            const items = NewcoData.get('salesItems') || [];
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < items.length) {
                [items[index], items[newIndex]] = [items[newIndex], items[index]];
                items.forEach((item, i) => item.order = i);
                NewcoData.set('salesItems', items);
                loadSalesItems();
            }
        }
        
        // Modal functions
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        
        // Reusable Alert/Confirm Modal System
        function showModal(options) {
            const defaults = {
                title: 'Alert',
                message: '',
                type: 'info', // info, success, warning, error, confirm
                confirmText: 'OK',
                cancelText: 'Cancel',
                onConfirm: null,
                onCancel: null,
                showCancel: false
            };
            
            const config = { ...defaults, ...options };
            
            // Create or get alert modal
            let alertModal = document.getElementById('alertModal');
            if (!alertModal) {
                alertModal = document.createElement('div');
                alertModal.id = 'alertModal';
                alertModal.className = 'modal';
                alertModal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; max-height: 80vh; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                        <div class="modal-header" id="modalHeaderColor" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 1.5rem; flex-shrink: 0;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span id="alertIcon" style="font-size: 2rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"></span>
                                <h2 class="modal-title" id="alertTitle" style="margin: 0; color: white; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);"></h2>
                            </div>
                        </div>
                        <div id="alertBody" style="padding: 2rem; color: var(--gray-dark); line-height: 1.6; font-size: 1.05rem; background: white; overflow-y: auto; flex: 1;">
                            <!-- Message content -->
                        </div>
                        <div class="modal-footer" id="alertFooter" style="background: var(--gray-lighter); padding: 1rem 1.5rem; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 0.75rem; justify-content: flex-end; flex-shrink: 0;">
                            <!-- Buttons -->
                        </div>
                    </div>
                `;
                document.body.appendChild(alertModal);
            }
            
            // Set icon based on type
            const icons = {
                info: '💡',
                success: '✅',
                warning: '⚠️',
                error: '❌',
                confirm: '❓'
            };
            
            const headerColors = {
                info: 'linear-gradient(135deg, #2196f3, #1976d2)',
                success: 'linear-gradient(135deg, #4caf50, #388e3c)',
                warning: 'linear-gradient(135deg, #ff9800, #f57c00)',
                error: 'linear-gradient(135deg, #f44336, #d32f2f)',
                confirm: 'linear-gradient(135deg, var(--primary), var(--primary-dark))'
            };
            
            document.getElementById('alertIcon').textContent = icons[config.type] || icons.info;
            document.getElementById('alertTitle').textContent = config.title;
            document.getElementById('alertBody').innerHTML = config.message;
            
            // Apply header color based on type
            const header = document.getElementById('modalHeaderColor');
            if (header) {
                header.style.background = headerColors[config.type] || headerColors.info;
            }
            
            // Set up buttons with better styling
            const footer = document.getElementById('alertFooter');
            footer.innerHTML = '';
            
            if (config.type === 'confirm' || config.showCancel) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.style.padding = '0.625rem 1.5rem';
                cancelBtn.style.borderRadius = '8px';
                cancelBtn.style.fontWeight = '500';
                cancelBtn.textContent = config.cancelText;
                cancelBtn.onclick = () => {
                    alertModal.classList.remove('active');
                    if (config.onCancel) config.onCancel();
                };
                footer.appendChild(cancelBtn);
            }
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = config.type === 'error' ? 'btn btn-danger' : 'btn btn-primary';
            confirmBtn.style.padding = '0.625rem 1.5rem';
            confirmBtn.style.borderRadius = '8px';
            confirmBtn.style.fontWeight = '500';
            confirmBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            confirmBtn.textContent = config.confirmText;
            confirmBtn.onclick = () => {
                alertModal.classList.remove('active');
                if (config.onConfirm) config.onConfirm();
            };
            footer.appendChild(confirmBtn);
            
            // Show modal
            alertModal.classList.add('active');
            
            // Auto-close for non-confirm modals after 3 seconds (optional)
            if (config.type !== 'confirm' && !config.showCancel && config.autoClose !== false) {
                setTimeout(() => {
                    alertModal.classList.remove('active');
                }, 3000);
            }
        }
        
        // Convenience functions
        function showAlert(message, title = 'Alert') {
            showModal({ type: 'info', title, message });
        }
        
        function showSuccess(message, title = 'Success') {
            showModal({ type: 'success', title, message });
        }
        
        function showError(message, title = 'Error') {
            showModal({ type: 'error', title, message });
        }
        
        function showConfirm(message, onConfirm, title = 'Confirm') {
            showModal({
                type: 'confirm',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                onConfirm
            });
        }

        function showComingSoon(featureName) {
            // Clear all active nav items since this isn't a real section
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            showModal({
                title: `${featureName} - Coming Soon`,
                message: `<div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🚀</div>
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Coming Soon!</h3>
                    <p style="color: var(--gray); line-height: 1.6;">
                        The ${featureName} feature is currently in development and will be available in a future update.
                    </p>
                </div>`,
                confirmText: 'OK'
            });
        }

        // Page Builder Functions
        function loadPageBuilder() {
            // Initialize drag and drop
            initializeDragAndDrop();
        }

        function initializeDragAndDrop() {
            const components = document.querySelectorAll('.drag-component');
            const canvas = document.getElementById('pageCanvas');
            
            if (!canvas) {
                console.warn('pageCanvas element not found, skipping drag and drop initialization');
                return;
            }
            
            components.forEach(component => {
                component.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('component', e.target.dataset.component);
                    e.target.classList.add('dragging');
                });
                
                component.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            });
            
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const componentType = e.dataTransfer.getData('component');
                addComponentToCanvas(componentType);
            });
        }

        function addComponentToCanvas(type) {
            const canvas = document.getElementById('pageCanvas');
            
            // Clear placeholder text if it's the first component
            if (canvas.querySelector('p')) {
                canvas.innerHTML = '';
            }
            
            const component = document.createElement('div');
            component.className = 'page-component';
            component.dataset.componentType = type;
            
            let content = '';
            switch(type) {
                case 'header':
                    content = '<h2>Welcome to ' + (NewcoData.get("organization")?.name || 'Our Bingo Hall') + '</h2>';
                    break;
                case 'session-selector':
                    content = '<div>📅 Session Selector Component</div>';
                    break;
                case 'package-cards':
                    content = '<div>📦 Package Selection Cards</div>';
                    break;
                case 'seat-selector':
                    content = '<div>🪑 Seat Selection Grid</div>';
                    break;
                case 'pricing':
                    content = '<div>💰 Dynamic Pricing Display</div>';
                    break;
                case 'checkout':
                    content = '<div>🛒 Checkout Form</div>';
                    break;
                case 'text':
                    content = '<p contenteditable="true">Click to edit this text...</p>';
                    break;
                case 'image':
                    content = '<div>🖼️ Image Placeholder</div>';
                    break;
            }
            
            component.innerHTML = content + '<button class="remove-btn" onclick="removeComponent(this)">×</button>';
            canvas.appendChild(component);
            
            // Show properties for the new component
            showComponentProperties(component);
        }

        function removeComponent(btn) {
            btn.parentElement.remove();
        }

        function showComponentProperties(component) {
            const panel = document.getElementById('propertyPanel');
            const type = component.dataset.componentType;
            
            let properties = '<h4>' + type.charAt(0).toUpperCase() + type.slice(1) + ' Properties</h4>';
            
            switch(type) {
                case 'text':
                    properties += `
                        <div class="form-group">
                            <label class="form-label">Font Size</label>
                            <select class="form-select">
                                <option>Small</option>
                                <option>Medium</option>
                                <option>Large</option>
                            </select>
                        </div>`;
                    break;
                case 'package-cards':
                    properties += `
                        <div class="form-group">
                            <label class="form-label">Layout</label>
                            <select class="form-select">
                                <option>Grid</option>
                                <option>List</option>
                                <option>Carousel</option>
                            </select>
                        </div>`;
                    break;
                // Add more property panels for different components
            }
            
            panel.innerHTML = properties;
        }

        // ═══════════════════════════════════════════════════════════════════
        // WEB TEMPLATES FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let selectedTemplate = 'modern';
        let currentTemplateIndex = 1; // Start with modern in center
        
        function rotateTemplateCarousel(direction) {
            const carousel = document.getElementById('templateCarousel');
            const templates = carousel.querySelectorAll('.template-card');
            const totalTemplates = templates.length;
            
            currentTemplateIndex += direction;
            if (currentTemplateIndex < 0) currentTemplateIndex = totalTemplates - 1;
            if (currentTemplateIndex >= totalTemplates) currentTemplateIndex = 0;
            
            // Update template selection and styling
            templates.forEach((template, index) => {
                const card = template.querySelector('div');
                if (index === currentTemplateIndex) {
                    // Featured template (center)
                    card.style.transform = 'scale(1)';
                    card.style.opacity = '1';
                    card.style.border = '3px solid var(--primary)';
                    template.classList.add('featured-template');
                    selectedTemplate = template.dataset.template;
                } else {
                    // Side templates
                    card.style.transform = 'scale(0.85)';
                    card.style.opacity = '0.6';
                    card.style.border = 'none';
                    template.classList.remove('featured-template');
                }
            });
            
            // Update preview
            generateTemplatePreview();
        }
        
        // Template click handlers
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', function() {
                    const templates = document.querySelectorAll('.template-card');
                    const clickedIndex = Array.from(templates).indexOf(this);
                    
                    if (clickedIndex !== currentTemplateIndex) {
                        const direction = clickedIndex > currentTemplateIndex ? 1 : -1;
                        rotateTemplateCarousel(direction * Math.abs(clickedIndex - currentTemplateIndex));
                    }
                });
            });
            
            // Initialize template preview
            generateTemplatePreview();
        });
        
        function updateApplyToHallButtons() {
            const buttonsContainer = document.getElementById('applyToHallButtons');
            const halls = NewcoData.get('halls') || [];
            
            if (!buttonsContainer) return;
            
            // Clear existing buttons
            buttonsContainer.innerHTML = '';
            
            // Only show buttons if a template is selected
            if (!selectedTemplate) {
                return;
            }
            
            // Create a button for each hall
            halls.forEach(hall => {
                const button = document.createElement('button');
                button.className = 'btn btn-primary';
                button.textContent = `Apply to ${hall.name}`;
                button.onclick = () => applyTemplateToHall(hall.id, hall.name);
                buttonsContainer.appendChild(button);
            });
        }
        
        function applyTemplateToHall(hallId, hallName) {
            if (!selectedTemplate) {
                showModal({
                    title: '⚠️ No Template Selected',
                    message: 'Please select a template first.',
                    type: 'warning'
                });
                return;
            }
            
            // Apply the selected template to the hall
            // This would update the hall's web configuration
            showModal({
                title: '✅ Template Applied',
                message: `The ${selectedTemplate} template has been applied to ${hallName}.`,
                type: 'success'
            });
            
            // TODO: Save template configuration to hall settings
            const halls = NewcoData.get('halls') || [];
            const hallIndex = halls.findIndex(h => h.id === hallId);
            if (hallIndex !== -1) {
                halls[hallIndex].webTemplate = selectedTemplate;
                NewcoData.set('halls', halls);
            }
        }
        
        function generateTemplatePreview() {
            const preview = document.getElementById('templatePreview');

            // Template preview was removed - just return
            if (!preview) return;

            const packages = NewcoData.get('packages') || [];
            const basicOfferings = NewcoData.get('basicOfferings') || [];

            // Update Apply to Hall buttons
            updateApplyToHallButtons();

            const templates = {
                classic: {
                    colors: { primary: '#667eea', secondary: '#764ba2', accent: '#9575cd' },
                    name: 'Classic Bingo Theme',
                    style: 'traditional'
                },
                modern: {
                    colors: { primary: '#2ea3f2', secondary: '#1a5f8a', accent: '#42a5f5' },
                    name: 'Modern Blue Theme', 
                    style: 'clean'
                },
                vibrant: {
                    colors: { primary: '#fa709a', secondary: '#fee140', accent: '#ff7043' },
                    name: 'Vibrant Fun Theme',
                    style: 'colorful'
                }
            };
            
            const template = templates[selectedTemplate];
            if (!template) return;
            
            preview.innerHTML = `
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto;">
                    <!-- Template Header -->
                    <div style="background: linear-gradient(135deg, ${template.colors.primary} 0%, ${template.colors.secondary} 100%); padding: 2rem; text-align: center; color: white;">
                        <h1 style="margin: 0 0 0.5rem; font-size: 2rem; font-weight: 700;">Welcome to Our Bingo Hall</h1>
                        <p style="margin: 0; opacity: 0.9; font-size: 1.1rem;">Book your session today!</p>
                    </div>
                    
                    <!-- Sample Packages -->
                    <div style="padding: 2rem;">
                        <h2 style="margin: 0 0 1.5rem; color: ${template.colors.primary}; font-size: 1.5rem;">Available Packages</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            ${packages.slice(0, 3).map(pkg => `
                                <div style="background: var(--gray-lighter); border-radius: 8px; padding: 1.5rem; border: 2px solid transparent; transition: all 0.3s;">
                                    <h3 style="margin: 0 0 0.5rem; color: ${template.colors.primary};">${pkg.name}</h3>
                                    <p style="margin: 0 0 1rem; color: var(--gray); font-size: 0.875rem;">${pkg.description || 'Package description'}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 1.25rem; font-weight: 700; color: ${template.colors.secondary};">$${pkg.price || '25'}</span>
                                        <button style="background: ${template.colors.primary}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Select</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${packages.length === 0 ? `
                                <div style="background: var(--gray-lighter); border-radius: 8px; padding: 1.5rem;">
                                    <h3 style="margin: 0 0 0.5rem; color: ${template.colors.primary};">Sample Package</h3>
                                    <p style="margin: 0 0 1rem; color: var(--gray); font-size: 0.875rem;">This is how your packages will appear</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 1.25rem; font-weight: 700; color: ${template.colors.secondary};">$25</span>
                                        <button style="background: ${template.colors.primary}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px;">Select</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Sample Basic Offerings -->
                        ${basicOfferings.length > 0 ? `
                            <h3 style="margin: 2rem 0 1rem; color: ${template.colors.primary};">Additional Options</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                ${basicOfferings.slice(0, 4).map(offer => `
                                    <div style="background: ${template.colors.accent}20; padding: 0.75rem 1rem; border-radius: 6px; border: 1px solid ${template.colors.accent}40;">
                                        <span style="font-weight: 600; color: ${template.colors.primary};">${offer.name}</span>
                                        <span style="margin-left: 0.5rem; color: var(--gray);">$${offer.price || '5'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Sample Booking Button -->
                    <div style="padding: 0 2rem 2rem; text-align: center;">
                        <button style="background: linear-gradient(135deg, ${template.colors.primary} 0%, ${template.colors.secondary} 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            Complete Booking
                        </button>
                    </div>
                </div>
            `;
        }
        
        function previewSelectedTemplate() {
            if (!selectedTemplate) {
                showModal({
                    title: '⚠️ No Template Selected',
                    message: 'Please select a template first.',
                    type: 'warning'
                });
                return;
            }
            
            const previewWindow = window.open('', 'templatePreview', 'width=1200,height=800');
            const previewContent = document.getElementById('templatePreview').innerHTML;
            
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Template Preview - ${selectedTemplate}</title>
                    <style>
                        body { 
                            font-family: Inter, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            background: #f5f5f5;
                        }
                        :root {
                            --gray: #6b7280;
                            --gray-lighter: #f9fafb;
                        }
                    </style>
                </head>
                <body>
                    ${previewContent}
                </body>
                </html>
            `);
            previewWindow.document.close();
        }
        
        function launchWebsite() {
            // Open the customer website in a new window/tab
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-customer-demo-v2.2.html?customer=${customerId}`, '_blank');
        }

        function launchCustomerSite() {
            // Open the customer demo site in a new tab
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-customer-demo-v2.2.html?customer=${customerId}`, '_blank');
        }
        
        function useSelectedTemplate() {
            if (!selectedTemplate) {
                showModal({
                    title: '⚠️ No Template Selected',
                    message: 'Please select a template first.',
                    type: 'warning'
                });
                return;
            }
            
            // Save selected template to NewcoData
            NewcoData.set('selectedWebTemplate', {
                template: selectedTemplate,
                timestamp: new Date().toISOString()
            });
            
            showModal({
                title: '✅ Template Selected',
                message: `The ${selectedTemplate} template has been set as your web template. You can now customize it further in the Web Builder.`,
                type: 'success'
            });
        }

        function generateBookingHTML(components) {
            // Generate complete HTML with embedded NewcoData
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Bingo Session</title>
    <style>
        /* Generated styles */
        body { font-family: Inter, sans-serif; }
    </style>
</head>
<body>
    <!-- Generated booking page -->
    ${Array.from(components).map(c => c.innerHTML.replace(/<button class="remove-btn".*?<\/button>/, '')).join('')}
</body>
</html>`;
        }

        // Schedule Functions
        // Session Management Functions
        function loadSessions() {
            const sessions = NewcoData.get('sessions') || [];
            const halls = NewcoData.get('halls') || [];
            const container = document.getElementById('sessionsContainer');
            
            if (halls.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No halls configured. Please add halls first.</p>';
                return;
            }
            
            if (sessions.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No sessions configured yet. Click "Add Session" to create recurring sessions.</p>';
                return;
            }
            
            container.innerHTML = sessions.map((session, index) => {
                const hall = halls.find(h => h.id === session.hallId) || halls[0];
                return `
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #333;">${session.name}</h4>
                            <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: #666;">
                                <span>📍 ${hall ? hall.name : 'Hall 1'}</span>
                                <span>🕐 ${session.startTime} - ${session.endTime}</span>
                                <span>📅 ${session.days && session.days.length > 0 ? session.days.join(', ') : 'Every day'}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="editSession(${index})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSession(${index})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addSession() {
            const halls = NewcoData.get('halls') || [];
            if (halls.length === 0) {
                // Create default Hall 1 if none exists
                const defaultHall = {
                    id: 'hall-1',
                    name: 'Hall 1',
                    address: '',
                    capacity: 100,
                    layout: { rows: 10, cols: 10, cells: {} }
                };
                halls.push(defaultHall);
                NewcoData.set('halls', halls);
            }
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Session Template';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Session Name</label>
                    <input type="text" class="form-input" id="sessionName" placeholder="e.g., Evening Session">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hall</label>
                    <select class="form-select" id="sessionHall">
                        ${halls.map(hall => `<option value="${hall.id}">${hall.name}</option>`).join('')}
                    </select>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="time" class="form-input" id="sessionStartTime" value="18:00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="time" class="form-input" id="sessionEndTime" value="22:00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Days Available</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label><input type="checkbox" class="session-day" value="Monday"> Monday</label>
                        <label><input type="checkbox" class="session-day" value="Tuesday"> Tuesday</label>
                        <label><input type="checkbox" class="session-day" value="Wednesday" checked> Wednesday</label>
                        <label><input type="checkbox" class="session-day" value="Thursday"> Thursday</label>
                        <label><input type="checkbox" class="session-day" value="Friday" checked> Friday</label>
                        <label><input type="checkbox" class="session-day" value="Saturday" checked> Saturday</label>
                        <label><input type="checkbox" class="session-day" value="Sunday" checked> Sunday</label>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave all unchecked for every day</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="sessionSpecialEvent"> Special Event Session
                    </label>
                </div>
            `;
            
            modalSaveBtn.onclick = () => {
                const sessions = NewcoData.get('sessions') || [];
                const selectedDays = Array.from(document.querySelectorAll('.session-day:checked')).map(cb => cb.value);
                
                const newSession = {
                    id: 'session-' + Date.now(),
                    name: document.getElementById('sessionName').value,
                    hallId: document.getElementById('sessionHall').value,
                    startTime: document.getElementById('sessionStartTime').value,
                    endTime: document.getElementById('sessionEndTime').value,
                    days: selectedDays,
                    day: selectedDays[0] || 'Monday', // For compatibility
                    time: `${document.getElementById('sessionStartTime').value} - ${document.getElementById('sessionEndTime').value}`,
                    specialEvent: document.getElementById('sessionSpecialEvent').checked
                };
                
                sessions.push(newSession);
                NewcoData.set('sessions', sessions);
                closeModal();
                loadSessions();
                showSuccess(`Session "${newSession.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }
        
        function editSession(index) {
            // Implementation for editing sessions
            showAlert('Edit functionality coming soon', 'Info');
        }
        
        function deleteSession(index) {
            showConfirm(
                'Are you sure you want to delete this session?',
                () => {
                    const sessions = NewcoData.get('sessions') || [];
                    const deleted = sessions.splice(index, 1)[0];
                    NewcoData.set('sessions', sessions);
                    loadSessions();
                    showSuccess(`Session "${deleted.name}" deleted successfully`);
                },
                'Delete Session'
            );
        }
        
        function loadSchedule() {
            const halls = NewcoData.get('halls') || [];
            const schedules = NewcoData.get('schedules') || {};
            const schedule = NewcoData.get('schedule') || {}; // Support both singular and plural
            const wizardData = NewcoData.get('wizardData') || {};
            const container = document.getElementById('scheduleContainer');

            if (halls.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No halls configured. Please add halls first.</p>';
                return;
            }
            
            // Get session names once for all halls
            const sessions = NewcoData.get('sessions') || [];

            let html = '';
            halls.forEach(hall => {
                // Check both per-hall schedules and global schedule.weekly
                const hallSchedule = schedules[hall.id] || {};
                const globalWeekly = schedule.weekly || {};

                html += `
                    <div class="content-section" style="margin-top: 1.5rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">🏢</span>
                                ${hall.name}
                            </h3>
                            <div style="font-size: 0.875rem; color: var(--gray);">
                                ${hall.address || 'No address set'}
                            </div>
                        </div>

                        <div style="display: grid; gap: 1rem;">
                `;

                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                const dayColors = {
                    monday: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    tuesday: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    wednesday: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    thursday: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    friday: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    saturday: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    sunday: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                };

                days.forEach(day => {
                    // Get schedule from saved data or wizard defaults
                    const defaultOpen = ['wednesday', 'friday', 'saturday', 'sunday'].includes(day);
                    const wizardSchedule = wizardData.schedule?.[day] || {};
                    let daySessions = hallSchedule[day] || globalWeekly[day];

                    // Handle both single session (object) and multiple sessions (array)
                    if (!daySessions) {
                        daySessions = {
                            open: wizardSchedule.open !== undefined ? wizardSchedule.open : defaultOpen,
                            doors: wizardSchedule.doors || '17:00',
                            early: wizardSchedule.early || '18:00',
                            regular: wizardSchedule.regular || '18:30',
                            closing: wizardSchedule.closing || '21:00'
                        };
                    }

                    // Convert to array if it's a single object
                    let sessionsArray = Array.isArray(daySessions) ? daySessions : [daySessions];

                    // If sessions come from JSON (have sessionId), ensure they have 'open' flag and populate sessionName
                    sessionsArray = sessionsArray.map(s => {
                        if (s.sessionId && s.open === undefined) {
                            // Find session details from sessions table
                            const sessionData = sessions.find(sess => sess.id === s.sessionId);
                            return {
                                ...s,
                                open: true,
                                sessionName: sessionData ? sessionData.name : s.sessionName
                            };
                        }
                        return s;
                    });

                    const dayLabel = day.charAt(0).toUpperCase() + day.slice(1);

                    // Display each session
                    sessionsArray.forEach((daySchedule, sessionIndex) => {
                    
                    html += `
                        <div style="padding: 1.25rem; background: white; border: 2px solid ${daySchedule.open ? 'var(--success)' : 'var(--gray-light)'}; border-radius: 12px; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: ${dayColors[day]}; border-radius: 12px 0 0 12px;"></div>
                            
                            <div style="padding-left: 1rem;">
                                <!-- Day Header with Toggle -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${daySchedule.open ? '1rem' : '0'};">
                                    <div>
                                        <div style="font-weight: 700; font-size: 1.1rem; background: ${dayColors[day]}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                                            ${dayLabel}${daySchedule.suffix ? ` - ${daySchedule.suffix.charAt(0).toUpperCase() + daySchedule.suffix.slice(1)}` : ''}
                                        </div>
                                        ${sessionIndex > 0 ? '<span style="font-size: 0.75rem; color: var(--gray);">Additional Session</span>' : ''}
                                    </div>
                                    
                                    <!-- Toggle Switch and Add Session Button -->
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        ${daySchedule.open ? `
                                            <button class="btn btn-sm btn-outline" onclick="addSessionForDay('${hall.id}', '${day}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                                + Add Session
                                            </button>
                                        ` : ''}
                                        <span style="font-size: 0.875rem; color: ${daySchedule.open ? 'var(--success)' : 'var(--gray)'};">
                                            ${daySchedule.open ? 'Open' : 'Closed'}
                                        </span>
                                        <label class="toggle-switch">
                                            <input type="checkbox"
                                                   id="hall-${hall.id}-${day}-toggle"
                                                   ${daySchedule.open ? 'checked' : ''}
                                                   onchange="toggleDaySchedule('${hall.id}', '${day}')">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Time Fields (shown when open) -->
                                <div id="hall-${hall.id}-${day}-${sessionIndex}-times" style="display: ${daySchedule.open ? 'grid' : 'none'}; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🚪 Doors Open</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-doors"
                                               value="${daySchedule.doors || '17:00'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'doors', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🌅 Early Bird</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-early"
                                               value="${daySchedule.early || '18:00'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'early', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🎯 Regular</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-regular"
                                               value="${daySchedule.regular || '18:30'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'regular', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🌙 Closing</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-closing"
                                               value="${daySchedule.closing || '21:00'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'closing', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                </div>

                                <!-- Session Name Field -->
                                <div id="hall-${hall.id}-${day}-${sessionIndex}-session-name-field" style="display: ${daySchedule.open ? 'block' : 'none'}; margin-top: 1rem;">
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">📋 Session Name (e.g., "Broadway Thursday", "5K Friday")</label>
                                    <input type="text"
                                           id="hall-${hall.id}-${day}-${sessionIndex}-sessionName"
                                           value="${daySchedule.sessionName || ''}"
                                           placeholder="Enter session name..."
                                           onchange="updateScheduleTime('${hall.id}', '${day}', 'sessionName', this.value, ${sessionIndex})"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                </div>
                            </div>
                        </div>
                    `;
                    }); // End sessions forEach
                }); // End days forEach
                
                html += `
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-light);">
                            <div style="font-size: 0.875rem; color: var(--gray);">
                                💡 Tip: Check the days you're open and set your operating hours
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleDaySchedule(hallId, day) {
            const toggle = document.getElementById(`hall-${hallId}-${day}-toggle`);
            // Use sessionIndex 0 for the main times div since that's the primary session
            const timesDiv = document.getElementById(`hall-${hallId}-${day}-0-times`);
            const sessionNameField = document.getElementById(`hall-${hallId}-${day}-session-name-field`);
            const schedules = NewcoData.get('schedules') || {};

            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }

            if (toggle.checked) {
                // Show time fields and session name field, save as open
                if (timesDiv) timesDiv.style.display = 'grid';
                if (sessionNameField) sessionNameField.style.display = 'block';

                // Get values from sessionIndex 0 fields
                schedules[hallId][day] = {
                    open: true,
                    doors: document.getElementById(`hall-${hallId}-${day}-0-doors`)?.value || '17:00',
                    early: document.getElementById(`hall-${hallId}-${day}-0-early`)?.value || '18:00',
                    regular: document.getElementById(`hall-${hallId}-${day}-0-regular`)?.value || '18:30',
                    closing: document.getElementById(`hall-${hallId}-${day}-0-closing`)?.value || '21:00',
                    sessionName: document.getElementById(`hall-${hallId}-${day}-sessionName`)?.value || ''
                };

                // Update border color to green
                if (timesDiv) {
                    const borderDiv = timesDiv.closest('[style*="border:"]');
                    if (borderDiv) borderDiv.style.borderColor = 'var(--success)';
                }

                // Update status text
                const statusText = toggle.closest('div').querySelector('span');
                if (statusText) {
                    statusText.textContent = 'Open';
                    statusText.style.color = 'var(--success)';
                }
            } else {
                // Hide time fields and session name field, save as closed
                if (timesDiv) timesDiv.style.display = 'none';
                if (sessionNameField) sessionNameField.style.display = 'none';
                schedules[hallId][day] = { open: false };

                // Update border color to gray
                if (timesDiv) {
                    const borderDiv = timesDiv.closest('[style*="border:"]');
                    if (borderDiv) borderDiv.style.borderColor = 'var(--gray-light)';
                }

                // Update status text
                const statusText = toggle.closest('div').querySelector('span');
                if (statusText) {
                    statusText.textContent = 'Closed';
                    statusText.style.color = 'var(--gray)';
                }
            }

            NewcoData.set('schedules', schedules);
            showAutoSave();
        }
        
        function updateScheduleTime(hallId, day, field, value, sessionIndex = 0) {
            const schedules = NewcoData.get('schedules') || {};

            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }

            if (!schedules[hallId][day]) {
                schedules[hallId][day] = { open: true };
            }

            // Handle array of sessions
            if (Array.isArray(schedules[hallId][day])) {
                if (schedules[hallId][day][sessionIndex]) {
                    schedules[hallId][day][sessionIndex][field] = value;
                }
            } else {
                // Single session object
                schedules[hallId][day][field] = value;
            }

            NewcoData.set('schedules', schedules);
        }
        
        function updateSchedule(hallId, day) {
            const schedules = NewcoData.get('schedules') || {};
            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }
            
            const isOpen = document.getElementById(`schedule-${hallId}-${day}`).checked;
            
            if (isOpen) {
                schedules[hallId][day] = {
                    open: true,
                    doors: document.getElementById(`doors-${hallId}-${day}`).value,
                    earlyBird: document.getElementById(`early-${hallId}-${day}`).value, 
                    regular: document.getElementById(`regular-${hallId}-${day}`).value,
                    closing: document.getElementById(`closing-${hallId}-${day}`).value
                };
            } else {
                schedules[hallId][day] = { open: false };
            }
            
            NewcoData.set('schedules', schedules);
            markUnsaved();
        }
        
        function saveSchedule(hallId) {
            // Data is already saved via updateScheduleTime() and toggleDaySchedule()
            // This function just confirms the save to the user
            showSuccess('Schedule saved successfully');
        }

        function addSessionForDay(hallId, day) {
            showModal({
                title: `Add Additional Session for ${day.charAt(0).toUpperCase() + day.slice(1)}`,
                message: `
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Session Suffix:</label>
                        <select id="sessionSuffix" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px;">
                            <option value="early">Early</option>
                            <option value="matinee">Matinee</option>
                            <option value="late">Late</option>
                        </select>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                            This will create "${day.charAt(0).toUpperCase() + day.slice(1)} - Early" as a separate session
                        </p>
                    </div>
                `,
                confirmText: 'Create Session',
                onConfirm: () => {
                    const suffix = document.getElementById('sessionSuffix').value;
                    createAdditionalSession(hallId, day, suffix);
                }
            });
        }

        function createAdditionalSession(hallId, day, suffix) {
            const schedules = NewcoData.get('schedules') || {};

            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }

            // Convert single session to array if needed
            if (schedules[hallId][day] && !Array.isArray(schedules[hallId][day])) {
                const originalSession = schedules[hallId][day];
                schedules[hallId][day] = [originalSession];
            }

            // Create array if it doesn't exist
            if (!schedules[hallId][day]) {
                schedules[hallId][day] = [];
            }

            // Add new session with suffix
            const newSession = {
                open: true,
                suffix: suffix,
                sessionName: `${day.charAt(0).toUpperCase() + day.slice(1)} - ${suffix.charAt(0).toUpperCase() + suffix.slice(1)}`,
                doors: '17:00',
                early: '18:00',
                regular: '18:30',
                closing: '21:00'
            };

            schedules[hallId][day].push(newSession);

            // Sort sessions by suffix priority: Early, Matinee, Normal (no suffix), Late
            const suffixOrder = { 'early': 1, 'matinee': 2, '': 3, 'late': 4 };
            schedules[hallId][day].sort((a, b) => {
                const orderA = suffixOrder[a.suffix || ''] || 3;
                const orderB = suffixOrder[b.suffix || ''] || 3;
                return orderA - orderB;
            });

            NewcoData.set('schedules', schedules);

            showSuccess(`Created "${newSession.sessionName}" session`);

            // Reload schedule display
            loadSchedule();
        }

        // Theme Functions
        function loadThemes() {
            const org = NewcoData.get("organization");
            if (org?.colors) {
                document.getElementById('themePrimary').value = org.colors.primary || '#2ea3f2';
                document.getElementById('themeSecondary').value = org.colors.secondary || '#9c27b0';
                document.getElementById('themeAccent').value = org.colors.accent || '#4CAF50';
            }
        }

        function applyTheme(themeName) {
            const themes = {
                classic: {
                    primary: '#667eea',
                    secondary: '#764ba2',
                    accent: '#FFD700'
                },
                modern: {
                    primary: '#2ea3f2',
                    secondary: '#1a5f8a',
                    accent: '#4CAF50'
                },
                fun: {
                    primary: '#f093fb',
                    secondary: '#f5576c',
                    accent: '#4facfe'
                },
                elegant: {
                    primary: '#434343',
                    secondary: '#000000',
                    accent: '#FFD700'
                }
            };
            
            const theme = themes[themeName];
            if (theme) {
                document.getElementById('themePrimary').value = theme.primary;
                document.getElementById('themeSecondary').value = theme.secondary;
                document.getElementById('themeAccent').value = theme.accent;
                
                // Apply to current page
                document.documentElement.style.setProperty('--primary', theme.primary);
                document.documentElement.style.setProperty('--secondary', theme.secondary);
                
                markUnsaved();
            }
        }

        function saveTheme() {
            const org = NewcoData.get("organization") || {};
            org.colors = {
                primary: document.getElementById('themePrimary').value,
                secondary: document.getElementById('themeSecondary').value,
                accent: document.getElementById('themeAccent').value
            };
            org.fonts = {
                heading: document.getElementById('headingFont')?.value || 'Inter',
                body: document.getElementById('bodyFont')?.value || 'Inter'
            };
            
            NewcoData.updateOrganization(org);
            showAutoSave();
        }

        // Members Management Functions
        let membersData = [];
        let filteredMembers = [];
        let currentMemberPage = 1;
        const membersPerPage = 10;
        let currentSortField = 'name';
        let currentSortDirection = 'asc';
        
        async function loadMembers() {
            // Refresh cache from Supabase first
            const custData = await NewcoData.read_cust();
            if (custData.members) {
                NewcoData.cache.members = custData.members;
            }
            if (custData.transactions) {
                NewcoData.cache.transactions = custData.transactions;
            }

            // Load actual members data (don't generate samples)
            membersData = NewcoData.get('members') || [];
            filteredMembers = [...membersData];

            // Update stats
            updateMemberStats();

            // Display members
            displayMembers();
        }
        
        function generateSampleMembers() {
            const firstNames = ['John', 'Jane', 'Michael', 'Sarah', 'Robert', 'Emily', 'David', 'Lisa', 'James', 'Mary'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Martinez', 'Anderson'];
            const members = [];
            
            for (let i = 0; i < 50; i++) {
                const created = new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000);
                const lastLogin = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                const lifetimeSpend = Math.floor(Math.random() * 5000);
                const monthlySpend = Math.floor(Math.random() * 500);
                
                members.push({
                    id: Date.now() + i,
                    name: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                    email: `member${i + 1}@example.com`,
                    phone: `555-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
                    loyaltyPoints: Math.floor(Math.random() * 10000),
                    lifetimeLoyalty: Math.floor(Math.random() * 50000),
                    logins: Math.floor(Math.random() * 100) + 1,
                    dateCreated: created.toISOString(),
                    lastLogin: lastLogin.toISOString(),
                    lifetimeSpend: lifetimeSpend,
                    averageSpend: lifetimeSpend > 0 ? Math.floor(lifetimeSpend / (Math.floor(Math.random() * 20) + 1)) : 0,
                    monthlySpend: monthlySpend
                });
            }
            
            NewcoData.set('members', members);
            return members;
        }

        // Calculate member's total lifetime spending from all transactions
        function calculateLifetimeSpend(member) {
            const transactions = NewcoData.get('transactions') || [];
            const memberName = (member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim()).toLowerCase();
            const memberId = member.id || member.memberId || member.userId;

            const memberTransactions = transactions.filter(t => {
                const txName = (t.memberName || '').toLowerCase();
                const matchesName = txName === memberName;
                const matchesId = memberId && (t.memberId === memberId);
                return matchesName || matchesId;
            });

            return memberTransactions.reduce((sum, t) => sum + (parseFloat(t.finalTotal) || 0), 0);
        }

        // Calculate member's spending from last 30 days of transactions
        function calculateMonthlySpend(member) {
            const transactions = NewcoData.get('transactions') || [];
            const now = new Date();
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Get member name for matching - case insensitive
            const memberName = (member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim()).toLowerCase();
            const memberId = member.id || member.memberId || member.userId;

            console.log(`Calculating monthly spend for: "${memberName}" (ID: ${memberId})`);
            console.log(`Total transactions available: ${transactions.length}`);

            // Debug: show first transaction structure
            if (transactions.length > 0) {
                console.log('Transaction field names:', Object.keys(transactions[0]));
                console.log('Full transaction data:', JSON.stringify(transactions[0], null, 2));
            }

            const memberTransactions = transactions.filter(t => {
                // Match by name (primary) or ID fields (fallback) - case insensitive
                const txName = (t.memberName || '').toLowerCase();
                const matchesName = txName === memberName;
                const matchesId = memberId && (t.memberId === memberId);

                if (!matchesName && !matchesId) return false;

                const txDate = new Date(t.date || t.timestamp);
                const isInRange = txDate >= monthAgo && txDate <= now;

                if (matchesName || matchesId) {
                    console.log(`  Found transaction: ${t.memberName}, $${t.finalTotal}, date: ${txDate}, in range: ${isInRange}`);
                }

                return isInRange;
            });

            const total = memberTransactions.reduce((sum, t) => sum + (parseFloat(t.finalTotal) || 0), 0);

            console.log(`  Total monthly spend: $${total} from ${memberTransactions.length} transactions`);

            return total;
        }

        function updateMemberStats() {
            const totalMembers = filteredMembers.length;
            const now = new Date();
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Calculate monthly spend for each member from transactions
            filteredMembers.forEach(member => {
                member.monthlySpend = calculateMonthlySpend(member);
            });

            const activeThisMonth = filteredMembers.filter(m => new Date(m.lastLogin) > monthAgo).length;
            const avgPoints = Math.floor(filteredMembers.reduce((sum, m) => sum + m.loyaltyPoints, 0) / (totalMembers || 1));
            const avgMonthly = Math.floor(filteredMembers.reduce((sum, m) => sum + (m.monthlySpend || 0), 0) / (totalMembers || 1));

            document.getElementById('totalMembersCount').textContent = totalMembers.toLocaleString();
            document.getElementById('activeMonthCount').textContent = activeThisMonth.toLocaleString();
            document.getElementById('avgPointsCount').textContent = avgPoints.toLocaleString();
            document.getElementById('avgMonthlySpend').textContent = `$${avgMonthly.toLocaleString()}`;
        }
        
        function displayMembers() {
            const tbody = document.getElementById('membersTableBody');
            const start = (currentMemberPage - 1) * membersPerPage;
            const end = start + membersPerPage;
            const pageMembers = filteredMembers.slice(start, end);
            
            if (pageMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: var(--gray);">No members found matching your criteria</td></tr>';
                return;
            }
            
            tbody.innerHTML = pageMembers.map(member => {
                // Handle both old sample format and new registration format
                const name = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim();
                const created = new Date(member.dateCreated || member.joinDate);
                const lastLogin = new Date(member.lastLogin || member.lastVisit || member.joinDate);
                const loyaltyPoints = member.loyaltyPoints || 0;
                const lifetimeLoyalty = member.lifetimeLoyalty || loyaltyPoints;
                const logins = member.logins || member.visits || 1;
                // Calculate lifetime spend from actual transactions
                const lifetimeSpend = calculateLifetimeSpend(member);
                const averageSpend = lifetimeSpend > 0 ? Math.floor(lifetimeSpend / logins) : 0;
                // Calculate monthly spend from transactions if not already calculated
                const monthlySpend = member.monthlySpend !== undefined ? member.monthlySpend : calculateMonthlySpend(member);
                
                return `
                    <tr style="border-bottom: 1px solid var(--gray-lighter); transition: background 0.2s;" onmouseover="this.style.background='var(--gray-lighter)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600;">${name}</div>
                            <div style="font-size: 0.875rem; color: var(--gray);">${member.email}</div>
                            ${member.memberId ? `<div style="font-size: 0.75rem; color: var(--gray);">ID: ${member.memberId}</div>` : ''}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <span style="font-weight: 600; color: var(--warning);">${loyaltyPoints.toLocaleString()}</span>
                        </td>
                        <td style="padding: 1rem; text-align: center;">${lifetimeLoyalty.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center;">${logins}</td>
                        <td style="padding: 1rem; text-align: center;">$${lifetimeSpend.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center;">$${averageSpend.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center;">$${monthlySpend.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center; font-size: 0.875rem;">${created.toLocaleDateString()}</td>
                        <td style="padding: 1rem; text-align: center; font-size: 0.875rem;">${lastLogin.toLocaleDateString()}</td>
                        <td style="padding: 1rem; text-align: center;">
                            <button class="btn btn-sm btn-secondary" onclick="viewMemberDetails('${member.id}')">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination
            updateMembersPagination();
            
            // Update showing text
            document.getElementById('membersShowing').textContent = pageMembers.length;
            document.getElementById('membersTotal').textContent = filteredMembers.length;
        }
        
        function updateMembersPagination() {
            const totalPages = Math.ceil(filteredMembers.length / membersPerPage);
            const paginationDiv = document.getElementById('membersPagination');
            
            // Use the generic pagination helper
            paginationDiv.innerHTML = generatePagination(currentMemberPage, totalPages, 'changeMemberPage');
        }
        
        function changeMemberPage(page) {
            const totalPages = Math.ceil(filteredMembers.length / membersPerPage);
            if (page >= 1 && page <= totalPages) {
                currentMemberPage = page;
                displayMembers();
            }
        }
        
        function filterMembers() {
            const searchName = document.getElementById('memberSearchName').value.toLowerCase();
            const minPoints = parseInt(document.getElementById('memberMinPoints').value) || 0;
            const minSpend = parseInt(document.getElementById('memberMinSpend').value) || 0;
            const dateRange = document.getElementById('memberDateRange').value;
            const activity = document.getElementById('memberActivity').value;
            
            filteredMembers = membersData.filter(member => {
                // Name filter - handle both formats
                const memberName = (member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim()).toLowerCase();
                if (searchName && !memberName.includes(searchName)) return false;
                
                // Points filter
                const points = member.loyaltyPoints || 0;
                if (points < minPoints) return false;
                
                // Spend filter
                const spend = member.lifetimeSpend || member.totalSpent || 0;
                if (spend < minSpend) return false;
                
                // Date range filter
                const created = new Date(member.dateCreated || member.joinDate);
                const now = new Date();
                if (dateRange === 'today' && created.toDateString() !== now.toDateString()) return false;
                if (dateRange === 'week' && created < new Date(now - 7 * 24 * 60 * 60 * 1000)) return false;
                if (dateRange === 'month' && created < new Date(now - 30 * 24 * 60 * 60 * 1000)) return false;
                if (dateRange === 'year' && created < new Date(now - 365 * 24 * 60 * 60 * 1000)) return false;
                
                // Activity filter
                const lastLogin = new Date(member.lastLogin || member.lastVisit || member.joinDate);
                if (activity === 'active' && lastLogin < new Date(now - 30 * 24 * 60 * 60 * 1000)) return false;
                if (activity === 'inactive' && lastLogin >= new Date(now - 30 * 24 * 60 * 60 * 1000)) return false;
                if (activity === 'new' && created < new Date(now - 7 * 24 * 60 * 60 * 1000)) return false;
                
                return true;
            });
            
            // Apply sorting
            const sortBy = document.getElementById('memberSortBy').value;
            sortMembers(sortBy);
        }
        
        function sortMembers(field) {
            if (field === currentSortField) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // Update all sort arrows to neutral
            const arrows = ['Name', 'Points', 'Lifetime', 'Logins', 'Spend', 'Average', 'Monthly', 'Created', 'LastLogin'];
            arrows.forEach(arrow => {
                const elem = document.getElementById('sortArrow' + arrow);
                if (elem) {
                    elem.textContent = '↕️';
                }
            });
            
            // Update current field's arrow
            const fieldMap = {
                'name': 'Name',
                'points': 'Points',
                'lifetime': 'Lifetime',
                'logins': 'Logins',
                'spend': 'Spend',
                'average': 'Average',
                'monthly': 'Monthly',
                'created': 'Created',
                'lastLogin': 'LastLogin'
            };
            
            const arrowId = 'sortArrow' + fieldMap[field];
            const arrowElem = document.getElementById(arrowId);
            if (arrowElem) {
                arrowElem.textContent = currentSortDirection === 'asc' ? '↑' : '↓';
            }
            
            filteredMembers.sort((a, b) => {
                let aVal, bVal;
                
                switch(field) {
                    case 'name': 
                        aVal = a.name || `${a.firstName || ''} ${a.lastName || ''}`.trim();
                        bVal = b.name || `${b.firstName || ''} ${b.lastName || ''}`.trim();
                        break;
                    case 'points': 
                        aVal = a.loyaltyPoints || 0;
                        bVal = b.loyaltyPoints || 0;
                        break;
                    case 'lifetime': 
                        aVal = a.lifetimeLoyalty || a.loyaltyPoints || 0;
                        bVal = b.lifetimeLoyalty || b.loyaltyPoints || 0;
                        break;
                    case 'logins': 
                        aVal = a.logins || a.visits || 0;
                        bVal = b.logins || b.visits || 0;
                        break;
                    case 'spend': 
                        aVal = a.lifetimeSpend || a.totalSpent || 0;
                        bVal = b.lifetimeSpend || b.totalSpent || 0;
                        break;
                    case 'average': 
                        aVal = a.averageSpend || 0;
                        bVal = b.averageSpend || 0;
                        break;
                    case 'monthly': 
                        aVal = a.monthlySpend || 0;
                        bVal = b.monthlySpend || 0;
                        break;
                    case 'created': 
                        aVal = new Date(a.dateCreated || a.joinDate);
                        bVal = new Date(b.dateCreated || b.joinDate);
                        break;
                    case 'lastLogin': 
                        aVal = new Date(a.lastLogin || a.lastVisit || a.joinDate);
                        bVal = new Date(b.lastLogin || b.lastVisit || b.joinDate);
                        break;
                    default: 
                        aVal = a.name || `${a.firstName || ''} ${a.lastName || ''}`.trim();
                        bVal = b.name || `${b.firstName || ''} ${b.lastName || ''}`.trim();
                }
                
                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            currentMemberPage = 1;
            updateMemberStats();
            displayMembers();
        }
        
        function resetMemberFilters() {
            document.getElementById('memberSearchName').value = '';
            document.getElementById('memberMinPoints').value = '';
            document.getElementById('memberMinSpend').value = '';
            document.getElementById('memberDateRange').value = 'all';
            document.getElementById('memberActivity').value = 'all';
            document.getElementById('memberSortBy').value = 'name';
            
            filteredMembers = [...membersData];
            currentMemberPage = 1;
            updateMemberStats();
            displayMembers();
        }
        
        function viewMemberDetails(memberId) {
            showModal({
                title: 'Member Details',
                message: 'Detailed member view is not enabled yet. This will show complete member history, transactions, rewards earned/redeemed, and allow editing member information.',
                type: 'info'
            });
        }
        
        function exportMembers() {
            // Use the generic CSV export helper
            const columns = [
                { key: 'name', label: 'Name' },
                { key: 'email', label: 'Email' },
                { key: 'phone', label: 'Phone' },
                { key: 'loyaltyPoints', label: 'Loyalty Points' },
                { key: 'lifetimeLoyalty', label: 'Lifetime Loyalty' },
                { key: 'logins', label: 'Logins' },
                { key: 'lifetimeSpend', label: 'Lifetime Spend' },
                { key: 'averageSpend', label: 'Average Spend' },
                { key: 'monthlySpend', label: 'Monthly Spend' },
                { key: 'dateCreated', label: 'Date Created' },
                { key: 'lastLogin', label: 'Last Login' }
            ];
            
            exportToCSV(filteredMembers, columns, `members_${new Date().toISOString().split('T')[0]}.csv`);
            showSuccess('Members data exported successfully');
        }
        
        function addMember() {
            showModal({
                title: 'Add Member',
                message: 'Member addition form will be implemented here. This will allow adding new members with all their information.',
                type: 'info'
            });
        }
        
        function toggleTopPerformers() {
            const section = document.getElementById('topPerformersSection');
            const btn = document.getElementById('topPerformersBtn');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.innerHTML = '🏆 Hide Top Performers';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
                loadTopPerformers();
            } else {
                section.style.display = 'none';
                btn.innerHTML = '🏆 Top Performers';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
        }
        
        // Rewards Program Functions
        function loadRewards() {
            // Load loyalty program enabled state
            const rewards = NewcoData.get('rewards') || {};
            const wizardData = NewcoData.get('wizardData') || {};
            const isEnabled = rewards.enabled !== undefined ? rewards.enabled : (wizardData.rewards?.enabled !== undefined ? wizardData.rewards.enabled : true);

            document.getElementById('enableLoyaltyProgram').checked = isEnabled;
            document.getElementById('loyaltyProgramContent').style.display = isEnabled ? 'block' : 'none';

            loadRewardsMetrics();
            loadRewardsConfiguration();
            loadRewardsTransactions();
        }

        function toggleLoyaltyProgram() {
            const isEnabled = document.getElementById('enableLoyaltyProgram').checked;
            const rewards = NewcoData.get('rewards') || {};

            rewards.enabled = isEnabled;
            NewcoData.set('rewards', rewards);

            // Show/hide loyalty program content
            document.getElementById('loyaltyProgramContent').style.display = isEnabled ? 'block' : 'none';

            showAutoSave();
        }

        function loadRewardsMetrics() {
            const period = document.getElementById('rewardsMonth')?.value || 'current';
            
            // Generate sample metrics
            const baseEarned = 15000 + Math.floor(Math.random() * 10000);
            const baseRedeemed = 8000 + Math.floor(Math.random() * 5000);
            const baseActive = 120 + Math.floor(Math.random() * 50);
            
            // Adjust based on period
            let multiplier = 1;
            if (period === '3months') multiplier = 3;
            if (period === '6months') multiplier = 6;
            if (period === 'year') multiplier = 12;
            
            document.getElementById('monthlyPointsEarned').textContent = (baseEarned * multiplier).toLocaleString();
            document.getElementById('monthlyPointsRedeemed').textContent = (baseRedeemed * multiplier).toLocaleString();
            document.getElementById('activeLoyaltyUsers').textContent = Math.floor(baseActive * (1 + multiplier * 0.1)).toLocaleString();
        }
        
        function loadTopPerformers() {
            const members = NewcoData.get('members') || [];
            
            // Sort for top earners
            const topEarners = [...members].sort((a, b) => b.loyaltyPoints - a.loyaltyPoints).slice(0, 5);
            document.getElementById('topEarners').innerHTML = topEarners.map((m, i) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--gray-lighter);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][i]}</span>
                        <span>${m.name}</span>
                    </div>
                    <span style="font-weight: 600; color: var(--success);">${m.loyaltyPoints.toLocaleString()} pts</span>
                </div>
            `).join('');
            
            // Sort for top redeemers (using lifetime loyalty as proxy)
            const topRedeemers = [...members].sort((a, b) => b.lifetimeLoyalty - a.loyaltyPoints).slice(0, 5);
            document.getElementById('topRedeemers').innerHTML = topRedeemers.map((m, i) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--gray-lighter);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][i]}</span>
                        <span>${m.name}</span>
                    </div>
                    <span style="font-weight: 600; color: var(--warning);">${Math.floor(m.lifetimeLoyalty * 0.3).toLocaleString()} pts</span>
                </div>
            `).join('');
            
            // Sort for most active
            const mostActive = [...members].sort((a, b) => b.logins - a.logins).slice(0, 5);
            document.getElementById('mostActive').innerHTML = mostActive.map((m, i) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--gray-lighter);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][i]}</span>
                        <span>${m.name}</span>
                    </div>
                    <span style="font-weight: 600; color: var(--primary);">${m.logins} visits</span>
                </div>
            `).join('');
        }
        
        function loadRewardsConfiguration() {
            const config = NewcoData.get('rewardsConfig') || {
                rewardType: 'lifetime',
                basicSettings: {
                    pointsPerDollar: 10,
                    webPointsPerDollar: 10,
                    floorPointsPerDollar: 10,
                    birthdayBonusPoints: 500,
                    signupBonusPoints: 100,
                    pointsExpiration: 'never',
                    minPointsRedeem: 100
                }
            };
            
            console.log('Loading rewards configuration:', config);
            
            // If no config exists in localStorage, save the defaults
            const existingConfig = NewcoData.get('rewardsConfig');
            if (!existingConfig || !existingConfig.rewardType) {
                console.log('No rewards config found, saving defaults:', config);
                NewcoData.set('rewardsConfig', config);
            }
            
            // Set reward type
            if (config.rewardType) {
                const rewardTypeRadio = document.querySelector(`input[name="rewardType"][value="${config.rewardType}"]`);
                if (rewardTypeRadio) {
                    rewardTypeRadio.checked = true;
                    applyRewardTypeChange(config.rewardType);
                }
            }
            
            // Load basic settings
            if (config.basicSettings) {
                const pointsPerDollarEl = document.getElementById('pointsPerDollar');
                const webPointsPerDollarEl = document.getElementById('webPointsPerDollar');
                const floorPointsPerDollarEl = document.getElementById('floorPointsPerDollar');
                const birthdayBonusEl = document.getElementById('birthdayBonusPoints');
                const signupBonusEl = document.getElementById('signupBonusPoints');
                const pointsExpirationEl = document.getElementById('pointsExpiration');
                const minPointsRedeemEl = document.getElementById('minPointsRedeem');
                const pointsCurrencyEl = document.getElementById('rewardsPointsCurrency');
                
                if (pointsPerDollarEl) pointsPerDollarEl.value = config.basicSettings.pointsPerDollar || 10;
                if (webPointsPerDollarEl) webPointsPerDollarEl.value = config.basicSettings.webPointsPerDollar || 10;
                if (floorPointsPerDollarEl) floorPointsPerDollarEl.value = config.basicSettings.floorPointsPerDollar || 10;
                if (birthdayBonusEl) birthdayBonusEl.value = config.basicSettings.birthdayBonusPoints || 500;
                if (signupBonusEl) signupBonusEl.value = config.basicSettings.signupBonusPoints || 100;
                if (pointsExpirationEl) pointsExpirationEl.value = config.basicSettings.pointsExpiration || 'never';
                if (minPointsRedeemEl) minPointsRedeemEl.value = config.basicSettings.minPointsRedeem || 100;
                if (pointsCurrencyEl) pointsCurrencyEl.value = config.basicSettings.pointsCurrencyName || 'Loyalty Points';
                
                // Load birthday requirement settings
                if (config.basicSettings.birthdayRequirement) {
                    const birthdayReqRadio = document.querySelector(`input[name="birthdayRequirement"][value="${config.basicSettings.birthdayRequirement}"]`);
                    if (birthdayReqRadio) birthdayReqRadio.checked = true;
                }
                
                const birthdayEmailCheckbox = document.getElementById('birthdayTriggerEmail');
                if (birthdayEmailCheckbox) {
                    birthdayEmailCheckbox.checked = config.basicSettings.birthdayTriggerEmail || false;
                }
                
                const emailDaysBeforeEl = document.getElementById('birthdayEmailDaysBefore');
                if (emailDaysBeforeEl) {
                    emailDaysBeforeEl.value = config.basicSettings.birthdayEmailDaysBefore || 7;
                }
            }
            
            // Load tier-specific settings based on type
            if (config.rewardType === 'lifetime' && config.lifetimeTiers) {
                // Load lifetime tier settings
                const tiers = config.lifetimeTiers;
                if (tiers.tier1) {
                    document.getElementById('tier1Name').value = tiers.tier1.name || 'Bronze';
                    document.getElementById('tier1Points').value = tiers.tier1.points || 0;
                    document.getElementById('tier1DiscountType').value = tiers.tier1.discountType || 'none';
                    document.getElementById('tier1Discount').value = tiers.tier1.discount || 0;
                    document.getElementById('tier1BonusType').value = tiers.tier1.bonusType || 'none';
                    document.getElementById('tier1Multiplier').value = tiers.tier1.multiplier || 1;
                }
                // Similar for tier2 and tier3...
            }
        }
        
        function loadPointsConfiguration() {
            // Redirect to new function
            loadRewardsConfiguration();
        }
        
        function updateRewardType(type) {
            // Just update the UI - no warnings until save
            applyRewardTypeChange(type);
        }
        
        function toggleBirthdayBonus() {
            const enabled = document.getElementById('birthdayBonusEnabled').checked;
            const config = document.getElementById('birthdayBonusConfig');
            config.style.display = enabled ? 'block' : 'none';
            if (enabled) {
                toggleEmailDaysBefore();
            }
        }
        
        function toggleEmailDaysBefore() {
            const triggerEmail = document.getElementById('birthdayTriggerEmail');
            const daysContainer = document.getElementById('emailDaysBeforeContainer');
            if (triggerEmail && daysContainer) {
                daysContainer.style.display = triggerEmail.checked ? 'flex' : 'none';
            }
        }
        
        function toggleSignupBonus() {
            const enabled = document.getElementById('signupBonusEnabled').checked;
            const config = document.getElementById('signupBonusConfig');
            config.style.display = enabled ? 'block' : 'none';
        }
        
        function getRewardTypeName(type) {
            const names = {
                'lifetime': '🏆 Lifetime Tiers (Permanent status levels)',
                'temporary': '⏰ Temporary Tiers (Time-limited purchased status)',
                'bonuses': '🎁 Bonuses Only (Simple points system)'
            };
            return names[type] || type;
        }
        
        function applyRewardTypeChange(type) {
            // Hide all config sections
            document.getElementById('lifetimeTiersConfig').style.display = 'none';
            document.getElementById('temporaryTiersConfig').style.display = 'none';
            document.getElementById('bonusesOnlyConfig').style.display = 'none';
            
            // Show selected config
            if (type === 'lifetime') {
                document.getElementById('lifetimeTiersConfig').style.display = 'block';
            } else if (type === 'temporary') {
                document.getElementById('temporaryTiersConfig').style.display = 'block';
            } else if (type === 'bonuses') {
                document.getElementById('bonusesOnlyConfig').style.display = 'block';
            }
        }
        
        function saveRewardsConfig() {
            const rewardType = document.querySelector('input[name="rewardType"]:checked').value;
            
            // Check if system has been live for 30 days
            const systemConfig = NewcoData.get('systemConfig') || {};
            const goLiveDate = systemConfig.goLiveDate;
            
            if (goLiveDate) {
                const daysSinceLive = Math.floor((Date.now() - new Date(goLiveDate).getTime()) / (1000 * 60 * 60 * 24));
                if (daysSinceLive >= 30) {
                    // Check if trying to change type
                    const currentConfig = NewcoData.get('rewardsConfig') || { rewardType: 'lifetime' };
                    if (currentConfig.rewardType && currentConfig.rewardType !== rewardType) {
                        showModal({
                            title: '🔒 Reward Type Locked',
                            message: `<div style="font-size: 1.1rem; line-height: 1.6;">
                                <p style="margin-bottom: 1rem;"><strong>Your reward program type has been locked.</strong></p>
                                <p style="margin-bottom: 1rem;">Once your system has been live for 30 days, the fundamental reward program type cannot be changed to maintain consistency for your members.</p>
                                <p style="margin-bottom: 0.5rem;">Your system went live: <strong>${new Date(goLiveDate).toLocaleDateString()}</strong></p>
                                <p>Days since live: <strong>${daysSinceLive} days</strong></p>
                            </div>`,
                            type: 'error'
                        });
                        
                        // Reset to current saved type
                        document.querySelector(`input[name="rewardType"][value="${currentConfig.rewardType}"]`).checked = true;
                        applyRewardTypeChange(currentConfig.rewardType);
                        return;
                    }
                }
            }
            
            // Get current saved reward type
            const currentConfig = NewcoData.get('rewardsConfig') || {};
            
            // If changing from the saved type, show warning
            if (currentConfig.rewardType && currentConfig.rewardType !== rewardType) {
                showModal({
                    type: 'confirm',
                    title: '⚠️ Change Reward Type',
                    message: `<div style="font-size: 1.05rem; line-height: 1.6;">
                        <p style="margin-bottom: 1rem;"><strong style="color: var(--danger);">WARNING: You are about to change the fundamental TYPE of reward program!</strong></p>
                        <p style="margin-bottom: 1rem;">This is a very important choice that affects how your entire loyalty system works:</p>
                        <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                            <li style="margin-bottom: 0.5rem;"><strong>Current:</strong> ${getRewardTypeName(currentConfig.rewardType)}</li>
                            <li style="margin-bottom: 0.5rem;"><strong>New:</strong> ${getRewardTypeName(rewardType)}</li>
                        </ul>
                        <p>Are you absolutely sure you want to make this change?</p>
                    </div>`,
                    confirmText: 'Yes, Change Type',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                        // User confirmed - proceed with save
                        performRewardsSave(rewardType);
                    },
                    onCancel: () => {
                        // User cancelled - revert selection
                        document.querySelector(`input[name="rewardType"][value="${currentConfig.rewardType}"]`).checked = true;
                        applyRewardTypeChange(currentConfig.rewardType);
                    }
                });
            } else {
                // No change or first time setting - just save
                performRewardsSave(rewardType);
            }
        }
        
        function performRewardsSave(rewardType) {
            const config = {
                rewardType: rewardType,
                basicSettings: {
                    webPointsPerDollar: parseInt(document.getElementById('webPointsPerDollar')?.value) || 10,
                    floorPointsPerDollar: parseInt(document.getElementById('floorPointsPerDollar')?.value) || 10,
                    pointsPerDollar: parseInt(document.getElementById('pointsPerDollar')?.value) || 10, // Legacy fallback
                    birthdayBonusPoints: parseInt(document.getElementById('birthdayBonusPoints')?.value) || 0,
                    signupBonusPoints: parseInt(document.getElementById('signupBonusPoints')?.value) || 0,
                    pointsExpiration: document.getElementById('pointsExpiration')?.value || 'never',
                    minPointsRedeem: parseInt(document.getElementById('minPointsRedeem')?.value) || 100,
                    pointsCurrencyName: document.getElementById('rewardsPointsCurrency')?.value || 'Loyalty Points',
                    // Birthday reward settings
                    birthdayRequirement: document.querySelector('input[name="birthdayRequirement"]:checked')?.value || 'automatic',
                    birthdayTriggerEmail: document.getElementById('birthdayTriggerEmail')?.checked || false,
                    birthdayEmailDaysBefore: parseInt(document.getElementById('birthdayEmailDaysBefore')?.value) || 7
                }
            };
            
            if (rewardType === 'lifetime') {
                config.lifetimeTiers = {
                    tier1: {
                        name: document.getElementById('tier1Name').value,
                        points: parseInt(document.getElementById('tier1Points').value),
                        discountType: document.getElementById('tier1DiscountType').value,
                        discount: parseInt(document.getElementById('tier1Discount').value),
                        bonusType: document.getElementById('tier1BonusType').value,
                        multiplier: parseFloat(document.getElementById('tier1Multiplier').value)
                    },
                    tier2: {
                        name: document.getElementById('tier2Name').value,
                        points: parseInt(document.getElementById('tier2Points').value),
                        discountType: document.getElementById('tier2DiscountType').value,
                        discount: parseInt(document.getElementById('tier2Discount').value),
                        bonusType: document.getElementById('tier2BonusType').value,
                        multiplier: parseFloat(document.getElementById('tier2Multiplier').value)
                    },
                    tier3: {
                        name: document.getElementById('tier3Name').value,
                        points: parseInt(document.getElementById('tier3Points').value),
                        discountType: document.getElementById('tier3DiscountType').value,
                        discount: parseInt(document.getElementById('tier3Discount').value),
                        bonusType: document.getElementById('tier3BonusType').value,
                        multiplier: parseFloat(document.getElementById('tier3Multiplier').value)
                    }
                };
            } else if (rewardType === 'temporary') {
                config.temporaryTiers = {
                    tier1: {
                        name: document.getElementById('tempTier1Name').value,
                        cost: parseFloat(document.getElementById('tempTier1Cost').value),
                        duration: parseInt(document.getElementById('tempTier1Duration').value),
                        discountType: document.getElementById('tempTier1DiscountType').value,
                        discount: parseInt(document.getElementById('tempTier1Discount').value),
                        bonusType: document.getElementById('tempTier1BonusType').value,
                        multiplier: parseFloat(document.getElementById('tempTier1Multiplier').value)
                    },
                    tier2: {
                        name: document.getElementById('tempTier2Name').value,
                        cost: parseFloat(document.getElementById('tempTier2Cost').value),
                        duration: parseInt(document.getElementById('tempTier2Duration').value),
                        discountType: document.getElementById('tempTier2DiscountType').value,
                        discount: parseInt(document.getElementById('tempTier2Discount').value),
                        bonusType: document.getElementById('tempTier2BonusType').value,
                        multiplier: parseFloat(document.getElementById('tempTier2Multiplier').value)
                    }
                };
            } else if (rewardType === 'bonuses') {
                config.bonusesOnly = {
                    referralBonus: parseInt(document.getElementById('referralBonus').value),
                    reviewBonus: parseInt(document.getElementById('reviewBonus').value),
                    socialBonus: parseInt(document.getElementById('socialBonus').value)
                };
            }
            
            console.log('Saving rewards config:', config);
            NewcoData.set('rewardsConfig', config);
            
            // Verify it was saved
            const savedConfig = NewcoData.get('rewardsConfig');
            console.log('Saved rewards config verified:', savedConfig);
            
            showSuccess('Rewards configuration saved successfully');
        }
        
        function savePointsConfig() {
            // Redirect to new function
            saveRewardsConfig();
        }
        
        function toggleTempTierPayment(tierNumber) {
            const cashCheckbox = document.getElementById(`tempTier${tierNumber}PayCash`);
            const pointsCheckbox = document.getElementById(`tempTier${tierNumber}PayPoints`);
            const cashCostDiv = document.getElementById(`tempTier${tierNumber}CashCost`);
            const pointsCostDiv = document.getElementById(`tempTier${tierNumber}PointsCost`);
            
            // Ensure at least one payment method is selected
            if (!cashCheckbox.checked && !pointsCheckbox.checked) {
                // If trying to uncheck both, keep the current one checked
                if (cashCostDiv.style.display !== 'none') {
                    cashCheckbox.checked = true;
                } else {
                    pointsCheckbox.checked = true;
                }
                showModal({
                    title: '⚠️ Payment Method Required',
                    message: 'At least one payment method must be available for each tier.',
                    type: 'warning'
                });
                return;
            }
            
            // Show/hide cost fields based on selected payment methods
            cashCostDiv.style.display = cashCheckbox.checked ? 'block' : 'none';
            pointsCostDiv.style.display = pointsCheckbox.checked ? 'block' : 'none';
            
            // Update labels if both are selected
            const cashLabel = cashCostDiv.querySelector('.form-label');
            const pointsLabel = pointsCostDiv.querySelector('.form-label');
            
            if (cashCheckbox.checked && pointsCheckbox.checked) {
                cashLabel.textContent = 'Cost ($) - Alternative 1';
                pointsLabel.textContent = 'Cost (Points) - Alternative 2';
            } else {
                cashLabel.textContent = 'Cost ($)';
                pointsLabel.textContent = 'Cost (Points)';
            }
        }

        // Create Examples Functions
        function createSalesItemExamples() {
            showConfirm(
                'This will add 5 example basic offerings to your system. Continue?',
                () => {
                    const examples = [
                        {
                            id: Date.now().toString(),
                            name: 'Double Action (2)',
                            description: 'Double Action game pack',
                            price: 5,
                            art: '🎫',
                            canBuyWithLoyalty: false,
                            givesBonus: false,
                            limitPerCustomer: 0,
                            order: 1,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        },
                        {
                            id: (Date.now() + 1).toString(),
                            name: '6-on Paper Regular Games',
                            description: 'Standard 6-on paper cards for all regular games',
                            price: 10,
                            art: '🎯',
                            canBuyWithLoyalty: true,
                            loyaltyPointsCost: 1000,
                            givesBonus: true,
                            bonusType: 'fixed',
                            bonusFixed: 100,
                            limitPerCustomer: 5,
                            order: 2,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        },
                        {
                            id: (Date.now() + 2).toString(),
                            name: 'Electronic Package',
                            description: '24 electronic cards for all regular and special games',
                            price: 25,
                            art: '📱',
                            canBuyWithLoyalty: true,
                            loyaltyPointsCost: 2500,
                            givesBonus: true,
                            bonusType: 'multiplier',
                            bonusMultiplier: 2,
                            limitPerCustomer: 2,
                            order: 3,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        },
                        {
                            id: (Date.now() + 3).toString(),
                            name: 'Dauber Set',
                            description: 'Set of 3 colorful bingo daubers',
                            price: 5,
                            art: '🖊️',
                            canBuyWithLoyalty: false,
                            givesBonus: false,
                            limitPerCustomer: 10,
                            order: 4,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        },
                        {
                            id: (Date.now() + 4).toString(),
                            name: 'Progressive Jackpot Entry',
                            description: 'Entry into the progressive jackpot game',
                            price: 2,
                            art: '💰',
                            canBuyWithLoyalty: true,
                            loyaltyPointsCost: 200,
                            givesBonus: true,
                            bonusType: 'fixed',
                            bonusFixed: 20,
                            limitPerCustomer: 3,
                            order: 5,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        }
                    ];
                    
                    // Get existing items or empty array
                    let existingItems = NewcoData.get('salesItems') || [];
                    
                    // Add each example
                    examples.forEach(item => {
                        existingItems.push(item);
                    });
                    
                    // Save all items
                    NewcoData.set('salesItems', existingItems);
                    
                    // Reload the display
                    loadSalesItems();
                    showSuccess('5 example offerings added successfully!');
                    
                    // Remove pulse animation from button
                    const btn = document.querySelector('.create-examples-btn.pulse');
                    if (btn) btn.classList.remove('pulse');
                },
                'Add Examples'
            );
        }
        
        function createPackageExamples() {
            showConfirm(
                'This will add 4 example packages to your system. Continue?',
                () => {
                    const examples = [
                        {
                            id: Date.now().toString(),
                            name: 'Early Bird Special',
                            description: 'Perfect for early arrivals - includes early bird games and regular session',
                            price: 15,
                            originalPrice: 20,
                            art: '🌅',
                            includedItems: [],
                            badges: ['popular'],
                            loyaltyPrice: 1500,
                            givesExtraPoints: true,
                            pointsMultiplier: 1.5,
                            order: 1,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        },
                        {
                            id: (Date.now() + 1).toString(),
                            name: 'Power Pack',
                            description: 'Our most popular package - everything you need for a great session',
                            price: 35,
                            originalPrice: 45,
                            art: '⚡',
                            includedItems: [],
                            badges: ['bestValue', 'popular'],
                            loyaltyPrice: 3500,
                            givesExtraPoints: true,
                            bonusPoints: 500,
                            order: 2,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        },
                        {
                            id: (Date.now() + 2).toString(),
                            name: 'VIP Experience',
                            description: 'Premium package with reserved seating and complimentary refreshments',
                            price: 75,
                            art: '👑',
                            includedItems: [],
                            badges: ['new'],
                            loyaltyPrice: 7500,
                            givesExtraPoints: true,
                            pointsMultiplier: 3,
                            order: 3,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        },
                        {
                            id: (Date.now() + 3).toString(),
                            name: 'Family Fun Pack',
                            description: 'Great value for groups - includes 4 player positions',
                            price: 60,
                            originalPrice: 80,
                            art: '👨‍👩‍👧‍👦',
                            includedItems: [],
                            badges: ['bestValue'],
                            loyaltyPrice: 6000,
                            givesExtraPoints: true,
                            bonusPoints: 300,
                            order: 4,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null,
                            specialEventsOnly: false
                        }
                    ];
                    
                    // Get existing packages or empty array
                    let existingPackages = NewcoData.get('packages') || [];
                    
                    // Add each example
                    examples.forEach(pkg => {
                        existingPackages.push(pkg);
                    });
                    
                    // Save all packages
                    NewcoData.set('packages', existingPackages);
                    
                    // Reload the display
                    loadPackages();
                    showSuccess('4 example packages added successfully!');
                },
                'Add Examples'
            );
        }
        
        function createLoyaltyExamples() {
            showConfirm(
                'This will add 4 example loyalty items to your system. Continue?',
                () => {
                    const examples = [
                        {
                            id: Date.now().toString(),
                            name: 'Free Session Pass',
                            description: 'Redeem for one free regular bingo session',
                            pointsCost: 5000,
                            cashValue: 50,
                            art: '🎫',
                            type: 'freeItem',
                            limitPerMember: 2,
                            expiresInDays: 30,
                            order: 1,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        },
                        {
                            id: (Date.now() + 1).toString(),
                            name: '25% Off Next Purchase',
                            description: 'Save 25% on your next package purchase',
                            pointsCost: 2000,
                            cashValue: 10,
                            art: '🏷️',
                            type: 'discount',
                            limitPerMember: 3,
                            expiresInDays: 14,
                            order: 2,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        },
                        {
                            id: (Date.now() + 2).toString(),
                            name: 'VIP Lounge Access',
                            description: 'Exclusive access to VIP lounge with complimentary refreshments',
                            pointsCost: 3000,
                            cashValue: 30,
                            art: '🥂',
                            type: 'experience',
                            limitPerMember: 1,
                            order: 3,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        },
                        {
                            id: (Date.now() + 3).toString(),
                            name: 'Branded Merchandise',
                            description: 'Choose from t-shirt, cap, or tote bag with our logo',
                            pointsCost: 1500,
                            cashValue: 20,
                            art: '👕',
                            type: 'merchandise',
                            order: 4,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        }
                    ];
                    
                    // Get existing loyalty items or empty array
                    let existingLoyalty = NewcoData.get('loyaltyItems') || [];
                    
                    // Add each example
                    examples.forEach(item => {
                        existingLoyalty.push(item);
                    });
                    
                    // Save all loyalty items
                    NewcoData.set('loyaltyItems', existingLoyalty);
                    
                    // Reload the display
                    loadLoyaltyItems();
                    showSuccess('4 example loyalty items added successfully!');
                },
                'Add Examples'
            );
        }

        // Initialize art storage from stored data
        function initializeArtStorage() {
            if (!window.artStorage) {
                window.artStorage = {};
            }
            
            // Restore art data from all stored items
            const salesItems = NewcoData.get('salesItems') || [];
            const packages = NewcoData.get('packages') || [];
            const loyaltyItems = NewcoData.get('loyaltyItems') || [];
            const organization = NewcoData.get('organization') || {};
            
            // For backward compatibility with items that still have direct art properties
            // (from before we switched to memory-only storage)
            salesItems.forEach(item => {
                if (item.bannerArt && !item.bannerArtId) {
                    const artId = 'legacy_sales_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.bannerArt;
                    item.bannerArtId = artId;
                }
                if (item.backgroundArt && !item.backgroundArtId) {
                    const artId = 'legacy_sales_bg_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.backgroundArt;
                    item.backgroundArtId = artId;
                }
                if (item.art && !item.bannerArtId && !item.backgroundArtId) {
                    const artId = 'legacy_sales_general_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.art;
                    item.bannerArtId = artId;
                }
            });
            
            // For backward compatibility with packages
            packages.forEach(pkg => {
                if (pkg.bannerArt && !pkg.bannerArtId) {
                    const artId = 'legacy_pkg_' + pkg.id + '_' + Date.now();
                    window.artStorage[artId] = pkg.bannerArt;
                    pkg.bannerArtId = artId;
                }
                if (pkg.backgroundArt && !pkg.backgroundArtId) {
                    const artId = 'legacy_pkg_bg_' + pkg.id + '_' + Date.now();
                    window.artStorage[artId] = pkg.backgroundArt;
                    pkg.backgroundArtId = artId;
                }
                if (pkg.art && !pkg.bannerArtId && !pkg.backgroundArtId) {
                    const artId = 'legacy_pkg_general_' + pkg.id + '_' + Date.now();
                    window.artStorage[artId] = pkg.art;
                    pkg.bannerArtId = artId;
                }
            });
            
            // For backward compatibility with loyalty items
            loyaltyItems.forEach(item => {
                if (item.bannerArt && !item.bannerArtId) {
                    const artId = 'legacy_loyalty_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.bannerArt;
                    item.bannerArtId = artId;
                }
                if (item.backgroundArt && !item.backgroundArtId) {
                    const artId = 'legacy_loyalty_bg_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.backgroundArt;
                    item.backgroundArtId = artId;
                }
                if (item.art && !item.bannerArtId && !item.backgroundArtId) {
                    const artId = 'legacy_loyalty_general_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.art;
                    item.bannerArtId = artId;
                }
            });
            
            // For backward compatibility with logo
            if (organization.logo && !organization.logoId) {
                const logoId = 'legacy_logo_' + Date.now();
                window.artStorage[logoId] = organization.logo;
                organization.logoId = logoId;
                // Update the organization in localStorage without the logo data
                const orgWithoutLogo = { ...organization };
                delete orgWithoutLogo.logo;
                NewcoData.set('organization', orgWithoutLogo);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize art storage first
            initializeArtStorage();
            
            // Apply saved branding colors
            applyBrandingColors();
            
            // Load and apply organization settings including logo
            const org = NewcoData.get('organization');
            const sidebarLogo = document.getElementById('sidebarLogo');
            if (sidebarLogo) {
                if (org?.logo) {
                    // Check if logo is a reference ID or actual data
                    let logoData = org.logo;
                    if (window.artStorage && org.logoId) {
                        logoData = window.artStorage[org.logoId] || org.logo;
                    }
                    sidebarLogo.innerHTML = `<img src="${logoData}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                } else {
                    sidebarLogo.innerHTML = '🎱';
                }
            }

            // Update sidebar org name
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName && org) {
                sidebarOrgName.textContent = org.name || 'Admin Panel';
                document.title = (org.name || 'Admin') + ' - Management System';
            }
            
            // Initialize birthday email settings
            const birthdayTriggerEmail = document.getElementById('birthdayTriggerEmail');
            if (birthdayTriggerEmail) {
                birthdayTriggerEmail.addEventListener('change', toggleEmailDaysBefore);
                toggleEmailDaysBefore(); // Initialize visibility
            }
            
            // Set up navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    showSection(section);
                });
            });
            
            // Load initial dashboard
            loadDashboard();
            
            // Set up auto-save on input changes
            document.addEventListener('input', markUnsaved);
            document.addEventListener('change', markUnsaved);
            
            // Warn before leaving with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        // ═══════════════════════════════════════════════════════════════════
        // ART LIBRARY FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        // Global art storage
        let selectedArtwork = null;
        let artLibrary = NewcoData.get('artLibrary') || [];
        
        // Store image reference only (not the actual data)
        function storeImageReference(dataUrl, artId, callback) {
            // For file uploads, we'll use the data URL directly in memory
            // Only store a reference in the art library
            callback(true, dataUrl);
        }
        
        function cleanupUnusedArt() {
            // Remove art chunks that are no longer in the library
            const artLibrary = NewcoData.get('artLibrary') || [];
            const validIds = new Set(artLibrary.map(a => a.id));
            
            // Check all localStorage keys
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('newco_art_')) {
                    const match = key.match(/newco_art_([^_]+)_/);
                    if (match && !validIds.has(match[1])) {
                        keysToRemove.push(key);
                    }
                }
            }
            
            // Remove unused keys
            keysToRemove.forEach(key => localStorage.removeItem(key));
        }
        
        // Retrieve stored image
        function getStoredImage(artId) {
            try {
                const chunkCount = parseInt(localStorage.getItem(`newco_art_${artId}_chunks`) || '0');
                if (chunkCount === 0) return null;
                
                let dataUrl = '';
                for (let i = 0; i < chunkCount; i++) {
                    dataUrl += localStorage.getItem(`newco_art_${artId}_${i}`) || '';
                }
                return dataUrl;
            } catch (e) {
                return null;
            }
        }
        
        function uploadNewArt() {
            document.getElementById('artUploadZone').style.display = 'block';
        }
        
        function handleArtUpload(files) {
            Array.from(files).forEach(file => {
                // Remove file size limit since we're storing in memory
                // if (file.size > 5 * 1024 * 1024) {
                //     showModal({
                //         title: '⚠️ File Too Large',
                //         message: `${file.name} exceeds 5MB limit.`,
                //         type: 'warning'
                //     });
                //     return;
                // }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const artId = 'art_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // Create art reference (without the actual data)
                    const artReference = {
                        id: artId,
                        name: file.name.replace(/\.[^/.]+$/, ''),
                        type: detectArtType(file.name),
                        size: file.size,
                        uploadDate: new Date().toISOString(),
                        usageCount: 0,
                        isCustom: true
                        // Note: NOT storing dataUrl here
                    };
                    
                    // Store image data in memory only
                    window.tempArtStorage = window.tempArtStorage || {};
                    window.tempArtStorage[artId] = e.target.result;
                    
                    // Add reference to library (without image data)
                    artLibrary.push(artReference);
                    
                    // Save only the reference to localStorage
                    try {
                        NewcoData.set('artLibrary', artLibrary);
                        
                        // Add to display with the image from memory
                        const displayItem = {...artReference, dataUrl: e.target.result};
                        addArtToGrid(displayItem);
                        
                        showSuccess('Image uploaded successfully.');
                    } catch (err) {
                        // Save failed but keep in memory
                        console.warn('Could not persist image reference');
                        // Still show the image since it's in memory
                        const displayItem = {...artReference, dataUrl: e.target.result};
                        addArtToGrid(displayItem);
                        showSuccess('Image uploaded successfully.');
                    }
                };
                reader.readAsDataURL(file);
            });
            
            document.getElementById('artUploadZone').style.display = 'none';
        }
        
        function detectArtType(filename) {
            // Detect type based on filename or ask user
            if (filename.includes('banner')) return 'banners';
            if (filename.includes('backdrop')) return 'backdrops';
            if (filename.includes('icon')) return 'icons';
            if (filename.includes('holiday') || filename.includes('christmas') || filename.includes('easter')) return 'seasonal';
            return 'banners'; // default
        }
        
        function addArtToGrid(artItem) {
            const grid = document.getElementById('artLibraryGrid');
            if (!grid) return;
            
            const artDiv = document.createElement('div');
            artDiv.className = 'art-item';
            artDiv.dataset.category = artItem.type;
            artDiv.dataset.artId = artItem.id;
            
            artDiv.innerHTML = `
                <div style="background-image: url('${artItem.dataUrl}'); background-size: cover; background-position: center; height: 120px; border-radius: 8px; position: relative; overflow: hidden;">
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem; font-size: 0.75rem;">
                        ${artItem.type} • Custom Upload
                    </div>
                </div>
                <div style="padding: 0.75rem; background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${artItem.name}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.75rem; color: var(--gray);">Used ${artItem.usageCount} times</span>
                        <button class="btn btn-sm btn-secondary" onclick="useArtwork('${artItem.id}')">
                            Use
                        </button>
                    </div>
                </div>
            `;
            
            grid.prepend(artDiv);
        }
        
        function useArtwork(artId) {
            selectedArtwork = artId;
            
            // Find the art item
            const artItem = artLibrary.find(a => a.id === artId) || 
                           { id: artId, name: 'Built-in Art', dataUrl: null };
            
            // Update usage count
            if (artItem.dataUrl) {
                artItem.usageCount = (artItem.usageCount || 0) + 1;
                NewcoData.set('artLibrary', artLibrary);
            }
            
            showModal({
                title: '✅ Artwork Selected',
                message: `"${artItem.name}" is now selected. It will be used for your next package or item creation.`,
                type: 'success'
            });
            
            // Close modal if it was opened from package/item creation
            const modal = document.getElementById('modal');
            if (modal.style.display === 'block') {
                closeModal();
            }
        }
        
        function showArtSelector(callback) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = '🎨 Select Artwork';
            
            // Load art library and reconstruct images
            const artItems = NewcoData.get('artLibrary') || [];
            const artWithImages = [];
            
            // Get images with their data URLs
            artItems.forEach(art => {
                // Check if we have the data URL stored
                let imageData = art.dataUrl;
                
                // If not in the item, check temporary storage
                if (!imageData && window.tempArtStorage && window.tempArtStorage[art.id]) {
                    imageData = window.tempArtStorage[art.id];
                }
                
                if (imageData) {
                    artWithImages.push({
                        ...art,
                        dataUrl: imageData
                    });
                }
            });
            
            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; max-height: 400px; overflow-y: auto;">
                    <!-- Built-in art -->
                    <div class="art-selector-item" style="cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 0.5rem;">
                        <div onclick="window.selectArtForItem('builtin_1')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 80px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; cursor: pointer;">🎰</div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">Jackpot Dreams</div>
                    </div>
                    <div class="art-selector-item" style="cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 0.5rem;">
                        <div onclick="window.selectArtForItem('builtin_2')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); height: 80px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; cursor: pointer;">🎉</div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">Party Time</div>
                    </div>
                    ${artWithImages.map(art => `
                        <div class="art-selector-item" style="cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 0.5rem;">
                            <div onclick="window.selectArtForItem('${art.id}')" style="background-image: url('${art.dataUrl}'); background-size: cover; background-position: center; height: 80px; border-radius: 4px; cursor: pointer;"></div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">${art.name}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="uploadNewArt()">
                        📤 Upload New Art
                    </button>
                </div>
            `;
            
            window.selectArtForItem = function(artId) {
                // Get the actual image data for the selected art
                let selectedArtData = null;
                
                if (artId.startsWith('builtin_')) {
                    // For built-in art, just pass the ID
                    selectedArtData = artId;
                } else {
                    // For uploaded art, get the full data URL
                    const selectedArt = artWithImages.find(a => a.id === artId);
                    if (selectedArt) {
                        selectedArtData = selectedArt.dataUrl;
                    }
                }
                
                // Call the callback with the art data
                if (callback) {
                    callback(selectedArtData);
                }
                closeModal();
            };
            
            modalSaveBtn.style.display = 'none';
            modal.classList.add('active');
        }
        
        function filterArtLibrary(category) {
            const items = document.querySelectorAll('.art-item');
            items.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update active button
            event.target.classList.add('active');
            event.target.parentElement.querySelectorAll('.btn').forEach(btn => {
                if (btn !== event.target) btn.classList.remove('active');
            });
        }
        
        function loadArtLibrary() {
            const grid = document.getElementById('artLibraryGrid');
            if (!grid) return;
            
            // Get saved art library
            artLibrary = NewcoData.get('artLibrary') || [];
            
            // Clear existing custom art (keep the sample art)
            const existingCustomArt = grid.querySelectorAll('.art-item[data-custom="true"]');
            existingCustomArt.forEach(item => item.remove());
            
            // Load and display each saved art item
            artLibrary.forEach(artItem => {
                // Check if we have the data URL stored
                let imageData = artItem.dataUrl;
                
                // If not in the item, check temporary storage
                if (!imageData && window.tempArtStorage && window.tempArtStorage[artItem.id]) {
                    imageData = window.tempArtStorage[artItem.id];
                }
                
                if (imageData) {
                    artItem.dataUrl = imageData;
                    
                    // Create the art display element
                    const artDiv = document.createElement('div');
                    artDiv.className = 'art-item';
                    artDiv.dataset.category = artItem.type || 'banners';
                    artDiv.dataset.artId = artItem.id;
                    artDiv.dataset.custom = 'true';
                    
                    artDiv.innerHTML = `
                        <div style="background-image: url('${artItem.dataUrl}'); background-size: cover; background-position: center; height: 120px; border-radius: 8px; position: relative; overflow: hidden;">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem; font-size: 0.75rem;">
                                ${artItem.type || 'Custom'} • ${artItem.dimensions || 'Uploaded'}
                            </div>
                        </div>
                        <div style="padding: 0.75rem; background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${artItem.name}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; color: var(--gray);">Used ${artItem.usageCount || 0} times</span>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="useArtwork('${artItem.id}')">
                                        Use
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteArtwork('${artItem.id}')">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add to grid after the upload zone samples
                    grid.appendChild(artDiv);
                }
            });
        }
        
        function deleteArtwork(artId) {
            showConfirm(
                'Are you sure you want to delete this artwork?',
                () => {
                    // Remove from library
                    artLibrary = artLibrary.filter(a => a.id !== artId);
                    NewcoData.set('artLibrary', artLibrary);
                    
                    // Remove from temporary storage if exists
                    if (window.tempArtStorage && window.tempArtStorage[artId]) {
                        delete window.tempArtStorage[artId];
                    }
                    
                    // Remove from display
                    const artElement = document.querySelector(`[data-art-id="${artId}"]`);
                    if (artElement) {
                        artElement.remove();
                    }
                    
                    showSuccess('Artwork deleted successfully');
                },
                'Delete Artwork'
            );
        }
        
        function showArtCategories() {
            showModal({
                title: '📁 Art Categories',
                message: `
                    <div style="display: grid; gap: 1rem;">
                        <div><strong>Banners (800x200):</strong> ${artLibrary.filter(a => a.type === 'banners').length} items</div>
                        <div><strong>Backdrops (600x400):</strong> ${artLibrary.filter(a => a.type === 'backdrops').length} items</div>
                        <div><strong>Icons:</strong> ${artLibrary.filter(a => a.type === 'icons').length} items</div>
                        <div><strong>Seasonal:</strong> ${artLibrary.filter(a => a.type === 'seasonal').length} items</div>
                    </div>
                `,
                type: 'info'
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // SCHEDULE FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function openScheduleModal(hallId, day) {
            const halls = NewcoData.get('halls') || [];
            const hall = halls.find(h => h.id === hallId);
            const schedules = NewcoData.get('schedules') || {};
            const hallSchedule = schedules[hallId] || {};
            
            // Check for wizard data to populate initial schedule
            const wizardData = NewcoData.get('wizardData') || {};
            const wizardSchedule = wizardData.schedule || {};
            const wizardDaySchedule = wizardSchedule[day] || {};
            
            // Use existing schedule data or fall back to wizard data
            const daySchedule = hallSchedule[day] || {
                open: wizardDaySchedule.open || false,
                doors: wizardDaySchedule.doors || '17:00',
                early: wizardDaySchedule.early || wizardDaySchedule.earlyBird || '18:00',
                regular: wizardDaySchedule.regular || '18:30',
                closing: wizardDaySchedule.closing || wizardDaySchedule.close || '21:00',
                lateNight: wizardDaySchedule.lateNight || false,
                specialEvent: wizardDaySchedule.specialEvent || false,
                tournament: wizardDaySchedule.tournament || false
            };
            
            const dayLabel = day.charAt(0).toUpperCase() + day.slice(1);
            const dayColors = {
                monday: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                tuesday: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', 
                wednesday: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                thursday: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                friday: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                saturday: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                sunday: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            };
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = `${dayLabel} Schedule - ${hall.name}`;
            modalBody.innerHTML = `
                <div style="background: ${dayColors[day]}; height: 4px; margin: -1rem -1.5rem 1.5rem -1.5rem;"></div>
                
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem;">
                        <input type="checkbox" id="dayOpen" ${daySchedule.open ? 'checked' : ''} 
                               style="width: 24px; height: 24px; cursor: pointer;"
                               onchange="document.getElementById('scheduleTimesContainer').style.display = this.checked ? 'block' : 'none'">
                        <span>Open on ${dayLabel}</span>
                    </label>
                </div>
                
                <div id="scheduleTimesContainer" style="display: ${daySchedule.open ? 'block' : 'none'};">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">🚪 Doors Open</label>
                            <input type="time" class="form-input" id="modalDoors" value="${daySchedule.doors || '17:00'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">When players can enter</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🌅 Early Bird Session</label>
                            <input type="time" class="form-input" id="modalEarly" value="${daySchedule.early || daySchedule.earlyBird || '18:00'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Early bird specials start</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🎯 Regular Session</label>
                            <input type="time" class="form-input" id="modalRegular" value="${daySchedule.regular || '18:30'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Main session begins</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🌙 Closing Time</label>
                            <input type="time" class="form-input" id="modalClosing" value="${daySchedule.closing || daySchedule.close || '21:00'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Last game ends</p>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label class="form-label">Special Sessions</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modalLateNight" ${daySchedule.lateNight ? 'checked' : ''}>
                                <span>🌃 Late Night Session</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modalSpecialEvent" ${daySchedule.specialEvent ? 'checked' : ''}>
                                <span>⭐ Special Event Day</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modalTournament" ${daySchedule.tournament ? 'checked' : ''}>
                                <span>🏆 Tournament Day</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            modalSaveBtn.textContent = 'Save Schedule';
            modalSaveBtn.onclick = () => {
                const isOpen = document.getElementById('dayOpen').checked;
                
                if (!schedules[hallId]) {
                    schedules[hallId] = {};
                }
                
                if (isOpen) {
                    schedules[hallId][day] = {
                        open: true,
                        doors: document.getElementById('modalDoors').value,
                        early: document.getElementById('modalEarly').value,
                        earlyBird: document.getElementById('modalEarly').value, // legacy
                        regular: document.getElementById('modalRegular').value,
                        closing: document.getElementById('modalClosing').value,
                        close: document.getElementById('modalClosing').value, // legacy
                        lateNight: document.getElementById('modalLateNight').checked,
                        specialEvent: document.getElementById('modalSpecialEvent').checked,
                        tournament: document.getElementById('modalTournament').checked
                    };
                } else {
                    schedules[hallId][day] = { open: false };
                }
                
                NewcoData.set('schedules', schedules);
                loadSchedule(); // Refresh the display
                closeModal();
                
                showModal({
                    title: '✅ Schedule Updated',
                    message: `${dayLabel} schedule for ${hall.name} has been saved.`,
                    type: 'success'
                });
            };
            
            modal.classList.add('active');
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // INTEGRATIONS FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function testLightspeedConnection() {
            const apiKey = document.getElementById('lightspeedApiKey').value;
            const storeId = document.getElementById('lightspeedStoreId').value;
            
            if (!apiKey || !storeId) {
                showModal({
                    title: '⚠️ Missing Credentials',
                    message: 'Please enter both API Key and Store ID to test the connection.',
                    type: 'warning'
                });
                return;
            }
            
            // Simulate testing connection
            showModal({
                title: '🔄 Testing Connection',
                message: 'Connecting to Lightspeed POS...',
                type: 'info'
            });
            
            setTimeout(() => {
                // Save integration status
                let integrations = NewcoData.get('integrations') || {};
                integrations.lightspeed = {
                    enabled: true,
                    apiKey: apiKey,
                    storeId: storeId,
                    lastSync: new Date().toISOString()
                };
                NewcoData.set('integrations', integrations);
                
                showModal({
                    title: '✅ Connection Successful',
                    message: 'Lightspeed POS has been successfully connected. Floor spending points are now enabled.',
                    type: 'success'
                });
            }, 2000);
        }
        
        function connectShopify() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = '🛍️ Connect Shopify Store';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Store URL</label>
                    <input type="text" class="form-input" id="shopifyStoreUrl" placeholder="yourstore.myshopify.com">
                    <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                        Enter your Shopify store URL without https://
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">API Access Token</label>
                    <input type="password" class="form-input" id="shopifyApiToken" placeholder="Enter your Shopify API token">
                    <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                        Generate this in your Shopify Admin under Apps > Private Apps
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">Integration Features</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncProducts" checked>
                            <span style="font-size: 0.875rem;">Sync Products & Inventory</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncCustomers" checked>
                            <span style="font-size: 0.875rem;">Sync Customer Data</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncOrders" checked>
                            <span style="font-size: 0.875rem;">Sync Order History</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncRewards">
                            <span style="font-size: 0.875rem;">Enable Rewards Integration</span>
                        </label>
                    </div>
                </div>
            `;
            
            modalSaveBtn.textContent = 'Connect Store';
            modalSaveBtn.onclick = () => {
                const storeUrl = document.getElementById('shopifyStoreUrl').value;
                const apiToken = document.getElementById('shopifyApiToken').value;
                
                if (!storeUrl || !apiToken) {
                    showError('Please enter both Store URL and API Token');
                    return;
                }
                
                // Show loading
                showAlert('Connecting to Shopify...', 'Please Wait');
                
                // Simulate connection (in real app, would make API call)
                setTimeout(() => {
                    // Save integration status
                    let integrations = NewcoData.get('integrations') || {};
                    integrations.shopify = {
                        enabled: true,
                        storeUrl: storeUrl,
                        apiToken: apiToken,
                        syncProducts: document.getElementById('syncProducts').checked,
                        syncCustomers: document.getElementById('syncCustomers').checked,
                        syncOrders: document.getElementById('syncOrders').checked,
                        syncRewards: document.getElementById('syncRewards').checked,
                        lastSync: new Date().toISOString()
                    };
                    NewcoData.set('integrations', integrations);
                    
                    closeModal();
                    
                    // Update UI
                    const shopifyCard = document.querySelector('.integration-card');
                    if (shopifyCard) {
                        const statusDiv = shopifyCard.querySelector('.integration-status');
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                    <span style="font-size: 0.875rem; color: var(--gray-dark);">Connected to ${storeUrl}</span>
                                </div>
                            `;
                        }
                    }
                    
                    showSuccess('Shopify store connected successfully!');
                }, 2000);
            };
            
            modal.classList.add('active');
        }
        
        function syncLightspeedData() {
            showModal({
                title: '🔄 Syncing Data',
                message: 'Syncing with Lightspeed POS... This may take a few moments.',
                type: 'info'
            });
            
            setTimeout(() => {
                // Update last sync time
                let integrations = NewcoData.get('integrations') || {};
                if (integrations.lightspeed) {
                    integrations.lightspeed.lastSync = new Date().toISOString();
                    NewcoData.set('integrations', integrations);
                }
                
                showModal({
                    title: '✅ Sync Complete',
                    message: 'Successfully synced 1,234 transactions and 567 customer records.',
                    type: 'success'
                });
            }, 3000);
        }
        
        function updateLightspeedFields() {
            const posType = document.getElementById('lightspeedPosType')?.value;
            const storeIdInput = document.getElementById('lightspeedStoreId');
            
            if (storeIdInput) {
                switch(posType) {
                    case 'retail':
                        storeIdInput.placeholder = 'Retail Store ID (e.g., 12345)';
                        break;
                    case 'restaurant':
                        storeIdInput.placeholder = 'Restaurant ID (e.g., REST-12345)';
                        break;
                    case 'ecom':
                        storeIdInput.placeholder = 'eCom Account ID (e.g., EC-12345)';
                        break;
                }
            }
        }
        
        function configureLightspeedMapping() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Configure Lightspeed Field Mapping';
            modalBody.innerHTML = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <div class="form-group">
                        <h4 style="color: var(--primary); margin: 0 0 1rem;">Customer Data Mapping</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: center; font-size: 0.875rem;">
                            <strong>BMS Field</strong>
                            <strong>Lightspeed Field</strong>
                            
                            <span>Customer Name</span>
                            <select class="form-select" id="mapCustomerName">
                                <option value="firstName">firstName + lastName</option>
                                <option value="fullName">fullName</option>
                                <option value="displayName">displayName</option>
                            </select>
                            
                            <span>Email</span>
                            <select class="form-select" id="mapCustomerEmail">
                                <option value="email">email</option>
                                <option value="contact.email">contact.email</option>
                            </select>
                            
                            <span>Phone</span>
                            <select class="form-select" id="mapCustomerPhone">
                                <option value="phone">phone</option>
                                <option value="contact.phone">contact.phone</option>
                                <option value="mobilePhone">mobilePhone</option>
                            </select>
                            
                            <span>Total Spent</span>
                            <select class="form-select" id="mapCustomerSpent">
                                <option value="totalSpent">totalSpent</option>
                                <option value="lifetimeValue">lifetimeValue</option>
                                <option value="accountBalance">accountBalance</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <h4 style="color: var(--primary); margin: 0 0 1rem;">Transaction Data Mapping</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: center; font-size: 0.875rem;">
                            <strong>BMS Field</strong>
                            <strong>Lightspeed Field</strong>
                            
                            <span>Transaction ID</span>
                            <select class="form-select" id="mapTransactionId">
                                <option value="saleID">saleID</option>
                                <option value="transactionNumber">transactionNumber</option>
                                <option value="receiptNumber">receiptNumber</option>
                            </select>
                            
                            <span>Amount</span>
                            <select class="form-select" id="mapTransactionAmount">
                                <option value="total">total</option>
                                <option value="subtotal">subtotal</option>
                                <option value="grandTotal">grandTotal</option>
                            </select>
                            
                            <span>Date/Time</span>
                            <select class="form-select" id="mapTransactionDate">
                                <option value="timeStamp">timeStamp</option>
                                <option value="createTime">createTime</option>
                                <option value="completedTime">completedTime</option>
                            </select>
                            
                            <span>Payment Method</span>
                            <select class="form-select" id="mapPaymentMethod">
                                <option value="paymentType">paymentType</option>
                                <option value="tenderType">tenderType</option>
                                <option value="payments.method">payments.method</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <h4 style="color: var(--primary); margin: 0 0 1rem;">Filtering Options</h4>
                        <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px;">
                            <label class="form-label">Only sync transactions containing:</label>
                            <input type="text" class="form-input" id="filterByKeyword" placeholder="e.g., 'Bingo', 'Gaming', etc." style="margin-bottom: 0.5rem;">
                            <p style="font-size: 0.75rem; color: var(--gray); margin: 0;">Leave blank to sync all transactions</p>
                        </div>
                    </div>
                </div>
            `;
            
            modalSaveBtn.textContent = 'Save Field Mapping';
            modalSaveBtn.onclick = () => {
                // Save the field mapping configuration
                const fieldMapping = {
                    customer: {
                        name: document.getElementById('mapCustomerName').value,
                        email: document.getElementById('mapCustomerEmail').value,
                        phone: document.getElementById('mapCustomerPhone').value,
                        totalSpent: document.getElementById('mapCustomerSpent').value
                    },
                    transaction: {
                        id: document.getElementById('mapTransactionId').value,
                        amount: document.getElementById('mapTransactionAmount').value,
                        date: document.getElementById('mapTransactionDate').value,
                        paymentMethod: document.getElementById('mapPaymentMethod').value
                    },
                    filters: {
                        keyword: document.getElementById('filterByKeyword').value
                    }
                };
                
                let integrations = NewcoData.get('integrations') || {};
                if (!integrations.lightspeed) {
                    integrations.lightspeed = {};
                }
                integrations.lightspeed.fieldMapping = fieldMapping;
                NewcoData.set('integrations', integrations);
                
                closeModal();
                showModal({
                    title: '✅ Field Mapping Saved',
                    message: 'Lightspeed field mapping has been configured successfully.',
                    type: 'success'
                });
            };
            
            modal.classList.add('active');
        }
        
        
        // ═══════════════════════════════════════════════════════════════════
        // TRANSACTIONS LOG FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let currentTransactionPage = 1;
        let transactionSortBy = 'date';
        let transactionSortOrder = 'desc';
        let transactionFilters = {
            source: 'all',
            customerType: 'all',
            salesperson: 'all',
            dateRange: 'all',
            rewardsEligible: 'all'
        };
        
        // Sample transaction data (in real implementation this would come from database/API)
        function generateSampleTransactions() {
            const transactions = [];
            const sources = ['floor', 'website', 'other'];
            const types = ['Bingo Session', 'Package Purchase', 'Concessions', 'Merchandise', 'Donation', 'Membership'];
            const names = ['John Smith', 'Mary Johnson', 'Bob Wilson', 'Lisa Davis', 'Mike Brown', null, 'Sarah Lee', null, 'Tom Garcia'];
            const staffNames = ['Alice Chen', 'Bob Martinez', 'Carol White', 'David Kim', 'Emma Jones', 'Frank Miller', 'Grace Taylor', 'Henry Wilson'];
            
            for (let i = 0; i < 1234; i++) {
                const source = sources[Math.floor(Math.random() * sources.length)];
                const customerName = names[Math.floor(Math.random() * names.length)];
                const amount = Math.floor(Math.random() * 100) + 5;
                const isRewardsEligible = Math.random() > 0.3;
                const loyaltyGranted = isRewardsEligible && Math.random() > 0.2;
                const loyaltyEarned = loyaltyGranted ? Math.floor(amount * (source === 'floor' ? 2 : 1)) : 0;
                
                // Determine salesperson based on source with realistic variation
                let salesperson;
                if (source === 'website') {
                    // Always Web for website transactions
                    salesperson = 'Web';
                } else if (source === 'floor') {
                    // 50% staff names, 35% Paymaster, 15% Web (for phone orders)
                    const rand = Math.random();
                    if (rand < 0.5) {
                        salesperson = staffNames[Math.floor(Math.random() * staffNames.length)];
                    } else if (rand < 0.85) {
                        salesperson = 'Paymaster';
                    } else {
                        salesperson = 'Web';
                    }
                } else {
                    // Other sources - mixed between staff and system
                    const rand = Math.random();
                    if (rand < 0.4) {
                        salesperson = staffNames[Math.floor(Math.random() * staffNames.length)];
                    } else if (rand < 0.7) {
                        salesperson = 'Paymaster';
                    } else {
                        salesperson = 'Web';
                    }
                }
                
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                transactions.push({
                    id: i + 1,
                    source: source,
                    customerName: customerName,
                    customerType: customerName ? 'identified' : 'headless',
                    salesperson: salesperson,
                    date: date,
                    type: types[Math.floor(Math.random() * types.length)],
                    amount: amount,
                    rewardsEligible: isRewardsEligible,
                    loyaltyGranted: loyaltyGranted,
                    loyaltyEarned: loyaltyEarned
                });
            }
            
            return transactions.sort((a, b) => b.date - a.date);
        }
        
        function sortTransactions(field) {
            // Toggle sort order if clicking the same field
            if (transactionSortBy === field) {
                transactionSortOrder = transactionSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                transactionSortBy = field;
                transactionSortOrder = 'asc';
            }
            
            // Update arrow indicators
            ['source', 'customer', 'salesperson', 'date', 'type', 'amount', 'status', 'loyalty'].forEach(f => {
                const arrow = document.getElementById(`sortArrow${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (arrow) {
                    if (f === field) {
                        arrow.textContent = transactionSortOrder === 'asc' ? '↑' : '↓';
                    } else {
                        arrow.textContent = '↕️';
                    }
                }
            });
            
            loadTransactions();
        }
        
        function getFilteredTransactions() {
            // Get REAL transactions from localStorage, don't generate fake ones
            const allTransactions = NewcoData.get('transactions') || [];
            const today = new Date();
            
            // Convert date strings to Date objects and add calculated fields
            const processedTransactions = allTransactions.map(t => ({
                ...t,
                date: new Date(t.date),
                source: 'website', // All from customer demo are website
                customerType: 'member',
                salesperson: 'Web',
                customerName: t.memberName,
                amount: t.finalTotal || t.total,
                type: t.paymentMethod === 'cash' ? 'CASH' : 'CARD',
                rewardsEligible: true,
                loyaltyGranted: t.loyaltyPointsUsed > 0,
                loyaltyEarned: t.loyaltyPointsEarned || 0 // Use actual points earned from transaction
            }));
            
            return processedTransactions.filter(transaction => {
                // Source filter
                if (transactionFilters.source !== 'all' && transaction.source !== transactionFilters.source) {
                    return false;
                }
                
                // Customer type filter
                if (transactionFilters.customerType !== 'all' && transaction.customerType !== transactionFilters.customerType) {
                    return false;
                }
                
                // Salesperson filter
                if (transactionFilters.salesperson !== 'all' && transaction.salesperson !== transactionFilters.salesperson) {
                    return false;
                }
                
                // Date range filter
                if (transactionFilters.dateRange === 'today') {
                    const isToday = transaction.date.toDateString() === today.toDateString();
                    if (!isToday) return false;
                } else if (transactionFilters.dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(today.getDate() - 7);
                    if (transaction.date < weekAgo) return false;
                } else if (transactionFilters.dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(today.getMonth() - 1);
                    if (transaction.date < monthAgo) return false;
                }
                
                // Rewards eligible filter
                if (transactionFilters.rewardsEligible === 'eligible' && !transaction.rewardsEligible) {
                    return false;
                } else if (transactionFilters.rewardsEligible === 'not-eligible' && transaction.rewardsEligible) {
                    return false;
                }
                
                return true;
            }).sort((a, b) => {
                let aVal, bVal;
                
                switch(transactionSortBy) {
                    case 'source':
                        aVal = a.source || '';
                        bVal = b.source || '';
                        break;
                    case 'customer':
                        aVal = a.customer || '';
                        bVal = b.customer || '';
                        break;
                    case 'salesperson':
                        aVal = a.salesperson || '';
                        bVal = b.salesperson || '';
                        break;
                    case 'date':
                        aVal = a.date;
                        bVal = b.date;
                        break;
                    case 'type':
                        aVal = a.type || '';
                        bVal = b.type || '';
                        break;
                    case 'amount':
                        aVal = a.amount || 0;
                        bVal = b.amount || 0;
                        break;
                    case 'status':
                        aVal = a.status || '';
                        bVal = b.status || '';
                        break;
                    case 'loyalty':
                        aVal = a.loyaltyPoints || 0;
                        bVal = b.loyaltyPoints || 0;
                        break;
                    default:
                        aVal = a.date;
                        bVal = b.date;
                }
                
                if (transactionSortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        function loadTransactions() {
            // Update header with current currency name
            const loyaltyHeader = document.getElementById('loyaltyPointsHeader');
            if (loyaltyHeader) {
                loyaltyHeader.textContent = getPointsCurrencyName();
            }
            
            const filteredTransactions = getFilteredTransactions();
            const perPage = 50;
            const startIndex = (currentTransactionPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            const totalPages = Math.ceil(filteredTransactions.length / perPage);
            
            // Update analytics
            updateTransactionAnalytics(filteredTransactions);
            
            // Update table
            const tbody = document.getElementById('transactionsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = pageTransactions.map(transaction => `
                <tr style="border-bottom: 1px solid var(--gray-light);">
                    <td style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${getSourceColor(transaction.source)};"></span>
                            <span style="font-weight: 600; text-transform: capitalize;">${transaction.source}</span>
                            ${transaction.isTestTransaction ? '<span style="background: #f59e0b; color: white; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.625rem; font-weight: 600; margin-left: 0.25rem;">TEST</span>' : ''}
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 600;">${transaction.customerName || 'Anonymous'}</div>
                            <div style="font-size: 0.75rem; color: var(--gray); text-transform: capitalize;">${transaction.customerType}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: ${transaction.salesperson === 'Web' ? 'var(--primary-light)' : 'var(--warning-light)'}; color: ${transaction.salesperson === 'Web' ? 'var(--primary-dark)' : 'var(--warning-dark)'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">
                            ${transaction.salesperson}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 500;">${transaction.date.toLocaleDateString()}</div>
                            <div style="font-size: 0.875rem; color: var(--gray);">${transaction.date.toLocaleTimeString()}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: var(--gray-lighter); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                            ${transaction.type}
                        </span>
                    </td>
                    <td style="padding: 1rem; font-weight: 600;">$${transaction.amount.toFixed(2)}</td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="
                            padding: 0.25rem 0.75rem;
                            border-radius: 4px;
                            font-size: 0.875rem;
                            font-weight: 500;
                            ${transaction.status === 'Received' ? 'background: var(--success-light); color: var(--success-dark);' :
                              transaction.status === 'Purchased' ? 'background: var(--primary-light); color: var(--primary-dark);' :
                              transaction.status === 'Pending' ? 'background: var(--warning-light); color: var(--warning-dark);' :
                              'background: var(--gray-lighter); color: var(--gray-dark);'}
                        ">
                            ${transaction.status || 'Unknown'}
                        </span>
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--primary);">
                        ${transaction.loyaltyEarned > 0 ? transaction.loyaltyEarned.toLocaleString() : '—'}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <button onclick='viewTransactionDetails(${JSON.stringify(transaction).replace(/'/g, "&apos;")})' class="btn btn-outline" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                            👁️ View Details
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update pagination
            const prevBtn = Array.from(document.querySelectorAll('.btn')).find(btn => btn.textContent.includes('← Previous'));
            if (prevBtn) prevBtn.disabled = currentTransactionPage === 1;
            
            const nextBtn = Array.from(document.querySelectorAll('.btn')).find(btn => btn.textContent.includes('Next →'));
            if (nextBtn) nextBtn.disabled = currentTransactionPage === totalPages;
            
            // Update counts
            const countElement = document.getElementById('transactionCount');
            if (countElement) {
                countElement.textContent = `Showing ${pageTransactions.length} of ${filteredTransactions.length} transactions`;
            }
        }
        
        function getSourceColor(source) {
            const colors = {
                floor: '#2196f3',
                website: '#4caf50', 
                other: '#ff9800'
            };
            return colors[source] || '#999';
        }
        
        function getPointsCurrencyName() {
            const rewardsConfig = NewcoData.get('rewardsConfig') || {};
            return rewardsConfig.basicSettings?.pointsCurrencyName || 'Loyalty Points';
        }

        // View Transaction Details Modal
        window.viewTransactionDetails = function(transaction) {
            const modal = document.createElement('div');
            modal.id = 'transactionDetailsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const isCancelled = transaction.status === 'Cancelled' || transaction.cancelled;
            const hasRefund = transaction.refundAmount > 0 || (transaction.refunded && transaction.amount > 0);
            const refundAmount = transaction.refundAmount || (hasRefund ? transaction.amount : 0);

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 2rem; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <button onclick="closeTransactionDetailsModal()" style="position: absolute; right: 1.5rem; top: 1.5rem; background: none; border: none; font-size: 1.75rem; cursor: pointer; color: #999; line-height: 1;">&times;</button>

                    <div style="margin-bottom: 2rem;">
                        <h2 style="margin: 0 0 0.5rem 0; color: #333; font-size: 1.75rem;">Transaction Details</h2>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="color: #666; font-size: 0.95rem;">Order #${transaction.id || 'N/A'}</span>
                            <span style="
                                padding: 0.25rem 0.75rem;
                                border-radius: 20px;
                                font-size: 0.875rem;
                                font-weight: 600;
                                ${isCancelled ? 'background: #fee; color: #c33;' :
                                  transaction.status === 'Received' ? 'background: var(--success-light); color: var(--success-dark);' :
                                  transaction.status === 'Purchased' ? 'background: var(--primary-light); color: var(--primary-dark);' :
                                  transaction.status === 'Pending' ? 'background: var(--warning-light); color: var(--warning-dark);' :
                                  'background: var(--gray-lighter); color: var(--gray-dark);'}
                            ">
                                ${isCancelled ? '❌ Cancelled' : transaction.status || 'Unknown'}
                            </span>
                            ${transaction.isTestTransaction ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">TEST</span>' : ''}
                        </div>
                    </div>

                    <!-- Customer & Transaction Info -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Customer</div>
                                <div style="font-weight: 600; font-size: 1.05rem;">${transaction.customerName || 'Anonymous'}</div>
                                <div style="font-size: 0.875rem; color: #666; text-transform: capitalize;">${transaction.customerType || 'Guest'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Date & Time</div>
                                <div style="font-weight: 600; font-size: 1.05rem;">${new Date(transaction.date).toLocaleDateString()}</div>
                                <div style="font-size: 0.875rem; color: #666;">${new Date(transaction.date).toLocaleTimeString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Source</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${getSourceColor(transaction.source)};"></span>
                                    <span style="font-weight: 600; text-transform: capitalize; font-size: 1.05rem;">${transaction.source}</span>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Salesperson</div>
                                <div style="font-weight: 600; font-size: 1.05rem;">${transaction.salesperson || 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Breakdown -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Items</h3>
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                            ${(transaction.items || []).map((item, idx) => `
                                <div style="padding: 1rem; ${idx > 0 ? 'border-top: 1px solid #e5e7eb;' : ''} display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${item.name || 'Item'}</div>
                                        <div style="font-size: 0.875rem; color: #666;">Qty: ${item.quantity || 1} × $${(item.price || 0).toFixed(2)}</div>
                                    </div>
                                    <div style="font-weight: 600; font-size: 1.1rem;">$${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                                </div>
                            `).join('')}
                            ${!transaction.items || transaction.items.length === 0 ? '<div style="padding: 1rem; text-align: center; color: #999;">No items recorded</div>' : ''}
                        </div>
                    </div>

                    <!-- Seats (if applicable) -->
                    ${transaction.selectedSeats && Object.keys(transaction.selectedSeats).length > 0 ? `
                        <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; color: #1e40af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 600;">Reserved Seats</div>
                            <div style="font-size: 0.95rem; color: #1e3a8a;">${Object.values(transaction.selectedSeats).flat().join(', ')}</div>
                        </div>
                    ` : ''}

                    <!-- Payment Breakdown -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Payment Breakdown</h3>
                        <div style="space-y: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: #666;">Subtotal (before tax)</span>
                                <span style="font-weight: 600;">$${(transaction.subtotal || transaction.amount || 0).toFixed(2)}</span>
                            </div>
                            ${transaction.tax > 0 || transaction.taxAmount > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                    <span style="color: #666;">Tax ${transaction.taxRate ? `(${transaction.taxRate}%)` : ''}</span>
                                    <span style="font-weight: 600;">$${(transaction.tax || transaction.taxAmount || 0).toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.tip > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                    <span style="color: #666;">Tip</span>
                                    <span style="font-weight: 600;">$${transaction.tip.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.discount > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #16a34a;">
                                    <span>Discount</span>
                                    <span style="font-weight: 600;">-$${transaction.discount.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.loyaltyPointsUsed > 0 || transaction.loyaltyDiscount > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #7c3aed;">
                                    <span>${getPointsCurrencyName()} Redeemed</span>
                                    <span style="font-weight: 600;">-${transaction.loyaltyPointsUsed || 0} pts (-$${(transaction.loyaltyDiscount || transaction.loyaltyPointsValue || 0).toFixed(2)})</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-top: 2px solid #ddd; margin-top: 0.5rem;">
                                <span style="font-weight: 700; font-size: 1.1rem;">Total Paid</span>
                                <span style="font-weight: 700; font-size: 1.3rem; color: #2563eb;">$${(transaction.finalTotal || transaction.total || transaction.amount || 0).toFixed(2)}</span>
                            </div>
                            ${transaction.processingFee > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #666; font-size: 0.875rem; border-top: 1px solid #e5e7eb; margin-top: 0.5rem;">
                                    <span>Processing Fee (${transaction.processingFeeRate || '2.9%'})</span>
                                    <span>$${transaction.processingFee.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: 600;">
                                    <span>Net Amount</span>
                                    <span style="color: #16a34a;">$${((transaction.finalTotal || transaction.total || transaction.amount || 0) - transaction.processingFee).toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.loyaltyEarned > 0 || transaction.loyaltyPointsEarned > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; background: #fef3c7; margin: 0.5rem -1rem 0; padding: 0.75rem 1rem; border-radius: 6px;">
                                    <span style="color: #92400e; font-weight: 600;">${getPointsCurrencyName()} Earned</span>
                                    <span style="font-weight: 700; color: #92400e;">+${transaction.loyaltyEarned || transaction.loyaltyPointsEarned || 0} pts</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Refund Info (if applicable) -->
                    ${hasRefund ? `
                        <div style="background: #fee; border: 2px solid #fcc; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.25rem;">💸</span>
                                <h3 style="margin: 0; font-size: 1.1rem; color: #c33;">Refund Information</h3>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">Refund Amount</div>
                                    <div style="font-weight: 700; font-size: 1.3rem; color: #c33;">$${refundAmount.toFixed(2)}</div>
                                </div>
                                ${transaction.refundDate ? `
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">Refunded On</div>
                                        <div style="font-weight: 600; color: #666;">${new Date(transaction.refundDate).toLocaleDateString()}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${transaction.refundReason ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #fcc;">
                                    <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; margin-bottom: 0.25rem;">Reason</div>
                                    <div style="color: #666;">${transaction.refundReason}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Payment & Card Details -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Payment Details</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            ${transaction.paymentMethod ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Payment Method</div>
                                    <div style="font-weight: 600; text-transform: capitalize;">${transaction.paymentMethod}</div>
                                </div>
                            ` : ''}
                            ${transaction.cardLast4 || transaction.card_last4 ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Card Number</div>
                                    <div style="font-weight: 600;">•••• •••• •••• ${transaction.cardLast4 || transaction.card_last4}</div>
                                </div>
                            ` : ''}
                            ${transaction.cardBrand || transaction.card_brand ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Card Brand</div>
                                    <div style="font-weight: 600; text-transform: capitalize;">${transaction.cardBrand || transaction.card_brand}</div>
                                </div>
                            ` : ''}
                            ${transaction.authorizationCode || transaction.auth_code ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Authorization Code</div>
                                    <div style="font-weight: 600; font-family: monospace;">${transaction.authorizationCode || transaction.auth_code}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Transaction Metadata -->
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Transaction Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                            <div>
                                <div style="color: #666; margin-bottom: 0.25rem;">Transaction ID</div>
                                <div style="font-weight: 600; font-family: monospace; font-size: 0.8rem;">${transaction.id || 'N/A'}</div>
                            </div>
                            ${transaction.invoiceNumber || transaction.invoice_number ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Invoice Number</div>
                                    <div style="font-weight: 600;">${transaction.invoiceNumber || transaction.invoice_number}</div>
                                </div>
                            ` : ''}
                            ${transaction.timestamp || transaction.processedAt ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Processed At</div>
                                    <div style="font-weight: 600;">${new Date(transaction.timestamp || transaction.processedAt).toLocaleString()}</div>
                                </div>
                            ` : ''}
                            ${transaction.sessionId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Session ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.8rem;">${transaction.sessionId}</div>
                                </div>
                            ` : ''}
                            ${transaction.sessionName ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Session Name</div>
                                    <div style="font-weight: 600;">${transaction.sessionName}</div>
                                </div>
                            ` : ''}
                            ${transaction.sessionDate ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Session Date</div>
                                    <div style="font-weight: 600;">${transaction.sessionDate}</div>
                                </div>
                            ` : ''}
                            ${transaction.customerEmail || transaction.memberEmail ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Customer Email</div>
                                    <div style="font-weight: 600;">${transaction.customerEmail || transaction.memberEmail}</div>
                                </div>
                            ` : ''}
                            ${transaction.customerId || transaction.memberId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Customer ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.8rem;">${transaction.customerId || transaction.memberId}</div>
                                </div>
                            ` : ''}
                            ${transaction.stripeChargeId || transaction.stripe_charge_id ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Stripe Charge ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.75rem;">${transaction.stripeChargeId || transaction.stripe_charge_id}</div>
                                </div>
                            ` : ''}
                            ${transaction.stripePaymentMethodId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Stripe Payment Method</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.75rem;">${transaction.stripePaymentMethodId}</div>
                                </div>
                            ` : ''}
                            ${transaction.receiptUrl || transaction.receipt_url ? `
                                <div style="grid-column: 1 / -1;">
                                    <div style="color: #666; margin-bottom: 0.25rem;">Receipt URL</div>
                                    <a href="${transaction.receiptUrl || transaction.receipt_url}" target="_blank" style="color: #2563eb; text-decoration: underline; word-break: break-all; font-size: 0.8rem;">${transaction.receiptUrl || transaction.receipt_url}</a>
                                </div>
                            ` : ''}
                            ${transaction.notes ? `
                                <div style="grid-column: 1 / -1;">
                                    <div style="color: #666; margin-bottom: 0.25rem;">Notes</div>
                                    <div style="font-weight: 500; padding: 0.75rem; background: #fff; border-radius: 6px; border: 1px solid #e5e7eb;">${transaction.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        window.closeTransactionDetailsModal = function() {
            const modal = document.getElementById('transactionDetailsModal');
            if (modal) modal.remove();
        }
        
        function updateTransactionAnalytics(transactions) {
            const today = new Date();
            const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Daily totals
            const todayTransactions = transactions.filter(t => 
                t.date.toDateString() === today.toDateString()
            );
            const dailyAmount = todayTransactions.reduce((sum, t) => sum + t.amount, 0);
            const dailyCount = todayTransactions.length;
            
            // Monthly totals  
            const monthTransactions = transactions.filter(t => t.date >= thisMonth);
            const monthlyAmount = monthTransactions.reduce((sum, t) => sum + t.amount, 0);
            const monthlyCount = monthTransactions.length;
            
            // Loyalty points
            const todayLoyalty = todayTransactions.reduce((sum, t) => sum + t.loyaltyEarned, 0);
            
            // Floor vs Web split
            const floorAmount = todayTransactions.filter(t => t.source === 'floor').reduce((sum, t) => sum + t.amount, 0);
            const webAmount = todayTransactions.filter(t => t.source === 'website').reduce((sum, t) => sum + t.amount, 0);
            const total = floorAmount + webAmount || 1;
            const floorPercent = Math.round((floorAmount / total) * 100);
            const webPercent = Math.round((webAmount / total) * 100);
            
            // Update UI
            const dailyTotalEl = document.getElementById('dailyTotal');
            const monthlyTotalEl = document.getElementById('monthlyTotal');
            const loyaltyEarnedEl = document.getElementById('loyaltyEarned');
            
            if (dailyTotalEl) {
                dailyTotalEl.textContent = `$${dailyAmount.toFixed(2)}`;
                dailyTotalEl.nextElementSibling.textContent = `${dailyCount} transactions`;
            }
            
            if (monthlyTotalEl) {
                monthlyTotalEl.textContent = `$${monthlyAmount.toFixed(2)}`;
                monthlyTotalEl.nextElementSibling.textContent = `${monthlyCount} transactions`;
            }
            
            if (loyaltyEarnedEl) {
                loyaltyEarnedEl.textContent = todayLoyalty.toLocaleString();
            }
            
            // Update floor vs web split
            const floorVsWebEl = document.querySelector('[id*="floorVsWeb"] .purple-text, .text-purple-600');
            if (floorVsWebEl) {
                floorVsWebEl.textContent = `${floorPercent}% / ${webPercent}%`;
            }
        }
        
        function filterTransactions() {
            transactionFilters.source = document.getElementById('filterSource')?.value || 'all';
            transactionFilters.customerType = document.getElementById('filterCustomerType')?.value || 'all';
            transactionFilters.salesperson = document.getElementById('filterSalesperson')?.value || 'all';
            transactionFilters.dateRange = document.getElementById('filterDateRange')?.value || 'today';
            transactionFilters.rewardsEligible = document.getElementById('filterRewardsEligible')?.value || 'all';
            
            currentTransactionPage = 1; // Reset to first page
            loadTransactions();
        }
        
        function loadTransactionPage(direction) {
            const filteredTransactions = getFilteredTransactions();
            const totalPages = Math.ceil(filteredTransactions.length / 50);
            
            if (direction === 'next' && currentTransactionPage < totalPages) {
                currentTransactionPage++;
            } else if (direction === 'prev' && currentTransactionPage > 1) {
                currentTransactionPage--;
            }
            
            loadTransactions();
        }

        async function deleteTestTransactions() {
            const allTransactions = NewcoData.get('transactions') || [];
            const testTransactions = allTransactions.filter(t => t.isTestTransaction);
            const testCount = testTransactions.length;

            if (testCount === 0) {
                showModal({
                    title: 'No Test Transactions',
                    message: 'There are no test transactions to delete.',
                    type: 'info'
                });
                return;
            }

            showModal({
                title: '⚠️ Delete Test Transactions',
                message: `Are you sure you want to delete ${testCount} test transaction${testCount > 1 ? 's' : ''}? This action cannot be undone.`,
                type: 'warning',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Delete', type: 'danger', action: 'confirm' }
                ],
                onConfirm: async () => {
                    // Filter out test transactions
                    const remainingTransactions = allTransactions.filter(t => !t.isTestTransaction);

                    // Save to Supabase (set() already does this)
                    await NewcoData.set('transactions', remainingTransactions);

                    // Reload the transactions view
                    loadTransactions();

                    showModal({
                        title: '✅ Success',
                        message: `Successfully deleted ${testCount} test transaction${testCount > 1 ? 's' : ''}.`,
                        type: 'success'
                    });
                }
            });
        }

        function exportTransactions() {
            const filteredTransactions = getFilteredTransactions();
            
            // Create CSV content
            const headers = ['Date', 'Time', 'Source', 'Customer', 'Type', 'Amount', 'Rewards Eligible', 'Loyalty Granted', 'Points Earned'];
            const csvContent = [
                headers.join(','),
                ...filteredTransactions.map(t => [
                    t.date.toLocaleDateString(),
                    t.date.toLocaleTimeString(),
                    t.source,
                    `"${t.customerName || 'Anonymous'}"`,
                    `"${t.type}"`,
                    t.amount.toFixed(2),
                    t.rewardsEligible ? 'Yes' : 'No',
                    t.loyaltyGranted ? 'Yes' : 'No',
                    t.loyaltyEarned
                ].join(','))
            ].join('\\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showModal({
                title: '📊 Export Complete',
                message: `Exported ${filteredTransactions.length} transactions to CSV file.`,
                type: 'success'
            });
        }
        
        // Initialize transactions on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('transactionsTableBody')) {
                loadTransactions();
            }
            if (document.getElementById('rewardsTransactionsTableBody')) {
                loadRewardsTransactions();
            }
        });
        
        // ═══════════════════════════════════════════════════════════════════
        // STORE OPERATIONS FUNCTIONS (Redemption, Purchasing, Floor Rewards)
        // ═══════════════════════════════════════════════════════════════════
        
        function toggleRedemptionSettings() {
            const enabled = document.getElementById('enableRedemption').checked;
            const settings = document.getElementById('redemptionSettings');
            const otherSettings = document.querySelectorAll('#requireIdVerification, #sendRedemptionNotifications, #redemptionMode, #redemptionStartTime, #redemptionEndTime');
            
            settings.style.opacity = enabled ? '1' : '0.3';
            settings.style.pointerEvents = enabled ? 'auto' : 'none';
            
            otherSettings.forEach(el => {
                el.disabled = !enabled;
                if (el.parentElement.tagName === 'LABEL') {
                    el.parentElement.style.opacity = enabled ? '1' : '0.3';
                }
            });
        }
        
        function togglePurchasingSettings() {
            const enabled = document.getElementById('enablePurchasing').checked;
            const settings = document.getElementById('purchasingSettings');
            const otherSettings = document.querySelectorAll('#mergeRedemptionPurchasing, #printReceipts, #emailReceipts');
            
            settings.style.opacity = enabled ? '1' : '0.3';
            settings.style.pointerEvents = enabled ? 'auto' : 'none';
            
            otherSettings.forEach(el => {
                el.disabled = !enabled;
                if (el.parentElement.tagName === 'LABEL') {
                    el.parentElement.style.opacity = enabled ? '1' : '0.3';
                }
            });
        }
        
        function saveRedemptionSettings() {
            const settings = {
                enabled: document.getElementById('enableRedemption').checked,
                permissionLevel: document.getElementById('redemptionPermissionLevel').value,
                mode: document.getElementById('redemptionMode').value,
                requireIdVerification: document.getElementById('requireIdVerification').checked,
                sendNotifications: document.getElementById('sendRedemptionNotifications').checked,
                startTime: document.getElementById('redemptionStartTime').value,
                endTime: document.getElementById('redemptionEndTime').value
            };
            
            NewcoData.set('redemptionSettings', settings);
            showSuccess('Redemption settings saved successfully!');
        }
        
        function savePurchasingSettings() {
            const settings = {
                enabled: document.getElementById('enablePurchasing').checked,
                permissionLevel: document.getElementById('purchasingPermissionLevel').value,
                mergeWithRedemption: document.getElementById('mergeRedemptionPurchasing').checked,
                printReceipts: document.getElementById('printReceipts').checked,
                emailReceipts: document.getElementById('emailReceipts').checked
            };
            
            NewcoData.set('purchasingSettings', settings);
            showSuccess('Purchasing settings saved successfully!');
        }
        
        function saveFloorRewardsSettings() {
            const settings = {
                enabled: document.getElementById('enableFloorRewards').checked,
                enableScanning: document.getElementById('enableFloorScanning').checked
            };
            
            NewcoData.set('floorRewardsSettings', settings);
            showSuccess('Floor rewards settings saved successfully!');
        }
        
        function openRedemptionApp() {
            // Open in new tab with redemption mode
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-redemption-v2.2.html?customer=${customerId}&mode=redemption`, '_blank');
        }

        function openPurchasingApp() {
            // Open in new tab with purchasing mode
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-redemption-v2.2.html?customer=${customerId}&mode=purchasing`, '_blank');
        }
        
        function copyRedemptionLink() {
            const input = document.getElementById('redemptionAppLink');
            input.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        }
        
        function copyPurchasingLink() {
            const input = document.getElementById('purchasingAppLink');
            input.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        }
        
        
        function openFloorRewardsApp() {
            // Open floor rewards app in new tab
            window.open('bms-floor-runner-vanguard.html', '_blank');
        }
        
        function copyFloorRewardsLink() {
            const input = document.getElementById('floorRewardsAppLink');
            input.select();
            document.execCommand('copy');
            showSuccess('Link copied to clipboard!');
        }
        
        function loadStoreOperationsSettings() {
            // Load redemption settings
            const redemptionSettings = NewcoData.get('redemptionSettings');
            if (redemptionSettings) {
                document.getElementById('enableRedemption').checked = redemptionSettings.enabled || false;
                document.getElementById('redemptionPermissionLevel').value = redemptionSettings.permissionLevel || 'Staff';
                document.getElementById('redemptionMode').value = redemptionSettings.mode || 'pickup';
                document.getElementById('requireIdVerification').checked = redemptionSettings.requireIdVerification !== false;
                document.getElementById('sendRedemptionNotifications').checked = redemptionSettings.sendNotifications === true;
                document.getElementById('redemptionStartTime').value = redemptionSettings.startTime || '09:00';
                document.getElementById('redemptionEndTime').value = redemptionSettings.endTime || '17:00';
                toggleRedemptionSettings();
            } else {
                // Check additionalApps from wizard
                const additionalApps = NewcoData.get('additionalApps');
                if (additionalApps && additionalApps.enableRedemptionApp) {
                    document.getElementById('enableRedemption').checked = true;
                    toggleRedemptionSettings();
                }
            }
            
            // Load purchasing settings
            const purchasingSettings = NewcoData.get('purchasingSettings');
            if (purchasingSettings) {
                document.getElementById('enablePurchasing').checked = purchasingSettings.enabled || false;
                document.getElementById('purchasingPermissionLevel').value = purchasingSettings.permissionLevel || 'Cashier';
                document.getElementById('printReceipts').checked = purchasingSettings.printReceipts !== false;
                document.getElementById('emailReceipts').checked = purchasingSettings.emailReceipts || false;
                togglePurchasingSettings();
            } else {
                // Check additionalApps from wizard
                const additionalApps = NewcoData.get('additionalApps');
                if (additionalApps && additionalApps.enableDesktopApp) {
                    document.getElementById('enablePurchasing').checked = true;
                    togglePurchasingSettings();
                }
            }
            
            // Load floor rewards settings
            const floorRewardsSettings = NewcoData.get('floorRewardsSettings');
            if (floorRewardsSettings) {
                if (document.getElementById('enableFloorRewards')) {
                    document.getElementById('enableFloorRewards').checked = floorRewardsSettings.enabled !== false;
                }
                if (document.getElementById('enableFloorScanning')) {
                    document.getElementById('enableFloorScanning').checked = floorRewardsSettings.enableScanning !== false;
                }
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // REWARDS TRANSACTIONS FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let currentRewardsTab = 'earned';
        let currentRewardsPage = 1;
        let rewardsSortBy = 'date';
        let rewardsSortOrder = 'desc';
        let rewardsTransactionFilters = {
            type: 'all',
            source: 'all',
            dateRange: 'all',
            memberStatus: 'all'
        };
        
        function switchRewardsTab(tab) {
            currentRewardsTab = tab;
            
            // Update tab styling
            const earnedTab = document.getElementById('earnedTab');
            const redeemedTab = document.getElementById('redeemedTab');
            
            if (tab === 'earned') {
                earnedTab.className = 'btn btn-primary';
                redeemedTab.className = 'btn btn-outline';
                document.getElementById('filterEarnedOption').selected = true;
                rewardsTransactionFilters.type = 'earned';
            } else {
                earnedTab.className = 'btn btn-outline';
                redeemedTab.className = 'btn btn-primary';
                document.getElementById('filterRedeemedOption').selected = true;
                rewardsTransactionFilters.type = 'redeemed';
            }
            
            // Update filter dropdown
            document.getElementById('filterRewardsType').value = tab;
            
            // Reload data
            currentRewardsPage = 1;
            loadRewardsTransactions();
        }
        
        function generateSampleRewardsTransactions() {
            const transactions = [];
            const members = ['John Smith', 'Mary Johnson', 'Bob Wilson', 'Lisa Davis', 'Mike Brown', 'Sarah Lee', 'Tom Garcia', 'Amy Chen', 'David Miller', 'Kate Johnson'];
            const earnedSources = ['floor', 'website', 'bonus', 'birthday', 'referral', 'signup'];
            const redeemedItems = ['Free Bingo Session', '10% Discount', 'Concession Credit', 'VIP Seat Upgrade', 'Extra Cards', 'Merchandise'];
            const tiers = ['tier1', 'tier2', 'tier3', 'vip'];
            
            for (let i = 0; i < 2847; i++) {
                const isEarned = Math.random() > 0.4; // 60% earned, 40% redeemed
                const member = members[Math.floor(Math.random() * members.length)];
                const tier = tiers[Math.floor(Math.random() * tiers.length)];
                
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                const transaction = {
                    id: 'txn_' + Date.now() + '_' + i,
                    date: date,
                    member: member,
                    memberTier: tier,
                    type: isEarned ? 'earned' : 'redeemed',
                    points: isEarned ?
                        Math.floor(Math.random() * 500) + 10 :
                        -(Math.floor(Math.random() * 1000) + 100),
                    balance: Math.floor(Math.random() * 5000) + 100,
                    status: Math.random() > 0.05 ? 'completed' : 'pending'
                };
                
                if (isEarned) {
                    transaction.source = earnedSources[Math.floor(Math.random() * earnedSources.length)];
                    transaction.description = `Points from ${transaction.source} purchase`;
                } else {
                    transaction.source = 'redemption';
                    transaction.description = redeemedItems[Math.floor(Math.random() * redeemedItems.length)];
                }
                
                transactions.push(transaction);
            }
            
            return transactions.sort((a, b) => b.date - a.date);
        }
        
        function sortRewardsTransactions(field) {
            // Toggle sort order if clicking the same field
            if (rewardsSortBy === field) {
                rewardsSortOrder = rewardsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                rewardsSortBy = field;
                rewardsSortOrder = 'asc';
            }
            
            // Update arrow indicators
            ['date', 'member', 'type', 'source', 'points', 'balance', 'status'].forEach(f => {
                const arrow = document.getElementById(`sortArrowRewards${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (arrow) {
                    if (f === field) {
                        arrow.textContent = rewardsSortOrder === 'asc' ? '↑' : '↓';
                    } else {
                        arrow.textContent = '↕️';
                    }
                }
            });
            
            loadRewardsTransactions();
        }
        
        function getFilteredRewardsTransactions() {
            // Get REAL rewards transactions from localStorage
            const allTransactions = NewcoData.get('rewardsTransactions') || [];
            const today = new Date();
            
            // Convert date strings to Date objects and normalize field names
            const normalizedTransactions = allTransactions.map(t => ({
                ...t,
                date: typeof t.date === 'string' ? new Date(t.date) : t.date,
                member: t.member || t.memberName || 'Unknown',
                memberTier: t.memberTier || 'tier1',
                status: t.status || 'completed'
            }));
            
            return normalizedTransactions.filter(transaction => {
                // Type filter
                if (rewardsTransactionFilters.type !== 'all' && transaction.type !== rewardsTransactionFilters.type) {
                    return false;
                }
                
                // Source filter
                if (rewardsTransactionFilters.source !== 'all' && transaction.source !== rewardsTransactionFilters.source) {
                    return false;
                }
                
                // Date range filter
                if (rewardsTransactionFilters.dateRange === 'today') {
                    const isToday = transaction.date.toDateString() === today.toDateString();
                    if (!isToday) return false;
                } else if (rewardsTransactionFilters.dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(today.getDate() - 7);
                    if (transaction.date < weekAgo) return false;
                } else if (rewardsTransactionFilters.dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(today.getMonth() - 1);
                    if (transaction.date < monthAgo) return false;
                }
                
                // Member status filter
                if (rewardsTransactionFilters.memberStatus !== 'all' && transaction.memberTier !== rewardsTransactionFilters.memberStatus) {
                    return false;
                }
                
                return true;
            }).sort((a, b) => {
                let aVal, bVal;
                
                switch(rewardsSortBy) {
                    case 'date':
                        aVal = a.date;
                        bVal = b.date;
                        break;
                    case 'member':
                        aVal = a.member || '';
                        bVal = b.member || '';
                        break;
                    case 'type':
                        aVal = a.type || '';
                        bVal = b.type || '';
                        break;
                    case 'source':
                        aVal = a.source || '';
                        bVal = b.source || '';
                        break;
                    case 'points':
                        aVal = a.points || 0;
                        bVal = b.points || 0;
                        break;
                    case 'balance':
                        aVal = a.balance || 0;
                        bVal = b.balance || 0;
                        break;
                    case 'status':
                        aVal = a.status || '';
                        bVal = b.status || '';
                        break;
                    default:
                        aVal = a.date;
                        bVal = b.date;
                }
                
                if (rewardsSortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        async function loadRewardsTransactions() {
            // Refresh cache from Supabase first
            const custData = await NewcoData.read_cust();
            if (custData.rewardsTransactions) {
                NewcoData.cache.rewardsTransactions = custData.rewardsTransactions;
            }

            // Get REAL rewards transactions from cache
            const allTransactions = NewcoData.get('rewardsTransactions') || [];
            
            // Normalize all transactions for analytics
            const normalizedAll = allTransactions.map(t => ({
                ...t,
                date: typeof t.date === 'string' ? new Date(t.date) : t.date,
                member: t.member || t.memberName || 'Unknown',
                memberTier: t.memberTier || 'tier1',
                status: t.status || 'completed'
            }));
            
            const filteredTransactions = getFilteredRewardsTransactions();
            const perPage = 50;
            const startIndex = (currentRewardsPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            const totalPages = Math.ceil(filteredTransactions.length / perPage);
            
            // Update analytics with all transactions (not filtered by tab)
            updateRewardsAnalytics(normalizedAll);
            
            // Update table
            const tbody = document.getElementById('rewardsTransactionsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = pageTransactions.map(transaction => `
                <tr style="border-bottom: 1px solid var(--gray-light);">
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 500;">${transaction.date.toLocaleDateString()}</div>
                            <div style="font-size: 0.875rem; color: var(--gray);">${transaction.date.toLocaleTimeString()}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 600;">${transaction.member}</div>
                            <div style="font-size: 0.75rem; color: var(--gray); text-transform: capitalize;">${transaction.memberTier.replace('tier', 'Tier ')}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: ${transaction.type === 'earned' ? '#ffa72620' : '#26a69a20'}; color: ${transaction.type === 'earned' ? '#ffa726' : '#26a69a'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize;">
                            ${transaction.type === 'earned' ? '⭐ Earned' : '🎁 Redeemed'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 500; text-transform: capitalize;">${transaction.source.replace('_', ' ')}</div>
                            <div style="font-size: 0.75rem; color: var(--gray);">${transaction.description}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: ${transaction.points > 0 ? 'var(--success)' : '#26a69a'};">
                        ${transaction.points > 0 ? '+' : ''}${transaction.points.toLocaleString()}
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--primary);">
                        ${transaction.balance.toLocaleString()}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="color: ${transaction.status === 'completed' ? 'var(--success)' : '#ffa726'}; font-weight: 600; text-transform: capitalize;">
                            ${transaction.status === 'completed' ? '✓ Complete' : '⏳ Pending'}
                        </span>
                    </td>
                </tr>
            `).join('');
            
            // Update table title and counts
            const titleElement = document.getElementById('rewardsTableTitle');
            const countElement = document.getElementById('rewardsTransactionCount');
            const paginationElement = document.getElementById('rewardsPagination');
            
            if (titleElement) {
                titleElement.textContent = currentRewardsTab === 'earned' ? 
                    'Recent Points Earned' : 'Recent Points Redeemed';
            }
            
            if (countElement) {
                countElement.textContent = `Showing ${pageTransactions.length} of ${filteredTransactions.length} transactions`;
            }
            
            if (paginationElement) {
                paginationElement.textContent = `Page ${currentRewardsPage} of ${totalPages}`;
            }
        }
        
        function updateRewardsAnalytics(transactions) {
            const today = new Date();
            const todayTransactions = transactions.filter(t => 
                t.date.toDateString() === today.toDateString()
            );
            
            const earnedToday = todayTransactions.filter(t => t.type === 'earned');
            const redeemedToday = todayTransactions.filter(t => t.type === 'redeemed');
            
            const earnedPoints = earnedToday.reduce((sum, t) => sum + t.points, 0);
            const redeemedPoints = Math.abs(redeemedToday.reduce((sum, t) => sum + t.points, 0));
            const netPoints = earnedPoints - redeemedPoints;
            const activeMembers = new Set(todayTransactions.map(t => t.member)).size;
            
            // Update UI elements
            const pointsEarnedTodayEl = document.getElementById('pointsEarnedToday');
            const pointsRedeemedTodayEl = document.getElementById('pointsRedeemedToday');
            const netPointsTodayEl = document.getElementById('netPointsToday');
            const activeMembersEl = document.getElementById('activeMembers');
            
            if (pointsEarnedTodayEl) {
                pointsEarnedTodayEl.textContent = earnedPoints.toLocaleString();
                pointsEarnedTodayEl.nextElementSibling.textContent = `${earnedToday.length} transactions`;
            }
            
            if (pointsRedeemedTodayEl) {
                pointsRedeemedTodayEl.textContent = redeemedPoints.toLocaleString();
                pointsRedeemedTodayEl.nextElementSibling.textContent = `${redeemedToday.length} redemptions`;
            }
            
            if (netPointsTodayEl) {
                netPointsTodayEl.textContent = (netPoints >= 0 ? '+' : '') + netPoints.toLocaleString();
            }
            
            if (activeMembersEl) {
                activeMembersEl.textContent = activeMembers.toLocaleString();
            }
        }
        
        function filterRewardsTransactions() {
            rewardsTransactionFilters.type = document.getElementById('filterRewardsType')?.value || 'all';
            rewardsTransactionFilters.source = document.getElementById('filterRewardsSource')?.value || 'all';
            rewardsTransactionFilters.dateRange = document.getElementById('filterRewardsDateRange')?.value || 'today';
            rewardsTransactionFilters.memberStatus = document.getElementById('filterMemberStatus')?.value || 'all';
            
            // Update tab if filter type changed
            if (rewardsTransactionFilters.type !== 'all' && rewardsTransactionFilters.type !== currentRewardsTab) {
                switchRewardsTab(rewardsTransactionFilters.type);
                return; // switchRewardsTab will call loadRewardsTransactions
            }
            
            currentRewardsPage = 1; // Reset to first page
            loadRewardsTransactions();
        }
        
        function loadRewardsTransactionPage(direction) {
            const filteredTransactions = getFilteredRewardsTransactions();
            const totalPages = Math.ceil(filteredTransactions.length / 50);
            
            if (direction === 'next' && currentRewardsPage < totalPages) {
                currentRewardsPage++;
            } else if (direction === 'prev' && currentRewardsPage > 1) {
                currentRewardsPage--;
            }
            
            loadRewardsTransactions();
        }
        
        function exportRewardsTransactions() {
            const filteredTransactions = getFilteredRewardsTransactions();
            
            // Create CSV content
            const headers = ['Date', 'Time', 'Member', 'Type', 'Source', 'Description', 'Points', 'Balance', 'Status'];
            const csvContent = [
                headers.join(','),
                ...filteredTransactions.map(t => [
                    t.date.toLocaleDateString(),
                    t.date.toLocaleTimeString(),
                    `"${t.member}"`,
                    t.type,
                    t.source,
                    `"${t.description}"`,
                    t.points,
                    t.balance,
                    t.status
                ].join(','))
            ].join('\\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rewards_transactions_${currentRewardsTab}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showModal({
                title: '📊 Export Complete',
                message: `Exported ${filteredTransactions.length} rewards transactions to CSV file.`,
                type: 'success'
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // WEB BUILDER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let selectedBuilderComponent = null;
        let builderComponents = [];
        
        // Drag and Drop Functions
        function allowDrop(event) {
            event.preventDefault();
        }
        
        function dropComponent(event) {
            event.preventDefault();
            const componentType = event.dataTransfer.getData('text/plain');
            if (componentType) {
                addComponentToBuilder(componentType, event.clientY);
            }
        }
        
        // Reports Section Functions
        function loadReports() {
            // Update stats with current data
            updateReportStats();
        }
        
        function updateReportStats() {
            // Simulate updating stats with real data
            const stats = {
                revenue: Math.floor(Math.random() * 5000) + 20000,
                sessions: Math.floor(Math.random() * 100) + 800,
                memberGrowth: Math.floor(Math.random() * 20) + 30
            };
            
            document.getElementById('reportRevenue').textContent = '$' + stats.revenue.toLocaleString();
            document.getElementById('reportSessions').textContent = stats.sessions.toLocaleString();
            document.getElementById('reportAvgRevenue').textContent = '$' + (stats.revenue / stats.sessions).toFixed(2);
            document.getElementById('reportMemberGrowth').textContent = '+' + stats.memberGrowth;
        }
        
        function viewReport(reportType) {
            showModal({
                title: '📊 ' + reportType.charAt(0).toUpperCase() + reportType.slice(1) + ' Report',
                message: 'Generating ' + reportType + ' report... This feature will connect to your analytics system.',
                type: 'info'
            });
        }
        
        function exportReports() {
            showModal({
                title: '📥 Export Reports',
                message: 'Exporting all reports to Excel format... Download will start shortly.',
                type: 'success'
            });
        }
        
        function viewSavedReport(reportId) {
            showModal({
                title: '📄 View Report',
                message: 'Opening saved report #' + reportId + '...',
                type: 'info'
            });
        }
        
        function downloadReport(reportId) {
            showModal({
                title: '⬇️ Download Report',
                message: 'Downloading report #' + reportId + ' as PDF...',
                type: 'success'
            });
        }
        
        // Email Section Functions
        function loadEmails() {
            // Update email stats
            updateEmailStats();
        }
        
        function updateEmailStats() {
            // Could fetch real stats from backend
            console.log('Email stats loaded');
        }
        
        function testEmailSetup() {
            showModal({
                title: '🧪 Test Email Setup',
                message: 'Sending test email to your configured address... Check your inbox!',
                type: 'info'
            });
        }
        
        function createEmailCampaign() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Create Email Campaign';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Campaign Name</label>
                    <input type="text" class="form-input" id="campaignName" placeholder="e.g., Holiday Special Announcement">
                </div>
                <div class="form-group">
                    <label class="form-label">Subject Line</label>
                    <input type="text" class="form-input" id="campaignSubject" placeholder="e.g., 🎄 Special Holiday Bingo Events!">
                </div>
                <div class="form-group">
                    <label class="form-label">Recipients</label>
                    <select class="form-select" id="campaignRecipients">
                        <option value="all">All Members (1,247)</option>
                        <option value="active">Active Members (892)</option>
                        <option value="vip">VIP Members (124)</option>
                        <option value="new">New Members (47)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Send Time</label>
                    <select class="form-select" id="campaignSendTime">
                        <option value="now">Send Now</option>
                        <option value="scheduled">Schedule for Later</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-input" id="campaignMessage" rows="6" placeholder="Enter your email message here..."></textarea>
                </div>
            `;
            
            modalSaveBtn.onclick = () => {
                showSuccess('Email campaign created successfully!');
                closeModal();
            };
            
            modal.classList.add('active');
        }
        
        function editEmailTemplate(templateType) {
            showModal({
                title: '✏️ Edit ' + templateType.charAt(0).toUpperCase() + templateType.slice(1) + ' Email Template',
                message: 'Email template editor will open here with rich text formatting options.',
                type: 'info'
            });
        }
        
        function previewEmail(templateType) {
            showModal({
                title: '👁️ Preview ' + templateType.charAt(0).toUpperCase() + templateType.slice(1) + ' Email',
                message: 'Email preview will show here with your branding and content.',
                type: 'info'
            });
        }
        
        function sendTestEmail(templateType) {
            showModal({
                title: '📧 Send Test Email',
                message: 'Test email sent! Check your inbox for the ' + templateType + ' email template.',
                type: 'success'
            });
        }
        
        function viewCampaignStats(campaignId) {
            showModal({
                title: '📊 Campaign Statistics',
                message: 'Detailed stats for campaign #' + campaignId + ' including open rates, click-through rates, and conversions.',
                type: 'info'
            });
        }
        
        function duplicateCampaign(campaignId) {
            showModal({
                title: '📋 Duplicate Campaign',
                message: 'Campaign #' + campaignId + ' duplicated. You can now edit and send it.',
                type: 'success'
            });
        }
        
        function editCampaign(campaignId) {
            createEmailCampaign(); // Reuse the create function for editing
        }
        
        function cancelCampaign(campaignId) {
            showConfirm(
                'Are you sure you want to cancel this scheduled campaign?',
                () => {
                    showSuccess('Campaign cancelled successfully');
                }
            );
        }
        
        function saveEmailSettings() {
            const settings = {
                fromName: document.getElementById('emailFromName').value,
                fromAddress: document.getElementById('emailFromAddress').value,
                replyTo: document.getElementById('emailReplyTo').value,
                footer: document.getElementById('emailFooter').value
            };
            
            NewcoData.set('emailSettings', settings);
            showSuccess('Email settings saved successfully!');
        }
        
        function sendCampaign(campaignId) {
            showConfirm(
                'Are you sure you want to send this campaign now? This action cannot be undone.',
                () => {
                    showSuccess('Campaign is being sent to recipients...');
                    // Update the campaign status in the table
                    setTimeout(() => {
                        const row = document.querySelector(`#emailCampaignsTableBody tr:nth-child(${campaignId})`);
                        if (row) {
                            const statusCell = row.cells[1];
                            statusCell.innerHTML = '<span style="background: var(--info); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sending...</span>';
                            
                            setTimeout(() => {
                                statusCell.innerHTML = '<span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>';
                                showSuccess('Campaign sent successfully!');
                            }, 2000);
                        }
                    }, 500);
                },
                'Send Campaign'
            );
        }
        
        function editRecurring(campaignId) {
            showModal({
                title: '🎯 Edit Recurring Campaign',
                message: 'Recurring campaign settings: Weekly Game Schedule<br><br>Frequency: Every Monday at 9:00 AM<br>Recipients: All Active Members<br><br>This feature will allow you to edit the schedule and content.',
                type: 'info'
            });
        }
        
        function pauseRecurring(campaignId) {
            showConfirm(
                'Pause the weekly game schedule emails?',
                () => {
                    const row = document.querySelector(`#emailCampaignsTableBody tr:nth-child(${campaignId})`);
                    if (row) {
                        const actionsCell = row.cells[5];
                        actionsCell.innerHTML = `
                            <button class="btn btn-sm btn-secondary" onclick="editRecurring(${campaignId})">Edit</button>
                            <button class="btn btn-sm btn-success" onclick="resumeRecurring(${campaignId})">Resume</button>
                        `;
                    }
                    showSuccess('Recurring campaign paused');
                }
            );
        }
        
        function resumeRecurring(campaignId) {
            const row = document.querySelector(`#emailCampaignsTableBody tr:nth-child(${campaignId})`);
            if (row) {
                const actionsCell = row.cells[5];
                actionsCell.innerHTML = `
                    <button class="btn btn-sm btn-secondary" onclick="editRecurring(${campaignId})">Edit</button>
                    <button class="btn btn-sm btn-outline" onclick="pauseRecurring(${campaignId})">Pause</button>
                `;
            }
            showSuccess('Recurring campaign resumed');
        }
        
        // Helper functions for welcome email in staff member modal
        function toggleWelcomeEmailOptions(checkbox) {
            const options = document.getElementById('welcomeEmailOptions');
            if (options) {
                options.style.display = checkbox.checked ? 'block' : 'none';
            }
        }
        
        function updateWelcomePreview() {
            const template = document.getElementById('welcomeEmailTemplate').value;
            const preview = document.getElementById('welcomeEmailPreview');
            const customGroup = document.getElementById('customWelcomeGroup');
            
            if (!preview) return;
            
            if (template === 'custom') {
                customGroup.style.display = 'block';
                const customText = document.getElementById('customWelcomeText').value || 
                    'Welcome to our team! We\'re excited to have you join us...';
                preview.innerHTML = `
                    Subject: Welcome to Santa Clara Bingo!<br>
                    <br>
                    ${customText.replace(/{name}/g, 'John Doe')
                                .replace(/{role}/g, 'Staff Member')
                                .replace(/{email}/g, 'john@example.com')
                                .replace(/{organization}/g, 'Santa Clara Bingo')
                                .replace(/{loginUrl}/g, 'https://portal.santaclarabingo.com')}
                `;
            } else {
                customGroup.style.display = 'none';
                
                const templates = {
                    standard: `
                        Subject: Welcome to Santa Clara Bingo!<br>
                        <br>
                        Dear {name},<br>
                        <br>
                        Welcome to Santa Clara Bingo! You've been added as a {role}.<br>
                        <br>
                        We're thrilled to have you join our team. You'll find everything you need to get started in our staff portal.<br>
                        <br>
                        Your login credentials will be sent in a separate email.
                    `,
                    admin: `
                        Subject: Admin Access Granted - Santa Clara Bingo<br>
                        <br>
                        Dear {name},<br>
                        <br>
                        You've been granted Admin access to Santa Clara Bingo's management system.<br>
                        <br>
                        As an administrator, you have full access to:<br>
                        • Staff management<br>
                        • Financial reports<br>
                        • Game configuration<br>
                        • Member database<br>
                        <br>
                        Please review our admin guide at: {loginUrl}/admin-guide<br>
                        <br>
                        Your credentials will follow in a secure email.
                    `,
                    floor: `
                        Subject: Welcome to the Team - Santa Clara Bingo<br>
                        <br>
                        Hello {name}!<br>
                        <br>
                        Welcome aboard as our new {role}!<br>
                        <br>
                        Your first shift details:<br>
                        • Check the schedule portal for your assigned shifts<br>
                        • Arrive 15 minutes early for orientation<br>
                        • Uniform will be provided on your first day<br>
                        <br>
                        Portal access: {loginUrl}<br>
                        Your login details will be sent separately.
                    `
                };
                
                preview.innerHTML = templates[template] || templates.standard;
            }
        }
        
        window.toggleWelcomeEmailOptions = toggleWelcomeEmailOptions;
        window.updateWelcomePreview = updateWelcomePreview;
        
        // ═══════════════════════════════════════════════════════════════════
        // ACTIONS LOG FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let currentActionsPage = 1;
        let actionsSortBy = 'timestamp';
        let actionsSortOrder = 'desc';
        let actionsFilters = {
            user: 'all',
            actionType: 'all',
            dateRange: 'today',
            search: ''
        };
        
        function loadActionsLog() {
            const actionsLog = NewcoData.get('actionsLog') || [];
            
            // Populate user filter
            const users = [...new Set(actionsLog.map(a => a.user))];
            const userFilter = document.getElementById('filterActionUser');
            if (userFilter) {
                userFilter.innerHTML = '<option value="all">All Users</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userFilter.appendChild(option);
                });
            }
            
            filterActionsLog();
        }
        
        function filterActionsLog() {
            const actionsLog = NewcoData.get('actionsLog') || [];
            const today = new Date();
            
            actionsFilters.user = document.getElementById('filterActionUser')?.value || 'all';
            actionsFilters.actionType = document.getElementById('filterActionType')?.value || 'all';
            actionsFilters.dateRange = document.getElementById('filterActionDate')?.value || 'today';
            actionsFilters.search = document.getElementById('searchActionDetails')?.value?.toLowerCase() || '';
            
            let filtered = actionsLog.filter(action => {
                // User filter
                if (actionsFilters.user !== 'all' && action.user !== actionsFilters.user) {
                    return false;
                }
                
                // Action type filter
                if (actionsFilters.actionType !== 'all' && action.actionType !== actionsFilters.actionType) {
                    return false;
                }
                
                // Date range filter
                const actionDate = new Date(action.timestamp);
                if (actionsFilters.dateRange === 'today') {
                    if (actionDate.toDateString() !== today.toDateString()) return false;
                } else if (actionsFilters.dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(today.getDate() - 7);
                    if (actionDate < weekAgo) return false;
                } else if (actionsFilters.dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(today.getMonth() - 1);
                    if (actionDate < monthAgo) return false;
                }
                
                // Search filter
                if (actionsFilters.search && !action.details.toLowerCase().includes(actionsFilters.search)) {
                    return false;
                }
                
                return true;
            });
            
            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;
                
                switch(actionsSortBy) {
                    case 'timestamp':
                        aVal = new Date(a.timestamp);
                        bVal = new Date(b.timestamp);
                        break;
                    case 'user':
                        aVal = a.user || '';
                        bVal = b.user || '';
                        break;
                    case 'action':
                        aVal = a.actionType || '';
                        bVal = b.actionType || '';
                        break;
                    case 'section':
                        aVal = a.section || '';
                        bVal = b.section || '';
                        break;
                    default:
                        aVal = new Date(a.timestamp);
                        bVal = new Date(b.timestamp);
                }
                
                if (actionsSortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Paginate
            const perPage = 50;
            const startIndex = (currentActionsPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageActions = filtered.slice(startIndex, endIndex);
            const totalPages = Math.ceil(filtered.length / perPage) || 1;
            
            // Update table
            const tbody = document.getElementById('actionsLogTableBody');
            if (tbody) {
                if (pageActions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray);">No actions found</td></tr>';
                } else {
                    tbody.innerHTML = pageActions.map(action => {
                        const date = new Date(action.timestamp);
                        const actionColor = {
                            create: '#28a745',
                            update: '#007bff',
                            delete: '#dc3545',
                            save: '#17a2b8'
                        }[action.actionType] || '#6c757d';
                        
                        return `
                            <tr style="border-bottom: 1px solid var(--gray-light);">
                                <td style="padding: 1rem;">
                                    <div>
                                        <div style="font-weight: 500;">${date.toLocaleDateString()}</div>
                                        <div style="font-size: 0.875rem; color: var(--gray);">${date.toLocaleTimeString()}</div>
                                    </div>
                                </td>
                                <td style="padding: 1rem; font-weight: 600;">${action.user}</td>
                                <td style="padding: 1rem;">
                                    <span style="background: ${actionColor}20; color: ${actionColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                        ${action.actionType}
                                    </span>
                                </td>
                                <td style="padding: 1rem; color: var(--gray-dark);">${action.details}</td>
                                <td style="padding: 1rem;">
                                    <span style="background: var(--gray-lighter); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                        ${action.section}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            // Update count
            const countEl = document.getElementById('actionsCount');
            if (countEl) {
                countEl.textContent = `Showing ${pageActions.length} of ${filtered.length} actions`;
            }
            
            // Update pagination
            const pageInfo = document.getElementById('actionsPageInfo');
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentActionsPage} of ${totalPages}`;
            }
        }
        
        function sortActionsLog(field) {
            if (actionsSortBy === field) {
                actionsSortOrder = actionsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                actionsSortBy = field;
                actionsSortOrder = field === 'timestamp' ? 'desc' : 'asc';
            }
            
            // Update arrows
            ['timestamp', 'user', 'action', 'section'].forEach(f => {
                const arrow = document.getElementById(`sortArrowAction${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (arrow) {
                    if (f === field) {
                        arrow.textContent = actionsSortOrder === 'asc' ? '↑' : '↓';
                    } else {
                        arrow.textContent = '↕️';
                    }
                }
            });
            
            filterActionsLog();
        }
        
        function loadActionsPage(direction) {
            const actionsLog = NewcoData.get('actionsLog') || [];
            const totalPages = Math.ceil(actionsLog.length / 50) || 1;
            
            if (direction === 'prev' && currentActionsPage > 1) {
                currentActionsPage--;
            } else if (direction === 'next' && currentActionsPage < totalPages) {
                currentActionsPage++;
            }
            
            filterActionsLog();
        }
        
        function clearActionsLog() {
            if (confirm('Are you sure you want to clear all action logs? This cannot be undone.')) {
                NewcoData.set('actionsLog', [], true); // Skip logging this action
                loadActionsLog();
                showSuccess('Actions log cleared');
            }
        }
        
        function exportActionsLog() {
            const actionsLog = NewcoData.get('actionsLog') || [];
            
            const headers = ['Timestamp', 'User', 'Action', 'Details', 'Section'];
            const csvContent = [
                headers.join(','),
                ...actionsLog.map(a => [
                    new Date(a.timestamp).toISOString(),
                    a.user,
                    a.actionType,
                    `"${a.details.replace(/"/g, '""')}"`,
                    a.section
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `actions_log_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Actions log exported');
        }
        
        // Add drag start listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.drag-component').forEach(component => {
                component.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.component);
                });
            });
            
            // Initialize Start Here indicators
            initStartHereIndicators();
        });
        
        function addComponentToBuilder(componentType, yPosition) {
            const canvas = document.getElementById('builderCanvas');
            const placeholder = document.getElementById('canvasPlaceholder');
            
            // Hide placeholder
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            const componentId = Date.now().toString();
            const component = createBuilderComponent(componentType, componentId);
            
            // Store component data
            builderComponents.push({
                id: componentId,
                type: componentType,
                element: component
            });
            
            canvas.appendChild(component);
            selectBuilderComponent(componentId);
        }
        
        function createBuilderComponent(type, id) {
            const div = document.createElement('div');
            div.className = 'builder-component';
            div.dataset.componentId = id;
            div.style.cssText = `
                margin: 1rem 0;
                padding: 1rem;
                border: 2px solid transparent;
                border-radius: 8px;
                background: var(--gray-lighter);
                position: relative;
                cursor: pointer;
                transition: all 0.2s;
            `;
            
            div.onclick = () => selectBuilderComponent(id);
            
            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '✕';
            removeBtn.style.cssText = `
                position: absolute;
                top: -8px;
                right: -8px;
                width: 20px;
                height: 20px;
                border: none;
                border-radius: 50%;
                background: var(--danger);
                color: white;
                font-size: 12px;
                cursor: pointer;
                display: none;
            `;
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeBuilderComponent(id);
            };
            
            div.onmouseover = () => removeBtn.style.display = 'block';
            div.onmouseout = () => removeBtn.style.display = 'none';
            
            div.appendChild(removeBtn);
            
            // Component content
            const content = getBuilderComponentContent(type);
            div.innerHTML += content;
            
            return div;
        }
        
        function getBuilderComponentContent(type) {
            const templates = {
                header: `
                    <div style="text-align: center; padding: 2rem;">
                        <h1 style="font-size: 2.5rem; margin: 0 0 0.5rem; color: var(--primary);">Welcome to Bingo Night</h1>
                        <p style="font-size: 1.2rem; color: var(--gray); margin: 0;">Book your session and win big!</p>
                    </div>
                `,
                'session-selector': `
                    <div style="text-align: center; padding: 1.5rem;">
                        <h3 style="margin: 0 0 1rem;">Select Your Session</h3>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-outline">📅 Tonight 7PM</button>
                            <button class="btn btn-outline">📅 Saturday 2PM</button>
                            <button class="btn btn-primary">📅 Sunday 6PM</button>
                        </div>
                    </div>
                `,
                'package-cards': `
                    <div style="padding: 1.5rem;">
                        <h3 style="text-align: center; margin: 0 0 1.5rem;">Choose Your Package</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 0.5rem;">Basic Package</h4>
                                <p style="color: var(--gray); margin: 0 0 1rem;">6 cards, daubers included</p>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">$15</div>
                            </div>
                            <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid var(--primary);">
                                <h4 style="margin: 0 0 0.5rem;">Premium Package</h4>
                                <p style="color: var(--gray); margin: 0 0 1rem;">12 cards, snacks, drinks</p>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">$25</div>
                            </div>
                        </div>
                    </div>
                `,
                'seat-selector': `
                    <div style="text-align: center; padding: 1.5rem;">
                        <h3 style="margin: 0 0 1rem;">Select Your Seats</h3>
                        <div style="background: white; border-radius: 8px; padding: 1rem; display: inline-block;">
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                                ${Array(12).fill().map((_, i) => 
                                    `<div style="width: 30px; height: 30px; border-radius: 4px; background: ${i < 3 ? 'var(--success)' : 'var(--gray-light)'}; cursor: pointer;"></div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `,
                pricing: `
                    <div style="background: white; border-radius: 8px; padding: 2rem; margin: 1rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span>Premium Package</span>
                            <span style="font-weight: bold;">$25.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: var(--gray);">
                            <span>Processing Fee</span>
                            <span>$2.50</span>
                        </div>
                        <div style="border-top: 1px solid var(--gray-light); padding-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.2rem; font-weight: bold;">Total</span>
                            <span style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">$27.50</span>
                        </div>
                    </div>
                `,
                checkout: `
                    <div style="background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1.5rem;">Complete Your Booking</h3>
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" placeholder="Enter your name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" placeholder="Enter your email">
                        </div>
                        <button class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                            Complete Booking - $27.50
                        </button>
                    </div>
                `,
                text: `
                    <div style="padding: 1rem;">
                        <h3 style="margin: 0 0 1rem;">Your Custom Text</h3>
                        <p style="color: var(--gray); line-height: 1.6;">
                            Add your custom text here. You can include information about your bingo hall, 
                            special promotions, rules, or any other content you'd like your visitors to see.
                        </p>
                    </div>
                `,
                image: `
                    <div style="text-align: center; padding: 2rem; background: var(--gray-lighter);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🖼️</div>
                        <h4 style="margin: 0 0 0.5rem;">Image Placeholder</h4>
                        <p style="color: var(--gray); margin: 0;">Click to upload an image</p>
                    </div>
                `,
                divider: `
                    <div style="padding: 2rem 0;">
                        <hr style="border: none; height: 2px; background: linear-gradient(to right, transparent, var(--primary), transparent);">
                    </div>
                `
            };
            
            return templates[type] || '<p>Unknown component</p>';
        }
        
        function selectBuilderComponent(componentId) {
            // Remove previous selection
            document.querySelectorAll('.builder-component').forEach(comp => {
                comp.style.border = '2px solid transparent';
            });
            
            // Select new component
            const component = document.querySelector(`[data-component-id="${componentId}"]`);
            if (component) {
                component.style.border = '2px solid var(--primary)';
                selectedBuilderComponent = componentId;
                showComponentProperties(componentId);
            }
        }
        
        function showComponentProperties(componentId) {
            const component = builderComponents.find(c => c.id === componentId);
            const panel = document.getElementById('builderPropertyPanel');
            
            if (!component || !panel) return;
            
            const properties = getComponentProperties(component.type);
            panel.innerHTML = properties;
        }
        
        function getComponentProperties(type) {
            const properties = {
                header: `
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" value="Welcome to Bingo Night" onchange="updateComponentProperty('title', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subtitle</label>
                        <input type="text" class="form-input" value="Book your session and win big!" onchange="updateComponentProperty('subtitle', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Text Align</label>
                        <select class="form-select" onchange="updateComponentProperty('align', this.value)">
                            <option value="center" selected>Center</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                `,
                text: `
                    <div class="form-group">
                        <label class="form-label">Heading</label>
                        <input type="text" class="form-input" value="Your Custom Text" onchange="updateComponentProperty('heading', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Content</label>
                        <textarea class="form-input" rows="4" onchange="updateComponentProperty('content', this.value)">Add your custom text here...</textarea>
                    </div>
                `,
                image: `
                    <div class="form-group">
                        <label class="form-label">Image Source</label>
                        <input type="file" class="form-input" accept="image/*" onchange="updateComponentProperty('image', this.files[0])">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Alt Text</label>
                        <input type="text" class="form-input" placeholder="Description of image" onchange="updateComponentProperty('alt', this.value)">
                    </div>
                `
            };
            
            return properties[type] || '<p style="color: var(--gray); font-size: 0.875rem;">No properties available for this component.</p>';
        }
        
        function updateComponentProperty(property, value) {
            if (!selectedBuilderComponent) return;
            
            const component = document.querySelector(`[data-component-id="${selectedBuilderComponent}"]`);
            if (component) {
                // Update component based on property
                // This would be expanded in a real implementation
                console.log(`Updating ${property} to ${value}`);
            }
        }
        
        function removeBuilderComponent(componentId) {
            const component = document.querySelector(`[data-component-id="${componentId}"]`);
            if (component) {
                component.remove();
                builderComponents = builderComponents.filter(c => c.id !== componentId);
                
                // Show placeholder if no components left
                if (builderComponents.length === 0) {
                    document.getElementById('canvasPlaceholder').style.display = 'block';
                }
                
                // Clear properties panel
                document.getElementById('builderPropertyPanel').innerHTML = `
                    <p style="color: var(--gray); font-size: 0.875rem;">
                        Select a component to edit its properties
                    </p>
                `;
            }
        }
        
        function previewBuiltPage() {
            const canvas = document.getElementById('builderCanvas');
            const content = canvas.innerHTML;
            
            const previewWindow = window.open('', 'builderPreview', 'width=1200,height=800');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Page Builder Preview</title>
                    <style>
                        body { 
                            font-family: Inter, sans-serif; 
                            margin: 0; 
                            padding: 0;
                            background: #f5f5f5;
                        }
                        .builder-component { 
                            margin: 0; 
                            background: white;
                        }
                        .builder-component:hover { border: none !important; }
                        button { display: none; }
                        :root {
                            --primary: #3b82f6;
                            --success: #10b981;
                            --gray: #6b7280;
                            --gray-light: #d1d5db;
                            --gray-lighter: #f9fafb;
                        }
                        .btn {
                            padding: 0.5rem 1rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            background: white;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
                        .btn-outline { background: transparent; color: var(--primary); border-color: var(--primary); }
                        .form-input, .form-select {
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 1rem;
                        }
                        .form-label {
                            display: block;
                            margin-bottom: 0.5rem;
                            font-weight: 600;
                        }
                        .form-group {
                            margin-bottom: 1rem;
                        }
                    </style>
                </head>
                <body>
                    ${content.replace(/<button[^>]*class="[^"]*remove[^"]*"[^>]*>.*?<\/button>/g, '')}
                </body>
                </html>
            `);
        }
        
        function exportBuiltPage() {
            const canvas = document.getElementById('builderCanvas');
            const components = canvas.querySelectorAll('.builder-component');
            
            let html = generateBuiltPageHTML(components);
            
            // Download as HTML file
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'custom-booking-page.html';
            a.click();
            
            URL.revokeObjectURL(url);
            
            showModal({
                title: '📥 Export Complete',
                message: 'Your custom booking page has been exported as an HTML file.',
                type: 'success'
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // START HERE INDICATOR FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function initStartHereIndicators() {
            const clickedIndicators = NewcoData.get('clickedStartHereIndicators') || [];
            
            // Add click listeners to all nav items with Start Here indicators
            document.querySelectorAll('.nav-item').forEach(navItem => {
                const indicator = navItem.querySelector('.start-here-indicator');
                if (indicator) {
                    const section = navItem.getAttribute('data-section');
                    
                    // Hide if already clicked
                    if (clickedIndicators.includes(section)) {
                        indicator.style.display = 'none';
                    }
                    
                    // Add click listener
                    navItem.addEventListener('click', function() {
                        if (!clickedIndicators.includes(section)) {
                            indicator.classList.add('clicked');
                            clickedIndicators.push(section);
                            NewcoData.set('clickedStartHereIndicators', clickedIndicators);
                            
                            // Remove after animation
                            setTimeout(() => {
                                indicator.style.display = 'none';
                            }, 500);
                        }
                    });
                }
            });
        }

        function generateBuiltPageHTML(components) {
            return '<html><head><title>Booking Page</title></head><body><h1>Booking Page</h1></body></html>';
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // SOCIAL MEDIA FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        // Social Media Functions
        function refreshSocialStats() {
            showModal({
                title: '🔄 Refreshing Stats',
                message: 'Fetching latest Twitter analytics data...',
                type: 'info'
            });
            
            // Simulate refresh with new random data
            setTimeout(() => {
                document.getElementById('twitterTotalPosts').textContent = Math.floor(Math.random() * 50 + 230);
                document.getElementById('twitterAvgEngagement').textContent = (Math.random() * 2 + 3.5).toFixed(1) + '%';
                document.getElementById('twitterImpressions').textContent = (Math.random() * 20 + 45).toFixed(1) + 'K';
                document.getElementById('twitterNewFollowers').textContent = Math.floor(Math.random() * 50 + 150);
                
                showModal({
                    title: '✅ Stats Updated',
                    message: 'Twitter analytics have been refreshed with the latest data.',
                    type: 'success'
                });
            }, 1500);
        }

        function schedulePost() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = '📅 Schedule Social Media Post';
            modalBody.innerHTML = `
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Platform</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" checked> 
                                <span style="color: #1DA1F2;">🐦 Twitter</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox"> 
                                <span style="color: #1877f2;">📘 Facebook</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox"> 
                                <span style="color: #E4405F;">📷 Instagram</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Schedule Date</label>
                        <input type="date" class="form-input" id="postDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Schedule Time</label>
                        <input type="time" class="form-input" id="postTime" value="10:00">
                    </div>
                    
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Post Content</label>
                        <textarea class="form-input" id="postContent" rows="4" placeholder="What's happening at the bingo hall?" style="resize: vertical;"></textarea>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                            <span>Character count: <span id="charCount">0</span>/280</span>
                            <span>Add: 📷 🎥 📊 🔗</span>
                        </div>
                    </div>
                    
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Add Promotion</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="form-select" id="postPromotion" style="flex: 1;">
                                <option value="">No promotion</option>
                                <option value="promo1">🎉 Friday Night Special - 20% off all packages</option>
                                <option value="promo2">🎂 Birthday Month - Free dauber set</option>
                                <option value="promo3">💰 Mega Jackpot - $10,000 prize pool</option>
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="insertPromotion()">
                                Insert
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Hashtags</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="postHashtags" placeholder="#bingo #jackpot #winners" value="${NewcoData.get('socialHashtags')?.default || '#bingo #vanguardbingo'}" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="applyHashtagPreset('default')">Default</button>
                            <button type="button" class="btn btn-secondary" onclick="applyHashtagPreset('promotion')">Promo</button>
                            <button type="button" class="btn btn-secondary" onclick="applyHashtagPreset('event')">Event</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Character counter
            const contentField = document.getElementById('postContent');
            const charCount = document.getElementById('charCount');
            contentField.addEventListener('input', () => {
                charCount.textContent = contentField.value.length;
                charCount.style.color = contentField.value.length > 280 ? 'var(--danger)' : 'var(--gray)';
            });
            
            modalSaveBtn.textContent = 'Schedule Post';
            modalSaveBtn.onclick = () => {
                const content = document.getElementById('postContent').value;
                const date = document.getElementById('postDate').value;
                const time = document.getElementById('postTime').value;
                
                if (!content) {
                    showModal({
                        title: '⚠️ Missing Content',
                        message: 'Please enter post content before scheduling.',
                        type: 'warning'
                    });
                    return;
                }
                
                // Save scheduled post
                const scheduledPosts = NewcoData.get('scheduledPosts') || [];
                scheduledPosts.push({
                    id: Date.now().toString(),
                    content: content,
                    date: date,
                    time: time,
                    platforms: ['twitter'],
                    status: 'scheduled'
                });
                NewcoData.set('scheduledPosts', scheduledPosts);
                
                closeModal();
                showModal({
                    title: '✅ Post Scheduled',
                    message: `Your post has been scheduled for ${date} at ${time}.`,
                    type: 'success'
                });
                
                // Refresh scheduled posts display
                loadScheduledPosts();
            };
            
            modal.classList.add('active');
        }

        function addScheduledPost() {
            schedulePost();
        }

        function editScheduledPost(id) {
            showModal({
                title: '✏️ Edit Scheduled Post',
                message: 'Edit functionality would open the post editor with existing content.',
                type: 'info'
            });
        }

        function deleteScheduledPost(id) {
            showModal({
                type: 'confirm',
                title: '🗑️ Delete Scheduled Post',
                message: 'Are you sure you want to delete this scheduled post?',
                confirmText: 'Delete',
                cancelText: 'Cancel',
                onConfirm: () => {
                    showModal({
                        title: '✅ Post Deleted',
                        message: 'The scheduled post has been removed.',
                        type: 'success'
                    });
                }
            });
        }

        function updateTwitterTimeframe(days) {
            // Update stats based on timeframe
            refreshSocialStats();
        }

        function updateTopPostsTimeframe(period) {
            // Update top posts based on period
            showModal({
                title: '📊 Updating Top Posts',
                message: `Loading top performing posts for: ${period}`,
                type: 'info'
            });
        }

        function exportTwitterHistory() {
            showModal({
                title: '📥 Export Twitter History',
                message: 'Your Twitter post history has been exported to CSV format.',
                type: 'success'
            });
        }

        function loadScheduledPosts() {
            const scheduledPosts = NewcoData.get('scheduledPosts') || [];
            // Update the scheduled posts display
            // This would refresh the scheduledPostsContainer with latest data
        }
        
        function saveHashtags() {
            const hashtags = {
                default: document.getElementById('defaultHashtags').value,
                promotion: document.getElementById('promotionHashtags').value,
                event: document.getElementById('eventHashtags').value
            };
            NewcoData.set('socialHashtags', hashtags);
            showModal({
                title: '✅ Hashtags Saved',
                message: 'Your hashtag presets have been saved.',
                type: 'success'
            });
        }
        
        function applyHashtagPreset(type) {
            const hashtags = NewcoData.get('socialHashtags') || {
                default: '#bingo #vanguardbingo',
                promotion: '#special #promotion',
                event: '#jackpot #tournament'
            };
            
            const hashtagField = document.getElementById('postHashtags');
            if (hashtagField) {
                const currentTags = hashtagField.value;
                const newTags = hashtags[type] || '';
                
                // Add to existing tags if not already present
                const combinedTags = [...new Set([...currentTags.split(' '), ...newTags.split(' ')])].join(' ');
                hashtagField.value = combinedTags;
            }
        }
        
        function insertPromotion() {
            const promotionSelect = document.getElementById('postPromotion');
            const contentField = document.getElementById('postContent');
            
            if (promotionSelect && contentField && promotionSelect.value) {
                // Get promotion text
                const selectedOption = promotionSelect.options[promotionSelect.selectedIndex];
                const promotionText = selectedOption.text.replace(/^[^\s]+ /, ''); // Remove emoji
                
                // Add to content
                if (contentField.value) {
                    contentField.value += '\n\n🎊 ' + promotionText;
                } else {
                    contentField.value = '🎊 ' + promotionText;
                }
                
                // Update character count
                const charCount = document.getElementById('charCount');
                if (charCount) {
                    charCount.textContent = contentField.value.length;
                    charCount.style.color = contentField.value.length > 280 ? 'var(--danger)' : 'var(--gray)';
                }
                
                // Add promotion hashtags
                applyHashtagPreset('promotion');
                
                // Reset selection
                promotionSelect.value = '';
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // UNIFIED NOTIFICATION SYSTEM - Beautiful modals and toasts
        // ═══════════════════════════════════════════════════════════════════
        
        const notify = (function() {
            let stylesInitialized = false;
            
            function initStyles() {
                if (stylesInitialized) return;
                stylesInitialized = true;
                
                const styles = `
                    /* Modal Styles */
                    .notify-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.6);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: notifyFadeIn 0.2s ease-out;
                        backdrop-filter: blur(4px);
                    }
                    
                    .notify-modal {
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        max-width: 500px;
                        width: 90%;
                        max-height: 90vh;
                        overflow: hidden;
                        animation: notifySlideUp 0.3s ease-out;
                    }
                    
                    .notify-modal-header {
                        padding: 1.5rem;
                        border-bottom: 1px solid #e5e7eb;
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                    }
                    
                    .notify-modal-icon {
                        width: 24px;
                        height: 24px;
                        flex-shrink: 0;
                    }
                    
                    .notify-modal-title {
                        font-size: 1.25rem;
                        font-weight: 600;
                        color: #111827;
                        margin: 0;
                        flex: 1;
                    }
                    
                    .notify-modal-close {
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        color: #6b7280;
                        cursor: pointer;
                        padding: 0;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 6px;
                        transition: all 0.2s;
                    }
                    
                    .notify-modal-close:hover {
                        background: #f3f4f6;
                        color: #111827;
                    }
                    
                    .notify-modal-body {
                        padding: 1.5rem;
                        color: #4b5563;
                        line-height: 1.6;
                        max-height: 60vh;
                        overflow-y: auto;
                    }
                    
                    .notify-modal-footer {
                        padding: 1rem 1.5rem;
                        border-top: 1px solid #e5e7eb;
                        display: flex;
                        gap: 0.75rem;
                        justify-content: flex-end;
                    }
                    
                    .notify-btn {
                        padding: 0.625rem 1.25rem;
                        border-radius: 8px;
                        font-size: 0.875rem;
                        font-weight: 500;
                        border: none;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-family: inherit;
                    }
                    
                    .notify-btn-primary {
                        background: #2ea3f2;
                        color: white;
                    }
                    
                    .notify-btn-primary:hover {
                        background: #1e8ed8;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(46, 163, 242, 0.3);
                    }
                    
                    .notify-btn-secondary {
                        background: #f3f4f6;
                        color: #4b5563;
                    }
                    
                    .notify-btn-secondary:hover {
                        background: #e5e7eb;
                    }
                    
                    .notify-btn-danger {
                        background: #ef4444;
                        color: white;
                    }
                    
                    .notify-btn-danger:hover {
                        background: #dc2626;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                    }
                    
                    /* Toast Styles */
                    .notify-toast-container {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10001;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        pointer-events: none;
                    }
                    
                    .notify-toast {
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
                        padding: 1rem 1.25rem;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        min-width: 320px;
                        max-width: 420px;
                        animation: notifySlideIn 0.3s ease-out;
                        pointer-events: all;
                        border-left: 4px solid;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    
                    .notify-toast:hover {
                        transform: translateX(-5px);
                        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.18);
                    }
                    
                    .notify-toast.removing {
                        animation: notifySlideOut 0.3s ease-in;
                    }
                    
                    .notify-toast-success {
                        border-left-color: #10b981;
                    }
                    
                    .notify-toast-error {
                        border-left-color: #ef4444;
                    }
                    
                    .notify-toast-warning {
                        border-left-color: #f59e0b;
                    }
                    
                    .notify-toast-info {
                        border-left-color: #3b82f6;
                    }
                    
                    .notify-toast-icon {
                        width: 20px;
                        height: 20px;
                        flex-shrink: 0;
                    }
                    
                    .notify-toast-content {
                        flex: 1;
                    }
                    
                    .notify-toast-title {
                        font-weight: 600;
                        color: #111827;
                        margin-bottom: 0.125rem;
                        font-size: 0.95rem;
                    }
                    
                    .notify-toast-message {
                        color: #6b7280;
                        font-size: 0.875rem;
                        line-height: 1.4;
                    }
                    
                    .notify-toast-close {
                        width: 20px;
                        height: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #9ca3af;
                        cursor: pointer;
                        border-radius: 4px;
                        transition: all 0.2s;
                        flex-shrink: 0;
                    }
                    
                    .notify-toast-close:hover {
                        background: #f3f4f6;
                        color: #4b5563;
                    }
                    
                    /* Icons */
                    .notify-icon-success {
                        color: #10b981;
                    }
                    
                    .notify-icon-error {
                        color: #ef4444;
                    }
                    
                    .notify-icon-warning {
                        color: #f59e0b;
                    }
                    
                    .notify-icon-info {
                        color: #3b82f6;
                    }
                    
                    /* Animations */
                    @keyframes notifyFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes notifySlideUp {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    
                    @keyframes notifySlideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    @keyframes notifySlideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                    
                    /* Responsive */
                    @media (max-width: 640px) {
                        .notify-toast-container {
                            left: 10px;
                            right: 10px;
                            top: 10px;
                        }
                        
                        .notify-toast {
                            min-width: auto;
                            max-width: 100%;
                        }
                        
                        .notify-modal {
                            width: 95%;
                            margin: 1rem;
                        }
                    }
                `;
                
                const styleSheet = document.createElement('style');
                styleSheet.textContent = styles;
                document.head.appendChild(styleSheet);
            }
            
            // Icons as SVG strings
            const icons = {
                success: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
                error: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>',
                warning: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
                info: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>',
                close: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>'
            };
            
            let toastContainer = null;
            
            function getToastContainer() {
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'notify-toast-container';
                    document.body.appendChild(toastContainer);
                }
                return toastContainer;
            }
            
            function showToast(type, message, title = null, duration = 4000) {
                initStyles();
                
                const toast = document.createElement('div');
                toast.className = `notify-toast notify-toast-${type}`;
                
                const iconClass = `notify-icon-${type}`;
                const defaultTitles = {
                    success: 'Success',
                    error: 'Error',
                    warning: 'Warning',
                    info: 'Info'
                };
                
                toast.innerHTML = `
                    <div class="notify-toast-icon ${iconClass}">
                        ${icons[type]}
                    </div>
                    <div class="notify-toast-content">
                        ${title || defaultTitles[type] ? `<div class="notify-toast-title">${title || defaultTitles[type]}</div>` : ''}
                        <div class="notify-toast-message">${message}</div>
                    </div>
                    <div class="notify-toast-close">
                        ${icons.close}
                    </div>
                `;
                
                const container = getToastContainer();
                container.appendChild(toast);
                
                let removeTimeout;
                const removeToast = () => {
                    toast.classList.add('removing');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                };
                
                removeTimeout = setTimeout(removeToast, duration);
                
                toast.addEventListener('click', () => {
                    clearTimeout(removeTimeout);
                    removeToast();
                });
                
                return toast;
            }
            
            function showModal(options) {
                initStyles();
                
                const overlay = document.createElement('div');
                overlay.className = 'notify-overlay';
                
                const modal = document.createElement('div');
                modal.className = 'notify-modal';
                
                let modalHTML = '';
                
                if (options.title) {
                    const iconHTML = options.icon ? `
                        <div class="notify-modal-icon notify-icon-${options.type || 'info'}">
                            ${icons[options.type] || icons.info}
                        </div>
                    ` : '';
                    
                    modalHTML += `
                        <div class="notify-modal-header">
                            ${iconHTML}
                            <h2 class="notify-modal-title">${options.title}</h2>
                            ${options.closeButton !== false ? `
                                <button class="notify-modal-close">
                                    ${icons.close}
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                modalHTML += `
                    <div class="notify-modal-body">
                        ${options.content || options.message || ''}
                    </div>
                `;
                
                if (options.buttons || options.onConfirm) {
                    modalHTML += '<div class="notify-modal-footer">';
                    
                    if (options.buttons) {
                        options.buttons.forEach(button => {
                            modalHTML += `
                                <button class="notify-btn notify-btn-${button.type || 'secondary'}" 
                                        data-action="${button.action}">
                                    ${button.text}
                                </button>
                            `;
                        });
                    } else if (options.onConfirm) {
                        modalHTML += `
                            <button class="notify-btn notify-btn-secondary" data-action="cancel">
                                ${options.cancelText || 'Cancel'}
                            </button>
                            <button class="notify-btn notify-btn-${options.confirmType || 'primary'}" data-action="confirm">
                                ${options.confirmText || 'Confirm'}
                            </button>
                        `;
                    }
                    
                    modalHTML += '</div>';
                }
                
                modal.innerHTML = modalHTML;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                const closeModal = () => {
                    overlay.style.animation = 'notifyFadeIn 0.2s ease-out reverse';
                    modal.style.animation = 'notifySlideUp 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 200);
                };
                
                const closeBtn = modal.querySelector('.notify-modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeModal);
                }
                
                modal.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        
                        if (action === 'cancel') {
                            if (options.onCancel) options.onCancel();
                            closeModal();
                        } else if (action === 'confirm') {
                            if (options.onConfirm) options.onConfirm();
                            closeModal();
                        } else if (options.buttons) {
                            const button = options.buttons.find(b => b.action === action);
                            if (button && button.handler) {
                                button.handler();
                            }
                            if (button && button.close !== false) {
                                closeModal();
                            }
                        }
                    });
                });
                
                if (options.closeOnOverlay !== false) {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            closeModal();
                        }
                    });
                }
                
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                return { overlay, modal, close: closeModal };
            }
            
            return {
                success(message, title) {
                    return showToast('success', message, title);
                },
                
                error(message, title) {
                    return showToast('error', message, title);
                },
                
                warning(message, title) {
                    return showToast('warning', message, title);
                },
                
                info(message, title) {
                    return showToast('info', message, title);
                },
                
                toast(type, message, title, duration) {
                    return showToast(type, message, title, duration);
                },
                
                modal(options) {
                    return showModal(options);
                },
                
                confirm(message, onConfirm, onCancel, options = {}) {
                    return showModal({
                        title: options.title || 'Confirm',
                        message,
                        type: 'warning',
                        icon: true,
                        onConfirm,
                        onCancel,
                        confirmText: options.confirmText,
                        cancelText: options.cancelText,
                        confirmType: options.dangerous ? 'danger' : 'primary'
                    });
                },
                
                alert(message, title = 'Alert', type = 'info') {
                    return showModal({
                        title,
                        message,
                        type,
                        icon: true,
                        buttons: [
                            { text: 'OK', type: 'primary', action: 'ok' }
                        ]
                    });
                }
            };
        })();
        
        // Replace old notification functions with new ones
        window.showSuccess = (msg) => notify.success(msg);
        window.showError = (msg) => notify.error(msg);
        window.showWarning = (msg) => notify.warning(msg);
        window.showInfo = (msg) => notify.info(msg);
        window.showAlert = (msg, type) => {
            if (type === 'success') notify.success(msg);
            else if (type === 'error') notify.error(msg);
            else if (type === 'warning') notify.warning(msg);
            else notify.info(msg);
        };
        
        // Update showConfirm to use new system but keep compatibility
        const oldShowConfirm = window.showConfirm;
        window.showConfirm = (msg, onYes, title) => {
            notify.confirm(msg, onYes, null, { title });
        };

        // ═══════════════════════════════════════════════════════════
        // [ADMIN-AUTH] - Password Protection
        // ═══════════════════════════════════════════════════════════

        async function checkAdminPassword(event) {
            event.preventDefault();

            const email = document.getElementById('adminEmailInput').value.trim().toLowerCase();
            const password = document.getElementById('adminPasswordInput').value;
            const customerId = NewcoData.get('customerId') || new URLSearchParams(window.location.search).get('customer');

            // Get admin users object (stores passwords per email)
            const adminUsers = NewcoData.get('adminUsers') || {};

            let isValidPassword = false;
            let isSuperAdmin = false;
            let isFirstLogin = false;
            let superAdminEmail = null;

            // Check Master Portal admin credentials first (NewCo employees)
            const masterPortalUsers = NewcoData.get('masterPortalUsers') || [];
            const masterUser = masterPortalUsers.find(u => u.email && u.email.toLowerCase() === email);

            if (masterUser) {
                // Check password for master portal user
                const masterAdminPasswords = NewcoData.get('masterAdminPasswords') || {};
                if (masterAdminPasswords[email] && password === masterAdminPasswords[email]) {
                    isValidPassword = true;
                    isSuperAdmin = true; // Grant super admin access to all client portals
                } else if (masterUser.password && password === masterUser.password) {
                    // Check if password is stored in user object
                    isValidPassword = true;
                    isSuperAdmin = true;
                }
            }

            // Check Super Admin from Supabase
            try {
                const accountResponse = await fetch(
                    `${NewcoData.supabaseUrl}/rest/v1/accounts?customer_id=eq.${customerId}&select=email,organization_name,password_hash`,
                    {
                        headers: {
                            'apikey': NewcoData.supabaseKey,
                            'Authorization': `Bearer ${NewcoData.supabaseKey}`
                        }
                    }
                );
                const accounts = await accountResponse.json();

                if (accounts && accounts.length > 0) {
                    superAdminEmail = accounts[0].email.toLowerCase();
                    const passwordHash = accounts[0].password_hash;

                    // Check if this is the super admin logging in
                    if (email === superAdminEmail) {
                        isSuperAdmin = true;

                        // Check password from Supabase first (set during account creation)
                        if (passwordHash) {
                            const enteredPasswordHash = btoa(password);
                            if (enteredPasswordHash === passwordHash) {
                                isValidPassword = true;
                            }
                        }
                        // Check if super admin has set a password in localStorage
                        else if (adminUsers[email]) {
                            // Use their custom password
                            if (password === adminUsers[email]) {
                                isValidPassword = true;
                            }
                        } else {
                            // First login: email as password
                            if (password === superAdminEmail) {
                                isValidPassword = true;
                                isFirstLogin = true;
                            }
                        }
                    }
                }
            } catch (err) {
                console.error('Error checking super admin:', err);
            }

            // If not super admin, check if they're in the staff list
            if (!isSuperAdmin) {
                const staff = NewcoData.get('staff') || [];
                const staffMember = staff.find(s => s.email && s.email.toLowerCase() === email);

                if (staffMember) {
                    // Check if staff member has set a password
                    if (adminUsers[email]) {
                        // Use their custom password
                        if (password === adminUsers[email]) {
                            isValidPassword = true;
                        }
                    } else {
                        // First login: email as password
                        if (password === email) {
                            isValidPassword = true;
                            isFirstLogin = true;
                        }
                    }
                }
            }

            if (isValidPassword) {
                // Store auth session
                sessionStorage.setItem('newco_admin_authenticated', 'true');
                sessionStorage.setItem('newco_admin_email', email);

                // Update last_login timestamp in Supabase if this is the super admin
                if (isSuperAdmin) {
                    try {
                        await fetch(
                            `${NewcoData.supabaseUrl}/rest/v1/accounts?customer_id=eq.${customerId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': NewcoData.supabaseKey,
                                    'Authorization': `Bearer ${NewcoData.supabaseKey}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify({ last_login: new Date().toISOString() })
                            }
                        );
                    } catch (err) {
                        console.error('Error updating last login:', err);
                    }
                }

                // If first login, prompt for password change
                if (isFirstLogin) {
                    showPasswordChangeModal(email);
                } else {
                    // Hide login, show admin panel
                    document.getElementById('adminLoginScreen').style.display = 'none';
                    document.getElementById('adminMainPanel').style.display = 'flex';
                }

                return false;
            } else {
                // Show error
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'Invalid email or password. Please try again.';
                errorDiv.style.display = 'block';

                // Clear password field
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();

                return false;
            }
        }

        function showPasswordChangeModal(userEmail) {
            // Hide login screen
            document.getElementById('adminLoginScreen').style.display = 'none';

            // Create password change modal
            const modal = document.createElement('div');
            modal.id = 'passwordChangeModal';
            modal.style.cssText = 'display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;';

            modal.innerHTML = `
                <div style="background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 100%;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🔐</div>
                        <h1 style="margin: 0; font-size: 1.75rem; color: #1f2937;">Set Your Admin Password</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #6b7280;">This is your first login. Please set a secure password.</p>
                    </div>
                    <form id="passwordChangeForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">New Password</label>
                            <input
                                type="password"
                                id="newPassword"
                                placeholder="Enter new password"
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                                required
                                autofocus
                                minlength="8"
                            >
                            <small style="color: #6b7280; font-size: 0.75rem;">Minimum 8 characters</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Confirm Password</label>
                            <input
                                type="password"
                                id="confirmPassword"
                                placeholder="Confirm new password"
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                                required
                                minlength="8"
                            >
                        </div>
                        <div id="passwordChangeError" style="color: #dc2626; font-size: 0.875rem; text-align: center; display: none;"></div>
                        <button
                            type="submit"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.875rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                            onmouseover="this.style.transform='translateY(-2px)'"
                            onmouseout="this.style.transform='translateY(0)'"
                        >
                            Set Password
                        </button>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('passwordChangeForm').onsubmit = function(e) {
                e.preventDefault();

                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const errorDiv = document.getElementById('passwordChangeError');

                if (newPassword.length < 8) {
                    errorDiv.textContent = 'Password must be at least 8 characters.';
                    errorDiv.style.display = 'block';
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'Passwords do not match.';
                    errorDiv.style.display = 'block';
                    return false;
                }

                // Save new password for this specific user
                const adminUsers = NewcoData.get('adminUsers') || {};
                adminUsers[userEmail] = newPassword;
                NewcoData.set('adminUsers', adminUsers);

                // Remove modal
                modal.remove();

                // Show admin panel
                document.getElementById('adminMainPanel').style.display = 'block';

                // Show success notification
                if (window.notify) {
                    notify.success('Password successfully set!');
                }

                return false;
            };
        }

        // Check if already authenticated and load organization name
        window.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = sessionStorage.getItem('newco_admin_authenticated');
            const customerId = NewcoData.get('customerId') || new URLSearchParams(window.location.search).get('customer');

            // Load and display organization name
            try {
                const accountResponse = await fetch(
                    `${NewcoData.supabaseUrl}/rest/v1/accounts?customer_id=eq.${customerId}&select=organization_name`,
                    {
                        headers: {
                            'apikey': NewcoData.supabaseKey,
                            'Authorization': `Bearer ${NewcoData.supabaseKey}`
                        }
                    }
                );
                const accounts = await accountResponse.json();

                if (accounts && accounts.length > 0 && accounts[0].organization_name) {
                    document.getElementById('orgNameDisplay').textContent = accounts[0].organization_name;
                } else {
                    document.getElementById('orgNameDisplay').textContent = 'Admin Portal';
                }
            } catch (err) {
                document.getElementById('orgNameDisplay').textContent = 'Admin Portal';
            }

            if (isAuthenticated === 'true') {
                // Already logged in
                document.getElementById('adminLoginScreen').style.display = 'none';
                document.getElementById('adminMainPanel').style.display = 'flex';

                // Apply branding colors after showing main panel
                setTimeout(() => applyBrandingColors(), 100);
            } else {
                // Check if any users have passwords set
                const adminUsers = NewcoData.get('adminUsers') || {};
                const hasAnyPasswords = Object.keys(adminUsers).length > 0;

                if (!hasAnyPasswords) {
                    // No passwords set yet - show first-time hint
                    document.getElementById('firstTimeHint').style.display = 'block';
                    document.getElementById('passwordHint').style.display = 'block';
                }
            }
        });

        // Add logout function
        window.logoutAdmin = function() {
            sessionStorage.removeItem('newco_admin_authenticated');
            document.getElementById('adminLoginScreen').style.display = 'flex';
            document.getElementById('adminMainPanel').style.display = 'none';
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        };
    </script>
    </div> <!-- Close adminMainPanel -->
</body>
</html>