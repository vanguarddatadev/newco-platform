<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - NewCo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Loading Screen - Always visible first */
        #initialLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s ease-out;
        }

        #initialLoader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        .loader-text {
            color: white;
            font-size: 1.25rem;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide main content initially */
        body {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        body.loaded {
            opacity: 1;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #10b981;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .form-toggle-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-toggle-group .form-label {
            margin: 0;
            flex: 1;
        }
        
        .form-toggle-group .toggle-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Art Library Styles */
        .art-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .art-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .art-card-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f8f9fa;
            padding: 1rem;
        }

        .art-card-info {
            padding: 1rem;
        }

        .art-card-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: var(--dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .art-card-meta {
            font-size: 0.75rem;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .art-card-category {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--light-gray);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary);
        }

        .art-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .art-card-actions button {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .art-card-delete {
            background: #fee;
            color: var(--danger);
        }

        .art-card-delete:hover {
            background: var(--danger);
            color: white;
        }
    </style>
    
    <!-- 
    ╔═══════════════════════════════════════════════════════════════════╗
    ║              NEWCO ADMIN PANEL - COMPLETE CONTROL CENTER            ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║ FILE: bms-admin-new.html (13,543 lines)                          ║
    ║ PURPOSE: Central administration for entire NewCo ecosystem          ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║                                                                   ║
    ║ FILE STRUCTURE:                                                   ║
    ║ • Lines 9-73:       Toggle switch styles (critical inline CSS)   ║
    ║ • Lines 75-500:     NewcoData storage system                  ║
    ║ • Line 500:         Link to newco-admin.css (1,098 lines)          ║
    ║ • Lines 501-2800:   HTML structure & sidebar                     ║
    ║ • Lines 2800-8200:  Content sections (all modules)               ║
    ║ • Lines 8200-13543: JavaScript functions & event handlers        ║
    ║                                                                   ║
    ║ EXTERNAL DEPENDENCIES:                                            ║
    ║ • newco-admin.css     - All component styles (1,098 lines)         ║
    ║ • Google Fonts      - Inter font family                          ║
    ║ • No frameworks     - Pure vanilla JS/HTML/CSS                   ║
    ║                                                                   ║
    ║ KEY SECTIONS (use Ctrl+F to navigate):                           ║
    ║ • [VANGUARD-DATA]   - LocalStorage data layer (Line 123)         ║
    ║ • [DASHBOARD]       - Stats & quick actions                      ║
    ║ • [ORGANIZATION]    - Branding & basic settings                  ║
    ║ • [STAFF-MGMT]      - Staff users & permissions                  ║
    ║ • [MEMBERS-MGMT]    - Customer database                          ║
    ║ • [HALLS-LAYOUT]    - Hall configuration & seat designer         ║
    ║ • [SESSION-WIZARD]  - Session creation wizard                    ║
    ║ • [SCHEDULE-MGMT]   - Calendar & scheduling                      ║
    ║ • [PACKAGES-ITEMS]  - Products & pricing                         ║
    ║ • [REWARDS-SYSTEM]  - Loyalty points & tiers                     ║
    ║ • [TRANSACTIONS]    - Sales & transaction logs                   ║
    ║ • [REPORTS]         - Analytics & reporting                      ║
    ║ • [WEB-BUILDER]     - Customer website generator                 ║
    ║ • [ACTIONS-LOG]     - Audit trail & history                      ║
    ║                                                                   ║
    ║ DATA FLOW:                                                        ║
    ║ • WRITES TO: All newco_ localStorage keys                     ║
    ║ • CONSUMED BY:                                                    ║
    ║   - newco-customer-demo-v2.2.html (public website)               ║
    ║   - newco-redemption-v2.2.html (POS system)                      ║
    ║   - newco-floor-runner-v2.2.html (cash rewards)                  ║
    ║                                                                   ║
    ║ TECHNICAL STATUS:                                                 ║
    ║ ✅ COMPLETED:                                                     ║
    ║ • CSS extracted to external file                                 ║
    ║ • Full CRUD operations for all entities                          ║
    ║ • Real-time preview for website builder                          ║
    ║ • Comprehensive audit logging                                    ║
    ║                                                                   ║
    ║ 🔴 CRITICAL IMPROVEMENTS NEEDED:                                 ║
    ║ • Split into modules (too monolithic at 13K+ lines)              ║
    ║ • Add authentication system                                      ║
    ║ • Migrate to IndexedDB (localStorage limits)                     ║
    ║                                                                   ║
    ║ 🟡 ENHANCEMENTS:                                                 ║
    ║ • Add TypeScript for type safety                                 ║
    ║ • Implement lazy loading for sections                            ║
    ║ • Add data validation layer                                      ║
    ║ • Create reusable components                                     ║
    ║ • Add unit tests                                                 ║
    ║                                                                   ║
    ║ DEVELOPER NOTES:                                                  ║
    ║ • Each section is self-contained with its own load function      ║
    ║ • NewcoData handles all localStorage operations               ║
    ║ • Actions are logged automatically via NewcoData.set()        ║
    ║ • Theme colors are CSS variables, updated dynamically            ║
    ╚═══════════════════════════════════════════════════════════════════╝
    -->

    <script src="newco-supabase.js"></script>
    <script src="newco-art-picker.js"></script>
    <script src="newco-payment-processor.js"></script>
    <script>
        /*
        // [VANGUARD-DATA] - Embedded NewcoData - REPLACED WITH SUPABASE VERSION
        const NewcoData = {
            DB_PREFIX: 'newco_',
            
            init() {
                const defaults = {
                    organization: {
                        name: '',
                        logo: '',
                        address: '',
                        phone: '',
                        email: '',
                        website: '',
                        tagline: 'Your Premier Bingo Destination',
                        colors: {
                            primary: '#667eea',
                            secondary: '#f59e0b',
                            accent: '#48bb78'
                        }
                    },
                    halls: [],
                    sessions: [],
                    packages: [],
                    rewards: {
                        items: [],
                        coupons: [],
                        pointsConfig: {
                            dollarToPoints: 10,
                            bonusRules: []
                        }
                    },
                    schedule: {
                        weekly: {},
                        special: []
                    },
                    settings: {
                        timezone: 'America/Los_Angeles',
                        currency: 'USD',
                        dateFormat: 'MM/DD/YYYY'
                    }
                };
                
                Object.keys(defaults).forEach(key => {
                    if (!this.get(key)) {
                        this.set(key, defaults[key]);
                    }
                });
            },
            
            get(key) {
                try {
                    const data = localStorage.getItem(this.DB_PREFIX + key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Error reading data:', e);
                    return null;
                }
            },
            
            set(key, value, skipLogging = false, detailMessage = null) {
                try {
                    const jsonString = JSON.stringify(value);
                    
                    // Art data should not be stored in localStorage - it's kept in memory only
                    // If data is still too large after removing art data, it indicates a problem
                    if (jsonString.length > 2000000) {
                        console.warn('Data too large for localStorage even without art data:', key, jsonString.length);
                        throw new Error('Data too large for localStorage');
                    } else {
                        // Get old value for comparison
                        const oldValue = this.get(key);
                        
                        localStorage.setItem(this.DB_PREFIX + key, jsonString);
                        
                        // Log the action unless explicitly skipped
                        if (!skipLogging && key !== 'actionsLog') {
                            let details = detailMessage || `Updated ${key}`;
                            
                            // Try to be more specific based on what changed
                            if (!detailMessage) {
                                details = this.getChangeDetails(key, oldValue, value);
                            }
                            
                            this.logAction('update', key, details);
                        }
                    }
                    return true;
                } catch (e) {
                    console.error('Error saving data:', e);
                    
                    // Try to clear old/unused data
                    this.clearOldData();
                    
                    // Try one more time
                    try {
                        localStorage.setItem(this.DB_PREFIX + key, JSON.stringify(value));
                        return true;
                    } catch (e2) {
                        // Silently fail - data just won't persist
                        console.warn('Could not save to localStorage');
                        return false;
                    }
                }
            },
            
            clearOldData() {
                // Clear old or temporary data to free up space
                const keysToCheck = ['temp_', 'backup_', 'old_', 'logo_data'];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && keysToCheck.some(prefix => key.includes(prefix))) {
                        localStorage.removeItem(key);
                    }
                }
            },
            
            getOrganization() {
                return this.get('organization');
            },
            
            updateOrganization(updates) {
                const org = this.getOrganization() || {};
                return this.set('organization', { ...org, ...updates });
            },
            
            getHalls() {
                return this.get('halls') || [];
            },
            
            getSessions() {
                return this.get('sessions') || [];
            },
            
            getPackages() {
                const packages = this.get('packages') || [];
                return packages.sort((a, b) => (a.order || 0) - (b.order || 0));
            },
            
            addPackage(pkg) {
                const packages = this.getPackages();
                pkg.id = pkg.id || Date.now().toString();
                packages.push(pkg);
                return this.set('packages', packages);
            },
            
            updatePackage(id, updates) {
                const packages = this.getPackages();
                const index = packages.findIndex(p => p.id === id);
                if (index !== -1) {
                    packages[index] = { ...packages[index], ...updates };
                    return this.set('packages', packages);
                }
                return false;
            },
            
            removePackage(id) {
                const packages = this.getPackages();
                const filtered = packages.filter(p => p.id !== id);
                return this.set('packages', filtered);
            },
            
            // Get detailed change description
            getChangeDetails(key, oldValue, newValue) {
                try {
                    switch(key) {
                        case 'organization':
                            const changes = [];
                            if (!oldValue) return 'Initial organization setup';
                            
                            if (oldValue.name !== newValue.name) {
                                changes.push(`Changed name from "${oldValue.name || 'none'}" to "${newValue.name}"`);
                            }
                            if (oldValue.tagline !== newValue.tagline) {
                                changes.push(`Updated tagline to "${newValue.tagline}"`);
                            }
                            if (oldValue.email !== newValue.email) {
                                changes.push(`Changed email to "${newValue.email}"`);
                            }
                            if (oldValue.phone !== newValue.phone) {
                                changes.push(`Changed phone to "${newValue.phone}"`);
                            }
                            if (oldValue.address !== newValue.address) {
                                changes.push(`Updated address`);
                            }
                            if (JSON.stringify(oldValue.colors) !== JSON.stringify(newValue.colors)) {
                                changes.push(`Changed theme colors`);
                            }
                            if (oldValue.logo !== newValue.logo) {
                                changes.push(`Updated logo`);
                            }
                            
                            return changes.length > 0 ? changes.join(', ') : 'Updated organization settings';
                            
                        case 'staff':
                            if (!oldValue || oldValue.length === 0) return 'Added first staff member';
                            if (newValue.length > oldValue.length) {
                                const newStaff = newValue[newValue.length - 1];
                                return `Added staff member: ${newStaff.name} (${newStaff.role})`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed staff member`;
                            }
                            return 'Updated staff information';
                            
                        case 'members':
                            if (!oldValue || oldValue.length === 0) return 'Added first member';
                            if (newValue.length > oldValue.length) {
                                const newMember = newValue[newValue.length - 1];
                                return `Added member: ${newMember.firstName} ${newMember.lastName}`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed member`;
                            }
                            return 'Updated member information';
                            
                        case 'packages':
                            if (!oldValue || oldValue.length === 0) return 'Created first package';
                            if (newValue.length > oldValue.length) {
                                const newPkg = newValue[newValue.length - 1];
                                return `Added package: ${newPkg.name} ($${newPkg.price})`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed package`;
                            }
                            return 'Modified package details';
                            
                        case 'salesItems':
                            if (!oldValue || oldValue.length === 0) return 'Added first sales item';
                            if (newValue.length > oldValue.length) {
                                const newItem = newValue[newValue.length - 1];
                                return `Added item: ${newItem.name} ($${newItem.price})`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed sales item`;
                            }
                            return 'Updated sales item';
                            
                        case 'halls':
                            if (!oldValue || oldValue.length === 0) return 'Created first hall';
                            if (newValue.length > oldValue.length) {
                                const newHall = newValue[newValue.length - 1];
                                return `Added hall: ${newHall.name}`;
                            }
                            if (newValue.length < oldValue.length) {
                                return `Removed hall`;
                            }
                            // Check for layout changes
                            for (let i = 0; i < newValue.length; i++) {
                                if (oldValue[i] && JSON.stringify(oldValue[i].layout) !== JSON.stringify(newValue[i].layout)) {
                                    return `Modified layout for ${newValue[i].name}`;
                                }
                            }
                            return 'Updated hall configuration';
                            
                        case 'schedules':
                            return 'Updated session schedule times';
                            
                        case 'rewardsConfig':
                            const rewardChanges = [];
                            if (!oldValue) return 'Initial rewards configuration';
                            
                            if (oldValue.basicSettings?.pointsPerDollar !== newValue.basicSettings?.pointsPerDollar) {
                                rewardChanges.push(`Changed points per dollar to ${newValue.basicSettings?.pointsPerDollar}`);
                            }
                            if (oldValue.basicSettings?.pointsCurrencyName !== newValue.basicSettings?.pointsCurrencyName) {
                                rewardChanges.push(`Renamed points to "${newValue.basicSettings?.pointsCurrencyName}"`);
                            }
                            
                            return rewardChanges.length > 0 ? rewardChanges.join(', ') : 'Updated rewards configuration';
                            
                        case 'settings':
                            const settingChanges = [];
                            if (!oldValue) return 'Initial settings configuration';
                            
                            if (oldValue.timezone !== newValue.timezone) {
                                settingChanges.push(`Changed timezone to ${newValue.timezone}`);
                            }
                            if (oldValue.currency !== newValue.currency) {
                                settingChanges.push(`Changed currency to ${newValue.currency}`);
                            }
                            if (oldValue.maxSeatsPerUser !== newValue.maxSeatsPerUser) {
                                settingChanges.push(`Changed max seats per user to ${newValue.maxSeatsPerUser}`);
                            }
                            
                            return settingChanges.length > 0 ? settingChanges.join(', ') : 'Updated system settings';
                            
                        case 'transactions':
                            if (!oldValue || oldValue.length === 0) return 'First transaction recorded';
                            if (newValue.length > oldValue.length) {
                                const newTrans = newValue[newValue.length - 1];
                                return `New transaction: $${newTrans.amount} from ${newTrans.memberName || 'Guest'}`;
                            }
                            return 'Transaction status updated';
                            
                        default:
                            return `Updated ${key}`;
                    }
                } catch (e) {
                    console.error('Error getting change details:', e);
                    return `Updated ${key}`;
                }
            },
            
            // Actions Log functions
            logAction(actionType, section, details) {
                try {
                    const actionsLog = this.get('actionsLog') || [];
                    const currentUser = sessionStorage.getItem('newco_current_user') || 'Admin';
                    
                    const action = {
                        id: 'action_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        user: currentUser,
                        actionType: actionType,
                        section: section,
                        details: details
                    };
                    
                    actionsLog.unshift(action); // Add to beginning
                    
                    // Keep only last 1000 actions
                    if (actionsLog.length > 1000) {
                        actionsLog.splice(1000);
                    }
                    
                    // Save without triggering another log
                    localStorage.setItem(this.DB_PREFIX + 'actionsLog', JSON.stringify(actionsLog));
                } catch (e) {
                    console.error('Error logging action:', e);
                }
            }
        };
        */

        // Examples Section Collapse Toggle
        function toggleExamplesSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const icon = document.getElementById(sectionName + 'ToggleIcon');
            const section = document.getElementById(sectionName + 'Section');
            const uiPrefs = NewcoData.get('uiPreferences') || {};

            if (!uiPrefs.collapsedExamples) {
                uiPrefs.collapsedExamples = {};
            }

            const isCollapsed = content.style.display === 'none';

            if (isCollapsed) {
                // Expand
                content.style.display = 'block';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(0deg)';
                if (section) section.style.marginBottom = '2rem';
                uiPrefs.collapsedExamples[sectionName] = false;
            } else {
                // Collapse
                content.style.display = 'none';
                icon.textContent = '▶';
                icon.style.transform = 'rotate(-90deg)';
                if (section) section.style.marginBottom = '0.5rem';
                uiPrefs.collapsedExamples[sectionName] = true;
            }

            NewcoData.set('uiPreferences', uiPrefs);
        }

        // Restore collapsed state on load
        function restoreExamplesState() {
            const uiPrefs = NewcoData.get('uiPreferences') || {};
            const collapsed = uiPrefs.collapsedExamples || {};
            const recommendationsDisabled = uiPrefs.disableRecommendations || false;

            // If recommendations are completely disabled, hide all sections
            if (recommendationsDisabled) {
                ['packageExamples', 'offeringsExamples', 'loyaltyExamples'].forEach(sectionName => {
                    const section = document.getElementById(sectionName + 'Section');
                    if (section) section.style.display = 'none';
                });
                return;
            }

            // Otherwise restore collapsed state
            ['packageExamples', 'offeringsExamples', 'loyaltyExamples'].forEach(sectionName => {
                if (collapsed[sectionName]) {
                    const content = document.getElementById(sectionName + 'Content');
                    const icon = document.getElementById(sectionName + 'ToggleIcon');
                    const section = document.getElementById(sectionName + 'Section');
                    if (content && icon) {
                        content.style.display = 'none';
                        icon.textContent = '▶';
                        icon.style.transform = 'rotate(-90deg)';
                        if (section) section.style.marginBottom = '0.5rem';
                    }
                }
            });
        }

        // Toggle all recommendations on/off
        function toggleRecommendations(enabled) {
            const uiPrefs = NewcoData.get('uiPreferences') || {};
            uiPrefs.disableRecommendations = !enabled;
            NewcoData.set('uiPreferences', uiPrefs);

            // Show/hide all recommendation sections
            ['packageExamples', 'offeringsExamples', 'loyaltyExamples'].forEach(sectionName => {
                const section = document.getElementById(sectionName + 'Section');
                if (section) {
                    section.style.display = enabled ? 'block' : 'none';
                }
            });

            showModal({
                title: enabled ? '✅ Recommendations Enabled' : '🔕 Recommendations Disabled',
                message: enabled
                    ? 'Item recommendation boxes will now be visible in Basic Offerings, Packages, and Loyalty Items sections.'
                    : 'Item recommendation boxes have been hidden. You can re-enable them anytime from this setting.',
                type: 'success'
            });
        }

        // Helper function to reinitialize Lucide icons after dynamic content changes
        function refreshIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Initialize NewcoData (async)
        (async () => {
            await NewcoData.init();
            console.log('NewcoData initialized');

            // Update org name in sidebar after init completes
            const org = NewcoData.get('organization');
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName && org && org.name) {
                sidebarOrgName.textContent = org.name;
                document.title = org.name + ' - Management System';
            }

            // Hide initial loader and show content after everything is loaded
            setTimeout(() => {
                document.getElementById('initialLoader').classList.add('hidden');
                document.body.classList.add('loaded');
                restoreExamplesState();
                toggleTestDataButtons(); // Show/hide test data buttons based on settings
                checkIntegrationsNotice(); // Show Important badge if not viewed
                loadIntegrationSettings(); // Load saved integration settings
            }, 300);
        })();

        // Apply saved branding on load
        async function applyBrandingColors() {
            const org = NewcoData.get('organization') || {};

            // Apply colors
            if (org?.colors) {
                document.documentElement.style.setProperty('--primary', org.colors.primary || '#2ea3f2');
                document.documentElement.style.setProperty('--primary-dark', adjustColor(org.colors.primary || '#2ea3f2', -30));
                document.documentElement.style.setProperty('--primary-light', adjustColor(org.colors.primary || '#2ea3f2', 80));
                document.documentElement.style.setProperty('--secondary', org.colors.secondary || '#9c27b0');
                document.documentElement.style.setProperty('--accent', org.colors.accent || org.colors.secondary || '#9c27b0');
            }

            // Apply logo to sidebar
            const sidebarLogo = document.getElementById('sidebarLogo');
            if (sidebarLogo) {
                if (org?.logoArtId) {
                    // Load logo from art library
                    try {
                        const response = await fetch(
                            `${NewcoData.supabaseUrl}/rest/v1/art_library?id=eq.${org.logoArtId}&select=*`,
                            {
                                headers: {
                                    'apikey': NewcoData.supabaseKey,
                                    'Authorization': `Bearer ${NewcoData.supabaseKey}`
                                }
                            }
                        );
                        const art = await response.json();
                        if (art && art.length > 0) {
                            sidebarLogo.innerHTML = `<img src="${art[0].file_data}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                        }
                    } catch (err) {
                        console.error('Error loading sidebar logo:', err);
                    }
                } else if (org?.name) {
                    // Show initials if no logo
                    const initials = org.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
                    sidebarLogo.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.5rem; font-weight: bold; color: white; background: var(--primary); border-radius: 8px;">${initials}</div>`;
                } else {
                    sidebarLogo.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.5rem; font-weight: bold; color: white; background: var(--primary); border-radius: 8px;">NC</div>';
                }
            }

            // Apply organization name to sidebar
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName && org?.name) {
                sidebarOrgName.textContent = org.name;
            }
        }
        
        // Helper to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16),
                amt = Math.round(2.55 * percent),
                R = (num >> 16) + amt,
                G = (num >> 8 & 0x00FF) + amt,
                B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
        }
    </script>
    <!-- External CSS -->
    <link rel="stylesheet" href="newco-admin.css">
    <style>
        /* Fix for content width - override to use full available space */
        .main-content {
            width: calc(100% - 280px) !important;
            max-width: 100% !important;
        }
    </style>

    <!-- JsBarcode Library for Barcode Generation -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Initial Loading Screen -->
    <div id="initialLoader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading Admin Portal...</div>
    </div>

    <!-- Login Screen -->
    <div id="adminLoginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);">
        <div style="background: white; padding: 3rem; border-radius: 16px; box-shadow: var(--shadow-xl); max-width: 450px; width: 100%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🔐</div>
                <h1 style="margin: 0; font-size: 1.75rem; color: var(--gray-dark);">Admin Portal</h1>
                <p id="orgNameDisplay" style="margin: 0.5rem 0 0 0; color: var(--gray); font-weight: 500;">Loading...</p>
            </div>

            <!-- First-time login hint -->
            <div id="firstTimeHint" style="background: var(--primary-light); border: 1px solid var(--warning); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: none;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <span style="font-size: 1.25rem;">💡</span>
                    <div style="font-size: 0.875rem; color: var(--gray-dark);">
                        <strong style="display: block; margin-bottom: 0.25rem;">First time logging in?</strong>
                        Use your email as both the username and password. You'll be prompted to set a secure password after login.
                    </div>
                </div>
            </div>

            <form id="adminLoginForm" onsubmit="return checkAdminPassword(event);" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-dark);">Email</label>
                    <input
                        type="email"
                        id="adminEmailInput"
                        placeholder="admin@example.com"
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-light); border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                        required
                        autofocus
                    >
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-dark);">Password</label>
                    <input
                        type="password"
                        id="adminPasswordInput"
                        placeholder="Enter your password"
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-light); border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                        required
                    >
                    <small id="passwordHint" style="color: var(--gray); font-size: 0.75rem; display: none; margin-top: 0.25rem;">First time? Use your email as password</small>
                </div>
                <div id="loginError" style="color: var(--danger); font-size: 0.875rem; text-align: center; display: none;"></div>
                <button
                    type="submit"
                    style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 0.875rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'"
                >
                    Sign In
                </button>
            </form>
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-light); text-align: center; color: var(--gray); font-size: 0.875rem;">
                Powered by NewCo
            </div>
        </div>
    </div>

    <!-- Main Admin Panel (hidden until login) -->
    <div id="adminMainPanel" style="display: none; flex-direction: column; width: 100%; min-height: 100vh;">

    <!-- Main Content Area with Sidebar and Panels -->
    <div style="display: flex; flex: 1;">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon" id="sidebarLogo">
                    🎱
                </div>
                <span id="sidebarOrgName">Admin Panel</span>
            </div>
            <div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">
                Powered by NewCo
            </div>
        </div>
        
        <nav class="sidebar-nav" aria-label="Main navigation">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="#dashboard" class="nav-item active" data-section="dashboard" aria-current="page" aria-label="Dashboard">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>
                <a href="#branding" class="nav-item" data-section="branding" aria-label="Branding">
                    <i data-lucide="sparkles"></i> Branding
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Store Operations</div>
                <a href="#halls" class="nav-item" data-section="halls" aria-label="Hall and Layout">
                    <i data-lucide="building-2"></i> Hall & Layout
                </a>
                <a href="#schedule" class="nav-item" data-section="schedule" aria-label="Schedule">
                    <i data-lucide="calendar"></i> Schedule
                </a>
                <a href="#pos-redemption" class="nav-item" data-section="pos-redemption" aria-label="POS and Redemption">
                    <i data-lucide="shopping-cart"></i> POS + Redemption
                </a>
                <a href="#floor-rewards" class="nav-item" data-section="floor-rewards" style="display: none;" aria-label="Floor Rewards">
                    <i data-lucide="star"></i> Floor Rewards
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Offerings</div>
                <a href="#salesItems" class="nav-item" data-section="salesItems" aria-label="Basic Offerings">
                    <i data-lucide="shopping-bag"></i> Basic Offerings
                </a>
                <a href="#packages" class="nav-item" data-section="packages" aria-label="Packages">
                    <i data-lucide="package"></i> Packages
                </a>
                <a href="#loyaltyItems" class="nav-item" data-section="loyaltyItems" id="navLoyaltyItems" aria-label="Loyalty Items">
                    <i data-lucide="gift"></i> Loyalty Items
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Member Management</div>
                <a href="#members" class="nav-item" data-section="members" aria-label="Members Database">
                    <i data-lucide="users"></i> Members Database
                </a>
                <a href="#rewards" class="nav-item" data-section="rewards" aria-label="Rewards Program">
                    <i data-lucide="award"></i> Rewards Program
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Marketing Tools</div>
                <a href="#pagebuilder" class="nav-item" data-section="pagebuilder" aria-label="Web Templates">
                    <i data-lucide="globe"></i> Web Templates
                </a>
                <a href="#webbuilder" class="nav-item" data-section="webbuilder" style="display: none;" aria-label="Web Builder">
                    <i data-lucide="wrench"></i> Web Builder
                </a>
                <a href="javascript:void(0)" class="nav-item" data-section="socialmedia" onclick="showComingSoon('Social Media')" aria-label="Social Media">
                    <i data-lucide="share-2"></i> Social Media
                </a>
                <a href="#marketing" class="nav-item" data-section="marketing" aria-label="Marketing">
                    <i data-lucide="megaphone"></i> Marketing
                </a>
                <a href="#artLibrary" class="nav-item" data-section="artLibrary" aria-label="Art Library">
                    <i data-lucide="image"></i> Art Library
                </a>
                <a href="#marketing" class="nav-item" data-section="marketing" style="display: none;" aria-label="Email Campaigns">
                    <i data-lucide="mail"></i> Email Campaigns
                </a>
                <a href="#themes" class="nav-item" data-section="themes" style="display: none;" aria-label="Themes">
                    <i data-lucide="palette"></i> Themes
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Operations</div>
                <a href="#staff" class="nav-item" data-section="staff" aria-label="Staff">
                    <i data-lucide="user-cog"></i> Staff
                </a>
                <a href="#artlibrary" class="nav-item" data-section="artlibrary" style="display: none;" aria-label="Art Library">
                    <i data-lucide="image"></i> Art Library
                </a>
                <a href="#integrations" class="nav-item" data-section="integrations" onclick="dismissIntegrationsNotice()" aria-label="Integrations">
                    <i data-lucide="link"></i> Integrations
                    <span id="integrationsImportantBadge" class="badge-important" style="display: none; background: var(--success); color: white; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-left: 0.5rem; font-weight: 600;">IMPORTANT</span>
                </a>
                <a href="#transactions" class="nav-item" data-section="transactions" aria-label="Transactions Log">
                    <i data-lucide="credit-card"></i> Transactions Log
                </a>
                <a href="#rewardstransactions" class="nav-item" data-section="rewardstransactions" id="navRewardsTransactions" aria-label="Rewards Transactions">
                    <i data-lucide="trophy"></i> Rewards Transactions
                </a>
                <a href="#actionslog" class="nav-item" data-section="actionslog" aria-label="Actions Log">
                    <i data-lucide="file-text"></i> Actions Log
                </a>
                <a href="javascript:void(0)" class="nav-item" data-section="reports" onclick="showComingSoon('Reports')" aria-label="Reports">
                    <i data-lucide="bar-chart"></i> Reports
                </a>
                <a href="#settings" class="nav-item" data-section="settings" aria-label="Settings">
                    <i data-lucide="settings"></i> Settings
                </a>
            </div>
        </nav>
    </aside>

    <!-- ═══════════════════════════════════════════════════════════════════
         MAIN CONTENT AREA - All Admin Panel Sections
         ═══════════════════════════════════════════════════════════════════ -->
    <!-- Main Content Area -->
    <main class="main-content">
        <!-- ═══════════════════════════════════════════════════════════════════
             DASHBOARD SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-panel active">
            <div class="header-bar">
                <h1 class="header-title">Dashboard</h1>
                <div class="header-actions">
                    <span id="lastSaved" style="color: var(--gray); font-size: 0.875rem;">
                        Auto-save enabled
                    </span>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        🔄 Refresh
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-card" onclick="showComingSoonModal('New Session')">
                    <div class="quick-action-icon"><i data-lucide="plus" style="width: 32px; height: 32px;"></i></div>
                    <div class="quick-action-label">New Session</div>
                </div>
                <div class="quick-action-card" onclick="showComingSoonModal('View Bookings')">
                    <div class="quick-action-icon"><i data-lucide="ticket" style="width: 32px; height: 32px;"></i></div>
                    <div class="quick-action-label">View Bookings</div>
                </div>
                <div class="quick-action-card" onclick="showSection('members')">
                    <div class="quick-action-icon"><i data-lucide="user" style="width: 32px; height: 32px;"></i></div>
                    <div class="quick-action-label">Add Member</div>
                </div>
                <div class="quick-action-card" onclick="showSection('reports')">
                    <div class="quick-action-icon"><i data-lucide="bar-chart" style="width: 32px; height: 32px;"></i></div>
                    <div class="quick-action-label">Run Report</div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today's Revenue</div>
                    <div class="stat-value">$0</div>
                    <div class="stat-change positive">↑ 0% from yesterday</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Sessions</div>
                    <div class="stat-value">0</div>
                    <div class="stat-change">0 upcoming today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Members</div>
                    <div class="stat-value">0</div>
                    <div class="stat-change positive">↑ 0 new this week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Occupancy Rate</div>
                    <div class="stat-value">0%</div>
                    <div class="stat-change">0 seats filled</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Activity</h2>
                    <p class="section-subtitle">Latest bookings and member activity</p>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable">
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--gray);">
                                No recent activity
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             BRANDING SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Branding Section -->
        <section id="branding" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Branding & Identity</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="saveBranding()" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="save" style="width: 16px; height: 16px;"></i> Save Branding</button>
                </div>
            </div>

            <div class="content-section" style="padding: 1rem;">
                <!-- Compact grid layout for all branding elements -->
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1.5rem; align-items: start;">
                    <!-- Logo Preview -->
                    <div id="logoPreview" style="width: 200px; height: 140px; background: var(--gray-lighter); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--gray-light);">
                        <span style="color: var(--gray); font-size: 0.875rem;">No logo</span>
                    </div>

                    <!-- Right side: All inputs in compact grid -->
                    <div style="display: grid; gap: 1rem;">
                        <!-- Logo Controls -->
                        <div>
                            <label class="form-label" style="margin-bottom: 0.5rem;">Logo</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" class="btn btn-primary" onclick="selectLogoFromArt()" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="frame" style="width: 16px; height: 16px;"></i> Select</button>
                                <button type="button" class="btn btn-secondary" onclick="resetLogo()" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="trash-2" style="width: 16px; height: 16px;"></i> Remove</button>
                            </div>
                            <input type="hidden" id="selectedLogoArtId">
                        </div>

                        <!-- Colors in horizontal layout -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label class="form-label" style="margin-bottom: 0.5rem;">Primary Color</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" class="form-input" id="brandPrimaryColor" value="#2ea3f2" onchange="updateBrandPreview()" style="width: 60px; height: 40px; padding: 0.25rem;">
                                    <input type="text" class="form-input" id="brandPrimaryHex" value="#2ea3f2" onchange="updateColorFromHex('primary')" style="flex: 1; padding: 0.5rem;">
                                </div>
                            </div>
                            <div>
                                <label class="form-label" style="margin-bottom: 0.5rem;">Secondary Color</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" class="form-input" id="brandSecondaryColor" value="#9c27b0" onchange="updateBrandPreview()" style="width: 60px; height: 40px; padding: 0.25rem;">
                                    <input type="text" class="form-input" id="brandSecondaryHex" value="#9c27b0" onchange="updateColorFromHex('secondary')" style="flex: 1; padding: 0.5rem;">
                                </div>
                            </div>
                        </div>

                        <!-- Organization Name and Tagline -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label class="form-label" style="margin-bottom: 0.5rem;">Organization Name</label>
                                <input type="text" class="form-input" id="brandOrgName" placeholder="Your Charity Name" style="padding: 0.5rem;">
                            </div>
                            <div>
                                <label class="form-label" style="margin-bottom: 0.5rem;">Tagline</label>
                                <input type="text" class="form-input" id="brandTagline" placeholder="Marketing tagline" style="padding: 0.5rem;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             SCHEDULE SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Schedule Section -->
        <section id="schedule" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Schedule Management</h1>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Weekly Schedule</h2>
                    <p class="section-subtitle">Assign sessions to specific days</p>
                </div>

                <div id="scheduleContainer">
                    <!-- Schedule will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Redemption Section -->
        <!-- POS + Redemption Combined Section -->
        <section id="pos-redemption" class="content-panel" style="display: none;">
            <div class="content-main" style="padding-top: 0.5rem;">
                <!-- PURCHASING SECTION -->
                <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--success); display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="shopping-bag" style="width: 20px; height: 20px;"></i> Purchasing (POS)</h2>

                <!-- Launch POS Card -->
                <div class="card" id="purchasingLaunchCard" style="display: none; float: right; width: 280px; margin-left: 1rem; margin-bottom: 1rem; margin-top: -3rem;">
                    <div style="padding: 1rem; background: var(--success-light); border-radius: 8px; border: 2px solid var(--success);">
                        <h3 style="margin: 0 0 0.75rem 0; color: var(--success); font-size: 1rem;">🛍️ Launch POS</h3>
                        <button class="btn" onclick="openPurchasingApp()" style="width: 100%; padding: 0.75rem; font-size: 0.95rem; font-weight: 600; background: var(--success); color: white; margin-bottom: 0.75rem;">
                            Open POS
                        </button>
                        <div style="padding: 0.5rem; background: white; border-radius: 4px;">
                            <label style="font-size: 0.75rem; color: var(--gray); display: block; margin-bottom: 0.25rem;">Link:</label>
                            <div style="display: flex; gap: 0.25rem; align-items: center;">
                                <input type="text" id="purchasingAppLink" value="file:///C:/Users/aring/NewCo/newco-redemption-v2.2.html?mode=purchasing" readonly style="flex: 1; padding: 0.25rem; border: 1px solid var(--gray-light); border-radius: 4px; font-family: monospace; font-size: 0.7rem; min-width: 0;">
                                <button class="btn btn-outline" onclick="copyPurchasingLink()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap; display: flex; align-items: center;"><i data-lucide="clipboard-list" style="width: 14px; height: 14px;"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <strong>Enable In-Person Purchasing</strong>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enablePurchasing" onchange="togglePurchasingSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Marketing Text (shown when disabled) -->
                    <div id="purchasingMarketingText" style="display: none; padding: 2rem; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; color: white;">🛍️ Why Use Our POS System?</h3>
                        <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem;">
                            Our Point of Sale system will speed up sales, improve tracking, and enable floor sales to connect to rewards.
                            Streamline your operations with real-time inventory management, automated receipt generation, and seamless integration
                            with your loyalty program.
                        </p>
                        <ul style="font-size: 1rem; line-height: 1.8; margin: 0; padding-left: 1.5rem;">
                            <li>⚡ Faster checkout process</li>
                            <li>📊 Real-time sales tracking and reporting</li>
                            <li>🏆 Automatic loyalty point integration</li>
                            <li>📱 Mobile-friendly floor sales</li>
                            <li>🧾 Automated receipt generation</li>
                        </ul>
                        <p style="margin-top: 1.5rem; font-style: italic; opacity: 0.9;">
                            Enable the toggle above to get started!
                        </p>
                    </div>

                    <!-- Settings Content (shown when enabled) -->
                    <div id="purchasingContent" style="display: none;">
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1.5rem;">
                            <span style="color: var(--gray); font-size: 0.875rem;">Minimum role:</span>
                            <select class="form-input" id="purchasingPermissionLevel" style="width: 150px;">
                                <option value="Cashier" selected>Cashier</option>
                                <option value="Staff">Staff</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin Only</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 2rem; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span>Print Receipts Automatically</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="printReceipts" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span>Email Receipts</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailReceipts">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DIVIDER -->
                <div style="margin: 1.5rem 0; border-top: 2px solid var(--gray-light);"></div>

                <!-- REDEMPTION SECTION -->
                <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="ticket" style="width: 20px; height: 20px;"></i> Redemption</h2>

                <!-- Launch Redemption Card -->
                <div class="card" id="redemptionLaunchCard" style="display: none; float: right; width: 280px; margin-left: 1rem; margin-bottom: 1rem; clear: right;">
                    <div style="padding: 1rem; background: var(--primary-light); border-radius: 8px; border: 2px solid var(--primary);">
                        <h3 style="margin: 0 0 0.75rem 0; color: var(--primary); font-size: 1rem;">🎟️ Launch Redemption</h3>
                        <button class="btn btn-primary" onclick="openRedemptionApp()" style="width: 100%; padding: 0.75rem; font-size: 0.95rem; font-weight: 600; background: var(--primary); margin-bottom: 0.75rem;">
                            Open Redemption
                        </button>
                        <div style="padding: 0.5rem; background: white; border-radius: 4px;">
                            <label style="font-size: 0.75rem; color: var(--gray); display: block; margin-bottom: 0.25rem;">Link:</label>
                            <div style="display: flex; gap: 0.25rem; align-items: center;">
                                <input type="text" id="redemptionAppLink" value="file:///C:/Users/aring/NewCo/newco-redemption-v2.2.html?mode=redemption" readonly style="flex: 1; padding: 0.25rem; border: 1px solid var(--gray-light); border-radius: 4px; font-family: monospace; font-size: 0.7rem; min-width: 0;">
                                <button class="btn btn-outline" onclick="copyRedemptionLink()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap; display: flex; align-items: center;"><i data-lucide="clipboard-list" style="width: 14px; height: 14px;"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <strong>Enable Redemption System</strong>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableRedemption" onchange="toggleRedemptionSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Marketing Text (shown when disabled) -->
                    <div id="redemptionMarketingText" style="display: none; padding: 2rem; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; color: white;">🎟️ Why Use Our Redemption System?</h3>
                        <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem;">
                            Our Redemption system will help you streamline your online sales into distributing your Bingo materials quickly,
                            efficiently, and correctly. No more confusion, no more errors - just smooth, organized distribution.
                        </p>
                        <ul style="font-size: 1rem; line-height: 1.8; margin: 0; padding-left: 1.5rem;">
                            <li>⚡ Quick and efficient material distribution</li>
                            <li>✅ Reduce errors with ID verification</li>
                            <li>📦 Organized pickup/will-call system</li>
                            <li>📧 Automated customer notifications</li>
                            <li>⏰ Flexible redemption window hours</li>
                        </ul>
                        <p style="margin-top: 1.5rem; font-style: italic; opacity: 0.9;">
                            Enable the toggle above to get started!
                        </p>
                    </div>

                    <!-- Settings Content (shown when enabled) -->
                    <div id="redemptionContent" style="display: none;">
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1.5rem;">
                            <span style="color: var(--gray); font-size: 0.875rem;">Minimum role:</span>
                            <select class="form-input" id="redemptionPermissionLevel" style="width: 150px;">
                                <option value="Cashier">Cashier</option>
                                <option value="Staff" selected>Staff</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin Only</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 2rem; align-items: center; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span>Require ID Verification</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="requireIdVerification" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span>Send SMS/Email when ready</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sendRedemptionNotifications">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <select class="form-input" id="redemptionMode" style="width: 160px;">
                                    <option value="pickup">Customer Pickup</option>
                                    <option value="willcall">Will Call Window</option>
                                    <option value="delivery">Delivery Service</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Redemption Window Hours</label>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <input type="time" class="form-input" id="redemptionStartTime" value="09:00" style="width: 120px;">
                                <span style="color: var(--gray);">to</span>
                                <input type="time" class="form-input" id="redemptionEndTime" value="17:00" style="width: 120px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Floor Rewards Section -->
        <section id="floor-rewards" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Floor Rewards</h1>
            </div>
            
            <div class="content-main">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                        <div class="form-label">Enable Floor Reward System</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableFloorRewards" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1.5rem;">
                        <div class="form-label">Enable Barcode Scanning</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableFloorScanning" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--warning-light); border-radius: 12px; border: 2px solid var(--warning);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--warning);">Launch Floor Rewards</h3>
                        <button class="btn" onclick="openFloorRewardsApp()" style="width: 100%; padding: 1.25rem; font-size: 1.2rem; font-weight: 600; background: var(--warning); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            ⭐ Open Floor Rewards
                        </button>
                        <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                            <label style="font-size: 0.875rem; color: var(--gray); display: block; margin-bottom: 0.5rem;">Direct Link (copy and share):</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="floorRewardsAppLink" value="file:///C:/Users/aring/NewCo/newco-floor-runner-vanguard.html" readonly style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                                <button class="btn btn-outline" onclick="copyFloorRewardsLink()" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="clipboard-list" style="width: 16px; height: 16px;"></i> Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Halls Section -->
        <section id="halls" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Hall & Layout</h1>
            </div>

            <!-- Single Hall Configuration -->
            <div id="hallContent">
                <!-- Hall content will be generated here -->
            </div>
        </section>

        <!-- Staff Section -->
        <section id="staff" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Team Management</h1>
                <p class="content-subtitle">Manage staff members, roles, and permissions</p>
            </div>
            
            <!-- Staff Stats -->
            <div class="content-section">
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-light), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Total Staff</div>
                        <div class="stat-value" id="totalStaffCount" style="font-size: 2rem; font-weight: bold; color: var(--primary);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Active Today</div>
                        <div class="stat-value" id="activeStaffCount" style="font-size: 2rem; font-weight: bold; color: var(--success);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Managers</div>
                        <div class="stat-value" id="managerCount" style="font-size: 2rem; font-weight: bold; color: var(--warning);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), white); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Floor Staff</div>
                        <div class="stat-value" id="floorStaffCount" style="font-size: 2rem; font-weight: bold; color: var(--primary);">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Filters and Actions -->
            <div class="content-section">
                <div class="section-header">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="staffSearchInput" placeholder="Search by name or email..." 
                               style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;"
                               onkeyup="filterStaff()">
                        <select id="staffRoleFilter" onchange="filterStaff()" 
                                style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="">All Roles</option>
                            <option value="Admin">Admin</option>
                            <option value="Manager">Manager</option>
                            <option value="Floor Staff">Floor Staff</option>
                            <option value="Cashier">Cashier</option>
                            <option value="Caller">Caller</option>
                            <option value="Security">Security</option>
                        </select>
                        <select id="staffStatusFilter" onchange="filterStaff()" 
                                style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="on_leave">On Leave</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="exportStaff()" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="download" style="width: 16px; height: 16px;"></i> Export</button>
                        <button class="btn btn-primary" onclick="addStaffMember()">+ Add Staff Member</button>
                    </div>
                </div>
                
                <!-- Staff Table -->
                <div style="overflow-x: auto; margin-top: 1.5rem;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark);">
                                    <input type="checkbox" id="selectAllStaff" onchange="toggleAllStaff()">
                                </th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortStaff('name')">
                                    Name <span id="sortArrowStaffName">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark);">Contact</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortStaff('role')">
                                    Role <span id="sortArrowStaffRole">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark);">Status</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortStaff('lastActive')">
                                    Last Active <span id="sortArrowStaffLastActive">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); width: 60px;"></th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- Staff rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                <div id="bulkActionsBar" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 1rem 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="selectedCount" style="font-weight: 600;">0 selected</span>
                        <button class="btn btn-sm" onclick="bulkChangeRole()" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Change Role</button>
                        <button class="btn btn-sm" onclick="bulkUpdateStatus('active')">Activate</button>
                        <button class="btn btn-sm" onclick="bulkUpdateStatus('inactive')">Deactivate</button>
                        <button class="btn btn-sm btn-danger" onclick="bulkDeleteStaff()">Delete</button>
                        <button class="btn btn-sm btn-secondary" onclick="clearStaffSelection()">Cancel</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             WEB TEMPLATES SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Web Templates Section -->
        <section id="pagebuilder" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Web Templates</h1>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="launchCustomerSite()">
                        🚀 Launch Site
                    </button>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Choose Your Template Style</h2>
                    <p class="section-subtitle">Select which features to include on your booking page</p>
                </div>

                <!-- Template Options -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1200px; margin: 0 auto;">

                    <!-- Modern Components (Center) -->
                    <div id="templateModernComponents" class="template-option selected" onclick="selectTemplate('modern-components')" style="cursor: pointer; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: all 0.3s; border: 3px solid var(--primary);">
                        <div style="background: white; overflow: hidden;">
                            <!-- Header Preview -->
                            <div style="height: 50px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); display: flex; align-items: center; padding: 0 1rem; gap: 0.5rem;">
                                <div style="width: 30px; height: 30px; background: rgba(255,255,255,0.3); border-radius: 4px;"></div>
                                <div style="flex: 1; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; max-width: 100px;"></div>
                            </div>

                            <!-- Hero Carousel Preview -->
                            <div style="height: 80px; background: linear-gradient(to right, #667eea, #764ba2); position: relative;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; font-size: 0.75rem;">
                                    📸 Hero Carousel
                                </div>
                            </div>

                            <div style="padding: 1rem; display: flex; gap: 0.75rem;">
                                <!-- Sessions (6 cards) -->
                                <div style="flex: 3; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                    <div style="height: 40px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 40px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 40px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 40px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 40px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 40px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                </div>

                                <!-- Side Alerts (4 cards) -->
                                <div style="flex: 1; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="height: 20px; background: #fef3c7; border-radius: 4px; border: 1px solid #fbbf24;"></div>
                                    <div style="height: 20px; background: #dbeafe; border-radius: 4px; border: 1px solid #60a5fa;"></div>
                                    <div style="height: 20px; background: #d1fae5; border-radius: 4px; border: 1px solid #34d399;"></div>
                                    <div style="height: 20px; background: #fee2e2; border-radius: 4px; border: 1px solid #f87171;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 1.5rem; background: white; border-top: 1px solid var(--gray-light); text-align: center;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; font-weight: 700; color: var(--primary);">Modern Components</h4>
                            <p style="margin: 0; color: var(--gray); font-size: 0.875rem;">Full-featured with carousel & alerts</p>
                            <div style="margin-top: 0.75rem; display: inline-block; background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">DEFAULT</div>
                        </div>
                    </div>

                    <!-- Minimal Modern (Right) -->
                    <div id="templateMinimalModern" class="template-option" onclick="selectTemplate('minimal-modern')" style="cursor: pointer; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: all 0.3s; border: 3px solid transparent;">
                        <div style="background: white; overflow: hidden;">
                            <!-- Header Preview -->
                            <div style="height: 50px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); display: flex; align-items: center; padding: 0 1rem; gap: 0.5rem;">
                                <div style="width: 30px; height: 30px; background: rgba(255,255,255,0.3); border-radius: 4px;"></div>
                                <div style="flex: 1; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; max-width: 100px;"></div>
                            </div>

                            <!-- No Carousel - Clean Space -->
                            <div style="height: 30px; background: #f9fafb;"></div>

                            <div style="padding: 1rem;">
                                <!-- Sessions Only (6 cards, full width) -->
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                    <div style="height: 50px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 50px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 50px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 50px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 50px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                    <div style="height: 50px; background: var(--primary-light); border-radius: 6px; border: 1px solid var(--primary);"></div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 1.5rem; background: white; border-top: 1px solid var(--gray-light); text-align: center;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; font-weight: 700; color: var(--gray-dark);">Minimal Modern</h4>
                            <p style="margin: 0; color: var(--gray); font-size: 0.875rem;">Clean & simple - sessions only</p>
                        </div>
                    </div>
                </div>

                <!-- Current Selection Display -->
                <div style="margin-top: 2rem; padding: 1rem; background: var(--primary-light); border-radius: 8px; border-left: 4px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--primary);">Current Template:</strong>
                            <span id="currentTemplateLabel" style="margin-left: 0.5rem; font-weight: 600;">Modern Components</span>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--gray);">
                            <span id="templateFeaturesLabel">Includes: Header, Carousel, Sessions, Side Alerts</span>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             WEB BUILDER SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Web Builder Section -->
        <section id="webbuilder" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Web Builder</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="previewBuiltPage()">
                        👁️ Preview Page
                    </button>
                    <button class="btn btn-primary" onclick="exportBuiltPage()">
                        📥 Export HTML
                    </button>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Drag & Drop Page Builder</h2>
                    <p class="section-subtitle">Build your custom booking page with drag and drop components</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 200px 1fr 300px; gap: 1rem;">
                    <!-- Component Palette -->
                    <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px; height: fit-content;">
                        <h3 style="font-size: 0.875rem; margin-bottom: 1rem;">Components</h3>
                        <div class="component-list">
                            <div class="drag-component" draggable="true" data-component="header" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📄</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Header</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="session-selector" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📅</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Date/Time Picker</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="package-cards" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📦</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Package Cards</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="seat-selector" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>🪑</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Seat Selector</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="pricing" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>💰</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Pricing Display</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="checkout" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>🛒</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Checkout Form</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="text" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>📝</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Text Block</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="image" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>🖼️</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Image</span>
                            </div>
                            <div class="drag-component" draggable="true" data-component="divider" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: grab; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                <span>➖</span>
                                <span style="font-size: 0.875rem; font-weight: 500;">Divider</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Canvas -->
                    <div style="background: white; border: 2px dashed #ddd; border-radius: 8px; padding: 1rem; min-height: 600px; position: relative;">
                        <div id="builderCanvas" style="min-height: 550px;" ondragover="allowDrop(event)" ondrop="dropComponent(event)">
                            <div style="text-align: center; color: var(--gray); margin-top: 200px; pointer-events: none;" id="canvasPlaceholder">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">🎨</div>
                                <h3>Drag components here to build your page</h3>
                                <p>Start by dragging a Header component to begin</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Properties Panel -->
                    <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px; height: fit-content;">
                        <h3 style="font-size: 0.875rem; margin-bottom: 1rem;">Properties</h3>
                        <div id="builderPropertyPanel">
                            <p style="color: var(--gray); font-size: 0.875rem;">
                                Select a component to edit its properties
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Page Settings</h2>
                    <p class="section-subtitle">Configure advanced page behavior and integrations</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Seat Selection Mode</label>
                        <select class="form-select" id="builderSeatMode">
                            <option value="simple">Simple (Quantity)</option>
                            <option value="visual">Visual (Grid Map)</option>
                            <option value="vip">VIP Sections</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pricing Display</label>
                        <select class="form-select" id="builderPricing">
                            <option value="dynamic">Dynamic (Live Update)</option>
                            <option value="static">Static</option>
                            <option value="tiered">Tiered Pricing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Enable Rewards Integration</label>
                        <select class="form-select" id="builderRewards">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Checkout Flow</label>
                        <select class="form-select" id="builderCheckout">
                            <option value="single">Single Page</option>
                            <option value="multi">Multi-Step Wizard</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Responsive</label>
                        <select class="form-select" id="builderMobile">
                            <option value="auto" selected>Auto-Responsive</option>
                            <option value="desktop">Desktop Only</option>
                            <option value="mobile">Mobile Optimized</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme Integration</label>
                        <select class="form-select" id="builderTheme">
                            <option value="template">Use Selected Template</option>
                            <option value="custom">Custom Styling</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Theme Presets Section (moved from Themes) -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Theme Presets</h2>
                    <p class="section-subtitle">Choose a starting theme for your brand</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="theme-card" onclick="applyTheme('classic')">
                        <div style="height: 100px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Classic Bingo</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Traditional purple & gold</p>
                        </div>
                    </div>
                    <div class="theme-card" onclick="applyTheme('modern')">
                        <div style="height: 100px; background: linear-gradient(135deg, #2ea3f2, #1a5f8a); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Modern Blue</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Clean and professional</p>
                        </div>
                    </div>
                    <div class="theme-card" onclick="applyTheme('fun')">
                        <div style="height: 100px; background: linear-gradient(135deg, #f093fb, #f5576c); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Fun & Vibrant</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Colorful and energetic</p>
                        </div>
                    </div>
                    <div class="theme-card" onclick="applyTheme('elegant')">
                        <div style="height: 100px; background: linear-gradient(135deg, #434343, #000000); border-radius: 8px 8px 0 0;"></div>
                        <div style="padding: 1rem;">
                            <strong>Elegant Dark</strong>
                            <p style="font-size: 0.875rem; color: var(--gray);">Sophisticated black & gold</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typography Section (moved from Themes) -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Typography</h2>
                    <p class="section-subtitle">Choose your fonts for a consistent look</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Heading Font</label>
                        <select class="form-select" id="headingFont">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Playfair Display">Playfair Display</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Body Font</label>
                        <select class="form-select" id="bodyFont">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Lato">Lato</option>
                            <option value="Source Sans Pro">Source Sans Pro</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Settings</h1>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Organization Details</h2>
                    <p class="section-subtitle">Legal and contact information</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Organization Legal Name</label>
                        <input type="text" class="form-input" id="settingsOrgName" placeholder="Legal entity name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">License Number</label>
                        <input type="text" class="form-input" id="settingsLicense" placeholder="Gaming license #">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Primary Email</label>
                        <input type="email" class="form-input" id="settingsEmail" placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Primary Phone</label>
                        <input type="tel" class="form-input" id="settingsPhone" placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Main Address</label>
                        <input type="text" class="form-input" id="settingsAddress" placeholder="123 Main St">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="settingsWebsite" placeholder="https://example.com">
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">System Preferences</h2>
                    <p class="section-subtitle">Configure system behavior</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Time Zone</label>
                        <select class="form-select" id="settingsTimezone">
                            <option value="America/Los_Angeles">Pacific Time</option>
                            <option value="America/Denver">Mountain Time</option>
                            <option value="America/Chicago">Central Time</option>
                            <option value="America/New_York">Eastern Time</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-select" id="settingsCurrency">
                            <option value="USD">USD ($)</option>
                            <option value="CAD">CAD (C$)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Points Currency Name</label>
                        <input type="text" class="form-input" id="settingsPointsCurrency" value="Loyalty Points" placeholder="e.g., Stars, Tokens, Coins, Loyalty Points">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Name displayed for loyalty points throughout the system
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seat Limit Per User</label>
                        <input type="number" class="form-input" id="settingsSeatLimit" min="1" max="20" value="1" placeholder="1">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Maximum number of seats a single user can purchase (applies to packages with seat selection)
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tax Rate (%)</label>
                        <input type="number" class="form-input" id="settingsTaxRate" min="0" max="25" step="0.01" value="8.75" placeholder="8.75">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Sales tax percentage applied at checkout (when not exempt)
                        </p>
                    </div>
                    <div class="form-toggle-group" style="grid-column: 1/-1;">
                        <div style="flex: 1;">
                            <div class="form-label">No Add-ons without Seat</div>
                            <div class="toggle-description">
                                Prevent customers from purchasing add-ons unless they have a package with a seat in their cart or already purchased for that date
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsRequireSeatForAddons" onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group" style="grid-column: 1/-1;">
                        <div style="flex: 1;">
                            <div class="form-label">Enable Test Members/Transactions</div>
                            <div class="toggle-description">
                                Allow generation of test data for members, transactions, and loyalty rewards for demo purposes
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsEnableTestData" onchange="saveSettings(); toggleTestDataButtons()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">UI Preferences</h2>
                    <p class="section-subtitle">Customize your admin interface experience</p>
                </div>

                <div class="form-grid">
                    <div class="form-toggle-group" style="grid-column: 1/-1;">
                        <div style="flex: 1;">
                            <div class="form-label">Show Item Recommendations</div>
                            <div class="toggle-description">
                                Display helpful examples and suggestions in Basic Offerings, Packages, and Loyalty Items sections
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsShowRecommendations" checked onchange="toggleRecommendations(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Tax Exemption Settings</h2>
                    <p class="section-subtitle">Configure tax-exempt status for charitable gaming</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Bingo Packages are Tax-Exempt</div>
                            <div class="toggle-description">
                                Bingo games operated by qualified non-profits are typically tax-exempt in California
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsTaxExemptPackages" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Gaming Items are Tax-Exempt</div>
                            <div class="toggle-description">
                                Pull-tabs, paper cards, and other gaming items
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsTaxExemptItems" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Reward Redemptions are Tax-Exempt</div>
                            <div class="toggle-description">
                                Items redeemed with loyalty points
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsTaxExemptRewards" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border: 1px solid #ffc107;">
                            <strong style="color: #856404;">⚠️ Note on Taxable Items:</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #856404;">
                                Concessions, merchandise, and bingo supplies (daubers, seat cushions) sold separately are typically taxable. 
                                Consider creating a separate "Merchandise" category for these items.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Payment Options</h2>
                    <p class="section-subtitle">Configure accepted payment methods</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Accept Credit/Debit Cards</div>
                            <div class="toggle-description">
                                Enable online card payments through checkout
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsPaymentCard">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Accept Cash at Hall</div>
                            <div class="toggle-description">
                                Allow customers to reserve online and pay cash when they arrive
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsPaymentCash">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-toggle-group">
                        <div style="flex: 1;">
                            <div class="form-label">Accept Checks</div>
                            <div class="toggle-description">
                                Accept check payments at the hall
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsPaymentCheck">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Access Permissions</h2>
                    <p class="section-subtitle">Control who can modify different sections</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Required Permission for Offerings</label>
                        <select class="form-select" id="settingsOfferingsPermission" onchange="saveSettings()">
                            <option value="any">Any Role</option>
                            <option value="Admin">Admin Only</option>
                            <option value="Marketing Manager">Marketing Manager or Admin</option>
                            <option value="Manager">Manager or Higher</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Controls who can create/edit Basic Offerings, Packages, and Loyalty Items
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required Permission for Marketing Tools</label>
                        <select class="form-select" id="settingsMarketingPermission" onchange="saveSettings()">
                            <option value="any">Any Role</option>
                            <option value="Admin">Admin Only</option>
                            <option value="Marketing Manager">Marketing Manager or Admin</option>
                            <option value="Manager">Manager or Higher</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Controls who can modify Page Builder, Promotions, and Themes
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required Permission for Branding</label>
                        <select class="form-select" id="settingsBrandingPermission" onchange="saveSettings()">
                            <option value="any">Any Role</option>
                            <option value="Admin">Admin Only</option>
                            <option value="Marketing Manager">Marketing Manager or Admin</option>
                            <option value="Manager">Manager or Higher</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Controls who can modify logo, colors, and brand messaging
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             PACKAGES SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Packages Section -->
        <section id="packages" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Package Management</h1>
                <p class="content-subtitle">Create and manage bingo packages</p>
            </div>
            
            <!-- Package Examples Section -->
            <div class="content-section" id="packageExamplesSection" style="background: #f0f4f8; border-left: 3px solid #64748b; padding: 0; overflow: hidden; transition: all 0.3s ease;">
                <div class="section-header" style="padding: 0.75rem 1.5rem; margin: 0; cursor: pointer; user-select: none; background: white; border-bottom: 1px solid #e2e8f0;" onclick="toggleExamplesSection('packageExamples')">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <h2 class="section-title" style="font-size: 0.95rem; color: #475569; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span id="packageExamplesToggleIcon" style="font-size: 0.75rem; transition: transform 0.3s;">▼</span>
                            📦 Popular Package Examples
                        </h2>
                    </div>
                </div>
                <div id="packageExamplesContent" style="padding: 1.5rem; display: block;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; font-size: 0.9rem;">
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--secondary); font-size: 1rem;">🌟 Early Bird Special</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$15 (Save $5!)</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>6-on Paper Regular Games</li>
                            <li>Early Bird Games</li>
                            <li>1 Special Game Sheet</li>
                            <li>Free Dauber</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">Available until 6:30 PM</div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                        <span style="position: absolute; top: -8px; right: 10px; background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">BEST VALUE</span>
                        <strong style="color: var(--secondary); font-size: 1rem;">💎 Premium Package</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$35 or 350 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Electronic Unit (48 cards)</li>
                            <li>All Special Games</li>
                            <li>Progressive Jackpot Entry</li>
                            <li>Reserved Seat Selection</li>
                            <li>Complimentary Snack</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">Includes loyalty points bonus</div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--secondary); font-size: 1rem;">👥 Group Bundle</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$100 (4 Players)</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>4x 6-on Paper Games</li>
                            <li>4x Special Game Sheets</li>
                            <li>Table Reservation</li>
                            <li>Shared Bonanza Pack</li>
                            <li>Group Photo</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">Perfect for parties!</div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--secondary); font-size: 1rem;">🎯 Beginner's Luck</strong>
                        <div style="color: var(--admin-primary); font-weight: bold; margin: 0.5rem 0;">$10</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>3-on Paper (6 cards)</li>
                            <li>1 Special Game</li>
                            <li>Dauber Included</li>
                            <li>How-to-Play Guide</li>
                        </ul>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">First-timers welcome!</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.8); border-radius: 8px;">
                    <p style="font-size: 0.85rem; color: var(--gray-dark); margin: 0;">
                        <strong>💡 Package Strategy Tips:</strong>
                    </p>
                    <ul style="font-size: 0.85rem; color: var(--gray); margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Create 3-4 packages at different price points to appeal to all players</li>
                        <li>Mark one package as "Best Value" to guide purchasing decisions</li>
                        <li>Include seat selection in premium packages as an incentive</li>
                        <li>Consider time-based packages (Early Bird) to manage crowd flow</li>
                        <li>Offer loyalty point redemption on higher-tier packages</li>
                    </ul>
                </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Packages</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="create-examples-btn" onclick="createPackageExamples()">
                            ✨ Create Examples
                        </button>
                        <button class="btn btn-primary" onclick="addPackage()">+ Add Package</button>
                    </div>
                </div>
                
                <div id="packagesContainer">
                    <!-- Packages will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Loyalty Items Section -->
        <section id="loyaltyItems" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Loyalty Rewards</h1>
                <p class="content-subtitle">Create exclusive items that can only be redeemed with loyalty points</p>
            </div>
            
            <!-- Loyalty Examples Section -->
            <div class="content-section" id="loyaltyExamplesSection" style="background: #f0f4f8; border-left: 3px solid #64748b; padding: 0; overflow: hidden; transition: all 0.3s ease;">
                <div class="section-header" style="padding: 0.75rem 1.5rem; margin: 0; cursor: pointer; user-select: none; background: white; border-bottom: 1px solid #e2e8f0;" onclick="toggleExamplesSection('loyaltyExamples')">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <h2 class="section-title" style="font-size: 0.95rem; color: #475569; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span id="loyaltyExamplesToggleIcon" style="font-size: 0.75rem; transition: transform 0.3s;">▼</span>
                            🏆 Loyalty Reward Examples
                        </h2>
                    </div>
                </div>
                <div id="loyaltyExamplesContent" style="padding: 1.5rem; display: block;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; font-size: 0.9rem;">
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">🎟️ Free Play Vouchers</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">100-500 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Free Regular Session (500 pts)</li>
                            <li>Free Special Game (100 pts)</li>
                            <li>Free Electronic Upgrade (300 pts)</li>
                            <li>Buy-One-Get-One (250 pts)</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">🍔 Food & Beverage</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">50-200 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Free Snack Pack (50 pts)</li>
                            <li>Meal Voucher (150 pts)</li>
                            <li>Drink Credits (75 pts)</li>
                            <li>Birthday Cake Slice (100 pts)</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">🎁 Merchandise</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">200-1000 Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Branded Dauber Set (200 pts)</li>
                            <li>Lucky Seat Cushion (400 pts)</li>
                            <li>Bingo Bag (600 pts)</li>
                            <li>VIP Jacket (1000 pts)</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <strong style="color: var(--warning); font-size: 1rem;">⭐ VIP Experiences</strong>
                        <div style="color: var(--secondary); font-weight: bold; margin: 0.5rem 0;">1000+ Points</div>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                            <li>Reserved Table Month (2000 pts)</li>
                            <li>Private Party Package (5000 pts)</li>
                            <li>Caller for a Day (3000 pts)</li>
                            <li>VIP Parking Pass (1500 pts)</li>
                        </ul>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.8); border-radius: 8px;">
                    <p style="font-size: 0.85rem; color: var(--gray-dark); margin: 0;">
                        <strong>💡 Loyalty Program Tips:</strong>
                    </p>
                    <ul style="font-size: 0.85rem; color: var(--gray); margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Set point values that encourage repeat visits (e.g., 1 point per $1 spent)</li>
                        <li>Create tiers of rewards from small (50 pts) to aspirational (5000+ pts)</li>
                        <li>Include experiential rewards that money can't buy</li>
                        <li>Rotate seasonal items to keep the program fresh</li>
                        <li>Consider partner rewards with local businesses</li>
                    </ul>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Loyalty Items</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="create-examples-btn" onclick="createLoyaltyExamples()">
                            ✨ Create Examples
                        </button>
                        <button class="btn btn-primary" onclick="addLoyaltyItem()">+ Add Loyalty Item</button>
                    </div>
                </div>
                
                <div id="loyaltyItemsContainer">
                    <!-- Loyalty items will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             PROMOTIONS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Marketing Section -->
        <section id="marketing" class="content-panel" style="display: none;">
            <div class="content-header" style="padding: 1rem 1.5rem; margin-bottom: 0.5rem;">
                <h1 class="content-title" style="font-size: 1.25rem; margin-bottom: 0.25rem;">Marketing & Promotions</h1>
                <p class="content-subtitle" style="font-size: 0.875rem;">Manage carousel banners, notification cards, social media, and promotional campaigns</p>
            </div>

            <!-- Hero Carousel Manager -->
            <div class="content-section" style="padding: 0.5rem 1rem;">
                <div class="section-header" style="margin-bottom: 0.75rem;">
                    <h2 class="section-title" style="font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="clapperboard" style="width: 18px; height: 18px;"></i> Hero Carousel</h2>
                    <button class="btn btn-primary" onclick="addCarouselSlide()">+ Add Custom Slide</button>
                </div>
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Carousel</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableCarousel" onchange="toggleCarousel()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show rotating banner on customer landing page
                            </div>
                        </div>
                    </div>

                    <div id="carouselSlidesList">
                        <!-- Carousel slides will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Notification Cards Manager -->
            <div class="content-section" style="padding: 0.5rem 1rem;">
                <div class="section-header" style="margin-bottom: 0.75rem;">
                    <h2 class="section-title" style="font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="clipboard-list" style="width: 18px; height: 18px;"></i> Notification Cards</h2>
                    <button class="btn btn-primary" onclick="addNotificationCard()">+ Add Custom Card</button>
                </div>
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Notification Cards</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableNotificationCards" onchange="toggleNotificationCards()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show sidebar alerts before cart (up to 4 cards visible)
                            </div>
                        </div>
                    </div>

                    <div id="notificationCardsList">
                        <!-- Notification cards will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Social Media Configuration -->
            <div class="content-section" style="padding: 0.5rem 1rem;">
                <div class="section-header" style="margin-bottom: 0.75rem;">
                    <h2 class="section-title" style="font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="smartphone" style="width: 18px; height: 18px;"></i> Social Media Links</h2>
                </div>
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Social Media Carousel Slide</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableSocialMediaCarousel" onchange="saveSocialMediaConfig()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show carousel slide promoting your social media
                            </div>
                        </div>
                    </div>

                    <div id="socialMediaPlatforms">
                        <!-- Social media platforms will be loaded here -->
                    </div>

                    <button class="btn btn-secondary" onclick="addSocialMediaPlatform()" style="margin-top: 1rem;">+ Add Platform</button>
                </div>
            </div>

            <!-- Text Updates Configuration -->
            <div class="content-section" style="padding: 0.5rem 1rem;">
                <div class="section-header" style="margin-bottom: 0.75rem;">
                    <h2 class="section-title" style="font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="smartphone" style="width: 18px; height: 18px;"></i> Text/SMS Updates</h2>
                </div>
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Text Updates Carousel Slide</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableTextUpdatesCarousel" onchange="saveTextUpdatesConfig()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show carousel slide promoting SMS signup
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">SMS Keyword</label>
                            <input type="text" class="form-input" id="smsKeyword" placeholder="BINGO" maxlength="20">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Keyword customers text (e.g., "BINGO", "DEALS")
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SMS Shortcode/Number</label>
                            <input type="text" class="form-input" id="smsShortcode" placeholder="12345" maxlength="10">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Shortcode or phone number to text
                            </p>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveTextUpdatesConfig()" style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="save" style="width: 16px; height: 16px;"></i> Save Text Updates</button>
                </div>
            </div>

            <!-- Birthday Offer Configuration -->
            <div class="content-section" style="padding: 0.5rem 1rem;">
                <div class="section-header" style="margin-bottom: 0.75rem;">
                    <h2 class="section-title" style="font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="cake" style="width: 18px; height: 18px;"></i> Birthday Offer Configuration</h2>
                </div>
                <div id="birthdayOfferContainer">
                    <!-- Birthday offer settings will be loaded here -->
                </div>
            </div>

            <!-- Welcome Popup -->
            <div class="content-section" style="padding: 0.5rem 1rem;">
                <div class="section-header" style="margin-bottom: 0.75rem;">
                    <h2 class="section-title" style="font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="party-popper" style="width: 18px; height: 18px;"></i> Welcome Popup</h2>
                </div>
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="form-label">Enable Welcome Popup</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableWelcomePopup" onchange="toggleWelcomePopupSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-description" style="margin-top: 0.5rem;">
                                Show a welcome popup with custom image when visitors first arrive
                            </div>
                        </div>
                    </div>

                    <div id="welcomePopupSettings" style="display: none; margin-top: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Popup Image</label>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <button type="button" onclick="openArtLibraryForWelcomePopup()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                                    🎨 Choose from Art Library
                                </button>
                                <button type="button" onclick="document.getElementById('welcomePopupImageFile').click()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(245, 87, 108, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(245, 87, 108, 0.3)'">
                                    📁 Upload File
                                </button>
                            </div>
                            <input type="file" id="welcomePopupImageFile" accept="image/*" onchange="handleWelcomePopupImageUpload(this)" style="display: none;">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Choose from art library or upload a banner image (recommended: 1200x400px or similar aspect ratio)
                            </p>
                            <div id="welcomePopupImagePreview" style="margin-top: 1rem;">
                                <!-- Image preview will appear here -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Welcome Message (Optional)</label>
                            <textarea class="form-input" id="welcomePopupMessage" rows="3"
                                placeholder="Enter a welcome message to display..."></textarea>
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                Optional text message to show with the image
                            </p>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <div class="form-group" style="flex: 1; max-width: 300px;">
                                <label class="form-label">Text Position</label>
                                <select class="form-select" id="welcomePopupTextPosition">
                                    <option value="bottom">Bottom of image</option>
                                    <option value="diagonal">Diagonal across image</option>
                                    <option value="none">No text overlay (message below image)</option>
                                </select>
                                <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    Choose where to display the welcome message
                                </p>
                            </div>

                            <div class="form-group" style="flex: 1; max-width: 300px;">
                                <label class="form-label">Show Frequency</label>
                                <select class="form-select" id="welcomePopupFrequency">
                                    <option value="once-per-session">Once per browser session</option>
                                    <option value="once-per-day">Once per day</option>
                                    <option value="every-visit">Every visit</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="saveWelcomePopupSettings()">
                                💾 Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="previewWelcomePopup()">
                                👁️ Preview Popup
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Promotions -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Active Promotions</h2>
                    <button class="btn btn-primary" onclick="addPromotion()">+ Add Promotion</button>
                </div>
                
                <!-- Promotion Examples -->
                <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%); border-left: 4px solid var(--success); padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <h3 style="font-size: 1rem; color: var(--success); margin: 0 0 0.5rem 0;">💡 Promotion Ideas</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.85rem; color: var(--gray-dark);">
                        <div>
                            <strong>Time-Based:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1.25rem;">
                                <li>Happy Hour (2-4 PM)</li>
                                <li>Weekend Special</li>
                                <li>Month-End Bonus</li>
                            </ul>
                        </div>
                        <div>
                            <strong>Customer-Based:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1.25rem;">
                                <li>New Player Welcome</li>
                                <li>VIP Member Perks</li>
                                <li>Referral Rewards</li>
                            </ul>
                        </div>
                        <div>
                            <strong>Event-Based:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1.25rem;">
                                <li>Holiday Specials</li>
                                <li>Anniversary Sale</li>
                                <li>Tournament Qualifier</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div id="promotionsContainer">
                    <!-- Promotions will be loaded here -->
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             ART LIBRARY SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <section id="artLibrary" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">🖼️ Art Library</h1>
                <p class="content-subtitle">Manage your art assets and access the NewCo global library</p>
            </div>

            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <p style="color: var(--gray); font-size: 0.875rem;">Upload and organize images for use in packages, marketing, and more</p>
                </div>
                <button class="btn btn-primary" onclick="showUploadCustomerArt()" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="upload" style="width: 16px; height: 16px;"></i> Upload Art</button>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid var(--gray-light); margin-bottom: 1.5rem;">
                <button class="btn" id="newcoArtTabBtn" onclick="switchArtLibraryTab('newco')"
                        style="border: none; border-bottom: 3px solid var(--primary); background: transparent; color: var(--primary); font-weight: 600; padding: 1rem 1.5rem;">
                    NewCo Global Library
                </button>
                <button class="btn" id="myArtTabBtn" onclick="switchArtLibraryTab('my')"
                        style="border: none; border-bottom: 3px solid transparent; background: transparent; color: var(--gray); font-weight: 600; padding: 1rem 1.5rem;">
                    My Library
                </button>
            </div>

            <!-- Filters -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: end;">
                <div class="form-group" style="flex: 1; min-width: 150px; max-width: 200px;">
                    <label class="form-label">Category</label>
                    <select id="filterCustomerArtCategory" class="form-select" onchange="filterCustomerArtLibrary()">
                        <option value="">All Categories</option>
                        <option value="logo">Logo</option>
                        <option value="banner">Banner</option>
                        <option value="package">Package Image</option>
                        <option value="social">Social Media</option>
                        <option value="marketing">Marketing Popup</option>
                        <option value="background">Background</option>
                        <option value="icon">Icon</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 120px; max-width: 150px;">
                    <label class="form-label">File Type</label>
                    <select id="filterCustomerArtType" class="form-select" onchange="filterCustomerArtLibrary()">
                        <option value="">All Types</option>
                        <option value="png">PNG</option>
                        <option value="jpg">JPG</option>
                        <option value="svg">SVG</option>
                        <option value="gif">GIF</option>
                        <option value="webp">WebP</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px; max-width: 300px;">
                    <label class="form-label">Search</label>
                    <input type="text" id="searchCustomerArt" class="form-input" placeholder="Search by name or description..." oninput="filterCustomerArtLibrary()">
                </div>
            </div>

            <!-- Art Grid -->
            <div id="customerArtLibraryGrid" class="art-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; padding: 1rem 0;">
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--gray);">
                    Loading art library...
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             SOCIAL MEDIA SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Social Media Section -->
        <section id="socialmedia" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Social Media Management</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshSocialStats()">
                        🔄 Refresh Stats
                    </button>
                    <button class="btn btn-primary" onclick="schedulePost()">
                        📅 Schedule Post
                    </button>
                </div>
            </div>

            <!-- Hashtag Settings -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title"># Hashtag Settings</h2>
                    <button class="btn btn-primary btn-sm" onclick="saveHashtags()">Save Hashtags</button>
                </div>
                <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Default Hashtags</label>
                        <input type="text" class="form-input" id="defaultHashtags" placeholder="#bingo #vanguardbingo #bingonight #winners" value="#bingo #vanguardbingo">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            These hashtags will be automatically added to all posts
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Promotion Hashtags</label>
                        <input type="text" class="form-input" id="promotionHashtags" placeholder="#promotion #special #limitedtime" value="#special #promotion">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Added when including promotions in posts
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Event Hashtags</label>
                        <input type="text" class="form-input" id="eventHashtags" placeholder="#event #tournament #jackpot" value="#jackpot #tournament">
                        <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                            Used for special event announcements
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Twitter Analytics Dashboard -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="bar-chart" style="width: 20px; height: 20px;"></i> Twitter Analytics</h2>
                    <select class="form-select" style="width: 200px;" onchange="updateTwitterTimeframe(this.value)">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #1DA1F2 0%, #0e71c8 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Posts</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterTotalPosts">247</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    <span style="color: #4ade80;">↑ 12%</span> from last period
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">📝</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Average Engagement</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterAvgEngagement">4.7%</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    <span style="color: #fbbf24;">↑ 0.3%</span> from last period
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">💬</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Impressions</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterImpressions">52.3K</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    <span style="color: #4ade80;">↑ 23%</span> from last period
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">👁️</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">New Followers</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="twitterNewFollowers">189</div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                    Total: <strong>3,482</strong> followers
                                </div>
                            </div>
                            <div style="font-size: 3rem; opacity: 0.3;">👥</div>
                        </div>
                    </div>
                </div>

                <!-- Engagement Chart -->
                <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">Engagement Timeline</h3>
                    <div style="height: 300px; background: linear-gradient(to bottom, rgba(29, 161, 242, 0.1) 0%, rgba(29, 161, 242, 0.02) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📈</div>
                            <div>Chart visualization would go here</div>
                            <div style="font-size: 0.875rem; margin-top: 0.5rem;">Showing likes, retweets, and replies over time</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Posts History -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="scroll" style="width: 20px; height: 20px;"></i> Recent Posts History</h2>
                    <button class="btn btn-secondary btn-sm" onclick="exportTwitterHistory()" style="display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="download" style="width: 14px; height: 14px;"></i> Export CSV
                    </button>
                </div>

                <div style="background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Post Content</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Likes</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Retweets</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Replies</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Engagement</th>
                            </tr>
                        </thead>
                        <tbody id="twitterHistoryTable">
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">Dec 28, 2024</td>
                                <td style="padding: 1rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    🎉 Join us tonight for MEGA BINGO! $5,000 jackpot up for grabs! Doors open at 5PM...
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #ef4444;">❤️ 47</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #10b981;">🔄 12</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #3b82f6;">💬 8</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="background: var(--success-light); color: var(--success); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">6.2%</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">Dec 27, 2024</td>
                                <td style="padding: 1rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    Don't forget - Early Bird Special tomorrow! First 50 players get a free dauber pack...
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #ef4444;">❤️ 31</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #10b981;">🔄 8</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #3b82f6;">💬 3</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="background: var(--warning-light); color: var(--warning); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">4.1%</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 1rem;">Dec 26, 2024</td>
                                <td style="padding: 1rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    Congratulations to tonight's big winner - Mary S. took home $2,500! 🎊 #BingoWinner
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #ef4444;">❤️ 89</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #10b981;">🔄 23</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="color: #3b82f6;">💬 15</span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <span style="background: var(--primary-light); color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">8.9%</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Schedule Posts -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="calendar" style="width: 20px; height: 20px;"></i> Scheduled Posts</h2>
                    <button class="btn btn-primary" onclick="addScheduledPost()">
                        + Schedule New Post
                    </button>
                </div>

                <div id="scheduledPostsContainer">
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; position: relative;">
                            <div style="position: absolute; top: 1rem; right: 1rem;">
                                <span style="background: var(--warning-light); color: var(--warning); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600;">
                                    Scheduled
                                </span>
                            </div>
                            <div style="display: flex; gap: 1.5rem;">
                                <div style="flex-shrink: 0;">
                                    <div style="background: linear-gradient(135deg, #1DA1F2 0%, #0e71c8 100%); color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        📅
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Dec 30, 2024 - 10:00 AM</div>
                                    <div style="color: var(--gray-dark); margin-bottom: 1rem;">
                                        New Year's Eve Spectacular! 🎊 Join us for our biggest event of the year with $10,000 in prizes! Special midnight countdown bingo session. Reserve your seats now!
                                    </div>
                                    <div style="display: flex; gap: 1rem;">
                                        <button class="btn btn-sm btn-secondary" onclick="editScheduledPost(1)">
                                            ✏️ Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteScheduledPost(1)">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; position: relative;">
                            <div style="position: absolute; top: 1rem; right: 1rem;">
                                <span style="background: var(--warning-light); color: var(--warning); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600;">
                                    Scheduled
                                </span>
                            </div>
                            <div style="display: flex; gap: 1.5rem;">
                                <div style="flex-shrink: 0;">
                                    <div style="background: linear-gradient(135deg, #1DA1F2 0%, #0e71c8 100%); color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        📅
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Jan 1, 2025 - 9:00 AM</div>
                                    <div style="color: var(--gray-dark); margin-bottom: 1rem;">
                                        Happy New Year! 🎉 Start 2025 with us! January special: Buy 2 packs, get 1 FREE all month long. See you at the hall!
                                    </div>
                                    <div style="display: flex; gap: 1rem;">
                                        <button class="btn btn-sm btn-secondary" onclick="editScheduledPost(2)">
                                            ✏️ Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteScheduledPost(2)">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Best Performing Posts -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="trophy" style="width: 20px; height: 20px;"></i> Top Performing Posts</h2>
                    <select class="form-select" style="width: 150px;" onchange="updateTopPostsTimeframe(this.value)">
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>

                <div style="display: grid; gap: 1rem;">
                    <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%); border: 2px solid #fbbf24; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">🥇</div>
                            <div style="background: #fbbf24; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                12.3% Engagement
                            </div>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Winner Announcement Post</div>
                        <div style="color: var(--gray-dark); font-size: 0.95rem; margin-bottom: 1rem;">
                            "🎊 JACKPOT ALERT! Congratulations to Robert M. who just won our $5,000 progressive jackpot! This could be YOU next week!"
                        </div>
                        <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: var(--gray);">
                            <span>❤️ 234 likes</span>
                            <span>🔄 67 retweets</span>
                            <span>💬 45 replies</span>
                            <span>Dec 15, 2024</span>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(192, 192, 192, 0.1) 0%, rgba(192, 192, 192, 0.05) 100%); border: 2px solid #c0c0c0; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">🥈</div>
                            <div style="background: #c0c0c0; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                9.8% Engagement
                            </div>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Christmas Special Announcement</div>
                        <div style="color: var(--gray-dark); font-size: 0.95rem; margin-bottom: 1rem;">
                            "🎄 CHRISTMAS MEGA BINGO! Dec 23rd - $10,000 in prizes! Early bird gets free holiday meal. Limited seats - book now!"
                        </div>
                        <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: var(--gray);">
                            <span>❤️ 189 likes</span>
                            <span>🔄 52 retweets</span>
                            <span>💬 28 replies</span>
                            <span>Dec 10, 2024</span>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(205, 127, 50, 0.1) 0%, rgba(205, 127, 50, 0.05) 100%); border: 2px solid #cd7f32; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">🥉</div>
                            <div style="background: #cd7f32; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                8.4% Engagement
                            </div>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Free Dauber Friday</div>
                        <div style="color: var(--gray-dark); font-size: 0.95rem; margin-bottom: 1rem;">
                            "IT'S FRIDAY! 🎉 First 100 players get a FREE dauber set! Doors open at 4PM. Who's ready for some weekend bingo?"
                        </div>
                        <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: var(--gray);">
                            <span>❤️ 156 likes</span>
                            <span>🔄 41 retweets</span>
                            <span>💬 22 replies</span>
                            <span>Dec 8, 2024</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             BASIC OFFERINGS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Basic Offerings Section -->
        <section id="salesItems" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Basic Offerings</h1>
                <p class="content-subtitle">Define your basic bingo items that can be sold individually or included in packages</p>
            </div>
            
            <!-- Examples Section -->
            <div class="content-section" id="offeringsExamplesSection" style="background: #f0f4f8; border-left: 3px solid #64748b; padding: 0; overflow: hidden; transition: all 0.3s ease;">
                <div class="section-header" style="padding: 0.75rem 1.5rem; margin: 0; cursor: pointer; user-select: none; background: white; border-bottom: 1px solid #e2e8f0;" onclick="toggleExamplesSection('offeringsExamples')">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <h2 class="section-title" style="font-size: 0.95rem; color: #475569; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span id="offeringsExamplesToggleIcon" style="font-size: 0.75rem; transition: transform 0.3s;">▼</span>
                            💡 Common Basic Offerings Examples
                        </h2>
                    </div>
                </div>
                <div id="offeringsExamplesContent" style="padding: 1.5rem; display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                        <div>
                            <strong style="color: #3b82f6;">Regular Cards:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                                <li>3-on Paper (6 cards) - $1</li>
                                <li>6-on Paper (18 cards) - $2</li>
                                <li>9-on Paper (27 cards) - $3</li>
                            </ul>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">Special Games:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                                <li>Early Bird Special - $5</li>
                                <li>Warm-Up Games - $2</li>
                                <li>Progressive Jackpot - $1</li>
                            </ul>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">Electronic Options:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                                <li>Electronic Unit (24 cards) - $20</li>
                                <li>Power Pack (48 cards) - $35</li>
                                <li>Max Pack (72 cards) - $50</li>
                            </ul>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">Extras & Add-ons:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--gray-dark);">
                                <li>Daubers - $2</li>
                                <li>Bonanza Cards - $1</li>
                                <li>Second Chance Drawing - $1</li>
                            </ul>
                        </div>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--gray); font-style: italic;">
                        💡 Tip: Start by creating your most common items, then build packages that combine them for better value!
                    </p>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Basic Items</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="create-examples-btn" onclick="createSalesItemExamples()">
                            ✨ Create Examples
                        </button>
                        <button class="btn btn-primary" onclick="addSalesItem()">+ Add Offering</button>
                    </div>
                </div>
                
                <div id="salesItemsContainer">
                    <!-- Sales items will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Members Database Section -->
        <section id="members" class="content-panel" style="display: none;">

            <!-- Compact Filters with Title -->
            <div class="content-section" style="padding: 0.75rem 1rem; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; margin: 0; white-space: nowrap; display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="users" style="width: 22px; height: 22px;"></i> Members Database</h2>
                    <input type="text" class="form-input" id="memberSearchName" placeholder="Search by name..." oninput="filterMembers()" style="flex: 1; min-width: 150px; max-width: 200px;">
                    <input type="number" class="form-input" id="memberMinPoints" placeholder="Min Points" oninput="filterMembers()" style="flex: 1; min-width: 100px; max-width: 120px;">
                    <input type="number" class="form-input" id="memberMinSpend" placeholder="Min Spend" oninput="filterMembers()" style="flex: 1; min-width: 100px; max-width: 120px;">
                    <select class="form-select" id="memberDateRange" onchange="filterMembers()" style="flex: 1; min-width: 120px; max-width: 150px;">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    <select class="form-select" id="memberActivity" onchange="filterMembers()" style="flex: 1; min-width: 120px; max-width: 150px;">
                        <option value="all">All Members</option>
                        <option value="active">Active (30 days)</option>
                        <option value="inactive">Inactive</option>
                        <option value="new">New (7 days)</option>
                    </select>
                    <select class="form-select" id="memberSortBy" onchange="filterMembers()" style="flex: 1; min-width: 120px; max-width: 150px;">
                        <option value="name">Name</option>
                        <option value="points">Loyalty Points</option>
                        <option value="lifetime">Lifetime Loyalty</option>
                        <option value="spend">Lifetime Spend</option>
                        <option value="average">Average Spend</option>
                        <option value="monthly">Monthly Spend</option>
                        <option value="created">Date Created</option>
                        <option value="lastLogin">Last Login</option>
                    </select>
                    <button class="btn btn-primary" onclick="resetMemberFilters()" style="white-space: nowrap;">Reset</button>
                </div>
            </div>

            <!-- Members Stats -->
            <div class="content-section" style="padding: 0.75rem 1rem 0.5rem;">
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-light), white); padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Total Members</div>
                        <div class="stat-value" id="totalMembersCount" style="font-size: 2rem; font-weight: bold; color: var(--primary);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), white); padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Active This Month</div>
                        <div class="stat-value" id="activeMonthCount" style="font-size: 2rem; font-weight: bold; color: var(--success);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), white); padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Avg Loyalty Points</div>
                        <div class="stat-value" id="avgPointsCount" style="font-size: 2rem; font-weight: bold; color: var(--warning);">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), white); padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="stat-label" style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Avg Monthly Spend</div>
                        <div class="stat-value" id="avgMonthlySpend" style="font-size: 2rem; font-weight: bold; color: var(--primary);">$0</div>
                    </div>
                </div>
            </div>

            <!-- Members Table -->
            <div class="content-section" style="padding: 0.5rem 1rem 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="font-size: 1.1rem; font-weight: 700; margin: 0;">Member List</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success test-data-btn" onclick="generateTestMembers()" title="Add 50 test members" style="display: none; align-items: center; gap: 0.5rem;"><i data-lucide="plus" style="width: 16px; height: 16px;"></i> Add Test Members (+50)</button>
                        <button class="btn btn-danger test-data-btn" onclick="deleteTestMembers()" title="Delete all test members" style="display: none; align-items: center; gap: 0.5rem;"><i data-lucide="trash-2" style="width: 16px; height: 16px;"></i> Delete Test Members</button>
                        <button class="btn btn-warning" onclick="toggleTopPerformers()" id="topPerformersBtn" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="trophy" style="width: 16px; height: 16px;"></i> Top Performers</button>
                        <button class="btn btn-secondary" onclick="exportMembers()" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="download" style="width: 16px; height: 16px;"></i> Export CSV</button>
                        <button class="btn btn-primary" onclick="addMember()">+ Add Member</button>
                    </div>
                </div>
                
                <!-- Top Performers Section (Hidden by default) -->
                <div id="topPerformersSection" style="display: none; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 255, 255, 0.95) 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--warning); margin-top: 1rem;">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--warning); font-size: 1.25rem; margin: 0;">🏆 Top Performers This Month</h3>
                            <select class="form-select" id="performersPeriod" onchange="loadTopPerformers()" style="width: 200px;">
                                <option value="month">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div>
                                <h4 style="font-size: 1rem; color: var(--gray); margin-bottom: 1rem;">💰 Most Points Earned</h4>
                                <div id="topEarners" style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <!-- Top earners will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h4 style="font-size: 1rem; color: var(--gray); margin-bottom: 1rem;">🎁 Most Points Redeemed</h4>
                                <div id="topRedeemers" style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <!-- Top redeemers will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h4 style="font-size: 1rem; color: var(--gray); margin-bottom: 1rem;">⭐ Most Active Members</h4>
                                <div id="mostActive" style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <!-- Most active members will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="members-table" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('name')">
                                    Name <span id="sortArrowName">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('points')">
                                    Loyalty Points <span id="sortArrowPoints">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('lifetime')">
                                    Lifetime Loyalty <span id="sortArrowLifetime">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('logins')">
                                    Logins <span id="sortArrowLogins">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('spend')">
                                    Lifetime Spend <span id="sortArrowSpend">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('average')">
                                    Avg Spend <span id="sortArrowAverage">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('monthly')">
                                    Monthly Spend <span id="sortArrowMonthly">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('created')">
                                    Created <span id="sortArrowCreated">↕️</span>
                                </th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--gray-dark); cursor: pointer;" onclick="sortMembers('lastLogin')">
                                    Last Login <span id="sortArrowLastLogin">↕️</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                            <!-- Members will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;">
                    <div id="membersPagination" style="display: flex; gap: 0.5rem;">
                        <!-- Pagination buttons will be here -->
                    </div>
                    <div style="color: var(--gray);">
                        Showing <span id="membersShowing">0</span> of <span id="membersTotal">0</span> members
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Rewards Program Section -->
        <section id="rewards" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">Rewards Program</h1>
                <p class="content-subtitle">Monitor and manage your loyalty rewards program</p>
            </div>

            <!-- Enable/Disable Loyalty Program -->
            <div class="content-section">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <strong>Enable Loyalty Rewards Program</strong>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableLoyaltyProgram" onchange="toggleLoyaltyProgram()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p style="color: var(--gray); font-size: 0.95rem; margin: 0;">
                        When disabled, loyalty points will be hidden from customer site and no points will be earned or redeemed
                    </p>

                    <!-- Marketing Text (shown when disabled) -->
                    <div id="rewardsMarketingText" style="display: none; padding: 2rem; margin-top: 1.5rem; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; color: white;">🎁 Why Use a Loyalty Rewards Program?</h3>
                        <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem;">
                            A loyalty rewards program helps you retain customers, increase repeat visits, and build lasting relationships with your members.
                            Turn one-time visitors into loyal regulars who feel valued and appreciated.
                        </p>
                        <ul style="font-size: 1rem; line-height: 1.8; margin: 0; padding-left: 1.5rem;">
                            <li>💰 Increase customer lifetime value</li>
                            <li>🔄 Boost repeat visit frequency</li>
                            <li>📈 Track member spending and preferences</li>
                            <li>🎯 Target promotions to your best customers</li>
                            <li>⭐ Build emotional connection and brand loyalty</li>
                            <li>📊 Gain valuable insights into customer behavior</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="loyaltyProgramContent" style="display: none;">
            <!-- Monthly Metrics (HIDDEN - fake data not connected to system) -->
            <div class="content-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="bar-chart" style="width: 20px; height: 20px;"></i> Monthly Metrics</h2>
                    <select class="form-select" id="rewardsMonth" onchange="loadRewardsMetrics()" style="width: 200px;">
                        <option value="current">Current Month</option>
                        <option value="last">Last Month</option>
                        <option value="3months">Last 3 Months</option>
                        <option value="6months">Last 6 Months</option>
                        <option value="year">Last Year</option>
                    </select>
                </div>

                <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <div class="metric-card" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">💰</div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Monthly Points Earned</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="monthlyPointsEarned">0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">↑ 12% from last month</div>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card" style="background: linear-gradient(135deg, #ff9800, #ffb74d); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">🎁</div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Monthly Points Redeemed</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="monthlyPointsRedeemed">0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">↑ 8% from last month</div>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card" style="background: linear-gradient(135deg, #2196f3, #64b5f6); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">👥</div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Active Loyalty Members</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="activeLoyaltyUsers">0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">↑ 15% from last month</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rewards Program Type Selection -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="target" style="width: 20px; height: 20px;"></i> Rewards Program Type</h2>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <label class="reward-type-card" style="position: relative; padding: 1.5rem; background: white; border: 2px solid var(--gray-light); border-radius: 12px; cursor: not-allowed; opacity: 0.6; transition: all 0.3s;">
                        <input type="radio" name="rewardType" value="lifetime" disabled style="position: absolute; top: 1rem; right: 1rem; cursor: not-allowed;">
                        <div style="padding-right: 2rem;" onclick="showComingSoonModal('Lifetime Tiers')">
                            <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">🏆 Lifetime Tiers</div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Permanent Status Levels</div>
                            <div style="font-size: 0.875rem; color: var(--gray); line-height: 1.4;">Members advance through tiers based on lifetime spending and keep their status permanently</div>
                            <div style="position: absolute; top: 0.5rem; left: 0.5rem; background: var(--warning); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">Coming Soon</div>
                        </div>
                    </label>

                    <label class="reward-type-card" style="position: relative; padding: 1.5rem; background: white; border: 2px solid var(--gray-light); border-radius: 12px; cursor: not-allowed; opacity: 0.6; transition: all 0.3s;">
                        <input type="radio" name="rewardType" value="temporary" disabled style="position: absolute; top: 1rem; right: 1rem; cursor: not-allowed;">
                        <div style="padding-right: 2rem;" onclick="showComingSoonModal('Temporary Tiers')">
                            <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">⏰ Temporary Tiers</div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--warning); margin-bottom: 0.5rem;">Time-Limited Status</div>
                            <div style="font-size: 0.875rem; color: var(--gray); line-height: 1.4;">Members can purchase tier status for a limited time period with enhanced benefits</div>
                            <div style="position: absolute; top: 0.5rem; left: 0.5rem; background: var(--warning); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">Coming Soon</div>
                        </div>
                    </label>

                    <label class="reward-type-card" style="position: relative; padding: 1.5rem; background: white; border: 2px solid var(--success); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <input type="radio" name="rewardType" value="bonuses" checked onchange="updateRewardType('bonuses')" style="position: absolute; top: 1rem; right: 1rem;">
                        <div style="padding-right: 2rem;">
                            <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">🎁 Bonuses Only</div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--success); margin-bottom: 0.5rem;">Simple Points System</div>
                            <div style="font-size: 0.875rem; color: var(--gray); line-height: 1.4;">No tiers, just earn points on purchases and redeem for rewards</div>
                        </div>
                    </label>
                </div>
                
                <!-- Styles moved to newco-admin.css -->
            </div>
            
            <!-- Points Configuration -->
            <div class="content-section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="settings" style="width: 20px; height: 20px;"></i> Basic Points Settings</h2>
                    <button class="btn btn-primary" onclick="saveRewardsConfig()" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="save" style="width: 16px; height: 16px;"></i> Save All Settings</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    <div>
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--gray-dark);">Points Currency</h3>
                        <div class="form-group" style="margin-bottom: 2rem;">
                            <label class="form-label">💰 Points Currency Name</label>
                            <input type="text" class="form-input" id="rewardsPointsCurrency" value="Loyalty Points" placeholder="e.g., Stars, Tokens, Coins, Loyalty Points">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                Name displayed for loyalty points throughout the system (e.g., "Stars", "Tokens", "Coins")
                            </p>
                        </div>
                        
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--gray-dark);">Earning Rules</h3>
                        <div class="form-group">
                            <label class="form-label">🌐 Web Earned Points per $</label>
                            <input type="number" class="form-input" id="webPointsPerDollar" value="10" min="0" step="1">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                Points earned for every dollar spent on web purchases
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">🏢 Floor Earned Points per $</label>
                            <input type="number" class="form-input" id="floorPointsPerDollar" value="10" min="0" step="1">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                                Points earned for every dollar spent on floor purchases
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Birthday Bonus</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                <span>Enable Birthday Bonus</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="birthdayBonusEnabled" checked onchange="toggleBirthdayBonus()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div id="birthdayBonusConfig" style="padding-left: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                    <label style="width: 100px;">Points</label>
                                    <input type="number" class="form-input" id="birthdayBonusPoints" value="500" min="0" style="width: 150px;">
                                </div>
                                <div style="margin-top: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="radio" name="birthdayRequirement" id="birthdayRequiresPurchase" value="purchase">
                                        <span>Requires purchase on birthday</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="radio" name="birthdayRequirement" id="birthdayAutomatic" value="automatic" checked>
                                        <span>Automatically awarded</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="radio" name="birthdayRequirement" id="birthdayRequiresAttendance" value="attendance">
                                        <span>Requires attendance on birthday</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" id="birthdayTriggerEmail">
                                        <span>Trigger email notification</span>
                                    </label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; padding-left: 1.5rem;" id="emailDaysBeforeContainer">
                                        <label style="width: 120px;">Days before birthday</label>
                                        <input type="number" class="form-input" id="birthdayEmailDaysBefore" value="7" min="0" max="30" style="width: 80px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Sign-up Bonus</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                <span>Enable Sign-up Bonus</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="signupBonusEnabled" checked onchange="toggleSignupBonus()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div id="signupBonusConfig" style="padding-left: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label style="width: 100px;">Points</label>
                                    <input type="number" class="form-input" id="signupBonusPoints" value="100" min="0" style="width: 150px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--gray-dark);">Point Expiration</h3>
                        <div class="form-group">
                            <label class="form-label">Points Expire After</label>
                            <select class="form-select" id="pointsExpiration">
                                <option value="never">Never</option>
                                <option value="6months">6 Months</option>
                                <option value="1year">1 Year</option>
                                <option value="2years">2 Years</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tier Configuration (shown based on selection) -->
            <div class="content-section" id="tierConfiguration">
                <!-- Lifetime Tiers Configuration -->
                <div id="lifetimeTiersConfig" style="display: block;">
                    <div class="section-header">
                        <h2 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;"><i data-lucide="trophy" style="width: 20px; height: 20px;"></i> Lifetime Tier Configuration</h2>
                    </div>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Tier 1 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #cd7f32;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier 1 Name</label>
                                    <input type="text" class="form-input" id="tier1Name" value="Bronze" placeholder="e.g., Bronze">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Required</label>
                                    <input type="number" class="form-input" id="tier1Points" value="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tier1DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all">All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tier1Discount" value="0" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tier1BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all">All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tier1Multiplier" value="1" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tier 2 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #c0c0c0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier 2 Name</label>
                                    <input type="text" class="form-input" id="tier2Name" value="Silver" placeholder="e.g., Silver">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Required</label>
                                    <input type="number" class="form-input" id="tier2Points" value="1000" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tier2DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all">All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tier2Discount" value="5" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tier2BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tier2Multiplier" value="1.25" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tier 3 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #ffd700;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier 3 Name</label>
                                    <input type="text" class="form-input" id="tier3Name" value="Gold" placeholder="e.g., Gold">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Required</label>
                                    <input type="number" class="form-input" id="tier3Points" value="5000" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tier3DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tier3Discount" value="10" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tier3BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tier3Multiplier" value="1.5" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Temporary Tiers Configuration -->
                <div id="temporaryTiersConfig" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">⏰ Temporary Tier Configuration</h2>
                    </div>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Temp Tier 1 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #9c27b0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier Name</label>
                                    <input type="text" class="form-input" id="tempTier1Name" value="VIP Pass" placeholder="e.g., VIP Pass">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Payment Options</label>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier1PayCash" checked onchange="toggleTempTierPayment(1)">
                                            <span style="font-size: 0.875rem;">Cash ($)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier1PayPoints" onchange="toggleTempTierPayment(1)">
                                            <span style="font-size: 0.875rem;">Loyalty Points</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" id="tempTier1CashCost">
                                    <label class="form-label">Cost ($)</label>
                                    <input type="number" class="form-input" id="tempTier1Cost" value="19.99" min="0" step="0.01">
                                </div>
                                <div class="form-group" id="tempTier1PointsCost" style="display: none;">
                                    <label class="form-label">Cost (Points)</label>
                                    <input type="number" class="form-input" id="tempTier1PointsPrice" value="2000" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration (Days)</label>
                                    <input type="number" class="form-input" id="tempTier1Duration" value="30" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tempTier1DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tempTier1Discount" value="15" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tempTier1BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tempTier1Multiplier" value="2" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Temp Tier 2 -->
                        <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #e91e63;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Tier Name</label>
                                    <input type="text" class="form-input" id="tempTier2Name" value="Premium Pass" placeholder="e.g., Premium Pass">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Payment Options</label>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier2PayCash" checked onchange="toggleTempTierPayment(2)">
                                            <span style="font-size: 0.875rem;">Cash ($)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                            <input type="checkbox" id="tempTier2PayPoints" onchange="toggleTempTierPayment(2)">
                                            <span style="font-size: 0.875rem;">Loyalty Points</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" id="tempTier2CashCost">
                                    <label class="form-label">Cost ($)</label>
                                    <input type="number" class="form-input" id="tempTier2Cost" value="49.99" min="0" step="0.01">
                                </div>
                                <div class="form-group" id="tempTier2PointsCost" style="display: none;">
                                    <label class="form-label">Cost (Points)</label>
                                    <input type="number" class="form-input" id="tempTier2PointsPrice" value="5000" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration (Days)</label>
                                    <input type="number" class="form-input" id="tempTier2Duration" value="90" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select class="form-select" id="tempTier2DiscountType">
                                        <option value="none">No Discount</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-input" id="tempTier2Discount" value="20" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points Bonus</label>
                                    <select class="form-select" id="tempTier2BonusType">
                                        <option value="none">No Bonus</option>
                                        <option value="all" selected>All Purchases</option>
                                        <option value="web">Web Purchases Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bonus Multiplier</label>
                                    <input type="number" class="form-input" id="tempTier2Multiplier" value="3" step="0.1" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bonuses Only Configuration (HIDDEN per user request) -->
                <div id="bonusesOnlyConfig" style="display: none;">
                    <!-- Removed: Bonuses configuration section hidden per user request -->
            </div>
            </div> <!-- End loyaltyProgramContent -->

        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             ART LIBRARY SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Art Library Section -->
        <section id="artlibrary" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Art Library</h1>
            </div>

            <div class="content-section">
                <div style="text-align: center; padding: 4rem 2rem; color: var(--gray);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🎨</div>
                    <h2 style="color: var(--gray-dark); margin-bottom: 1rem;">Art Library Coming Soon</h2>
                    <p style="max-width: 500px; margin: 0 auto; line-height: 1.6;">
                        The art library feature will be available in a future update. 
                        For now, packages and items will display with simple, clean designs.
                    </p>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             INTEGRATIONS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <!-- Integrations Section -->
        <section id="integrations" class="content-panel" style="display: none;">
            <div class="content-header">
                <h1 class="content-title">🔗 Integrations</h1>
                <p class="content-subtitle">Connect with external systems and services to power your operations</p>
            </div>

            <div class="content-section" style="max-width: 900px;">
                <!-- Payment Processing Integration -->
                <div class="integration-section" style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 2rem; border-left: 6px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1.5rem;">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #4caf50, #66bb6a); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                                💳
                            </div>
                            <div>
                                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Payment Processing</h2>
                                <p style="margin: 0.25rem 0 0; color: var(--gray); font-size: 1rem;">Accept payments online and in-person</p>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="paymentProcessingToggle" onchange="togglePaymentProcessing()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Marketing Box (When Disabled) -->
                    <div id="paymentProcessingMarketing" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(255,255,255,0.95)); padding: 2rem; border-radius: 12px; border: 2px solid rgba(76, 175, 80, 0.3);">
                            <h3 style="color: var(--success); font-size: 1.25rem; margin: 0 0 1rem;">Why Enable Payment Processing?</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; line-height: 2;">
                                <li><strong>Accept Credit & Debit Cards</strong> - Process Visa, Mastercard, Amex, Discover</li>
                                <li><strong>Online & In-Person Payments</strong> - Unified processing across all channels</li>
                                <li><strong>Automatic Reconciliation</strong> - Transactions sync with your records instantly</li>
                                <li><strong>PCI Compliant</strong> - Industry-leading security protects your customers</li>
                                <li><strong>Fraud Protection</strong> - Advanced fraud detection included</li>
                                <li><strong>Reporting & Analytics</strong> - Real-time transaction insights</li>
                            </ul>
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.1);">
                                <p style="margin: 0; color: var(--gray); font-size: 0.95rem;"><strong>Ready to get started?</strong> Toggle the switch above to enable payment processing and connect your accounts.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration (When Enabled) -->
                    <div id="paymentProcessingConfig" style="display: none;">
                        <!-- TABS -->
                        <div style="display: flex; gap: 0.5rem; margin: 1.5rem 0; border-bottom: 2px solid #e0e0e0;">
                            <button class="payment-tab-btn active" onclick="showPaymentTab('web')" data-tab="web" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid #4caf50; font-size: 1rem; font-weight: 600; color: var(--success); cursor: pointer; transition: all 0.2s; margin-bottom: -2px;">
                                🌐 Web Processing
                            </button>
                            <button class="payment-tab-btn" onclick="showPaymentTab('terminal')" data-tab="terminal" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; font-size: 1rem; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; margin-bottom: -2px;">
                                🏪 In-Store Terminals
                            </button>
                        </div>

                        <!-- WEB PROCESSING TAB -->
                        <div id="webPaymentTab" class="payment-tab-content" style="display: block;">
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 1rem;">
                                <!-- Combined 2Accept + Authorize.Net Section -->
                                <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1.5rem;">
                                    <!-- Header with both company names -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <div>
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                                <h3 style="margin: 0; font-size: 1.4rem; font-weight: 700; color: #1976d2;">2Accept</h3>
                                                <span style="color: var(--gray); font-size: 1.2rem;">+</span>
                                                <h3 style="margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--danger);">Authorize.Net</h3>
                                            </div>
                                            <p style="margin: 0; color: var(--gray); font-size: 0.95rem;">Merchant Account + Payment Gateway</p>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span id="authorizeNetStatus" style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                            <span id="authorizeNetStatusText" style="font-size: 0.875rem; color: var(--success); font-weight: 600;">Sandbox Connected</span>
                                        </div>
                                    </div>

                                    <!-- How it works explanation -->
                                    <div style="background: #f8f9fa; padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                        <h4 style="margin: 0 0 0.75rem; font-size: 1rem; font-weight: 600; color: var(--gray-dark);">How It Works</h4>
                                        <ol style="margin: 0; padding-left: 1.25rem; color: var(--gray-dark); line-height: 1.8;">
                                            <li><strong>Sign up with 2Accept</strong> - They specialize in reliable merchant accounts for bingo/gaming (48-hour approval)</li>
                                            <li><strong>Get approved</strong> - 2Accept will provide you with Authorize.Net API credentials</li>
                                            <li><strong>Enter credentials below</strong> - Paste the credentials from 2Accept to connect your payment processing</li>
                                        </ol>
                                    </div>

                                    <!-- Sign Up Button -->
                                    <div style="margin-bottom: 1.5rem;">
                                        <a href="https://www.2accept.net/" target="_blank" class="btn btn-success" style="text-decoration: none;">
                                            <span style="font-size: 1.1rem; margin-right: 0.5rem;">🚀</span> Sign Up with 2Accept
                                        </a>
                                        <p style="margin: 0.5rem 0 0; color: var(--gray); font-size: 0.85rem;">NewCo's exclusive payment partner for bingo halls</p>
                                    </div>

                                    <!-- Divider -->
                                    <div style="border-top: 2px solid #e0e0e0; margin: 1.5rem 0; position: relative;">
                                        <span style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 1rem; color: var(--gray); font-size: 0.85rem; font-weight: 600;">AFTER APPROVAL</span>
                                    </div>

                                    <!-- Authorize.Net Credentials Form -->
                                    <div style="margin-top: 2rem;">
                                        <h4 style="margin: 0 0 1rem; font-size: 1.1rem; font-weight: 600; color: var(--gray-dark);">Enter Your Authorize.Net Credentials</h4>
                                        <div class="form-group">
                                            <label class="form-label">
                                                API Login ID
                                                <span style="cursor: help; color: #1976d2; margin-left: 0.5rem;" title="Your unique identifier for API access.

How to get it:
• Provided by 2Accept after merchant account approval
• OR log into Authorize.Net dashboard
• Go to Account → API Credentials & Keys
• Find your API Login ID (8+ characters)
• Copy and paste here

Note: Keep this credential secure. Never share it publicly.">ⓘ</span>
                                            </label>
                                            <input type="text" class="form-input" id="authorizeNetApiLogin" placeholder="Enter your API Login ID (8+ characters)">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                Transaction Key
                                                <span style="cursor: help; color: #1976d2; margin-left: 0.5rem;" title="Secret key used to authenticate API transactions.

How to get it:
• Provided by 2Accept after merchant account approval
• OR log into Authorize.Net dashboard
• Go to Account → API Credentials & Keys
• Click 'New Transaction Key' or 'Request New Key'
• Authorize.Net will show the key ONCE - copy it immediately
• Paste it here (you won't be able to view it again)

Note: If you lose it, you must generate a new one. The old key will stop working.">ⓘ</span>
                                            </label>
                                            <input type="password" class="form-input" id="authorizeNetTransactionKey" placeholder="Enter your Transaction Key (16 characters)">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                Public Client Key
                                                <span style="cursor: help; color: #1976d2; margin-left: 0.5rem;" title="Required for Accept.js tokenization to securely process card data in the browser.

How to get it:
• Log into Authorize.Net dashboard (sandbox or production)
• Click 'Account' in the top menu
• Select 'Security Settings'
• Click 'Manage Public Client Key'
• Click 'Create New Public Client Key' or 'Submit'
• Copy the key that appears
• Paste it here

Note: This is safe to use in client-side code. It only allows creating payment tokens, not charging cards.">ⓘ</span>
                                            </label>
                                            <input type="text" class="form-input" id="authorizeNetPublicKey" placeholder="Enter your Public Client Key">
                                        </div>

                                        <!-- Active Environment Indicator -->
                                        <div id="activeEnvironmentIndicator" style="margin-top: 1.5rem; padding: 1rem; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong style="color: #2e7d32; font-size: 1rem;">SANDBOX</strong>
                                                <p style="margin: 0.25rem 0 0; font-size: 0.875rem; color: #555;">Test mode - No real charges</p>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button id="activateSandboxBtn" class="btn btn-success" onclick="activateSandbox()" title="Sandbox mode uses test credentials. No real charges will be made. Perfect for testing your payment flow.">Sandbox</button>
                                                <button id="activateProductionBtn" class="btn" style="background: #9e9e9e; color: white; display: none;" onclick="activateProduction()" disabled title="This button will become available when your account credentials are saved. Once clicked it will activate all of your payment processing elements.">Production</button>
                                            </div>
                                        </div>

                                        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                                            <button class="btn btn-primary" onclick="saveAuthorizeNetCredentials()">Save Credentials</button>
                                            <button class="btn btn-secondary" onclick="testAuthorizeNetConnection()">Test Connection</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- IN-STORE TERMINALS TAB -->
                        <div id="terminalPaymentTab" class="payment-tab-content" style="display: none;">
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 1rem;">
                                <!-- 2Accept + Authorize.Net Header -->
                                <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                                <h3 style="margin: 0; font-size: 1.4rem; font-weight: 700; color: #1976d2;">2Accept</h3>
                                                <span style="color: var(--gray); font-size: 1.2rem;">+</span>
                                                <h3 style="margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--danger);">Authorize.Net</h3>
                                            </div>
                                            <p style="margin: 0; color: var(--gray); font-size: 0.95rem;">Merchant Account + Payment Gateway</p>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                            <span style="font-size: 0.875rem; color: var(--success); font-weight: 600;">Sandbox Connected</span>
                                        </div>
                                    </div>
                                </div>

                                <h4 style="margin: 0 0 1rem; font-size: 1.1rem; color: #333;">Physical Card Terminals</h4>
                                <p style="color: #666; margin: 0 0 1.5rem 0;">Configure card readers for each bingo hall location</p>

                                <!-- Configured Terminals List -->
                                <div id="terminalsList">
                                    <!-- Terminals will be loaded here -->
                                </div>

                                <button class="btn btn-success" onclick="showAddTerminalModal()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; font-size: 1rem;">
                                    ➕ Add New Terminal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QuickBooks Integration -->
                <div class="integration-section" style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 2rem; border-left: 6px solid #2ca01c;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1.5rem;">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #2ca01c, #4caf50); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 12px rgba(44, 160, 28, 0.3);">
                                📊
                            </div>
                            <div>
                                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">QuickBooks</h2>
                                <p style="margin: 0.25rem 0 0; color: var(--gray); font-size: 1rem;">Accounting & bookkeeping integration</p>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="quickbooksToggle" onchange="toggleQuickBooks()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Marketing Box -->
                    <div id="quickbooksMarketing" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(44, 160, 28, 0.1), rgba(255,255,255,0.95)); padding: 2rem; border-radius: 12px; border: 2px solid rgba(44, 160, 28, 0.3);">
                            <h3 style="color: #2ca01c; font-size: 1.25rem; margin: 0 0 1rem;">Why Connect QuickBooks?</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; line-height: 2;">
                                <li><strong>Automatic Sync</strong> - Transactions, invoices, and payments sync automatically</li>
                                <li><strong>Accurate Books</strong> - Eliminate manual entry errors and save hours of work</li>
                                <li><strong>Real-Time Reporting</strong> - See up-to-date financial data in QuickBooks</li>
                                <li><strong>Tax Ready</strong> - All transactions categorized and ready for tax filing</li>
                                <li><strong>Cash Flow Insights</strong> - Track revenue and expenses effortlessly</li>
                            </ul>
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.1);">
                                <p style="margin: 0; color: var(--gray); font-size: 0.95rem;"><strong>Ready to connect?</strong> Toggle the switch above to link your QuickBooks account.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div id="quickbooksConfig" style="display: none;">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span id="quickbooksConnectionStatus" style="width: 10px; height: 10px; background: #ff9800; border-radius: 50%;"></span>
                                <span id="quickbooksConnectionText" style="font-weight: 600; color: #ff9800;">Not Connected</span>
                            </div>
                            <p style="margin: 0.5rem 0 0; color: var(--gray-dark); line-height: 1.6;">
                                Connect your QuickBooks account using OAuth 2.0. Your data is secured and you can disconnect at any time.
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-success" onclick="connectQuickBooks()">
                                <span style="font-size: 1.1rem; margin-right: 0.5rem;">🔗</span> Connect to QuickBooks
                            </button>
                            <button class="btn btn-secondary" onclick="showQuickBooksSettings()" id="quickbooksSettingsBtn" style="display: none;">
                                Settings
                            </button>
                            <button class="btn btn-danger" onclick="disconnectQuickBooks()" id="quickbooksDisconnectBtn" style="display: none;">
                                Disconnect
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SAR Integration -->
                <div class="integration-section" style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 16px rgba(0,0,0,0.08); border-left: 6px solid #9c27b0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1.5rem;">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #9c27b0, #ba68c8); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);">
                                📈
                            </div>
                            <div>
                                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">SAR - Stand Alone Reporting</h2>
                                <p style="margin: 0.25rem 0 0; color: var(--gray); font-size: 1rem;">Advanced session reporting for bingo halls</p>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sarToggle" onchange="toggleSAR()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Marketing Box -->
                    <div id="sarMarketing" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(255,255,255,0.95)); padding: 2rem; border-radius: 12px; border: 2px solid rgba(156, 39, 176, 0.3);">
                            <h3 style="color: #9c27b0; font-size: 1.25rem; margin: 0 0 1rem;">Why Use SAR?</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; line-height: 2;">
                                <li><strong>Session Analytics</strong> - Detailed insights into each bingo session</li>
                                <li><strong>Attendance Tracking</strong> - Monitor player counts and trends</li>
                                <li><strong>Revenue Analysis</strong> - Track income per session and day</li>
                                <li><strong>Game Performance</strong> - See which games and packages perform best</li>
                                <li><strong>Staff Metrics</strong> - Evaluate staff performance by session</li>
                                <li><strong>Custom Reports</strong> - Export data for regulatory compliance</li>
                            </ul>
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.1);">
                                <p style="margin: 0; color: var(--gray); font-size: 0.95rem;"><strong>Ready to enable?</strong> Toggle the switch above to activate advanced reporting.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div id="sarConfig" style="display: none;">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span id="sarConnectionStatus" style="width: 10px; height: 10px; background: var(--success); border-radius: 50%;"></span>
                                <span id="sarConnectionText" style="font-weight: 600; color: var(--success);">Active</span>
                            </div>
                            <p style="margin: 0.5rem 0 0; color: var(--gray-dark); line-height: 1.6;">
                                SAR is a NewCo feature - no additional configuration needed. Reports are available in the Reports section.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Report Frequency</label>
                            <select class="form-select" id="sarReportFrequency" onchange="saveSARSettings()">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="sarAutoExport" onchange="saveSARSettings()">
                                <span>Auto-export reports to email</span>
                            </label>
                        </div>
                        <div class="form-group" id="sarEmailGroup" style="display: none;">
                            <label class="form-label">Email Recipients</label>
                            <input type="email" class="form-input" id="sarEmailRecipients" placeholder="manager@binghall.com" onchange="saveSARSettings()">
                            <small style="color: var(--gray); display: block; margin-top: 0.25rem;">Separate multiple emails with commas</small>
                        </div>
                        <button class="btn btn-primary" onclick="viewSARReports()">
                            View Reports →
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             TRANSACTIONS LOG SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <section id="transactions" class="content-panel" style="display: none;">
            <div class="header-bar" style="padding: 1rem 1.5rem;">
                <h1 class="header-title" style="font-size: 1.25rem;">💳 Transactions Log</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportTransactions()">
                        📊 Export Data
                    </button>
                    <button class="btn btn-secondary test-data-btn" onclick="generateTestTransactions()" style="display: none;">
                        ➕ Generate Test Transactions
                    </button>
                    <button class="btn btn-danger test-data-btn" onclick="deleteTestTransactions()" style="display: none;">
                        🗑️ Delete Test Transactions
                    </button>
                    <button class="btn btn-primary" onclick="loadTransactions()">
                        🔄 Refresh
                    </button>
                </div>
            </div>

            <div class="content-section" style="padding-top: 1rem;">
                <!-- Transaction Analytics Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #2196f3;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Daily Total</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="dailyTotal">$1,247.50</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">47 transactions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #4caf50;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Monthly Total</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="monthlyTotal">$28,945.75</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">1,234 transactions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ff9800;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Loyalty Earned</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ff9800;" id="loyaltyEarned">15,420</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">points today</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #9c27b0;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Floor vs Web</h3>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #9c27b0;">65% / 35%</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">Floor / Web split</div>
                    </div>
                </div>
                
                <!-- Transaction Filters -->
                <div style="background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                        <div class="form-group">
                            <label class="form-label">Transaction Source</label>
                            <select class="form-select" id="filterSource" onchange="filterTransactions()">
                                <option value="all">All Sources</option>
                                <option value="floor">Floor</option>
                                <option value="website">Website</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Type</label>
                            <select class="form-select" id="filterCustomerType" onchange="filterTransactions()">
                                <option value="all">All Customers</option>
                                <option value="identified">Identified</option>
                                <option value="headless">Headless (Anonymous)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salesperson</label>
                            <select class="form-select" id="filterSalesperson" onchange="filterTransactions()">
                                <option value="all">All</option>
                                <option value="Web">Web</option>
                                <option value="Paymaster">Paymaster</option>
                                <optgroup label="Staff">
                                    <option value="Alice Chen">Alice Chen</option>
                                    <option value="Bob Martinez">Bob Martinez</option>
                                    <option value="Carol White">Carol White</option>
                                    <option value="David Kim">David Kim</option>
                                    <option value="Emma Jones">Emma Jones</option>
                                    <option value="Frank Miller">Frank Miller</option>
                                    <option value="Grace Taylor">Grace Taylor</option>
                                    <option value="Henry Wilson">Henry Wilson</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="filterDateRange" onchange="filterTransactions()">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rewards Eligible</label>
                            <select class="form-select" id="filterRewardsEligible" onchange="filterTransactions()">
                                <option value="all">All Transactions</option>
                                <option value="eligible">Rewards Eligible</option>
                                <option value="not-eligible">Not Eligible</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;">
                    <div style="padding: 1.5rem 1.5rem 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Recent Transactions</h3>
                            <span style="color: var(--gray); font-size: 0.875rem;" id="transactionCount">Showing 50 of 1,234 transactions</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--gray-lighter);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('source')">Source <span id="sortArrowSource">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('customer')">Customer <span id="sortArrowCustomer">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('salesperson')">Salesperson <span id="sortArrowSalesperson">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('date')">Date/Time <span id="sortArrowDate">↓</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('type')">Type <span id="sortArrowType">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('amount')">Amount <span id="sortArrowAmount">↕️</span></th>
                                    <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortTransactions('status')">Status <span id="sortArrowStatus">↕️</span></th>
                                    <th style="padding: 1rem; text-align: right; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" id="loyaltyPointsHeader" onclick="sortTransactions('loyalty')">Loyalty Points <span id="sortArrowLoyalty">↕️</span></th>
                                    <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- Transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-outline" onclick="loadTransactionPage('prev')">← Previous</button>
                        <span style="color: var(--gray); font-size: 0.875rem;">Page 1 of 25</span>
                        <button class="btn btn-outline" onclick="loadTransactionPage('next')">Next →</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════════════
             REWARDS TRANSACTIONS SECTION
             ═══════════════════════════════════════════════════════════════════ -->
        <section id="rewardstransactions" class="content-panel" style="display: none;">
            <div class="header-bar">
                <h1 class="header-title">Rewards Transactions</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportRewardsTransactions()">
                        📊 Export Rewards Data
                    </button>
                    <button class="btn btn-secondary test-data-btn" onclick="generateTestRewardTransactions()" style="display: none;">
                        ➕ Generate Test Rewards
                    </button>
                    <button class="btn btn-danger test-data-btn" onclick="deleteTestRewardTransactions()" style="display: none;">
                        🗑️ Delete Test Rewards
                    </button>
                    <button class="btn btn-primary" onclick="loadRewardsTransactions()">
                        🔄 Refresh
                    </button>
                </div>
            </div>
            
            <div class="content-section">
                <!-- Rewards Transaction Tabs -->
                <div style="border-bottom: 1px solid var(--gray-light); margin-bottom: 2rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" id="earnedTab" onclick="switchRewardsTab('earned')" style="border-radius: 8px 8px 0 0;">
                            ⭐ Points Earned
                        </button>
                        <button class="btn btn-outline" id="redeemedTab" onclick="switchRewardsTab('redeemed')" style="border-radius: 8px 8px 0 0;">
                            🎁 Points Redeemed
                        </button>
                    </div>
                </div>
                
                <!-- Rewards Analytics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ffa726;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Points Earned Today</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ffa726;" id="pointsEarnedToday">15,420</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">183 transactions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #26a69a;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Points Redeemed Today</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #26a69a;" id="pointsRedeemedToday">8,750</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">45 redemptions</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ab47bc;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Net Points</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ab47bc;" id="netPointsToday">+6,670</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">earned - redeemed</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #5c6bc0;">
                        <h3 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px;">Active Members</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #5c6bc0;" id="activeMembers">1,247</div>
                        <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">with activity today</div>
                    </div>
                </div>
                
                <!-- Rewards Transaction Filters -->
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                        <div class="form-group">
                            <label class="form-label">Transaction Type</label>
                            <select class="form-select" id="filterRewardsType" onchange="filterRewardsTransactions()">
                                <option value="all" id="filterAllOption">All Transactions</option>
                                <option value="earned" id="filterEarnedOption">Points Earned</option>
                                <option value="redeemed" id="filterRedeemedOption">Points Redeemed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select class="form-select" id="filterRewardsSource" onchange="filterRewardsTransactions()">
                                <option value="all">All Sources</option>
                                <option value="floor">Floor Purchase</option>
                                <option value="website">Website Purchase</option>
                                <option value="bonus">Bonus Points</option>
                                <option value="birthday">Birthday Bonus</option>
                                <option value="referral">Referral Bonus</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="filterRewardsDateRange" onchange="filterRewardsTransactions()">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Member Status</label>
                            <select class="form-select" id="filterMemberStatus" onchange="filterRewardsTransactions()">
                                <option value="all">All Members</option>
                                <option value="tier1">Tier 1</option>
                                <option value="tier2">Tier 2</option>
                                <option value="tier3">Tier 3</option>
                                <option value="vip">VIP</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Rewards Transactions Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;">
                    <div style="padding: 1.5rem 1.5rem 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;" id="rewardsTableTitle">Recent Rewards Transactions</h3>
                            <span style="color: var(--gray); font-size: 0.875rem;" id="rewardsTransactionCount">Showing 50 of 2,847 transactions</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--gray-lighter);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('date')">Date/Time <span id="sortArrowRewardsDate">↓</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('member')">Member <span id="sortArrowRewardsMember">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('type')">Type <span id="sortArrowRewardsType">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('source')">Source <span id="sortArrowRewardsSource">↕️</span></th>
                                    <th style="padding: 1rem; text-align: right; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('points')">Points <span id="sortArrowRewardsPoints">↕️</span></th>
                                    <th style="padding: 1rem; text-align: right; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('balance')">Balance <span id="sortArrowRewardsBalance">↕️</span></th>
                                    <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortRewardsTransactions('status')">Status <span id="sortArrowRewardsStatus">↕️</span></th>
                                </tr>
                            </thead>
                            <tbody id="rewardsTransactionsTableBody">
                                <!-- Rewards transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-outline" onclick="loadRewardsTransactionPage('prev')">← Previous</button>
                        <span style="color: var(--gray); font-size: 0.875rem;" id="rewardsPagination">Page 1 of 58</span>
                        <button class="btn btn-outline" onclick="loadRewardsTransactionPage('next')">Next →</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Actions Log Section -->
        <section id="actionslog" class="content-panel" style="display: none;">
            <div class="header-bar" style="padding: 1rem 1.5rem; align-items: flex-start;">
                <div style="flex: 1;">
                    <h1 class="header-title" style="font-size: 1.25rem; margin-bottom: 0.5rem;">📋 Actions Log</h1>
                    <div style="background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 0.5rem 0.75rem; border-radius: 6px; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                        <span>⏱️</span>
                        <span><strong>Note:</strong> Activity logs are grouped on a 30-minute delay. Actions within the same 30-minute window are consolidated into a single entry with a change counter.</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="exportActionsLog()">Export CSV</button>
                </div>
            </div>

            <div class="content-main" style="padding-top: 0.5rem;">
                <!-- Filters -->
                <div class="content-section" style="padding: 0.75rem 1rem;">
                    <div style="display: flex; align-items: end; gap: 1rem; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 150px; max-width: 200px;">
                            <label class="form-label">User</label>
                            <select class="form-select" id="filterActionUser" onchange="filterActionsLog()">
                                <option value="all">All Users</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px; max-width: 200px;">
                            <label class="form-label">Action Type</label>
                            <select class="form-select" id="filterActionType" onchange="filterActionsLog()">
                                <option value="all">All Actions</option>
                                <option value="create">Create</option>
                                <option value="update">Update</option>
                                <option value="delete">Delete</option>
                                <option value="save">Save Settings</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px; max-width: 200px;">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="filterActionDate" onchange="filterActionsLog()">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px; max-width: 300px;">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-input" id="searchActionDetails" placeholder="Search details..." oninput="filterActionsLog()">
                        </div>
                    </div>
                </div>
                
                <!-- Actions Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; margin-top: 1.5rem;">
                    <div style="padding: 1.5rem 1.5rem 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Recent Actions</h3>
                            <span style="color: var(--gray); font-size: 0.875rem;" id="actionsCount">Showing 0 actions</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--gray-lighter);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('timestamp')">Timestamp <span id="sortArrowActionTimestamp">↓</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('user')">User <span id="sortArrowActionUser">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light);">Role</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('action')">Action <span id="sortArrowActionAction">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light);">Details</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light); cursor: pointer;" onclick="sortActionsLog('section')">Section <span id="sortArrowActionSection">↕️</span></th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 1px solid var(--gray-light);">Saves</th>
                                </tr>
                            </thead>
                            <tbody id="actionsLogTableBody">
                                <!-- Actions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-outline" onclick="loadActionsPage('prev')">← Previous</button>
                        <span style="color: var(--gray); font-size: 0.875rem;" id="actionsPageInfo">Page 1 of 1</span>
                        <button class="btn btn-outline" onclick="loadActionsPage('next')">Next →</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Reports Section -->
        <section id="reports" class="content-panel" style="display: none;">
            <div class="header-bar">
                <div>
                    <h1 class="header-title">📊 Reports & Analytics</h1>
                    <p style="color: var(--gray); margin-top: 0.25rem;">View and export detailed business reports</p>
                </div>
                <div class="header-actions">
                    <select class="form-select" id="reportDateRange" style="width: 200px;">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <button class="btn btn-primary" onclick="exportReports()">
                        📥 Export All
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="reportRevenue">$24,586</div>
                    <div class="stat-change positive">↑ 12.5% vs last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sessions Played</div>
                    <div class="stat-value" id="reportSessions">847</div>
                    <div class="stat-change positive">↑ 8.3% vs last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Revenue/Session</div>
                    <div class="stat-value" id="reportAvgRevenue">$29.03</div>
                    <div class="stat-change positive">↑ 3.9% vs last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Member Growth</div>
                    <div class="stat-value" id="reportMemberGrowth">+47</div>
                    <div class="stat-change positive">↑ 23% vs last month</div>
                </div>
            </div>

            <!-- Report Categories -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Available Reports</h2>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                    <!-- Financial Reports -->
                    <div class="report-card" style="border: 1px solid var(--success); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">💰</span>
                            <div>
                                <h3 style="margin: 0;">Financial Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Revenue, expenses, and profitability</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('revenue')">📈 Revenue Report</button>
                            <button class="btn btn-outline" onclick="viewReport('expenses')">📉 Expense Report</button>
                            <button class="btn btn-outline" onclick="viewReport('profit')">💵 Profit & Loss</button>
                            <button class="btn btn-outline" onclick="viewReport('tax')">📋 Tax Summary</button>
                        </div>
                    </div>

                    <!-- Session Reports -->
                    <div class="report-card" style="border: 1px solid var(--primary); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">🎯</span>
                            <div>
                                <h3 style="margin: 0;">Session Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Game performance and attendance</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('attendance')">👥 Attendance Report</button>
                            <button class="btn btn-outline" onclick="viewReport('winners')">🏆 Winners Report</button>
                            <button class="btn btn-outline" onclick="viewReport('payouts')">💸 Payout Analysis</button>
                            <button class="btn btn-outline" onclick="viewReport('popularity')">⭐ Game Popularity</button>
                        </div>
                    </div>

                    <!-- Member Reports -->
                    <div class="report-card" style="border: 1px solid var(--warning); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">👥</span>
                            <div>
                                <h3 style="margin: 0;">Member Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Customer insights and loyalty</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('demographics')">📊 Demographics</button>
                            <button class="btn btn-outline" onclick="viewReport('retention')">🔄 Retention Analysis</button>
                            <button class="btn btn-outline" onclick="viewReport('lifetime')">💎 Lifetime Value</button>
                            <button class="btn btn-outline" onclick="viewReport('loyalty')">⭐ Loyalty Points</button>
                        </div>
                    </div>

                    <!-- Sales Reports -->
                    <div class="report-card" style="border: 1px solid var(--secondary); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">🛍️</span>
                            <div>
                                <h3 style="margin: 0;">Sales Reports</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Product and package performance</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="viewReport('packages')">📦 Package Sales</button>
                            <button class="btn btn-outline" onclick="viewReport('concessions')">🍿 Concessions</button>
                            <button class="btn btn-outline" onclick="viewReport('merchandise')">👕 Merchandise</button>
                            <button class="btn btn-outline" onclick="viewReport('channels')">📱 Sales Channels</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Report Runs -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Reports</h2>
                </div>
                
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-lighter);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Report Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Date Range</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Generated</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentReportsTable">
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Monthly Revenue Report</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 1-30, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">2 hours ago</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="viewSavedReport(1)">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadReport(1)">Download</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Weekly Attendance Report</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 18-24, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Yesterday</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="viewSavedReport(2)">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadReport(2)">Download</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Member Demographics</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">All Time</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">3 days ago</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="viewSavedReport(3)">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadReport(3)">Download</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Emails Section -->
        <section id="emails" class="content-panel" style="display: none;">
            <div class="header-bar">
                <div>
                    <h1 class="header-title">✉️ Email Center</h1>
                    <p style="color: var(--gray); margin-top: 0.25rem;">Manage automated emails and campaigns</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="testEmailSetup()">
                        🧪 Test Email Setup
                    </button>
                    <button class="btn btn-primary" onclick="createEmailCampaign()">
                        ➕ New Campaign
                    </button>
                </div>
            </div>

            <!-- Email Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Emails Sent (30d)</div>
                    <div class="stat-value">3,847</div>
                    <div class="stat-change positive">↑ 15.2%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Open Rate</div>
                    <div class="stat-value">42.7%</div>
                    <div class="stat-change positive">↑ 3.1%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Click Rate</div>
                    <div class="stat-value">8.9%</div>
                    <div class="stat-change negative">↓ 0.5%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unsubscribe Rate</div>
                    <div class="stat-value">0.3%</div>
                    <div class="stat-change positive">↓ 0.1%</div>
                </div>
            </div>

            <!-- Email Templates -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Automated Email Templates</h2>
                    <p class="section-subtitle">Configure emails that are sent automatically based on triggers</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                    <!-- Welcome Email -->
                    <div class="email-template-card" style="border: 2px solid var(--primary); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">👋 Welcome Email</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent when new member signs up</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="welcomeEmailEnabled" checked>
                                <label for="welcomeEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> Welcome to Santa Clara Bingo!</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> 2 hours ago</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 247 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('welcome')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('welcome')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('welcome')">Send Test</button>
                        </div>
                    </div>

                    <!-- Birthday Email -->
                    <div class="email-template-card" style="border: 2px solid var(--warning); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">🎂 Birthday Bonus</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent 7 days before birthday</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="birthdayEmailEnabled" checked>
                                <label for="birthdayEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> 🎉 Your Birthday Bonus Awaits!</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> Yesterday</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 18 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('birthday')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('birthday')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('birthday')">Send Test</button>
                        </div>
                    </div>

                    <!-- Win Notification -->
                    <div class="email-template-card" style="border: 2px solid var(--success); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">🏆 Winner Notification</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent after winning a game</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="winnerEmailEnabled">
                                <label for="winnerEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> Congratulations on Your Win!</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> 3 hours ago</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 89 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('winner')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('winner')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('winner')">Send Test</button>
                        </div>
                    </div>

                    <!-- Inactive Member -->
                    <div class="email-template-card" style="border: 2px solid var(--danger); background: white; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0;">😴 Win-Back Campaign</h3>
                                <p style="font-size: 0.875rem; color: var(--gray); margin: 0.25rem 0 0 0;">Sent after 30 days inactive</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="winbackEmailEnabled" checked>
                                <label for="winbackEmailEnabled"></label>
                            </div>
                        </div>
                        <div style="background: var(--gray-lighter); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.875rem; margin: 0;"><strong>Subject:</strong> We Miss You! Come Back for Free Credits</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Last sent:</strong> 5 days ago</p>
                            <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;"><strong>Total sent:</strong> 34 this month</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editEmailTemplate('winback')">Edit</button>
                            <button class="btn btn-outline" onclick="previewEmail('winback')">Preview</button>
                            <button class="btn btn-outline" onclick="sendTestEmail('winback')">Send Test</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Campaigns -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Email Campaigns</h2>
                    <p class="section-subtitle">One-time email blasts to your member list</p>
                </div>
                
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-lighter);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Campaign Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Recipients</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Sent Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Open Rate</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="emailCampaignsTableBody">
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎁 New Year's Eve Extravaganza</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--warning); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Scheduled</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">~1,300</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Dec 31, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">-</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="editCampaign(1)">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="cancelCampaign(1)">Cancel</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎅 December Holiday Jackpot Alert</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Draft</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">~1,300</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Dec 15, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">-</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="editCampaign(2)">Edit</button>
                                    <button class="btn btn-sm btn-primary" onclick="sendCampaign(2)">Send</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎄 Holiday Special Announcement</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,247</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 25, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">48.3%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(3)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(3)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🦃 Thanksgiving Week Schedule</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,189</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Nov 20, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">52.1%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(4)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(4)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎃 Halloween Spooktacular</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,156</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Oct 25, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">55.8%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(5)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(5)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">💰 Double Points Weekend</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,098</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Oct 10, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">61.2%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(6)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(6)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🏆 VIP Member Exclusive</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">124</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Sep 28, 2024</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">72.5%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-outline" onclick="viewCampaignStats(7)">Stats</button>
                                    <button class="btn btn-sm btn-outline" onclick="duplicateCampaign(7)">Duplicate</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">🎯 Weekly Game Schedule</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <span style="background: var(--secondary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Recurring</span>
                                </td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">1,247</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">Every Monday</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">45.6%</td>
                                <td style="padding: 1rem; border-top: 1px solid var(--gray-lighter);">
                                    <button class="btn btn-sm btn-secondary" onclick="editRecurring(8)">Edit</button>
                                    <button class="btn btn-sm btn-outline" onclick="pauseRecurring(8)">Pause</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Email Settings -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Email Settings</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">From Name</label>
                        <input type="text" class="form-input" value="Santa Clara Bingo" id="emailFromName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">From Email</label>
                        <input type="email" class="form-input" value="hello@santaclarabingo.com" id="emailFromAddress">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reply-To Email</label>
                        <input type="email" class="form-input" value="support@santaclarabingo.com" id="emailReplyTo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Footer</label>
                        <textarea class="form-input" rows="3" id="emailFooter">Santa Clara Bingo | 123 Main St, Santa Clara, CA 95050 | (408) 555-0123</textarea>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="saveEmailSettings()">Save Email Settings</button>
                </div>
            </div>
        </section>
        
        <!-- Other sections will be added here -->
    </main>
    </div> <!-- Close Main Content Area wrapper -->

    <!-- Auto-save indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <span class="loading"></span>
        <span>Saving...</span>
    </div>

    <!-- Modal for adding/editing -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Modal Title</h2>
            </div>
            <div id="modalBody">
                <!-- Modal content will be injected here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize NewcoData if not already initialized
        if (typeof NewcoData !== 'undefined') {
            (async () => {
                await NewcoData.init();

                // Initialize master admin user if not exists
                const staff = NewcoData.get('staff') || [];
                const masterAdminExists = staff.some(s => s.role === 'master-admin');

                if (!masterAdminExists) {
                    // Create initial master admin
                    staff.push({
                        id: 'master_admin_' + Date.now(),
                        name: 'Master Admin',
                        email: 'admin@newco.com',
                        role: 'master-admin',
                        status: 'Active',
                        permissions: ['all'],
                        createdAt: new Date().toISOString()
                    });
                    await NewcoData.set('staff', staff);

                    // Set initial password
                    const adminUsers = NewcoData.get('adminUsers') || {};
                    if (!adminUsers['admin@newco.com']) {
                        adminUsers['admin@newco.com'] = 'admin123';
                        await NewcoData.set('adminUsers', adminUsers);
                    }
                }
            })();
        }

        // ═══════════════════════════════════════════════════════════════════
        // HELPER FUNCTIONS - Reduce code duplication
        // ═══════════════════════════════════════════════════════════════════
        
        /**
         * Generic delete with confirmation
         */
        function deleteWithConfirm(array, index, message, displayFunc, saveFunc, useModal = false) {
            const doDelete = () => {
                array.splice(index, 1);
                if (displayFunc) displayFunc();
                if (saveFunc) saveFunc();
                return true;
            };
            
            if (useModal && typeof showConfirm === 'function') {
                showConfirm(message || 'Delete this item?', doDelete);
            } else if (confirm(message || 'Delete this item?')) {
                return doDelete();
            }
            return false;
        }
        
        /**
         * Generic duplicate item
         */
        function duplicateItem(array, index, idPrefix, displayFunc, saveFunc) {
            const original = array[index];
            const duplicate = {
                ...original,
                id: generateId(idPrefix),
                name: (original.name || '') + ' (Copy)'
            };
            array.push(duplicate);
            if (displayFunc) displayFunc();
            if (saveFunc) saveFunc();
            return duplicate;
        }
        
        /**
         * Generate unique ID
         */
        function generateId(prefix = 'id') {
            return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }
        
        /**
         * Get nested object value safely
         */
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current?.[key], obj);
        }
        
        /**
         * Generic table generator
         */
        function generateTable(data, columns, actions) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            ${columns.map(col => `<th>${col.label}</th>`).join('')}
                            ${actions ? '<th>Actions</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map((item, index) => `
                            <tr>
                                ${columns.map(col => `
                                    <td>${getNestedValue(item, col.key) || ''}</td>
                                `).join('')}
                                ${actions ? `
                                    <td>
                                        ${actions.map(action => `
                                            <button class="btn-small" onclick="${action.handler}(${index})">
                                                ${action.label}
                                            </button>
                                        `).join('')}
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        /**
         * Generic pagination controls
         */
        function generatePagination(currentPage, totalPages, changePageFunc) {
            return `
                <div class="pagination">
                    <button onclick="${changePageFunc}(1)" ${currentPage === 1 ? 'disabled' : ''}>
                        First
                    </button>
                    <button onclick="${changePageFunc}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                        Previous
                    </button>
                    <span>Page ${currentPage} of ${totalPages}</span>
                    <button onclick="${changePageFunc}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                        Next
                    </button>
                    <button onclick="${changePageFunc}(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                        Last
                    </button>
                </div>
            `;
        }
        
        /**
         * Generic CSV export
         */
        function exportToCSV(data, columns, filename) {
            const headers = columns.map(col => col.label);
            const rows = data.map(item => 
                columns.map(col => {
                    const value = getNestedValue(item, col.key) || '';
                    // Escape commas and quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                })
            );
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        /**
         * Safe DOM value setter
         */
        function setElementValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = !!value;
                } else {
                    element.value = value || '';
                }
            }
        }
        
        /**
         * Safe DOM value getter
         */
        function getElementValue(id) {
            const element = document.getElementById(id);
            if (!element) return '';
            return element.type === 'checkbox' ? element.checked : element.value;
        }
        
        /**
         * Generic form validation
         */
        function validateRequired(value, fieldName) {
            if (!value || value.toString().trim() === '') {
                showAlert(`${fieldName} is required`, 'error');
                return false;
            }
            return true;
        }

        // Auto-save functionality from wizard
        let autoSaveTimeout;
        let hasUnsavedChanges = false;
        let currentSection = 'dashboard'; // Track current active section

        // Activity Log - tracks saves only
        function logSaveAction() {
            const activityLog = NewcoData.get('activityLog') || [];
            const userEmail = sessionStorage.getItem('newco_admin_email');
            const staff = NewcoData.get('staff') || [];

            // Try to find user in staff, fallback to email or super admin
            let userName = userEmail || 'Admin';
            let userRole = 'Admin';
            const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail?.toLowerCase());
            if (currentUser) {
                userName = currentUser.name || currentUser.email;
                userRole = currentUser.role || 'Staff';
            } else if (sessionStorage.getItem('newco_is_super_admin') === 'true') {
                userRole = 'Super Admin';
            }

            const now = new Date();
            const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);

            // Section name mapping
            const sectionNames = {
                'branding': 'Branding',
                'artLibrary': 'Art Library',
                'halls': 'Hall & Layout',
                'schedule': 'Schedule',
                'packages': 'Packages',
                'offerings': 'Basic Offerings',
                'members': 'Members',
                'staff': 'Staff',
                'loyalty': 'Loyalty Program',
                'marketing': 'Marketing',
                'settings': 'Settings',
                'dashboard': 'Dashboard',
                'pos-redemption': 'POS + Redemption'
            };

            // Check if there's a recent entry for this user and section within 30 minutes
            const recentEntry = activityLog.find(log =>
                log.user === userName &&
                log.section === currentSection &&
                new Date(log.timestamp) > thirtyMinutesAgo
            );

            if (recentEntry) {
                // Increment change count and update last update time
                recentEntry.changes = (recentEntry.changes || 1) + 1;
                recentEntry.lastUpdate = now.toISOString();
            } else {
                // Create new log entry
                activityLog.unshift({
                    user: userName,
                    userEmail: userEmail,
                    userRole: userRole,
                    section: currentSection,
                    sectionName: sectionNames[currentSection] || currentSection,
                    timestamp: now.toISOString(),
                    lastUpdate: now.toISOString(),
                    changes: 1
                });
            }

            // Keep only last 100 entries
            if (activityLog.length > 100) {
                activityLog.splice(100);
            }

            NewcoData.set('activityLog', activityLog);
        }

        function showAutoSave() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.innerHTML = '✓ Saved';
                setTimeout(() => {
                    indicator.classList.remove('show');
                    indicator.innerHTML = '<span class="loading"></span><span>Saving...</span>';
                }, 1000);
            }, 500);

            // Log the save action
            logSaveAction();
        }

        function autoSave() {
            if (hasUnsavedChanges) {
                saveAllData();
                hasUnsavedChanges = false;
                showAutoSave();
                document.getElementById('lastSaved').textContent = `Last saved: ${new Date().toLocaleTimeString()}`;
            }
        }

        function markUnsaved() {
            hasUnsavedChanges = true;
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSave, 2000); // Auto-save after 2 seconds of inactivity
        }

        // Save all data to NewcoData
        function saveAllData() {
            // This will be expanded as we add more sections
            const org = NewcoData.get("organization");
            // Save any changes made in the UI
            NewcoData.updateOrganization(org);
        }

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');

            // Prevent body scroll when menu is open
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');

            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Navigation
        function showSection(sectionId) {
            // Close mobile menu when navigating on mobile
            closeMobileMenu();

            // Check if section requires admin privileges
            const restrictedSections = ['actionslog', 'settings'];
            if (restrictedSections.includes(sectionId)) {
                const userRole = sessionStorage.getItem('newco_admin_role');
                const isSuperAdmin = sessionStorage.getItem('newco_is_super_admin') === 'true';

                // Allow only admin or super admin (Super Admin role or is_super_admin flag)
                if (!isSuperAdmin && userRole !== 'Admin' && userRole !== 'Super Admin') {
                    showModal({
                        title: '🔒 Access Restricted',
                        message: 'Requires higher privilege to access.',
                        type: 'warning'
                    });

                    // Show restricted overlay
                    showRestrictedOverlay(sectionId);
                    return;
                }
            }

            // Track current section for activity logging
            currentSection = sectionId;

            // Hide all sections
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.style.display = 'none';
            });

            // Show selected section
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
                // Immediately reset scroll for the section itself
                section.scrollTop = 0;
            }

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });

            // Scroll to top of content area - try all possible scroll containers
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.scrollTop = 0;
            }

            // Reset all possible scroll positions
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;

            // Load section data
            loadSectionData(sectionId);

            // Refresh icons after section change
            setTimeout(refreshIcons, 100);
        }

        function showRestrictedOverlay(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.style.display = 'none';
            });

            // Show the restricted section with overlay
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
                section.style.position = 'relative';

                // Add overlay if not already present
                let overlay = section.querySelector('.restricted-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'restricted-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(255, 255, 255, 0.9);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 999;
                        backdrop-filter: blur(4px);
                    `;
                    overlay.innerHTML = `
                        <div style="text-align: center; color: var(--gray);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">🔒</div>
                            <div style="font-size: 1.5rem; font-weight: 600;">Restricted</div>
                        </div>
                    `;
                    section.insertBefore(overlay, section.firstChild);
                }
            }

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });
        }

        // Load data for each section
        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'organization':
                    loadOrganization();
                    break;
                case 'halls':
                    loadHalls();
                    break;
                case 'staff':
                    loadStaff();
                    break;
                case 'pagebuilder':
                    loadPageBuilder();
                    // Ensure scroll is at top after content loads - try multiple selectors
                    setTimeout(() => {
                        const section = document.getElementById('pagebuilder');
                        const mainContent = document.querySelector('.main-content');
                        const contentPanel = document.querySelector('.content-panel');
                        const contentSection = document.querySelector('.content-section');

                        if (section) section.scrollTop = 0;
                        if (mainContent) mainContent.scrollTop = 0;
                        if (contentPanel) contentPanel.scrollTop = 0;
                        if (contentSection) contentSection.scrollTop = 0;
                        window.scrollTo(0, 0);
                        document.documentElement.scrollTop = 0;
                        document.body.scrollTop = 0;
                    }, 100);
                    break;
                case 'themes':
                    loadThemes();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'branding':
                    loadBranding();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'packages':
                    loadPackages();
                    break;
                case 'salesItems':
                    loadSalesItems();
                    break;
                case 'redemption':
                case 'purchasing':
                case 'pos-redemption':
                case 'floor-rewards':
                    loadStoreOperationsSettings();
                    break;
                case 'loyaltyItems':
                    loadLoyaltyItems();
                    break;
                case 'artlibrary':
                    loadArtLibrary();
                    break;
                case 'marketing':
                    loadMarketing();
                    break;
                case 'artLibrary':
                    loadCustomerArtLibrary();
                    break;
                case 'members':
                    loadMembers();
                    toggleTestDataButtons();
                    break;
                case 'rewards':
                    loadRewards();
                    break;
                case 'transactions':
                    loadTransactions();
                    toggleTestDataButtons();
                    break;
                case 'rewardstransactions':
                    toggleTestDataButtons();
                    break;
                case 'actionslog':
                    loadActionsLog();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'emails':
                    loadEmails();
                    break;
                // Add more cases as we build out sections
            }
        }

        // Dashboard functions
        function loadDashboard() {
            const stats = calculateStats();
            updateDashboardStats(stats);
            loadRecentActivity();
            setTimeout(refreshIcons, 100);
        }

        function calculateStats() {
            const transactions = NewcoData.get('transactions') || [];
            const members = NewcoData.get('members') || [];
            const schedule = NewcoData.get('schedule') || {};
            const schedules = schedule.schedules || {};
            const halls = NewcoData.get('halls') || [];

            // Calculate today's revenue
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => {
                const transDate = new Date(t.timestamp || t.date);
                return transDate.toDateString() === today;
            });
            const todayRevenue = todayTransactions.reduce((sum, t) => sum + (t.finalTotal || t.total || t.amount || 0), 0);

            // Calculate yesterday's revenue for comparison
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            const yesterdayTransactions = transactions.filter(t => {
                const transDate = new Date(t.timestamp || t.date);
                return transDate.toDateString() === yesterdayStr;
            });
            const yesterdayRevenue = yesterdayTransactions.reduce((sum, t) => sum + (t.finalTotal || t.total || t.amount || 0), 0);
            const revenueChange = yesterdayRevenue > 0 ? (((todayRevenue - yesterdayRevenue) / yesterdayRevenue) * 100).toFixed(1) : 0;

            // Count active sessions today
            const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const todayDay = daysOfWeek[new Date().getDay()];
            let activeSessions = 0;
            Object.values(schedules).forEach(schedule => {
                if (schedule[todayDay]) {
                    activeSessions++;
                }
            });

            // Count members added this week
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const newMembersThisWeek = members.filter(m => {
                const joinDate = new Date(m.joinDate || m.createdAt);
                return joinDate >= weekAgo;
            }).length;

            // Calculate occupancy rate
            const totalCapacity = halls.reduce((sum, h) => sum + (h.capacity || 0), 0);
            const totalBooked = todayTransactions.reduce((sum, t) => sum + (t.seats || 1), 0);
            const occupancyRate = totalCapacity > 0 ? Math.round((totalBooked / totalCapacity) * 100) : 0;

            return {
                revenue: todayRevenue,
                revenueChange: revenueChange,
                activeSessions: activeSessions,
                totalMembers: members.length,
                newMembersThisWeek: newMembersThisWeek,
                occupancyRate: occupancyRate,
                seatsBooked: totalBooked
            };
        }

        function updateDashboardStats(stats) {
            // Update stat cards with real data
            const statCards = document.querySelectorAll('.stat-value');
            const statChanges = document.querySelectorAll('.stat-change');

            if (statCards[0]) statCards[0].textContent = `$${parseFloat(stats.revenue || 0).toFixed(2)}`;
            if (statChanges[0]) {
                const changeClass = stats.revenueChange >= 0 ? 'positive' : 'negative';
                const arrow = stats.revenueChange >= 0 ? '↑' : '↓';
                statChanges[0].className = `stat-change ${changeClass}`;
                statChanges[0].textContent = `${arrow} ${Math.abs(stats.revenueChange)}% from yesterday`;
            }

            if (statCards[1]) statCards[1].textContent = stats.activeSessions;
            if (statChanges[1]) {
                statChanges[1].textContent = `${stats.activeSessions} scheduled today`;
            }

            if (statCards[2]) statCards[2].textContent = stats.totalMembers;
            if (statChanges[2]) {
                const changeClass = stats.newMembersThisWeek > 0 ? 'positive' : '';
                statChanges[2].className = `stat-change ${changeClass}`;
                statChanges[2].textContent = `↑ ${stats.newMembersThisWeek} new this week`;
            }

            if (statCards[3]) statCards[3].textContent = `${stats.occupancyRate}%`;
            if (statChanges[3]) {
                statChanges[3].textContent = `${stats.seatsBooked} seats filled`;
            }
        }

        function loadRecentActivity() {
            const transactions = NewcoData.get('transactions') || [];
            const activityTable = document.getElementById('activityTable');

            if (!activityTable) return;

            // Get last 10 transactions
            const recentTransactions = transactions
                .sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date))
                .slice(0, 10);

            if (recentTransactions.length === 0) {
                activityTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--gray);">
                            No recent activity
                        </td>
                    </tr>
                `;
                return;
            }

            activityTable.innerHTML = recentTransactions.map(t => {
                const time = new Date(t.timestamp || t.date);
                const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const dateStr = time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <tr>
                        <td>${dateStr} ${timeStr}</td>
                        <td><span class="badge badge-success">Booking</span></td>
                        <td>${t.memberName || t.customerName || 'Guest'} - ${t.type || t.packageName || 'Package'}</td>
                        <td style="font-weight: 600; color: var(--success);">$${(parseFloat(t.finalTotal || t.total || t.amount) || 0).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        function refreshDashboard() {
            loadDashboard();
            showAutoSave();
        }

        // Branding functions
        async function loadBranding() {
            const org = NewcoData.get("organization") || {};

            // Load logo from art library
            if (org.logoArtId) {
                document.getElementById('selectedLogoArtId').value = org.logoArtId;
                // Fetch art from library
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/art_library?id=eq.${org.logoArtId}&select=*`,
                        {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        }
                    );
                    const art = await response.json();
                    if (art && art.length > 0) {
                        document.getElementById('logoPreview').innerHTML = `<img src="${art[0].file_data}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
                    }
                } catch (err) {
                    console.error('Error loading logo art:', err);
                }
            } else if (org.name) {
                // Show initials if no logo but have name
                const initials = org.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
                document.getElementById('logoPreview').innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 3rem; font-weight: bold; color: var(--primary);">${initials}</div>`;
            }

            // Load colors
            if (org.colors) {
                document.getElementById('brandPrimaryColor').value = org.colors.primary || '#2ea3f2';
                document.getElementById('brandPrimaryHex').value = org.colors.primary || '#2ea3f2';
                document.getElementById('brandSecondaryColor').value = org.colors.secondary || '#9c27b0';
                document.getElementById('brandSecondaryHex').value = org.colors.secondary || '#9c27b0';
            }

            // Load messaging
            document.getElementById('brandOrgName').value = org.name || '';
            document.getElementById('brandTagline').value = org.tagline || '';

            // Apply the branding to the UI (colors and logo to sidebar)
            applyBrandingColors();
        }

        async function saveBranding() {
            const org = NewcoData.get("organization") || {};

            org.name = document.getElementById('brandOrgName').value;
            org.tagline = document.getElementById('brandTagline').value;
            org.colors = {
                primary: document.getElementById('brandPrimaryColor').value,
                secondary: document.getElementById('brandSecondaryColor').value
            };

            // Save logo art ID if selected
            const logoArtId = document.getElementById('selectedLogoArtId').value;
            if (logoArtId) {
                org.logoArtId = logoArtId;
            }

            await NewcoData.updateOrganization(org);

            // Refresh all branding elements
            applyBrandingColors();

            // Update sidebar name immediately
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName) {
                sidebarOrgName.textContent = org.name || 'Admin Panel';
                document.title = (org.name || 'Admin') + ' - Management System';
            }

            showAutoSave();
        }

        function selectLogoFromArt() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            ArtPicker.open(async (selectedArt) => {
                // Update hidden field with art ID
                document.getElementById('selectedLogoArtId').value = selectedArt.id;

                // Update preview
                document.getElementById('logoPreview').innerHTML = `<img src="${selectedArt.file_data}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;

                // Update sidebar logo immediately
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.innerHTML = `<img src="${selectedArt.file_data}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                }

                // Mark as unsaved
                markUnsaved();
            }, customerId);
        }

        function resetLogo() {
            document.getElementById('selectedLogoArtId').value = '';
            const org = NewcoData.get("organization") || {};

            if (org.name) {
                const initials = org.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
                document.getElementById('logoPreview').innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 3rem; font-weight: bold; color: var(--primary);">${initials}</div>`;
            } else {
                document.getElementById('logoPreview').innerHTML = `<span style="color: var(--gray); font-size: 0.875rem;">No logo selected</span>`;
            }

            // Clear sidebar logo
            const sidebarLogo = document.getElementById('sidebarLogo');
            if (sidebarLogo && org.name) {
                const initials = org.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
                sidebarLogo.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.5rem; font-weight: bold; color: white; background: var(--primary); border-radius: 8px;">${initials}</div>`;
            }

            markUnsaved();
        }
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const org = NewcoData.get('organization') || {};
                    
                    // Store logo in memory to avoid quota issues
                    if (!window.artStorage) {
                        window.artStorage = {};
                    }
                    
                    const logoId = 'logo_' + Date.now();
                    window.artStorage[logoId] = e.target.result;
                    org.logoId = logoId;
                    
                    // Don't store the actual logo data in org object to avoid quota issues
                    // The logo will be retrieved from window.artStorage using logoId
                    
                    try {
                        NewcoData.set('organization', org);
                    } catch (error) {
                        console.warn('Could not save logo to localStorage, keeping in memory:', error);
                        // Still update the display even if save fails
                    }
                    
                    // Update preview in branding section
                    document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
                    
                    // Update sidebar logo immediately
                    const sidebarLogo = document.getElementById('sidebarLogo');
                    if (sidebarLogo) {
                        sidebarLogo.innerHTML = `<img src="${e.target.result}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                    }
                    
                    markUnsaved();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateBrandPreview() {
            const primary = document.getElementById('brandPrimaryColor').value;
            const secondary = document.getElementById('brandSecondaryColor').value;

            document.getElementById('brandPrimaryHex').value = primary;
            document.getElementById('brandSecondaryHex').value = secondary;

            markUnsaved();
        }
        
        function updateColorFromHex(type) {
            const hexInput = document.getElementById(`brand${type.charAt(0).toUpperCase() + type.slice(1)}Hex`);
            const colorInput = document.getElementById(`brand${type.charAt(0).toUpperCase() + type.slice(1)}Color`);
            if (hexInput && colorInput) {
                colorInput.value = hexInput.value;
                updateBrandPreview();
            }
        }
        
        // Settings functions
        function loadSettings() {
            const org = NewcoData.get("organization") || {};
            const settings = NewcoData.get('settings') || {};
            
            document.getElementById('settingsOrgName').value = org.name || '';
            document.getElementById('settingsLicense').value = org.licenseNumber || org.license || '';
            document.getElementById('settingsEmail').value = org.email || '';
            document.getElementById('settingsPhone').value = org.phone || '';
            document.getElementById('settingsAddress').value = org.address || '';
            document.getElementById('settingsWebsite').value = org.website || '';
            
            if (settings.timezone) {
                document.getElementById('settingsTimezone').value = settings.timezone;
            }
            if (settings.currency) {
                document.getElementById('settingsCurrency').value = settings.currency;
            }
            
            // Load new settings
            document.getElementById('settingsSeatLimit').value = settings.seatLimit || 1;
            document.getElementById('settingsTaxRate').value = settings.taxRate || 8.75;
            document.getElementById('settingsRequireSeatForAddons').checked = settings.requireSeatForAddons === true;
            document.getElementById('settingsEnableTestData').checked = settings.enableTestData === true;

            // Initialize payment settings if not set
            if (settings.paymentCard === undefined) {
                settings.paymentCard = true; // Default to card enabled
                NewcoData.set('settings', settings);
            }
            if (settings.paymentCash === undefined) {
                settings.paymentCash = false; // Default to cash disabled
                NewcoData.set('settings', settings);
            }
            
            document.getElementById('settingsPaymentCard').checked = settings.paymentCard === true;
            document.getElementById('settingsPaymentCash').checked = settings.paymentCash === true;
            document.getElementById('settingsPaymentCheck').checked = settings.paymentCheck === true;
            
            // Load tax exemption settings (default to true for charitable bingo)
            document.getElementById('settingsTaxExemptPackages').checked = settings.taxExemptPackages !== false;
            document.getElementById('settingsTaxExemptItems').checked = settings.taxExemptItems !== false;
            document.getElementById('settingsTaxExemptRewards').checked = settings.taxExemptRewards !== false;
            
            // Load points currency name
            document.getElementById('settingsPointsCurrency').value = settings.pointsCurrencyName || 'Loyalty Points';

            // Load UI preferences
            const uiPrefs = NewcoData.get('uiPreferences') || {};
            const showRecommendations = !uiPrefs.disableRecommendations;
            document.getElementById('settingsShowRecommendations').checked = showRecommendations;

            // Update test data buttons visibility
            toggleTestDataButtons();
        }
        
        function saveSettings() {
            const org = NewcoData.get("organization") || {};
            const settings = NewcoData.get('settings') || {};
            
            // Save org details
            org.name = document.getElementById('settingsOrgName').value;
            org.licenseNumber = document.getElementById('settingsLicense').value;
            org.email = document.getElementById('settingsEmail').value;
            org.phone = document.getElementById('settingsPhone').value;
            org.address = document.getElementById('settingsAddress').value;
            org.website = document.getElementById('settingsWebsite').value;
            
            // Save system settings
            settings.timezone = document.getElementById('settingsTimezone').value;
            settings.currency = document.getElementById('settingsCurrency').value;
            settings.pointsCurrencyName = document.getElementById('settingsPointsCurrency').value || 'Loyalty Points';
            settings.seatLimit = parseInt(document.getElementById('settingsSeatLimit').value) || 1;
            settings.taxRate = parseFloat(document.getElementById('settingsTaxRate').value) || 8.75;
            settings.requireSeatForAddons = document.getElementById('settingsRequireSeatForAddons').checked;
            settings.enableTestData = document.getElementById('settingsEnableTestData').checked;
            settings.paymentCard = document.getElementById('settingsPaymentCard').checked;
            settings.paymentCash = document.getElementById('settingsPaymentCash').checked;
            settings.paymentCheck = document.getElementById('settingsPaymentCheck').checked;
            
            // Save tax exemption settings
            settings.taxExemptPackages = document.getElementById('settingsTaxExemptPackages').checked;
            settings.taxExemptItems = document.getElementById('settingsTaxExemptItems').checked;
            settings.taxExemptRewards = document.getElementById('settingsTaxExemptRewards').checked;
            
            // Save points currency name
            settings.pointsCurrencyName = document.getElementById('settingsPointsCurrency').value || 'Loyalty Points';
            
            NewcoData.updateOrganization(org);
            NewcoData.set('settings', settings);
            showAutoSave();
        }

        // Organization functions (DEPRECATED - moved to Branding and Settings)
        function loadOrganization() {
            const org = NewcoData.get("organization");
            if (org) {
                document.getElementById('orgName').value = org.name || '';
                document.getElementById('orgLicense').value = org.licenseNumber || org.license || '';
                document.getElementById('orgEmail').value = org.email || '';
                document.getElementById('orgPhone').value = org.phone || '';
                document.getElementById('orgTagline').value = org.tagline || '';
                if (org.colors) {
                    document.getElementById('orgPrimaryColor').value = org.colors.primary || '#2ea3f2';
                    document.getElementById('orgSecondaryColor').value = org.colors.secondary || org.colors.accent || '#9c27b0';
                }
            }
        }

        function saveOrganization() {
            const org = {
                name: document.getElementById('orgName').value,
                licenseNumber: document.getElementById('orgLicense').value,
                email: document.getElementById('orgEmail').value,
                phone: document.getElementById('orgPhone').value,
                tagline: document.getElementById('orgTagline').value,
                colors: {
                    primary: document.getElementById('orgPrimaryColor').value,
                    secondary: document.getElementById('orgSecondaryColor').value
                }
            };
            
            NewcoData.updateOrganization(org);
            
            // Apply the new colors to the UI immediately
            applyBrandingColors();
            
            showAutoSave();
        }

        // Halls functions with layout designer from wizard
        function loadHalls() {
            let halls = NewcoData.get('halls') || [];
            const hallContent = document.getElementById('hallContent');

            // Ensure only one hall exists
            if (halls.length === 0) {
                halls = [{
                    id: 'main-hall',
                    name: 'Main Hall',
                    address: '',
                    capacity: 0,
                    seatingMapType: 'none', // none, manual, prebuilt
                    layout: {
                        rows: 15,
                        cols: 20,
                        cells: {}
                    }
                }];
                NewcoData.set('halls', halls);
            } else if (halls.length > 1) {
                // Keep only the first hall
                halls = [halls[0]];
                NewcoData.set('halls', halls);
            }

            const hall = halls[0];
            const index = 0;

            hallContent.innerHTML = '';

            // Create single hall content
            const content = document.createElement('div');
            content.className = 'content-section';
            content.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">Hall Configuration</h2>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                        <label style="font-weight: 600;">Name:</label>
                        <input type="text" class="form-input" id="hall-name-${index}"
                               value="${hall.name || 'Main Hall'}"
                               placeholder="Hall name"
                               onchange="updateHallInfo(${index}, 'name')"
                               style="width: 200px;">
                        <label style="font-weight: 600;">Address:</label>
                        <input type="text" class="form-input" id="hall-address-${index}"
                               value="${hall.address || ''}"
                               placeholder="Enter address"
                               onchange="updateHallInfo(${index}, 'address')"
                               style="flex: 1;">
                        <label style="font-weight: 600;">Capacity:</label>
                        <input type="number" class="form-input" id="hall-capacity-${index}"
                               value="${hall.capacity || 0}"
                               placeholder="Capacity"
                               onchange="updateHallInfo(${index}, 'capacity')"
                               style="width: 120px;">
                        <div id="seat-count-${index}" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary-light); border-radius: 4px; font-size: 0.875rem; color: var(--primary-dark);">
                            <strong>Seats in Layout:</strong> <span id="seat-count-value-${index}">0</span>
                        </div>
                    </div>
                </div>

                <!-- Seating Map Type Selection -->
                <div class="section-header" style="margin-top: 2rem;">
                    <h3 class="section-title">Seating Map Configuration</h3>
                    <div style="margin-top: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Seating Map Type:</label>
                        <select id="seating-map-type-${index}" class="form-input" style="width: 300px;" onchange="changeSeatingMapType(${index})">
                            <option value="none" ${(hall.seatingMapType || 'none') === 'none' ? 'selected' : ''}>No Seating Map</option>
                            <option value="manual" ${hall.seatingMapType === 'manual' ? 'selected' : ''}>Manual Configuration (Grid Designer)</option>
                            <option value="prebuilt" ${hall.seatingMapType === 'prebuilt' ? 'selected' : ''}>Prebuilt Map (Import .js file)</option>
                        </select>
                    </div>
                </div>

                <!-- Seating Map Content (changes based on type) -->
                <div id="seating-map-content-${index}" style="margin-top: 2rem;">
                    <!-- Content will be loaded here based on type -->
                </div>
            `;
            hallContent.appendChild(content);

            // Load the appropriate seating map content
            loadSeatingMapContent(hall, index);
        }

        function changeSeatingMapType(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            const hall = halls[hallIndex];
            const newType = document.getElementById(`seating-map-type-${hallIndex}`).value;

            hall.seatingMapType = newType;
            NewcoData.set('halls', halls);

            loadSeatingMapContent(hall, hallIndex);
        }

        function loadSeatingMapContent(hall, hallIndex) {
            const container = document.getElementById(`seating-map-content-${hallIndex}`);
            if (!container) return;

            const mapType = hall.seatingMapType || 'none';

            if (mapType === 'none') {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; background: var(--gray-lighter); border-radius: 8px;">
                        <p style="color: var(--gray); font-size: 1.1rem;">
                            No seating map configured. Seat selection will not be available.
                        </p>
                    </div>
                `;
            } else if (mapType === 'manual') {
                // Show the grid designer
                container.innerHTML = `
                    <div class="layout-designer">
                        <div class="layout-tools" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <button class="tool-btn active" onclick="selectLayoutTool('seat', ${hallIndex})" title="Place seats">
                                    💺 Place Seat
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('directional', ${hallIndex})" title="Place directional seats">
                                    🪑 Place Directional Seat
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('blocked', ${hallIndex})" title="Block areas">
                                    🚫 Blocked
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('entrance', ${hallIndex})" title="Mark entrances">
                                    🚪 Entrance
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('restroom', ${hallIndex})" title="Mark restrooms">
                                    🚻 Restroom
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('vip', ${hallIndex})" title="VIP areas">
                                    ⭐ VIP
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('custom', ${hallIndex})" title="Create custom area">
                                    🎨 Custom Area
                                </button>
                                <button class="tool-btn" onclick="selectLayoutTool('clear', ${hallIndex})" title="Clear cells">
                                    🗑️ Clear
                                </button>
                            </div>

                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem;">Width:</label>
                                <input type="number" id="grid-width-${hallIndex}" min="5" max="30" value="${hall.layout?.width || hall.layout?.cols || 20}"
                                       style="width: 60px; padding: 0.25rem;" onchange="updateGridSize(${hallIndex})">
                                <label style="font-size: 0.875rem;">Height:</label>
                                <input type="number" id="grid-height-${hallIndex}" min="5" max="30" value="${hall.layout?.height || hall.layout?.rows || 15}"
                                       style="width: 60px; padding: 0.25rem;" onchange="updateGridSize(${hallIndex})">
                            </div>
                        </div>

                        <div id="custom-area-info-${hallIndex}" style="padding: 1rem; background: var(--primary-light); border-radius: 8px; margin: 0.5rem 0; display: none;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Creating Custom Area</strong>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <input type="text" id="custom-area-name-${hallIndex}" placeholder="Area name" style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;" readonly>
                                <input type="color" id="custom-area-color-${hallIndex}" value="#ff6b6b" style="width: 60px; height: 38px; border: 1px solid var(--gray-light); border-radius: 4px;" disabled>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <span id="custom-area-count-${hallIndex}">0 cells selected</span>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong style="display: block; margin-bottom: 0.5rem;">Text Orientation:</strong>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button onclick="updateCustomAreaOrientation(${hallIndex}, 'horizontal')" id="orient-horizontal-${hallIndex}" class="btn btn-outline" style="padding: 0.35rem 0.75rem; font-size: 0.7rem;">
                                        →
                                    </button>
                                    <button onclick="updateCustomAreaOrientation(${hallIndex}, 'vertical-left')" id="orient-vertical-left-${hallIndex}" class="btn btn-outline" style="padding: 0.35rem 0.75rem; font-size: 0.7rem;">
                                        ↓
                                    </button>
                                    <button onclick="updateCustomAreaOrientation(${hallIndex}, 'vertical-right')" id="orient-vertical-right-${hallIndex}" class="btn btn-outline" style="padding: 0.35rem 0.75rem; font-size: 0.7rem;">
                                        ↑
                                    </button>
                                    <div id="orientation-example-${hallIndex}" style="width: 80px; padding: 0.35rem; background: white; border-radius: 4px; font-size: 0.65rem; text-align: center; border: 1px solid var(--gray-light); overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                                        Custom Area
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="cancelCustomArea(${hallIndex})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="confirmCustomArea(${hallIndex})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    ✓ Confirm Area
                                </button>
                            </div>
                        </div>

                        <div id="layout-grid-${hallIndex}" class="layout-grid">
                            <!-- Grid will be generated here -->
                        </div>
                    </div>
                `;
                // Initialize layout grid
                initializeLayoutGrid(hall, hallIndex);
            } else if (mapType === 'prebuilt') {
                // Show prebuilt map upload/selection
                container.innerHTML = `
                    <div style="padding: 2rem; background: var(--gray-lighter); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem;">Import Prebuilt Seating Map</h4>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Upload .js Map File:</label>
                            <input type="file" id="prebuilt-map-file-${hallIndex}" accept=".js" onchange="loadPrebuiltMapFile(${hallIndex})"
                                   style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px; width: 100%; max-width: 500px;">
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                                Select a JavaScript file containing a seating map function (e.g., milpitas-grid-map.js)
                            </p>
                        </div>

                        ${hall.prebuiltMapCode ? `
                            <div style="margin-top: 1.5rem;">
                                <h5 style="color: var(--success); margin-bottom: 0.5rem;">✅ Prebuilt Map Loaded</h5>
                                <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid var(--success);">
                                    <p style="margin-bottom: 0.5rem;"><strong>Function Name:</strong> ${hall.prebuiltMapFunction || 'Unknown'}</p>
                                    <p style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                                        Map file loaded successfully. This map will be used for seat selection.
                                    </p>
                                    <button class="btn btn-danger" onclick="removePrebuiltMap(${hallIndex})" style="margin-top: 0.5rem; padding: 0.5rem 1rem;">
                                        Remove Map
                                    </button>
                                </div>

                                <!-- Preview Container -->
                                <div style="margin-top: 1rem;">
                                    <h5>Preview:</h5>
                                    <div id="prebuilt-map-preview-${hallIndex}" style="margin-top: 0.5rem; max-height: 500px; overflow: auto;">
                                        <!-- Preview will render here -->
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Render preview if map exists
                if (hall.prebuiltMapCode && hall.prebuiltMapFunction) {
                    renderPrebuiltMapPreview(hall, hallIndex);
                }
            }
        }

        function loadPrebuiltMapFile(hallIndex) {
            const fileInput = document.getElementById(`prebuilt-map-file-${hallIndex}`);
            const file = fileInput.files[0];

            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const code = e.target.result;

                // Extract function name from code (look for pattern: function functionName() or window.functionName =)
                const functionMatch = code.match(/function\s+(\w+)\s*\(/) || code.match(/window\.(\w+)\s*=/);
                const functionName = functionMatch ? functionMatch[1] : null;

                if (!functionName) {
                    alert('Could not find a valid function in the uploaded file. Please ensure the file contains a seating map function.');
                    return;
                }

                const halls = NewcoData.get('halls') || [];
                halls[hallIndex].prebuiltMapCode = code;
                halls[hallIndex].prebuiltMapFunction = functionName;
                NewcoData.set('halls', halls);

                // Reload the content to show success message and preview
                loadSeatingMapContent(halls[hallIndex], hallIndex);
            };
            reader.readAsText(file);
        }

        function removePrebuiltMap(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            delete halls[hallIndex].prebuiltMapCode;
            delete halls[hallIndex].prebuiltMapFunction;
            NewcoData.set('halls', halls);

            loadSeatingMapContent(halls[hallIndex], hallIndex);
        }

        function renderPrebuiltMapPreview(hall, hallIndex) {
            try {
                // Create a temporary container ID
                const containerId = `prebuilt-map-preview-${hallIndex}`;

                // Execute the prebuilt map code in a safe way
                eval(hall.prebuiltMapCode);

                // Call the function to render the map
                if (window[hall.prebuiltMapFunction]) {
                    window[hall.prebuiltMapFunction](containerId);
                }
            } catch (error) {
                console.error('Error rendering prebuilt map preview:', error);
                document.getElementById(`prebuilt-map-preview-${hallIndex}`).innerHTML = `
                    <p style="color: var(--danger); padding: 1rem; background: #ffebee; border-radius: 8px;">
                        Error rendering map preview: ${error.message}
                    </p>
                `;
            }
        }

        function switchHallTab(index) {
            // No longer needed - single hall only
        }

        function addNewHall() {
            // No longer needed - single hall only
            alert('Only one hall is supported. Please configure the existing hall.');
        }

        function deleteHall(index) {
            // No longer needed - single hall only
            alert('Cannot delete the main hall. You can modify its configuration instead.');
        }

        function updateHallInfo(hallIndex, field) {
            const halls = NewcoData.get('halls') || [];
            if (halls[hallIndex]) {
                const value = document.getElementById(`hall-${field}-${hallIndex}`).value;
                halls[hallIndex][field] = field === 'capacity' ? parseInt(value) || 0 : value;
                NewcoData.set('halls', halls);
            }
        }

        // Layout designer functions from wizard
        let currentTool = {};  // Track tool per hall: {0: 'table', 1: 'select'}
        let selectedCells = {};  // Track selected cells per hall: {0: Set(), 1: Set()}
        let tableCount = {};

        function initializeLayoutGrid(hall, hallIndex) {
            const gridContainer = document.getElementById(`layout-grid-${hallIndex}`);
            if (!gridContainer) return;
            
            // Handle both wizard format (width/height) and admin format (rows/cols)
            const rows = hall.layout?.rows || hall.layout?.height || 15;
            const cols = hall.layout?.cols || hall.layout?.width || 20;
            
            gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            if (!window.seatCount) window.seatCount = {};
            seatCount[hallIndex] = 0;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.dataset.hallIndex = hallIndex;

                    // Load existing cell data if available
                    if (hall.layout?.cells?.[`${r}-${c}`]) {
                        const cellData = hall.layout.cells[`${r}-${c}`];

                        // Handle different data formats
                        if (cellData.type) {
                            cell.className = `grid-cell ${cellData.type}`;

                            // Set display text based on type
                            if (cellData.type === 'seat') {
                                cell.textContent = cellData.label || cellData.seatNumber || '';
                                if (cellData.seatNumber) {
                                    cell.dataset.seatNumber = cellData.seatNumber;
                                    if (cellData.seatNumber > seatCount[hallIndex]) {
                                        seatCount[hallIndex] = cellData.seatNumber;
                                    }
                                }
                            } else if (cellData.type === 'directional') {
                                const directionSymbols = {
                                    'up': '↑',
                                    'down': '↓',
                                    'left': '←',
                                    'right': '→'
                                };
                                const direction = cellData.direction || 'up';
                                cell.innerHTML = `
                                    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                        <div style="position: absolute; top: 2px; font-size: 0.7rem;">${directionSymbols[direction]}</div>
                                        <div style="font-size: 0.8rem; font-weight: bold;">${cellData.seatNumber || ''}</div>
                                    </div>
                                `;
                                if (cellData.seatNumber) {
                                    cell.dataset.seatNumber = cellData.seatNumber;
                                    cell.dataset.direction = direction;
                                    if (cellData.seatNumber > seatCount[hallIndex]) {
                                        seatCount[hallIndex] = cellData.seatNumber;
                                    }
                                }
                            } else if (cellData.type === 'custom') {
                                cell.dataset.customName = cellData.customName;
                                cell.dataset.customColor = cellData.customColor;
                                cell.dataset.customAreaId = cellData.customAreaId;
                                cell.dataset.textOrientation = cellData.textOrientation || 'horizontal';
                                cell.style.backgroundColor = cellData.customColor;
                                cell.style.color = '#fff';
                                cell.style.fontWeight = 'bold';

                                // We'll calculate borders after loading all cells
                                cell.textContent = '';
                            } else if (cellData.type === 'blocked') {
                                cell.textContent = '❌';
                            } else if (cellData.type === 'entrance') {
                                cell.textContent = '🚪';
                            } else if (cellData.type === 'restroom') {
                                cell.textContent = '🚻';
                            } else if (cellData.type === 'vip') {
                                cell.textContent = '⭐';
                            } else {
                                cell.textContent = cellData.label || cellData.name || '';
                            }

                            // Apply table styling if this is part of a table
                            if (cellData.isTable && cellData.tableId) {
                                cell.classList.add('table-group');
                                cell.dataset.tableId = cellData.tableId;
                                // Don't change background or text color - keep seat styling
                                // Borders will be applied by applyTableBorders function
                            }
                        } else if (cellData.marker) {
                            // Handle markers (entrance, restroom)
                            if (cellData.marker === 'entrance') {
                                cell.className = 'grid-cell entrance';
                                cell.textContent = '🚪';
                            } else if (cellData.marker === 'restroom') {
                                cell.className = 'grid-cell restroom';
                                cell.textContent = '🚻';
                            }
                        } else if (typeof cellData === 'string') {
                            // Handle legacy string format
                            cell.className = `grid-cell ${cellData}`;
                            cell.textContent = cellData;
                        }
                    }

                    cell.onclick = (e) => handleLayoutCellClick(e, hallIndex, r, c);
                    gridContainer.appendChild(cell);
                }
            }

            // After loading all cells, apply merged styling to custom areas
            applyCustomAreaMerging(hallIndex);

            // Apply borders to table groups
            applyTableBorders(hallIndex);

            // Update seat count display
            updateSeatCount(hallIndex);
        }

        function applyTableBorders(hallIndex) {
            // Group table cells by tableId
            const tableCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"].table-group`);
            const tableGroups = {};

            tableCells.forEach(cell => {
                const tableId = cell.dataset.tableId;
                if (!tableGroups[tableId]) {
                    tableGroups[tableId] = [];
                }
                tableGroups[tableId].push(cell);
            });

            // For each table, calculate bounds and apply borders
            Object.entries(tableGroups).forEach(([tableId, cells]) => {
                if (cells.length === 0) return;

                // Get all cell coordinates
                const coords = cells.map(cell => ({
                    row: parseInt(cell.dataset.row),
                    col: parseInt(cell.dataset.col),
                    cell: cell
                }));

                const minRow = Math.min(...coords.map(c => c.row));
                const maxRow = Math.max(...coords.map(c => c.row));
                const minCol = Math.min(...coords.map(c => c.col));
                const maxCol = Math.max(...coords.map(c => c.col));

                // Apply borders to each cell
                coords.forEach(({ row, col, cell }) => {
                    const isTopEdge = row === minRow;
                    const isBottomEdge = row === maxRow;
                    const isLeftEdge = col === minCol;
                    const isRightEdge = col === maxCol;

                    if (isTopEdge) cell.style.borderTop = '3px solid #4CAF50';
                    if (isBottomEdge) cell.style.borderBottom = '3px solid #4CAF50';
                    if (isLeftEdge) cell.style.borderLeft = '3px solid #4CAF50';
                    if (isRightEdge) cell.style.borderRight = '3px solid #4CAF50';

                    // Remove internal borders
                    if (!isTopEdge) cell.style.borderTop = 'none';
                    if (!isBottomEdge) cell.style.borderBottom = 'none';
                    if (!isLeftEdge) cell.style.borderLeft = 'none';
                    if (!isRightEdge) cell.style.borderRight = 'none';
                });
            });
        }

        function applyCustomAreaMerging(hallIndex) {
            // Group cells by customAreaId
            const customCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"].custom`);
            const areaGroups = {};

            customCells.forEach(cell => {
                const areaId = cell.dataset.customAreaId || `${cell.dataset.customName}-${cell.dataset.customColor}`;
                if (!areaGroups[areaId]) {
                    areaGroups[areaId] = [];
                }
                areaGroups[areaId].push(cell);
            });

            // For each custom area, calculate bounds and apply merged styling
            Object.entries(areaGroups).forEach(([areaId, cells]) => {
                if (cells.length === 0) return;

                const coords = cells.map(c => ({
                    row: parseInt(c.dataset.row),
                    col: parseInt(c.dataset.col),
                    cell: c
                }));

                const minRow = Math.min(...coords.map(c => c.row));
                const maxRow = Math.max(...coords.map(c => c.row));
                const minCol = Math.min(...coords.map(c => c.col));
                const maxCol = Math.max(...coords.map(c => c.col));

                const areaName = cells[0].dataset.customName;
                const areaColor = cells[0].dataset.customColor;

                // Apply borders and find top-left cell
                let topLeftCell = null;
                cells.forEach(cell => {
                    const r = parseInt(cell.dataset.row);
                    const c = parseInt(cell.dataset.col);

                    const isTopEdge = r === minRow;
                    const isBottomEdge = r === maxRow;
                    const isLeftEdge = c === minCol;
                    const isRightEdge = c === maxCol;

                    cell.style.borderTop = isTopEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderBottom = isBottomEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderLeft = isLeftEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderRight = isRightEdge ? `3px solid ${areaColor}` : 'none';

                    if (r === minRow && c === minCol) {
                        topLeftCell = cell;
                    }
                });

                // Add text overlay to top-left cell
                if (topLeftCell) {
                    const rowSpan = maxRow - minRow + 1;
                    const colSpan = maxCol - minCol + 1;
                    const orientation = topLeftCell.dataset.textOrientation || 'horizontal';

                    let transform = 'none';
                    if (orientation === 'vertical-left') {
                        transform = 'rotate(-90deg)';
                    } else if (orientation === 'vertical-right') {
                        transform = 'rotate(90deg)';
                    }

                    topLeftCell.style.position = 'relative';
                    topLeftCell.innerHTML = `
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: ${colSpan * 100}%;
                            height: ${rowSpan * 100}%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: ${Math.min(1.5, Math.max(0.75, colSpan * 0.4))}rem;
                            padding: 0.5rem;
                            pointer-events: none;
                            z-index: 1;
                            transform: ${transform};
                        ">${areaName}</div>
                    `;
                }
            });
        }

        function selectLayoutTool(tool, hallIndex, skipModal = false) {
            currentTool[hallIndex] = tool;

            // Remove active from all layout tool buttons
            const buttons = document.querySelectorAll('.layout-designer .tool-btn');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Add active to the clicked tool button
            const toolMap = {
                'seat': '💺',
                'directional': '🪑',
                'blocked': '🚫',
                'entrance': '🚪',
                'restroom': '🚻',
                'vip': '⭐',
                'custom': '🎨',
                'clear': '🗑️'
            };

            buttons.forEach(btn => {
                const btnText = btn.textContent.trim();
                if (toolMap[tool] && btnText.includes(toolMap[tool])) {
                    btn.classList.add('active');
                }
            });

            // Show modals only if not skipping
            if (!skipModal) {
                if (tool === 'custom') {
                    startCustomAreaSelection(hallIndex);
                } else if (tool === 'seat') {
                    showSeatNumberModal(hallIndex);
                } else if (tool === 'directional') {
                    showDirectionalSeatModal(hallIndex);
                } else if (tool === 'blocked') {
                    showBlockedColorModal(hallIndex);
                }
            }
        }

        function showBlockedColorModal(hallIndex) {
            if (!window.blockedColor) window.blockedColor = {};
            const currentColor = blockedColor[hallIndex] || '#f44336';

            showModal({
                title: '🚫 Blocked Area Color',
                message: `
                    <div style="padding: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Choose Blocked Color</label>
                        <input type="color" id="blockedColorPicker" value="${currentColor}"
                            style="width: 100%; height: 50px; border: 1px solid var(--gray-light); border-radius: 6px; cursor: pointer;">
                    </div>
                `,
                confirmText: 'OK',
                cancelText: 'Cancel',
                showCancel: true,
                autoClose: false,
                onConfirm: () => {
                    const color = document.getElementById('blockedColorPicker').value;
                    blockedColor[hallIndex] = color;
                },
                onCancel: () => {
                    selectLayoutTool('blocked', hallIndex, true);
                }
            });
        }

        function showSeatNumberModal(hallIndex) {
            // Get the next seat number
            if (!window.seatCount) window.seatCount = {};
            if (!seatCount[hallIndex]) seatCount[hallIndex] = 0;
            const nextNumber = seatCount[hallIndex] + 1;

            showModal({
                title: '💺 Place Seat',
                message: `
                    <div style="padding: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Start with what number?</label>
                        <input type="number" id="seatStartNumber" value="${nextNumber}" min="1"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1rem;">
                    </div>
                `,
                confirmText: 'OK',
                cancelText: 'Cancel',
                showCancel: true,
                autoClose: false,
                onConfirm: () => {
                    const startNumber = parseInt(document.getElementById('seatStartNumber').value) || nextNumber;
                    seatCount[hallIndex] = startNumber - 1; // Set to one before so next seat will be this number
                },
                onCancel: () => {
                    selectLayoutTool('seat', hallIndex, true); // Keep seat tool active, skip modal
                }
            });
        }

        function showDirectionalSeatModal(hallIndex) {
            // Get the next seat number
            if (!window.seatCount) window.seatCount = {};
            if (!seatCount[hallIndex]) seatCount[hallIndex] = 0;
            const nextNumber = seatCount[hallIndex] + 1;

            showModal({
                title: '🪑 Place Directional Seat',
                message: `
                    <div style="padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Seat Direction</label>
                            <select id="seatDirection" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1rem;">
                                <option value="up">↑ Up</option>
                                <option value="down">↓ Down</option>
                                <option value="left">← Left</option>
                                <option value="right">→ Right</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Start with what number?</label>
                            <input type="number" id="directionalStartNumber" value="${nextNumber}" min="1"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1rem;">
                        </div>
                    </div>
                `,
                confirmText: 'OK',
                cancelText: 'Cancel',
                showCancel: true,
                autoClose: false,
                onConfirm: () => {
                    const direction = document.getElementById('seatDirection').value;
                    const startNumber = parseInt(document.getElementById('directionalStartNumber').value) || nextNumber;

                    if (!window.directionalSeatConfig) {
                        window.directionalSeatConfig = {};
                    }
                    directionalSeatConfig[hallIndex] = {
                        direction: direction,
                        startNumber: startNumber
                    };
                    seatCount[hallIndex] = startNumber - 1; // Set to one before so next seat will be this number
                },
                onCancel: () => {
                    selectLayoutTool('seat', hallIndex, true); // Switch back to regular seat, skip modal
                }
            });
        }

        function startTableSelection(hallIndex) {
            // Initialize table selection cells if not exists
            if (!window.tableSelectionCells) {
                window.tableSelectionCells = {};
            }
            if (!tableSelectionCells[hallIndex]) {
                tableSelectionCells[hallIndex] = new Set();
            }
            tableSelectionCells[hallIndex].clear();

            // Show the table selection panel
            const panel = document.getElementById(`table-selection-panel-${hallIndex}`);
            if (panel) {
                panel.style.display = 'block';
            }

            // Clear any existing selections
            document.querySelectorAll(`[data-hall-index="${hallIndex}"].selected`).forEach(cell => {
                cell.classList.remove('selected');
            });

            updateTableSelectionCount(hallIndex);
        }

        function updateTableSelectionCount(hallIndex) {
            const countElement = document.getElementById(`table-selection-count-${hallIndex}`);
            if (countElement && tableSelectionCells[hallIndex]) {
                const count = tableSelectionCells[hallIndex].size;
                countElement.textContent = `${count} seat${count !== 1 ? 's' : ''} selected`;
            }
        }

        function isAdjacentToTableSelection(row, col, hallIndex) {
            if (!tableSelectionCells[hallIndex] || tableSelectionCells[hallIndex].size === 0) {
                return true; // First cell is always valid
            }

            const directions = [
                [-1, 0], [1, 0], [0, -1], [0, 1] // up, down, left, right
            ];

            for (let key of tableSelectionCells[hallIndex]) {
                const [r, c] = key.split('-').map(Number);
                for (let [dr, dc] of directions) {
                    if (r + dr === row && c + dc === col) {
                        return true;
                    }
                }
            }
            return false;
        }

        function confirmTableSelection(hallIndex) {
            if (!tableSelectionCells[hallIndex] || tableSelectionCells[hallIndex].size === 0) {
                showModal({
                    title: '⚠️ No Seats Selected',
                    message: 'Please select at least one seat to create a table.',
                    type: 'error'
                });
                return;
            }

            const tableId = `table-${hallIndex}-${Date.now()}`;

            // Find bounds of the table
            const coords = Array.from(tableSelectionCells[hallIndex]).map(key => {
                const [r, c] = key.split('-').map(Number);
                return { row: r, col: c };
            });

            const minRow = Math.min(...coords.map(c => c.row));
            const maxRow = Math.max(...coords.map(c => c.row));
            const minCol = Math.min(...coords.map(c => c.col));
            const maxCol = Math.max(...coords.map(c => c.col));

            // Apply table styling to all selected cells
            tableSelectionCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-').map(Number);
                const cell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`);

                if (cell) {
                    // Keep the existing seat class and styling
                    cell.classList.add('table-group');
                    cell.dataset.tableId = tableId;

                    // Apply green borders only on edges
                    const isTopEdge = r === minRow;
                    const isBottomEdge = r === maxRow;
                    const isLeftEdge = c === minCol;
                    const isRightEdge = c === maxCol;

                    if (isTopEdge) cell.style.borderTop = '3px solid #4CAF50';
                    if (isBottomEdge) cell.style.borderBottom = '3px solid #4CAF50';
                    if (isLeftEdge) cell.style.borderLeft = '3px solid #4CAF50';
                    if (isRightEdge) cell.style.borderRight = '3px solid #4CAF50';

                    // Remove internal borders
                    if (!isTopEdge) cell.style.borderTop = 'none';
                    if (!isBottomEdge) cell.style.borderBottom = 'none';
                    if (!isLeftEdge) cell.style.borderLeft = 'none';
                    if (!isRightEdge) cell.style.borderRight = 'none';
                }
            });

            // Clear selection and hide panel
            cancelTableSelection(hallIndex);
            saveHallLayout(hallIndex);
            markUnsaved();
        }

        function cancelTableSelection(hallIndex) {
            // Clear selections
            if (tableSelectionCells[hallIndex]) {
                tableSelectionCells[hallIndex].clear();
            }

            document.querySelectorAll(`[data-hall-index="${hallIndex}"].selected`).forEach(cell => {
                cell.classList.remove('selected');
            });

            // Hide panel
            const panel = document.getElementById(`table-selection-panel-${hallIndex}`);
            if (panel) {
                panel.style.display = 'none';
            }

            // Switch back to seat tool, skip modal
            selectLayoutTool('seat', hallIndex, true);
        }

        function startCustomAreaSelection(hallIndex) {
            // Initialize custom area cells if not exists
            if (!window.customAreaCells) {
                window.customAreaCells = {};
            }
            if (!customAreaCells[hallIndex]) {
                customAreaCells[hallIndex] = new Set();
            }
            customAreaCells[hallIndex].clear();

            // Initialize config with defaults
            if (!window.customAreaConfig) {
                window.customAreaConfig = {};
            }
            customAreaConfig[hallIndex] = {
                name: 'Custom Area',
                color: '#4A90E2',
                orientation: 'horizontal'
            };

            // Show the panel
            const customPanel = document.getElementById(`custom-area-info-${hallIndex}`);
            if (customPanel) {
                customPanel.style.display = 'block';
                document.getElementById(`custom-area-name-${hallIndex}`).value = customAreaConfig[hallIndex].name;
                document.getElementById(`custom-area-color-${hallIndex}`).value = customAreaConfig[hallIndex].color;
                // Make inputs editable
                document.getElementById(`custom-area-name-${hallIndex}`).removeAttribute('readonly');
                document.getElementById(`custom-area-color-${hallIndex}`).removeAttribute('disabled');
                // Add listeners to update config
                document.getElementById(`custom-area-name-${hallIndex}`).oninput = (e) => {
                    customAreaConfig[hallIndex].name = e.target.value;
                    previewCustomAreaText(hallIndex);
                    // Update example
                    const example = document.getElementById(`orientation-example-${hallIndex}`);
                    if (example) example.textContent = e.target.value || 'Custom Area';
                };
                document.getElementById(`custom-area-color-${hallIndex}`).oninput = (e) => {
                    customAreaConfig[hallIndex].color = e.target.value;
                    // Update selected cell colors
                    customAreaCells[hallIndex].forEach(cellKey => {
                        const [r, c] = cellKey.split('-').map(Number);
                        const cell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.backgroundColor = e.target.value;
                        }
                    });
                };
                updateCustomAreaInfo(hallIndex);
                // Highlight default orientation button
                updateOrientationButtons(hallIndex, 'horizontal');
            }
        }

        function updateCustomAreaOrientation(hallIndex, orientation) {
            if (!customAreaConfig[hallIndex]) return;

            // Update config
            customAreaConfig[hallIndex].orientation = orientation;

            // Update button states
            updateOrientationButtons(hallIndex, orientation);

            // Show live preview on selected cells
            previewCustomAreaText(hallIndex);
        }

        function updateOrientationButtons(hallIndex, activeOrientation) {
            // Remove active from all
            ['horizontal', 'vertical-left', 'vertical-right'].forEach(orient => {
                const btn = document.getElementById(`orient-${orient}-${hallIndex}`);
                if (btn) {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                }
            });

            // Add active to selected
            const activeBtn = document.getElementById(`orient-${activeOrientation}-${hallIndex}`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline');
                activeBtn.classList.add('btn-primary');
            }

            // Update example text
            const example = document.getElementById(`orientation-example-${hallIndex}`);
            if (example) {
                const areaName = customAreaConfig[hallIndex]?.name || 'Custom Area';
                let transform = 'none';
                if (activeOrientation === 'vertical-left') {
                    transform = 'rotate(-90deg)';
                } else if (activeOrientation === 'vertical-right') {
                    transform = 'rotate(90deg)';
                }
                example.style.transform = transform;
                example.textContent = areaName;
            }
        }

        function previewCustomAreaText(hallIndex) {
            if (!customAreaCells[hallIndex] || customAreaCells[hallIndex].size === 0) return;
            if (!customAreaConfig[hallIndex]) return;

            const config = customAreaConfig[hallIndex];
            const coords = Array.from(customAreaCells[hallIndex]).map(key => {
                const [r, c] = key.split('-').map(Number);
                return { row: r, col: c, key: key };
            });

            const minRow = Math.min(...coords.map(c => c.row));
            const minCol = Math.min(...coords.map(c => c.col));
            const maxRow = Math.max(...coords.map(c => c.row));
            const maxCol = Math.max(...coords.map(c => c.col));

            const rowSpan = maxRow - minRow + 1;
            const colSpan = maxCol - minCol + 1;

            let transform = 'none';
            if (config.orientation === 'vertical-left') {
                transform = 'rotate(-90deg)';
            } else if (config.orientation === 'vertical-right') {
                transform = 'rotate(90deg)';
            }

            // Clear all preview text first
            customAreaCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-').map(Number);
                const cell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`);
                if (cell) {
                    cell.innerHTML = '';
                }
            });

            // Add preview text to top-left cell
            const topLeftKey = `${minRow}-${minCol}`;
            const topLeftCell = document.querySelector(`[data-hall-index="${hallIndex}"][data-row="${minRow}"][data-col="${minCol}"]`);

            if (topLeftCell) {
                topLeftCell.style.position = 'relative';
                topLeftCell.innerHTML = `
                    <div style="
                        position: absolute;
                        top: 0; left: 0;
                        width: ${colSpan * 100}%;
                        height: ${rowSpan * 100}%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: ${Math.min(1.5, Math.max(0.75, colSpan * 0.4))}rem;
                        font-weight: bold;
                        color: white;
                        transform: ${transform};
                        pointer-events: none;
                        z-index: 1;
                        opacity: 0.8;
                    ">${config.name}</div>
                `;
            }
        }

        function clearSelection(hallIndex) {
            if (selectedCells[hallIndex]) {
                selectedCells[hallIndex].clear();
            }
            document.querySelectorAll(`[data-hall-index="${hallIndex}"].selected`).forEach(cell => {
                cell.classList.remove('selected');
            });
            updateSelectionInfo(hallIndex);
        }
        
        function updateSelectionInfo(hallIndex) {
            const info = document.getElementById(`selection-info-${hallIndex}`);
            const count = document.getElementById(`selection-count-${hallIndex}`);
            if (!selectedCells[hallIndex]) {
                selectedCells[hallIndex] = new Set();
            }
            
            if (selectedCells[hallIndex].size > 0) {
                info.style.display = 'block';
                count.textContent = `${selectedCells[hallIndex].size} cells selected`;
            } else {
                info.style.display = 'none';
            }
        }

        function handleLayoutCellClick(event, hallIndex, row, col) {
            const cell = event.target;
            const tool = currentTool[hallIndex] || 'seat';
            const cellKey = `${row}-${col}`;

            if (tool === 'table-select') {
                // Table selection mode - only allow selecting existing seats
                const cellType = cell.className.replace('grid-cell', '').replace('selected', '').replace('table-group', '').trim();

                if (cellType !== 'seat' && cellType !== 'directional') {
                    showModal({
                        title: '⚠️ Invalid Selection',
                        message: 'You can only select existing seats to create a table.',
                        type: 'error'
                    });
                    return;
                }

                if (!tableSelectionCells[hallIndex]) {
                    tableSelectionCells[hallIndex] = new Set();
                }

                if (tableSelectionCells[hallIndex].has(cellKey)) {
                    // Deselect cell
                    tableSelectionCells[hallIndex].delete(cellKey);
                    cell.classList.remove('selected');
                } else {
                    // Check adjacency if not first cell
                    if (tableSelectionCells[hallIndex].size > 0) {
                        if (!isAdjacentToTableSelection(row, col, hallIndex)) {
                            showModal({
                                title: '⚠️ Invalid Selection',
                                message: 'All seats in a table must be adjacent to each other.',
                                type: 'error'
                            });
                            return;
                        }
                    }
                    tableSelectionCells[hallIndex].add(cellKey);
                    cell.classList.add('selected');
                }
                updateTableSelectionCount(hallIndex);
            } else if (tool === 'custom') {
                // Custom area selection mode with adjacency check
                if (!customAreaCells[hallIndex]) {
                    customAreaCells[hallIndex] = new Set();
                }

                if (customAreaCells[hallIndex].has(cellKey)) {
                    // Deselect cell
                    customAreaCells[hallIndex].delete(cellKey);
                    cell.classList.remove('selected');
                } else {
                    // Check adjacency if not first cell
                    if (customAreaCells[hallIndex].size > 0) {
                        if (!isAdjacentToCustomArea(row, col, hallIndex)) {
                            showModal({
                                title: '⚠️ Invalid Selection',
                                message: 'All custom area cells must be adjacent to each other.',
                                type: 'error'
                            });
                            return;
                        }
                    }
                    customAreaCells[hallIndex].add(cellKey);
                    cell.classList.add('selected');
                }
                updateCustomAreaInfo(hallIndex);
            } else if (tool === 'clear') {
                // Check if this is a table group cell
                if (cell.classList.contains('table-group') && cell.dataset.tableId) {
                    const tableId = cell.dataset.tableId;

                    // Find and clear all cells with the same table ID
                    const allCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"]`);
                    allCells.forEach(c => {
                        if (c.dataset.tableId === tableId) {
                            c.classList.remove('table-group');
                            delete c.dataset.tableId;
                            // Reset borders - remove all table borders
                            c.style.borderTop = '';
                            c.style.borderBottom = '';
                            c.style.borderLeft = '';
                            c.style.borderRight = '';
                            // Keep original background and color (seats stay blue)
                        }
                    });
                }
                // Check if this is a custom area cell
                else if (cell.classList.contains('custom') && cell.dataset.customName) {
                    const customName = cell.dataset.customName;
                    const customColor = cell.dataset.customColor;

                    // Find and clear all cells with the same custom area
                    const allCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"]`);
                    allCells.forEach(c => {
                        if (c.dataset.customName === customName && c.dataset.customColor === customColor) {
                            c.className = 'grid-cell';
                            c.textContent = '';
                            c.style.backgroundColor = '';
                            c.style.color = '';
                            c.style.fontWeight = '';
                            c.style.fontSize = '';
                            c.style.border = '';
                            c.style.display = '';
                            c.style.alignItems = '';
                            c.style.justifyContent = '';
                            delete c.dataset.customName;
                            delete c.dataset.customColor;
                        }
                    });
                } else {
                    // Clear single cell
                    cell.className = 'grid-cell';
                    cell.textContent = '';
                    cell.style.backgroundColor = '';
                    cell.style.color = '';
                    cell.style.fontWeight = '';
                    cell.style.fontSize = '';
                    cell.style.border = '';
                    delete cell.dataset.customName;
                    delete cell.dataset.customColor;
                    delete cell.dataset.seatNumber;
                }
                saveHallLayout(hallIndex);
                markUnsaved();
            } else {
                // Apply tool to cell immediately
                applyCellType(cell, tool, hallIndex, row, col);
                saveHallLayout(hallIndex);
                markUnsaved();
            }
        }
        
        // Helper function to get next available seat number (prevents duplicates)
        function getNextAvailableSeatNumber(hallIndex) {
            if (!window.seatCount) window.seatCount = {};
            if (!seatCount[hallIndex]) seatCount[hallIndex] = 0;

            // Get all existing seat numbers from the grid
            const grid = document.getElementById(`hallGrid${hallIndex}`);
            if (!grid) {
                seatCount[hallIndex]++;
                return seatCount[hallIndex];
            }

            const existingSeatNumbers = new Set();
            const cells = grid.querySelectorAll('.grid-cell');
            cells.forEach(cell => {
                if (cell.dataset.seatNumber) {
                    existingSeatNumbers.add(parseInt(cell.dataset.seatNumber));
                }
            });

            // Increment counter and keep going until we find a number not in use
            do {
                seatCount[hallIndex]++;
            } while (existingSeatNumbers.has(seatCount[hallIndex]));

            return seatCount[hallIndex];
        }

        function applyCellType(cell, type, hallIndex, row, col) {
            // Special handling for VIP - can be placed over existing seats
            if (type === 'vip') {
                const currentClass = cell.className;
                const isSeat = currentClass.includes('seat') || currentClass.includes('directional');

                if (isSeat) {
                    // Convert existing seat to VIP seat
                    const seatNumber = cell.dataset.seatNumber;
                    const isDirectional = currentClass.includes('directional');

                    if (isDirectional) {
                        // VIP directional seat
                        cell.className = 'grid-cell directional vip-seat';
                        const direction = cell.dataset.direction || 'up';
                        const directionSymbols = {
                            'up': '↑',
                            'down': '↓',
                            'left': '←',
                            'right': '→'
                        };

                        cell.innerHTML = `
                            <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                <div style="position: absolute; top: 2px; font-size: 0.7rem;">${directionSymbols[direction]}</div>
                                <div style="font-size: 0.8rem; font-weight: bold;">${seatNumber}</div>
                                <div style="position: absolute; bottom: 0px; right: 2px; font-size: 0.6rem;">⭐</div>
                            </div>
                        `;
                        cell.dataset.isVip = 'true';
                    } else {
                        // VIP regular seat
                        cell.className = 'grid-cell seat vip-seat';
                        cell.innerHTML = `
                            <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                <div style="font-size: 0.9rem; font-weight: bold;">${seatNumber}</div>
                                <div style="position: absolute; bottom: 0px; right: 2px; font-size: 0.6rem;">⭐</div>
                            </div>
                        `;
                        cell.dataset.isVip = 'true';
                    }
                    return;
                } else {
                    // VIP area marker (no seat)
                    cell.className = 'grid-cell vip';
                    cell.textContent = '⭐';
                    cell.style.backgroundColor = '#ffd700';
                    delete cell.dataset.isVip;
                }
                return;
            }

            cell.className = `grid-cell ${type}`;

            if (type === 'seat') {
                const seatNumber = getNextAvailableSeatNumber(hallIndex);
                cell.textContent = `${seatNumber}`;
                cell.dataset.seatNumber = seatNumber;
            } else if (type === 'directional') {
                const seatNumber = getNextAvailableSeatNumber(hallIndex);

                const config = window.directionalSeatConfig?.[hallIndex] || { direction: 'up' };
                const directionSymbols = {
                    'up': '↑',
                    'down': '↓',
                    'left': '←',
                    'right': '→'
                };

                cell.innerHTML = `
                    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <div style="position: absolute; top: 2px; font-size: 0.7rem;">${directionSymbols[config.direction]}</div>
                        <div style="font-size: 0.8rem; font-weight: bold;">${seatNumber}</div>
                    </div>
                `;
                cell.dataset.seatNumber = seatNumber;
                cell.dataset.direction = config.direction;
            } else if (type === 'entrance') {
                cell.textContent = '🚪';
            } else if (type === 'restroom') {
                cell.textContent = '🚻';
            } else if (type === 'blocked') {
                cell.textContent = '❌';
                // Apply custom blocked color if set
                if (window.blockedColor && blockedColor[hallIndex]) {
                    cell.style.backgroundColor = blockedColor[hallIndex];
                }
            } else {
                cell.textContent = '';
            }
        }
        
        function applyToSelected(hallIndex) {
            if (!selectedCells[hallIndex] || selectedCells[hallIndex].size === 0) {
                showAlert('Please select cells first', 'Selection Required');
                return;
            }
            
            const tool = currentTool[hallIndex];
            if (!tool || tool === 'select') {
                showAlert('Please select a tool to apply', 'Tool Required');
                return;
            }
            
            if (tool === 'caller' || tool === 'vip') {
                // Prompt for custom name for special areas
                const name = prompt(`Enter name for ${tool === 'caller' ? 'caller station' : 'VIP area'}:`, 
                                   tool === 'caller' ? 'Caller Station' : 'VIP Section');
                if (!name) return;
                
                selectedCells[hallIndex].forEach(cellKey => {
                    const [r, c] = cellKey.split('-');
                    const cell = document.querySelector(
                        `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                    );
                    if (cell) {
                        cell.className = `grid-cell ${tool}`;
                        cell.textContent = tool === 'caller' ? '🎤' : '⭐';
                        cell.title = name;
                        cell.dataset.customName = name;
                    }
                });
            } else {
                // Apply tool to all selected cells
                selectedCells[hallIndex].forEach(cellKey => {
                    const [r, c] = cellKey.split('-');
                    const cell = document.querySelector(
                        `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                    );
                    if (cell) {
                        applyCellType(cell, tool, hallIndex);
                    }
                });
            }
            
            clearSelection(hallIndex);
            saveHallLayout(hallIndex);
            markUnsaved();
        }
        
        function updateGridSize(hallIndex) {
            const widthInput = document.getElementById(`grid-width-${hallIndex}`);
            const heightInput = document.getElementById(`grid-height-${hallIndex}`);
            
            if (!widthInput || !heightInput) return;
            
            const newWidth = parseInt(widthInput.value) || 20;
            const newHeight = parseInt(heightInput.value) || 15;
            
            // Clear and regenerate grid
            const halls = NewcoData.get('halls') || [];
            if (halls[hallIndex]) {
                // Save existing layout data
                const oldLayout = halls[hallIndex].layout || {};
                
                // Update dimensions
                halls[hallIndex].layout = {
                    ...oldLayout,
                    width: newWidth,
                    height: newHeight,
                    rows: newHeight,
                    cols: newWidth,
                    cells: oldLayout.cells || {}
                };
                
                NewcoData.set('halls', halls);
                
                // Regenerate grid display
                const gridContainer = document.getElementById(`layout-grid-${hallIndex}`);
                gridContainer.innerHTML = '';
                initializeLayoutGrid(halls[hallIndex], hallIndex);
            }
        }

        function saveHallLayout(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            if (!halls[hallIndex]) return;

            const cells = {};
            const gridCells = document.querySelectorAll(`[data-hall-index="${hallIndex}"]`);

            gridCells.forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                const type = cell.className.replace('grid-cell', '').replace('selected', '').trim();

                if (type) {
                    const cellData = {
                        type: type,
                        label: cell.textContent
                    };

                    // Save custom area data
                    if (type === 'custom') {
                        cellData.customName = cell.dataset.customName;
                        cellData.customColor = cell.dataset.customColor;
                        cellData.customAreaId = cell.dataset.customAreaId;
                        cellData.textOrientation = cell.dataset.textOrientation || 'horizontal';
                        cellData.showText = cell.innerHTML.includes('position: absolute') ? true : false;
                    }

                    // Save seat number
                    if (type === 'seat' && cell.dataset.seatNumber) {
                        cellData.seatNumber = cell.dataset.seatNumber;
                    }

                    // Save directional seat data
                    if (type === 'directional' && cell.dataset.seatNumber) {
                        cellData.seatNumber = cell.dataset.seatNumber;
                        cellData.direction = cell.dataset.direction || 'up';
                    }

                    // Save table group data
                    if (cell.classList.contains('table-group') && cell.dataset.tableId) {
                        cellData.tableId = cell.dataset.tableId;
                        cellData.isTable = true;
                    }

                    cells[`${row}-${col}`] = cellData;
                }
            });

            const widthInput = document.getElementById(`grid-width-${hallIndex}`);
            const heightInput = document.getElementById(`grid-height-${hallIndex}`);

            halls[hallIndex].layout = {
                rows: heightInput ? parseInt(heightInput.value) : 15,
                cols: widthInput ? parseInt(widthInput.value) : 20,
                width: widthInput ? parseInt(widthInput.value) : 20,
                height: heightInput ? parseInt(heightInput.value) : 15,
                cells: cells
            };

            NewcoData.set('halls', halls);
            updateSeatCount(hallIndex);
        }

        function updateSeatCount(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            if (!halls[hallIndex] || !halls[hallIndex].layout || !halls[hallIndex].layout.cells) {
                return;
            }

            const cells = halls[hallIndex].layout.cells;
            let seatCount = 0;

            Object.values(cells).forEach(cellData => {
                if (cellData.type === 'seat' || cellData.type === 'vip' || cellData.type === 'directional') {
                    seatCount++;
                }
            });

            const countElement = document.getElementById(`seat-count-value-${hallIndex}`);
            if (countElement) {
                countElement.textContent = seatCount;
            }
        }

        // Custom Area Functions
        function updateCustomAreaInfo(hallIndex) {
            const count = document.getElementById(`custom-area-count-${hallIndex}`);
            if (count && customAreaCells[hallIndex]) {
                count.textContent = `${customAreaCells[hallIndex].size} cells selected`;
            }
            // Update preview when cells change
            previewCustomAreaText(hallIndex);
        }

        function isAdjacentToCustomArea(row, col, hallIndex) {
            // Check if the cell at (row, col) is adjacent to any cell in customAreaCells
            const directions = [
                [-1, 0], [1, 0], [0, -1], [0, 1] // up, down, left, right
            ];

            for (let key of customAreaCells[hallIndex]) {
                const [r, c] = key.split('-').map(Number);
                for (let [dr, dc] of directions) {
                    if (r + dr === row && c + dc === col) {
                        return true;
                    }
                }
            }
            return false;
        }

        function confirmCustomArea(hallIndex) {
            const nameInput = document.getElementById(`custom-area-name-${hallIndex}`);
            const colorInput = document.getElementById(`custom-area-color-${hallIndex}`);

            if (!nameInput.value.trim()) {
                showModal({
                    title: '⚠️ Name Required',
                    message: 'Please enter a name for the custom area.',
                    type: 'error'
                });
                return;
            }

            if (!customAreaCells[hallIndex] || customAreaCells[hallIndex].size === 0) {
                showModal({
                    title: '⚠️ No Cells Selected',
                    message: 'Please select cells for the custom area.',
                    type: 'error'
                });
                return;
            }

            const areaName = nameInput.value.trim();
            const areaColor = colorInput.value;
            const orientation = customAreaConfig[hallIndex]?.orientation || 'horizontal';

            // Find bounds of the custom area (min/max row and col)
            const cellArray = Array.from(customAreaCells[hallIndex]);
            const coords = cellArray.map(key => {
                const [r, c] = key.split('-').map(Number);
                return { row: r, col: c, key };
            });

            const minRow = Math.min(...coords.map(c => c.row));
            const maxRow = Math.max(...coords.map(c => c.row));
            const minCol = Math.min(...coords.map(c => c.col));
            const maxCol = Math.max(...coords.map(c => c.col));
            const topLeftCell = `${minRow}-${minCol}`;

            // Generate unique ID for this custom area
            const areaId = `custom-area-${hallIndex}-${Date.now()}`;

            // Apply custom area to all selected cells
            customAreaCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-').map(Number);
                const cell = document.querySelector(
                    `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                );
                if (cell) {
                    cell.className = 'grid-cell custom';
                    cell.style.backgroundColor = areaColor;
                    cell.style.color = '#fff';
                    cell.style.fontWeight = 'bold';
                    cell.dataset.customName = areaName;
                    cell.dataset.customColor = areaColor;
                    cell.dataset.customAreaId = areaId;
                    cell.classList.remove('selected');
                    cell.textContent = '';

                    // Remove borders between cells in same area, but keep outer border
                    const isTopEdge = r === minRow;
                    const isBottomEdge = r === maxRow;
                    const isLeftEdge = c === minCol;
                    const isRightEdge = c === maxCol;

                    cell.style.borderTop = isTopEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderBottom = isBottomEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderLeft = isLeftEdge ? `3px solid ${areaColor}` : 'none';
                    cell.style.borderRight = isRightEdge ? `3px solid ${areaColor}` : 'none';

                    // Create text overlay only in top-left cell
                    if (cellKey === topLeftCell) {
                        const rowSpan = maxRow - minRow + 1;
                        const colSpan = maxCol - minCol + 1;

                        let transform = 'none';
                        if (orientation === 'vertical-left') {
                            transform = 'rotate(-90deg)';
                        } else if (orientation === 'vertical-right') {
                            transform = 'rotate(90deg)';
                        }

                        cell.style.position = 'relative';
                        cell.innerHTML = `
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: ${colSpan * 100}%;
                                height: ${rowSpan * 100}%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: ${Math.min(1.5, Math.max(0.75, colSpan * 0.4))}rem;
                                padding: 0.5rem;
                                pointer-events: none;
                                z-index: 1;
                                transform: ${transform};
                            ">${areaName}</div>
                        `;

                        // Store orientation in dataset
                        cell.dataset.textOrientation = orientation;
                    }
                }
            });

            // Clear and reset
            customAreaCells[hallIndex].clear();
            nameInput.value = '';
            colorInput.value = '#ff6b6b';
            document.getElementById(`custom-area-info-${hallIndex}`).style.display = 'none';

            // Don't auto-select any tool
            currentTool[hallIndex] = null;
            // Remove active from all buttons
            document.querySelectorAll('.layout-designer .tool-btn').forEach(btn => btn.classList.remove('active'));

            saveHallLayout(hallIndex);
            markUnsaved();
        }

        function cancelCustomArea(hallIndex) {
            // Clear selection visuals
            customAreaCells[hallIndex].forEach(cellKey => {
                const [r, c] = cellKey.split('-');
                const cell = document.querySelector(
                    `[data-hall-index="${hallIndex}"][data-row="${r}"][data-col="${c}"]`
                );
                if (cell) {
                    cell.classList.remove('selected');
                    cell.style.backgroundColor = '';
                    cell.innerHTML = '';
                }
            });

            // Clear data
            customAreaCells[hallIndex].clear();
            document.getElementById(`custom-area-name-${hallIndex}`).value = '';
            document.getElementById(`custom-area-color-${hallIndex}`).value = '#ff6b6b';
            document.getElementById(`custom-area-info-${hallIndex}`).style.display = 'none';

            // Don't auto-select any tool
            currentTool[hallIndex] = null;
            // Remove active from all buttons
            document.querySelectorAll('.layout-designer .tool-btn').forEach(btn => btn.classList.remove('active'));
        }

        function updateHallInfo(hallIndex, field) {
            const halls = NewcoData.get('halls') || [];
            if (!halls[hallIndex]) return;
            
            if (field === 'address') {
                halls[hallIndex].address = document.getElementById(`hall-address-${hallIndex}`).value;
            } else if (field === 'capacity') {
                halls[hallIndex].capacity = parseInt(document.getElementById(`hall-capacity-${hallIndex}`).value) || 0;
            }
            
            NewcoData.set('halls', halls);
            markUnsaved();
        }
        
        function deleteHall(hallIndex) {
            const halls = NewcoData.get('halls') || [];
            deleteWithConfirm(
                halls,
                hallIndex,
                'Are you sure you want to delete this hall? This will also delete its layout and schedule.',
                () => {
                    // Also remove related schedules
                    const schedule = NewcoData.get('schedule') || {};
                    const schedules = schedule.schedules || {};
                    const deletedHall = halls[hallIndex];

                    // Remove its schedule
                    if (deletedHall && schedules[deletedHall.id]) {
                        delete schedules[deletedHall.id];
                        schedule.schedules = schedules;
                        NewcoData.set('schedule', schedule);
                    }

                    NewcoData.set('halls', halls);
                    loadHalls();
                    showSuccess('Hall deleted successfully');
                },
                'Delete Hall'
            );
        }
        
        function addNewHall() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add New Hall';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Hall Name</label>
                    <input type="text" class="form-input" id="newHallName" placeholder="Main Hall">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="newHallAddress" placeholder="123 Main St">
                </div>
                <div class="form-group">
                    <label class="form-label">Capacity</label>
                    <input type="number" class="form-input" id="newHallCapacity" placeholder="200">
                </div>
            `;
            
            modalSaveBtn.onclick = () => {
                const halls = NewcoData.get('halls') || [];
                const newHall = {
                    id: Date.now().toString(),
                    name: document.getElementById('newHallName').value,
                    address: document.getElementById('newHallAddress').value,
                    capacity: parseInt(document.getElementById('newHallCapacity').value) || 0,
                    layout: {
                        rows: 15,
                        cols: 20,
                        cells: {}
                    }
                };
                
                halls.push(newHall);
                NewcoData.set('halls', halls);
                
                closeModal();
                loadHalls();
                showSuccess(`Hall "${newHall.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }

        // Staff functions from wizard
        // Staff Management - CRM Style Functions
        let currentStaffSort = { column: null, direction: 'asc' };
        let selectedStaff = new Set();
        
        function loadStaff() {
            const allStaff = NewcoData.get('staff') || [];
            // Filter out master admins from display
            const staff = allStaff.filter(s => s.role !== 'master-admin');
            const org = NewcoData.get("organization") || {};

            // Update statistics cards
            updateStaffStats(staff, org);

            // Load staff table
            loadStaffTable(staff, org);
        }
        
        function updateStaffStats(staff, org) {
            // Calculate stats
            const totalStaff = staff.length + (org.email ? 1 : 0); // Include super admin
            const today = new Date().toDateString();
            const activeToday = staff.filter(s => {
                const lastActive = s.lastActive ? new Date(s.lastActive).toDateString() : null;
                return lastActive === today;
            }).length;
            const managers = staff.filter(s => s.role === 'Manager' || s.role === 'Admin').length;
            const floorStaff = staff.filter(s => s.role === 'Floor Staff' || s.role === 'Caller' || s.role === 'Cashier').length;
            
            // Update the stat cards if they exist
            const statsContainer = document.querySelector('.content-section:has(.stat-value)');
            if (statsContainer) {
                const statValues = statsContainer.querySelectorAll('.stat-value');
                if (statValues[0]) statValues[0].textContent = totalStaff;
                if (statValues[1]) statValues[1].textContent = activeToday;
                if (statValues[2]) statValues[2].textContent = managers;
                if (statValues[3]) statValues[3].textContent = floorStaff;
            }
        }
        
        function loadStaffTable(staff, org) {
            const tbody = document.getElementById('staffTableBody');
            if (!tbody) {
                // Fallback to old style if new table doesn't exist
                loadStaffLegacy();
                return;
            }
            
            tbody.innerHTML = '';
            
            // Add Super Admin first if exists
            if (org.email) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" disabled></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${(org.name || 'SA').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${org.name || 'Super Admin'}</div>
                                <div style="font-size: 0.75rem; color: var(--gray);">ID: admin</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${org.email}</div>
                        <div style="font-size: 0.75rem; color: var(--gray);">${org.phone || 'No phone'}</div>
                    </td>
                    <td style="color: #6c5ce7; font-weight: 600;">SUPER ADMIN</td>
                    <td style="color: #27ae60; font-weight: 600;">Active</td>
                    <td>Always</td>
                    <td>
                        <button class="btn btn-sm" style="padding: 0.25rem 0.5rem;" disabled>
                            <span style="font-size: 1.25rem;">⋮</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            
            // Get current user role for permission checks
            const userEmail = sessionStorage.getItem('newco_user_email');
            const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail?.toLowerCase());
            const currentUserRole = org.email && org.email.toLowerCase() === userEmail?.toLowerCase() ? 'super-admin' : (currentUser?.role || 'staff');

            // Add other staff members
            staff.forEach((member, index) => {
                const tr = document.createElement('tr');
                const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const lastActive = member.lastActive ? new Date(member.lastActive).toLocaleDateString() : 'Never';
                const status = member.status || 'Active';
                const statusColor = status === 'Active' ? 'success' : status === 'Inactive' ? 'gray' : 'warning';

                // Determine if current user can manage this staff member
                const canManage = canManageStaffMember(currentUserRole, member.role);

                tr.innerHTML = `
                    <td><input type="checkbox" data-staff-id="${member.id || index}" onchange="toggleStaffSelection('${member.id || index}')"></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: ${getColorForRole(member.role)}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${initials.substring(0, 2)}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${member.name}</div>
                                <div style="font-size: 0.75rem; color: var(--gray);">ID: ${member.id || 'staff-' + index}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${member.email}</div>
                        <div style="font-size: 0.75rem; color: var(--gray);">${member.phone || 'No phone'}</div>
                    </td>
                    <td style="color: ${getRoleTextColor(member.role)}; font-weight: 600;">${member.role}</td>
                    <td style="color: ${getStatusTextColor(status)}; font-weight: 600;">${status}</td>
                    <td>${lastActive}</td>
                    <td>
                        ${canManage ? `
                            <div style="position: relative; display: inline-block;">
                                <button class="btn btn-sm" style="padding: 0.25rem 0.5rem;" onclick="event.stopPropagation(); toggleStaffActionMenu(${index}, event)">
                                    <span style="font-size: 1.25rem;">⋮</span>
                                </button>
                                <div id="staffActionMenu_${index}" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid var(--gray-light); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; z-index: 1000; margin-top: 0.25rem;">
                                    <button onclick="changeStaffRole(${index})" style="width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;" onmouseover="this.style.background='var(--gray-lighter)'" onmouseout="this.style.background='none'">
                                        <span>🔄</span> Change Role
                                    </button>
                                    <button onclick="removeStaffMember(${index})" style="width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: #e74c3c; transition: background 0.2s;" onmouseover="this.style.background='#fee'" onmouseout="this.style.background='none'">
                                        <span>🗑️</span> Remove
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <button class="btn btn-sm" style="padding: 0.25rem 0.5rem;" disabled>
                                <span style="font-size: 1.25rem;">⋮</span>
                            </button>
                        `}
                    </td>
                `;

                tbody.appendChild(tr);
            });
            
            // Update selected count
            updateSelectedCount();
        }
        
        function loadStaffLegacy() {
            // Fallback to old card-based display if needed
            const staff = NewcoData.get('staff') || [];
            const org = NewcoData.get("organization") || {};
            const staffList = document.getElementById('staffList');
            
            if (!staffList) return;
            
            staffList.innerHTML = '';
            
            if (org.email) {
                const adminCard = document.createElement('div');
                adminCard.className = 'content-section';
                adminCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${org.name || 'Super Admin'}</strong><br>
                            <small style="color: var(--gray);">${org.email}</small><br>
                            <span class="btn btn-primary" style="margin-top: 0.5rem; display: inline-block; cursor: default;">
                                SUPER ADMIN
                            </span>
                        </div>
                        <div style="color: var(--gray); font-size: 0.875rem;">
                            <em>Primary Administrator</em>
                        </div>
                    </div>
                `;
                staffList.appendChild(adminCard);
            }
            
            staff.forEach((member, index) => {
                const card = document.createElement('div');
                card.className = 'content-section';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${member.name}</strong><br>
                            <small style="color: var(--gray);">${member.email}</small><br>
                            <span class="btn btn-secondary" style="margin-top: 0.5rem; display: inline-block;">
                                ${member.role}
                            </span>
                        </div>
                        <button class="btn btn-danger" onclick="removeStaff(${index})">
                            Remove
                        </button>
                    </div>
                `;
                staffList.appendChild(card);
            });
        }
        
        function getColorForRole(role) {
            const colors = {
                'Admin': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'Manager': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'Marketing Manager': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'Caller': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'Floor Staff': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'Cashier': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'Security': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            };
            return colors[role] || 'linear-gradient(135deg, #ccc 0%, #999 100%)';
        }
        
        function getRoleTextColor(role) {
            const colors = {
                'Admin': '#6c5ce7',
                'Manager': '#e74c3c',
                'Marketing Manager': '#3498db',
                'Caller': '#27ae60',
                'Floor Staff': '#f39c12',
                'Cashier': '#95a5a6',
                'Security': '#34495e'
            };
            return colors[role] || '#7f8c8d';
        }
        
        function getStatusTextColor(status) {
            const colors = {
                'Active': '#27ae60',
                'Inactive': '#95a5a6',
                'On Leave': '#f39c12'
            };
            return colors[status] || '#7f8c8d';
        }
        
        function toggleStaffSelection(staffId) {
            if (selectedStaff.has(staffId)) {
                selectedStaff.delete(staffId);
            } else {
                selectedStaff.add(staffId);
            }
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const bulkActions = document.getElementById('bulkActionsBar');
            const countSpan = document.getElementById('selectedCount');

            if (!bulkActions || !countSpan) return;

            const count = selectedStaff.size;
            if (count > 0) {
                bulkActions.style.display = 'block';
                countSpan.textContent = `${count} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        function filterStaff() {
            const searchInput = document.getElementById('staffSearch');
            const roleFilter = document.getElementById('staffRoleFilter');
            const statusFilter = document.getElementById('staffStatusFilter');
            
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const roleValue = roleFilter ? roleFilter.value : '';
            const statusValue = statusFilter ? statusFilter.value : '';

            const allStaff = NewcoData.get('staff') || [];
            const org = NewcoData.get("organization") || {};

            const filtered = allStaff.filter(s => {
                // Filter out master admins
                if (s.role === 'master-admin') return false;

                const matchesSearch = !searchTerm ||
                    s.name.toLowerCase().includes(searchTerm) ||
                    s.email.toLowerCase().includes(searchTerm) ||
                    (s.role && s.role.toLowerCase().includes(searchTerm));

                const matchesRole = !roleValue || s.role === roleValue;
                const matchesStatus = !statusValue || (s.status || 'Active') === statusValue;

                return matchesSearch && matchesRole && matchesStatus;
            });
            
            loadStaffTable(filtered, org);
        }
        
        function sortStaff(column) {
            if (currentStaffSort.column === column) {
                currentStaffSort.direction = currentStaffSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentStaffSort.column = column;
                currentStaffSort.direction = 'asc';
            }

            const allStaff = NewcoData.get('staff') || [];
            // Filter out master admins before sorting
            const staff = allStaff.filter(s => s.role !== 'master-admin');
            const sorted = [...staff].sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (column === 'lastActive') {
                    aVal = a.lastActive ? new Date(a.lastActive).getTime() : 0;
                    bVal = b.lastActive ? new Date(b.lastActive).getTime() : 0;
                }
                
                if (currentStaffSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            const org = NewcoData.get("organization") || {};
            loadStaffTable(sorted, org);
        }
        
        function toggleAllStaff() {
            const checkboxes = document.querySelectorAll('#staffTableBody input[type="checkbox"]');
            const selectAll = document.getElementById('selectAllStaff');

            if (selectAll.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    const staffId = cb.getAttribute('data-staff-id');
                    if (staffId) selectedStaff.add(staffId);
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    const staffId = cb.getAttribute('data-staff-id');
                    if (staffId) selectedStaff.delete(staffId);
                });
            }
            updateSelectedCount();
        }

        function clearStaffSelection() {
            selectedStaff.clear();
            document.querySelectorAll('#staffTableBody input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            const selectAll = document.getElementById('selectAllStaff');
            if (selectAll) selectAll.checked = false;
            updateSelectedCount();
        }

        function bulkDeleteStaff() {
            if (selectedStaff.size === 0) return;

            showConfirm(
                `Are you sure you want to delete ${selectedStaff.size} staff member(s)?`,
                async () => {
                    const staff = NewcoData.get('staff') || [];
                    const toDelete = Array.from(selectedStaff);
                    const newStaff = staff.filter(s => !toDelete.includes(s.id));

                    try {
                        await NewcoData.set('staff', newStaff);

                        const userEmail = sessionStorage.getItem('newco_user_email');
                        logAction('delete', 'staff', `Bulk deleted ${toDelete.length} staff members`, userEmail);

                        selectedStaff.clear();
                        loadStaff();
                        showSuccess(`${toDelete.length} staff member(s) deleted`);
                    } catch (err) {
                        console.error('Failed to delete staff:', err);
                        showError('Failed to delete staff members: ' + err.message);
                    }
                },
                'Delete Staff Members'
            );
        }

        function bulkChangeRole() {
            if (selectedStaff.size === 0) return;

            // Get current user role for permission check
            const userEmail = sessionStorage.getItem('newco_user_email');
            const org = NewcoData.get("organization") || {};
            const staff = NewcoData.get('staff') || [];
            const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail?.toLowerCase());
            const currentUserRole = org.email && org.email.toLowerCase() === userEmail?.toLowerCase() ? 'super-admin' : (currentUser?.role || 'staff');

            // Create role selection modal
            const modal = document.getElementById('modal');
            if (!modal) {
                showError('Modal container not found');
                return;
            }

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2>Bulk Change Role</h2>
                        <button class="modal-close" onclick="closeModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Selected: <strong>${selectedStaff.size} staff member(s)</strong></label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Role</label>
                            <select class="form-select" id="bulkNewRoleSelect">
                                ${currentUserRole === 'super-admin' ? '<option value="admin">Admin</option>' : ''}
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmBulkRoleChange()">Change Role</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        async function confirmBulkRoleChange() {
            const newRole = document.getElementById('bulkNewRoleSelect').value;
            const staff = NewcoData.get('staff') || [];
            const userEmail = sessionStorage.getItem('newco_user_email');
            const org = NewcoData.get("organization") || {};
            const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail?.toLowerCase());
            const currentUserRole = org.email && org.email.toLowerCase() === userEmail?.toLowerCase() ? 'super-admin' : (currentUser?.role || 'staff');

            let updated = 0;
            const selectedIds = Array.from(selectedStaff);

            staff.forEach(s => {
                if (selectedIds.includes(s.id)) {
                    // Check permission for each member
                    if (canManageStaffMember(currentUserRole, s.role)) {
                        s.role = newRole;
                        updated++;
                    }
                }
            });

            if (updated > 0) {
                try {
                    await NewcoData.set('staff', staff);
                    logAction('update', 'staff', `Bulk changed role to ${newRole} for ${updated} staff members`, userEmail);
                    selectedStaff.clear();
                    closeModal();
                    loadStaff();
                    showSuccess(`Changed role for ${updated} staff member(s)`);
                } catch (err) {
                    console.error('Failed to update roles:', err);
                    showError('Failed to update roles: ' + err.message);
                }
            } else {
                closeModal();
                showError('No staff members were updated. Check permissions.');
            }
        }

        function bulkUpdateStatus(status) {
            const staff = NewcoData.get('staff') || [];
            let updated = 0;

            staff.forEach(s => {
                if (selectedStaff.has(s.id)) {
                    s.status = status;
                    updated++;
                }
            });

            if (updated > 0) {
                NewcoData.set('staff', staff);
                selectedStaff.clear();
                loadStaff();
                showSuccess(`Updated status for ${updated} staff member(s)`);
            }
        }

        function exportStaff() {
            const staff = NewcoData.get('staff') || [];
            const org = NewcoData.get("organization") || {};
            
            // Add super admin to export
            const exportData = [];
            if (org.email) {
                exportData.push({
                    name: org.name || 'Super Admin',
                    email: org.email,
                    role: 'SUPER ADMIN',
                    phone: org.phone || '',
                    status: 'Active'
                });
            }
            
            staff.forEach(s => {
                exportData.push({
                    name: s.name,
                    email: s.email,
                    role: s.role,
                    phone: s.phone || '',
                    status: s.status || 'Active',
                    lastActive: s.lastActive || ''
                });
            });
            
            // Convert to CSV
            const csv = [
                'Name,Email,Role,Phone,Status,Last Active',
                ...exportData.map(s => 
                    `"${s.name}","${s.email}","${s.role}","${s.phone}","${s.status}","${s.lastActive}"`
                )
            ].join('\n');
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `staff-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Staff data exported successfully');
        }
        
        function showStaffActions(index) {
            const staff = NewcoData.get('staff') || [];
            const member = staff[index];
            
            if (!member) return;
            
            // Show action menu or modal
            showAlert(`Actions for ${member.name}: Edit, Delete, Send Email, Reset Password`, 'Staff Actions');
        }

        function addStaffMember() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Staff Member';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="staffName" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="staffEmail" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="staffRole">
                        <option value="Admin">Admin</option>
                        <option value="Manager">Manager</option>
                        <option value="Marketing Manager">Marketing Manager</option>
                        <option value="Caller">Caller</option>
                        <option value="Floor Staff">Floor Staff</option>
                        <option value="Cashier">Cashier</option>
                        <option value="Security">Security</option>
                    </select>
                </div>
                
                <!-- Welcome Email Section -->
                <div style="border-top: 1px solid var(--gray-lighter); margin-top: 1.5rem; padding-top: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--primary-dark); font-size: 1rem;">📧 Welcome Email Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="sendWelcomeEmail" checked onchange="toggleWelcomeEmailOptions(this)">
                            Send welcome email to new staff member
                        </label>
                    </div>
                    
                    <div id="welcomeEmailOptions">
                        <div class="form-group">
                            <label class="form-label">Welcome Email Template</label>
                            <select class="form-select" id="welcomeEmailTemplate" onchange="updateWelcomePreview()">
                                <option value="standard">Standard Welcome</option>
                                <option value="admin">Admin Welcome (includes admin guide)</option>
                                <option value="floor">Floor Staff Welcome (includes schedule info)</option>
                                <option value="custom">Custom Message</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="customWelcomeGroup" style="display: none;">
                            <label class="form-label">Custom Welcome Message</label>
                            <textarea class="form-input" id="customWelcomeText" rows="4" placeholder="Welcome to our team! We're excited to have you join us..."></textarea>
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                                Available placeholders: {name}, {role}, {email}, {organization}, {loginUrl}
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="includeCredentials" checked>
                                Include login credentials in email
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="requirePasswordReset" checked>
                                Require password reset on first login
                            </label>
                        </div>
                        
                        <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="font-size: 0.875rem; color: var(--gray-dark); margin: 0 0 0.5rem 0;"><strong>Preview:</strong></p>
                            <div id="welcomeEmailPreview" style="font-size: 0.875rem; color: var(--gray);">
                                Subject: Welcome to Santa Clara Bingo!<br>
                                <br>
                                Dear {name},<br>
                                <br>
                                Welcome to Santa Clara Bingo! You've been added as a {role}.<br>
                                <br>
                                Your login credentials will be sent in a separate email.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modalSaveBtn.onclick = async () => {
                const staff = NewcoData.get('staff') || [];
                const newMember = {
                    id: Date.now().toString(),
                    name: document.getElementById('staffName').value,
                    email: document.getElementById('staffEmail').value,
                    role: document.getElementById('staffRole').value,
                    status: 'Active',
                    lastActive: null,
                    sendWelcomeEmail: document.getElementById('sendWelcomeEmail').checked,
                    welcomeEmailTemplate: document.getElementById('sendWelcomeEmail').checked ?
                        document.getElementById('welcomeEmailTemplate').value : null,
                    customWelcomeText: document.getElementById('welcomeEmailTemplate').value === 'custom' ?
                        document.getElementById('customWelcomeText').value : null,
                    includeCredentials: document.getElementById('includeCredentials').checked,
                    requirePasswordReset: document.getElementById('requirePasswordReset').checked
                };

                staff.push(newMember);

                try {
                    await NewcoData.set('staff', staff);

                    // Simulate sending welcome email
                    if (newMember.sendWelcomeEmail) {
                        setTimeout(() => {
                            showSuccess(`Welcome email sent to ${newMember.email}`);
                        }, 1000);
                    }

                    closeModal();
                    loadStaff();
                    showSuccess(`Staff member "${newMember.name}" added successfully`);
                } catch (err) {
                    console.error('Failed to save staff:', err);
                    showError('Failed to save staff member: ' + err.message);
                }
            };
            
            modal.classList.add('active');
        }

        function removeStaff(index) {
            showConfirm(
                'Are you sure you want to remove this staff member?',
                () => {
                    const staff = NewcoData.get('staff') || [];
                    staff.splice(index, 1);
                    NewcoData.set('staff', staff);
                    loadStaff();
                    showSuccess('Staff member removed successfully');
                },
                'Remove Staff Member'
            );
        }

        // Log action to actions log
        function logAction(actionType, section, details, userEmail = null) {
            try {
                const actionsLog = NewcoData.get('actionsLog') || [];
                const currentUser = userEmail || sessionStorage.getItem('newco_user_email') || sessionStorage.getItem('newco_current_user') || 'Admin';

                const action = {
                    id: 'action_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    user: currentUser,
                    actionType: actionType,
                    section: section,
                    details: details
                };

                actionsLog.unshift(action);

                // Keep only last 1000 actions
                if (actionsLog.length > 1000) {
                    actionsLog.splice(1000);
                }

                NewcoData.set('actionsLog', actionsLog);
            } catch (e) {
                console.error('Error logging action:', e);
            }
        }

        // Permission check function
        function canManageStaffMember(currentUserRole, targetRole) {
            // Role hierarchy: super-admin > admin > staff/manager
            const roleHierarchy = {
                'super-admin': 3,
                'admin': 2,
                'manager': 1,
                'staff': 1
            };

            const currentLevel = roleHierarchy[currentUserRole] || 0;
            const targetLevel = roleHierarchy[targetRole] || 0;

            // Super admin can manage everyone
            if (currentUserRole === 'super-admin') return true;

            // Admin can manage anyone with lower role (not super-admin)
            if (currentUserRole === 'admin' && targetLevel < currentLevel) return true;

            return false;
        }

        // Toggle staff action menu
        function toggleStaffActionMenu(index, event) {
            event.stopPropagation();

            // Close all other menus first
            document.querySelectorAll('[id^="staffActionMenu_"]').forEach(menu => {
                if (menu.id !== `staffActionMenu_${index}`) {
                    menu.style.display = 'none';
                }
            });

            const menu = document.getElementById(`staffActionMenu_${index}`);
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('[id^="staffActionMenu_"]').forEach(menu => {
                menu.style.display = 'none';
            });
        });

        // Change staff role
        async function changeStaffRole(index) {
            const staff = NewcoData.get('staff') || [];
            const member = staff[index];

            if (!member) {
                showError('Staff member not found');
                return;
            }

            // Get current user role
            const userEmail = sessionStorage.getItem('newco_user_email');
            const org = NewcoData.get("organization") || {};
            const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail?.toLowerCase());
            const currentUserRole = org.email && org.email.toLowerCase() === userEmail?.toLowerCase() ? 'super-admin' : (currentUser?.role || 'staff');

            // Check permissions
            if (!canManageStaffMember(currentUserRole, member.role)) {
                showError('You do not have permission to change this user\'s role');
                return;
            }

            // Close menu
            const menuEl = document.getElementById(`staffActionMenu_${index}`);
            if (menuEl) menuEl.style.display = 'none';

            // Create role selection modal
            const modal = document.getElementById('modal');
            if (!modal) {
                showError('Modal container not found');
                return;
            }
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2>Change Role - ${member.name}</h2>
                        <button class="modal-close" onclick="closeModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Current Role: <strong>${member.role}</strong></label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Role</label>
                            <select class="form-select" id="newRoleSelect">
                                ${currentUserRole === 'super-admin' ? '<option value="admin">Admin</option>' : ''}
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmRoleChange(${index})">Change Role</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        // Confirm role change
        async function confirmRoleChange(index) {
            const newRole = document.getElementById('newRoleSelect').value;
            const staff = NewcoData.get('staff') || [];
            const member = staff[index];

            if (!member) {
                showError('Staff member not found');
                return;
            }

            const oldRole = member.role;
            member.role = newRole;

            try {
                await NewcoData.set('staff', staff);

                // Log the action
                const userEmail = sessionStorage.getItem('newco_user_email');
                logAction('update', 'staff', `Changed role for ${member.name} from ${oldRole} to ${newRole}`, userEmail);

                closeModal();
                loadStaff();
                showSuccess(`Role changed successfully for ${member.name}`);
            } catch (err) {
                console.error('Failed to update role:', err);
                showError('Failed to update role: ' + err.message);
            }
        }

        // Remove staff member with permissions
        async function removeStaffMember(index) {
            const staff = NewcoData.get('staff') || [];
            const member = staff[index];

            if (!member) {
                showError('Staff member not found');
                return;
            }

            // Get current user role
            const userEmail = sessionStorage.getItem('newco_user_email');
            const org = NewcoData.get("organization") || {};
            const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail?.toLowerCase());
            const currentUserRole = org.email && org.email.toLowerCase() === userEmail?.toLowerCase() ? 'super-admin' : (currentUser?.role || 'staff');

            // Check permissions
            if (!canManageStaffMember(currentUserRole, member.role)) {
                showError('You do not have permission to remove this user');
                return;
            }

            // Close menu
            document.getElementById(`staffActionMenu_${index}`).style.display = 'none';

            // Confirm and remove
            showConfirm(
                `Are you sure you want to remove ${member.name} (${member.role})?`,
                async () => {
                    staff.splice(index, 1);

                    try {
                        await NewcoData.set('staff', staff);

                        // Log the action
                        logAction('delete', 'staff', `Removed staff member: ${member.name} (${member.role})`, userEmail);

                        loadStaff();
                        showSuccess(`${member.name} has been removed`);
                    } catch (err) {
                        console.error('Failed to remove staff:', err);
                        showError('Failed to remove staff member: ' + err.message);
                    }
                },
                'Remove Staff Member'
            );
        }

        // Package Management Functions
        function loadPackages() {
            const packages = NewcoData.get('packages') || [];
            const salesItems = NewcoData.get('salesItems') || [];
            const container = document.getElementById('packagesContainer');
            
            if (packages.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No packages created yet. Click "Add Package" to create your first package.</p>';
                return;
            }
            
            let html = '<div class="packages-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">';
            
            packages.forEach((pkg, index) => {
                const items = pkg.items || [];
                const itemsHtml = items.map(item => {
                    // Handle new schema: items are objects with {itemId, itemName, quantity}
                    if (typeof item === 'object' && item !== null) {
                        if (item.itemName) {
                            return `• ${item.itemName}${item.quantity > 1 ? ' x' + item.quantity : ''}`;
                        }
                        // Handle case where item is an object but missing itemName
                        if (item.itemId) {
                            const salesItem = salesItems.find(si => si.id === item.itemId);
                            return salesItem ? `• ${salesItem.name}${item.quantity > 1 ? ' x' + item.quantity : ''}` : `• Unknown item`;
                        }
                        // Object without expected properties
                        return `• [Invalid item]`;
                    }
                    // Legacy support: items are strings (item IDs or 'custom')
                    if (typeof item === 'string') {
                        if (item === 'custom') {
                            return pkg.customLineText ? `• ${pkg.customLineText}` : '• Custom selection';
                        }
                        const salesItem = salesItems.find(si => si.id === item);
                        return salesItem ? `• ${salesItem.name}` : `• ${item}`;
                    }
                    return `• [Unknown format]`;
                }).join('<br>');
                

                // Build image preview based on style
                let imagePreviewHtml = '';
                if (pkg.imageUrl) {
                    if (pkg.imageStyle === 'banner') {
                        imagePreviewHtml = `
                            <div style="width: 100%; height: 100px; overflow: hidden; margin-bottom: 1rem; border-radius: 8px; border: 1px solid var(--gray-light);">
                                <img src="${pkg.imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">📐 Banner Style</div>
                        `;
                    } else if (pkg.imageStyle === 'background') {
                        imagePreviewHtml = `
                            <div style="position: relative; width: 100%; height: 80px; overflow: hidden; margin-bottom: 1rem; border-radius: 8px; border: 1px solid var(--gray-light);">
                                <div style="position: absolute; inset: 0; background-image: url('${pkg.imageUrl}'); background-size: cover; background-position: center; opacity: 0.3;"></div>
                                <div style="position: relative; z-index: 1; display: flex; align-items: center; justify-content: center; height: 100%; font-weight: bold; color: var(--gray-dark);">Sample Text</div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">📐 Background Style</div>
                        `;
                    } else {
                        // thumbnail
                        imagePreviewHtml = `
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.5rem; background: var(--light-gray); border-radius: 6px;">
                                <img src="${pkg.imageUrl}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid var(--gray-light);">
                                <div style="font-size: 0.75rem; color: var(--gray);">📐 Thumbnail Style</div>
                            </div>
                        `;
                    }
                }

                html += `
                    <div class="package-card" style="background: white; border: 2px solid var(--gray-light); border-radius: 12px; padding: 1.5rem; position: relative;">
                        ${pkg.bestValue ? '<span style="position: absolute; top: -10px; right: 10px; background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">Best Value!</span>' : ''}
                        ${imagePreviewHtml}
                        <h3 style="margin: 0 0 0.5rem 0;">${pkg.name}</h3>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.5rem; font-weight: bold; color: var(--admin-primary);">$${pkg.price}</span>
                            ${pkg.canBuyWithLoyalty ? `<span style="color: var(--secondary);">or ${pkg.loyaltyPointsCost || 0} pts</span>` : ''}
                        </div>
                        ${pkg.givesBonus ? `<div style="font-size: 0.875rem; color: var(--warning); margin-bottom: 0.5rem;">🎁 Bonus: ${pkg.bonusType === 'fixed' ? `+${pkg.bonusFixed} pts` : `${pkg.bonusMultiplier}x points`}</div>` : ''}
                        <div style="font-size: 0.875rem; color: var(--gray-dark); margin-bottom: 1rem;">
                            ${itemsHtml || 'No items added'}
                        </div>
                        ${pkg.seatSelection ? '<div style="font-size: 0.875rem; color: var(--admin-primary);">✓ Seat Selection: On</div>' : '<div style="font-size: 0.875rem; color: var(--gray);">Seat Selection: Off</div>'}
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="editPackage(${index})" style="flex: 1;">Edit</button>
                            <button class="btn btn-danger" onclick="deletePackage(${index})" style="flex: 1;">Delete</button>
                            ${index > 0 ? `<button class="btn btn-secondary" onclick="movePackage(${index}, -1)">↑</button>` : ''}
                            ${index < packages.length - 1 ? `<button class="btn btn-secondary" onclick="movePackage(${index}, 1)">↓</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;

            // Update button states after loading
            updateExampleButtonStates();
        }

        function addPackage() {
            const salesItems = NewcoData.get('salesItems') || [];
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Package';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Package Name</label>
                    <input type="text" class="form-input" id="packageName" placeholder="e.g., Premium Package">
                </div>

                <!-- Art/Image Section -->
                <div style="border: 1px solid var(--gray-light); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--light-gray);">
                    <h4 style="margin: 0 0 0.75rem 0; color: var(--primary-dark); font-size: 0.95rem;">🎨 Package Image (Optional)</h4>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="openArtLibraryForPackage()" style="width: 100%;">
                            📚 Choose from Art Library
                        </button>
                    </div>
                    <div id="packageImagePreview" style="margin-top: 0.5rem; display: none;">
                        <img id="packageImagePreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid var(--primary);">
                        <button type="button" class="btn btn-danger btn-small" onclick="clearPackageImage()" style="margin-top: 0.5rem; width: 100%;">Remove Image</button>
                    </div>
                    <div class="form-group" style="margin-top: 0.75rem;">
                        <label class="form-label">Image Display Style</label>
                        <select class="form-select" id="packageImageStyle">
                            <option value="thumbnail">Thumbnail (small image next to name)</option>
                            <option value="banner">Banner (wide image above package)</option>
                            <option value="background">Background (image fills card)</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-input" id="packagePrice" min="0" step="0.01" placeholder="25.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="packageCanBuyWithPoints" onchange="togglePackageLoyaltyPoints(this)"> Can buy with loyalty points
                        </label>
                    </div>
                </div>
                <div class="form-group" id="packageLoyaltyPointsCostGroup" style="display: none;">
                    <label class="form-label">Loyalty Points Cost</label>
                    <input type="number" class="form-input" id="packagePointsCost" min="0" placeholder="250">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="packageGivesBonus" onchange="togglePackageBonusPoints(this)"> Gives bonus loyalty points
                    </label>
                </div>
                <div class="form-grid" id="packageBonusPointsGroup" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Bonus Type</label>
                        <select class="form-select" id="packageBonusType" onchange="togglePackageBonusType(this)">
                            <option value="fixed">Fixed Amount</option>
                            <option value="multiplier">Multiplier</option>
                        </select>
                    </div>
                    <div class="form-group" id="packageFixedBonusGroup">
                        <label class="form-label">Bonus Points</label>
                        <input type="number" class="form-input" id="packageBonusFixed" min="0" placeholder="20">
                    </div>
                    <div class="form-group" id="packageMultiplierBonusGroup" style="display: none;">
                        <label class="form-label">Points Multiplier (e.g., 2 for double)</label>
                        <input type="number" class="form-input" id="packageBonusMultiplier" min="1" step="0.5" placeholder="2">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="packageBestValue"> Mark as Best Value
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="packageSeatSelection"> Include Seat Selection
                    </label>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Display Order #</label>
                        <input type="number" class="form-input" id="packageDisplayOrder" min="1" placeholder="1" value="${(NewcoData.get('packages') || []).length + 1}">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Order shown on website</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Limit Per Customer</label>
                        <input type="number" class="form-input" id="packageLimitPerCustomer" min="0" placeholder="0">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">0 = unlimited</p>
                    </div>
                </div>
                <!-- Availability Settings -->
                <div style="border-top: 1px solid var(--gray-light); margin-top: 1.5rem; padding-top: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--primary-dark);">📅 Availability Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Available Days</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <label><input type="checkbox" class="day-checkbox" value="Monday"> Monday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Tuesday"> Tuesday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Wednesday"> Wednesday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Thursday"> Thursday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Friday"> Friday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Saturday"> Saturday</label>
                            <label><input type="checkbox" class="day-checkbox" value="Sunday"> Sunday</label>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Check days to LIMIT availability. Leave all unchecked for everyday availability.</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Specific Date Only (Optional)</label>
                        <input type="date" class="form-input" id="packageSpecificDate">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Use for special events or one-time offerings</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Package Items</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-light); border-radius: 8px; padding: 0.5rem;">
                        <label style="display: block; padding: 0.5rem; border-bottom: 1px solid var(--gray-lighter);">
                            <input type="checkbox" id="packageCustomLine" value="custom" onchange="toggleCustomLineInput(this)"> Custom Selection Line
                        </label>
                        <div id="customLineInputGroup" style="display: none; padding: 0.5rem; background: var(--gray-lighter); margin-bottom: 0.5rem;">
                            <input type="text" class="form-input" id="packageCustomLineText" placeholder="Enter custom line text (e.g., '2 Special Game Cards')" style="width: 100%;">
                        </div>
                        ${salesItems.map(item => `
                            <label style="display: block; padding: 0.5rem;">
                                <input type="checkbox" class="package-item-checkbox" value="${item.id}"> ${item.name} - $${item.price}
                            </label>
                        `).join('')}
                        ${salesItems.length === 0 ? '<p style="color: var(--gray); margin: 0.5rem;">No sales items available. Create items first.</p>' : ''}
                    </div>
                </div>
            `;
            
            // Add helper functions for toggling
            window.togglePackageLoyaltyPoints = function(checkbox) {
                document.getElementById('packageLoyaltyPointsCostGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.togglePackageBonusPoints = function(checkbox) {
                document.getElementById('packageBonusPointsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.togglePackageBonusType = function(select) {
                document.getElementById('packageFixedBonusGroup').style.display = select.value === 'fixed' ? 'block' : 'none';
                document.getElementById('packageMultiplierBonusGroup').style.display = select.value === 'multiplier' ? 'block' : 'none';
            };
            
            window.toggleCustomLineInput = function(checkbox) {
                document.getElementById('customLineInputGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            
            modalSaveBtn.onclick = () => {
                const salesItems = NewcoData.get('salesItems') || [];
                const selectedItems = [];
                modalBody.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    if (cb.id !== 'packageBestValue' && cb.id !== 'packageSeatSelection' && !cb.classList.contains('day-checkbox')) {
                        // Create proper object structure with itemId, itemName, quantity
                        const salesItem = salesItems.find(si => si.id === cb.value);
                        if (salesItem) {
                            selectedItems.push({
                                itemId: cb.value,
                                itemName: salesItem.name,
                                quantity: 1
                            });
                        } else if (cb.value === 'custom') {
                            selectedItems.push({
                                itemId: 'custom',
                                itemName: document.getElementById('packageCustomLineText')?.value || 'Custom selection',
                                quantity: 1
                            });
                        }
                    }
                });

                    const packages = NewcoData.get('packages') || [];
                    const packageId = Date.now().toString();
                    
                    
                    // Handle custom line text
                    const hasCustomLine = document.getElementById('packageCustomLine').checked;
                    const customLineText = hasCustomLine ? document.getElementById('packageCustomLineText').value : null;
                    
                    // Get selected days
                    const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                        .map(cb => cb.value.toLowerCase());

                    const newPackage = {
                        id: packageId,
                        name: document.getElementById('packageName').value,
                        price: parseFloat(document.getElementById('packagePrice').value) || 0,
                        canBuyWithLoyalty: document.getElementById('packageCanBuyWithPoints').checked,
                        loyaltyPointsCost: document.getElementById('packageCanBuyWithPoints').checked ?
                            parseInt(document.getElementById('packagePointsCost').value) || 0 : null,
                        givesBonus: document.getElementById('packageGivesBonus').checked,
                        bonusType: document.getElementById('packageGivesBonus').checked ?
                            document.getElementById('packageBonusType').value : null,
                        bonusFixed: document.getElementById('packageGivesBonus').checked && document.getElementById('packageBonusType').value === 'fixed' ?
                            parseInt(document.getElementById('packageBonusFixed').value) || 0 : null,
                        bonusMultiplier: document.getElementById('packageGivesBonus').checked && document.getElementById('packageBonusType').value === 'multiplier' ?
                            parseFloat(document.getElementById('packageBonusMultiplier').value) || 1 : null,
                        bestValue: document.getElementById('packageBestValue').checked,
                        seatSelection: document.getElementById('packageSeatSelection').checked,
                        displayOrder: parseInt(document.getElementById('packageDisplayOrder').value) || packages.length + 1,
                        limitPerCustomer: parseInt(document.getElementById('packageLimitPerCustomer').value) || 0,
                        items: selectedItems,
                        customLineText: customLineText,
                        validDays: selectedDays.length > 0 ? selectedDays : null,
                        dateEligibility: document.getElementById('packageSpecificDate').value || null,
                        order: packages.length,
                        // Image fields
                        imageUrl: window.tempPackageImageUrl || null,
                        imageArtId: window.tempPackageArtId || null,
                        imageStyle: document.getElementById('packageImageStyle').value || 'thumbnail'
                    };
                    
                    packages.push(newPackage);
                    
                    try {
                        NewcoData.set('packages', packages);
                    } catch (e) {
                        console.warn('Could not save to localStorage, keeping in memory:', e);
                        window.tempPackages = packages;
                    }
                    
                    closeModal();
                    loadPackages();
                    showSuccess(`Package "${newPackage.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }

        // Package art library functions
        function openArtLibraryForPackage() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            if (typeof ArtPicker !== 'undefined' && typeof ArtPicker.open === 'function') {
                ArtPicker.open((selectedArt) => {
                    window.tempPackageArtId = selectedArt.id;
                    window.tempPackageImageUrl = selectedArt.file_data;

                    const preview = document.getElementById('packageImagePreview');
                    const previewImg = document.getElementById('packageImagePreviewImg');

                    if (preview && previewImg) {
                        previewImg.src = selectedArt.file_data;
                        preview.style.display = 'block';
                    }
                }, customerId);
            } else {
                showError('Art library not available. Please ensure art-picker.js is loaded.');
            }
        }

        function clearPackageImage() {
            window.tempPackageArtId = null;
            window.tempPackageImageUrl = null;

            const preview = document.getElementById('packageImagePreview');
            if (preview) {
                preview.style.display = 'none';
            }
        }

        function editPackage(index) {
            const packages = NewcoData.get('packages') || [];
            const pkg = packages[index];
            if (!pkg) return;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            // Copy the form from addPackage
            modalTitle.textContent = 'Edit Package';
            
            // Get the form HTML from addPackage function
            addPackage();
            
            // Change title to Edit
            setTimeout(() => {
                document.getElementById('modalTitle').textContent = 'Edit Package';
            }, 10);
            
            // Pre-fill values after a short delay
            setTimeout(() => {
                document.getElementById('packageName').value = pkg.name || '';
                document.getElementById('packagePrice').value = pkg.price || '';
                
                // Handle loyalty points option
                const canBuyWithPoints = document.getElementById('packageCanBuyWithPoints');
                const pointsCost = document.getElementById('packagePointsCost');
                if (canBuyWithPoints && pkg.canBuyWithLoyalty) {
                    canBuyWithPoints.checked = true;
                    document.getElementById('packageLoyaltyPointsCostGroup').style.display = 'block';
                    if (pointsCost) {
                        pointsCost.value = pkg.loyaltyPointsCost || '';
                    }
                }
                
                // Check the included items
                if (pkg.items && pkg.items.length > 0) {
                    const salesItems = NewcoData.get('salesItems') || [];
                    const checkboxes = document.querySelectorAll('.package-item-checkbox');

                    checkboxes.forEach(checkbox => {
                        // Get the sales item for this checkbox
                        const salesItem = salesItems.find(si => si.id === checkbox.value);
                        if (!salesItem) return;

                        // Handle new schema: items are objects with {itemId, itemName, quantity}
                        const hasItem = pkg.items.some(item => {
                            if (typeof item === 'object' && item.itemName) {
                                // Match by name (handles quantity variations like "Strip Pack x2")
                                const baseName = item.itemName.replace(/ x\d+$/, ''); // Remove " x2" suffix
                                return baseName === salesItem.name || item.itemName === salesItem.name;
                            }
                            // Legacy: items are strings (IDs)
                            return item === checkbox.value;
                        });

                        if (hasItem) {
                            checkbox.checked = true;
                        }
                    });

                    // Handle custom line
                    const hasCustom = pkg.items.some(item =>
                        (typeof item === 'object' && item.itemId === 'custom') || item === 'custom'
                    );
                    if (hasCustom && pkg.customLineText) {
                        document.getElementById('packageCustomLine').checked = true;
                        document.getElementById('customLineInputGroup').style.display = 'block';
                        document.getElementById('packageCustomLineText').value = pkg.customLineText;
                    }
                }
                
                // Handle Best Value
                if (pkg.bestValue) {
                    document.getElementById('packageBestValue').checked = true;
                }
                
                // Handle Seat Selection
                if (pkg.seatSelection) {
                    document.getElementById('packageSeatSelection').checked = true;
                }
                
                // Handle bonus points
                if (pkg.givesBonus) {
                    document.getElementById('packageGivesBonus').checked = true;
                    document.getElementById('packageBonusPointsGroup').style.display = 'block';
                    document.getElementById('packageBonusType').value = pkg.bonusType || 'fixed';
                    if (pkg.bonusType === 'multiplier') {
                        document.getElementById('packageMultiplierBonusGroup').style.display = 'block';
                        document.getElementById('packageFixedBonusGroup').style.display = 'none';
                        document.getElementById('packageBonusMultiplier').value = pkg.bonusMultiplier || 2;
                    } else {
                        document.getElementById('packageBonusFixed').value = pkg.bonusFixed || 0;
                    }
                }
                
                // Handle other fields
                document.getElementById('packageLimitPerCustomer').value = pkg.limitPerCustomer || 0;
                document.getElementById('packageDisplayOrder').value = pkg.displayOrder || index + 1;

                // Handle day eligibility
                if (pkg.dayEligibility && pkg.dayEligibility.length > 0) {
                    const dayCheckboxes = document.querySelectorAll('.day-checkbox');
                    dayCheckboxes.forEach(checkbox => {
                        if (pkg.dayEligibility.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                }

                // Handle specific date eligibility
                if (pkg.dateEligibility) {
                    const specificDateInput = document.getElementById('packageSpecificDate');
                    if (specificDateInput) {
                        specificDateInput.value = pkg.dateEligibility;
                    }
                }

                // Load existing image
                if (pkg.imageUrl) {
                    window.tempPackageArtId = pkg.imageArtId || null;
                    window.tempPackageImageUrl = pkg.imageUrl;

                    const preview = document.getElementById('packageImagePreview');
                    const previewImg = document.getElementById('packageImagePreviewImg');
                    const styleSelect = document.getElementById('packageImageStyle');

                    if (preview && previewImg) {
                        previewImg.src = pkg.imageUrl;
                        preview.style.display = 'block';
                    }

                    if (styleSelect && pkg.imageStyle) {
                        styleSelect.value = pkg.imageStyle;
                    }
                }

                }, 100);
                
                // Override save function to update instead of create - with delay to ensure it works
                setTimeout(() => {
                    const modalSaveBtn = document.getElementById('modalSaveBtn');
                    modalSaveBtn.onclick = () => {
                    const bannerFileInput = document.getElementById('packageBannerArt');
                    const backgroundFileInput = document.getElementById('packageBackgroundArt');
                    const bannerFile = bannerFileInput ? bannerFileInput.files[0] : null;
                    const backgroundFile = backgroundFileInput ? backgroundFileInput.files[0] : null;
                    let bannerArtData = null;
                    let backgroundArtData = null;
                    let pendingUploads = 0;
                    
                    function checkAndSave() {
                        if (pendingUploads === 0) {
                            updatePackage();
                        }
                    }
                    
                    if (bannerFile) {
                        pendingUploads++;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            bannerArtData = e.target.result;
                            pendingUploads--;
                            checkAndSave();
                        };
                        reader.readAsDataURL(bannerFile);
                    }
                    
                    if (backgroundFile) {
                        pendingUploads++;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            backgroundArtData = e.target.result;
                            pendingUploads--;
                            checkAndSave();
                        };
                        reader.readAsDataURL(backgroundFile);
                    }
                    
                    if (pendingUploads === 0) {
                        checkAndSave();
                    }
                    
                    function updatePackage() {
                        // Rebuild items based on checked boxes, preserving quantities from original
                        const salesItems = NewcoData.get('salesItems') || [];
                        const updatedItems = [];

                        // Check if package uses new schema
                        const usesNewSchema = pkg.items && pkg.items.length > 0 &&
                            typeof pkg.items[0] === 'object' && pkg.items[0].itemId;

                        if (usesNewSchema) {
                            // New schema: rebuild items array matching checked boxes with original quantities
                            const checkboxes = document.querySelectorAll('.package-item-checkbox:checked');
                            checkboxes.forEach(cb => {
                                const salesItem = salesItems.find(si => si.id === cb.value);
                                if (salesItem) {
                                    // Find original item to preserve quantity
                                    const originalItem = pkg.items.find(item => {
                                        if (typeof item === 'object' && item.itemName) {
                                            const baseName = item.itemName.replace(/ x\d+$/, '');
                                            return baseName === salesItem.name || item.itemName === salesItem.name;
                                        }
                                        return false;
                                    });

                                    // Use original quantity if found, otherwise default to 1
                                    const quantity = originalItem ? originalItem.quantity : 1;

                                    updatedItems.push({
                                        itemId: cb.value, // Use the actual salesItem ID from checkbox
                                        itemName: salesItem.name,
                                        quantity: quantity
                                    });
                                }
                            });

                            // Check for custom line
                            if (document.getElementById('packageCustomLine').checked) {
                                updatedItems.push({
                                    itemId: 'custom',
                                    itemName: document.getElementById('packageCustomLineText').value || 'Custom',
                                    quantity: 1
                                });
                            }
                        } else {
                            // Legacy mode: collect item IDs as strings
                            const checkboxes = document.querySelectorAll('.package-item-checkbox:checked');
                            checkboxes.forEach(cb => updatedItems.push(cb.value));

                            // Check for custom line
                            if (document.getElementById('packageCustomLine').checked) {
                                updatedItems.push('custom');
                            }
                        }

                        // Get selected days
                        const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                            .map(cb => cb.value.toLowerCase());

                        // Update the package
                        packages[index] = {
                            id: pkg.id,
                            name: document.getElementById('packageName').value,
                            price: parseFloat(document.getElementById('packagePrice').value) || 0,
                            canBuyWithLoyalty: document.getElementById('packageCanBuyWithPoints').checked,
                            loyaltyPointsCost: document.getElementById('packageCanBuyWithPoints').checked ?
                                parseInt(document.getElementById('packagePointsCost').value) || 0 : null,
                            givesBonus: document.getElementById('packageGivesBonus').checked,
                            bonusType: document.getElementById('packageGivesBonus').checked ?
                                document.getElementById('packageBonusType').value : null,
                            bonusFixed: document.getElementById('packageBonusType')?.value === 'fixed' ?
                                parseInt(document.getElementById('packageBonusFixed').value) || 0 : null,
                            bonusMultiplier: document.getElementById('packageBonusType')?.value === 'multiplier' ?
                                parseFloat(document.getElementById('packageBonusMultiplier').value) || 1 : null,
                            bestValue: document.getElementById('packageBestValue').checked,
                            seatSelection: document.getElementById('packageSeatSelection').checked,
                            items: updatedItems,
                            customLineText: document.getElementById('packageCustomLine').checked ?
                                document.getElementById('packageCustomLineText').value : null,
                            limitPerCustomer: parseInt(document.getElementById('packageLimitPerCustomer').value) || 0,
                            displayOrder: parseInt(document.getElementById('packageDisplayOrder').value) || index + 1,
                            validDays: selectedDays.length > 0 ? selectedDays : null,
                            dateEligibility: document.getElementById('packageSpecificDate').value || null,
                            hasDateRestrictions: pkg.hasDateRestrictions || false,
                            availableDays: pkg.availableDays || [],
                            validFrom: pkg.validFrom || null,
                            validUntil: pkg.validUntil || null,
                            specialEventsOnly: pkg.specialEventsOnly || false,
                            category: pkg.category,
                            description: pkg.description,
                            // Image fields
                            imageUrl: window.tempPackageImageUrl || null,
                            imageArtId: window.tempPackageArtId || null,
                            imageStyle: document.getElementById('packageImageStyle')?.value || 'thumbnail'
                        };
                        
                        NewcoData.set('packages', packages);
                        
                        // Clear selected art
                        window.selectedPackageBannerArt = null;
                        window.selectedPackageBackgroundArt = null;
                        
                        console.log('Closing modal after package update...');
                        closeModal();
                        loadPackages();
                        showSuccess(`Package "${packages[index].name}" updated successfully`);
                    }
                    };
                }, 200); // Longer delay to ensure the override takes effect
        }
        
        function deletePackage(index) {
            showConfirm(
                'Are you sure you want to delete this package?',
                () => {
                    const packages = NewcoData.get('packages') || [];
                    console.log('Before delete:', packages.length, 'packages');
                    const deleted = packages.splice(index, 1)[0];
                    console.log('After delete:', packages.length, 'packages');
                    NewcoData.set('packages', packages);
                    console.log('Saved to localStorage. New count:', NewcoData.get('packages').length);
                    loadPackages();
                    showSuccess(`Package "${deleted.name}" deleted successfully`);
                },
                'Delete Package'
            );
        }
        
        function clearAllPackages() {
            showConfirm(
                'This will delete ALL packages. Are you sure?',
                () => {
                    NewcoData.set('packages', []);
                    localStorage.removeItem('newco_packages');
                    console.log('All packages cleared');
                    loadPackages();
                    showSuccess('All packages have been deleted');
                },
                'Clear All Packages'
            );
        }
        
        function movePackage(index, direction) {
            const packages = NewcoData.get('packages') || [];
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < packages.length) {
                [packages[index], packages[newIndex]] = [packages[newIndex], packages[index]];
                packages.forEach((pkg, i) => pkg.order = i);
                NewcoData.set('packages', packages);
                loadPackages();
            }
        }
        
        // Package art selection functions
        function selectPackageBannerArt() {
            showArtSelector((artData) => { 
                window.selectedPackageBannerArt = artData; 
                const elem = document.getElementById('packageBannerArtSelected'); 
                if (elem) {
                    if (artData && artData.startsWith('data:')) {
                        elem.innerHTML = `<img src='${artData}' style='max-width: 200px; max-height: 100px; border-radius: 8px; margin-top: 0.5rem;'>`;
                    } else {
                        elem.textContent = 'Banner art selected';
                    }
                }
            });
        }

        function selectPackageBackgroundArt() {
            showArtSelector((artData) => { 
                window.selectedPackageBackgroundArt = artData; 
                const elem = document.getElementById('packageBackgroundArtSelected'); 
                if (elem) {
                    if (artData && artData.startsWith('data:')) {
                        elem.innerHTML = `<img src='${artData}' style='max-width: 200px; max-height: 120px; border-radius: 8px; margin-top: 0.5rem;'>`;
                    } else {
                        elem.textContent = 'Background art selected';
                    }
                }
            });
        }
        
        // Marketing Management Functions
        function loadMarketing() {
            loadCarouselManager();
            loadNotificationCardsManager();
            loadSocialMediaConfig();
            loadTextUpdatesConfig();
            loadBirthdayOffer();
            loadWelcomePopupSettings();
            loadActivePromotions();
        }

        // ===== CAROUSEL MANAGER =====
        function loadCarouselManager() {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            const enabled = marketingConfig.carouselEnabled !== false;

            document.getElementById('enableCarousel').checked = enabled;
            renderCarouselSlidesList();
        }

        function toggleCarousel() {
            const enabled = document.getElementById('enableCarousel').checked;
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            marketingConfig.carouselEnabled = enabled;
            NewcoData.set('marketingConfig', marketingConfig);
            notify.success(enabled ? 'Carousel enabled' : 'Carousel disabled');
        }

        function renderCarouselSlidesList() {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            const slides = marketingConfig.carouselSlides || [];
            const container = document.getElementById('carouselSlidesList');

            if (slides.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">No slides configured. Dynamic slides will be shown automatically.</p>';
                return;
            }

            container.innerHTML = slides.map((slide, index) => `
                <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid ${slide.enabled !== false ? '#6c5ce7' : '#ccc'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <strong>${slide.title || 'Untitled Slide'}</strong>
                                ${slide.type === 'dynamic' ? '<span style="background: #667eea; color: white; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">DYNAMIC</span>' : ''}
                                ${slide.enabled === false ? '<span style="background: #ccc; color: white; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">DISABLED</span>' : ''}
                            </div>
                            <div style="color: #666; font-size: 0.875rem;">${slide.subtitle || 'No subtitle'}</div>
                            <div style="color: #999; font-size: 0.75rem; margin-top: 0.25rem;">Duration: ${(slide.duration || 5000) / 1000}s</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editCarouselSlide(${index})" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Edit</button>
                            ${slide.type === 'custom' ? `<button onclick="deleteCarouselSlide(${index})" class="btn" style="padding: 0.375rem 0.75rem; font-size: 0.875rem; background: #e74c3c; color: white;">Delete</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addCarouselSlide() {
            // Show modal to add custom slide
            notify.modal({
                title: 'Add Custom Carousel Slide',
                message: 'Custom carousel slide builder coming soon. For now, slides are auto-generated from your settings.',
                type: 'info',
                buttons: [{ text: 'OK', type: 'primary', action: 'ok' }]
            });
        }

        function editCarouselSlide(index) {
            notify.modal({
                title: 'Edit Carousel Slide',
                message: 'Carousel slide editor coming soon.',
                type: 'info',
                buttons: [{ text: 'OK', type: 'primary', action: 'ok' }]
            });
        }

        function deleteCarouselSlide(index) {
            if (!confirm('Delete this carousel slide?')) return;

            const marketingConfig = NewcoData.get('marketingConfig') || {};
            marketingConfig.carouselSlides = marketingConfig.carouselSlides || [];
            marketingConfig.carouselSlides.splice(index, 1);
            NewcoData.set('marketingConfig', marketingConfig);
            renderCarouselSlidesList();
            notify.success('Slide deleted');
        }

        // ===== NOTIFICATION CARDS MANAGER =====
        function loadNotificationCardsManager() {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            const enabled = marketingConfig.notificationCardsEnabled !== false;

            document.getElementById('enableNotificationCards').checked = enabled;
            renderNotificationCardsList();
        }

        function toggleNotificationCards() {
            const enabled = document.getElementById('enableNotificationCards').checked;
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            marketingConfig.notificationCardsEnabled = enabled;
            NewcoData.set('marketingConfig', marketingConfig);
            notify.success(enabled ? 'Notification cards enabled' : 'Notification cards disabled');
        }

        function renderNotificationCardsList() {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            const cards = marketingConfig.notificationCards || [];
            const container = document.getElementById('notificationCardsList');

            if (cards.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">No cards configured. Dynamic cards will be shown automatically.</p>';
                return;
            }

            container.innerHTML = cards.map((card, index) => `
                <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid ${card.enabled !== false ? '#6c5ce7' : '#ccc'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <span>${card.icon || '📌'}</span>
                                <strong>${card.title || 'Untitled Card'}</strong>
                                ${card.type === 'dynamic' ? '<span style="background: #667eea; color: white; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">DYNAMIC</span>' : ''}
                                ${card.enabled === false ? '<span style="background: #ccc; color: white; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">DISABLED</span>' : ''}
                            </div>
                            <div style="color: #666; font-size: 0.875rem;">${card.subtitle || 'No subtitle'}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editNotificationCard(${index})" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Edit</button>
                            ${card.type === 'custom' ? `<button onclick="deleteNotificationCard(${index})" class="btn" style="padding: 0.375rem 0.75rem; font-size: 0.875rem; background: #e74c3c; color: white;">Delete</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addNotificationCard() {
            notify.modal({
                title: 'Add Custom Notification Card',
                message: 'Custom notification card builder coming soon. For now, cards are auto-generated.',
                type: 'info',
                buttons: [{ text: 'OK', type: 'primary', action: 'ok' }]
            });
        }

        function editNotificationCard(index) {
            notify.modal({
                title: 'Edit Notification Card',
                message: 'Notification card editor coming soon.',
                type: 'info',
                buttons: [{ text: 'OK', type: 'primary', action: 'ok' }]
            });
        }

        function deleteNotificationCard(index) {
            if (!confirm('Delete this notification card?')) return;

            const marketingConfig = NewcoData.get('marketingConfig') || {};
            marketingConfig.notificationCards = marketingConfig.notificationCards || [];
            marketingConfig.notificationCards.splice(index, 1);
            NewcoData.set('marketingConfig', marketingConfig);
            renderNotificationCardsList();
            notify.success('Card deleted');
        }

        // ===== SOCIAL MEDIA CONFIG =====
        function loadSocialMediaConfig() {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            const socialMedia = marketingConfig.socialMedia || { enabled: false, platforms: [] };

            document.getElementById('enableSocialMediaCarousel').checked = socialMedia.enabled;
            renderSocialMediaPlatforms();
        }

        function renderSocialMediaPlatforms() {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            const socialMedia = marketingConfig.socialMedia || { platforms: [] };
            const container = document.getElementById('socialMediaPlatforms');

            if (!socialMedia.platforms || socialMedia.platforms.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">No platforms added yet</p>';
                return;
            }

            container.innerHTML = socialMedia.platforms.map((platform, index) => `
                <div style="background: #f9f9f9; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <strong>${platform.name}</strong>
                        <div style="color: #666; font-size: 0.875rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${platform.url}</div>
                    </div>
                    <button onclick="removeSocialMediaPlatform(${index})" class="btn" style="padding: 0.375rem 0.75rem; font-size: 0.875rem; background: #e74c3c; color: white;">Remove</button>
                </div>
            `).join('');
        }

        function addSocialMediaPlatform() {
            const name = prompt('Platform name (e.g., Facebook, Instagram):');
            if (!name) return;

            const url = prompt('Platform URL:');
            if (!url) return;

            const marketingConfig = NewcoData.get('marketingConfig') || {};
            if (!marketingConfig.socialMedia) marketingConfig.socialMedia = { enabled: false, platforms: [] };
            if (!marketingConfig.socialMedia.platforms) marketingConfig.socialMedia.platforms = [];

            marketingConfig.socialMedia.platforms.push({ name, url });
            NewcoData.set('marketingConfig', marketingConfig);
            renderSocialMediaPlatforms();
            notify.success('Platform added');
        }

        function removeSocialMediaPlatform(index) {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            marketingConfig.socialMedia.platforms.splice(index, 1);
            NewcoData.set('marketingConfig', marketingConfig);
            renderSocialMediaPlatforms();
            notify.success('Platform removed');
        }

        function saveSocialMediaConfig() {
            const enabled = document.getElementById('enableSocialMediaCarousel').checked;
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            if (!marketingConfig.socialMedia) marketingConfig.socialMedia = { platforms: [] };
            marketingConfig.socialMedia.enabled = enabled;
            NewcoData.set('marketingConfig', marketingConfig);
            notify.success('Social media settings saved');
        }

        // ===== TEXT UPDATES CONFIG =====
        function loadTextUpdatesConfig() {
            const marketingConfig = NewcoData.get('marketingConfig') || {};
            const textUpdates = marketingConfig.textUpdates || { enabled: false, keyword: '', shortcode: '' };

            document.getElementById('enableTextUpdatesCarousel').checked = textUpdates.enabled;
            document.getElementById('smsKeyword').value = textUpdates.keyword || '';
            document.getElementById('smsShortcode').value = textUpdates.shortcode || '';
        }

        function saveTextUpdatesConfig() {
            const enabled = document.getElementById('enableTextUpdatesCarousel').checked;
            const keyword = document.getElementById('smsKeyword').value;
            const shortcode = document.getElementById('smsShortcode').value;

            const marketingConfig = NewcoData.get('marketingConfig') || {};
            marketingConfig.textUpdates = {
                enabled,
                keyword,
                shortcode
            };
            NewcoData.set('marketingConfig', marketingConfig);
            notify.success('Text updates settings saved');
        }

        // Social Media Settings Functions
        function loadSocialMediaSettings() {
            const settings = NewcoData.get('socialMediaSettings') || {
                enabled: false,
                buttonText: '📱 GET UPDATES!',
                modalTitle: 'GET UPDATES!',
                message: '',
                smsKeyword: '',
                smsNumber: '',
                twitterLink: '',
                facebookLink: '',
                instagramLink: ''
            };

            document.getElementById('enableSocialMediaButton').checked = settings.enabled;
            document.getElementById('socialMediaButtonText').value = settings.buttonText || '';
            document.getElementById('socialMediaModalTitle').value = settings.modalTitle || '';
            document.getElementById('socialMediaMessage').value = settings.message || '';
            document.getElementById('socialMediaSMSKeyword').value = settings.smsKeyword || '';
            document.getElementById('socialMediaSMSNumber').value = settings.smsNumber || '';
            document.getElementById('socialMediaTwitterLink').value = settings.twitterLink || '';
            document.getElementById('socialMediaFacebookLink').value = settings.facebookLink || '';
            document.getElementById('socialMediaInstagramLink').value = settings.instagramLink || '';

            toggleSocialMediaSettings();
        }

        function toggleSocialMediaSettings() {
            const enabled = document.getElementById('enableSocialMediaButton').checked;
            document.getElementById('socialMediaSettings').style.display = enabled ? 'block' : 'none';
        }

        function saveSocialMediaSettings() {
            const settings = {
                enabled: document.getElementById('enableSocialMediaButton').checked,
                buttonText: document.getElementById('socialMediaButtonText').value,
                modalTitle: document.getElementById('socialMediaModalTitle').value,
                message: document.getElementById('socialMediaMessage').value,
                smsKeyword: document.getElementById('socialMediaSMSKeyword').value,
                smsNumber: document.getElementById('socialMediaSMSNumber').value,
                twitterLink: document.getElementById('socialMediaTwitterLink').value,
                facebookLink: document.getElementById('socialMediaFacebookLink').value,
                instagramLink: document.getElementById('socialMediaInstagramLink').value
            };

            NewcoData.set('socialMediaSettings', settings);
            showSuccess('Social media settings saved successfully!');
        }

        function previewSocialMediaModal() {
            const settings = {
                modalTitle: document.getElementById('socialMediaModalTitle').value || 'GET UPDATES!',
                message: document.getElementById('socialMediaMessage').value,
                smsKeyword: document.getElementById('socialMediaSMSKeyword').value,
                smsNumber: document.getElementById('socialMediaSMSNumber').value,
                twitterLink: document.getElementById('socialMediaTwitterLink').value,
                facebookLink: document.getElementById('socialMediaFacebookLink').value,
                instagramLink: document.getElementById('socialMediaInstagramLink').value
            };

            // Create preview modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; position: relative;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; right: 1rem; top: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>

                    <h2 style="margin: 0 0 1.5rem 0; color: #333;">${settings.modalTitle}</h2>

                    <div style="white-space: pre-line; line-height: 1.6; color: #666; margin-bottom: 1.5rem;">
                        ${settings.message || 'No message configured yet'}
                    </div>

                    ${settings.smsKeyword && settings.smsNumber ? `
                        <div style="background: #f0f0f0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                            <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Text this keyword:</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">${settings.smsKeyword}</div>
                            <div style="font-size: 0.875rem; color: #666;">to</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${settings.smsNumber}</div>
                        </div>
                    ` : ''}

                    ${(settings.twitterLink || settings.facebookLink || settings.instagramLink) ? `
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            ${settings.twitterLink ? `<a href="${settings.twitterLink}" target="_blank" style="background: #1DA1F2; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">🐦 Twitter/X</a>` : ''}
                            ${settings.facebookLink ? `<a href="${settings.facebookLink}" target="_blank" style="background: #4267B2; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">📘 Facebook</a>` : ''}
                            ${settings.instagramLink ? `<a href="${settings.instagramLink}" target="_blank" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">📷 Instagram</a>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Welcome Popup Functions
        async function loadWelcomePopupSettings() {
            const settings = NewcoData.get('welcomePopupSettings') || {
                enabled: false,
                image: null,
                imageArtId: null,
                message: '',
                textPosition: 'bottom',
                frequency: 'once-per-session'
            };

            document.getElementById('enableWelcomePopup').checked = settings.enabled;
            document.getElementById('welcomePopupMessage').value = settings.message || '';
            document.getElementById('welcomePopupTextPosition').value = settings.textPosition || 'bottom';
            document.getElementById('welcomePopupFrequency').value = settings.frequency || 'once-per-session';

            // Load image from art library if art ID exists
            if (settings.imageArtId) {
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/art_library?id=eq.${settings.imageArtId}&select=*`,
                        {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        }
                    );
                    const art = await response.json();
                    if (art && art.length > 0) {
                        document.getElementById('welcomePopupImagePreview').innerHTML = `
                            <img src="${art[0].file_data}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        `;
                    }
                } catch (err) {
                    console.error('Error loading welcome popup art:', err);
                }
            } else if (settings.image) {
                document.getElementById('welcomePopupImagePreview').innerHTML = `
                    <img src="${settings.image}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                `;
            }

            toggleWelcomePopupSettings();
        }

        function toggleWelcomePopupSettings() {
            const enabled = document.getElementById('enableWelcomePopup').checked;
            document.getElementById('welcomePopupSettings').style.display = enabled ? 'block' : 'none';

            // Save the enabled state immediately
            const settings = NewcoData.get('welcomePopupSettings') || {};
            settings.enabled = enabled;
            NewcoData.set('welcomePopupSettings', settings);

            showAutoSave();
        }

        function handleWelcomePopupImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (500KB max)
            if (file.size > 500000) {
                showModal({
                    title: '⚠️ File Too Large',
                    message: 'Image must be under 500KB. Please compress or resize your image.',
                    type: 'warning'
                });
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                document.getElementById('welcomePopupImagePreview').innerHTML = `
                    <img src="${imageData}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                `;
                // Store temporarily until saved
                window.tempWelcomePopupImage = imageData;
            };
            reader.readAsDataURL(file);
        }

        function openArtLibraryForWelcomePopup() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            if (typeof ArtPicker !== 'undefined' && typeof ArtPicker.open === 'function') {
                ArtPicker.open((selectedArt) => {
                    // Store art ID and display preview
                    window.tempWelcomePopupArtId = selectedArt.id;
                    window.tempWelcomePopupImage = selectedArt.file_data;

                    document.getElementById('welcomePopupImagePreview').innerHTML = `
                        <img src="${selectedArt.file_data}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    `;
                }, customerId);
            } else {
                showError('Art library not available. Please ensure art-picker.js is loaded.');
            }
        }

        function saveWelcomePopupSettings() {
            const settings = {
                enabled: document.getElementById('enableWelcomePopup').checked,
                image: window.tempWelcomePopupImage || NewcoData.get('welcomePopupSettings')?.image || null,
                imageArtId: window.tempWelcomePopupArtId || NewcoData.get('welcomePopupSettings')?.imageArtId || null,
                message: document.getElementById('welcomePopupMessage').value,
                textPosition: document.getElementById('welcomePopupTextPosition').value,
                frequency: document.getElementById('welcomePopupFrequency').value
            };

            NewcoData.set('welcomePopupSettings', settings);
            window.tempWelcomePopupImage = null;
            window.tempWelcomePopupArtId = null;
            showSuccess('Welcome popup settings saved successfully!');
        }

        function previewWelcomePopup() {
            const settings = {
                image: window.tempWelcomePopupImage || NewcoData.get('welcomePopupSettings')?.image,
                message: document.getElementById('welcomePopupMessage').value,
                textPosition: document.getElementById('welcomePopupTextPosition').value
            };

            if (!settings.image) {
                showModal({
                    title: '⚠️ No Image',
                    message: 'Please upload an image first to preview the popup.',
                    type: 'warning'
                });
                return;
            }

            showWelcomePopupModal(settings);
        }

        function showWelcomePopupModal(settings) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            let imageHTML = '';
            if (settings.image) {
                imageHTML = `<img src="${settings.image}" style="width: 100%; border-radius: 12px 12px 0 0; display: block;">`;
            }

            let textHTML = '';
            if (settings.message) {
                if (settings.textPosition === 'diagonal') {
                    textHTML = `
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
                            font-size: 2rem; font-weight: bold; color: white; text-shadow: 2px 2px 8px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5);
                            text-align: center; white-space: nowrap; padding: 1rem;">
                            ${settings.message}
                        </div>
                    `;
                } else if (settings.textPosition === 'bottom') {
                    textHTML = `
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
                            padding: 2rem 1rem 1rem; color: white; font-size: 1.25rem; font-weight: 600; text-align: center;">
                            ${settings.message}
                        </div>
                    `;
                }
            }

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 800px; width: 90%; position: relative; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        width: 40px;
                        height: 40px;
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        font-size: 1.5rem;
                        cursor: pointer;
                        z-index: 10;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        transition: all 0.2s;
                    " onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">&times;</button>
                    <div style="position: relative;">
                        ${imageHTML}
                        ${textHTML}
                    </div>
                    ${settings.textPosition === 'none' && settings.message ? `
                        <div style="padding: 1.5rem; text-align: center; font-size: 1.1rem; color: #333;">
                            ${settings.message}
                        </div>
                    ` : ''}
                    <div style="padding: 1rem; text-align: center; font-size: 0.875rem; color: #999;">
                        Click anywhere or wait 3 seconds to close
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Auto-close after 3 seconds
            const autoCloseTimer = setTimeout(() => {
                modal.remove();
            }, 3000);

            // Close on click
            modal.addEventListener('click', () => {
                clearTimeout(autoCloseTimer);
                modal.remove();
            });
        }

        function loadFlashyAlerts() {
            const settings = NewcoData.get('marketingAlerts') || {
                enabled: false,
                timeOnScreen: 3000,
                delayBetween: 6000,
                messageSource: 'default',
                customMessages: []
            };
            
            document.getElementById('enableFlashyAlerts').checked = settings.enabled;
            document.getElementById('alertTimeOnScreen').value = settings.timeOnScreen / 1000;
            document.getElementById('alertDelayBetween').value = settings.delayBetween / 1000;
            
            const sourceRadio = document.querySelector(`input[name="alertMessageSource"][value="${settings.messageSource}"]`);
            if (sourceRadio) sourceRadio.checked = true;
            
            if (settings.customMessages && settings.customMessages.length > 0) {
                document.getElementById('customAlertMessages').value = settings.customMessages.join('\n');
            }

            toggleFlashyAlerts(false);
            toggleMessageSource();
        }
        
        function toggleFlashyAlerts(showToast = true) {
            const enabled = document.getElementById('enableFlashyAlerts').checked;
            document.getElementById('flashyAlertsSettings').style.display = enabled ? 'block' : 'none';

            // Auto-save the enabled state
            const currentSettings = NewcoData.get('marketingAlerts') || {
                enabled: false,
                timeOnScreen: 3000,
                delayBetween: 6000,
                messageSource: 'default',
                customMessages: []
            };

            currentSettings.enabled = enabled;
            NewcoData.set('marketingAlerts', currentSettings);

            if (showToast) {
                if (enabled) {
                    showSuccess('Flashy alerts enabled');
                } else {
                    showSuccess('Flashy alerts disabled');
                }
            }
        }
        
        function toggleMessageSource() {
            const source = document.querySelector('input[name="alertMessageSource"]:checked').value;
            document.getElementById('customMessagesSection').style.display = source === 'custom' ? 'block' : 'none';
        }
        
        function saveFlashyAlertsSettings() {
            const settings = {
                enabled: document.getElementById('enableFlashyAlerts').checked,
                timeOnScreen: parseInt(document.getElementById('alertTimeOnScreen').value) * 1000,
                delayBetween: parseInt(document.getElementById('alertDelayBetween').value) * 1000,
                messageSource: document.querySelector('input[name="alertMessageSource"]:checked').value,
                customMessages: []
            };
            
            if (settings.messageSource === 'custom') {
                const customText = document.getElementById('customAlertMessages').value;
                settings.customMessages = customText.split('\n').filter(line => line.trim());
            }
            
            NewcoData.set('marketingAlerts', settings);
            showSuccess('Flashy alerts settings saved successfully!');
        }
        
        function previewFlashyAlert() {
            const messages = [
                "Feel that excitement? Your winning moment is near!",
                "Tonight's energy is electric - something special awaits!",
                "Your lucky stars are aligning right now!"
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            // Create preview alert
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0.9);
                background: #1a1a2e;
                color: #eee;
                padding: 1rem 1.75rem;
                border-radius: 8px;
                border: 2px solid #f39c12;
                box-shadow: 0 0 30px rgba(243, 156, 18, 0.5);
                z-index: 10000;
                opacity: 0;
                transition: all 0.4s ease;
                max-width: 500px;
                text-align: center;
                font-size: 1.1rem;
                font-weight: 500;
                line-height: 1.5;
            `;
            alert.textContent = randomMessage;
            
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => {
                alert.style.opacity = '1';
                alert.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translate(-50%, -50%) scale(0.9)';
                setTimeout(() => alert.remove(), 400);
            }, 3000);
        }
        
        function loadBirthdayOffer() {
            const birthdayOffer = NewcoData.get('birthdayOffer') || {
                enabled: false,
                offerType: 'percentage',
                percentageOff: 0,
                dollarOff: 0,
                freeItem: '',
                validDaysBefore: 7,
                validDaysAfter: 7,
                requiresRegistration: true,
                minimumPurchase: 0
            };
            
            const container = document.getElementById('birthdayOfferContainer');
            container.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="birthdayEnabled" ${birthdayOffer.enabled ? 'checked' : ''} 
                                   onchange="toggleBirthdayOffer(this)"> Enable Birthday Offers
                        </label>
                    </div>
                </div>
                
                <div id="birthdaySettings" style="${birthdayOffer.enabled ? '' : 'display: none;'}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Offer Type</label>
                            <select class="form-select" id="birthdayOfferType" onchange="updateBirthdayOfferType(this)">
                                <option value="percentage" ${birthdayOffer.offerType === 'percentage' ? 'selected' : ''}>Percentage Discount</option>
                                <option value="dollar" ${birthdayOffer.offerType === 'dollar' ? 'selected' : ''}>Dollar Amount Off</option>
                                <option value="freeItem" ${birthdayOffer.offerType === 'freeItem' ? 'selected' : ''}>Free Item/Package</option>
                                <option value="bonusPoints" ${birthdayOffer.offerType === 'bonusPoints' ? 'selected' : ''}>Bonus Loyalty Points</option>
                                <option value="bogo" ${birthdayOffer.offerType === 'bogo' ? 'selected' : ''}>Buy One Get One</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="percentageGroup" style="${birthdayOffer.offerType === 'percentage' ? '' : 'display: none;'}">
                            <label class="form-label">Percentage Off (%)</label>
                            <input type="number" class="form-input" id="birthdayPercentage" 
                                   value="${birthdayOffer.percentageOff}" min="0" max="100">
                        </div>
                        
                        <div class="form-group" id="dollarGroup" style="${birthdayOffer.offerType === 'dollar' ? '' : 'display: none;'}">
                            <label class="form-label">Dollar Amount Off ($)</label>
                            <input type="number" class="form-input" id="birthdayDollar" 
                                   value="${birthdayOffer.dollarOff}" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group" id="freeItemGroup" style="${birthdayOffer.offerType === 'freeItem' ? '' : 'display: none;'}">
                            <label class="form-label">Free Item/Package</label>
                            <select class="form-select" id="birthdayFreeItem">
                                <option value="">Select item...</option>
                                ${getBirthdayItemOptions(birthdayOffer.freeItem)}
                            </select>
                        </div>
                        
                        <div class="form-group" id="bonusPointsGroup" style="${birthdayOffer.offerType === 'bonusPoints' ? '' : 'display: none;'}">
                            <label class="form-label">Bonus Points Amount</label>
                            <input type="number" class="form-input" id="birthdayBonusPoints" 
                                   value="${birthdayOffer.bonusPoints || 100}" min="0">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Valid Days Before Birthday</label>
                            <input type="number" class="form-input" id="birthdayDaysBefore" 
                                   value="${birthdayOffer.validDaysBefore}" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Valid Days After Birthday</label>
                            <input type="number" class="form-input" id="birthdayDaysAfter" 
                                   value="${birthdayOffer.validDaysAfter}" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Minimum Purchase Required ($)</label>
                            <input type="number" class="form-input" id="birthdayMinPurchase" 
                                   value="${birthdayOffer.minimumPurchase}" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="birthdayRequiresReg" ${birthdayOffer.requiresRegistration ? 'checked' : ''}> 
                                Requires Loyalty Registration
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveBirthdayOffer()">Save Birthday Offer Settings</button>
                </div>
            `;
        }
        
        function getBirthdayItemOptions(selectedItem) {
            const packages = NewcoData.get('packages') || [];
            const items = NewcoData.get('salesItems') || [];
            
            let options = '<optgroup label="Packages">';
            packages.forEach(pkg => {
                options += `<option value="package_${pkg.id}" ${selectedItem === `package_${pkg.id}` ? 'selected' : ''}>
                    ${pkg.name} ($${pkg.price})
                </option>`;
            });
            options += '</optgroup><optgroup label="Basic Offerings">';
            items.forEach(item => {
                options += `<option value="item_${item.id}" ${selectedItem === `item_${item.id}` ? 'selected' : ''}>
                    ${item.name} ($${item.price})
                </option>`;
            });
            options += '</optgroup>';
            
            return options;
        }
        
        function toggleBirthdayOffer(checkbox) {
            document.getElementById('birthdaySettings').style.display = checkbox.checked ? 'block' : 'none';
        }
        
        function updateBirthdayOfferType(select) {
            document.getElementById('percentageGroup').style.display = select.value === 'percentage' ? 'block' : 'none';
            document.getElementById('dollarGroup').style.display = select.value === 'dollar' ? 'block' : 'none';
            document.getElementById('freeItemGroup').style.display = select.value === 'freeItem' ? 'block' : 'none';
            document.getElementById('bonusPointsGroup').style.display = select.value === 'bonusPoints' ? 'block' : 'none';
        }
        
        function saveBirthdayOffer() {
            const offerType = document.getElementById('birthdayOfferType').value;
            
            // Get the selected radio button value for birthday requirement
            let birthdayRequirement = 'automatic';
            const requirementRadios = document.getElementsByName('birthdayRequirement');
            for (const radio of requirementRadios) {
                if (radio.checked) {
                    birthdayRequirement = radio.value;
                    break;
                }
            }
            
            const birthdayOffer = {
                enabled: document.getElementById('birthdayEnabled').checked,
                offerType: offerType,
                percentageOff: offerType === 'percentage' ? parseInt(document.getElementById('birthdayPercentage').value) || 0 : 0,
                dollarOff: offerType === 'dollar' ? parseFloat(document.getElementById('birthdayDollar').value) || 0 : 0,
                freeItem: offerType === 'freeItem' ? document.getElementById('birthdayFreeItem').value : '',
                bonusPoints: offerType === 'bonusPoints' ? parseInt(document.getElementById('birthdayBonusPoints').value) || 0 : 0,
                validDaysBefore: parseInt(document.getElementById('birthdayDaysBefore').value) || 0,
                validDaysAfter: parseInt(document.getElementById('birthdayDaysAfter').value) || 0,
                minimumPurchase: parseFloat(document.getElementById('birthdayMinPurchase').value) || 0,
                requiresRegistration: document.getElementById('birthdayRequiresReg').checked,
                requirement: birthdayRequirement,
                triggerEmail: document.getElementById('birthdayTriggerEmail').checked,
                emailDaysBefore: document.getElementById('birthdayTriggerEmail').checked ? 
                    parseInt(document.getElementById('emailDaysBefore')?.value) || 7 : 0
            };
            
            NewcoData.set('birthdayOffer', birthdayOffer);
            showSuccess('Birthday offer settings saved successfully');
        }
        
        function loadActivePromotions() {
            const promotions = NewcoData.get('promotions') || [];
            const container = document.getElementById('promotionsContainer');
            
            if (promotions.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No active promotions. Click "Add Promotion" to create your first promotion.</p>';
                return;
            }
            
            let html = '<div class="promotions-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));">';
            
            promotions.forEach((promo, index) => {
                const isActive = isPromotionActive(promo);
                html += `
                    <div class="promo-card" style="background: white; border: 2px solid ${isActive ? 'var(--success)' : 'var(--gray-light)'}; border-radius: 12px; padding: 1.5rem; position: relative;">
                        ${isActive ? '<span style="position: absolute; top: 10px; right: 10px; background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">ACTIVE</span>' : ''}
                        <h3 style="margin: 0 0 0.5rem 0;">${promo.name}</h3>
                        <div style="font-size: 0.875rem; color: var(--gray-dark); margin-bottom: 1rem;">
                            ${promo.description || 'No description'}
                        </div>
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <strong>Type:</strong> ${promo.type}
                        </div>
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <strong>Discount:</strong> ${formatPromoDiscount(promo)}
                        </div>
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <strong>Valid:</strong> ${promo.startDate} to ${promo.endDate}
                        </div>
                        ${promo.promoCode ? `<div style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Code:</strong> ${promo.promoCode}</div>` : ''}
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="editPromotion(${index})" style="flex: 1;">Edit</button>
                            <button class="btn btn-danger" onclick="deletePromotion(${index})" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function isPromotionActive(promo) {
            const now = new Date();
            const start = new Date(promo.startDate);
            const end = new Date(promo.endDate);
            return now >= start && now <= end;
        }
        
        function formatPromoDiscount(promo) {
            if (promo.discountType === 'percentage') {
                return `${promo.percentageOff}% off`;
            } else if (promo.discountType === 'dollar') {
                return `$${promo.dollarOff} off`;
            } else if (promo.discountType === 'bogo') {
                return 'Buy One Get One';
            }
            return 'Custom offer';
        }
        
        function addPromotion() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Promotion';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Promotion Name</label>
                    <input type="text" class="form-input" id="promoName" placeholder="e.g., Weekend Special">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="promoDescription" rows="2" placeholder="Brief description of the promotion"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Promotion Type</label>
                        <select class="form-select" id="promoType">
                            <option value="time-based">Time-Based</option>
                            <option value="customer-based">Customer-Based</option>
                            <option value="event-based">Event-Based</option>
                            <option value="code-based">Promo Code</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Discount Type</label>
                        <select class="form-select" id="promoDiscountType" onchange="updatePromoDiscountType(this)">
                            <option value="percentage">Percentage Off</option>
                            <option value="dollar">Dollar Amount Off</option>
                            <option value="bogo">Buy One Get One</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group" id="promoPercentageGroup">
                        <label class="form-label">Percentage Off (%)</label>
                        <input type="number" class="form-input" id="promoPercentage" min="0" max="100" placeholder="20">
                    </div>
                    <div class="form-group" id="promoDollarGroup" style="display: none;">
                        <label class="form-label">Dollar Amount Off ($)</label>
                        <input type="number" class="form-input" id="promoDollar" min="0" step="0.01" placeholder="5.00">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" id="promoStartDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" id="promoEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Promo Code (optional)</label>
                    <input type="text" class="form-input" id="promoCode" placeholder="e.g., SAVE20">
                </div>
                <div class="form-group">
                    <label class="form-label">Minimum Purchase ($)</label>
                    <input type="number" class="form-input" id="promoMinPurchase" min="0" step="0.01" placeholder="0">
                </div>
            `;
            
            window.updatePromoDiscountType = function(select) {
                document.getElementById('promoPercentageGroup').style.display = select.value === 'percentage' ? 'block' : 'none';
                document.getElementById('promoDollarGroup').style.display = select.value === 'dollar' ? 'block' : 'none';
            };
            
            modalSaveBtn.onclick = () => {
                const promotions = NewcoData.get('promotions') || [];
                const discountType = document.getElementById('promoDiscountType').value;
                const newPromo = {
                    id: Date.now().toString(),
                    name: document.getElementById('promoName').value,
                    description: document.getElementById('promoDescription').value,
                    type: document.getElementById('promoType').value,
                    discountType: discountType,
                    percentageOff: discountType === 'percentage' ? parseInt(document.getElementById('promoPercentage').value) || 0 : 0,
                    dollarOff: discountType === 'dollar' ? parseFloat(document.getElementById('promoDollar').value) || 0 : 0,
                    startDate: document.getElementById('promoStartDate').value,
                    endDate: document.getElementById('promoEndDate').value,
                    promoCode: document.getElementById('promoCode').value,
                    minimumPurchase: parseFloat(document.getElementById('promoMinPurchase').value) || 0
                };
                
                promotions.push(newPromo);
                NewcoData.set('promotions', promotions);
                closeModal();
                loadActivePromotions();
                showSuccess(`Promotion "${newPromo.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }

        // ===== CUSTOMER ART LIBRARY FUNCTIONS =====

        let customerArtTab = 'newco'; // 'my' or 'newco'
        let allCustomerArt = [];
        let myCustomerArt = [];
        let newcoCustomerArt = [];
        let filteredCustomerArt = [];

        async function loadCustomerArtLibrary() {
            // Initialize art picker with current customer
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';
            ArtPicker.init(customerId);

            // Load art
            await loadAllCustomerArt();
            renderCustomerArtLibrary();
        }

        async function loadAllCustomerArt() {
            const SUPABASE_URL = 'https://ufagkpdpzziuqiiudvmp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmYWdrcGRwenppdXFpaXVkdm1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NDAyNzUsImV4cCI6MjA3NTAxNjI3NX0.7zla3G9lPFRiJTOE2XOiqXoIU7_5lqr1hC4KcwsNzrA';

            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            try {
                // Load NewCo global art
                const newcoResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/art_library?customer_id=eq.newco&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );
                newcoCustomerArt = await newcoResponse.json();

                // Load customer's own art
                const myResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/art_library?customer_id=eq.${customerId}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );
                myCustomerArt = await myResponse.json();

                allCustomerArt = [...myCustomerArt, ...newcoCustomerArt];
                filteredCustomerArt = customerArtTab === 'my' ? myCustomerArt : newcoCustomerArt;

            } catch (error) {
                console.error('Error loading art library:', error);
            }
        }

        function switchArtLibraryTab(tab) {
            customerArtTab = tab;

            // Update tab buttons
            document.getElementById('myArtTabBtn').style.borderBottomColor = tab === 'my' ? 'var(--primary)' : 'transparent';
            document.getElementById('myArtTabBtn').style.color = tab === 'my' ? 'var(--primary)' : 'var(--gray)';
            document.getElementById('newcoArtTabBtn').style.borderBottomColor = tab === 'newco' ? 'var(--primary)' : 'transparent';
            document.getElementById('newcoArtTabBtn').style.color = tab === 'newco' ? 'var(--primary)' : 'var(--gray)';

            filterCustomerArtLibrary();
        }

        function filterCustomerArtLibrary() {
            const category = document.getElementById('filterCustomerArtCategory').value;
            const fileType = document.getElementById('filterCustomerArtType').value;
            const searchTerm = document.getElementById('searchCustomerArt').value.toLowerCase();

            const artToFilter = customerArtTab === 'my' ? myCustomerArt : newcoCustomerArt;

            filteredCustomerArt = artToFilter.filter(art => {
                const matchesCategory = !category || art.category === category;
                const matchesType = !fileType || art.file_type === fileType;
                const matchesSearch = !searchTerm ||
                    art.name.toLowerCase().includes(searchTerm) ||
                    (art.description && art.description.toLowerCase().includes(searchTerm));

                return matchesCategory && matchesType && matchesSearch;
            });

            renderCustomerArtLibrary();
        }

        function renderCustomerArtLibrary() {
            const grid = document.getElementById('customerArtLibraryGrid');

            if (filteredCustomerArt.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--gray);">
                        ${customerArtTab === 'my' ? 'No art in your library yet. Upload some to get started!' : 'No NewCo global art found.'}
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredCustomerArt.map(art => `
                <div class="art-card">
                    <img src="${art.file_data}" alt="${art.name}" class="art-card-image" loading="lazy">
                    <div class="art-card-info">
                        <div class="art-card-name" title="${art.name}">${art.name}</div>
                        <div class="art-card-meta">
                            <span>${art.file_type.toUpperCase()}</span>
                            <span>${(art.file_size / 1024).toFixed(1)}KB</span>
                        </div>
                        ${art.category ? `<span class="art-card-category">${art.category}</span>` : ''}
                        ${customerArtTab === 'my' ? `
                            <div class="art-card-actions">
                                <button class="art-card-delete" onclick="deleteCustomerArt('${art.id}', '${art.name.replace(/'/g, "\\'")}')">🗑 Delete</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showUploadCustomerArt() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            ArtPicker.open(async (selectedArt) => {
                // Art was uploaded and selected
                await loadAllCustomerArt();
                customerArtTab = 'my';
                switchArtLibraryTab('my');
            }, customerId);
        }

        async function deleteCustomerArt(artId, artName) {
            // TODO: Check if art is in use before deleting
            if (!confirm(`Are you sure you want to delete "${artName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            const SUPABASE_URL = 'https://ufagkpdpzziuqiiudvmp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmYWdrcGRwenppdXFpaXVkdm1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NDAyNzUsImV4cCI6MjA3NTAxNjI3NX0.7zla3G9lPFRiJTOE2XOiqXoIU7_5lqr1hC4KcwsNzrA';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/art_library?id=eq.${artId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to delete art');
                }

                showSuccess(`"${artName}" has been deleted from your library.`);
                await loadAllCustomerArt();
                filterCustomerArtLibrary();
            } catch (error) {
                console.error('Error deleting art:', error);
                showError('Error deleting art: ' + error.message);
            }
        }

        function editPromotion(index) {
            showAlert('Edit functionality coming soon', 'Info');
        }
        
        function deletePromotion(index) {
            showConfirm(
                'Are you sure you want to delete this promotion?',
                () => {
                    const promotions = NewcoData.get('promotions') || [];
                    const deleted = promotions.splice(index, 1)[0];
                    NewcoData.set('promotions', promotions);
                    loadActivePromotions();
                    showSuccess(`Promotion "${deleted.name}" deleted successfully`);
                },
                'Delete Promotion'
            );
        }
        
        // Loyalty Items Management Functions
        function loadLoyaltyItems() {
            const loyaltyItems = window.tempLoyaltyItems || NewcoData.get('loyaltyItems') || [];
            const container = document.getElementById('loyaltyItemsContainer');
            
            if (loyaltyItems.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No loyalty items created yet. Click "Add Loyalty Item" to create rewards for your loyal customers.</p>';
                return;
            }
            
            let html = '<div class="packages-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">';
            
            loyaltyItems.forEach((item, index) => {
                // Build image preview based on style
                let imagePreviewHtml = '';
                if (item.imageUrl) {
                    if (item.imageStyle === 'banner') {
                        imagePreviewHtml = `
                            <div style="width: 100%; height: 100px; overflow: hidden; margin-bottom: 1rem; border-radius: 8px; border: 1px solid var(--gray-light);">
                                <img src="${item.imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">📐 Banner Style</div>
                        `;
                    } else if (item.imageStyle === 'background') {
                        imagePreviewHtml = `
                            <div style="position: relative; width: 100%; height: 80px; overflow: hidden; margin-bottom: 1rem; border-radius: 8px; border: 1px solid var(--gray-light);">
                                <div style="position: absolute; inset: 0; background-image: url('${item.imageUrl}'); background-size: cover; background-position: center; opacity: 0.3;"></div>
                                <div style="position: relative; z-index: 1; display: flex; align-items: center; justify-content: center; height: 100%; font-weight: bold; color: var(--gray-dark);">Sample Text</div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">📐 Background Style</div>
                        `;
                    } else {
                        // thumbnail
                        imagePreviewHtml = `
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.5rem; background: var(--light-gray); border-radius: 6px;">
                                <img src="${item.imageUrl}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid var(--gray-light);">
                                <div style="font-size: 0.75rem; color: var(--gray);">📐 Thumbnail Style</div>
                            </div>
                        `;
                    }
                }

                html += `
                    <div class="package-card" style="background: white; border: 2px solid var(--warning); border-radius: 12px; padding: 1.5rem; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">
                            ${item.pointsCost} Points
                        </div>
                        ${imagePreviewHtml}
                        <h3 style="margin: 0 0 0.5rem 0;">${item.name}</h3>
                        <div style="font-size: 0.875rem; color: var(--gray-dark); margin-bottom: 1rem;">
                            ${item.description || 'No description'}
                        </div>
                        ${item.category ? `<div style="font-size: 0.875rem; color: var(--secondary); margin-bottom: 0.5rem;">Category: ${item.category}</div>` : ''}
                        ${item.limitPerCustomer ? `<div style="font-size: 0.875rem; color: var(--danger);">Limit: ${item.limitPerCustomer} per customer</div>` : ''}
                        ${item.expiresAfterDays ? `<div style="font-size: 0.875rem; color: var(--gray);">Expires: ${item.expiresAfterDays} days after redemption</div>` : ''}
                        ${item.hasDateRestrictions ? `<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <span style="background: #f97316; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">📅 Date Restricted</span>
                        </div>` : ''}
                        ${item.specialEventsOnly ? `<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <span style="background: #8b5cf6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">🎉 Special Events Only</span>
                        </div>` : ''}
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="editLoyaltyItem(${index})" style="flex: 1;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteLoyaltyItem(${index})" style="flex: 1;">Delete</button>
                            ${index > 0 ? `<button class="btn btn-secondary" onclick="moveLoyaltyItem(${index}, -1)">↑</button>` : ''}
                            ${index < loyaltyItems.length - 1 ? `<button class="btn btn-secondary" onclick="moveLoyaltyItem(${index}, 1)">↓</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function addLoyaltyItem() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Loyalty Item';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input type="text" class="form-input" id="loyaltyName" placeholder="e.g., Free Session Voucher">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="loyaltyDescription" rows="2" placeholder="What does this reward include?"></textarea>
                </div>

                <!-- Art/Image Section -->
                <div style="border: 1px solid var(--gray-light); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--light-gray);">
                    <h4 style="margin: 0 0 0.75rem 0; color: var(--primary-dark); font-size: 0.95rem;">🎨 Reward Image (Optional)</h4>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="openArtLibraryForLoyalty()" style="width: 100%;">
                            📚 Choose from Art Library
                        </button>
                    </div>
                    <div id="loyaltyImagePreview" style="margin-top: 0.5rem; display: none;">
                        <img id="loyaltyImagePreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid var(--primary);">
                        <button type="button" class="btn btn-danger btn-small" onclick="clearLoyaltyImage()" style="margin-top: 0.5rem; width: 100%;">Remove Image</button>
                    </div>
                    <div class="form-group" style="margin-top: 0.75rem;">
                        <label class="form-label">Image Display Style</label>
                        <select class="form-select" id="loyaltyImageStyle">
                            <option value="thumbnail">Thumbnail (small image next to name)</option>
                            <option value="banner">Banner (wide image above reward)</option>
                            <option value="background">Background (image fills card)</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Points Cost</label>
                        <input type="number" class="form-input" id="loyaltyPoints" min="0" placeholder="500">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="loyaltyCategory" onchange="toggleDiscountPercentageField(this.value)">
                            <option value="">Select Category</option>
                            <option value="discount_coupon">Discount Coupon on Web Sale</option>
                            <option value="vouchers">Free Play Vouchers</option>
                            <option value="food">Food & Beverage</option>
                            <option value="merchandise">Merchandise</option>
                            <option value="vip">VIP Experiences</option>
                            <option value="special">Special Offers</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid" id="discountPercentageField" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Discount Percentage</label>
                        <input type="number" class="form-input" id="loyaltyDiscountPercentage" min="1" max="100" placeholder="e.g., 25">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Percentage off entire cart (1-100%)</p>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Limit Per Customer (optional)</label>
                        <input type="number" class="form-input" id="loyaltyLimit" min="0" placeholder="e.g., 1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expires After (days, optional)</label>
                        <input type="number" class="form-input" id="loyaltyExpires" min="0" placeholder="e.g., 30">
                    </div>
                </div>
                
                <!-- Day/Date Eligibility Section -->
                <div class="form-group">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-dark); font-size: 1rem; border-bottom: 1px solid var(--gray-light); padding-bottom: 0.5rem;">📅 Day/Date Eligibility</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="loyaltyHasDateRestrictions" onchange="toggleLoyaltyDateRestrictions(this)"> Restrict to specific days/dates
                    </label>
                </div>
                
                <div id="loyaltyDateRestrictionsGroup" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Available Days</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayMon" value="monday"> Mon
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayTue" value="tuesday"> Tue
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayWed" value="wednesday"> Wed
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayThu" value="thursday"> Thu
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDayFri" value="friday"> Fri
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDaySat" value="saturday"> Sat
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="loyaltyDaySun" value="sunday"> Sun
                                </label>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only available on selected days</p>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Valid From Date</label>
                            <input type="date" class="form-input" id="loyaltyValidFrom">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no start date</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valid Until Date</label>
                            <input type="date" class="form-input" id="loyaltyValidUntil">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no end date</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="loyaltySpecialEventsOnly"> Only available during special events
                        </label>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only shows when sessions are marked as special events</p>
                    </div>
                </div>
                
            `;
            
            // Add toggle function for date restrictions
            window.toggleLoyaltyDateRestrictions = function(checkbox) {
                document.getElementById('loyaltyDateRestrictionsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };

            // Add toggle function for discount percentage field
            window.toggleDiscountPercentageField = function(category) {
                const percentageField = document.getElementById('discountPercentageField');
                if (percentageField) {
                    percentageField.style.display = category === 'discount_coupon' ? 'block' : 'none';
                }
            };

            modalSaveBtn.onclick = () => {
                const loyaltyItems = NewcoData.get('loyaltyItems') || [];
                const categorySelect = document.getElementById('loyaltyCategory');
                const itemId = Date.now().toString();
                    
                    // Collect selected days
                    const selectedDays = [];
                    if (document.getElementById('loyaltyHasDateRestrictions').checked) {
                        if (document.getElementById('loyaltyDayMon').checked) selectedDays.push('monday');
                        if (document.getElementById('loyaltyDayTue').checked) selectedDays.push('tuesday');
                        if (document.getElementById('loyaltyDayWed').checked) selectedDays.push('wednesday');
                        if (document.getElementById('loyaltyDayThu').checked) selectedDays.push('thursday');
                        if (document.getElementById('loyaltyDayFri').checked) selectedDays.push('friday');
                        if (document.getElementById('loyaltyDaySat').checked) selectedDays.push('saturday');
                        if (document.getElementById('loyaltyDaySun').checked) selectedDays.push('sunday');
                    }
                    
                    const category = categorySelect ? categorySelect.value : 'merchandise';
                    const newItem = {
                        id: itemId,
                        name: document.getElementById('loyaltyName').value,
                        description: document.getElementById('loyaltyDescription').value,
                        pointsCost: parseInt(document.getElementById('loyaltyPoints').value) || 0,
                        category: category,
                        limitPerCustomer: parseInt(document.getElementById('loyaltyLimit').value) || null,
                        expiresAfterDays: parseInt(document.getElementById('loyaltyExpires').value) || null,
                        order: loyaltyItems.length,
                        // Date/day restrictions
                        hasDateRestrictions: document.getElementById('loyaltyHasDateRestrictions').checked,
                        availableDays: selectedDays,
                        validFrom: document.getElementById('loyaltyValidFrom').value || null,
                        validUntil: document.getElementById('loyaltyValidUntil').value || null,
                        specialEventsOnly: document.getElementById('loyaltySpecialEventsOnly').checked || false,
                        // Image fields
                        imageUrl: window.tempLoyaltyImageUrl || null,
                        imageArtId: window.tempLoyaltyArtId || null,
                        imageStyle: document.getElementById('loyaltyImageStyle').value || 'thumbnail'
                    };

                    // Add discount percentage if category is discount_coupon
                    if (category === 'discount_coupon') {
                        newItem.discountPercentage = parseInt(document.getElementById('loyaltyDiscountPercentage').value) || 0;
                    }
                    
                    loyaltyItems.push(newItem);
                    
                    try {
                        NewcoData.set('loyaltyItems', loyaltyItems);
                    } catch (e) {
                        console.warn('Could not save to localStorage, keeping in memory:', e);
                        // Keep the item in memory even if localStorage fails
                        window.tempLoyaltyItems = loyaltyItems;
                    }
                    
                    closeModal();
                    loadLoyaltyItems();
                    showSuccess(`Loyalty item "${newItem.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }

        // Loyalty item art library functions
        function openArtLibraryForLoyalty() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            if (typeof ArtPicker !== 'undefined' && typeof ArtPicker.open === 'function') {
                ArtPicker.open((selectedArt) => {
                    window.tempLoyaltyArtId = selectedArt.id;
                    window.tempLoyaltyImageUrl = selectedArt.file_data;

                    const preview = document.getElementById('loyaltyImagePreview');
                    const previewImg = document.getElementById('loyaltyImagePreviewImg');

                    if (preview && previewImg) {
                        previewImg.src = selectedArt.file_data;
                        preview.style.display = 'block';
                    }
                }, customerId);
            } else {
                showError('Art library not available. Please ensure art-picker.js is loaded.');
            }
        }

        function clearLoyaltyImage() {
            window.tempLoyaltyArtId = null;
            window.tempLoyaltyImageUrl = null;

            const preview = document.getElementById('loyaltyImagePreview');
            if (preview) {
                preview.style.display = 'none';
            }
        }

        function openArtLibraryForSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            if (typeof ArtPicker !== 'undefined' && typeof ArtPicker.open === 'function') {
                ArtPicker.open((selectedArt) => {
                    window.tempSessionArtId = selectedArt.id;
                    window.tempSessionImageUrl = selectedArt.file_data;

                    const preview = document.getElementById('sessionImagePreview');
                    const previewImg = document.getElementById('sessionImagePreviewImg');

                    if (preview && previewImg) {
                        previewImg.src = selectedArt.file_data;
                        preview.style.display = 'block';
                    }
                }, customerId);
            } else {
                showError('Art library not available. Please ensure art-picker.js is loaded.');
            }
        }

        function clearSessionImage() {
            window.tempSessionArtId = null;
            window.tempSessionImageUrl = null;

            const preview = document.getElementById('sessionImagePreview');
            if (preview) {
                preview.style.display = 'none';
            }
        }

        function editLoyaltyItem(index) {
            const items = NewcoData.get('loyaltyItems') || [];
            const item = items[index];
            if (!item) return;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            // Copy the form from addLoyaltyItem
            modalTitle.textContent = 'Edit Loyalty Item';
            
            // Get the form HTML from addLoyaltyItem function
            addLoyaltyItem();
            
            // Change the title after addLoyaltyItem sets it
            modalTitle.textContent = 'Edit Loyalty Item';
            
            // Pre-fill values after a short delay
            setTimeout(() => {
                document.getElementById('loyaltyName').value = item.name || '';
                document.getElementById('loyaltyDescription').value = item.description || '';
                document.getElementById('loyaltyPoints').value = item.pointsCost || '';
                const categorySelect = document.getElementById('loyaltyCategory');
                if (categorySelect) {
                    categorySelect.value = item.category || 'merchandise';
                    // Toggle discount percentage field if discount_coupon
                    toggleDiscountPercentageField(item.category);
                }
                // Set discount percentage if exists
                if (item.discountPercentage) {
                    const discountInput = document.getElementById('loyaltyDiscountPercentage');
                    if (discountInput) {
                        discountInput.value = item.discountPercentage;
                    }
                }
                const limitInput = document.getElementById('loyaltyLimit');
                if (limitInput) {
                    limitInput.value = item.limitPerCustomer || '';
                }
                const expiresInput = document.getElementById('loyaltyExpires');
                if (expiresInput) {
                    expiresInput.value = item.expiresAfterDays || '';
                }
                
                // Load date/day restrictions
                document.getElementById('loyaltyHasDateRestrictions').checked = item.hasDateRestrictions || false;
                if (item.hasDateRestrictions) {
                    document.getElementById('loyaltyDateRestrictionsGroup').style.display = 'block';
                    // Set available days
                    if (item.availableDays && item.availableDays.length > 0) {
                        document.getElementById('loyaltyDayMon').checked = item.availableDays.includes('monday');
                        document.getElementById('loyaltyDayTue').checked = item.availableDays.includes('tuesday');
                        document.getElementById('loyaltyDayWed').checked = item.availableDays.includes('wednesday');
                        document.getElementById('loyaltyDayThu').checked = item.availableDays.includes('thursday');
                        document.getElementById('loyaltyDayFri').checked = item.availableDays.includes('friday');
                        document.getElementById('loyaltyDaySat').checked = item.availableDays.includes('saturday');
                        document.getElementById('loyaltyDaySun').checked = item.availableDays.includes('sunday');
                    }
                    // Set date range
                    document.getElementById('loyaltyValidFrom').value = item.validFrom || '';
                    document.getElementById('loyaltyValidUntil').value = item.validUntil || '';
                    // Set special events only
                    document.getElementById('loyaltySpecialEventsOnly').checked = item.specialEventsOnly || false;
                }
                
                // Load existing image
                if (item.imageUrl) {
                    window.tempLoyaltyArtId = item.imageArtId || null;
                    window.tempLoyaltyImageUrl = item.imageUrl;

                    const preview = document.getElementById('loyaltyImagePreview');
                    const previewImg = document.getElementById('loyaltyImagePreviewImg');
                    const styleSelect = document.getElementById('loyaltyImageStyle');

                    if (preview && previewImg) {
                        previewImg.src = item.imageUrl;
                        preview.style.display = 'block';
                    }

                    if (styleSelect && item.imageStyle) {
                        styleSelect.value = item.imageStyle;
                    }
                }
                
                // Override save function to update instead of create
                modalSaveBtn.onclick = () => {
                    function updateLoyaltyItem() {
                        const categorySelect = document.getElementById('loyaltyCategory');

                        // Collect selected days
                        const selectedDays = [];
                        if (document.getElementById('loyaltyHasDateRestrictions').checked) {
                            if (document.getElementById('loyaltyDayMon').checked) selectedDays.push('monday');
                            if (document.getElementById('loyaltyDayTue').checked) selectedDays.push('tuesday');
                            if (document.getElementById('loyaltyDayWed').checked) selectedDays.push('wednesday');
                            if (document.getElementById('loyaltyDayThu').checked) selectedDays.push('thursday');
                            if (document.getElementById('loyaltyDayFri').checked) selectedDays.push('friday');
                            if (document.getElementById('loyaltyDaySat').checked) selectedDays.push('saturday');
                            if (document.getElementById('loyaltyDaySun').checked) selectedDays.push('sunday');
                        }
                        
                        const category = categorySelect ? categorySelect.value : 'merchandise';
                        items[index] = {
                            id: item.id,
                            name: document.getElementById('loyaltyName').value,
                            description: document.getElementById('loyaltyDescription').value,
                            pointsCost: parseInt(document.getElementById('loyaltyPoints').value) || 0,
                            category: category,
                            limitPerCustomer: parseInt(document.getElementById('loyaltyLimit').value) || null,
                            expiresAfterDays: parseInt(document.getElementById('loyaltyExpires').value) || null,
                            order: item.order || index,
                            // Date/day restrictions
                            hasDateRestrictions: document.getElementById('loyaltyHasDateRestrictions').checked,
                            availableDays: selectedDays,
                            validFrom: document.getElementById('loyaltyValidFrom').value || null,
                            validUntil: document.getElementById('loyaltyValidUntil').value || null,
                            specialEventsOnly: document.getElementById('loyaltySpecialEventsOnly').checked || false,
                            // Image fields
                            imageUrl: window.tempLoyaltyImageUrl || null,
                            imageArtId: window.tempLoyaltyArtId || null,
                            imageStyle: document.getElementById('loyaltyImageStyle')?.value || 'thumbnail'
                        };

                        // Add discount percentage if category is discount_coupon
                        if (category === 'discount_coupon') {
                            items[index].discountPercentage = parseInt(document.getElementById('loyaltyDiscountPercentage').value) || 0;
                        }
                        
                        try {
                            NewcoData.set('loyaltyItems', items);
                        } catch (e) {
                            console.warn('Could not save to localStorage, keeping in memory:', e);
                            window.tempLoyaltyItems = items;
                        }

                        closeModal();
                        loadLoyaltyItems();
                        showSuccess(`Loyalty item "${items[index].name}" updated successfully`);
                    }

                    updateLoyaltyItem();
                };
            }, 100);
        }
        
        function deleteLoyaltyItem(index) {
            showConfirm(
                'Are you sure you want to delete this loyalty item?',
                () => {
                    const loyaltyItems = NewcoData.get('loyaltyItems') || [];
                    const deleted = loyaltyItems.splice(index, 1)[0];
                    NewcoData.set('loyaltyItems', loyaltyItems);
                    loadLoyaltyItems();
                    showSuccess(`Loyalty item "${deleted.name}" deleted successfully`);
                },
                'Delete Loyalty Item'
            );
        }
        
        function moveLoyaltyItem(index, direction) {
            const loyaltyItems = NewcoData.get('loyaltyItems') || [];
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < loyaltyItems.length) {
                [loyaltyItems[index], loyaltyItems[newIndex]] = [loyaltyItems[newIndex], loyaltyItems[index]];
                loyaltyItems.forEach((item, i) => item.order = i);
                NewcoData.set('loyaltyItems', loyaltyItems);
                loadLoyaltyItems();
            }
        }
        
        // Sales Items Management Functions
        function loadSalesItems() {
            const items = window.tempSalesItems || NewcoData.get('salesItems') || [];
            const container = document.getElementById('salesItemsContainer');
            
            if (items.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No basic offerings created yet. Click "Create Examples" for quick setup or "Add Offering" to create your first basic bingo item.</p>';
                return;
            }
            
            let html = '<div class="offerings-grid">';
            
            items.forEach((item, index) => {
                let loyaltyInfo = '';
                if (item.canBuyWithLoyalty) {
                    loyaltyInfo = `${item.loyaltyPointsCost || 0} pts`;
                }
                
                let bonusInfo = '';
                if (item.givesBonus) {
                    if (item.bonusType === 'fixed') {
                        bonusInfo = `+${item.bonusFixed || 0}`;
                    } else if (item.bonusType === 'multiplier') {
                        bonusInfo = `${item.bonusMultiplier || 1}x`;
                    }
                }
                
                
                html += `
                <div class="offering-card">
                    <div class="offering-card-header">
                        <div class="offering-card-title">
                            <span>${item.name}</span>
                        </div>
                    </div>
                    <div class="offering-card-body">
                        <div class="offering-card-description">
                            ${item.description || 'No description provided'}
                        </div>
                        <div class="offering-card-stats">
                            <div class="offering-stat">
                                <span class="offering-stat-label">Price</span>
                                <span class="offering-stat-value">$${item.price}</span>
                            </div>
                            <div class="offering-stat">
                                <span class="offering-stat-label">Loyalty Price</span>
                                <span class="offering-stat-value">${loyaltyInfo || 'N/A'}</span>
                            </div>
                            <div class="offering-stat">
                                <span class="offering-stat-label">Display #</span>
                                <span class="offering-stat-value">${item.displayOrder || index + 1}</span>
                            </div>
                            ${item.limitPerCustomer ? `<div class="offering-stat">
                                <span class="offering-stat-label">Limit</span>
                                <span class="offering-stat-value">${item.limitPerCustomer}/customer</span>
                            </div>` : ''}
                        </div>
                        <div class="offering-card-badges">
                            ${item.canBuyWithLoyalty ? '<span class="offering-badge loyalty">💳 Loyalty Option</span>' : ''}
                            ${item.givesBonus ? 
                                (item.bonusType === 'multiplier' ? 
                                    `<span class="offering-badge bonus">⭐ ${bonusInfo} Points</span>` : 
                                    `<span class="offering-badge bonus">⭐ ${bonusInfo} Bonus</span>`
                                ) : ''}
                            ${item.hasDateRestrictions ? '<span class="offering-badge" style="background: #f97316; color: white;">📅 Date Restricted</span>' : ''}
                            ${item.specialEventsOnly ? '<span class="offering-badge" style="background: #8b5cf6; color: white;">🎉 Special Events Only</span>' : ''}
                        </div>
                    </div>
                    <div class="offering-card-actions">
                        <button class="btn btn-secondary" onclick="editSalesItem(${index})">✏️ Edit</button>
                        <button class="btn btn-danger" onclick="deleteSalesItem(${index})">🗑️ Delete</button>
                        <div style="display: flex; gap: 0.25rem;">
                            <button class="btn btn-outline" onclick="moveSalesItem(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="btn btn-outline" onclick="moveSalesItem(${index}, 1)" ${index === items.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                    </div>
                </div>`;
            });

            html += '</div>';
            container.innerHTML = html;

            // Update button states after loading
            updateExampleButtonStates();
        }

        function addSalesItem() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Basic Offering';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input type="text" class="form-input" id="itemName" placeholder="e.g., Extra Card Pack">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="itemDescription" rows="2" placeholder="Brief description of the item"></textarea>
                </div>

                <!-- Art/Image Section -->
                <div style="border: 1px solid var(--gray-light); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--light-gray);">
                    <h4 style="margin: 0 0 0.75rem 0; color: var(--primary-dark); font-size: 0.95rem;">🎨 Item Image (Optional)</h4>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="openArtLibraryForSalesItem()" style="width: 100%;">
                            📚 Choose from Art Library
                        </button>
                    </div>
                    <div id="salesItemImagePreview" style="margin-top: 0.5rem; display: none;">
                        <img id="salesItemImagePreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid var(--primary);">
                        <button type="button" class="btn btn-danger btn-small" onclick="clearSalesItemImage()" style="margin-top: 0.5rem; width: 100%;">Remove Image</button>
                    </div>
                    <div class="form-group" style="margin-top: 0.75rem;">
                        <label class="form-label">Image Display Style</label>
                        <select class="form-select" id="salesItemImageStyle">
                            <option value="thumbnail">Thumbnail (small image next to name)</option>
                            <option value="banner">Banner (wide image above item)</option>
                            <option value="background">Background (image fills card)</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-input" id="itemPrice" min="0" step="0.01" placeholder="5.00">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Used for package pricing calculations</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="itemPackageOnly"> Package Only (cannot buy individually)
                        </label>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only available as part of packages</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="itemLoyalty" onchange="toggleLoyaltyPoints(this)"> Can also buy with loyalty points
                    </label>
                </div>
                <div class="form-group" id="loyaltyPointsCostGroup" style="display: none;">
                    <label class="form-label">Loyalty Points Cost</label>
                    <input type="number" class="form-input" id="itemLoyaltyPointsCost" min="0" placeholder="50">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Display Order #</label>
                        <input type="number" class="form-input" id="itemDisplayOrder" min="1" placeholder="1" value="${(NewcoData.get('salesItems') || []).length + 1}">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Order shown on website</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Limit Per Customer</label>
                        <input type="number" class="form-input" id="itemLimitPerCustomer" min="0" placeholder="0">
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">0 = unlimited</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="itemGivesBonus" onchange="toggleBonusPoints(this)"> Gives bonus loyalty points
                    </label>
                </div>
                <div class="form-grid" id="bonusPointsGroup" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Bonus Type</label>
                        <select class="form-select" id="itemBonusType" onchange="toggleBonusType(this)">
                            <option value="fixed">Fixed Amount</option>
                            <option value="multiplier">Multiplier</option>
                        </select>
                    </div>
                    <div class="form-group" id="fixedBonusGroup">
                        <label class="form-label">Bonus Points</label>
                        <input type="number" class="form-input" id="itemBonusFixed" min="0" placeholder="10">
                    </div>
                    <div class="form-group" id="multiplierBonusGroup" style="display: none;">
                        <label class="form-label">Points Multiplier (e.g., 2 for double)</label>
                        <input type="number" class="form-input" id="itemBonusMultiplier" min="1" step="0.5" placeholder="2">
                    </div>
                </div>
                
                <!-- Day/Date Eligibility Section -->
                <div class="form-group">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-dark); font-size: 1rem; border-bottom: 1px solid var(--gray-light); padding-bottom: 0.5rem;">📅 Day/Date Eligibility</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="itemHasDateRestrictions" onchange="toggleDateRestrictions(this)"> Restrict to specific days/dates
                    </label>
                </div>
                
                <div id="dateRestrictionsGroup" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Available Days</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayMon" value="monday"> Mon
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayTue" value="tuesday"> Tue
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayWed" value="wednesday"> Wed
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayThu" value="thursday"> Thu
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDayFri" value="friday"> Fri
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDaySat" value="saturday"> Sat
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem;">
                                    <input type="checkbox" id="itemDaySun" value="sunday"> Sun
                                </label>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only available on selected days</p>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Valid From Date</label>
                            <input type="date" class="form-input" id="itemValidFrom">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no start date</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valid Until Date</label>
                            <input type="date" class="form-input" id="itemValidUntil">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave empty for no end date</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="itemSpecialEventsOnly"> Only available during special events
                        </label>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Item only shows when sessions are marked as special events</p>
                    </div>
                </div>
                
            `;
            
            // Add helper functions for toggling
            window.toggleLoyaltyPoints = function(checkbox) {
                document.getElementById('loyaltyPointsCostGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.toggleBonusPoints = function(checkbox) {
                document.getElementById('bonusPointsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            window.toggleBonusType = function(select) {
                document.getElementById('fixedBonusGroup').style.display = select.value === 'fixed' ? 'block' : 'none';
                document.getElementById('multiplierBonusGroup').style.display = select.value === 'multiplier' ? 'block' : 'none';
            };
            
            window.toggleDateRestrictions = function(checkbox) {
                document.getElementById('dateRestrictionsGroup').style.display = checkbox.checked ? 'block' : 'none';
            };
            
            
            modalSaveBtn.onclick = () => {
                    const items = NewcoData.get('salesItems') || [];
                    const itemId = Date.now().toString();
                    
                    // Collect selected days
                    const selectedDays = [];
                    if (document.getElementById('itemHasDateRestrictions').checked) {
                        if (document.getElementById('itemDayMon').checked) selectedDays.push('monday');
                        if (document.getElementById('itemDayTue').checked) selectedDays.push('tuesday');
                        if (document.getElementById('itemDayWed').checked) selectedDays.push('wednesday');
                        if (document.getElementById('itemDayThu').checked) selectedDays.push('thursday');
                        if (document.getElementById('itemDayFri').checked) selectedDays.push('friday');
                        if (document.getElementById('itemDaySat').checked) selectedDays.push('saturday');
                        if (document.getElementById('itemDaySun').checked) selectedDays.push('sunday');
                    }
                    
                    const newItem = {
                        id: itemId,
                        name: document.getElementById('itemName').value,
                        description: document.getElementById('itemDescription').value,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        packageOnly: document.getElementById('itemPackageOnly').checked || false,
                        canBuyWithLoyalty: document.getElementById('itemLoyalty').checked,
                        loyaltyPointsCost: document.getElementById('itemLoyalty').checked ?
                            parseInt(document.getElementById('itemLoyaltyPointsCost').value) || 0 : null,
                        givesBonus: document.getElementById('itemGivesBonus').checked,
                        bonusType: document.getElementById('itemGivesBonus').checked ?
                            document.getElementById('itemBonusType').value : null,
                        bonusFixed: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'fixed' ?
                            parseInt(document.getElementById('itemBonusFixed').value) || 0 : null,
                        bonusMultiplier: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'multiplier' ?
                            parseFloat(document.getElementById('itemBonusMultiplier').value) || 1 : null,
                        displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || items.length + 1,
                        limitPerCustomer: parseInt(document.getElementById('itemLimitPerCustomer').value) || 0,
                        // Date/day restrictions
                        hasDateRestrictions: document.getElementById('itemHasDateRestrictions').checked,
                        availableDays: selectedDays,
                        validFrom: document.getElementById('itemValidFrom').value || null,
                        validUntil: document.getElementById('itemValidUntil').value || null,
                        specialEventsOnly: document.getElementById('itemSpecialEventsOnly').checked || false,
                        // Image fields
                        imageUrl: window.tempSalesItemImageUrl || null,
                        imageArtId: window.tempSalesItemArtId || null,
                        imageStyle: document.getElementById('salesItemImageStyle')?.value || 'thumbnail'
                    };
                    
                    items.push(newItem);
                    
                    try {
                        NewcoData.set('salesItems', items);
                    } catch (e) {
                        console.warn('Could not save to localStorage, keeping in memory:', e);
                        window.tempSalesItems = items;
                    }
                    
                    closeModal();
                    loadSalesItems();
                    showSuccess(`Offering "${newItem.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }

        // Sales item art library functions
        function openArtLibraryForSalesItem() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            if (typeof ArtPicker !== 'undefined' && typeof ArtPicker.open === 'function') {
                ArtPicker.open((selectedArt) => {
                    window.tempSalesItemArtId = selectedArt.id;
                    window.tempSalesItemImageUrl = selectedArt.file_data;

                    const preview = document.getElementById('salesItemImagePreview');
                    const previewImg = document.getElementById('salesItemImagePreviewImg');

                    if (preview && previewImg) {
                        previewImg.src = selectedArt.file_data;
                        preview.style.display = 'block';
                    }
                }, customerId);
            } else {
                showError('Art library not available. Please ensure art-picker.js is loaded.');
            }
        }

        function clearSalesItemImage() {
            window.tempSalesItemArtId = null;
            window.tempSalesItemImageUrl = null;

            const preview = document.getElementById('salesItemImagePreview');
            if (preview) {
                preview.style.display = 'none';
            }
        }

        function editSalesItem(index) {
            const items = NewcoData.get('salesItems') || [];
            const item = items[index];
            if (!item) return;
            
            // Use the same form as addSalesItem but with pre-filled values
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Edit Basic Offering';
            
            // Copy the same form from addSalesItem
            modalBody.innerHTML = addSalesItem.toString().match(/modalBody\.innerHTML = `([\s\S]*?)`/)[1];
            
            // Pre-fill the form with existing values
            setTimeout(() => {
                document.getElementById('itemName').value = item.name || '';
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('itemPrice').value = item.price || '';
                document.getElementById('itemPackageOnly').checked = item.packageOnly || false;
                document.getElementById('itemLoyalty').checked = item.canBuyWithLoyalty || false;
                if (item.canBuyWithLoyalty) {
                    document.getElementById('loyaltyPointsCostGroup').style.display = 'block';
                    document.getElementById('itemLoyaltyPointsCost').value = item.loyaltyPointsCost || '';
                }
                document.getElementById('itemDisplayOrder').value = item.displayOrder || index + 1;
                document.getElementById('itemLimitPerCustomer').value = item.limitPerCustomer || 0;
                document.getElementById('itemGivesBonus').checked = item.givesBonus || false;
                if (item.givesBonus) {
                    document.getElementById('bonusPointsGroup').style.display = 'grid';
                    document.getElementById('itemBonusType').value = item.bonusType || 'fixed';
                    if (item.bonusType === 'fixed') {
                        document.getElementById('fixedBonusGroup').style.display = 'block';
                        document.getElementById('multiplierBonusGroup').style.display = 'none';
                        document.getElementById('itemBonusFixed').value = item.bonusFixed || '';
                    } else {
                        document.getElementById('fixedBonusGroup').style.display = 'none';
                        document.getElementById('multiplierBonusGroup').style.display = 'block';
                        document.getElementById('itemBonusMultiplier').value = item.bonusMultiplier || '';
                    }
                }
                
                // Load date/day restrictions
                document.getElementById('itemHasDateRestrictions').checked = item.hasDateRestrictions || false;
                if (item.hasDateRestrictions) {
                    document.getElementById('dateRestrictionsGroup').style.display = 'block';
                    // Set available days
                    if (item.availableDays && item.availableDays.length > 0) {
                        document.getElementById('itemDayMon').checked = item.availableDays.includes('monday');
                        document.getElementById('itemDayTue').checked = item.availableDays.includes('tuesday');
                        document.getElementById('itemDayWed').checked = item.availableDays.includes('wednesday');
                        document.getElementById('itemDayThu').checked = item.availableDays.includes('thursday');
                        document.getElementById('itemDayFri').checked = item.availableDays.includes('friday');
                        document.getElementById('itemDaySat').checked = item.availableDays.includes('saturday');
                        document.getElementById('itemDaySun').checked = item.availableDays.includes('sunday');
                    }
                    // Set date range
                    document.getElementById('itemValidFrom').value = item.validFrom || '';
                    document.getElementById('itemValidUntil').value = item.validUntil || '';
                    // Set special events only
                    document.getElementById('itemSpecialEventsOnly').checked = item.specialEventsOnly || false;
                }
            }, 100);
            
            // Override save function to update instead of create
            modalSaveBtn.onclick = () => {
                const bannerArtInput = document.getElementById('itemBannerArt');
                const backgroundArtInput = document.getElementById('itemBackgroundArt');
                let bannerArtData = null;
                let backgroundArtData = null;
                let pendingUploads = 0;
                
                function checkAndSave() {
                    if (pendingUploads === 0) {
                        updateItem();
                    }
                }
                
                if (bannerArtInput && bannerArtInput.files[0]) {
                    pendingUploads++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        bannerArtData = e.target.result;
                        pendingUploads--;
                        checkAndSave();
                    };
                    reader.readAsDataURL(bannerArtInput.files[0]);
                }
                
                if (backgroundArtInput && backgroundArtInput.files[0]) {
                    pendingUploads++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        backgroundArtData = e.target.result;
                        pendingUploads--;
                        checkAndSave();
                    };
                    reader.readAsDataURL(backgroundArtInput.files[0]);
                }
                
                if (pendingUploads === 0) {
                    checkAndSave();
                }
                
                function updateItem() {
                    const items = NewcoData.get('salesItems') || [];
                    
                    // Collect selected days
                    const selectedDays = [];
                    if (document.getElementById('itemHasDateRestrictions').checked) {
                        if (document.getElementById('itemDayMon').checked) selectedDays.push('monday');
                        if (document.getElementById('itemDayTue').checked) selectedDays.push('tuesday');
                        if (document.getElementById('itemDayWed').checked) selectedDays.push('wednesday');
                        if (document.getElementById('itemDayThu').checked) selectedDays.push('thursday');
                        if (document.getElementById('itemDayFri').checked) selectedDays.push('friday');
                        if (document.getElementById('itemDaySat').checked) selectedDays.push('saturday');
                        if (document.getElementById('itemDaySun').checked) selectedDays.push('sunday');
                    }
                    
                    items[index] = {
                        id: item.id,
                        name: document.getElementById('itemName').value,
                        description: document.getElementById('itemDescription').value,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        packageOnly: document.getElementById('itemPackageOnly').checked || false,
                        canBuyWithLoyalty: document.getElementById('itemLoyalty').checked,
                        loyaltyPointsCost: document.getElementById('itemLoyalty').checked ?
                            parseInt(document.getElementById('itemLoyaltyPointsCost').value) || 0 : null,
                        givesBonus: document.getElementById('itemGivesBonus').checked,
                        bonusType: document.getElementById('itemGivesBonus').checked ?
                            document.getElementById('itemBonusType').value : null,
                        bonusFixed: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'fixed' ?
                            parseInt(document.getElementById('itemBonusFixed').value) || 0 : null,
                        bonusMultiplier: document.getElementById('itemGivesBonus').checked && document.getElementById('itemBonusType').value === 'multiplier' ?
                            parseFloat(document.getElementById('itemBonusMultiplier').value) || 1 : null,
                        displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || index + 1,
                        limitPerCustomer: parseInt(document.getElementById('itemLimitPerCustomer').value) || 0,
                        // Date/day restrictions
                        hasDateRestrictions: document.getElementById('itemHasDateRestrictions').checked,
                        availableDays: selectedDays,
                        validFrom: document.getElementById('itemValidFrom').value || null,
                        validUntil: document.getElementById('itemValidUntil').value || null,
                        specialEventsOnly: document.getElementById('itemSpecialEventsOnly').checked || false
                    };
                    
                    NewcoData.set('salesItems', items);
                    
                    closeModal();
                    loadSalesItems();
                    showSuccess(`Offering "${items[index].name}" updated successfully`);
                }
            };
            
            modal.classList.add('active');
        }
        
        function deleteSalesItem(index) {
            showConfirm(
                'Are you sure you want to delete this offering?',
                () => {
                    const items = NewcoData.get('salesItems') || [];
                    const deleted = items.splice(index, 1)[0];
                    NewcoData.set('salesItems', items);
                    loadSalesItems();
                    showSuccess(`Offering "${deleted.name}" deleted successfully`);
                },
                'Delete Item'
            );
        }
        
        function moveSalesItem(index, direction) {
            const items = NewcoData.get('salesItems') || [];
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < items.length) {
                [items[index], items[newIndex]] = [items[newIndex], items[index]];
                items.forEach((item, i) => item.order = i);
                NewcoData.set('salesItems', items);
                loadSalesItems();
            }
        }
        
        // Modal functions
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Store timeout ID to prevent multiple timeouts
        let alertModalTimeout = null;

        // Reusable Alert/Confirm Modal System
        function showModal(options) {
            const defaults = {
                title: 'Alert',
                message: '',
                type: 'info', // info, success, warning, error, confirm
                confirmText: 'OK',
                cancelText: 'Cancel',
                onConfirm: null,
                onCancel: null,
                showCancel: false
            };
            
            const config = { ...defaults, ...options };
            
            // Create or get alert modal
            let alertModal = document.getElementById('alertModal');
            if (!alertModal) {
                alertModal = document.createElement('div');
                alertModal.id = 'alertModal';
                alertModal.className = 'modal';
                alertModal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; max-height: 80vh; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                        <div class="modal-header" id="modalHeaderColor" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 1.5rem; flex-shrink: 0;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span id="alertIcon" style="font-size: 2rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"></span>
                                <h2 class="modal-title" id="alertTitle" style="margin: 0; color: white; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);"></h2>
                            </div>
                        </div>
                        <div id="alertBody" style="padding: 2rem; color: var(--gray-dark); line-height: 1.6; font-size: 1.05rem; background: white; overflow-y: auto; flex: 1;">
                            <!-- Message content -->
                        </div>
                        <div class="modal-footer" id="alertFooter" style="background: var(--gray-lighter); padding: 1rem 1.5rem; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 0.75rem; justify-content: flex-end; flex-shrink: 0;">
                            <!-- Buttons -->
                        </div>
                    </div>
                `;
                document.body.appendChild(alertModal);
            }
            
            // Set icon based on type
            const icons = {
                info: '💡',
                success: '✅',
                warning: '⚠️',
                error: '❌',
                confirm: '❓'
            };
            
            const headerColors = {
                info: 'linear-gradient(135deg, #2196f3, #1976d2)',
                success: 'linear-gradient(135deg, #4caf50, #388e3c)',
                warning: 'linear-gradient(135deg, #ff9800, #f57c00)',
                error: 'linear-gradient(135deg, #f44336, #d32f2f)',
                confirm: 'linear-gradient(135deg, var(--primary), var(--primary-dark))'
            };
            
            document.getElementById('alertIcon').textContent = icons[config.type] || icons.info;
            document.getElementById('alertTitle').textContent = config.title;
            document.getElementById('alertBody').innerHTML = config.message;
            
            // Apply header color based on type
            const header = document.getElementById('modalHeaderColor');
            if (header) {
                header.style.background = headerColors[config.type] || headerColors.info;
            }
            
            // Set up buttons with better styling
            const footer = document.getElementById('alertFooter');
            footer.innerHTML = '';
            
            if (config.type === 'confirm' || config.showCancel) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.style.padding = '0.625rem 1.5rem';
                cancelBtn.style.borderRadius = '8px';
                cancelBtn.style.fontWeight = '500';
                cancelBtn.textContent = config.cancelText;
                cancelBtn.onclick = () => {
                    alertModal.classList.remove('active');
                    if (config.onCancel) config.onCancel();
                };
                footer.appendChild(cancelBtn);
            }
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = config.type === 'error' ? 'btn btn-danger' : 'btn btn-primary';
            confirmBtn.style.padding = '0.625rem 1.5rem';
            confirmBtn.style.borderRadius = '8px';
            confirmBtn.style.fontWeight = '500';
            confirmBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            confirmBtn.textContent = config.confirmText;
            confirmBtn.onclick = () => {
                alertModal.classList.remove('active');
                if (config.onConfirm) config.onConfirm();
            };
            footer.appendChild(confirmBtn);
            
            // Clear any existing timeout
            if (alertModalTimeout) {
                clearTimeout(alertModalTimeout);
                alertModalTimeout = null;
            }

            // Show modal
            alertModal.classList.add('active');
        }
        
        // Convenience functions
        function showAlert(message, title = 'Alert') {
            showModal({ type: 'info', title, message });
        }
        
        function showSuccess(message, title = 'Success') {
            showModal({ type: 'success', title, message });
        }
        
        function showError(message, title = 'Error') {
            showModal({ type: 'error', title, message });
        }
        
        function showConfirm(message, onConfirm, title = 'Confirm') {
            showModal({
                type: 'confirm',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                onConfirm
            });
        }

        function showComingSoon(featureName) {
            // Clear all active nav items since this isn't a real section
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            showModal({
                title: `${featureName} - Coming Soon`,
                message: `<div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🚀</div>
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Coming Soon!</h3>
                    <p style="color: var(--gray); line-height: 1.6;">
                        The ${featureName} feature is currently in development and will be available in a future update.
                    </p>
                </div>`,
                confirmText: 'OK'
            });
        }

        // Page Builder Functions
        function loadPageBuilder() {
            // Initialize drag and drop
            initializeDragAndDrop();
        }

        function initializeDragAndDrop() {
            const components = document.querySelectorAll('.drag-component');
            const canvas = document.getElementById('pageCanvas');
            
            if (!canvas) {
                console.warn('pageCanvas element not found, skipping drag and drop initialization');
                return;
            }
            
            components.forEach(component => {
                component.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('component', e.target.dataset.component);
                    e.target.classList.add('dragging');
                });
                
                component.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            });
            
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const componentType = e.dataTransfer.getData('component');
                addComponentToCanvas(componentType);
            });
        }

        function addComponentToCanvas(type) {
            const canvas = document.getElementById('pageCanvas');
            
            // Clear placeholder text if it's the first component
            if (canvas.querySelector('p')) {
                canvas.innerHTML = '';
            }
            
            const component = document.createElement('div');
            component.className = 'page-component';
            component.dataset.componentType = type;
            
            let content = '';
            switch(type) {
                case 'header':
                    content = '<h2>Welcome to ' + (NewcoData.get("organization")?.name || 'Our Bingo Hall') + '</h2>';
                    break;
                case 'session-selector':
                    content = '<div>📅 Session Selector Component</div>';
                    break;
                case 'package-cards':
                    content = '<div>📦 Package Selection Cards</div>';
                    break;
                case 'seat-selector':
                    content = '<div>🪑 Seat Selection Grid</div>';
                    break;
                case 'pricing':
                    content = '<div>💰 Dynamic Pricing Display</div>';
                    break;
                case 'checkout':
                    content = '<div>🛒 Checkout Form</div>';
                    break;
                case 'text':
                    content = '<p contenteditable="true">Click to edit this text...</p>';
                    break;
                case 'image':
                    content = '<div>🖼️ Image Placeholder</div>';
                    break;
            }
            
            component.innerHTML = content + '<button class="remove-btn" onclick="removeComponent(this)">×</button>';
            canvas.appendChild(component);
            
            // Show properties for the new component
            showComponentProperties(component);
        }

        function removeComponent(btn) {
            btn.parentElement.remove();
        }

        function showComponentProperties(component) {
            const panel = document.getElementById('propertyPanel');
            const type = component.dataset.componentType;
            
            let properties = '<h4>' + type.charAt(0).toUpperCase() + type.slice(1) + ' Properties</h4>';
            
            switch(type) {
                case 'text':
                    properties += `
                        <div class="form-group">
                            <label class="form-label">Font Size</label>
                            <select class="form-select">
                                <option>Small</option>
                                <option>Medium</option>
                                <option>Large</option>
                            </select>
                        </div>`;
                    break;
                case 'package-cards':
                    properties += `
                        <div class="form-group">
                            <label class="form-label">Layout</label>
                            <select class="form-select">
                                <option>Grid</option>
                                <option>List</option>
                                <option>Carousel</option>
                            </select>
                        </div>`;
                    break;
                // Add more property panels for different components
            }
            
            panel.innerHTML = properties;
        }

        // ═══════════════════════════════════════════════════════════════════
        // WEB TEMPLATES FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let selectedTemplate = 'modern';
        let selectedTemplateStyle = 'modern-components'; // Default template

        function selectTemplate(templateStyle) {
            selectedTemplateStyle = templateStyle;

            // Update visual selection
            const modernCard = document.getElementById('templateModernComponents');
            const minimalCard = document.getElementById('templateMinimalModern');

            if (templateStyle === 'modern-components') {
                modernCard.style.borderColor = 'var(--primary)';
                minimalCard.style.borderColor = 'transparent';
                document.getElementById('currentTemplateLabel').textContent = 'Modern Components';
                document.getElementById('templateFeaturesLabel').textContent = 'Includes: Header, Carousel, Sessions, Side Alerts';
            } else {
                modernCard.style.borderColor = 'transparent';
                minimalCard.style.borderColor = 'var(--primary)';
                document.getElementById('currentTemplateLabel').textContent = 'Minimal Modern';
                document.getElementById('templateFeaturesLabel').textContent = 'Includes: Header, Sessions';
            }

            // Save to storage
            const webBuilder = NewcoData.get('webBuilder') || {};
            webBuilder.templateStyle = templateStyle;
            webBuilder.carouselEnabled = (templateStyle === 'modern-components');
            webBuilder.alertsEnabled = (templateStyle === 'modern-components');
            NewcoData.set('webBuilder', webBuilder);

            // Update preview if function exists
            if (typeof generateTemplatePreview === 'function') {
                generateTemplatePreview();
            }

            showModal({
                title: '✅ Template Selected',
                message: `Your booking page will now use the "${templateStyle === 'modern-components' ? 'Modern Components' : 'Minimal Modern'}" layout.`,
                type: 'success'
            });
        }

        // Initialize template selection on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved template style
            const webBuilder = NewcoData.get('webBuilder') || {};
            if (webBuilder.templateStyle) {
                selectTemplate(webBuilder.templateStyle);
            }
        });
        
        function updateApplyToHallButtons() {
            const buttonsContainer = document.getElementById('applyToHallButtons');
            const halls = NewcoData.get('halls') || [];
            
            if (!buttonsContainer) return;
            
            // Clear existing buttons
            buttonsContainer.innerHTML = '';
            
            // Only show buttons if a template is selected
            if (!selectedTemplate) {
                return;
            }
            
            // Create a button for each hall
            halls.forEach(hall => {
                const button = document.createElement('button');
                button.className = 'btn btn-primary';
                button.textContent = `Apply to ${hall.name}`;
                button.onclick = () => applyTemplateToHall(hall.id, hall.name);
                buttonsContainer.appendChild(button);
            });
        }
        
        function applyTemplateToHall(hallId, hallName) {
            if (!selectedTemplate) {
                showModal({
                    title: '⚠️ No Template Selected',
                    message: 'Please select a template first.',
                    type: 'warning'
                });
                return;
            }
            
            // Apply the selected template to the hall
            // This would update the hall's web configuration
            showModal({
                title: '✅ Template Applied',
                message: `The ${selectedTemplate} template has been applied to ${hallName}.`,
                type: 'success'
            });
            
            // TODO: Save template configuration to hall settings
            const halls = NewcoData.get('halls') || [];
            const hallIndex = halls.findIndex(h => h.id === hallId);
            if (hallIndex !== -1) {
                halls[hallIndex].webTemplate = selectedTemplate;
                NewcoData.set('halls', halls);
            }
        }
        
        function generateTemplatePreview() {
            const preview = document.getElementById('templatePreview');

            // Template preview was removed - just return
            if (!preview) return;

            const packages = NewcoData.get('packages') || [];
            const basicOfferings = NewcoData.get('basicOfferings') || [];

            // Update Apply to Hall buttons
            updateApplyToHallButtons();

            const templates = {
                classic: {
                    colors: { primary: '#667eea', secondary: '#764ba2', accent: '#9575cd' },
                    name: 'Classic Bingo Theme',
                    style: 'traditional'
                },
                modern: {
                    colors: { primary: '#2ea3f2', secondary: '#1a5f8a', accent: '#42a5f5' },
                    name: 'Modern Blue Theme', 
                    style: 'clean'
                },
                vibrant: {
                    colors: { primary: '#fa709a', secondary: '#fee140', accent: '#ff7043' },
                    name: 'Vibrant Fun Theme',
                    style: 'colorful'
                }
            };
            
            const template = templates[selectedTemplate];
            if (!template) return;
            
            preview.innerHTML = `
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto;">
                    <!-- Template Header -->
                    <div style="background: linear-gradient(135deg, ${template.colors.primary} 0%, ${template.colors.secondary} 100%); padding: 2rem; text-align: center; color: white;">
                        <h1 style="margin: 0 0 0.5rem; font-size: 2rem; font-weight: 700;">Welcome to Our Bingo Hall</h1>
                        <p style="margin: 0; opacity: 0.9; font-size: 1.1rem;">Book your session today!</p>
                    </div>
                    
                    <!-- Sample Packages -->
                    <div style="padding: 2rem;">
                        <h2 style="margin: 0 0 1.5rem; color: ${template.colors.primary}; font-size: 1.5rem;">Available Packages</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            ${packages.slice(0, 3).map(pkg => `
                                <div style="background: var(--gray-lighter); border-radius: 8px; padding: 1.5rem; border: 2px solid transparent; transition: all 0.3s;">
                                    <h3 style="margin: 0 0 0.5rem; color: ${template.colors.primary};">${pkg.name}</h3>
                                    <p style="margin: 0 0 1rem; color: var(--gray); font-size: 0.875rem;">${pkg.description || 'Package description'}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 1.25rem; font-weight: 700; color: ${template.colors.secondary};">$${pkg.price || '25'}</span>
                                        <button style="background: ${template.colors.primary}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Select</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${packages.length === 0 ? `
                                <div style="background: var(--gray-lighter); border-radius: 8px; padding: 1.5rem;">
                                    <h3 style="margin: 0 0 0.5rem; color: ${template.colors.primary};">Sample Package</h3>
                                    <p style="margin: 0 0 1rem; color: var(--gray); font-size: 0.875rem;">This is how your packages will appear</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 1.25rem; font-weight: 700; color: ${template.colors.secondary};">$25</span>
                                        <button style="background: ${template.colors.primary}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px;">Select</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Sample Basic Offerings -->
                        ${basicOfferings.length > 0 ? `
                            <h3 style="margin: 2rem 0 1rem; color: ${template.colors.primary};">Additional Options</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                ${basicOfferings.slice(0, 4).map(offer => `
                                    <div style="background: ${template.colors.accent}20; padding: 0.75rem 1rem; border-radius: 6px; border: 1px solid ${template.colors.accent}40;">
                                        <span style="font-weight: 600; color: ${template.colors.primary};">${offer.name}</span>
                                        <span style="margin-left: 0.5rem; color: var(--gray);">$${offer.price || '5'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Sample Booking Button -->
                    <div style="padding: 0 2rem 2rem; text-align: center;">
                        <button style="background: linear-gradient(135deg, ${template.colors.primary} 0%, ${template.colors.secondary} 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            Complete Booking
                        </button>
                    </div>
                </div>
            `;
        }
        
        function previewSelectedTemplate() {
            if (!selectedTemplate) {
                showModal({
                    title: '⚠️ No Template Selected',
                    message: 'Please select a template first.',
                    type: 'warning'
                });
                return;
            }
            
            const previewWindow = window.open('', 'templatePreview', 'width=1200,height=800');
            const previewContent = document.getElementById('templatePreview').innerHTML;
            
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Template Preview - ${selectedTemplate}</title>
                    <style>
                        body { 
                            font-family: Inter, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            background: #f5f5f5;
                        }
                        :root {
                            --gray: #6b7280;
                            --gray-lighter: #f9fafb;
                        }
                    </style>
                </head>
                <body>
                    ${previewContent}
                </body>
                </html>
            `);
            previewWindow.document.close();
        }
        
        function launchWebsite() {
            // Open the customer website in a new window/tab
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-customer-demo-v2.2.html?customer=${customerId}`, '_blank');
        }

        function launchCustomerSite() {
            // Open the customer demo site in a new tab
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-customer-demo-v2.2.html?customer=${customerId}`, '_blank');
        }
        
        function useSelectedTemplate() {
            if (!selectedTemplate) {
                showModal({
                    title: '⚠️ No Template Selected',
                    message: 'Please select a template first.',
                    type: 'warning'
                });
                return;
            }
            
            // Save selected template to NewcoData
            NewcoData.set('selectedWebTemplate', {
                template: selectedTemplate,
                timestamp: new Date().toISOString()
            });
            
            showModal({
                title: '✅ Template Selected',
                message: `The ${selectedTemplate} template has been set as your web template. You can now customize it further in the Web Builder.`,
                type: 'success'
            });
        }

        function generateBookingHTML(components) {
            // Generate complete HTML with embedded NewcoData
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Bingo Session</title>
    <style>
        /* Generated styles */
        body { font-family: Inter, sans-serif; }
    </style>
</head>
<body>
    <!-- Generated booking page -->
    ${Array.from(components).map(c => c.innerHTML.replace(/<button class="remove-btn".*?<\/button>/, '')).join('')}
</body>
</html>`;
        }

        // Schedule Functions
        // Session Management Functions
        function loadSessions() {
            const sessions = NewcoData.get('sessions') || [];
            const halls = NewcoData.get('halls') || [];
            const container = document.getElementById('sessionsContainer');
            
            if (halls.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No halls configured. Please add halls first.</p>';
                return;
            }
            
            if (sessions.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No sessions configured yet. Click "Add Session" to create recurring sessions.</p>';
                return;
            }
            
            container.innerHTML = sessions.map((session, index) => {
                const hall = halls.find(h => h.id === session.hallId) || halls[0];
                return `
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #333;">${session.name}</h4>
                            <div style="display: flex; gap: 2rem; font-size: 0.875rem; color: #666;">
                                <span>📍 ${hall ? hall.name : 'Hall 1'}</span>
                                <span>🕐 ${session.startTime} - ${session.endTime}</span>
                                <span>📅 ${session.days && session.days.length > 0 ? session.days.join(', ') : 'Every day'}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="addArtToSession(${index})">📚 Add Art</button>
                            <button class="btn btn-secondary btn-sm" onclick="editSession(${index})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSession(${index})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addSession() {
            const halls = NewcoData.get('halls') || [];
            if (halls.length === 0) {
                // Create default Hall 1 if none exists
                const defaultHall = {
                    id: 'hall-1',
                    name: 'Hall 1',
                    address: '',
                    capacity: 100,
                    layout: { rows: 10, cols: 10, cells: {} }
                };
                halls.push(defaultHall);
                NewcoData.set('halls', halls);
            }
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Add Session Template';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Session Name</label>
                    <input type="text" class="form-input" id="sessionName" placeholder="e.g., Evening Session">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hall</label>
                    <select class="form-select" id="sessionHall">
                        ${halls.map(hall => `<option value="${hall.id}">${hall.name}</option>`).join('')}
                    </select>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="time" class="form-input" id="sessionStartTime" value="18:00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="time" class="form-input" id="sessionEndTime" value="22:00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Days Available</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label><input type="checkbox" class="session-day" value="Monday"> Monday</label>
                        <label><input type="checkbox" class="session-day" value="Tuesday"> Tuesday</label>
                        <label><input type="checkbox" class="session-day" value="Wednesday" checked> Wednesday</label>
                        <label><input type="checkbox" class="session-day" value="Thursday"> Thursday</label>
                        <label><input type="checkbox" class="session-day" value="Friday" checked> Friday</label>
                        <label><input type="checkbox" class="session-day" value="Saturday" checked> Saturday</label>
                        <label><input type="checkbox" class="session-day" value="Sunday" checked> Sunday</label>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Leave all unchecked for every day</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="sessionSpecialEvent"> Special Event Session
                    </label>
                </div>

                <!-- Art/Image Section -->
                <div style="border: 1px solid var(--gray-light); border-radius: 8px; padding: 1rem; margin-top: 1rem; background: var(--light-gray);">
                    <h4 style="margin: 0 0 0.75rem 0; color: var(--primary-dark); font-size: 0.95rem;">🎨 Session Image (Optional)</h4>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="openArtLibraryForSession()" style="width: 100%;">
                            📚 Choose from Art Library
                        </button>
                    </div>
                    <div id="sessionImagePreview" style="margin-top: 0.5rem; display: none;">
                        <img id="sessionImagePreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid var(--primary);">
                        <button type="button" class="btn btn-danger btn-small" onclick="clearSessionImage()" style="margin-top: 0.5rem; width: 100%;">Remove Image</button>
                    </div>
                    <div class="form-group" style="margin-top: 0.75rem;">
                        <label class="form-label">Image Display Style</label>
                        <select class="form-select" id="sessionImageStyle">
                            <option value="thumbnail">Thumbnail (small image next to name)</option>
                            <option value="banner">Banner (wide image above session)</option>
                            <option value="background">Background (image fills card)</option>
                        </select>
                    </div>
                    <div id="sessionBackgroundOptions" style="margin-top: 0.75rem; display: none;">
                        <div class="form-group">
                            <label class="form-label">Background Opacity</label>
                            <input type="range" class="form-input" id="sessionBgOpacity" min="0" max="100" value="20"
                                   oninput="document.getElementById('sessionOpacityValue').textContent = this.value + '%'">
                            <div style="text-align: center; font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                <span id="sessionOpacityValue">20%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text Color (for background style)</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <label style="flex: 1; cursor: pointer;">
                                    <input type="radio" name="sessionTextColor" value="white" checked>
                                    <span style="color: white; background: #333; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center;">White</span>
                                </label>
                                <label style="flex: 1; cursor: pointer;">
                                    <input type="radio" name="sessionTextColor" value="yellow">
                                    <span style="color: #ffd700; background: #333; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center;">Yellow</span>
                                </label>
                                <label style="flex: 1; cursor: pointer;">
                                    <input type="radio" name="sessionTextColor" value="black">
                                    <span style="color: black; background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center; border: 1px solid #ddd;">Black</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Set up event listener after modal content is rendered
            setTimeout(() => {
                const styleSelect = document.getElementById('sessionImageStyle');
                if (styleSelect) {
                    styleSelect.addEventListener('change', function() {
                        const bgOptions = document.getElementById('sessionBackgroundOptions');
                        if (bgOptions) {
                            bgOptions.style.display = this.value === 'background' ? 'block' : 'none';
                        }
                    });
                }
            }, 0);

            modalSaveBtn.onclick = () => {
                const sessions = NewcoData.get('sessions') || [];
                const selectedDays = Array.from(document.querySelectorAll('.session-day:checked')).map(cb => cb.value);
                
                const imageStyle = document.getElementById('sessionImageStyle').value;
                const textColorInput = document.querySelector('input[name="sessionTextColor"]:checked');

                const newSession = {
                    id: 'session-' + Date.now(),
                    name: document.getElementById('sessionName').value,
                    hallId: document.getElementById('sessionHall').value,
                    startTime: document.getElementById('sessionStartTime').value,
                    endTime: document.getElementById('sessionEndTime').value,
                    days: selectedDays,
                    day: selectedDays[0] || 'Monday', // For compatibility
                    time: `${document.getElementById('sessionStartTime').value} - ${document.getElementById('sessionEndTime').value}`,
                    specialEvent: document.getElementById('sessionSpecialEvent').checked,
                    imageUrl: window.tempSessionImageUrl || null,
                    imageArtId: window.tempSessionArtId || null,
                    imageStyle: imageStyle,
                    bgOpacity: imageStyle === 'background' ? document.getElementById('sessionBgOpacity').value : 20,
                    textColor: imageStyle === 'background' && textColorInput ? textColorInput.value : 'white'
                };
                
                sessions.push(newSession);
                NewcoData.set('sessions', sessions);
                closeModal();
                loadSessions();
                showSuccess(`Session "${newSession.name}" added successfully`);
            };
            
            modal.classList.add('active');
        }
        
        function addArtToSession(index) {
            const sessions = NewcoData.get('sessions') || [];
            const session = sessions[index];
            if (!session) return;

            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            if (typeof ArtPicker !== 'undefined' && typeof ArtPicker.open === 'function') {
                ArtPicker.open((selectedArt) => {
                    // Open modal to configure image style
                    const modal = document.getElementById('modal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalBody = document.getElementById('modalBody');
                    const modalSaveBtn = document.getElementById('modalSaveBtn');

                    modalTitle.textContent = `Add Art to "${session.name}"`;
                    modalBody.innerHTML = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <img src="${selectedArt.file_data}" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Image Display Style</label>
                            <select class="form-select" id="sessionArtImageStyle">
                                <option value="thumbnail">Thumbnail (small image next to name)</option>
                                <option value="banner">Banner (wide image above session)</option>
                                <option value="background">Background (image fills card)</option>
                            </select>
                        </div>
                        <div id="sessionArtBackgroundOptions" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Background Opacity</label>
                                <input type="range" class="form-input" id="sessionArtBgOpacity" min="0" max="100" value="${session.bgOpacity || 20}"
                                       oninput="document.getElementById('sessionArtOpacityValue').textContent = this.value + '%'">
                                <div style="text-align: center; font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    <span id="sessionArtOpacityValue">${session.bgOpacity || 20}%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="sessionArtTextColor" value="white" ${(!session.textColor || session.textColor === 'white') ? 'checked' : ''}>
                                        <span style="color: white; background: #333; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center;">White</span>
                                    </label>
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="sessionArtTextColor" value="yellow" ${session.textColor === 'yellow' ? 'checked' : ''}>
                                        <span style="color: #ffd700; background: #333; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center;">Yellow</span>
                                    </label>
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="sessionArtTextColor" value="black" ${session.textColor === 'black' ? 'checked' : ''}>
                                        <span style="color: black; background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center; border: 1px solid #ddd;">Black</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    `;

                    // Set up event listener
                    setTimeout(() => {
                        const styleSelect = document.getElementById('sessionArtImageStyle');
                        if (styleSelect) {
                            // Set current style
                            if (session.imageStyle) {
                                styleSelect.value = session.imageStyle;
                                if (session.imageStyle === 'background') {
                                    document.getElementById('sessionArtBackgroundOptions').style.display = 'block';
                                }
                            }

                            styleSelect.addEventListener('change', function() {
                                const bgOptions = document.getElementById('sessionArtBackgroundOptions');
                                if (bgOptions) {
                                    bgOptions.style.display = this.value === 'background' ? 'block' : 'none';
                                }
                            });
                        }
                    }, 0);

                    modalSaveBtn.onclick = () => {
                        const imageStyle = document.getElementById('sessionArtImageStyle').value;
                        const textColorInput = document.querySelector('input[name="sessionArtTextColor"]:checked');

                        session.imageUrl = selectedArt.file_data;
                        session.imageArtId = selectedArt.id;
                        session.imageStyle = imageStyle;
                        session.bgOpacity = imageStyle === 'background' ? document.getElementById('sessionArtBgOpacity').value : 20;
                        session.textColor = imageStyle === 'background' && textColorInput ? textColorInput.value : 'white';

                        sessions[index] = session;
                        NewcoData.set('sessions', sessions);
                        closeModal();
                        loadSessions();
                        showSuccess(`Art added to "${session.name}"`);
                    };

                    modal.classList.add('active');
                }, customerId);
            } else {
                showError('Art library not available. Please ensure art-picker.js is loaded.');
            }
        }

        function editSession(index) {
            // Implementation for editing sessions
            showAlert('Edit functionality coming soon', 'Info');
        }

        function deleteSession(index) {
            showConfirm(
                'Are you sure you want to delete this session?',
                () => {
                    const sessions = NewcoData.get('sessions') || [];
                    const deleted = sessions.splice(index, 1)[0];
                    NewcoData.set('sessions', sessions);
                    loadSessions();
                    showSuccess(`Session "${deleted.name}" deleted successfully`);
                },
                'Delete Session'
            );
        }
        
        function loadSchedule() {
            const halls = NewcoData.get('halls') || [];
            const schedule = NewcoData.get('schedule') || {}; // Support both singular and plural
            const schedules = schedule.schedules || {}; // Get schedules from schedule object
            const wizardData = NewcoData.get('wizardData') || {};
            const container = document.getElementById('scheduleContainer');

            if (halls.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No halls configured. Please add halls first.</p>';
                return;
            }

            // Get session names once for all halls
            const sessions = NewcoData.get('sessions') || [];

            let html = '';
            halls.forEach(hall => {
                // Check both per-hall schedules and global schedule.weekly
                const hallSchedule = schedules[hall.id] || {};
                const globalWeekly = schedule.weekly || {};

                html += `
                    <div class="content-section" style="margin-top: 1.5rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">🏢</span>
                                ${hall.name}
                            </h3>
                            <div style="font-size: 0.875rem; color: var(--gray);">
                                ${hall.address || 'No address set'}
                            </div>
                        </div>

                        <div style="display: grid; gap: 1rem;">
                `;

                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                const dayColors = {
                    monday: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    tuesday: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    wednesday: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    thursday: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    friday: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    saturday: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    sunday: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                };

                days.forEach(day => {
                    // Get schedule from saved data or wizard defaults
                    const defaultOpen = ['wednesday', 'friday', 'saturday', 'sunday'].includes(day);
                    const wizardSchedule = wizardData.schedule?.[day] || {};
                    let daySessions = hallSchedule[day] || globalWeekly[day];

                    // Handle both single session (object) and multiple sessions (array)
                    if (!daySessions) {
                        daySessions = {
                            open: wizardSchedule.open !== undefined ? wizardSchedule.open : defaultOpen,
                            doors: wizardSchedule.doors || '17:00',
                            early: wizardSchedule.early || '18:00',
                            regular: wizardSchedule.regular || '18:30',
                            closing: wizardSchedule.closing || '21:00'
                        };
                    }

                    // Convert to array if it's a single object
                    let sessionsArray = Array.isArray(daySessions) ? daySessions : [daySessions];

                    // If sessions come from JSON (have sessionId), ensure they have 'open' flag and populate sessionName
                    sessionsArray = sessionsArray.map(s => {
                        if (s.sessionId && s.open === undefined) {
                            // Find session details from sessions table
                            const sessionData = sessions.find(sess => sess.id === s.sessionId);
                            return {
                                ...s,
                                open: true,
                                sessionName: sessionData ? sessionData.name : s.sessionName
                            };
                        }
                        return s;
                    });

                    const dayLabel = day.charAt(0).toUpperCase() + day.slice(1);

                    // Display each session
                    sessionsArray.forEach((daySchedule, sessionIndex) => {
                    
                    html += `
                        <div style="padding: 1.25rem; background: white; border: 2px solid ${daySchedule.open ? 'var(--success)' : 'var(--gray-light)'}; border-radius: 12px; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: ${dayColors[day]}; border-radius: 12px 0 0 12px;"></div>
                            
                            <div style="padding-left: 1rem;">
                                <!-- Day Header with Toggle -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${daySchedule.open ? '1rem' : '0'};">
                                    <div>
                                        <div style="font-weight: 700; font-size: 1.1rem; background: ${dayColors[day]}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                                            ${dayLabel}${daySchedule.suffix ? ` - ${daySchedule.suffix.charAt(0).toUpperCase() + daySchedule.suffix.slice(1)}` : ''}
                                        </div>
                                        ${sessionIndex > 0 ? '<span style="font-size: 0.75rem; color: var(--gray);">Additional Session</span>' : ''}
                                    </div>
                                    
                                    <!-- Toggle Switch and Action Buttons -->
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        ${daySchedule.open ? `
                                            ${daySchedule.imageArtId ? `
                                                <div style="display: flex; align-items: center; gap: 0.5rem; background: #e8f5e9; padding: 0.25rem 0.75rem; border-radius: 6px; border: 1px solid #4caf50;">
                                                    <span style="font-size: 0.75rem; color: #2e7d32;">🖼️ Art Added</span>
                                                    ${daySchedule.imageUrl ? `<img src="${daySchedule.imageUrl}" style="width: 24px; height: 24px; object-fit: contain; border-radius: 4px; border: 1px solid #ddd;">` : ''}
                                                </div>
                                            ` : ''}
                                            <button class="btn btn-sm btn-secondary" onclick="addArtToDay('${day}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                                📚 ${daySchedule.imageArtId ? 'Change' : 'Add'} Art
                                            </button>
                                            <button class="btn btn-sm btn-outline" onclick="addSessionForDay('${hall.id}', '${day}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                                + Add Session
                                            </button>
                                        ` : ''}
                                        <span style="font-size: 0.875rem; color: ${daySchedule.open ? 'var(--success)' : 'var(--gray)'};">
                                            ${daySchedule.open ? 'Open' : 'Closed'}
                                        </span>
                                        <label class="toggle-switch">
                                            <input type="checkbox"
                                                   id="hall-${hall.id}-${day}-toggle"
                                                   ${daySchedule.open ? 'checked' : ''}
                                                   onchange="toggleDaySchedule('${hall.id}', '${day}')">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Time Fields (shown when open) -->
                                <div id="hall-${hall.id}-${day}-${sessionIndex}-times" style="display: ${daySchedule.open ? 'grid' : 'none'}; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🚪 Doors Open</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-doors"
                                               value="${daySchedule.doors || '17:00'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'doors', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🌅 Early Bird</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-early"
                                               value="${daySchedule.early || '18:00'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'early', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🎯 Regular</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-regular"
                                               value="${daySchedule.regular || '18:30'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'regular', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">🌙 Closing</label>
                                        <input type="time"
                                               id="hall-${hall.id}-${day}-${sessionIndex}-closing"
                                               value="${daySchedule.closing || '21:00'}"
                                               onchange="updateScheduleTime('${hall.id}', '${day}', 'closing', this.value, ${sessionIndex})"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                    </div>
                                </div>

                                <!-- Session Name Field -->
                                <div id="hall-${hall.id}-${day}-${sessionIndex}-session-name-field" style="display: ${daySchedule.open ? 'block' : 'none'}; margin-top: 1rem;">
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">📋 Session Name (e.g., "Broadway Thursday", "5K Friday")</label>
                                    <input type="text"
                                           id="hall-${hall.id}-${day}-${sessionIndex}-sessionName"
                                           value="${daySchedule.sessionName || ''}"
                                           placeholder="Enter session name..."
                                           onchange="updateScheduleTime('${hall.id}', '${day}', 'sessionName', this.value, ${sessionIndex})"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 0.875rem;">
                                </div>
                            </div>
                        </div>
                    `;
                    }); // End sessions forEach
                }); // End days forEach
                
                html += `
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-light);">
                            <div style="font-size: 0.875rem; color: var(--gray);">
                                💡 Tip: Check the days you're open and set your operating hours
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleDaySchedule(hallId, day) {
            const toggle = document.getElementById(`hall-${hallId}-${day}-toggle`);
            // Use sessionIndex 0 for the main times div since that's the primary session
            const timesDiv = document.getElementById(`hall-${hallId}-${day}-0-times`);
            const sessionNameField = document.getElementById(`hall-${hallId}-${day}-session-name-field`);
            const schedule = NewcoData.get('schedule') || {};
            const schedules = schedule.schedules || {};

            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }

            if (toggle.checked) {
                // Show time fields and session name field, save as open
                if (timesDiv) timesDiv.style.display = 'grid';
                if (sessionNameField) sessionNameField.style.display = 'block';

                // Get values from sessionIndex 0 fields
                schedules[hallId][day] = {
                    open: true,
                    doors: document.getElementById(`hall-${hallId}-${day}-0-doors`)?.value || '17:00',
                    early: document.getElementById(`hall-${hallId}-${day}-0-early`)?.value || '18:00',
                    regular: document.getElementById(`hall-${hallId}-${day}-0-regular`)?.value || '18:30',
                    closing: document.getElementById(`hall-${hallId}-${day}-0-closing`)?.value || '21:00',
                    sessionName: document.getElementById(`hall-${hallId}-${day}-sessionName`)?.value || ''
                };

                // Update border color to green
                if (timesDiv) {
                    const borderDiv = timesDiv.closest('[style*="border:"]');
                    if (borderDiv) borderDiv.style.borderColor = 'var(--success)';
                }

                // Update status text
                const statusText = toggle.closest('div').querySelector('span');
                if (statusText) {
                    statusText.textContent = 'Open';
                    statusText.style.color = 'var(--success)';
                }
            } else {
                // Hide time fields and session name field, save as closed
                if (timesDiv) timesDiv.style.display = 'none';
                if (sessionNameField) sessionNameField.style.display = 'none';
                schedules[hallId][day] = { open: false };

                // Update border color to gray
                if (timesDiv) {
                    const borderDiv = timesDiv.closest('[style*="border:"]');
                    if (borderDiv) borderDiv.style.borderColor = 'var(--gray-light)';
                }

                // Update status text
                const statusText = toggle.closest('div').querySelector('span');
                if (statusText) {
                    statusText.textContent = 'Closed';
                    statusText.style.color = 'var(--gray)';
                }
            }

            schedule.schedules = schedules;
            NewcoData.set('schedule', schedule);
            showAutoSave();

            // Reload schedule to show/hide buttons
            loadSchedule();
        }
        
        function updateScheduleTime(hallId, day, field, value, sessionIndex = 0) {
            const schedule = NewcoData.get('schedule') || {};
            const schedules = schedule.schedules || {};

            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }

            if (!schedules[hallId][day]) {
                schedules[hallId][day] = { open: true };
            }

            // Handle array of sessions
            if (Array.isArray(schedules[hallId][day])) {
                if (schedules[hallId][day][sessionIndex]) {
                    schedules[hallId][day][sessionIndex][field] = value;
                }
            } else {
                // Single session object
                schedules[hallId][day][field] = value;
            }

            schedule.schedules = schedules;
            NewcoData.set('schedule', schedule);
        }
        
        function updateSchedule(hallId, day) {
            const schedule = NewcoData.get('schedule') || {};
            const schedules = schedule.schedules || {};
            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }
            
            const isOpen = document.getElementById(`schedule-${hallId}-${day}`).checked;
            
            if (isOpen) {
                schedules[hallId][day] = {
                    open: true,
                    doors: document.getElementById(`doors-${hallId}-${day}`).value,
                    earlyBird: document.getElementById(`early-${hallId}-${day}`).value,
                    regular: document.getElementById(`regular-${hallId}-${day}`).value,
                    closing: document.getElementById(`closing-${hallId}-${day}`).value
                };
            } else {
                schedules[hallId][day] = { open: false };
            }

            schedule.schedules = schedules;
            NewcoData.set('schedule', schedule);
            markUnsaved();
        }
        
        function saveSchedule(hallId) {
            // Data is already saved via updateScheduleTime() and toggleDaySchedule()
            // This function just confirms the save to the user
            showSuccess('Schedule saved successfully');
        }

        function addArtToDay(day) {
            console.log('addArtToDay called with day:', day);
            const sessions = NewcoData.get('sessions') || [];
            const halls = NewcoData.get('halls') || [];
            const schedule = NewcoData.get('schedule') || {};
            const schedules = schedule.schedules || {};
            const globalWeekly = schedule.weekly || {};

            console.log('Sessions:', sessions);
            console.log('Halls:', halls);
            console.log('Schedules:', schedules);
            console.log('Global weekly:', globalWeekly);

            // Case-insensitive day matching
            const dayLower = day.toLowerCase();
            console.log('dayLower:', dayLower);

            // Find sessions that include this day
            const daySessions = sessions.filter(s =>
                s.days && s.days.some(d => d.toLowerCase() === dayLower)
            );
            console.log('daySessions found:', daySessions);

            // Check if any halls have schedules for this day (from schedules object or global weekly)
            // OR allow creating schedules for any hall
            const hallsWithDay = halls.filter(h => {
                const hallSchedule = schedules[h.id] || {};
                const daySchedule = hallSchedule[dayLower] || globalWeekly[dayLower];
                // Include hall if:
                // 1. It has an existing schedule for this day, OR
                // 2. The hall exists (we can create a schedule for it)
                return !!daySchedule || !!h;
            });
            console.log('hallsWithDay found:', hallsWithDay);

            if (daySessions.length === 0 && hallsWithDay.length === 0) {
                console.log('No sessions or halls found, showing alert');
                showAlert(`No sessions found for ${day}. Please create a session first.`, 'Info');
                return;
            }
            console.log('Proceeding to open ArtPicker');

            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            if (typeof ArtPicker !== 'undefined' && typeof ArtPicker.open === 'function') {
                ArtPicker.open((selectedArt) => {
                    // Show modal to select which session(s) and configure style
                    const modal = document.getElementById('modal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalBody = document.getElementById('modalBody');
                    const modalSaveBtn = document.getElementById('modalSaveBtn');

                    // Build list of all sessions/halls for this day
                    let sessionOptions = '';

                    // Add standalone sessions
                    daySessions.forEach((s, idx) => {
                        sessionOptions += `
                            <label style="display: block; margin-bottom: 0.5rem;">
                                <input type="checkbox" class="session-checkbox" data-type="session" value="${sessions.indexOf(s)}" checked>
                                ${s.name} (${s.startTime} - ${s.endTime})
                            </label>
                        `;
                    });

                    // Add hall schedules
                    hallsWithDay.forEach((hall) => {
                        sessionOptions += `
                            <label style="display: block; margin-bottom: 0.5rem;">
                                <input type="checkbox" class="hall-checkbox" data-type="hall" value="${hall.id}" data-day="${dayLower}" checked>
                                ${hall.name} - ${day.charAt(0).toUpperCase() + day.slice(1)}
                            </label>
                        `;
                    });

                    modalTitle.textContent = `Add Art to ${day} Sessions`;
                    modalBody.innerHTML = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <img src="${selectedArt.file_data}" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apply to Sessions:</label>
                            ${sessionOptions}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Image Display Style</label>
                            <select class="form-select" id="dayArtImageStyle">
                                <option value="thumbnail">Thumbnail</option>
                                <option value="banner">Banner</option>
                                <option value="background">Background</option>
                            </select>
                        </div>
                        <div id="dayArtBackgroundOptions" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Background Opacity</label>
                                <input type="range" class="form-input" id="dayArtBgOpacity" min="0" max="100" value="20"
                                       oninput="document.getElementById('dayArtOpacityValue').textContent = this.value + '%'">
                                <div style="text-align: center; font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
                                    <span id="dayArtOpacityValue">20%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="dayArtTextColor" value="black" checked>
                                        <span style="color: black; background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center; border: 1px solid #ddd;">Black</span>
                                    </label>
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="dayArtTextColor" value="white">
                                        <span style="color: white; background: #333; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center;">White</span>
                                    </label>
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="dayArtTextColor" value="yellow">
                                        <span style="color: #ffd700; background: #333; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; width: 100%; text-align: center;">Yellow</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Effect</label>
                                <select class="form-select" id="dayArtTextEffect" onchange="
                                    const highlightOptions = document.getElementById('dayArtHighlightOptions');
                                    if (highlightOptions) {
                                        highlightOptions.style.display = this.value === 'highlight' ? 'block' : 'none';
                                    }
                                ">
                                    <option value="none">None</option>
                                    <option value="shadow">Drop Shadow</option>
                                    <option value="glow">Glow</option>
                                    <option value="outline">Outline</option>
                                    <option value="highlight">Highlight</option>
                                </select>
                            </div>
                            <div id="dayArtHighlightOptions" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Highlight Color</label>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                        <label style="cursor: pointer;">
                                            <input type="radio" name="dayArtHighlightColor" value="yellow" checked>
                                            <span style="background: rgba(255,255,0,0.5); padding: 0.5rem; border-radius: 4px; display: block; text-align: center; border: 2px solid #ffd700;">Yellow</span>
                                        </label>
                                        <label style="cursor: pointer;">
                                            <input type="radio" name="dayArtHighlightColor" value="green">
                                            <span style="background: rgba(0,255,0,0.4); padding: 0.5rem; border-radius: 4px; display: block; text-align: center; border: 2px solid #00cc00;">Green</span>
                                        </label>
                                        <label style="cursor: pointer;">
                                            <input type="radio" name="dayArtHighlightColor" value="blue">
                                            <span style="background: rgba(0,150,255,0.4); padding: 0.5rem; border-radius: 4px; display: block; text-align: center; border: 2px solid #0096ff; color: white;">Blue</span>
                                        </label>
                                        <label style="cursor: pointer;">
                                            <input type="radio" name="dayArtHighlightColor" value="pink">
                                            <span style="background: rgba(255,105,180,0.4); padding: 0.5rem; border-radius: 4px; display: block; text-align: center; border: 2px solid #ff69b4;">Pink</span>
                                        </label>
                                        <label style="cursor: pointer;">
                                            <input type="radio" name="dayArtHighlightColor" value="orange">
                                            <span style="background: rgba(255,165,0,0.5); padding: 0.5rem; border-radius: 4px; display: block; text-align: center; border: 2px solid #ffa500;">Orange</span>
                                        </label>
                                        <label style="cursor: pointer;">
                                            <input type="radio" name="dayArtHighlightColor" value="white">
                                            <span style="background: rgba(255,255,255,0.6); padding: 0.5rem; border-radius: 4px; display: block; text-align: center; border: 2px solid #ddd;">White</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    setTimeout(() => {
                        const styleSelect = document.getElementById('dayArtImageStyle');
                        if (styleSelect) {
                            styleSelect.addEventListener('change', function() {
                                const bgOptions = document.getElementById('dayArtBackgroundOptions');
                                if (bgOptions) {
                                    bgOptions.style.display = this.value === 'background' ? 'block' : 'none';
                                }
                            });
                        }
                    }, 0);

                    modalSaveBtn.onclick = async () => {
                        const imageStyle = document.getElementById('dayArtImageStyle').value;
                        const textColorInput = document.querySelector('input[name="dayArtTextColor"]:checked');
                        const bgOpacity = imageStyle === 'background' ? document.getElementById('dayArtBgOpacity').value : 20;
                        const textColor = textColorInput ? textColorInput.value : 'black';
                        const textEffect = document.getElementById('dayArtTextEffect')?.value || 'none';
                        const highlightColorInput = document.querySelector('input[name="dayArtHighlightColor"]:checked');
                        const highlightColor = highlightColorInput ? highlightColorInput.value : 'yellow';

                        let updateCount = 0;

                        // Update standalone sessions
                        const selectedSessionIndices = Array.from(document.querySelectorAll('.session-checkbox:checked')).map(cb => parseInt(cb.value));
                        selectedSessionIndices.forEach(idx => {
                            sessions[idx].imageUrl = selectedArt.file_data;
                            sessions[idx].imageArtId = selectedArt.id;
                            sessions[idx].imageStyle = imageStyle;
                            sessions[idx].bgOpacity = bgOpacity;
                            sessions[idx].textColor = textColor;
                            sessions[idx].textEffect = textEffect;
                            sessions[idx].highlightColor = highlightColor;
                            updateCount++;
                        });

                        // Update hall schedules (stored in schedule.schedules[hallId] or schedule.weekly)
                        const selectedHalls = Array.from(document.querySelectorAll('.hall-checkbox:checked'));
                        selectedHalls.forEach(cb => {
                            const hallId = cb.value;
                            const hallDay = cb.dataset.day;

                            // Ensure we have a schedules object for this hall
                            if (!schedules[hallId]) {
                                schedules[hallId] = {};
                            }

                            // Get the hall's schedule, or create default if it doesn't exist
                            if (!schedules[hallId][hallDay]) {
                                const defaultOpen = ['wednesday', 'friday', 'saturday', 'sunday'].includes(hallDay);
                                schedules[hallId][hallDay] = {
                                    open: defaultOpen,
                                    doors: '17:00',
                                    early: '18:00',
                                    regular: '18:30',
                                    closing: '21:00'
                                };
                            }

                            // Handle both array and single object schedules
                            if (Array.isArray(schedules[hallId][hallDay])) {
                                schedules[hallId][hallDay].forEach(daySession => {
                                    daySession.imageUrl = selectedArt.file_data;
                                    daySession.imageArtId = selectedArt.id;
                                    daySession.imageStyle = imageStyle;
                                    daySession.bgOpacity = bgOpacity;
                                    daySession.textColor = textColor;
                                    daySession.textEffect = textEffect;
                                    daySession.highlightColor = highlightColor;
                                });
                            } else {
                                schedules[hallId][hallDay].imageUrl = selectedArt.file_data;
                                schedules[hallId][hallDay].imageArtId = selectedArt.id;
                                schedules[hallId][hallDay].imageStyle = imageStyle;
                                schedules[hallId][hallDay].bgOpacity = bgOpacity;
                                schedules[hallId][hallDay].textColor = textColor;
                                schedules[hallId][hallDay].textEffect = textEffect;
                                schedules[hallId][hallDay].highlightColor = highlightColor;
                            }
                            updateCount++;
                        });

                        // Save updated schedule back
                        schedule.schedules = schedules;
                        await NewcoData.set('sessions', sessions);
                        await NewcoData.set('schedule', schedule);
                        closeModal();
                        loadSessions();
                        loadSchedule();
                        showSuccess(`Art added to ${updateCount} session(s)`);
                    };

                    modal.classList.add('active');
                }, customerId);
            } else {
                showError('Art library not available. Please ensure art-picker.js is loaded.');
            }
        }

        function addSessionForDay(hallId, day) {
            showModal({
                title: `Add Additional Session for ${day.charAt(0).toUpperCase() + day.slice(1)}`,
                message: `
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Session Suffix:</label>
                        <select id="sessionSuffix" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px;">
                            <option value="early">Early</option>
                            <option value="matinee">Matinee</option>
                            <option value="late">Late</option>
                        </select>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                            This will create "${day.charAt(0).toUpperCase() + day.slice(1)} - Early" as a separate session
                        </p>
                    </div>
                `,
                confirmText: 'Create Session',
                onConfirm: () => {
                    const suffix = document.getElementById('sessionSuffix').value;
                    createAdditionalSession(hallId, day, suffix);
                }
            });
        }

        function createAdditionalSession(hallId, day, suffix) {
            const schedule = NewcoData.get('schedule') || {};
            const schedules = schedule.schedules || {};

            if (!schedules[hallId]) {
                schedules[hallId] = {};
            }

            // Convert single session to array if needed
            if (schedules[hallId][day] && !Array.isArray(schedules[hallId][day])) {
                const originalSession = schedules[hallId][day];
                schedules[hallId][day] = [originalSession];
            }

            // Create array if it doesn't exist
            if (!schedules[hallId][day]) {
                schedules[hallId][day] = [];
            }

            // Add new session with suffix
            const newSession = {
                open: true,
                suffix: suffix,
                sessionName: `${day.charAt(0).toUpperCase() + day.slice(1)} - ${suffix.charAt(0).toUpperCase() + suffix.slice(1)}`,
                doors: '17:00',
                early: '18:00',
                regular: '18:30',
                closing: '21:00'
            };

            schedules[hallId][day].push(newSession);

            // Sort sessions by suffix priority: Early, Matinee, Normal (no suffix), Late
            const suffixOrder = { 'early': 1, 'matinee': 2, '': 3, 'late': 4 };
            schedules[hallId][day].sort((a, b) => {
                const orderA = suffixOrder[a.suffix || ''] || 3;
                const orderB = suffixOrder[b.suffix || ''] || 3;
                return orderA - orderB;
            });

            schedule.schedules = schedules;
            NewcoData.set('schedule', schedule);

            showSuccess(`Created "${newSession.sessionName}" session`);

            // Reload schedule display
            loadSchedule();
        }

        // Theme Functions
        function loadThemes() {
            const org = NewcoData.get("organization");
            if (org?.colors) {
                document.getElementById('themePrimary').value = org.colors.primary || '#2ea3f2';
                document.getElementById('themeSecondary').value = org.colors.secondary || '#9c27b0';
                document.getElementById('themeAccent').value = org.colors.accent || '#4CAF50';
            }
        }

        function applyTheme(themeName) {
            const themes = {
                classic: {
                    primary: '#667eea',
                    secondary: '#764ba2',
                    accent: '#FFD700'
                },
                modern: {
                    primary: '#2ea3f2',
                    secondary: '#1a5f8a',
                    accent: '#4CAF50'
                },
                fun: {
                    primary: '#f093fb',
                    secondary: '#f5576c',
                    accent: '#4facfe'
                },
                elegant: {
                    primary: '#434343',
                    secondary: '#000000',
                    accent: '#FFD700'
                }
            };
            
            const theme = themes[themeName];
            if (theme) {
                document.getElementById('themePrimary').value = theme.primary;
                document.getElementById('themeSecondary').value = theme.secondary;
                document.getElementById('themeAccent').value = theme.accent;
                
                // Apply to current page
                document.documentElement.style.setProperty('--primary', theme.primary);
                document.documentElement.style.setProperty('--secondary', theme.secondary);
                
                markUnsaved();
            }
        }

        function saveTheme() {
            const org = NewcoData.get("organization") || {};
            org.colors = {
                primary: document.getElementById('themePrimary').value,
                secondary: document.getElementById('themeSecondary').value,
                accent: document.getElementById('themeAccent').value
            };
            org.fonts = {
                heading: document.getElementById('headingFont')?.value || 'Inter',
                body: document.getElementById('bodyFont')?.value || 'Inter'
            };
            
            NewcoData.updateOrganization(org);
            showAutoSave();
        }

        // Members Management Functions
        let membersData = [];
        let filteredMembers = [];
        let currentMemberPage = 1;
        const membersPerPage = 10;
        let currentSortField = 'name';
        let currentSortDirection = 'asc';
        
        async function loadMembers() {
            // Refresh cache from Supabase first
            const custData = await NewcoData.read_cust();
            if (custData.members) {
                NewcoData.cache.members = custData.members;
            }
            if (custData.transactions) {
                NewcoData.cache.transactions = custData.transactions;
            }

            // Load actual members data (don't generate samples)
            membersData = NewcoData.get('members') || [];
            filteredMembers = [...membersData];

            // Update stats
            updateMemberStats();

            // Display members
            displayMembers();
        }
        
        function generateSampleMembers() {
            const firstNames = ['John', 'Jane', 'Michael', 'Sarah', 'Robert', 'Emily', 'David', 'Lisa', 'James', 'Mary'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Martinez', 'Anderson'];
            const members = [];
            
            for (let i = 0; i < 50; i++) {
                const created = new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000);
                const lastLogin = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                const lifetimeSpend = Math.floor(Math.random() * 5000);
                const monthlySpend = Math.floor(Math.random() * 500);
                
                members.push({
                    id: Date.now() + i,
                    name: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                    email: `member${i + 1}@example.com`,
                    phone: `555-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
                    loyaltyPoints: Math.floor(Math.random() * 10000),
                    lifetimeLoyalty: Math.floor(Math.random() * 50000),
                    logins: Math.floor(Math.random() * 100) + 1,
                    dateCreated: created.toISOString(),
                    lastLogin: lastLogin.toISOString(),
                    lifetimeSpend: lifetimeSpend,
                    averageSpend: lifetimeSpend > 0 ? Math.floor(lifetimeSpend / (Math.floor(Math.random() * 20) + 1)) : 0,
                    monthlySpend: monthlySpend
                });
            }
            
            NewcoData.set('members', members);
            return members;
        }

        // Calculate member's total lifetime spending from all transactions
        function calculateLifetimeSpend(member) {
            const transactions = NewcoData.get('transactions') || [];
            const memberName = (member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim()).toLowerCase();
            const memberId = member.id || member.memberId || member.userId;

            const memberTransactions = transactions.filter(t => {
                const txName = (t.memberName || '').toLowerCase();
                const matchesName = txName === memberName;
                const matchesId = memberId && (t.memberId === memberId);
                return matchesName || matchesId;
            });

            return memberTransactions.reduce((sum, t) => sum + (parseFloat(t.finalTotal) || 0), 0);
        }

        // Calculate member's spending from last 30 days of transactions
        function calculateMonthlySpend(member) {
            const transactions = NewcoData.get('transactions') || [];
            const now = new Date();
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Get member name for matching - case insensitive
            const memberName = (member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim()).toLowerCase();
            const memberId = member.id || member.memberId || member.userId;

            const memberTransactions = transactions.filter(t => {
                // Match by name (primary) or ID fields (fallback) - case insensitive
                const txName = (t.memberName || '').toLowerCase();
                const matchesName = txName === memberName;
                const matchesId = memberId && (t.memberId === memberId);

                if (!matchesName && !matchesId) return false;

                const txDate = new Date(t.date || t.timestamp);
                const isInRange = txDate >= monthAgo && txDate <= now;

                return isInRange;
            });

            const total = memberTransactions.reduce((sum, t) => sum + (parseFloat(t.finalTotal) || 0), 0);

            return total;
        }

        function updateMemberStats() {
            const totalMembers = filteredMembers.length;
            const now = new Date();
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Calculate monthly spend for each member from transactions
            filteredMembers.forEach(member => {
                member.monthlySpend = calculateMonthlySpend(member);
            });

            const activeThisMonth = filteredMembers.filter(m => new Date(m.lastLogin) > monthAgo).length;
            const avgPoints = Math.floor(filteredMembers.reduce((sum, m) => sum + m.loyaltyPoints, 0) / (totalMembers || 1));
            const avgMonthly = Math.floor(filteredMembers.reduce((sum, m) => sum + (m.monthlySpend || 0), 0) / (totalMembers || 1));

            document.getElementById('totalMembersCount').textContent = totalMembers.toLocaleString();
            document.getElementById('activeMonthCount').textContent = activeThisMonth.toLocaleString();
            document.getElementById('avgPointsCount').textContent = avgPoints.toLocaleString();
            document.getElementById('avgMonthlySpend').textContent = `$${avgMonthly.toLocaleString()}`;
        }
        
        function displayMembers() {
            const tbody = document.getElementById('membersTableBody');
            const start = (currentMemberPage - 1) * membersPerPage;
            const end = start + membersPerPage;
            const pageMembers = filteredMembers.slice(start, end);
            
            if (pageMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--gray);">No members found matching your criteria</td></tr>';
                return;
            }
            
            tbody.innerHTML = pageMembers.map(member => {
                // Handle both old sample format and new registration format
                const name = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim();
                const created = new Date(member.dateCreated || member.joinDate);
                const lastLogin = new Date(member.lastLogin || member.lastVisit || member.joinDate);
                const loyaltyPoints = member.loyaltyPoints || 0;
                const lifetimeLoyalty = member.lifetimeLoyalty || loyaltyPoints;
                const logins = member.logins || member.visits || 1;
                // Calculate lifetime spend from actual transactions
                const lifetimeSpend = calculateLifetimeSpend(member);
                const averageSpend = lifetimeSpend > 0 ? Math.floor(lifetimeSpend / logins) : 0;
                // Calculate monthly spend from transactions if not already calculated
                const monthlySpend = member.monthlySpend !== undefined ? member.monthlySpend : calculateMonthlySpend(member);
                
                return `
                    <tr style="border-bottom: 1px solid var(--gray-lighter); transition: background 0.2s;" onmouseover="this.style.background='var(--gray-lighter)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600; color: var(--primary); cursor: pointer; text-decoration: underline;" onclick="viewMemberDetails('${member.id}')">${name}</div>
                            <div style="font-size: 0.875rem; color: var(--gray);">${member.email}</div>
                            ${member.memberId ? `<div style="font-size: 0.75rem; color: var(--gray);">ID: ${member.memberId}</div>` : ''}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <span style="font-weight: 600; color: var(--warning);">${loyaltyPoints.toLocaleString()}</span>
                        </td>
                        <td style="padding: 1rem; text-align: center;">${lifetimeLoyalty.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center;">${logins}</td>
                        <td style="padding: 1rem; text-align: center;">$${lifetimeSpend.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center;">$${averageSpend.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center;">$${monthlySpend.toLocaleString()}</td>
                        <td style="padding: 1rem; text-align: center; font-size: 0.875rem;">${created.toLocaleDateString()}</td>
                        <td style="padding: 1rem; text-align: center; font-size: 0.875rem;">${lastLogin.toLocaleDateString()}</td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination
            updateMembersPagination();
            
            // Update showing text
            document.getElementById('membersShowing').textContent = pageMembers.length;
            document.getElementById('membersTotal').textContent = filteredMembers.length;
        }
        
        function updateMembersPagination() {
            const totalPages = Math.ceil(filteredMembers.length / membersPerPage);
            const paginationDiv = document.getElementById('membersPagination');
            
            // Use the generic pagination helper
            paginationDiv.innerHTML = generatePagination(currentMemberPage, totalPages, 'changeMemberPage');
        }
        
        function changeMemberPage(page) {
            const totalPages = Math.ceil(filteredMembers.length / membersPerPage);
            if (page >= 1 && page <= totalPages) {
                currentMemberPage = page;
                displayMembers();
            }
        }
        
        function filterMembers() {
            const searchName = document.getElementById('memberSearchName').value.toLowerCase();
            const minPoints = parseInt(document.getElementById('memberMinPoints').value) || 0;
            const minSpend = parseInt(document.getElementById('memberMinSpend').value) || 0;
            const dateRange = document.getElementById('memberDateRange').value;
            const activity = document.getElementById('memberActivity').value;
            
            filteredMembers = membersData.filter(member => {
                // Name filter - handle both formats
                const memberName = (member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim()).toLowerCase();
                if (searchName && !memberName.includes(searchName)) return false;
                
                // Points filter
                const points = member.loyaltyPoints || 0;
                if (points < minPoints) return false;
                
                // Spend filter
                const spend = member.lifetimeSpend || member.totalSpent || 0;
                if (spend < minSpend) return false;
                
                // Date range filter
                const created = new Date(member.dateCreated || member.joinDate);
                const now = new Date();
                if (dateRange === 'today' && created.toDateString() !== now.toDateString()) return false;
                if (dateRange === 'week' && created < new Date(now - 7 * 24 * 60 * 60 * 1000)) return false;
                if (dateRange === 'month' && created < new Date(now - 30 * 24 * 60 * 60 * 1000)) return false;
                if (dateRange === 'year' && created < new Date(now - 365 * 24 * 60 * 60 * 1000)) return false;
                
                // Activity filter
                const lastLogin = new Date(member.lastLogin || member.lastVisit || member.joinDate);
                if (activity === 'active' && lastLogin < new Date(now - 30 * 24 * 60 * 60 * 1000)) return false;
                if (activity === 'inactive' && lastLogin >= new Date(now - 30 * 24 * 60 * 60 * 1000)) return false;
                if (activity === 'new' && created < new Date(now - 7 * 24 * 60 * 60 * 1000)) return false;
                
                return true;
            });
            
            // Apply sorting
            const sortBy = document.getElementById('memberSortBy').value;
            sortMembers(sortBy);
        }
        
        function sortMembers(field) {
            if (field === currentSortField) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // Update all sort arrows to neutral
            const arrows = ['Name', 'Points', 'Lifetime', 'Logins', 'Spend', 'Average', 'Monthly', 'Created', 'LastLogin'];
            arrows.forEach(arrow => {
                const elem = document.getElementById('sortArrow' + arrow);
                if (elem) {
                    elem.textContent = '↕️';
                }
            });
            
            // Update current field's arrow
            const fieldMap = {
                'name': 'Name',
                'points': 'Points',
                'lifetime': 'Lifetime',
                'logins': 'Logins',
                'spend': 'Spend',
                'average': 'Average',
                'monthly': 'Monthly',
                'created': 'Created',
                'lastLogin': 'LastLogin'
            };
            
            const arrowId = 'sortArrow' + fieldMap[field];
            const arrowElem = document.getElementById(arrowId);
            if (arrowElem) {
                arrowElem.textContent = currentSortDirection === 'asc' ? '↑' : '↓';
            }
            
            filteredMembers.sort((a, b) => {
                let aVal, bVal;
                
                switch(field) {
                    case 'name': 
                        aVal = a.name || `${a.firstName || ''} ${a.lastName || ''}`.trim();
                        bVal = b.name || `${b.firstName || ''} ${b.lastName || ''}`.trim();
                        break;
                    case 'points': 
                        aVal = a.loyaltyPoints || 0;
                        bVal = b.loyaltyPoints || 0;
                        break;
                    case 'lifetime': 
                        aVal = a.lifetimeLoyalty || a.loyaltyPoints || 0;
                        bVal = b.lifetimeLoyalty || b.loyaltyPoints || 0;
                        break;
                    case 'logins': 
                        aVal = a.logins || a.visits || 0;
                        bVal = b.logins || b.visits || 0;
                        break;
                    case 'spend': 
                        aVal = a.lifetimeSpend || a.totalSpent || 0;
                        bVal = b.lifetimeSpend || b.totalSpent || 0;
                        break;
                    case 'average': 
                        aVal = a.averageSpend || 0;
                        bVal = b.averageSpend || 0;
                        break;
                    case 'monthly': 
                        aVal = a.monthlySpend || 0;
                        bVal = b.monthlySpend || 0;
                        break;
                    case 'created': 
                        aVal = new Date(a.dateCreated || a.joinDate);
                        bVal = new Date(b.dateCreated || b.joinDate);
                        break;
                    case 'lastLogin': 
                        aVal = new Date(a.lastLogin || a.lastVisit || a.joinDate);
                        bVal = new Date(b.lastLogin || b.lastVisit || b.joinDate);
                        break;
                    default: 
                        aVal = a.name || `${a.firstName || ''} ${a.lastName || ''}`.trim();
                        bVal = b.name || `${b.firstName || ''} ${b.lastName || ''}`.trim();
                }
                
                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            currentMemberPage = 1;
            updateMemberStats();
            displayMembers();
        }
        
        function resetMemberFilters() {
            document.getElementById('memberSearchName').value = '';
            document.getElementById('memberMinPoints').value = '';
            document.getElementById('memberMinSpend').value = '';
            document.getElementById('memberDateRange').value = 'all';
            document.getElementById('memberActivity').value = 'all';
            document.getElementById('memberSortBy').value = 'name';
            
            filteredMembers = [...membersData];
            currentMemberPage = 1;
            updateMemberStats();
            displayMembers();
        }
        
        function viewMemberDetails(memberId) {
            const member = membersData.find(m => m.id === memberId);
            if (!member) {
                showModal({
                    title: '❌ Error',
                    message: 'Member not found.',
                    type: 'error'
                });
                return;
            }

            // Get all transactions for this member
            const allTransactions = NewcoData.get('transactions') || [];
            const memberTransactions = allTransactions.filter(t => t.customerId === memberId || t.memberId === memberId);

            // Get all reward transactions for this member
            const allRewards = NewcoData.get('rewardTransactions') || [];
            const memberRewards = allRewards.filter(r => r.customerId === memberId || r.memberId === memberId);

            // Calculate stats
            const name = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim() || 'Unknown';
            const lifetimeSpend = calculateLifetimeSpend(member);
            const monthlySpend = member.monthlySpend !== undefined ? member.monthlySpend : calculateMonthlySpend(member);
            const loyaltyPoints = member.loyaltyPoints || member.points || 0;
            const lifetimeLoyalty = member.lifetimeLoyalty || loyaltyPoints;

            // Create full-screen overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;

            overlay.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 1400px; max-height: 90vh; overflow: hidden; display: flex;">
                    <!-- Sidebar -->
                    <div style="width: 260px; background: #f9fafb; border-right: 2px solid var(--gray-light); display: flex; flex-direction: column; overflow-y: auto;">
                        <div style="padding: 1.5rem;">
                            <!-- Member Info -->
                            <div style="margin-bottom: 1.5rem;">
                                <h2 style="margin: 0; font-size: 1.1rem; color: var(--gray-dark);">${name}</h2>
                                <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--gray); word-break: break-word;">${member.email}</p>
                            </div>

                            <!-- Stats Cards -->
                            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #2196f3;">
                                    <div style="font-size: 0.7rem; color: var(--gray); text-transform: uppercase; margin-bottom: 0.25rem;">Loyalty Points</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${loyaltyPoints.toLocaleString()}</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #4caf50;">
                                    <div style="font-size: 0.7rem; color: var(--gray); text-transform: uppercase; margin-bottom: 0.25rem;">Lifetime Spend</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">$${lifetimeSpend.toLocaleString()}</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #ff9800;">
                                    <div style="font-size: 0.7rem; color: var(--gray); text-transform: uppercase; margin-bottom: 0.25rem;">Monthly Spend</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #ff9800;">$${monthlySpend.toLocaleString()}</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #9c27b0;">
                                    <div style="font-size: 0.7rem; color: var(--gray); text-transform: uppercase; margin-bottom: 0.25rem;">Lifetime Loyalty</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #9c27b0;">${lifetimeLoyalty.toLocaleString()}</div>
                                </div>
                            </div>

                            <!-- Barcode -->
                            <div style="background: white; padding: 0.75rem; border-radius: 6px; text-align: center; margin-top: auto;">
                                <div style="font-size: 0.7rem; color: var(--gray); margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">Member ID</div>
                                <svg id="memberBarcode${memberId}" style="width: 100%; height: auto;"></svg>
                                <div style="margin-top: 0.25rem; font-size: 0.7rem; color: var(--gray); font-family: monospace; word-break: break-all;">${member.id}</div>
                                <button onclick="printMemberCard('${memberId}')" class="btn btn-outline" style="width: 100%; margin-top: 0.75rem; font-size: 0.75rem; padding: 0.5rem;">
                                    🖨️ Print Card
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <!-- Header -->
                        <div style="padding: 1rem 1.5rem; border-bottom: 2px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-sm" id="memberTabTransactions" onclick="switchMemberTab('transactions', '${memberId}')" style="border-radius: 20px; padding: 0.35rem 0.75rem; font-size: 0.875rem;">
                                    <i data-lucide="credit-card" style="width: 16px; height: 16px;"></i> Transactions (${memberTransactions.length})
                                </button>
                                <button class="btn btn-outline btn-sm" id="memberTabRewards" onclick="switchMemberTab('rewards', '${memberId}')" style="border-radius: 20px; padding: 0.35rem 0.75rem; font-size: 0.875rem;">
                                    <i data-lucide="star" style="width: 16px; height: 16px;"></i> Rewards (${memberRewards.length})
                                </button>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-success btn-sm" onclick="showCreateTransactionModalForMember('${memberId}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i> Transaction
                                </button>
                                <button class="btn btn-primary btn-sm" id="createRewardBtn${memberId}" onclick="showCreateRewardTransactionModalForMember('${memberId}')" style="display: ${(NewcoData.get('rewards') || {}).enabled ? 'inline-block' : 'none'}; padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    <i data-lucide="star" style="width: 16px; height: 16px;"></i> Reward
                                </button>
                                <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); padding: 0.5rem;">&times;</button>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div id="memberDetailContent" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Generate barcode and refresh icons after modal is displayed
            setTimeout(() => {
                try {
                    JsBarcode(`#memberBarcode${memberId}`, member.id, {
                        format: 'CODE128',
                        width: 1.2,
                        height: 35,
                        displayValue: false,
                        margin: 3
                    });
                } catch (error) {
                    console.error('Barcode generation error:', error);
                }

                // Refresh Lucide icons
                refreshIcons();
            }, 100);

            // Load default tab
            switchMemberTab('transactions', memberId);
        }

        function switchMemberTab(tab, memberId) {
            // Update tab buttons
            document.getElementById('memberTabTransactions')?.classList.remove('btn-primary');
            document.getElementById('memberTabTransactions')?.classList.add('btn-outline');
            document.getElementById('memberTabRewards')?.classList.remove('btn-primary');
            document.getElementById('memberTabRewards')?.classList.add('btn-outline');

            if (tab === 'transactions') {
                document.getElementById('memberTabTransactions')?.classList.remove('btn-outline');
                document.getElementById('memberTabTransactions')?.classList.add('btn-primary');
                loadMemberTransactions(memberId);
            } else if (tab === 'rewards') {
                document.getElementById('memberTabRewards')?.classList.remove('btn-outline');
                document.getElementById('memberTabRewards')?.classList.add('btn-primary');
                loadMemberRewards(memberId);
            }
        }

        function loadMemberTransactions(memberId) {
            const allTransactions = NewcoData.get('transactions') || [];
            const memberTransactions = allTransactions.filter(t => t.customerId === memberId || t.memberId === memberId);

            const content = document.getElementById('memberDetailContent');
            if (!content) return;

            if (memberTransactions.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📭</div>
                        <div style="font-size: 1.125rem;">No transactions found</div>
                    </div>
                `;
                return;
            }

            // Sort by date descending
            memberTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            content.innerHTML = `
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Source</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Type</th>
                                <th style="padding: 1rem; text-align: right; font-weight: 600;">Amount</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600;">Loyalty Earned</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberTransactions.map(t => {
                                const date = new Date(t.date);
                                const amount = t.amount || t.finalTotal || t.total || 0;
                                const loyalty = t.loyaltyEarned || t.loyaltyPointsEarned || 0;
                                return `
                                    <tr style="border-bottom: 1px solid var(--gray-lighter);">
                                        <td style="padding: 1rem;">
                                            <div style="font-weight: 600;">${date.toLocaleDateString()}</div>
                                            <div style="font-size: 0.875rem; color: var(--gray);">${date.toLocaleTimeString()}</div>
                                        </td>
                                        <td style="padding: 1rem;">${t.source || 'Manual Entry'}</td>
                                        <td style="padding: 1rem;">${t.type || 'purchase'}</td>
                                        <td style="padding: 1rem; text-align: right; font-weight: 600;">$${amount.toFixed(2)}</td>
                                        <td style="padding: 1rem; text-align: center;">${loyalty}</td>
                                        <td style="padding: 1rem; font-size: 0.875rem; color: var(--gray);">${t.reason || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function printMemberCard(memberId) {
            const member = membersData.find(m => m.id === memberId);
            if (!member) {
                showModal({
                    title: '❌ Error',
                    message: 'Member not found.',
                    type: 'error'
                });
                return;
            }

            const org = NewcoData.get('organization') || {};
            const memberName = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim() || 'Member';

            // Create printable card window
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Member Card - ${memberName}</title>
                    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
                    <style>
                        @page {
                            size: 3.375in 2.125in;
                            margin: 0;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: Arial, sans-serif;
                        }
                        .member-card {
                            width: 3.375in;
                            height: 2.125in;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            box-sizing: border-box;
                            page-break-after: always;
                            display: flex;
                            flex-direction: column;
                            justify-content: space-between;
                        }
                        .card-header {
                            text-align: center;
                            border-bottom: 2px solid rgba(255,255,255,0.3);
                            padding-bottom: 10px;
                        }
                        .org-name {
                            font-size: 18px;
                            font-weight: bold;
                            margin: 0 0 5px 0;
                        }
                        .card-title {
                            font-size: 12px;
                            opacity: 0.9;
                            margin: 0;
                        }
                        .card-body {
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                        }
                        .member-name {
                            font-size: 16px;
                            font-weight: bold;
                            margin: 10px 0 5px 0;
                            text-align: center;
                        }
                        .member-id {
                            font-size: 11px;
                            opacity: 0.8;
                            text-align: center;
                            margin-bottom: 10px;
                            font-family: monospace;
                        }
                        .barcode-container {
                            background: white;
                            padding: 8px;
                            border-radius: 4px;
                            text-align: center;
                        }
                        @media print {
                            .no-print {
                                display: none;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="member-card">
                        <div class="card-header">
                            <div class="org-name">${org.name || 'BINGO HALL'}</div>
                            <div class="card-title">MEMBER CARD</div>
                        </div>
                        <div class="card-body">
                            <div class="member-name">${memberName}</div>
                            <div class="member-id">ID: ${member.id}</div>
                            <div class="barcode-container">
                                <svg id="memberCardBarcode"></svg>
                            </div>
                        </div>
                    </div>
                    <div class="no-print" style="text-align: center; margin: 20px;">
                        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 6px;">🖨️ Print Card</button>
                        <button onclick="window.close()" style="padding: 10px 20px; font-size: 16px; cursor: pointer; background: #dc3545; color: white; border: none; border-radius: 6px; margin-left: 10px;">✕ Close</button>
                    </div>
                    <script>
                        window.onload = function() {
                            try {
                                JsBarcode("#memberCardBarcode", "${member.id}", {
                                    format: 'CODE128',
                                    width: 2,
                                    height: 50,
                                    displayValue: false,
                                    margin: 0
                                });
                            } catch (error) {
                                console.error('Barcode generation error:', error);
                            }
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function loadMemberRewards(memberId) {
            const allRewards = NewcoData.get('rewardTransactions') || [];
            const memberRewards = allRewards.filter(r => r.customerId === memberId || r.memberId === memberId);

            const content = document.getElementById('memberDetailContent');
            if (!content) return;

            if (memberRewards.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⭐</div>
                        <div style="font-size: 1.125rem;">No reward transactions found</div>
                    </div>
                `;
                return;
            }

            // Sort by date descending
            memberRewards.sort((a, b) => new Date(b.date) - new Date(a.date));

            content.innerHTML = `
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--gray-lighter);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Type</th>
                                <th style="padding: 1rem; text-align: right; font-weight: 600;">Points</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberRewards.map(r => {
                                const date = new Date(r.date);
                                // Handle different point field names and calculate the change
                                let pointChange = 0;
                                if (r.pointChange !== undefined) {
                                    pointChange = r.pointChange;
                                } else if (r.points !== undefined) {
                                    // For test data, points is always positive for 'earned' type
                                    pointChange = (r.type === 'redeemed' || r.type === 'points_redeemed') ? -r.points : r.points;
                                }
                                return `
                                    <tr style="border-bottom: 1px solid var(--gray-lighter);">
                                        <td style="padding: 1rem;">
                                            <div style="font-weight: 600;">${date.toLocaleDateString()}</div>
                                            <div style="font-size: 0.875rem; color: var(--gray);">${date.toLocaleTimeString()}</div>
                                        </td>
                                        <td style="padding: 1rem;">${(r.type || 'points_added').replace(/_/g, ' ')}</td>
                                        <td style="padding: 1rem; text-align: right; font-weight: 600; color: ${pointChange >= 0 ? '#4caf50' : '#f44336'};">
                                            ${pointChange >= 0 ? '+' : ''}${pointChange.toLocaleString()}
                                        </td>
                                        <td style="padding: 1rem; font-size: 0.875rem; color: var(--gray);">${r.description || r.reason || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showCreateTransactionModalForMember(memberId) {
            const member = membersData.find(m => m.id === memberId);
            if (!member) return;

            showModal({
                title: '<i data-lucide="credit-card" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i> Create Transaction',
                message: `
                    <div style="text-align: left;">
                        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-lighter); border-radius: 8px;">
                            <strong>Member:</strong> ${member.name || member.email}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Transaction Type</label>
                            <select id="createTransactionType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                                <option value="purchase">Purchase</option>
                                <option value="refund">Refund</option>
                                <option value="adjustment">Adjustment</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Amount ($)</label>
                            <input type="number" id="createTransactionAmount" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reason <span style="color: red;">*</span></label>
                            <textarea id="createTransactionReason" rows="3" placeholder="Enter reason for this transaction..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;"></textarea>
                        </div>
                    </div>
                `,
                type: 'info',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Create Transaction', type: 'primary', action: 'confirm' }
                ],
                onConfirm: async () => {
                    const type = document.getElementById('createTransactionType').value;
                    const amount = parseFloat(document.getElementById('createTransactionAmount').value);
                    const reason = document.getElementById('createTransactionReason').value.trim();

                    if (!amount || amount <= 0) {
                        showModal({ title: '⚠️ Error', message: 'Please enter a valid amount.', type: 'warning' });
                        return;
                    }
                    if (!reason) {
                        showModal({ title: '⚠️ Error', message: 'Reason is required for manual transactions.', type: 'warning' });
                        return;
                    }

                    const transactions = NewcoData.get('transactions') || [];

                    const newTransaction = {
                        id: 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        date: new Date(),
                        source: 'Manual Entry',
                        customerId: memberId,
                        customerName: member.name || member.email,
                        type: type,
                        amount: amount,
                        rewardsEligible: type === 'purchase',
                        loyaltyGranted: false,
                        loyaltyEarned: 0,
                        reason: reason,
                        createdBy: sessionStorage.getItem('newco_admin_email'),
                        isManual: true
                    };

                    transactions.unshift(newTransaction);
                    await NewcoData.set('transactions', transactions);

                    // Log activity
                    const activityLog = NewcoData.get('activityLog') || [];
                    const userEmail = sessionStorage.getItem('newco_admin_email');
                    const staff = NewcoData.get('staff') || [];
                    let userName = 'Admin';
                    const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail);
                    if (currentUser) {
                        userName = currentUser.name;
                    }

                    activityLog.unshift({
                        user: userName,
                        userEmail: userEmail,
                        section: 'members',
                        sectionName: 'Members',
                        action: `Created ${type} transaction for ${member.name || member.email}: $${amount.toFixed(2)}. Reason: ${reason}`,
                        timestamp: new Date().toISOString(),
                        isDetailed: true
                    });

                    if (activityLog.length > 100) {
                        activityLog.splice(100);
                    }

                    await NewcoData.set('activityLog', activityLog);

                    // Reload member detail view to show new transaction
                    loadMemberTransactions(memberId);

                    showModal({
                        title: '✅ Success',
                        message: `Transaction created successfully for ${member.name || member.email}.`,
                        type: 'success'
                    });

                    // Reload members to update stats
                    loadMembers();
                }
            });

            // Refresh icons after modal is displayed
            setTimeout(refreshIcons, 100);
        }

        function showCreateRewardTransactionModalForMember(memberId) {
            const member = membersData.find(m => m.id === memberId);
            if (!member) return;

            const currentPoints = member.points || member.loyaltyPoints || 0;

            showModal({
                title: '<i data-lucide="star" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i> Create Reward Transaction',
                message: `
                    <div style="text-align: left;">
                        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-lighter); border-radius: 8px;">
                            <strong>Member:</strong> ${member.name || member.email}<br>
                            <strong>Current Points:</strong> ${currentPoints.toLocaleString()}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Transaction Type</label>
                            <select id="createRewardType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                                <option value="points_added">Points Added</option>
                                <option value="points_redeemed">Points Redeemed</option>
                                <option value="bonus">Bonus Points</option>
                                <option value="adjustment">Adjustment</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Points</label>
                            <input type="number" id="createRewardPoints" min="0" placeholder="0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reason <span style="color: red;">*</span></label>
                            <textarea id="createRewardReason" rows="3" placeholder="Enter reason for this reward transaction..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;"></textarea>
                        </div>
                    </div>
                `,
                type: 'info',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Create Reward', type: 'primary', action: 'confirm' }
                ],
                onConfirm: async () => {
                    const type = document.getElementById('createRewardType').value;
                    const points = parseInt(document.getElementById('createRewardPoints').value);
                    const reason = document.getElementById('createRewardReason').value.trim();

                    if (!points || points <= 0) {
                        showModal({ title: '⚠️ Error', message: 'Please enter a valid points amount.', type: 'warning' });
                        return;
                    }
                    if (!reason) {
                        showModal({ title: '⚠️ Error', message: 'Reason is required for manual reward transactions.', type: 'warning' });
                        return;
                    }

                    const members = NewcoData.get('members') || [];
                    const memberIndex = members.findIndex(m => m.id === memberId);
                    if (memberIndex === -1) return;

                    const rewardTransactions = NewcoData.get('rewardTransactions') || [];

                    // Update member points
                    const isDeduction = type === 'points_redeemed';
                    const pointChange = isDeduction ? -points : points;
                    members[memberIndex].points = (members[memberIndex].points || 0) + pointChange;
                    members[memberIndex].loyaltyPoints = members[memberIndex].points;

                    const newReward = {
                        id: 'rwd_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        date: new Date(),
                        customerId: memberId,
                        customerName: member.name || member.email,
                        type: type,
                        points: points,
                        pointChange: pointChange,
                        description: reason,
                        createdBy: sessionStorage.getItem('newco_admin_email'),
                        isManual: true
                    };

                    rewardTransactions.unshift(newReward);
                    await NewcoData.set('members', members);
                    await NewcoData.set('rewardTransactions', rewardTransactions);

                    // Log activity
                    const activityLog = NewcoData.get('activityLog') || [];
                    const userEmail = sessionStorage.getItem('newco_admin_email');
                    const staff = NewcoData.get('staff') || [];
                    let userName = 'Admin';
                    const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail);
                    if (currentUser) {
                        userName = currentUser.name;
                    }

                    activityLog.unshift({
                        user: userName,
                        userEmail: userEmail,
                        section: 'members',
                        sectionName: 'Members',
                        action: `Created ${type.replace(/_/g, ' ')} for ${member.name || member.email}: ${pointChange >= 0 ? '+' : ''}${pointChange} points. Reason: ${reason}`,
                        timestamp: new Date().toISOString(),
                        isDetailed: true
                    });

                    if (activityLog.length > 100) {
                        activityLog.splice(100);
                    }

                    await NewcoData.set('activityLog', activityLog);

                    // Reload member detail view to show new reward transaction
                    loadMemberRewards(memberId);

                    showModal({
                        title: '✅ Success',
                        message: `Reward transaction created successfully for ${member.name || member.email}. New balance: ${members[memberIndex].points} points.`,
                        type: 'success'
                    });

                    // Reload members to update stats
                    loadMembers();
                }
            });

            // Refresh icons after modal is displayed
            setTimeout(refreshIcons, 100);
        }

        function exportMembers() {
            // Use the generic CSV export helper
            const columns = [
                { key: 'name', label: 'Name' },
                { key: 'email', label: 'Email' },
                { key: 'phone', label: 'Phone' },
                { key: 'loyaltyPoints', label: 'Loyalty Points' },
                { key: 'lifetimeLoyalty', label: 'Lifetime Loyalty' },
                { key: 'logins', label: 'Logins' },
                { key: 'lifetimeSpend', label: 'Lifetime Spend' },
                { key: 'averageSpend', label: 'Average Spend' },
                { key: 'monthlySpend', label: 'Monthly Spend' },
                { key: 'dateCreated', label: 'Date Created' },
                { key: 'lastLogin', label: 'Last Login' }
            ];
            
            exportToCSV(filteredMembers, columns, `members_${new Date().toISOString().split('T')[0]}.csv`);
            showSuccess('Members data exported successfully');
        }
        
        function addMember() {
            showModal({
                title: 'Add Member',
                message: 'Member addition form will be implemented here. This will allow adding new members with all their information.',
                type: 'info'
            });
        }
        
        function toggleTopPerformers() {
            const section = document.getElementById('topPerformersSection');
            const btn = document.getElementById('topPerformersBtn');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.innerHTML = '🏆 Hide Top Performers';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
                loadTopPerformers();
            } else {
                section.style.display = 'none';
                btn.innerHTML = '🏆 Top Performers';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
        }
        
        // Rewards Program Functions
        function loadRewards() {
            // Load loyalty program enabled state
            const rewards = NewcoData.get('rewards') || {};
            const wizardData = NewcoData.get('wizardData') || {};
            const isEnabled = rewards.enabled !== undefined ? rewards.enabled : (wizardData.rewards?.enabled !== undefined ? wizardData.rewards.enabled : true);
            const marketingText = document.getElementById('rewardsMarketingText');
            const content = document.getElementById('loyaltyProgramContent');

            document.getElementById('enableLoyaltyProgram').checked = isEnabled;

            // Show/hide marketing text vs content
            if (isEnabled) {
                marketingText.style.display = 'none';
                content.style.display = 'block';
            } else {
                marketingText.style.display = 'block';
                content.style.display = 'none';
            }

            // Update nav visibility based on loyalty program status
            updateLoyaltyNavVisibility(isEnabled);

            loadRewardsMetrics();
            loadRewardsConfiguration();
            loadRewardsTransactions();
        }

        function toggleLoyaltyProgram() {
            const isEnabled = document.getElementById('enableLoyaltyProgram').checked;
            const rewards = NewcoData.get('rewards') || {};
            const marketingText = document.getElementById('rewardsMarketingText');
            const content = document.getElementById('loyaltyProgramContent');

            rewards.enabled = isEnabled;
            NewcoData.set('rewards', rewards);

            // Show/hide marketing text vs content
            if (isEnabled) {
                marketingText.style.display = 'none';
                content.style.display = 'block';
            } else {
                marketingText.style.display = 'block';
                content.style.display = 'none';
            }

            // Show/hide loyalty-related nav items
            updateLoyaltyNavVisibility(isEnabled);

            showAutoSave();
        }

        function updateLoyaltyNavVisibility(isEnabled) {
            const navLoyaltyItems = document.getElementById('navLoyaltyItems');
            const navRewardsTransactions = document.getElementById('navRewardsTransactions');

            if (navLoyaltyItems) {
                navLoyaltyItems.style.display = isEnabled ? 'block' : 'none';
            }
            if (navRewardsTransactions) {
                navRewardsTransactions.style.display = isEnabled ? 'block' : 'none';
            }
        }

        function loadRewardsMetrics() {
            const period = document.getElementById('rewardsMonth')?.value || 'current';
            
            // Generate sample metrics
            const baseEarned = 15000 + Math.floor(Math.random() * 10000);
            const baseRedeemed = 8000 + Math.floor(Math.random() * 5000);
            const baseActive = 120 + Math.floor(Math.random() * 50);
            
            // Adjust based on period
            let multiplier = 1;
            if (period === '3months') multiplier = 3;
            if (period === '6months') multiplier = 6;
            if (period === 'year') multiplier = 12;
            
            document.getElementById('monthlyPointsEarned').textContent = (baseEarned * multiplier).toLocaleString();
            document.getElementById('monthlyPointsRedeemed').textContent = (baseRedeemed * multiplier).toLocaleString();
            document.getElementById('activeLoyaltyUsers').textContent = Math.floor(baseActive * (1 + multiplier * 0.1)).toLocaleString();
        }
        
        function loadTopPerformers() {
            const members = NewcoData.get('members') || [];
            
            // Sort for top earners
            const topEarners = [...members].sort((a, b) => b.loyaltyPoints - a.loyaltyPoints).slice(0, 5);
            document.getElementById('topEarners').innerHTML = topEarners.map((m, i) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--gray-lighter);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][i]}</span>
                        <span>${m.name}</span>
                    </div>
                    <span style="font-weight: 600; color: var(--success);">${m.loyaltyPoints.toLocaleString()} pts</span>
                </div>
            `).join('');
            
            // Sort for top redeemers (using lifetime loyalty as proxy)
            const topRedeemers = [...members].sort((a, b) => b.lifetimeLoyalty - a.loyaltyPoints).slice(0, 5);
            document.getElementById('topRedeemers').innerHTML = topRedeemers.map((m, i) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--gray-lighter);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][i]}</span>
                        <span>${m.name}</span>
                    </div>
                    <span style="font-weight: 600; color: var(--warning);">${Math.floor(m.lifetimeLoyalty * 0.3).toLocaleString()} pts</span>
                </div>
            `).join('');
            
            // Sort for most active
            const mostActive = [...members].sort((a, b) => b.logins - a.logins).slice(0, 5);
            document.getElementById('mostActive').innerHTML = mostActive.map((m, i) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--gray-lighter);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][i]}</span>
                        <span>${m.name}</span>
                    </div>
                    <span style="font-weight: 600; color: var(--primary);">${m.logins} visits</span>
                </div>
            `).join('');
        }
        
        function loadRewardsConfiguration() {
            const config = NewcoData.get('rewardsConfig') || {
                rewardType: 'lifetime',
                basicSettings: {
                    pointsPerDollar: 10,
                    webPointsPerDollar: 10,
                    floorPointsPerDollar: 10,
                    birthdayBonusPoints: 500,
                    signupBonusPoints: 100,
                    pointsExpiration: 'never',
                    minPointsRedeem: 100
                }
            };
            
            console.log('Loading rewards configuration:', config);
            
            // If no config exists in localStorage, save the defaults
            const existingConfig = NewcoData.get('rewardsConfig');
            if (!existingConfig || !existingConfig.rewardType) {
                console.log('No rewards config found, saving defaults:', config);
                NewcoData.set('rewardsConfig', config);
            }
            
            // Set reward type
            if (config.rewardType) {
                const rewardTypeRadio = document.querySelector(`input[name="rewardType"][value="${config.rewardType}"]`);
                if (rewardTypeRadio) {
                    rewardTypeRadio.checked = true;
                    applyRewardTypeChange(config.rewardType);
                }
            }
            
            // Load basic settings
            if (config.basicSettings) {
                const pointsPerDollarEl = document.getElementById('pointsPerDollar');
                const webPointsPerDollarEl = document.getElementById('webPointsPerDollar');
                const floorPointsPerDollarEl = document.getElementById('floorPointsPerDollar');
                const birthdayBonusEl = document.getElementById('birthdayBonusPoints');
                const signupBonusEl = document.getElementById('signupBonusPoints');
                const pointsExpirationEl = document.getElementById('pointsExpiration');
                const minPointsRedeemEl = document.getElementById('minPointsRedeem');
                const pointsCurrencyEl = document.getElementById('rewardsPointsCurrency');
                
                if (pointsPerDollarEl) pointsPerDollarEl.value = config.basicSettings.pointsPerDollar || 10;
                if (webPointsPerDollarEl) webPointsPerDollarEl.value = config.basicSettings.webPointsPerDollar || 10;
                if (floorPointsPerDollarEl) floorPointsPerDollarEl.value = config.basicSettings.floorPointsPerDollar || 10;
                if (birthdayBonusEl) birthdayBonusEl.value = config.basicSettings.birthdayBonusPoints || 500;
                if (signupBonusEl) signupBonusEl.value = config.basicSettings.signupBonusPoints || 100;
                if (pointsExpirationEl) pointsExpirationEl.value = config.basicSettings.pointsExpiration || 'never';
                if (minPointsRedeemEl) minPointsRedeemEl.value = config.basicSettings.minPointsRedeem || 100;
                if (pointsCurrencyEl) pointsCurrencyEl.value = config.basicSettings.pointsCurrencyName || 'Loyalty Points';
                
                // Load birthday requirement settings
                if (config.basicSettings.birthdayRequirement) {
                    const birthdayReqRadio = document.querySelector(`input[name="birthdayRequirement"][value="${config.basicSettings.birthdayRequirement}"]`);
                    if (birthdayReqRadio) birthdayReqRadio.checked = true;
                }
                
                const birthdayEmailCheckbox = document.getElementById('birthdayTriggerEmail');
                if (birthdayEmailCheckbox) {
                    birthdayEmailCheckbox.checked = config.basicSettings.birthdayTriggerEmail || false;
                }
                
                const emailDaysBeforeEl = document.getElementById('birthdayEmailDaysBefore');
                if (emailDaysBeforeEl) {
                    emailDaysBeforeEl.value = config.basicSettings.birthdayEmailDaysBefore || 7;
                }
            }
            
            // Load tier-specific settings based on type
            if (config.rewardType === 'lifetime' && config.lifetimeTiers) {
                // Load lifetime tier settings
                const tiers = config.lifetimeTiers;
                if (tiers.tier1) {
                    document.getElementById('tier1Name').value = tiers.tier1.name || 'Bronze';
                    document.getElementById('tier1Points').value = tiers.tier1.points || 0;
                    document.getElementById('tier1DiscountType').value = tiers.tier1.discountType || 'none';
                    document.getElementById('tier1Discount').value = tiers.tier1.discount || 0;
                    document.getElementById('tier1BonusType').value = tiers.tier1.bonusType || 'none';
                    document.getElementById('tier1Multiplier').value = tiers.tier1.multiplier || 1;
                }
                // Similar for tier2 and tier3...
            }
        }
        
        function loadPointsConfiguration() {
            // Redirect to new function
            loadRewardsConfiguration();
        }
        
        function showComingSoonModal(featureName) {
            showModal({
                title: 'Coming Soon',
                message: `<p><strong>${featureName}</strong> is not yet available.</p><p>This feature will be released in a future update. For now, please use <strong>Bonuses Only</strong> mode.</p>`,
                type: 'info',
                confirmText: 'Got It'
            });
        }

        function updateRewardType(type) {
            // Just update the UI - no warnings until save
            applyRewardTypeChange(type);
        }

        function toggleBirthdayBonus() {
            const enabled = document.getElementById('birthdayBonusEnabled').checked;
            const config = document.getElementById('birthdayBonusConfig');
            config.style.display = enabled ? 'block' : 'none';
            if (enabled) {
                toggleEmailDaysBefore();
            }
        }
        
        function toggleEmailDaysBefore() {
            const triggerEmail = document.getElementById('birthdayTriggerEmail');
            const daysContainer = document.getElementById('emailDaysBeforeContainer');
            if (triggerEmail && daysContainer) {
                daysContainer.style.display = triggerEmail.checked ? 'flex' : 'none';
            }
        }
        
        function toggleSignupBonus() {
            const enabled = document.getElementById('signupBonusEnabled').checked;
            const config = document.getElementById('signupBonusConfig');
            config.style.display = enabled ? 'block' : 'none';
        }
        
        function getRewardTypeName(type) {
            const names = {
                'lifetime': '🏆 Lifetime Tiers (Permanent status levels)',
                'temporary': '⏰ Temporary Tiers (Time-limited purchased status)',
                'bonuses': '🎁 Bonuses Only (Simple points system)'
            };
            return names[type] || type;
        }
        
        function applyRewardTypeChange(type) {
            // Hide all config sections
            document.getElementById('lifetimeTiersConfig').style.display = 'none';
            document.getElementById('temporaryTiersConfig').style.display = 'none';
            document.getElementById('bonusesOnlyConfig').style.display = 'none';
            
            // Show selected config
            if (type === 'lifetime') {
                document.getElementById('lifetimeTiersConfig').style.display = 'block';
            } else if (type === 'temporary') {
                document.getElementById('temporaryTiersConfig').style.display = 'block';
            } else if (type === 'bonuses') {
                document.getElementById('bonusesOnlyConfig').style.display = 'block';
            }
        }
        
        function saveRewardsConfig() {
            const rewardType = document.querySelector('input[name="rewardType"]:checked').value;
            
            // Check if system has been live for 30 days
            const systemConfig = NewcoData.get('systemConfig') || {};
            const goLiveDate = systemConfig.goLiveDate;
            
            if (goLiveDate) {
                const daysSinceLive = Math.floor((Date.now() - new Date(goLiveDate).getTime()) / (1000 * 60 * 60 * 24));
                if (daysSinceLive >= 30) {
                    // Check if trying to change type
                    const currentConfig = NewcoData.get('rewardsConfig') || { rewardType: 'lifetime' };
                    if (currentConfig.rewardType && currentConfig.rewardType !== rewardType) {
                        showModal({
                            title: '🔒 Reward Type Locked',
                            message: `<div style="font-size: 1.1rem; line-height: 1.6;">
                                <p style="margin-bottom: 1rem;"><strong>Your reward program type has been locked.</strong></p>
                                <p style="margin-bottom: 1rem;">Once your system has been live for 30 days, the fundamental reward program type cannot be changed to maintain consistency for your members.</p>
                                <p style="margin-bottom: 0.5rem;">Your system went live: <strong>${new Date(goLiveDate).toLocaleDateString()}</strong></p>
                                <p>Days since live: <strong>${daysSinceLive} days</strong></p>
                            </div>`,
                            type: 'error'
                        });
                        
                        // Reset to current saved type
                        document.querySelector(`input[name="rewardType"][value="${currentConfig.rewardType}"]`).checked = true;
                        applyRewardTypeChange(currentConfig.rewardType);
                        return;
                    }
                }
            }
            
            // Get current saved reward type
            const currentConfig = NewcoData.get('rewardsConfig') || {};
            
            // If changing from the saved type, show warning
            if (currentConfig.rewardType && currentConfig.rewardType !== rewardType) {
                showModal({
                    type: 'confirm',
                    title: '⚠️ Change Reward Type',
                    message: `<div style="font-size: 1.05rem; line-height: 1.6;">
                        <p style="margin-bottom: 1rem;"><strong style="color: var(--danger);">WARNING: You are about to change the fundamental TYPE of reward program!</strong></p>
                        <p style="margin-bottom: 1rem;">This is a very important choice that affects how your entire loyalty system works:</p>
                        <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                            <li style="margin-bottom: 0.5rem;"><strong>Current:</strong> ${getRewardTypeName(currentConfig.rewardType)}</li>
                            <li style="margin-bottom: 0.5rem;"><strong>New:</strong> ${getRewardTypeName(rewardType)}</li>
                        </ul>
                        <p>Are you absolutely sure you want to make this change?</p>
                    </div>`,
                    confirmText: 'Yes, Change Type',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                        // User confirmed - proceed with save
                        performRewardsSave(rewardType);
                    },
                    onCancel: () => {
                        // User cancelled - revert selection
                        document.querySelector(`input[name="rewardType"][value="${currentConfig.rewardType}"]`).checked = true;
                        applyRewardTypeChange(currentConfig.rewardType);
                    }
                });
            } else {
                // No change or first time setting - just save
                performRewardsSave(rewardType);
            }
        }
        
        function performRewardsSave(rewardType) {
            const config = {
                rewardType: rewardType,
                basicSettings: {
                    webPointsPerDollar: parseInt(document.getElementById('webPointsPerDollar')?.value) || 10,
                    floorPointsPerDollar: parseInt(document.getElementById('floorPointsPerDollar')?.value) || 10,
                    pointsPerDollar: parseInt(document.getElementById('pointsPerDollar')?.value) || 10, // Legacy fallback
                    birthdayBonusPoints: parseInt(document.getElementById('birthdayBonusPoints')?.value) || 0,
                    signupBonusPoints: parseInt(document.getElementById('signupBonusPoints')?.value) || 0,
                    pointsExpiration: document.getElementById('pointsExpiration')?.value || 'never',
                    minPointsRedeem: parseInt(document.getElementById('minPointsRedeem')?.value) || 100,
                    pointsCurrencyName: document.getElementById('rewardsPointsCurrency')?.value || 'Loyalty Points',
                    // Birthday reward settings
                    birthdayRequirement: document.querySelector('input[name="birthdayRequirement"]:checked')?.value || 'automatic',
                    birthdayTriggerEmail: document.getElementById('birthdayTriggerEmail')?.checked || false,
                    birthdayEmailDaysBefore: parseInt(document.getElementById('birthdayEmailDaysBefore')?.value) || 7
                }
            };
            
            if (rewardType === 'lifetime') {
                config.lifetimeTiers = {
                    tier1: {
                        name: document.getElementById('tier1Name').value,
                        points: parseInt(document.getElementById('tier1Points').value),
                        discountType: document.getElementById('tier1DiscountType').value,
                        discount: parseInt(document.getElementById('tier1Discount').value),
                        bonusType: document.getElementById('tier1BonusType').value,
                        multiplier: parseFloat(document.getElementById('tier1Multiplier').value)
                    },
                    tier2: {
                        name: document.getElementById('tier2Name').value,
                        points: parseInt(document.getElementById('tier2Points').value),
                        discountType: document.getElementById('tier2DiscountType').value,
                        discount: parseInt(document.getElementById('tier2Discount').value),
                        bonusType: document.getElementById('tier2BonusType').value,
                        multiplier: parseFloat(document.getElementById('tier2Multiplier').value)
                    },
                    tier3: {
                        name: document.getElementById('tier3Name').value,
                        points: parseInt(document.getElementById('tier3Points').value),
                        discountType: document.getElementById('tier3DiscountType').value,
                        discount: parseInt(document.getElementById('tier3Discount').value),
                        bonusType: document.getElementById('tier3BonusType').value,
                        multiplier: parseFloat(document.getElementById('tier3Multiplier').value)
                    }
                };
            } else if (rewardType === 'temporary') {
                config.temporaryTiers = {
                    tier1: {
                        name: document.getElementById('tempTier1Name').value,
                        cost: parseFloat(document.getElementById('tempTier1Cost').value),
                        duration: parseInt(document.getElementById('tempTier1Duration').value),
                        discountType: document.getElementById('tempTier1DiscountType').value,
                        discount: parseInt(document.getElementById('tempTier1Discount').value),
                        bonusType: document.getElementById('tempTier1BonusType').value,
                        multiplier: parseFloat(document.getElementById('tempTier1Multiplier').value)
                    },
                    tier2: {
                        name: document.getElementById('tempTier2Name').value,
                        cost: parseFloat(document.getElementById('tempTier2Cost').value),
                        duration: parseInt(document.getElementById('tempTier2Duration').value),
                        discountType: document.getElementById('tempTier2DiscountType').value,
                        discount: parseInt(document.getElementById('tempTier2Discount').value),
                        bonusType: document.getElementById('tempTier2BonusType').value,
                        multiplier: parseFloat(document.getElementById('tempTier2Multiplier').value)
                    }
                };
            } else if (rewardType === 'bonuses') {
                config.bonusesOnly = {
                    referralBonus: parseInt(document.getElementById('referralBonus').value),
                    reviewBonus: parseInt(document.getElementById('reviewBonus').value),
                    socialBonus: parseInt(document.getElementById('socialBonus').value)
                };
            }
            
            console.log('Saving rewards config:', config);
            NewcoData.set('rewardsConfig', config);
            
            // Verify it was saved
            const savedConfig = NewcoData.get('rewardsConfig');
            console.log('Saved rewards config verified:', savedConfig);
            
            showSuccess('Rewards configuration saved successfully');
        }
        
        function savePointsConfig() {
            // Redirect to new function
            saveRewardsConfig();
        }
        
        function toggleTempTierPayment(tierNumber) {
            const cashCheckbox = document.getElementById(`tempTier${tierNumber}PayCash`);
            const pointsCheckbox = document.getElementById(`tempTier${tierNumber}PayPoints`);
            const cashCostDiv = document.getElementById(`tempTier${tierNumber}CashCost`);
            const pointsCostDiv = document.getElementById(`tempTier${tierNumber}PointsCost`);
            
            // Ensure at least one payment method is selected
            if (!cashCheckbox.checked && !pointsCheckbox.checked) {
                // If trying to uncheck both, keep the current one checked
                if (cashCostDiv.style.display !== 'none') {
                    cashCheckbox.checked = true;
                } else {
                    pointsCheckbox.checked = true;
                }
                showModal({
                    title: '⚠️ Payment Method Required',
                    message: 'At least one payment method must be available for each tier.',
                    type: 'warning'
                });
                return;
            }
            
            // Show/hide cost fields based on selected payment methods
            cashCostDiv.style.display = cashCheckbox.checked ? 'block' : 'none';
            pointsCostDiv.style.display = pointsCheckbox.checked ? 'block' : 'none';
            
            // Update labels if both are selected
            const cashLabel = cashCostDiv.querySelector('.form-label');
            const pointsLabel = pointsCostDiv.querySelector('.form-label');
            
            if (cashCheckbox.checked && pointsCheckbox.checked) {
                cashLabel.textContent = 'Cost ($) - Alternative 1';
                pointsLabel.textContent = 'Cost (Points) - Alternative 2';
            } else {
                cashLabel.textContent = 'Cost ($)';
                pointsLabel.textContent = 'Cost (Points)';
            }
        }

        // Create Examples Functions
        function createSalesItemExamples() {
            // Check usage count from organization data (not localStorage)
            const org = NewcoData.get('organization') || {};
            const usageCount = parseInt(org.salesItemExamplesCount || '0');
            if (usageCount >= 3) {
                showError('Maximum examples reached. You can create up to 15 example basic offerings (3 batches of 5).');
                return;
            }

            showConfirm(
                `This will add 5 example basic offerings to your system (${usageCount + 1} of 3). Continue?`,
                () => {
                    // Create different examples based on which batch this is
                    let examples = [];

                    if (usageCount === 0) {
                        // First batch - Basic offerings
                        examples = [
                            {
                                id: Date.now().toString(),
                                name: 'Double Action (2)',
                                description: 'Double Action game pack',
                                price: 5,
                                art: '🎫',
                                canBuyWithLoyalty: false,
                                givesBonus: false,
                                limitPerCustomer: 0,
                                order: 1,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 1).toString(),
                                name: '6-on Paper Regular Games',
                                description: 'Standard 6-on paper cards for all regular games',
                                price: 10,
                                art: '🎯',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 1000,
                                givesBonus: true,
                                bonusType: 'fixed',
                                bonusFixed: 100,
                                limitPerCustomer: 5,
                                order: 2,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 2).toString(),
                                name: 'Electronic Package',
                                description: '24 electronic cards for all regular and special games',
                                price: 25,
                                art: '📱',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 2500,
                                givesBonus: true,
                                bonusType: 'multiplier',
                                bonusMultiplier: 2,
                                limitPerCustomer: 2,
                                order: 3,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 3).toString(),
                                name: 'Dauber Set',
                                description: 'Set of 3 colorful bingo daubers',
                                price: 5,
                                art: '🖊️',
                                canBuyWithLoyalty: false,
                                givesBonus: false,
                                limitPerCustomer: 10,
                                order: 4,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 4).toString(),
                                name: 'Progressive Jackpot Entry',
                                description: 'Entry into the progressive jackpot game',
                                price: 2,
                                art: '💰',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 200,
                                givesBonus: true,
                                bonusType: 'fixed',
                                bonusFixed: 20,
                                limitPerCustomer: 3,
                                order: 5,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            }
                        ];
                    } else if (usageCount === 1) {
                        // Second batch - More advanced offerings
                        examples = [
                            {
                                id: Date.now().toString(),
                                name: 'Triple Action (3)',
                                description: 'Triple Action game pack with bonus chances',
                                price: 8,
                                art: '🎰',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 800,
                                givesBonus: true,
                                bonusType: 'fixed',
                                bonusFixed: 80,
                                limitPerCustomer: 4,
                                order: 6,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 1).toString(),
                                name: '9-on Paper Special Games',
                                description: 'Extended 9-on paper for special game sessions',
                                price: 15,
                                art: '🎲',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 1500,
                                givesBonus: true,
                                bonusType: 'multiplier',
                                bonusMultiplier: 1.5,
                                limitPerCustomer: 3,
                                order: 7,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 2).toString(),
                                name: 'Lucky Charm Card',
                                description: 'Special lucky number card with bonus features',
                                price: 12,
                                art: '🍀',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 1200,
                                givesBonus: true,
                                bonusType: 'fixed',
                                bonusFixed: 150,
                                limitPerCustomer: 2,
                                order: 8,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 3).toString(),
                                name: 'Pull-Tab Game Sheet',
                                description: 'Set of 5 pull-tab instant win games',
                                price: 10,
                                art: '🎟️',
                                canBuyWithLoyalty: false,
                                givesBonus: false,
                                limitPerCustomer: 5,
                                order: 9,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 4).toString(),
                                name: 'Bonus Ball Entry',
                                description: 'Entry for bonus ball jackpot round',
                                price: 3,
                                art: '⚡',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 300,
                                givesBonus: true,
                                bonusType: 'fixed',
                                bonusFixed: 30,
                                limitPerCustomer: 10,
                                order: 10,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            }
                        ];
                    } else {
                        // Third batch - Premium offerings
                        examples = [
                            {
                                id: Date.now().toString(),
                                name: 'Mega Electronic Pack',
                                description: '48 electronic cards with auto-daub feature',
                                price: 35,
                                art: '💻',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 3500,
                                givesBonus: true,
                                bonusType: 'multiplier',
                                bonusMultiplier: 3,
                                limitPerCustomer: 1,
                                order: 11,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 1).toString(),
                                name: 'Hardway Bingo Cards',
                                description: 'Special hardway pattern cards',
                                price: 18,
                                art: '🔷',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 1800,
                                givesBonus: true,
                                bonusType: 'fixed',
                                bonusFixed: 200,
                                limitPerCustomer: 3,
                                order: 12,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 2).toString(),
                                name: 'Coverall Special Entry',
                                description: 'Entry into coverall jackpot game',
                                price: 7,
                                art: '🎊',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 700,
                                givesBonus: true,
                                bonusType: 'fixed',
                                bonusFixed: 70,
                                limitPerCustomer: 5,
                                order: 13,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 3).toString(),
                                name: 'VIP Dauber Kit',
                                description: 'Premium dauber set with 6 colors and holder',
                                price: 12,
                                art: '✏️',
                                canBuyWithLoyalty: false,
                                givesBonus: false,
                                limitPerCustomer: 2,
                                order: 14,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 4).toString(),
                                name: 'Speed Bingo Cards',
                                description: 'Fast-paced speed bingo game cards',
                                price: 6,
                                art: '⚡',
                                canBuyWithLoyalty: true,
                                loyaltyPointsCost: 600,
                                givesBonus: true,
                                bonusType: 'multiplier',
                                bonusMultiplier: 1.5,
                                limitPerCustomer: 8,
                                order: 15,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            }
                        ];
                    }
                    
                    // Get existing items or empty array
                    let existingItems = NewcoData.get('salesItems') || [];
                    
                    // Add each example
                    examples.forEach(item => {
                        existingItems.push(item);
                    });
                    
                    // Save all items
                    NewcoData.set('salesItems', existingItems);

                    // Increment usage count in organization data
                    const newCount = usageCount + 1;
                    org.salesItemExamplesCount = newCount;
                    NewcoData.set('organization', org);

                    // Reload the display
                    loadSalesItems();

                    // Update button state if max reached
                    if (newCount >= 3) {
                        showSuccess('5 example offerings added successfully! Maximum examples reached (15 total).');
                        updateExampleButtonStates();
                    } else {
                        showSuccess(`5 example offerings added successfully! (${newCount} of 3 batches)`);
                    }

                    // Remove pulse animation from button
                    const btn = document.querySelector('.create-examples-btn.pulse');
                    if (btn) btn.classList.remove('pulse');
                },
                'Add Examples'
            );
        }
        
        function createPackageExamples() {
            // Check usage count from organization data (not localStorage)
            const org = NewcoData.get('organization') || {};
            const usageCount = parseInt(org.packageExamplesCount || '0');
            if (usageCount >= 3) {
                showError('Maximum examples reached. You can create up to 12 example packages (3 batches of 4).');
                return;
            }

            showConfirm(
                `This will add 4 example packages to your system (${usageCount + 1} of 3). Continue?`,
                () => {
                    // Get existing sales items to include in packages
                    const salesItems = NewcoData.get('salesItems') || [];

                    // Helper function to select items based on package price
                    function getItemsForPackage(priceRange) {
                        const selectedItems = [];
                        const availableItems = salesItems.filter(item => item.price <= priceRange / 2);

                        if (availableItems.length === 0) return [];

                        // Select 2-4 items based on price
                        const itemCount = priceRange < 25 ? 2 : priceRange < 50 ? 3 : 4;
                        const itemsToAdd = Math.min(itemCount, availableItems.length);

                        for (let i = 0; i < itemsToAdd; i++) {
                            const item = availableItems[Math.floor(Math.random() * availableItems.length)];
                            if (!selectedItems.find(si => si.itemId === item.id)) {
                                selectedItems.push({
                                    itemId: item.id,
                                    itemName: item.name,
                                    quantity: 1
                                });
                            }
                        }

                        return selectedItems;
                    }

                    let examples = [];

                    if (usageCount === 0) {
                        // First batch - Standard packages
                        examples = [
                            {
                                id: Date.now().toString(),
                                name: 'Early Bird Special',
                                description: 'Perfect for early arrivals - includes early bird games and regular session',
                                price: 15,
                                originalPrice: 20,
                                art: '🌅',
                                items: getItemsForPackage(15),
                                seatSelection: true,
                                badges: ['popular'],
                                loyaltyPrice: 1500,
                                givesExtraPoints: true,
                                pointsMultiplier: 1.5,
                                order: 1,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 1).toString(),
                                name: 'Power Pack',
                                description: 'Our most popular package - everything you need for a great session',
                                price: 35,
                                originalPrice: 45,
                                art: '⚡',
                                items: getItemsForPackage(35),
                                seatSelection: true,
                                badges: ['bestValue', 'popular'],
                                loyaltyPrice: 3500,
                                givesExtraPoints: true,
                                bonusPoints: 500,
                                order: 2,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 2).toString(),
                                name: 'VIP Experience',
                                description: 'Premium package with reserved seating and complimentary refreshments',
                                price: 75,
                                art: '👑',
                                items: getItemsForPackage(75),
                                seatSelection: true,
                                badges: ['new'],
                                loyaltyPrice: 7500,
                                givesExtraPoints: true,
                                pointsMultiplier: 3,
                                order: 3,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 3).toString(),
                                name: 'Family Fun Pack',
                                description: 'Great value for groups - includes 4 player positions',
                                price: 60,
                                originalPrice: 80,
                                art: '👨‍👩‍👧‍👦',
                                items: getItemsForPackage(60),
                                seatSelection: true,
                                badges: ['bestValue'],
                                loyaltyPrice: 6000,
                                givesExtraPoints: true,
                                bonusPoints: 300,
                                order: 4,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            }
                        ];
                    } else if (usageCount === 1) {
                        // Second batch - Special event packages
                        examples = [
                            {
                                id: Date.now().toString(),
                                name: 'Weekend Warrior',
                                description: 'Extended play package for weekend sessions with bonus games',
                                price: 45,
                                originalPrice: 60,
                                art: '🎮',
                                items: getItemsForPackage(45),
                                seatSelection: true,
                                badges: ['popular'],
                                loyaltyPrice: 4500,
                                givesExtraPoints: true,
                                bonusPoints: 400,
                                order: 5,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 1).toString(),
                                name: 'Midnight Madness',
                                description: 'Late night package with special jackpot games',
                                price: 40,
                                originalPrice: 50,
                                art: '🌙',
                                items: getItemsForPackage(40),
                                seatSelection: true,
                                badges: ['new'],
                                loyaltyPrice: 4000,
                                givesExtraPoints: true,
                                pointsMultiplier: 2,
                                order: 6,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 2).toString(),
                                name: 'Lucky 7 Package',
                                description: 'Seven games of fun with progressive jackpot entries',
                                price: 28,
                                originalPrice: 35,
                                art: '🎰',
                                items: getItemsForPackage(28),
                                seatSelection: true,
                                badges: ['bestValue'],
                                loyaltyPrice: 2800,
                                givesExtraPoints: true,
                                bonusPoints: 250,
                                order: 7,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 3).toString(),
                                name: 'Seniors Special',
                                description: 'Discounted package for seniors 55+ with complimentary refreshments',
                                price: 20,
                                originalPrice: 30,
                                art: '🎖️',
                                items: getItemsForPackage(20),
                                seatSelection: true,
                                badges: ['popular'],
                                loyaltyPrice: 2000,
                                givesExtraPoints: true,
                                pointsMultiplier: 1.5,
                                order: 8,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            }
                        ];
                    } else {
                        // Third batch - Premium/Theme packages
                        examples = [
                            {
                                id: Date.now().toString(),
                                name: 'High Roller Package',
                                description: 'Premium all-inclusive package with reserved premium seating',
                                price: 95,
                                originalPrice: 120,
                                art: '💎',
                                items: getItemsForPackage(95),
                                seatSelection: true,
                                badges: ['bestValue', 'new'],
                                loyaltyPrice: 9500,
                                givesExtraPoints: true,
                                pointsMultiplier: 4,
                                order: 9,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 1).toString(),
                                name: 'Holiday Special',
                                description: 'Festive themed package with bonus prize drawings',
                                price: 50,
                                originalPrice: 65,
                                art: '🎉',
                                items: getItemsForPackage(50),
                                seatSelection: true,
                                badges: ['popular'],
                                loyaltyPrice: 5000,
                                givesExtraPoints: true,
                                bonusPoints: 600,
                                order: 10,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 2).toString(),
                                name: 'Tournament Entry Package',
                                description: 'Entry to monthly tournament with qualifying games',
                                price: 55,
                                originalPrice: 70,
                                art: '🏆',
                                items: getItemsForPackage(55),
                                seatSelection: true,
                                badges: ['new'],
                                loyaltyPrice: 5500,
                                givesExtraPoints: true,
                                pointsMultiplier: 2.5,
                                order: 11,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            },
                            {
                                id: (Date.now() + 3).toString(),
                                name: 'Super Session Bundle',
                                description: 'Double session package - play afternoon and evening games',
                                price: 70,
                                originalPrice: 90,
                                art: '🌟',
                                items: getItemsForPackage(70),
                                seatSelection: true,
                                badges: ['bestValue'],
                                loyaltyPrice: 7000,
                                givesExtraPoints: true,
                                bonusPoints: 800,
                                order: 12,
                                hasDateRestrictions: false,
                                availableDays: [],
                                validFrom: null,
                                validUntil: null,
                                specialEventsOnly: false
                            }
                        ];
                    }

                    // Get existing packages or empty array
                    let existingPackages = NewcoData.get('packages') || [];

                    // Add each example
                    examples.forEach(pkg => {
                        existingPackages.push(pkg);
                    });

                    // Save all packages
                    NewcoData.set('packages', existingPackages);

                    // Increment usage count in organization data
                    const newCount = usageCount + 1;
                    org.packageExamplesCount = newCount;
                    NewcoData.set('organization', org);

                    // Reload the display
                    loadPackages();

                    // Update button state if max reached
                    if (newCount >= 3) {
                        showSuccess('4 example packages added successfully! Maximum examples reached (12 total).');
                        updateExampleButtonStates();
                    } else {
                        showSuccess(`4 example packages added successfully! (${newCount} of 3 batches)`);
                    }
                },
                'Add Examples'
            );
        }

        // Update example button states based on usage count
        function updateExampleButtonStates() {
            const org = NewcoData.get('organization') || {};
            const salesItemCount = parseInt(org.salesItemExamplesCount || '0');
            const packageCount = parseInt(org.packageExamplesCount || '0');

            // Find all Create Examples buttons
            const buttons = document.querySelectorAll('.create-examples-btn');
            buttons.forEach(btn => {
                const isSalesItemBtn = btn.onclick && btn.onclick.toString().includes('createSalesItemExamples');
                const isPackageBtn = btn.onclick && btn.onclick.toString().includes('createPackageExamples');

                if (isSalesItemBtn && salesItemCount >= 3) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.textContent = '✅ Max Examples (15)';
                } else if (isPackageBtn && packageCount >= 3) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.textContent = '✅ Max Examples (12)';
                }
            });
        }

        function createLoyaltyExamples() {
            showConfirm(
                'This will add 4 example loyalty items to your system. Continue?',
                () => {
                    const examples = [
                        {
                            id: Date.now().toString(),
                            name: 'Free Session Pass',
                            description: 'Redeem for one free regular bingo session',
                            pointsCost: 5000,
                            cashValue: 50,
                            art: '🎫',
                            type: 'freeItem',
                            limitPerMember: 2,
                            expiresInDays: 30,
                            order: 1,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        },
                        {
                            id: (Date.now() + 1).toString(),
                            name: '25% Off Next Purchase',
                            description: 'Save 25% on your next package purchase',
                            pointsCost: 2000,
                            cashValue: 10,
                            art: '🏷️',
                            type: 'discount',
                            limitPerMember: 3,
                            expiresInDays: 14,
                            order: 2,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        },
                        {
                            id: (Date.now() + 2).toString(),
                            name: 'VIP Lounge Access',
                            description: 'Exclusive access to VIP lounge with complimentary refreshments',
                            pointsCost: 3000,
                            cashValue: 30,
                            art: '🥂',
                            type: 'experience',
                            limitPerMember: 1,
                            order: 3,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        },
                        {
                            id: (Date.now() + 3).toString(),
                            name: 'Branded Merchandise',
                            description: 'Choose from t-shirt, cap, or tote bag with our logo',
                            pointsCost: 1500,
                            cashValue: 20,
                            art: '👕',
                            type: 'merchandise',
                            order: 4,
                            hasDateRestrictions: false,
                            availableDays: [],
                            validFrom: null,
                            validUntil: null
                        }
                    ];
                    
                    // Get existing loyalty items or empty array
                    let existingLoyalty = NewcoData.get('loyaltyItems') || [];
                    
                    // Add each example
                    examples.forEach(item => {
                        existingLoyalty.push(item);
                    });
                    
                    // Save all loyalty items
                    NewcoData.set('loyaltyItems', existingLoyalty);
                    
                    // Reload the display
                    loadLoyaltyItems();
                    showSuccess('4 example loyalty items added successfully!');
                },
                'Add Examples'
            );
        }

        // Initialize art storage from stored data
        function initializeArtStorage() {
            if (!window.artStorage) {
                window.artStorage = {};
            }
            
            // Restore art data from all stored items
            const salesItems = NewcoData.get('salesItems') || [];
            const packages = NewcoData.get('packages') || [];
            const loyaltyItems = NewcoData.get('loyaltyItems') || [];
            const organization = NewcoData.get('organization') || {};
            
            // For backward compatibility with items that still have direct art properties
            // (from before we switched to memory-only storage)
            salesItems.forEach(item => {
                if (item.bannerArt && !item.bannerArtId) {
                    const artId = 'legacy_sales_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.bannerArt;
                    item.bannerArtId = artId;
                }
                if (item.backgroundArt && !item.backgroundArtId) {
                    const artId = 'legacy_sales_bg_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.backgroundArt;
                    item.backgroundArtId = artId;
                }
                if (item.art && !item.bannerArtId && !item.backgroundArtId) {
                    const artId = 'legacy_sales_general_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.art;
                    item.bannerArtId = artId;
                }
            });
            
            // For backward compatibility with packages
            packages.forEach(pkg => {
                if (pkg.bannerArt && !pkg.bannerArtId) {
                    const artId = 'legacy_pkg_' + pkg.id + '_' + Date.now();
                    window.artStorage[artId] = pkg.bannerArt;
                    pkg.bannerArtId = artId;
                }
                if (pkg.backgroundArt && !pkg.backgroundArtId) {
                    const artId = 'legacy_pkg_bg_' + pkg.id + '_' + Date.now();
                    window.artStorage[artId] = pkg.backgroundArt;
                    pkg.backgroundArtId = artId;
                }
                if (pkg.art && !pkg.bannerArtId && !pkg.backgroundArtId) {
                    const artId = 'legacy_pkg_general_' + pkg.id + '_' + Date.now();
                    window.artStorage[artId] = pkg.art;
                    pkg.bannerArtId = artId;
                }
            });
            
            // For backward compatibility with loyalty items
            loyaltyItems.forEach(item => {
                if (item.bannerArt && !item.bannerArtId) {
                    const artId = 'legacy_loyalty_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.bannerArt;
                    item.bannerArtId = artId;
                }
                if (item.backgroundArt && !item.backgroundArtId) {
                    const artId = 'legacy_loyalty_bg_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.backgroundArt;
                    item.backgroundArtId = artId;
                }
                if (item.art && !item.bannerArtId && !item.backgroundArtId) {
                    const artId = 'legacy_loyalty_general_' + item.id + '_' + Date.now();
                    window.artStorage[artId] = item.art;
                    item.bannerArtId = artId;
                }
            });
            
            // For backward compatibility with logo
            if (organization.logo && !organization.logoId) {
                const logoId = 'legacy_logo_' + Date.now();
                window.artStorage[logoId] = organization.logo;
                organization.logoId = logoId;
                // Update the organization in localStorage without the logo data
                const orgWithoutLogo = { ...organization };
                delete orgWithoutLogo.logo;
                NewcoData.set('organization', orgWithoutLogo);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Initialize art storage first
            initializeArtStorage();

            // Note: applyBrandingColors() is called later after NewcoData is fully initialized
            // See line ~21079 where it waits for organization data to be loaded

            // Load and apply organization settings including logo
            const org = NewcoData.get('organization');
            const sidebarLogo = document.getElementById('sidebarLogo');
            if (sidebarLogo) {
                if (org?.logoArtId) {
                    // Load logo from art library
                    (async () => {
                        try {
                            const response = await fetch(
                                `${SUPABASE_URL}/rest/v1/art_library?id=eq.${org.logoArtId}&select=*`,
                                {
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                    }
                                }
                            );
                            const art = await response.json();
                            if (art && art.length > 0) {
                                sidebarLogo.innerHTML = `<img src="${art[0].file_data}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">`;
                            }
                        } catch (err) {
                            console.error('Error loading sidebar logo:', err);
                        }
                    })();
                } else if (org?.name) {
                    // Show initials if no logo
                    const initials = org.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
                    sidebarLogo.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.5rem; font-weight: bold; color: white; background: var(--primary); border-radius: 8px;">${initials}</div>`;
                } else {
                    sidebarLogo.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.5rem; font-weight: bold; color: white; background: var(--primary); border-radius: 8px;">NC</div>';
                }
            }

            // Update sidebar org name
            const sidebarOrgName = document.getElementById('sidebarOrgName');
            if (sidebarOrgName && org) {
                sidebarOrgName.textContent = org.name || 'Admin Panel';
                document.title = (org.name || 'Admin') + ' - Management System';
            }
            
            // Initialize birthday email settings
            const birthdayTriggerEmail = document.getElementById('birthdayTriggerEmail');
            if (birthdayTriggerEmail) {
                birthdayTriggerEmail.addEventListener('change', toggleEmailDaysBefore);
                toggleEmailDaysBefore(); // Initialize visibility
            }
            
            // Set up navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    showSection(section);
                });
            });
            
            // Load initial dashboard
            loadDashboard();
            
            // Set up auto-save on input changes
            document.addEventListener('input', markUnsaved);
            document.addEventListener('change', markUnsaved);
            
            // Warn before leaving with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        // ═══════════════════════════════════════════════════════════════════
        // ART LIBRARY FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        // Global art storage
        let selectedArtwork = null;
        let artLibrary = NewcoData.get('artLibrary') || [];
        
        // Store image reference only (not the actual data)
        function storeImageReference(dataUrl, artId, callback) {
            // For file uploads, we'll use the data URL directly in memory
            // Only store a reference in the art library
            callback(true, dataUrl);
        }
        
        function cleanupUnusedArt() {
            // Remove art chunks that are no longer in the library
            const artLibrary = NewcoData.get('artLibrary') || [];
            const validIds = new Set(artLibrary.map(a => a.id));
            
            // Check all localStorage keys
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('newco_art_')) {
                    const match = key.match(/newco_art_([^_]+)_/);
                    if (match && !validIds.has(match[1])) {
                        keysToRemove.push(key);
                    }
                }
            }
            
            // Remove unused keys
            keysToRemove.forEach(key => localStorage.removeItem(key));
        }
        
        // Retrieve stored image
        function getStoredImage(artId) {
            try {
                const chunkCount = parseInt(localStorage.getItem(`newco_art_${artId}_chunks`) || '0');
                if (chunkCount === 0) return null;
                
                let dataUrl = '';
                for (let i = 0; i < chunkCount; i++) {
                    dataUrl += localStorage.getItem(`newco_art_${artId}_${i}`) || '';
                }
                return dataUrl;
            } catch (e) {
                return null;
            }
        }
        
        function uploadNewArt() {
            document.getElementById('artUploadZone').style.display = 'block';
        }
        
        function handleArtUpload(files) {
            Array.from(files).forEach(file => {
                // Remove file size limit since we're storing in memory
                // if (file.size > 5 * 1024 * 1024) {
                //     showModal({
                //         title: '⚠️ File Too Large',
                //         message: `${file.name} exceeds 5MB limit.`,
                //         type: 'warning'
                //     });
                //     return;
                // }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const artId = 'art_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // Create art reference (without the actual data)
                    const artReference = {
                        id: artId,
                        name: file.name.replace(/\.[^/.]+$/, ''),
                        type: detectArtType(file.name),
                        size: file.size,
                        uploadDate: new Date().toISOString(),
                        usageCount: 0,
                        isCustom: true
                        // Note: NOT storing dataUrl here
                    };
                    
                    // Store image data in memory only
                    window.tempArtStorage = window.tempArtStorage || {};
                    window.tempArtStorage[artId] = e.target.result;
                    
                    // Add reference to library (without image data)
                    artLibrary.push(artReference);
                    
                    // Save only the reference to localStorage
                    try {
                        NewcoData.set('artLibrary', artLibrary);
                        
                        // Add to display with the image from memory
                        const displayItem = {...artReference, dataUrl: e.target.result};
                        addArtToGrid(displayItem);
                        
                        showSuccess('Image uploaded successfully.');
                    } catch (err) {
                        // Save failed but keep in memory
                        console.warn('Could not persist image reference');
                        // Still show the image since it's in memory
                        const displayItem = {...artReference, dataUrl: e.target.result};
                        addArtToGrid(displayItem);
                        showSuccess('Image uploaded successfully.');
                    }
                };
                reader.readAsDataURL(file);
            });
            
            document.getElementById('artUploadZone').style.display = 'none';
        }
        
        function detectArtType(filename) {
            // Detect type based on filename or ask user
            if (filename.includes('banner')) return 'banners';
            if (filename.includes('backdrop')) return 'backdrops';
            if (filename.includes('icon')) return 'icons';
            if (filename.includes('holiday') || filename.includes('christmas') || filename.includes('easter')) return 'seasonal';
            return 'banners'; // default
        }
        
        function addArtToGrid(artItem) {
            const grid = document.getElementById('artLibraryGrid');
            if (!grid) return;
            
            const artDiv = document.createElement('div');
            artDiv.className = 'art-item';
            artDiv.dataset.category = artItem.type;
            artDiv.dataset.artId = artItem.id;
            
            artDiv.innerHTML = `
                <div style="background-image: url('${artItem.dataUrl}'); background-size: cover; background-position: center; height: 120px; border-radius: 8px; position: relative; overflow: hidden;">
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem; font-size: 0.75rem;">
                        ${artItem.type} • Custom Upload
                    </div>
                </div>
                <div style="padding: 0.75rem; background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${artItem.name}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.75rem; color: var(--gray);">Used ${artItem.usageCount} times</span>
                        <button class="btn btn-sm btn-secondary" onclick="useArtwork('${artItem.id}')">
                            Use
                        </button>
                    </div>
                </div>
            `;
            
            grid.prepend(artDiv);
        }
        
        function useArtwork(artId) {
            selectedArtwork = artId;
            
            // Find the art item
            const artItem = artLibrary.find(a => a.id === artId) || 
                           { id: artId, name: 'Built-in Art', dataUrl: null };
            
            // Update usage count
            if (artItem.dataUrl) {
                artItem.usageCount = (artItem.usageCount || 0) + 1;
                NewcoData.set('artLibrary', artLibrary);
            }
            
            showModal({
                title: '✅ Artwork Selected',
                message: `"${artItem.name}" is now selected. It will be used for your next package or item creation.`,
                type: 'success'
            });
            
            // Close modal if it was opened from package/item creation
            const modal = document.getElementById('modal');
            if (modal.style.display === 'block') {
                closeModal();
            }
        }
        
        function showArtSelector(callback) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = '🖼️ Select Artwork';
            
            // Load art library and reconstruct images
            const artItems = NewcoData.get('artLibrary') || [];
            const artWithImages = [];
            
            // Get images with their data URLs
            artItems.forEach(art => {
                // Check if we have the data URL stored
                let imageData = art.dataUrl;
                
                // If not in the item, check temporary storage
                if (!imageData && window.tempArtStorage && window.tempArtStorage[art.id]) {
                    imageData = window.tempArtStorage[art.id];
                }
                
                if (imageData) {
                    artWithImages.push({
                        ...art,
                        dataUrl: imageData
                    });
                }
            });
            
            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; max-height: 400px; overflow-y: auto;">
                    <!-- Built-in art -->
                    <div class="art-selector-item" style="cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 0.5rem;">
                        <div onclick="window.selectArtForItem('builtin_1')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 80px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; cursor: pointer;">🎰</div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">Jackpot Dreams</div>
                    </div>
                    <div class="art-selector-item" style="cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 0.5rem;">
                        <div onclick="window.selectArtForItem('builtin_2')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); height: 80px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; cursor: pointer;">🎉</div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">Party Time</div>
                    </div>
                    ${artWithImages.map(art => `
                        <div class="art-selector-item" style="cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 0.5rem;">
                            <div onclick="window.selectArtForItem('${art.id}')" style="background-image: url('${art.dataUrl}'); background-size: cover; background-position: center; height: 80px; border-radius: 4px; cursor: pointer;"></div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">${art.name}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="uploadNewArt()">
                        📤 Upload New Art
                    </button>
                </div>
            `;
            
            window.selectArtForItem = function(artId) {
                // Get the actual image data for the selected art
                let selectedArtData = null;
                
                if (artId.startsWith('builtin_')) {
                    // For built-in art, just pass the ID
                    selectedArtData = artId;
                } else {
                    // For uploaded art, get the full data URL
                    const selectedArt = artWithImages.find(a => a.id === artId);
                    if (selectedArt) {
                        selectedArtData = selectedArt.dataUrl;
                    }
                }
                
                // Call the callback with the art data
                if (callback) {
                    callback(selectedArtData);
                }
                closeModal();
            };
            
            modalSaveBtn.style.display = 'none';
            modal.classList.add('active');
        }
        
        function filterArtLibrary(category) {
            const items = document.querySelectorAll('.art-item');
            items.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update active button
            event.target.classList.add('active');
            event.target.parentElement.querySelectorAll('.btn').forEach(btn => {
                if (btn !== event.target) btn.classList.remove('active');
            });
        }
        
        function loadArtLibrary() {
            const grid = document.getElementById('artLibraryGrid');
            if (!grid) return;
            
            // Get saved art library
            artLibrary = NewcoData.get('artLibrary') || [];
            
            // Clear existing custom art (keep the sample art)
            const existingCustomArt = grid.querySelectorAll('.art-item[data-custom="true"]');
            existingCustomArt.forEach(item => item.remove());
            
            // Load and display each saved art item
            artLibrary.forEach(artItem => {
                // Check if we have the data URL stored
                let imageData = artItem.dataUrl;
                
                // If not in the item, check temporary storage
                if (!imageData && window.tempArtStorage && window.tempArtStorage[artItem.id]) {
                    imageData = window.tempArtStorage[artItem.id];
                }
                
                if (imageData) {
                    artItem.dataUrl = imageData;
                    
                    // Create the art display element
                    const artDiv = document.createElement('div');
                    artDiv.className = 'art-item';
                    artDiv.dataset.category = artItem.type || 'banners';
                    artDiv.dataset.artId = artItem.id;
                    artDiv.dataset.custom = 'true';
                    
                    artDiv.innerHTML = `
                        <div style="background-image: url('${artItem.dataUrl}'); background-size: cover; background-position: center; height: 120px; border-radius: 8px; position: relative; overflow: hidden;">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem; font-size: 0.75rem;">
                                ${artItem.type || 'Custom'} • ${artItem.dimensions || 'Uploaded'}
                            </div>
                        </div>
                        <div style="padding: 0.75rem; background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${artItem.name}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; color: var(--gray);">Used ${artItem.usageCount || 0} times</span>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="useArtwork('${artItem.id}')">
                                        Use
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteArtwork('${artItem.id}')">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add to grid after the upload zone samples
                    grid.appendChild(artDiv);
                }
            });
        }
        
        function deleteArtwork(artId) {
            showConfirm(
                'Are you sure you want to delete this artwork?',
                () => {
                    // Remove from library
                    artLibrary = artLibrary.filter(a => a.id !== artId);
                    NewcoData.set('artLibrary', artLibrary);
                    
                    // Remove from temporary storage if exists
                    if (window.tempArtStorage && window.tempArtStorage[artId]) {
                        delete window.tempArtStorage[artId];
                    }
                    
                    // Remove from display
                    const artElement = document.querySelector(`[data-art-id="${artId}"]`);
                    if (artElement) {
                        artElement.remove();
                    }
                    
                    showSuccess('Artwork deleted successfully');
                },
                'Delete Artwork'
            );
        }
        
        function showArtCategories() {
            showModal({
                title: '📁 Art Categories',
                message: `
                    <div style="display: grid; gap: 1rem;">
                        <div><strong>Banners (800x200):</strong> ${artLibrary.filter(a => a.type === 'banners').length} items</div>
                        <div><strong>Backdrops (600x400):</strong> ${artLibrary.filter(a => a.type === 'backdrops').length} items</div>
                        <div><strong>Icons:</strong> ${artLibrary.filter(a => a.type === 'icons').length} items</div>
                        <div><strong>Seasonal:</strong> ${artLibrary.filter(a => a.type === 'seasonal').length} items</div>
                    </div>
                `,
                type: 'info'
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // SCHEDULE FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function openScheduleModal(hallId, day) {
            const halls = NewcoData.get('halls') || [];
            const hall = halls.find(h => h.id === hallId);
            const schedule = NewcoData.get('schedule') || {};
            const schedules = schedule.schedules || {};
            const hallSchedule = schedules[hallId] || {};
            
            // Check for wizard data to populate initial schedule
            const wizardData = NewcoData.get('wizardData') || {};
            const wizardSchedule = wizardData.schedule || {};
            const wizardDaySchedule = wizardSchedule[day] || {};
            
            // Use existing schedule data or fall back to wizard data
            const daySchedule = hallSchedule[day] || {
                open: wizardDaySchedule.open || false,
                doors: wizardDaySchedule.doors || '17:00',
                early: wizardDaySchedule.early || wizardDaySchedule.earlyBird || '18:00',
                regular: wizardDaySchedule.regular || '18:30',
                closing: wizardDaySchedule.closing || wizardDaySchedule.close || '21:00',
                lateNight: wizardDaySchedule.lateNight || false,
                specialEvent: wizardDaySchedule.specialEvent || false,
                tournament: wizardDaySchedule.tournament || false
            };
            
            const dayLabel = day.charAt(0).toUpperCase() + day.slice(1);
            const dayColors = {
                monday: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                tuesday: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', 
                wednesday: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                thursday: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                friday: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                saturday: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                sunday: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            };
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = `${dayLabel} Schedule - ${hall.name}`;
            modalBody.innerHTML = `
                <div style="background: ${dayColors[day]}; height: 4px; margin: -1rem -1.5rem 1.5rem -1.5rem;"></div>
                
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem;">
                        <input type="checkbox" id="dayOpen" ${daySchedule.open ? 'checked' : ''} 
                               style="width: 24px; height: 24px; cursor: pointer;"
                               onchange="document.getElementById('scheduleTimesContainer').style.display = this.checked ? 'block' : 'none'">
                        <span>Open on ${dayLabel}</span>
                    </label>
                </div>
                
                <div id="scheduleTimesContainer" style="display: ${daySchedule.open ? 'block' : 'none'};">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">🚪 Doors Open</label>
                            <input type="time" class="form-input" id="modalDoors" value="${daySchedule.doors || '17:00'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">When players can enter</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🌅 Early Bird Session</label>
                            <input type="time" class="form-input" id="modalEarly" value="${daySchedule.early || daySchedule.earlyBird || '18:00'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Early bird specials start</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🎯 Regular Session</label>
                            <input type="time" class="form-input" id="modalRegular" value="${daySchedule.regular || '18:30'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Main session begins</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🌙 Closing Time</label>
                            <input type="time" class="form-input" id="modalClosing" value="${daySchedule.closing || daySchedule.close || '21:00'}">
                            <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Last game ends</p>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label class="form-label">Special Sessions</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modalLateNight" ${daySchedule.lateNight ? 'checked' : ''}>
                                <span>🌃 Late Night Session</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modalSpecialEvent" ${daySchedule.specialEvent ? 'checked' : ''}>
                                <span>⭐ Special Event Day</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modalTournament" ${daySchedule.tournament ? 'checked' : ''}>
                                <span>🏆 Tournament Day</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            modalSaveBtn.textContent = 'Save Schedule';
            modalSaveBtn.onclick = () => {
                const isOpen = document.getElementById('dayOpen').checked;
                
                if (!schedules[hallId]) {
                    schedules[hallId] = {};
                }
                
                if (isOpen) {
                    schedules[hallId][day] = {
                        open: true,
                        doors: document.getElementById('modalDoors').value,
                        early: document.getElementById('modalEarly').value,
                        earlyBird: document.getElementById('modalEarly').value, // legacy
                        regular: document.getElementById('modalRegular').value,
                        closing: document.getElementById('modalClosing').value,
                        close: document.getElementById('modalClosing').value, // legacy
                        lateNight: document.getElementById('modalLateNight').checked,
                        specialEvent: document.getElementById('modalSpecialEvent').checked,
                        tournament: document.getElementById('modalTournament').checked
                    };
                } else {
                    schedules[hallId][day] = { open: false };
                }

                schedule.schedules = schedules;
                NewcoData.set('schedule', schedule);
                loadSchedule(); // Refresh the display
                closeModal();
                
                showModal({
                    title: '✅ Schedule Updated',
                    message: `${dayLabel} schedule for ${hall.name} has been saved.`,
                    type: 'success'
                });
            };
            
            modal.classList.add('active');
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // INTEGRATIONS FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function testLightspeedConnection() {
            const apiKey = document.getElementById('lightspeedApiKey').value;
            const storeId = document.getElementById('lightspeedStoreId').value;
            
            if (!apiKey || !storeId) {
                showModal({
                    title: '⚠️ Missing Credentials',
                    message: 'Please enter both API Key and Store ID to test the connection.',
                    type: 'warning'
                });
                return;
            }
            
            // Simulate testing connection
            showModal({
                title: '🔄 Testing Connection',
                message: 'Connecting to Lightspeed POS...',
                type: 'info'
            });
            
            setTimeout(() => {
                // Save integration status
                let integrations = NewcoData.get('integrations') || {};
                integrations.lightspeed = {
                    enabled: true,
                    apiKey: apiKey,
                    storeId: storeId,
                    lastSync: new Date().toISOString()
                };
                NewcoData.set('integrations', integrations);
                
                showModal({
                    title: '✅ Connection Successful',
                    message: 'Lightspeed POS has been successfully connected. Floor spending points are now enabled.',
                    type: 'success'
                });
            }, 2000);
        }
        
        function connectShopify() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = '🛍️ Connect Shopify Store';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Store URL</label>
                    <input type="text" class="form-input" id="shopifyStoreUrl" placeholder="yourstore.myshopify.com">
                    <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                        Enter your Shopify store URL without https://
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">API Access Token</label>
                    <input type="password" class="form-input" id="shopifyApiToken" placeholder="Enter your Shopify API token">
                    <p style="font-size: 0.875rem; color: var(--gray); margin-top: 0.5rem;">
                        Generate this in your Shopify Admin under Apps > Private Apps
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">Integration Features</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncProducts" checked>
                            <span style="font-size: 0.875rem;">Sync Products & Inventory</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncCustomers" checked>
                            <span style="font-size: 0.875rem;">Sync Customer Data</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncOrders" checked>
                            <span style="font-size: 0.875rem;">Sync Order History</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="syncRewards">
                            <span style="font-size: 0.875rem;">Enable Rewards Integration</span>
                        </label>
                    </div>
                </div>
            `;
            
            modalSaveBtn.textContent = 'Connect Store';
            modalSaveBtn.onclick = () => {
                const storeUrl = document.getElementById('shopifyStoreUrl').value;
                const apiToken = document.getElementById('shopifyApiToken').value;
                
                if (!storeUrl || !apiToken) {
                    showError('Please enter both Store URL and API Token');
                    return;
                }
                
                // Show loading
                showAlert('Connecting to Shopify...', 'Please Wait');
                
                // Simulate connection (in real app, would make API call)
                setTimeout(() => {
                    // Save integration status
                    let integrations = NewcoData.get('integrations') || {};
                    integrations.shopify = {
                        enabled: true,
                        storeUrl: storeUrl,
                        apiToken: apiToken,
                        syncProducts: document.getElementById('syncProducts').checked,
                        syncCustomers: document.getElementById('syncCustomers').checked,
                        syncOrders: document.getElementById('syncOrders').checked,
                        syncRewards: document.getElementById('syncRewards').checked,
                        lastSync: new Date().toISOString()
                    };
                    NewcoData.set('integrations', integrations);
                    
                    closeModal();
                    
                    // Update UI
                    const shopifyCard = document.querySelector('.integration-card');
                    if (shopifyCard) {
                        const statusDiv = shopifyCard.querySelector('.integration-status');
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                    <span style="font-size: 0.875rem; color: var(--gray-dark);">Connected to ${storeUrl}</span>
                                </div>
                            `;
                        }
                    }
                    
                    showSuccess('Shopify store connected successfully!');
                }, 2000);
            };
            
            modal.classList.add('active');
        }
        
        function syncLightspeedData() {
            showModal({
                title: '🔄 Syncing Data',
                message: 'Syncing with Lightspeed POS... This may take a few moments.',
                type: 'info'
            });
            
            setTimeout(() => {
                // Update last sync time
                let integrations = NewcoData.get('integrations') || {};
                if (integrations.lightspeed) {
                    integrations.lightspeed.lastSync = new Date().toISOString();
                    NewcoData.set('integrations', integrations);
                }
                
                showModal({
                    title: '✅ Sync Complete',
                    message: 'Successfully synced 1,234 transactions and 567 customer records.',
                    type: 'success'
                });
            }, 3000);
        }
        
        function updateLightspeedFields() {
            const posType = document.getElementById('lightspeedPosType')?.value;
            const storeIdInput = document.getElementById('lightspeedStoreId');
            
            if (storeIdInput) {
                switch(posType) {
                    case 'retail':
                        storeIdInput.placeholder = 'Retail Store ID (e.g., 12345)';
                        break;
                    case 'restaurant':
                        storeIdInput.placeholder = 'Restaurant ID (e.g., REST-12345)';
                        break;
                    case 'ecom':
                        storeIdInput.placeholder = 'eCom Account ID (e.g., EC-12345)';
                        break;
                }
            }
        }
        
        function configureLightspeedMapping() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Configure Lightspeed Field Mapping';
            modalBody.innerHTML = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <div class="form-group">
                        <h4 style="color: var(--primary); margin: 0 0 1rem;">Customer Data Mapping</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: center; font-size: 0.875rem;">
                            <strong>BMS Field</strong>
                            <strong>Lightspeed Field</strong>
                            
                            <span>Customer Name</span>
                            <select class="form-select" id="mapCustomerName">
                                <option value="firstName">firstName + lastName</option>
                                <option value="fullName">fullName</option>
                                <option value="displayName">displayName</option>
                            </select>
                            
                            <span>Email</span>
                            <select class="form-select" id="mapCustomerEmail">
                                <option value="email">email</option>
                                <option value="contact.email">contact.email</option>
                            </select>
                            
                            <span>Phone</span>
                            <select class="form-select" id="mapCustomerPhone">
                                <option value="phone">phone</option>
                                <option value="contact.phone">contact.phone</option>
                                <option value="mobilePhone">mobilePhone</option>
                            </select>
                            
                            <span>Total Spent</span>
                            <select class="form-select" id="mapCustomerSpent">
                                <option value="totalSpent">totalSpent</option>
                                <option value="lifetimeValue">lifetimeValue</option>
                                <option value="accountBalance">accountBalance</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <h4 style="color: var(--primary); margin: 0 0 1rem;">Transaction Data Mapping</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: center; font-size: 0.875rem;">
                            <strong>BMS Field</strong>
                            <strong>Lightspeed Field</strong>
                            
                            <span>Transaction ID</span>
                            <select class="form-select" id="mapTransactionId">
                                <option value="saleID">saleID</option>
                                <option value="transactionNumber">transactionNumber</option>
                                <option value="receiptNumber">receiptNumber</option>
                            </select>
                            
                            <span>Amount</span>
                            <select class="form-select" id="mapTransactionAmount">
                                <option value="total">total</option>
                                <option value="subtotal">subtotal</option>
                                <option value="grandTotal">grandTotal</option>
                            </select>
                            
                            <span>Date/Time</span>
                            <select class="form-select" id="mapTransactionDate">
                                <option value="timeStamp">timeStamp</option>
                                <option value="createTime">createTime</option>
                                <option value="completedTime">completedTime</option>
                            </select>
                            
                            <span>Payment Method</span>
                            <select class="form-select" id="mapPaymentMethod">
                                <option value="paymentType">paymentType</option>
                                <option value="tenderType">tenderType</option>
                                <option value="payments.method">payments.method</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <h4 style="color: var(--primary); margin: 0 0 1rem;">Filtering Options</h4>
                        <div style="background: var(--gray-lighter); padding: 1rem; border-radius: 8px;">
                            <label class="form-label">Only sync transactions containing:</label>
                            <input type="text" class="form-input" id="filterByKeyword" placeholder="e.g., 'Bingo', 'Gaming', etc." style="margin-bottom: 0.5rem;">
                            <p style="font-size: 0.75rem; color: var(--gray); margin: 0;">Leave blank to sync all transactions</p>
                        </div>
                    </div>
                </div>
            `;
            
            modalSaveBtn.textContent = 'Save Field Mapping';
            modalSaveBtn.onclick = () => {
                // Save the field mapping configuration
                const fieldMapping = {
                    customer: {
                        name: document.getElementById('mapCustomerName').value,
                        email: document.getElementById('mapCustomerEmail').value,
                        phone: document.getElementById('mapCustomerPhone').value,
                        totalSpent: document.getElementById('mapCustomerSpent').value
                    },
                    transaction: {
                        id: document.getElementById('mapTransactionId').value,
                        amount: document.getElementById('mapTransactionAmount').value,
                        date: document.getElementById('mapTransactionDate').value,
                        paymentMethod: document.getElementById('mapPaymentMethod').value
                    },
                    filters: {
                        keyword: document.getElementById('filterByKeyword').value
                    }
                };
                
                let integrations = NewcoData.get('integrations') || {};
                if (!integrations.lightspeed) {
                    integrations.lightspeed = {};
                }
                integrations.lightspeed.fieldMapping = fieldMapping;
                NewcoData.set('integrations', integrations);
                
                closeModal();
                showModal({
                    title: '✅ Field Mapping Saved',
                    message: 'Lightspeed field mapping has been configured successfully.',
                    type: 'success'
                });
            };
            
            modal.classList.add('active');
        }
        
        
        // ═══════════════════════════════════════════════════════════════════
        // TRANSACTIONS LOG FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let currentTransactionPage = 1;
        let transactionSortBy = 'date';
        let transactionSortOrder = 'desc';
        let transactionFilters = {
            source: 'all',
            customerType: 'all',
            salesperson: 'all',
            dateRange: 'all',
            rewardsEligible: 'all'
        };
        
        // Sample transaction data (in real implementation this would come from database/API)
        function generateSampleTransactions() {
            const transactions = [];
            const sources = ['floor', 'website', 'other'];
            const types = ['Bingo Session', 'Package Purchase', 'Concessions', 'Merchandise', 'Donation', 'Membership'];
            const names = ['John Smith', 'Mary Johnson', 'Bob Wilson', 'Lisa Davis', 'Mike Brown', null, 'Sarah Lee', null, 'Tom Garcia'];
            const staffNames = ['Alice Chen', 'Bob Martinez', 'Carol White', 'David Kim', 'Emma Jones', 'Frank Miller', 'Grace Taylor', 'Henry Wilson'];
            
            for (let i = 0; i < 1234; i++) {
                const source = sources[Math.floor(Math.random() * sources.length)];
                const customerName = names[Math.floor(Math.random() * names.length)];
                const amount = Math.floor(Math.random() * 100) + 5;
                const isRewardsEligible = Math.random() > 0.3;
                const loyaltyGranted = isRewardsEligible && Math.random() > 0.2;
                const loyaltyEarned = loyaltyGranted ? Math.floor(amount * (source === 'floor' ? 2 : 1)) : 0;
                
                // Determine salesperson based on source with realistic variation
                let salesperson;
                if (source === 'website') {
                    // Always Web for website transactions
                    salesperson = 'Web';
                } else if (source === 'floor') {
                    // 50% staff names, 35% Paymaster, 15% Web (for phone orders)
                    const rand = Math.random();
                    if (rand < 0.5) {
                        salesperson = staffNames[Math.floor(Math.random() * staffNames.length)];
                    } else if (rand < 0.85) {
                        salesperson = 'Paymaster';
                    } else {
                        salesperson = 'Web';
                    }
                } else {
                    // Other sources - mixed between staff and system
                    const rand = Math.random();
                    if (rand < 0.4) {
                        salesperson = staffNames[Math.floor(Math.random() * staffNames.length)];
                    } else if (rand < 0.7) {
                        salesperson = 'Paymaster';
                    } else {
                        salesperson = 'Web';
                    }
                }
                
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                transactions.push({
                    id: i + 1,
                    source: source,
                    customerName: customerName,
                    customerType: customerName ? 'identified' : 'headless',
                    salesperson: salesperson,
                    date: date,
                    type: types[Math.floor(Math.random() * types.length)],
                    amount: amount,
                    rewardsEligible: isRewardsEligible,
                    loyaltyGranted: loyaltyGranted,
                    loyaltyEarned: loyaltyEarned
                });
            }
            
            return transactions.sort((a, b) => b.date - a.date);
        }
        
        function sortTransactions(field) {
            // Toggle sort order if clicking the same field
            if (transactionSortBy === field) {
                transactionSortOrder = transactionSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                transactionSortBy = field;
                transactionSortOrder = 'asc';
            }
            
            // Update arrow indicators
            ['source', 'customer', 'salesperson', 'date', 'type', 'amount', 'status', 'loyalty'].forEach(f => {
                const arrow = document.getElementById(`sortArrow${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (arrow) {
                    if (f === field) {
                        arrow.textContent = transactionSortOrder === 'asc' ? '↑' : '↓';
                    } else {
                        arrow.textContent = '↕️';
                    }
                }
            });
            
            loadTransactions();
        }
        
        function getFilteredTransactions() {
            // Get REAL transactions from localStorage, don't generate fake ones
            const allTransactions = NewcoData.get('transactions') || [];
            const today = new Date();

            // Convert date strings to Date objects and add calculated fields
            const processedTransactions = allTransactions.map(t => ({
                ...t,
                date: new Date(t.date || t.timestamp),
                // Don't override manual transaction fields
                source: t.source || 'website',
                customerType: t.customerType || 'member',
                salesperson: t.salesperson || 'Web',
                customerName: t.customerName || t.memberName,
                amount: parseFloat(t.amount || t.finalTotal || t.total) || 0,
                type: t.type || (t.paymentMethod === 'cash' ? 'CASH' : 'CARD'),
                rewardsEligible: t.rewardsEligible !== undefined ? t.rewardsEligible : true,
                loyaltyGranted: t.loyaltyGranted !== undefined ? t.loyaltyGranted : (t.loyaltyPointsUsed > 0),
                loyaltyEarned: parseFloat(t.loyaltyEarned || t.loyaltyPointsEarned) || 0
            }));
            
            return processedTransactions.filter(transaction => {
                // Source filter
                if (transactionFilters.source !== 'all' && transaction.source !== transactionFilters.source) {
                    return false;
                }
                
                // Customer type filter
                if (transactionFilters.customerType !== 'all' && transaction.customerType !== transactionFilters.customerType) {
                    return false;
                }
                
                // Salesperson filter
                if (transactionFilters.salesperson !== 'all' && transaction.salesperson !== transactionFilters.salesperson) {
                    return false;
                }
                
                // Date range filter
                if (transactionFilters.dateRange === 'today') {
                    const isToday = transaction.date.toDateString() === today.toDateString();
                    if (!isToday) return false;
                } else if (transactionFilters.dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(today.getDate() - 7);
                    if (transaction.date < weekAgo) return false;
                } else if (transactionFilters.dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(today.getMonth() - 1);
                    if (transaction.date < monthAgo) return false;
                }
                
                // Rewards eligible filter
                if (transactionFilters.rewardsEligible === 'eligible' && !transaction.rewardsEligible) {
                    return false;
                } else if (transactionFilters.rewardsEligible === 'not-eligible' && transaction.rewardsEligible) {
                    return false;
                }
                
                return true;
            }).sort((a, b) => {
                let aVal, bVal;
                
                switch(transactionSortBy) {
                    case 'source':
                        aVal = a.source || '';
                        bVal = b.source || '';
                        break;
                    case 'customer':
                        aVal = a.customer || '';
                        bVal = b.customer || '';
                        break;
                    case 'salesperson':
                        aVal = a.salesperson || '';
                        bVal = b.salesperson || '';
                        break;
                    case 'date':
                        aVal = a.date;
                        bVal = b.date;
                        break;
                    case 'type':
                        aVal = a.type || '';
                        bVal = b.type || '';
                        break;
                    case 'amount':
                        aVal = a.amount || 0;
                        bVal = b.amount || 0;
                        break;
                    case 'status':
                        aVal = a.status || '';
                        bVal = b.status || '';
                        break;
                    case 'loyalty':
                        aVal = a.loyaltyPoints || 0;
                        bVal = b.loyaltyPoints || 0;
                        break;
                    default:
                        aVal = a.date;
                        bVal = b.date;
                }
                
                if (transactionSortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        function loadTransactions() {
            // Update header with current currency name
            const loyaltyHeader = document.getElementById('loyaltyPointsHeader');
            if (loyaltyHeader) {
                loyaltyHeader.textContent = getPointsCurrencyName();
            }
            
            const filteredTransactions = getFilteredTransactions();
            const perPage = 50;
            const startIndex = (currentTransactionPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            const totalPages = Math.ceil(filteredTransactions.length / perPage);
            
            // Update analytics
            updateTransactionAnalytics(filteredTransactions);
            
            // Update table
            const tbody = document.getElementById('transactionsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = pageTransactions.map(transaction => `
                <tr style="border-bottom: 1px solid var(--gray-light);">
                    <td style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${getSourceColor(transaction.source)};"></span>
                            <span style="font-weight: 600; text-transform: capitalize;">${transaction.source}</span>
                            ${transaction.isTestTransaction ? '<span style="background: #f59e0b; color: white; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.625rem; font-weight: 600; margin-left: 0.25rem;">TEST</span>' : ''}
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="cursor: pointer;" onclick="viewMemberDetails('${transaction.customerId || transaction.memberId}')" title="Click to view member details">
                            <div style="font-weight: 600; color: var(--primary); text-decoration: underline;">${transaction.customerName || 'Anonymous'}</div>
                            <div style="font-size: 0.75rem; color: var(--gray); text-transform: capitalize;">${transaction.customerType}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: ${transaction.salesperson === 'Web' ? 'var(--primary-light)' : 'var(--warning-light)'}; color: ${transaction.salesperson === 'Web' ? 'var(--primary-dark)' : 'var(--warning-dark)'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">
                            ${transaction.salesperson}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 500;">${transaction.date.toLocaleDateString()}</div>
                            <div style="font-size: 0.875rem; color: var(--gray);">${transaction.date.toLocaleTimeString()}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: var(--gray-lighter); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                            ${transaction.type}
                        </span>
                    </td>
                    <td style="padding: 1rem; font-weight: 600;">$${(parseFloat(transaction.amount) || 0).toFixed(2)}</td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="
                            padding: 0.25rem 0.75rem;
                            border-radius: 4px;
                            font-size: 0.875rem;
                            font-weight: 500;
                            ${transaction.status === 'Received' ? 'background: var(--success-light); color: var(--success-dark);' :
                              transaction.status === 'Purchased' ? 'background: var(--primary-light); color: var(--primary-dark);' :
                              transaction.status === 'Pending' ? 'background: var(--warning-light); color: var(--warning-dark);' :
                              'background: var(--gray-lighter); color: var(--gray-dark);'}
                        ">
                            ${transaction.status || 'Unknown'}
                        </span>
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--primary);">
                        ${transaction.loyaltyEarned > 0 ? transaction.loyaltyEarned.toLocaleString() : '—'}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <button onclick='viewTransactionDetails(${JSON.stringify(transaction).replace(/'/g, "&apos;")})' class="btn btn-outline" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                            👁️ View Details
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update pagination
            const prevBtn = Array.from(document.querySelectorAll('.btn')).find(btn => btn.textContent.includes('← Previous'));
            if (prevBtn) prevBtn.disabled = currentTransactionPage === 1;
            
            const nextBtn = Array.from(document.querySelectorAll('.btn')).find(btn => btn.textContent.includes('Next →'));
            if (nextBtn) nextBtn.disabled = currentTransactionPage === totalPages;
            
            // Update counts
            const countElement = document.getElementById('transactionCount');
            if (countElement) {
                countElement.textContent = `Showing ${pageTransactions.length} of ${filteredTransactions.length} transactions`;
            }
        }
        
        function getSourceColor(source) {
            const colors = {
                floor: '#2196f3',
                website: '#4caf50', 
                other: '#ff9800'
            };
            return colors[source] || '#999';
        }
        
        function getPointsCurrencyName() {
            const rewardsConfig = NewcoData.get('rewardsConfig') || {};
            return rewardsConfig.basicSettings?.pointsCurrencyName || 'Loyalty Points';
        }

        // View Transaction Details Modal
        window.viewTransactionDetails = function(transaction) {
            const modal = document.createElement('div');
            modal.id = 'transactionDetailsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const isCancelled = transaction.status === 'Cancelled' || transaction.cancelled;
            const hasRefund = transaction.refundAmount > 0 || (transaction.refunded && transaction.amount > 0);
            const refundAmount = transaction.refundAmount || (hasRefund ? transaction.amount : 0);

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 2rem; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <button onclick="closeTransactionDetailsModal()" style="position: absolute; right: 1.5rem; top: 1.5rem; background: none; border: none; font-size: 1.75rem; cursor: pointer; color: #999; line-height: 1;">&times;</button>

                    <div style="margin-bottom: 2rem;">
                        <h2 style="margin: 0 0 0.5rem 0; color: #333; font-size: 1.75rem;">Transaction Details</h2>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="color: #666; font-size: 0.95rem;">Order #${transaction.id || 'N/A'}</span>
                            <span style="
                                padding: 0.25rem 0.75rem;
                                border-radius: 20px;
                                font-size: 0.875rem;
                                font-weight: 600;
                                ${isCancelled ? 'background: #fee; color: #c33;' :
                                  transaction.status === 'Received' ? 'background: var(--success-light); color: var(--success-dark);' :
                                  transaction.status === 'Purchased' ? 'background: var(--primary-light); color: var(--primary-dark);' :
                                  transaction.status === 'Pending' ? 'background: var(--warning-light); color: var(--warning-dark);' :
                                  'background: var(--gray-lighter); color: var(--gray-dark);'}
                            ">
                                ${isCancelled ? '❌ Cancelled' : transaction.status || 'Unknown'}
                            </span>
                            ${transaction.isTestTransaction ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">TEST</span>' : ''}
                        </div>
                    </div>

                    <!-- Customer & Transaction Info -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Customer</div>
                                <div style="font-weight: 600; font-size: 1.05rem;">${transaction.customerName || 'Anonymous'}</div>
                                <div style="font-size: 0.875rem; color: #666; text-transform: capitalize;">${transaction.customerType || 'Guest'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Date & Time</div>
                                <div style="font-weight: 600; font-size: 1.05rem;">${new Date(transaction.date).toLocaleDateString()}</div>
                                <div style="font-size: 0.875rem; color: #666;">${new Date(transaction.date).toLocaleTimeString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Source</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${getSourceColor(transaction.source)};"></span>
                                    <span style="font-weight: 600; text-transform: capitalize; font-size: 1.05rem;">${transaction.source}</span>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Salesperson</div>
                                <div style="font-weight: 600; font-size: 1.05rem;">${transaction.salesperson || 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Breakdown -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Items</h3>
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                            ${(transaction.items || []).map((item, idx) => `
                                <div style="padding: 1rem; ${idx > 0 ? 'border-top: 1px solid #e5e7eb;' : ''} display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${item.name || 'Item'}</div>
                                        <div style="font-size: 0.875rem; color: #666;">Qty: ${item.quantity || 1} × $${(item.price || 0).toFixed(2)}</div>
                                    </div>
                                    <div style="font-weight: 600; font-size: 1.1rem;">$${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                                </div>
                            `).join('')}
                            ${!transaction.items || transaction.items.length === 0 ? '<div style="padding: 1rem; text-align: center; color: #999;">No items recorded</div>' : ''}
                        </div>
                    </div>

                    <!-- Seats (if applicable) -->
                    ${transaction.selectedSeats && Object.keys(transaction.selectedSeats).length > 0 ? `
                        <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; color: #1e40af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 600;">Reserved Seats</div>
                            <div style="font-size: 0.95rem; color: #1e3a8a;">${Object.values(transaction.selectedSeats).flat().join(', ')}</div>
                        </div>
                    ` : ''}

                    <!-- Payment Breakdown -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Payment Breakdown</h3>
                        <div style="space-y: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: #666;">Subtotal (before tax)</span>
                                <span style="font-weight: 600;">$${(transaction.subtotal || transaction.amount || 0).toFixed(2)}</span>
                            </div>
                            ${transaction.tax > 0 || transaction.taxAmount > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                    <span style="color: #666;">Tax ${transaction.taxRate ? `(${transaction.taxRate}%)` : ''}</span>
                                    <span style="font-weight: 600;">$${(transaction.tax || transaction.taxAmount || 0).toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.tip > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                    <span style="color: #666;">Tip</span>
                                    <span style="font-weight: 600;">$${transaction.tip.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.discount > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #16a34a;">
                                    <span>Discount</span>
                                    <span style="font-weight: 600;">-$${transaction.discount.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.loyaltyPointsUsed > 0 || transaction.loyaltyDiscount > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #7c3aed;">
                                    <span>${getPointsCurrencyName()} Redeemed</span>
                                    <span style="font-weight: 600;">-${transaction.loyaltyPointsUsed || 0} pts (-$${(transaction.loyaltyDiscount || transaction.loyaltyPointsValue || 0).toFixed(2)})</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-top: 2px solid #ddd; margin-top: 0.5rem;">
                                <span style="font-weight: 700; font-size: 1.1rem;">Total Paid</span>
                                <span style="font-weight: 700; font-size: 1.3rem; color: #2563eb;">$${(transaction.finalTotal || transaction.total || transaction.amount || 0).toFixed(2)}</span>
                            </div>
                            ${transaction.processingFee > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; color: #666; font-size: 0.875rem; border-top: 1px solid #e5e7eb; margin-top: 0.5rem;">
                                    <span>Processing Fee (${transaction.processingFeeRate || '2.9%'})</span>
                                    <span>$${transaction.processingFee.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: 600;">
                                    <span>Net Amount</span>
                                    <span style="color: #16a34a;">$${((transaction.finalTotal || transaction.total || transaction.amount || 0) - transaction.processingFee).toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${transaction.loyaltyEarned > 0 || transaction.loyaltyPointsEarned > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; background: #fef3c7; margin: 0.5rem -1rem 0; padding: 0.75rem 1rem; border-radius: 6px;">
                                    <span style="color: #92400e; font-weight: 600;">${getPointsCurrencyName()} Earned</span>
                                    <span style="font-weight: 700; color: #92400e;">+${transaction.loyaltyEarned || transaction.loyaltyPointsEarned || 0} pts</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Refund Info (if applicable) -->
                    ${hasRefund ? `
                        <div style="background: #fee; border: 2px solid #fcc; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.25rem;">💸</span>
                                <h3 style="margin: 0; font-size: 1.1rem; color: #c33;">Refund Information</h3>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">Refund Amount</div>
                                    <div style="font-weight: 700; font-size: 1.3rem; color: #c33;">$${refundAmount.toFixed(2)}</div>
                                </div>
                                ${transaction.refundDate ? `
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">Refunded On</div>
                                        <div style="font-weight: 600; color: #666;">${new Date(transaction.refundDate).toLocaleDateString()}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${transaction.refundReason ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #fcc;">
                                    <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; margin-bottom: 0.25rem;">Reason</div>
                                    <div style="color: #666;">${transaction.refundReason}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Payment & Card Details -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Payment Details</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            ${transaction.paymentMethod ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Payment Method</div>
                                    <div style="font-weight: 600; text-transform: capitalize;">${transaction.paymentMethod}</div>
                                </div>
                            ` : ''}
                            ${transaction.cardLast4 || transaction.card_last4 ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Card Number</div>
                                    <div style="font-weight: 600;">•••• •••• •••• ${transaction.cardLast4 || transaction.card_last4}</div>
                                </div>
                            ` : ''}
                            ${transaction.cardBrand || transaction.card_brand ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Card Brand</div>
                                    <div style="font-weight: 600; text-transform: capitalize;">${transaction.cardBrand || transaction.card_brand}</div>
                                </div>
                            ` : ''}
                            ${transaction.authorizationCode || transaction.auth_code ? `
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Authorization Code</div>
                                    <div style="font-weight: 600; font-family: monospace;">${transaction.authorizationCode || transaction.auth_code}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Transaction Metadata -->
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">Transaction Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                            <div>
                                <div style="color: #666; margin-bottom: 0.25rem;">Transaction ID</div>
                                <div style="font-weight: 600; font-family: monospace; font-size: 0.8rem;">${transaction.id || 'N/A'}</div>
                            </div>
                            ${transaction.invoiceNumber || transaction.invoice_number ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Invoice Number</div>
                                    <div style="font-weight: 600;">${transaction.invoiceNumber || transaction.invoice_number}</div>
                                </div>
                            ` : ''}
                            ${transaction.timestamp || transaction.processedAt ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Processed At</div>
                                    <div style="font-weight: 600;">${new Date(transaction.timestamp || transaction.processedAt).toLocaleString()}</div>
                                </div>
                            ` : ''}
                            ${transaction.sessionId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Session ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.8rem;">${transaction.sessionId}</div>
                                </div>
                            ` : ''}
                            ${transaction.sessionName ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Session Name</div>
                                    <div style="font-weight: 600;">${transaction.sessionName}</div>
                                </div>
                            ` : ''}
                            ${transaction.sessionDate ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Session Date</div>
                                    <div style="font-weight: 600;">${transaction.sessionDate}</div>
                                </div>
                            ` : ''}
                            ${transaction.customerEmail || transaction.memberEmail ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Customer Email</div>
                                    <div style="font-weight: 600;">${transaction.customerEmail || transaction.memberEmail}</div>
                                </div>
                            ` : ''}
                            ${transaction.customerId || transaction.memberId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Customer ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.8rem;">${transaction.customerId || transaction.memberId}</div>
                                </div>
                            ` : ''}
                            ${transaction.paymentProcessor === 'authorize_net' && transaction.paymentTransactionId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Authorize.Net Transaction ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.75rem;">${transaction.paymentTransactionId}</div>
                                </div>
                            ` : ''}
                            ${transaction.paymentProcessor === 'authorize_net' && transaction.paymentAuthCode ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Auth Code</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.75rem;">${transaction.paymentAuthCode}</div>
                                </div>
                            ` : ''}
                            ${transaction.paymentProcessor === 'authorize_net' && transaction.networkTransId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Network Transaction ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.75rem;">${transaction.networkTransId}</div>
                                </div>
                            ` : ''}
                            ${transaction.avsResultCode ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">AVS Result</div>
                                    <div style="font-weight: 600;">${transaction.avsResultCode}</div>
                                </div>
                            ` : ''}
                            ${transaction.cvvResultCode ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">CVV Result</div>
                                    <div style="font-weight: 600;">${transaction.cvvResultCode}</div>
                                </div>
                            ` : ''}
                            ${transaction.stripeChargeId || transaction.stripe_charge_id ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Stripe Charge ID</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.75rem;">${transaction.stripeChargeId || transaction.stripe_charge_id}</div>
                                </div>
                            ` : ''}
                            ${transaction.stripePaymentMethodId ? `
                                <div>
                                    <div style="color: #666; margin-bottom: 0.25rem;">Stripe Payment Method</div>
                                    <div style="font-weight: 600; font-family: monospace; font-size: 0.75rem;">${transaction.stripePaymentMethodId}</div>
                                </div>
                            ` : ''}
                            ${transaction.receiptUrl || transaction.receipt_url ? `
                                <div style="grid-column: 1 / -1;">
                                    <div style="color: #666; margin-bottom: 0.25rem;">Receipt URL</div>
                                    <a href="${transaction.receiptUrl || transaction.receipt_url}" target="_blank" style="color: #2563eb; text-decoration: underline; word-break: break-all; font-size: 0.8rem;">${transaction.receiptUrl || transaction.receipt_url}</a>
                                </div>
                            ` : ''}
                            ${transaction.notes ? `
                                <div style="grid-column: 1 / -1;">
                                    <div style="color: #666; margin-bottom: 0.25rem;">Notes</div>
                                    <div style="font-weight: 500; padding: 0.75rem; background: #fff; border-radius: 6px; border: 1px solid #e5e7eb;">${transaction.notes}</div>
                                </div>
                            ` : ''}
                        </div>

                        ${transaction.paymentProcessor === 'authorize_net' && transaction.paymentTransactionId && !isCancelled ? `
                            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                                <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600;">Transaction Actions</h3>
                                <div style="display: flex; gap: 1rem;">
                                    <button onclick="voidAuthorizeNetTransaction('${transaction.id}', '${transaction.paymentTransactionId}')" class="btn btn-warning" style="flex: 1;">
                                        Void Transaction
                                    </button>
                                    <button onclick="refundAuthorizeNetTransaction('${transaction.id}', '${transaction.paymentTransactionId}', ${transaction.finalTotal || transaction.total})" class="btn btn-danger" style="flex: 1;">
                                        Refund Transaction
                                    </button>
                                </div>
                                <p style="margin: 0.75rem 0 0; font-size: 0.875rem; color: #666;">
                                    <strong>Void:</strong> Cancel within 24 hours (before settlement)<br>
                                    <strong>Refund:</strong> Return funds after settlement
                                </p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        window.closeTransactionDetailsModal = function() {
            const modal = document.getElementById('transactionDetailsModal');
            if (modal) modal.remove();
        }

        // Void Authorize.Net Transaction
        async function voidAuthorizeNetTransaction(transactionId, authNetTransId) {
            if (!confirm('Are you sure you want to VOID this transaction?\n\nThis will cancel the charge before it settles (within 24 hours of authorization).')) {
                return;
            }

            showLoading('Voiding transaction...');

            try {
                // Call payment processor void function
                const result = await PaymentProcessor.voidTransaction(authNetTransId);

                if (result.success) {
                    // Update transaction status in database
                    const transactions = NewcoData.get('transactions') || [];
                    const txnIndex = transactions.findIndex(t => t.id === transactionId);

                    if (txnIndex !== -1) {
                        transactions[txnIndex].status = 'Voided';
                        transactions[txnIndex].voidedAt = new Date().toISOString();
                        transactions[txnIndex].voidTransactionId = result.transactionId;
                        await NewcoData.set('transactions', transactions);
                    }

                    hideLoading();
                    closeTransactionDetailsModal();
                    showModal({
                        title: '✅ Transaction Voided',
                        message: 'The transaction has been successfully voided. The charge will not settle.',
                        type: 'success'
                    });

                    // Refresh transaction list
                    loadTransactions();
                } else {
                    throw new Error(result.message || 'Void failed');
                }
            } catch (error) {
                hideLoading();
                showModal({
                    title: '❌ Void Failed',
                    message: error.message || 'Failed to void transaction. It may have already settled.',
                    type: 'error'
                });
            }
        }

        // Refund Authorize.Net Transaction
        async function refundAuthorizeNetTransaction(transactionId, authNetTransId, amount) {
            const refundAmount = prompt(`Enter refund amount (max: $${amount.toFixed(2)}):`, amount.toFixed(2));

            if (!refundAmount) return;

            const parsedAmount = parseFloat(refundAmount);
            if (isNaN(parsedAmount) || parsedAmount <= 0 || parsedAmount > amount) {
                showModal({
                    title: '❌ Invalid Amount',
                    message: `Refund amount must be between $0.01 and $${amount.toFixed(2)}`,
                    type: 'error'
                });
                return;
            }

            if (!confirm(`Are you sure you want to REFUND $${parsedAmount.toFixed(2)}?\n\nThis will return funds to the customer's card.`)) {
                return;
            }

            showLoading('Processing refund...');

            try {
                // Get transaction details for card info
                const transactions = NewcoData.get('transactions') || [];
                const transaction = transactions.find(t => t.id === transactionId);

                if (!transaction || !transaction.cardLast4) {
                    throw new Error('Transaction card details not found');
                }

                // Call payment processor refund function
                const result = await PaymentProcessor.refundTransaction(authNetTransId, parsedAmount, transaction.cardLast4);

                if (result.success) {
                    // Update transaction status in database
                    const txnIndex = transactions.findIndex(t => t.id === transactionId);

                    if (txnIndex !== -1) {
                        transactions[txnIndex].refundAmount = (transactions[txnIndex].refundAmount || 0) + parsedAmount;
                        transactions[txnIndex].refundedAt = new Date().toISOString();
                        transactions[txnIndex].refundTransactionId = result.transactionId;

                        // Mark as fully refunded if amount matches
                        if (transactions[txnIndex].refundAmount >= amount) {
                            transactions[txnIndex].status = 'Refunded';
                        } else {
                            transactions[txnIndex].status = 'Partially Refunded';
                        }

                        await NewcoData.set('transactions', transactions);
                    }

                    hideLoading();
                    closeTransactionDetailsModal();
                    showModal({
                        title: '✅ Refund Processed',
                        message: `$${parsedAmount.toFixed(2)} has been refunded to the customer's card.`,
                        type: 'success'
                    });

                    // Refresh transaction list
                    loadTransactions();
                } else {
                    throw new Error(result.message || 'Refund failed');
                }
            } catch (error) {
                hideLoading();
                showModal({
                    title: '❌ Refund Failed',
                    message: error.message || 'Failed to process refund.',
                    type: 'error'
                });
            }
        }
        
        function updateTransactionAnalytics(transactions) {
            const today = new Date();
            const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            // Daily totals
            const todayTransactions = transactions.filter(t =>
                t.date.toDateString() === today.toDateString()
            );
            const dailyAmount = todayTransactions.reduce((sum, t) => sum + (parseFloat(t.finalTotal) || parseFloat(t.amount) || 0), 0);
            const dailyCount = todayTransactions.length;

            // Monthly totals
            const monthTransactions = transactions.filter(t => t.date >= thisMonth);
            const monthlyAmount = monthTransactions.reduce((sum, t) => sum + (parseFloat(t.finalTotal) || parseFloat(t.amount) || 0), 0);
            const monthlyCount = monthTransactions.length;

            // Loyalty points
            const todayLoyalty = todayTransactions.reduce((sum, t) => sum + (parseFloat(t.loyaltyEarned) || 0), 0);

            // Floor vs Web split
            const floorAmount = todayTransactions.filter(t => t.source === 'floor').reduce((sum, t) => sum + (parseFloat(t.finalTotal) || parseFloat(t.amount) || 0), 0);
            const webAmount = todayTransactions.filter(t => t.source === 'website').reduce((sum, t) => sum + (parseFloat(t.finalTotal) || parseFloat(t.amount) || 0), 0);
            const total = floorAmount + webAmount || 1;
            const floorPercent = Math.round((floorAmount / total) * 100);
            const webPercent = Math.round((webAmount / total) * 100);
            
            // Update UI
            const dailyTotalEl = document.getElementById('dailyTotal');
            const monthlyTotalEl = document.getElementById('monthlyTotal');
            const loyaltyEarnedEl = document.getElementById('loyaltyEarned');
            
            if (dailyTotalEl) {
                dailyTotalEl.textContent = `$${dailyAmount.toFixed(2)}`;
                dailyTotalEl.nextElementSibling.textContent = `${dailyCount} transactions`;
            }
            
            if (monthlyTotalEl) {
                monthlyTotalEl.textContent = `$${monthlyAmount.toFixed(2)}`;
                monthlyTotalEl.nextElementSibling.textContent = `${monthlyCount} transactions`;
            }
            
            if (loyaltyEarnedEl) {
                loyaltyEarnedEl.textContent = todayLoyalty.toLocaleString();
            }
            
            // Update floor vs web split
            const floorVsWebEl = document.querySelector('[id*="floorVsWeb"] .purple-text, .text-purple-600');
            if (floorVsWebEl) {
                floorVsWebEl.textContent = `${floorPercent}% / ${webPercent}%`;
            }
        }
        
        function filterTransactions() {
            transactionFilters.source = document.getElementById('filterSource')?.value || 'all';
            transactionFilters.customerType = document.getElementById('filterCustomerType')?.value || 'all';
            transactionFilters.salesperson = document.getElementById('filterSalesperson')?.value || 'all';
            transactionFilters.dateRange = document.getElementById('filterDateRange')?.value || 'today';
            transactionFilters.rewardsEligible = document.getElementById('filterRewardsEligible')?.value || 'all';
            
            currentTransactionPage = 1; // Reset to first page
            loadTransactions();
        }
        
        function loadTransactionPage(direction) {
            const filteredTransactions = getFilteredTransactions();
            const totalPages = Math.ceil(filteredTransactions.length / 50);
            
            if (direction === 'next' && currentTransactionPage < totalPages) {
                currentTransactionPage++;
            } else if (direction === 'prev' && currentTransactionPage > 1) {
                currentTransactionPage--;
            }
            
            loadTransactions();
        }

        async function deleteTestTransactions() {
            const allTransactions = NewcoData.get('transactions') || [];
            const testTransactions = allTransactions.filter(t => t.isTestTransaction);
            const testCount = testTransactions.length;

            if (testCount === 0) {
                showModal({
                    title: 'No Test Transactions',
                    message: 'There are no test transactions to delete.',
                    type: 'info'
                });
                return;
            }

            showModal({
                title: '⚠️ Delete Test Transactions',
                message: `Are you sure you want to delete ${testCount} test transaction${testCount > 1 ? 's' : ''}? This action cannot be undone.`,
                type: 'warning',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Delete', type: 'danger', action: 'confirm' }
                ],
                onConfirm: async () => {
                    // Filter out test transactions
                    const remainingTransactions = allTransactions.filter(t => !t.isTestTransaction);

                    // Save to Supabase (set() already does this)
                    await NewcoData.set('transactions', remainingTransactions);

                    // Reload the transactions view
                    loadTransactions();

                    showModal({
                        title: '✅ Success',
                        message: `Successfully deleted ${testCount} test transaction${testCount > 1 ? 's' : ''}.`,
                        type: 'success'
                    });
                }
            });
        }

        function showCreateTransactionModal() {
            const members = NewcoData.get('members') || [];
            const memberOptions = members.map(m => `<option value="${m.id}">${m.name || m.email} (${m.id})</option>`).join('');

            showModal({
                title: '➕ Create Transaction',
                message: `
                    <div style="text-align: left;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Member</label>
                            <select id="createTransactionMember" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                                <option value="">Select a member...</option>
                                ${memberOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Transaction Type</label>
                            <select id="createTransactionType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                                <option value="purchase">Purchase</option>
                                <option value="refund">Refund</option>
                                <option value="adjustment">Adjustment</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Amount ($)</label>
                            <input type="number" id="createTransactionAmount" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reason <span style="color: red;">*</span></label>
                            <textarea id="createTransactionReason" rows="3" placeholder="Enter reason for this transaction..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;"></textarea>
                        </div>
                    </div>
                `,
                type: 'info',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Create Transaction', type: 'primary', action: 'confirm' }
                ],
                onConfirm: async () => {
                    const memberId = document.getElementById('createTransactionMember').value;
                    const type = document.getElementById('createTransactionType').value;
                    const amount = parseFloat(document.getElementById('createTransactionAmount').value);
                    const reason = document.getElementById('createTransactionReason').value.trim();

                    if (!memberId) {
                        showModal({ title: '⚠️ Error', message: 'Please select a member.', type: 'warning' });
                        return;
                    }
                    if (!amount || amount <= 0) {
                        showModal({ title: '⚠️ Error', message: 'Please enter a valid amount.', type: 'warning' });
                        return;
                    }
                    if (!reason) {
                        showModal({ title: '⚠️ Error', message: 'Reason is required for manual transactions.', type: 'warning' });
                        return;
                    }

                    const member = members.find(m => m.id === memberId);
                    const transactions = NewcoData.get('transactions') || [];

                    const newTransaction = {
                        id: 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        date: new Date(),
                        source: 'Manual Entry',
                        customerId: memberId,
                        customerName: member.name || member.email,
                        type: type,
                        amount: amount,
                        rewardsEligible: type === 'purchase',
                        loyaltyGranted: false,
                        loyaltyEarned: 0,
                        reason: reason,
                        createdBy: sessionStorage.getItem('newco_admin_email'),
                        isManual: true
                    };

                    transactions.unshift(newTransaction);
                    await NewcoData.set('transactions', transactions);

                    // Create detailed activity log entry
                    const activityLog = NewcoData.get('activityLog') || [];
                    const userEmail = sessionStorage.getItem('newco_admin_email');
                    const staff = NewcoData.get('staff') || [];
                    let userName = 'Admin';
                    const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail);
                    if (currentUser) {
                        userName = currentUser.name;
                    }

                    activityLog.unshift({
                        user: userName,
                        userEmail: userEmail,
                        section: 'transactions',
                        sectionName: 'Transactions',
                        action: `Created ${type} transaction for ${member.name || member.email}: $${amount.toFixed(2)}. Reason: ${reason}`,
                        timestamp: new Date().toISOString(),
                        isDetailed: true
                    });

                    if (activityLog.length > 100) {
                        activityLog.splice(100);
                    }

                    await NewcoData.set('activityLog', activityLog);

                    loadTransactions();
                    showModal({
                        title: '✅ Success',
                        message: `Transaction created successfully for ${member.name || member.email}.`,
                        type: 'success'
                    });
                }
            });
        }

        function showCreateRewardTransactionModal() {
            const members = NewcoData.get('members') || [];
            const memberOptions = members.map(m => `<option value="${m.id}">${m.name || m.email} (${m.points || 0} pts)</option>`).join('');

            showModal({
                title: '➕ Create Reward Transaction',
                message: `
                    <div style="text-align: left;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Member</label>
                            <select id="createRewardMember" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                                <option value="">Select a member...</option>
                                ${memberOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Transaction Type</label>
                            <select id="createRewardType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                                <option value="points_added">Points Added</option>
                                <option value="points_redeemed">Points Redeemed</option>
                                <option value="bonus">Bonus Points</option>
                                <option value="adjustment">Adjustment</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Points</label>
                            <input type="number" id="createRewardPoints" min="0" placeholder="0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reason <span style="color: red;">*</span></label>
                            <textarea id="createRewardReason" rows="3" placeholder="Enter reason for this reward transaction..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;"></textarea>
                        </div>
                    </div>
                `,
                type: 'info',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Create Reward', type: 'primary', action: 'confirm' }
                ],
                onConfirm: async () => {
                    const memberId = document.getElementById('createRewardMember').value;
                    const type = document.getElementById('createRewardType').value;
                    const points = parseInt(document.getElementById('createRewardPoints').value);
                    const reason = document.getElementById('createRewardReason').value.trim();

                    if (!memberId) {
                        showModal({ title: '⚠️ Error', message: 'Please select a member.', type: 'warning' });
                        return;
                    }
                    if (!points || points <= 0) {
                        showModal({ title: '⚠️ Error', message: 'Please enter a valid points amount.', type: 'warning' });
                        return;
                    }
                    if (!reason) {
                        showModal({ title: '⚠️ Error', message: 'Reason is required for manual reward transactions.', type: 'warning' });
                        return;
                    }

                    const members = NewcoData.get('members') || [];
                    const member = members.find(m => m.id === memberId);
                    const rewardTransactions = NewcoData.get('rewardTransactions') || [];

                    // Update member points
                    const isDeduction = type === 'points_redeemed';
                    const pointChange = isDeduction ? -points : points;
                    member.points = (member.points || 0) + pointChange;

                    const newReward = {
                        id: 'rwd_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        date: new Date(),
                        customerId: memberId,
                        customerName: member.name || member.email,
                        type: type,
                        points: points,
                        pointChange: pointChange,
                        description: reason,
                        createdBy: sessionStorage.getItem('newco_admin_email'),
                        isManual: true
                    };

                    rewardTransactions.unshift(newReward);
                    await NewcoData.set('members', members);
                    await NewcoData.set('rewardTransactions', rewardTransactions);

                    // Create detailed activity log entry
                    const activityLog = NewcoData.get('activityLog') || [];
                    const userEmail = sessionStorage.getItem('newco_admin_email');
                    const staff = NewcoData.get('staff') || [];
                    let userName = 'Admin';
                    const currentUser = staff.find(s => s.email && s.email.toLowerCase() === userEmail);
                    if (currentUser) {
                        userName = currentUser.name;
                    }

                    activityLog.unshift({
                        user: userName,
                        userEmail: userEmail,
                        section: 'rewards',
                        sectionName: 'Rewards Transactions',
                        action: `Created ${type.replace(/_/g, ' ')} for ${member.name || member.email}: ${pointChange >= 0 ? '+' : ''}${pointChange} points. Reason: ${reason}`,
                        timestamp: new Date().toISOString(),
                        isDetailed: true
                    });

                    if (activityLog.length > 100) {
                        activityLog.splice(100);
                    }

                    await NewcoData.set('activityLog', activityLog);

                    loadRewardTransactions();
                    showModal({
                        title: '✅ Success',
                        message: `Reward transaction created successfully for ${member.name || member.email}. New balance: ${member.points} points.`,
                        type: 'success'
                    });
                }
            });
        }

        function exportTransactions() {
            const filteredTransactions = getFilteredTransactions();
            
            // Create CSV content
            const headers = ['Date', 'Time', 'Source', 'Customer', 'Type', 'Amount', 'Rewards Eligible', 'Loyalty Granted', 'Points Earned'];
            const csvContent = [
                headers.join(','),
                ...filteredTransactions.map(t => [
                    t.date.toLocaleDateString(),
                    t.date.toLocaleTimeString(),
                    t.source,
                    `"${t.customerName || 'Anonymous'}"`,
                    `"${t.type}"`,
                    t.amount.toFixed(2),
                    t.rewardsEligible ? 'Yes' : 'No',
                    t.loyaltyGranted ? 'Yes' : 'No',
                    t.loyaltyEarned
                ].join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showModal({
                title: '📊 Export Complete',
                message: `Exported ${filteredTransactions.length} transactions to CSV file.`,
                type: 'success'
            });
        }

        // Toggle visibility of test data buttons
        function toggleTestDataButtons() {
            const settings = NewcoData.get('settings') || {};
            const enabled = settings.enableTestData === true;
            const buttons = document.querySelectorAll('.test-data-btn');
            buttons.forEach(btn => {
                btn.style.display = enabled ? 'inline-block' : 'none';
            });
        }

        // Generate Test Members
        async function generateTestMembers() {
            showModal({
                title: '➕ Generate Test Members',
                message: 'This will create 50 test members with random data. This may take a minute. Continue?',
                type: 'info',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Generate', type: 'primary', action: 'confirm' }
                ],
                onConfirm: async () => {
                    showLoading('Generating 50 test members...');
                    try {
                        const members = NewcoData.get('members') || [];
                        const firstNames = ['John', 'Jane', 'Michael', 'Sarah', 'David', 'Emily', 'Robert', 'Lisa', 'James', 'Mary', 'William', 'Patricia', 'Richard', 'Jennifer', 'Thomas', 'Christopher', 'Jessica', 'Daniel', 'Amanda', 'Matthew', 'Ashley', 'Joshua', 'Brittany', 'Andrew', 'Stephanie'];
                        const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Taylor', 'Thomas', 'Moore', 'Jackson', 'Martin', 'Lee', 'Walker', 'Hall', 'Allen', 'Young'];

                        console.log('Starting member generation, current count:', members.length);

                        // Helper function to generate UUID v4
                        function generateUUID() {
                            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                                const r = Math.random() * 16 | 0;
                                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                                return v.toString(16);
                            });
                        }

                        for (let i = 0; i < 50; i++) {
                            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                            const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${Math.floor(Math.random() * 1000)}@test.com`;
                            const timestamp = Date.now() + i;

                            members.push({
                                id: generateUUID(),
                                firstName: firstName,
                                lastName: lastName,
                                email: email,
                                phone: `555-${Math.floor(Math.random() * 900 + 100)}-${Math.floor(Math.random() * 9000 + 1000)}`,
                                password: 'testpass123',
                                dateOfBirth: '',
                                address: {
                                    street: '',
                                    city: '',
                                    state: '',
                                    zip: ''
                                },
                                tier: 'bronze',
                                lifetimePoints: Math.floor(Math.random() * 500),
                                currentPoints: Math.floor(Math.random() * 500),
                                lifetimeSpend: Math.floor(Math.random() * 1000),
                                barcode: 'MEMBER' + timestamp.toString().padStart(13, '0'),
                                status: 'active',
                                preferredHall: null,
                                joinDate: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString(),
                                lastVisit: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                                isTestData: true
                            });
                        }

                        console.log('Generated members, new count:', members.length);

                        await NewcoData.set('members', members);
                        console.log('Saved members to storage');

                        loadMembers();
                        console.log('Reloaded members display');

                        hideLoading();
                        notify.modal({
                            title: '✅ Success',
                            message: 'Successfully generated 50 test members.',
                            type: 'success'
                        });
                    } catch (error) {
                        console.error('Error generating test members:', error);
                        hideLoading();
                        notify.modal({
                            title: '❌ Error',
                            message: 'Failed to generate test members: ' + error.message,
                            type: 'error'
                        });
                    }
                }
            });
        }

        // Delete Test Members
        async function deleteTestMembers() {
            const members = NewcoData.get('members') || [];
            const testMembers = members.filter(m => m.isTestData);
            const testCount = testMembers.length;

            if (testCount === 0) {
                showModal({
                    title: 'No Test Members',
                    message: 'There are no test members to delete.',
                    type: 'info'
                });
                return;
            }

            showModal({
                title: '⚠️ Delete Test Members',
                message: `Are you sure you want to delete ${testCount} test member${testCount > 1 ? 's' : ''}? This action cannot be undone.`,
                type: 'warning',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Delete', type: 'danger', action: 'confirm' }
                ],
                onConfirm: async () => {
                    const remainingMembers = members.filter(m => !m.isTestData);
                    await NewcoData.set('members', remainingMembers);
                    loadMembers();

                    showModal({
                        title: '✅ Success',
                        message: `Successfully deleted ${testCount} test member${testCount > 1 ? 's' : ''}.`,
                        type: 'success'
                    });
                }
            });
        }

        // Generate Test Transactions
        async function generateTestTransactions() {
            showModal({
                title: '➕ Generate Test Transactions',
                message: 'This will create 200 test transactions using actual packages and items. This may take a moment. Continue?',
                type: 'info',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Generate', type: 'primary', action: 'confirm' }
                ],
                onConfirm: async () => {
                    showLoading('Generating 200 test transactions...');
                    try {
                        const transactions = NewcoData.get('transactions') || [];
                        const rewardTransactions = NewcoData.get('rewardsTransactions') || [];
                        const members = NewcoData.get('members') || [];
                        const packages = NewcoData.get('packages') || [];
                        const salesItems = NewcoData.get('salesItems') || [];
                        const rewardsConfig = NewcoData.get('rewardsConfig') || {};
                        const sources = ['Online', 'Walk-In', 'Phone', 'Redemption Portal'];
                        const paymentMethods = ['Credit Card', 'Cash', 'Debit Card'];

                        // Get loyalty points calculation from rewards config
                        const pointsPerDollar = rewardsConfig.basicSettings?.webPointsPerDollar || rewardsConfig.webPointsPerDollar || 10;

                        // Use members from database, or create guest customers if no members exist
                        const customersPool = members.length > 0 ? members : [
                            { name: 'Guest Customer', email: 'guest@test.com' }
                        ];

                        for (let i = 0; i < 200; i++) {
                            const member = customersPool[Math.floor(Math.random() * customersPool.length)];
                            const source = sources[Math.floor(Math.random() * sources.length)];

                            // Generate 30% of transactions for today, rest spread over past 90 days
                            let transactionDate;
                            if (i < 60) {
                                // Today's transactions - spread throughout the day
                                const todayStart = new Date();
                                todayStart.setHours(0, 0, 0, 0);
                                const hoursOffset = Math.random() * 24 * 60 * 60 * 1000; // Random time today
                                transactionDate = new Date(todayStart.getTime() + hoursOffset);
                            } else {
                                // Past transactions - spread over last 90 days
                                transactionDate = new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000);
                            }

                            let transactionItems = [];
                            let amount = 0;
                            let type = '';

                        // Decide transaction type
                        const typeRandom = Math.random();
                        if (typeRandom < 0.5 && packages.length > 0) {
                            // Package only
                            const pkg = packages[Math.floor(Math.random() * packages.length)];
                            transactionItems.push({
                                type: 'package',
                                id: pkg.id,
                                name: pkg.name,
                                price: pkg.price,
                                quantity: 1
                            });
                            amount = pkg.price;
                            type = 'Package Purchase';
                        } else if (typeRandom < 0.7 && salesItems.length > 0) {
                            // Item only
                            const item = salesItems[Math.floor(Math.random() * salesItems.length)];
                            const quantity = Math.floor(Math.random() * 3) + 1;
                            transactionItems.push({
                                type: 'item',
                                id: item.id,
                                name: item.name,
                                price: item.price,
                                quantity: quantity
                            });
                            amount = item.price * quantity;
                            type = 'Item Purchase';
                        } else if (packages.length > 0 && salesItems.length > 0) {
                            // Package + Items
                            const pkg = packages[Math.floor(Math.random() * packages.length)];
                            transactionItems.push({
                                type: 'package',
                                id: pkg.id,
                                name: pkg.name,
                                price: pkg.price,
                                quantity: 1
                            });
                            amount = pkg.price;

                            // Add 1-3 random items
                            const itemCount = Math.floor(Math.random() * 3) + 1;
                            for (let j = 0; j < itemCount; j++) {
                                const item = salesItems[Math.floor(Math.random() * salesItems.length)];
                                const quantity = Math.floor(Math.random() * 2) + 1;
                                transactionItems.push({
                                    type: 'item',
                                    id: item.id,
                                    name: item.name,
                                    price: item.price,
                                    quantity: quantity
                                });
                                amount += item.price * quantity;
                            }
                            type = 'Package + Items';
                        } else {
                            // Fallback if no packages/items exist
                            amount = Math.floor(Math.random() * 150 + 10);
                            type = 'General Purchase';
                        }

                        const tax = amount * 0.0875;
                        const total = amount + tax;

                        // Calculate loyalty points - all web transactions earn points if rewards enabled
                        const rewardsEligible = true;
                        const loyaltyGranted = rewardsConfig.rewardType && rewardsConfig.rewardType !== 'none';
                        const loyaltyEarned = loyaltyGranted ? Math.floor(total * pointsPerDollar) : 0;

                        const transactionId = Date.now().toString() + '-' + i + '-' + Math.random();

                        // Generate realistic payment data
                        const paymentMethod = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];
                        const isCard = paymentMethod !== 'Cash';
                        const cardBrands = ['Visa', 'Mastercard', 'Amex', 'Discover'];
                        const cardBrand = isCard ? cardBrands[Math.floor(Math.random() * cardBrands.length)] : null;
                        const cardLast4 = isCard ? Math.floor(1000 + Math.random() * 9000).toString() : null;

                        transactions.push({
                            id: transactionId,
                            type: type,
                            date: transactionDate.toISOString(),
                            memberId: member.id,
                            memberName: member.firstName && member.lastName ? `${member.firstName} ${member.lastName}` : member.name || 'Guest',
                            memberEmail: member.email,
                            sessionId: 'session_' + Math.floor(Math.random() * 100),
                            sessionName: 'Test Session',
                            sessionDate: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][Math.floor(Math.random() * 7)],
                            items: transactionItems,
                            selectedSeat: Math.random() > 0.5 ? `R${Math.floor(Math.random() * 10 + 1)}C${Math.floor(Math.random() * 10 + 1)}` : null,
                            subtotal: amount,
                            tax: tax,
                            loyaltyDiscount: 0,
                            finalTotal: total,
                            loyaltyPointsUsed: 0,
                            loyaltyPointsEarned: loyaltyEarned,
                            loyaltyEarned: loyaltyEarned,
                            paymentMethod: paymentMethod,
                            paymentTransactionId: isCard ? 'TEST_' + Date.now() + '_' + i : null,
                            paymentAuthCode: isCard ? 'ABC' + Math.floor(Math.random() * 1000) : null,
                            cardLast4: cardLast4,
                            cardBrand: cardBrand,
                            authorizationCode: isCard ? 'ABC' + Math.floor(Math.random() * 1000) : null,
                            avsResultCode: isCard ? 'Y' : null,
                            cvvResultCode: isCard ? 'M' : null,
                            networkTransId: isCard ? 'NET_' + Date.now() + '_' + i : null,
                            paymentProcessor: isCard ? 'authorize_net' : null,
                            status: 'purchased',
                            source: 'website',
                            salesperson: 'Web',
                            notes: '',
                            timestamp: transactionDate.toISOString(),
                            processedAt: transactionDate.toISOString(),
                            isTestTransaction: true
                        });

                        // Create corresponding loyalty reward transaction if loyalty granted
                        if (loyaltyGranted && member.id) {
                            // Calculate member's running balance
                            const currentPoints = member.currentPoints || member.loyaltyPoints || 0;
                            const memberBalance = currentPoints + loyaltyEarned;

                            rewardTransactions.push({
                                id: 'reward_' + transactionId + '_earn',
                                date: transactionDate.toISOString(),
                                memberId: member.id,
                                memberName: `${member.firstName} ${member.lastName}`,
                                memberEmail: member.email,
                                type: 'earned',
                                source: 'website',
                                description: `Points earned from ${type}`,
                                points: loyaltyEarned,
                                balance: memberBalance,
                                transactionId: transactionId,
                                isTestData: true
                            });

                            // Update member's loyalty points
                            if (member.currentPoints !== undefined) {
                                member.currentPoints = memberBalance;
                                member.lifetimePoints = (member.lifetimePoints || 0) + loyaltyEarned;
                            } else if (member.loyaltyPoints !== undefined) {
                                member.loyaltyPoints = memberBalance;
                            }
                        }
                    }

                        await NewcoData.set('transactions', transactions);
                        await NewcoData.set('rewardsTransactions', rewardTransactions);
                        await NewcoData.set('members', members);

                        // Refresh all analytics displays
                        loadTransactions();
                        if (typeof loadRewardsTransactions === 'function') {
                            loadRewardsTransactions();
                        }
                        if (typeof loadDashboard === 'function') {
                            loadDashboard();
                        }

                        hideLoading();
                        notify.modal({
                            title: '✅ Success',
                            message: 'Successfully generated 200 test transactions with linked loyalty rewards.',
                            type: 'success'
                        });
                    } catch (error) {
                        console.error('Error generating test transactions:', error);
                        hideLoading();
                        notify.modal({
                            title: '❌ Error',
                            message: 'Failed to generate test transactions: ' + error.message,
                            type: 'error'
                        });
                    }
                }
            });
        }

        // Generate Test Reward Transactions
        async function generateTestRewardTransactions() {
            showModal({
                title: '➕ Generate Test Reward Transactions',
                message: 'This will create 50 test reward transactions (earned and redeemed). Continue?',
                type: 'info',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Generate', type: 'primary', action: 'confirm' }
                ],
                onConfirm: async () => {
                    const rewardTransactions = NewcoData.get('rewardsTransactions') || [];
                    const members = NewcoData.get('members') || [];
                    const staffAwardReasons = ['Excellent Customer Service', 'Milestone Achievement', 'Birthday Bonus', 'Promotion', 'Referral Bonus', 'Sign-up Bonus', 'Anniversary Reward', 'Manager Discretion', 'Loyalty Thank You'];
                    const redeemTypes = ['Item Redemption', 'Discount', 'Free Play', 'Merchandise', 'Gift Card', 'Special Event Access'];

                    // Generate 25 purchase-based earned transactions (from website)
                    for (let i = 0; i < 25; i++) {
                        const member = members.length > 0 ? members[Math.floor(Math.random() * members.length)] : null;
                        if (!member) continue;

                        const points = Math.floor(Math.random() * 150 + 10);
                        const currentBalance = (member.currentPoints || member.loyaltyPoints || 0) + points;

                        rewardTransactions.push({
                            id: 'reward_test_purchase_' + Date.now() + '_' + i + '_' + Math.random().toString().substring(2, 8),
                            type: 'earned',
                            date: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString(),
                            memberId: member.id,
                            memberName: member.firstName && member.lastName ? `${member.firstName} ${member.lastName}` : member.name || 'Guest',
                            memberEmail: member.email,
                            points: points,
                            balance: currentBalance,
                            source: 'website',
                            description: 'Points earned from Package Purchase',
                            isTestData: true
                        });
                    }

                    // Generate 25 staff-awarded earned transactions
                    for (let i = 0; i < 25; i++) {
                        const member = members.length > 0 ? members[Math.floor(Math.random() * members.length)] : null;
                        if (!member) continue;

                        const points = Math.floor(Math.random() * 200 + 50);
                        const reason = staffAwardReasons[Math.floor(Math.random() * staffAwardReasons.length)];
                        const currentBalance = (member.currentPoints || member.loyaltyPoints || 0) + points;

                        rewardTransactions.push({
                            id: 'reward_test_staff_' + Date.now() + '_' + i + '_' + Math.random().toString().substring(2, 8),
                            type: 'earned',
                            date: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString(),
                            memberId: member.id,
                            memberName: member.firstName && member.lastName ? `${member.firstName} ${member.lastName}` : member.name || 'Guest',
                            memberEmail: member.email,
                            points: points,
                            balance: currentBalance,
                            source: 'staff',
                            description: reason,
                            isTestData: true
                        });
                    }

                    await NewcoData.set('rewardsTransactions', rewardTransactions);
                    loadRewardsTransactions();

                    notify.modal({
                        title: '✅ Success',
                        message: 'Successfully generated 50 test reward transactions (25 purchases, 25 staff awards).',
                        type: 'success'
                    });
                }
            });
        }

        // Delete Test Reward Transactions
        async function deleteTestRewardTransactions() {
            const rewardTransactions = NewcoData.get('rewardTransactions') || [];
            const testTransactions = rewardTransactions.filter(t => t.isTestData);
            const testCount = testTransactions.length;

            if (testCount === 0) {
                showModal({
                    title: 'No Test Reward Transactions',
                    message: 'There are no test reward transactions to delete.',
                    type: 'info'
                });
                return;
            }

            showModal({
                title: '⚠️ Delete Test Reward Transactions',
                message: `Are you sure you want to delete ${testCount} test reward transaction${testCount > 1 ? 's' : ''}? This action cannot be undone.`,
                type: 'warning',
                buttons: [
                    { text: 'Cancel', type: 'secondary', action: 'cancel' },
                    { text: 'Delete', type: 'danger', action: 'confirm' }
                ],
                onConfirm: async () => {
                    const remainingTransactions = rewardTransactions.filter(t => !t.isTestData);
                    await NewcoData.set('rewardTransactions', remainingTransactions);
                    loadRewardsTransactions();

                    showModal({
                        title: '✅ Success',
                        message: `Successfully deleted ${testCount} test reward transaction${testCount > 1 ? 's' : ''}.`,
                        type: 'success'
                    });
                }
            });
        }

        // Initialize transactions on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('transactionsTableBody')) {
                loadTransactions();
            }
            if (document.getElementById('rewardsTransactionsTableBody')) {
                loadRewardsTransactions();
            }
            toggleTestDataButtons();
        });
        
        // ═══════════════════════════════════════════════════════════════════
        // STORE OPERATIONS FUNCTIONS (Redemption, Purchasing, Floor Rewards)
        // ═══════════════════════════════════════════════════════════════════
        
        function toggleRedemptionSettings() {
            const enabled = document.getElementById('enableRedemption').checked;
            const marketingText = document.getElementById('redemptionMarketingText');
            const content = document.getElementById('redemptionContent');
            const launchCard = document.getElementById('redemptionLaunchCard');

            if (enabled) {
                marketingText.style.display = 'none';
                content.style.display = 'block';
                launchCard.style.display = 'block';
            } else {
                marketingText.style.display = 'block';
                content.style.display = 'none';
                launchCard.style.display = 'none';
            }

            // Save the enabled state
            const settings = NewcoData.get('redemptionSettings') || {};
            settings.enabled = enabled;
            NewcoData.set('redemptionSettings', settings);
        }
        
        function togglePurchasingSettings() {
            const enabled = document.getElementById('enablePurchasing').checked;
            const marketingText = document.getElementById('purchasingMarketingText');
            const content = document.getElementById('purchasingContent');
            const launchCard = document.getElementById('purchasingLaunchCard');

            if (enabled) {
                marketingText.style.display = 'none';
                content.style.display = 'block';
                launchCard.style.display = 'block';
            } else {
                marketingText.style.display = 'block';
                content.style.display = 'none';
                launchCard.style.display = 'none';
            }

            // Save the enabled state
            const settings = NewcoData.get('purchasingSettings') || {};
            settings.enabled = enabled;
            NewcoData.set('purchasingSettings', settings);
        }
        
        function saveRedemptionSettings() {
            const settings = {
                enabled: document.getElementById('enableRedemption').checked,
                permissionLevel: document.getElementById('redemptionPermissionLevel').value,
                mode: document.getElementById('redemptionMode').value,
                requireIdVerification: document.getElementById('requireIdVerification').checked,
                sendNotifications: document.getElementById('sendRedemptionNotifications').checked,
                startTime: document.getElementById('redemptionStartTime').value,
                endTime: document.getElementById('redemptionEndTime').value
            };
            
            NewcoData.set('redemptionSettings', settings);
            showSuccess('Redemption settings saved successfully!');
        }
        
        function savePurchasingSettings() {
            const settings = {
                enabled: document.getElementById('enablePurchasing').checked,
                permissionLevel: document.getElementById('purchasingPermissionLevel').value,
                mergeWithRedemption: document.getElementById('mergeRedemptionPurchasing').checked,
                printReceipts: document.getElementById('printReceipts').checked,
                emailReceipts: document.getElementById('emailReceipts').checked
            };
            
            NewcoData.set('purchasingSettings', settings);
            showSuccess('Purchasing settings saved successfully!');
        }
        
        function saveFloorRewardsSettings() {
            const settings = {
                enabled: document.getElementById('enableFloorRewards').checked,
                enableScanning: document.getElementById('enableFloorScanning').checked
            };
            
            NewcoData.set('floorRewardsSettings', settings);
            showSuccess('Floor rewards settings saved successfully!');
        }
        
        function openRedemptionApp() {
            // Open in new tab with redemption mode
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-redemption-v2.2.html?customer=${customerId}&mode=redemption`, '_blank');
        }

        function openPurchasingApp() {
            // Open in new tab with purchasing mode
            const customerId = new URLSearchParams(window.location.search).get('customer') || 'demo';
            window.open(`newco-redemption-v2.2.html?customer=${customerId}&mode=purchasing`, '_blank');
        }
        
        function copyRedemptionLink() {
            const input = document.getElementById('redemptionAppLink');
            input.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        }
        
        function copyPurchasingLink() {
            const input = document.getElementById('purchasingAppLink');
            input.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        }
        
        
        function openFloorRewardsApp() {
            // Open floor rewards app in new tab
            window.open('bms-floor-runner-vanguard.html', '_blank');
        }
        
        function copyFloorRewardsLink() {
            const input = document.getElementById('floorRewardsAppLink');
            input.select();
            document.execCommand('copy');
            showSuccess('Link copied to clipboard!');
        }
        
        function loadStoreOperationsSettings() {
            // Load redemption settings
            const redemptionSettings = NewcoData.get('redemptionSettings');
            const redemptionEnabled = redemptionSettings?.enabled !== undefined ? redemptionSettings.enabled : false;

            document.getElementById('enableRedemption').checked = redemptionEnabled;

            if (redemptionSettings) {
                document.getElementById('redemptionPermissionLevel').value = redemptionSettings.permissionLevel || 'Staff';
                document.getElementById('redemptionMode').value = redemptionSettings.mode || 'pickup';
                document.getElementById('requireIdVerification').checked = redemptionSettings.requireIdVerification !== false;
                document.getElementById('sendRedemptionNotifications').checked = redemptionSettings.sendNotifications === true;
                document.getElementById('redemptionStartTime').value = redemptionSettings.startTime || '09:00';
                document.getElementById('redemptionEndTime').value = redemptionSettings.endTime || '17:00';
            }
            toggleRedemptionSettings();

            // Load purchasing settings
            const purchasingSettings = NewcoData.get('purchasingSettings');
            const purchasingEnabled = purchasingSettings?.enabled !== undefined ? purchasingSettings.enabled : false;

            document.getElementById('enablePurchasing').checked = purchasingEnabled;

            if (purchasingSettings) {
                document.getElementById('purchasingPermissionLevel').value = purchasingSettings.permissionLevel || 'Cashier';
                document.getElementById('printReceipts').checked = purchasingSettings.printReceipts !== false;
                document.getElementById('emailReceipts').checked = purchasingSettings.emailReceipts || false;
            }
            togglePurchasingSettings();

            // Load floor rewards settings
            const floorRewardsSettings = NewcoData.get('floorRewardsSettings');
            if (floorRewardsSettings) {
                if (document.getElementById('enableFloorRewards')) {
                    document.getElementById('enableFloorRewards').checked = floorRewardsSettings.enabled !== false;
                }
                if (document.getElementById('enableFloorScanning')) {
                    document.getElementById('enableFloorScanning').checked = floorRewardsSettings.enableScanning !== false;
                }
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // REWARDS TRANSACTIONS FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let currentRewardsTab = 'earned';
        let currentRewardsPage = 1;
        let rewardsSortBy = 'date';
        let rewardsSortOrder = 'desc';
        let rewardsTransactionFilters = {
            type: 'all',
            source: 'all',
            dateRange: 'all',
            memberStatus: 'all'
        };
        
        function switchRewardsTab(tab) {
            currentRewardsTab = tab;
            
            // Update tab styling
            const earnedTab = document.getElementById('earnedTab');
            const redeemedTab = document.getElementById('redeemedTab');
            
            if (tab === 'earned') {
                earnedTab.className = 'btn btn-primary';
                redeemedTab.className = 'btn btn-outline';
                document.getElementById('filterEarnedOption').selected = true;
                rewardsTransactionFilters.type = 'earned';
            } else {
                earnedTab.className = 'btn btn-outline';
                redeemedTab.className = 'btn btn-primary';
                document.getElementById('filterRedeemedOption').selected = true;
                rewardsTransactionFilters.type = 'redeemed';
            }
            
            // Update filter dropdown
            document.getElementById('filterRewardsType').value = tab;
            
            // Reload data
            currentRewardsPage = 1;
            loadRewardsTransactions();
        }
        
        function generateSampleRewardsTransactions() {
            const transactions = [];
            const members = ['John Smith', 'Mary Johnson', 'Bob Wilson', 'Lisa Davis', 'Mike Brown', 'Sarah Lee', 'Tom Garcia', 'Amy Chen', 'David Miller', 'Kate Johnson'];
            const earnedSources = ['floor', 'website', 'bonus', 'birthday', 'referral', 'signup'];
            const redeemedItems = ['Free Bingo Session', '10% Discount', 'Concession Credit', 'VIP Seat Upgrade', 'Extra Cards', 'Merchandise'];
            const tiers = ['tier1', 'tier2', 'tier3', 'vip'];
            
            for (let i = 0; i < 2847; i++) {
                const isEarned = Math.random() > 0.4; // 60% earned, 40% redeemed
                const member = members[Math.floor(Math.random() * members.length)];
                const tier = tiers[Math.floor(Math.random() * tiers.length)];
                
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                const transaction = {
                    id: 'txn_' + Date.now() + '_' + i,
                    date: date,
                    member: member,
                    memberTier: tier,
                    type: isEarned ? 'earned' : 'redeemed',
                    points: isEarned ?
                        Math.floor(Math.random() * 500) + 10 :
                        -(Math.floor(Math.random() * 1000) + 100),
                    balance: Math.floor(Math.random() * 5000) + 100,
                    status: Math.random() > 0.05 ? 'completed' : 'pending'
                };
                
                if (isEarned) {
                    transaction.source = earnedSources[Math.floor(Math.random() * earnedSources.length)];
                    transaction.description = `Points from ${transaction.source} purchase`;
                } else {
                    transaction.source = 'redemption';
                    transaction.description = redeemedItems[Math.floor(Math.random() * redeemedItems.length)];
                }
                
                transactions.push(transaction);
            }
            
            return transactions.sort((a, b) => b.date - a.date);
        }
        
        function sortRewardsTransactions(field) {
            // Toggle sort order if clicking the same field
            if (rewardsSortBy === field) {
                rewardsSortOrder = rewardsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                rewardsSortBy = field;
                rewardsSortOrder = 'asc';
            }
            
            // Update arrow indicators
            ['date', 'member', 'type', 'source', 'points', 'balance', 'status'].forEach(f => {
                const arrow = document.getElementById(`sortArrowRewards${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (arrow) {
                    if (f === field) {
                        arrow.textContent = rewardsSortOrder === 'asc' ? '↑' : '↓';
                    } else {
                        arrow.textContent = '↕️';
                    }
                }
            });
            
            loadRewardsTransactions();
        }
        
        function getFilteredRewardsTransactions() {
            // Get REAL rewards transactions from localStorage
            const allTransactions = NewcoData.get('rewardsTransactions') || [];
            const today = new Date();
            
            // Convert date strings to Date objects and normalize field names
            const normalizedTransactions = allTransactions.map(t => ({
                ...t,
                date: typeof t.date === 'string' ? new Date(t.date) : t.date,
                member: t.member || t.memberName || 'Unknown',
                memberTier: t.memberTier || 'tier1',
                status: t.status || 'completed'
            }));
            
            return normalizedTransactions.filter(transaction => {
                // Type filter
                if (rewardsTransactionFilters.type !== 'all' && transaction.type !== rewardsTransactionFilters.type) {
                    return false;
                }
                
                // Source filter
                if (rewardsTransactionFilters.source !== 'all' && transaction.source !== rewardsTransactionFilters.source) {
                    return false;
                }
                
                // Date range filter
                if (rewardsTransactionFilters.dateRange === 'today') {
                    const isToday = transaction.date.toDateString() === today.toDateString();
                    if (!isToday) return false;
                } else if (rewardsTransactionFilters.dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(today.getDate() - 7);
                    if (transaction.date < weekAgo) return false;
                } else if (rewardsTransactionFilters.dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(today.getMonth() - 1);
                    if (transaction.date < monthAgo) return false;
                }
                
                // Member status filter
                if (rewardsTransactionFilters.memberStatus !== 'all' && transaction.memberTier !== rewardsTransactionFilters.memberStatus) {
                    return false;
                }
                
                return true;
            }).sort((a, b) => {
                let aVal, bVal;
                
                switch(rewardsSortBy) {
                    case 'date':
                        aVal = a.date;
                        bVal = b.date;
                        break;
                    case 'member':
                        aVal = a.member || '';
                        bVal = b.member || '';
                        break;
                    case 'type':
                        aVal = a.type || '';
                        bVal = b.type || '';
                        break;
                    case 'source':
                        aVal = a.source || '';
                        bVal = b.source || '';
                        break;
                    case 'points':
                        aVal = a.points || 0;
                        bVal = b.points || 0;
                        break;
                    case 'balance':
                        aVal = a.balance || 0;
                        bVal = b.balance || 0;
                        break;
                    case 'status':
                        aVal = a.status || '';
                        bVal = b.status || '';
                        break;
                    default:
                        aVal = a.date;
                        bVal = b.date;
                }
                
                if (rewardsSortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        async function loadRewardsTransactions() {
            // Refresh cache from Supabase first
            const custData = await NewcoData.read_cust();
            if (custData.rewardsTransactions) {
                NewcoData.cache.rewardsTransactions = custData.rewardsTransactions;
            }

            // Get REAL rewards transactions from cache
            const allTransactions = NewcoData.get('rewardsTransactions') || [];
            
            // Normalize all transactions for analytics
            const normalizedAll = allTransactions.map(t => ({
                ...t,
                date: typeof t.date === 'string' ? new Date(t.date) : t.date,
                member: t.member || t.memberName || 'Unknown',
                memberTier: t.memberTier || 'tier1',
                status: t.status || 'completed'
            }));
            
            const filteredTransactions = getFilteredRewardsTransactions();
            const perPage = 50;
            const startIndex = (currentRewardsPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            const totalPages = Math.ceil(filteredTransactions.length / perPage);
            
            // Update analytics with all transactions (not filtered by tab)
            updateRewardsAnalytics(normalizedAll);
            
            // Update table
            const tbody = document.getElementById('rewardsTransactionsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = pageTransactions.map(transaction => `
                <tr style="border-bottom: 1px solid var(--gray-light);">
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 500;">${transaction.date.toLocaleDateString()}</div>
                            <div style="font-size: 0.875rem; color: var(--gray);">${transaction.date.toLocaleTimeString()}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="cursor: pointer;" onclick="viewMemberDetails('${transaction.customerId || transaction.memberId}')" title="Click to view member details">
                            <div style="font-weight: 600; color: var(--primary); text-decoration: underline;">${transaction.member}</div>
                            <div style="font-size: 0.75rem; color: var(--gray); text-transform: capitalize;">${transaction.memberTier.replace('tier', 'Tier ')}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: ${transaction.type === 'earned' ? '#ffa72620' : '#26a69a20'}; color: ${transaction.type === 'earned' ? '#ffa726' : '#26a69a'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize;">
                            ${transaction.type === 'earned' ? '⭐ Earned' : '🎁 Redeemed'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div>
                            <div style="font-weight: 500; text-transform: capitalize;">${transaction.source.replace('_', ' ')}</div>
                            <div style="font-size: 0.75rem; color: var(--gray);">${transaction.description}</div>
                        </div>
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: ${transaction.points > 0 ? 'var(--success)' : '#26a69a'};">
                        ${transaction.points > 0 ? '+' : ''}${transaction.points.toLocaleString()}
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: var(--primary);">
                        ${transaction.balance.toLocaleString()}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="color: ${transaction.status === 'completed' ? 'var(--success)' : '#ffa726'}; font-weight: 600; text-transform: capitalize;">
                            ${transaction.status === 'completed' ? '✓ Complete' : '⏳ Pending'}
                        </span>
                    </td>
                </tr>
            `).join('');
            
            // Update table title and counts
            const titleElement = document.getElementById('rewardsTableTitle');
            const countElement = document.getElementById('rewardsTransactionCount');
            const paginationElement = document.getElementById('rewardsPagination');
            
            if (titleElement) {
                titleElement.textContent = currentRewardsTab === 'earned' ? 
                    'Recent Points Earned' : 'Recent Points Redeemed';
            }
            
            if (countElement) {
                countElement.textContent = `Showing ${pageTransactions.length} of ${filteredTransactions.length} transactions`;
            }
            
            if (paginationElement) {
                paginationElement.textContent = `Page ${currentRewardsPage} of ${totalPages}`;
            }
        }
        
        function updateRewardsAnalytics(transactions) {
            const today = new Date();
            const todayTransactions = transactions.filter(t => 
                t.date.toDateString() === today.toDateString()
            );
            
            const earnedToday = todayTransactions.filter(t => t.type === 'earned');
            const redeemedToday = todayTransactions.filter(t => t.type === 'redeemed');
            
            const earnedPoints = earnedToday.reduce((sum, t) => sum + t.points, 0);
            const redeemedPoints = Math.abs(redeemedToday.reduce((sum, t) => sum + t.points, 0));
            const netPoints = earnedPoints - redeemedPoints;
            const activeMembers = new Set(todayTransactions.map(t => t.member)).size;
            
            // Update UI elements
            const pointsEarnedTodayEl = document.getElementById('pointsEarnedToday');
            const pointsRedeemedTodayEl = document.getElementById('pointsRedeemedToday');
            const netPointsTodayEl = document.getElementById('netPointsToday');
            const activeMembersEl = document.getElementById('activeMembers');
            
            if (pointsEarnedTodayEl) {
                pointsEarnedTodayEl.textContent = earnedPoints.toLocaleString();
                pointsEarnedTodayEl.nextElementSibling.textContent = `${earnedToday.length} transactions`;
            }
            
            if (pointsRedeemedTodayEl) {
                pointsRedeemedTodayEl.textContent = redeemedPoints.toLocaleString();
                pointsRedeemedTodayEl.nextElementSibling.textContent = `${redeemedToday.length} redemptions`;
            }
            
            if (netPointsTodayEl) {
                netPointsTodayEl.textContent = (netPoints >= 0 ? '+' : '') + netPoints.toLocaleString();
            }
            
            if (activeMembersEl) {
                activeMembersEl.textContent = activeMembers.toLocaleString();
            }
        }
        
        function filterRewardsTransactions() {
            rewardsTransactionFilters.type = document.getElementById('filterRewardsType')?.value || 'all';
            rewardsTransactionFilters.source = document.getElementById('filterRewardsSource')?.value || 'all';
            rewardsTransactionFilters.dateRange = document.getElementById('filterRewardsDateRange')?.value || 'today';
            rewardsTransactionFilters.memberStatus = document.getElementById('filterMemberStatus')?.value || 'all';
            
            // Update tab if filter type changed
            if (rewardsTransactionFilters.type !== 'all' && rewardsTransactionFilters.type !== currentRewardsTab) {
                switchRewardsTab(rewardsTransactionFilters.type);
                return; // switchRewardsTab will call loadRewardsTransactions
            }
            
            currentRewardsPage = 1; // Reset to first page
            loadRewardsTransactions();
        }
        
        function loadRewardsTransactionPage(direction) {
            const filteredTransactions = getFilteredRewardsTransactions();
            const totalPages = Math.ceil(filteredTransactions.length / 50);
            
            if (direction === 'next' && currentRewardsPage < totalPages) {
                currentRewardsPage++;
            } else if (direction === 'prev' && currentRewardsPage > 1) {
                currentRewardsPage--;
            }
            
            loadRewardsTransactions();
        }
        
        function exportRewardsTransactions() {
            const filteredTransactions = getFilteredRewardsTransactions();
            
            // Create CSV content
            const headers = ['Date', 'Time', 'Member', 'Type', 'Source', 'Description', 'Points', 'Balance', 'Status'];
            const csvContent = [
                headers.join(','),
                ...filteredTransactions.map(t => [
                    t.date.toLocaleDateString(),
                    t.date.toLocaleTimeString(),
                    `"${t.member}"`,
                    t.type,
                    t.source,
                    `"${t.description}"`,
                    t.points,
                    t.balance,
                    t.status
                ].join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rewards_transactions_${currentRewardsTab}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showModal({
                title: '📊 Export Complete',
                message: `Exported ${filteredTransactions.length} rewards transactions to CSV file.`,
                type: 'success'
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // WEB BUILDER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let selectedBuilderComponent = null;
        let builderComponents = [];
        
        // Drag and Drop Functions
        function allowDrop(event) {
            event.preventDefault();
        }
        
        function dropComponent(event) {
            event.preventDefault();
            const componentType = event.dataTransfer.getData('text/plain');
            if (componentType) {
                addComponentToBuilder(componentType, event.clientY);
            }
        }
        
        // Reports Section Functions
        function loadReports() {
            // Update stats with current data
            updateReportStats();
        }
        
        function updateReportStats() {
            // Simulate updating stats with real data
            const stats = {
                revenue: Math.floor(Math.random() * 5000) + 20000,
                sessions: Math.floor(Math.random() * 100) + 800,
                memberGrowth: Math.floor(Math.random() * 20) + 30
            };
            
            document.getElementById('reportRevenue').textContent = '$' + stats.revenue.toLocaleString();
            document.getElementById('reportSessions').textContent = stats.sessions.toLocaleString();
            document.getElementById('reportAvgRevenue').textContent = '$' + (stats.revenue / stats.sessions).toFixed(2);
            document.getElementById('reportMemberGrowth').textContent = '+' + stats.memberGrowth;
        }
        
        function viewReport(reportType) {
            showModal({
                title: '📊 ' + reportType.charAt(0).toUpperCase() + reportType.slice(1) + ' Report',
                message: 'Generating ' + reportType + ' report... This feature will connect to your analytics system.',
                type: 'info'
            });
        }
        
        function exportReports() {
            // Gather data from multiple sections
            const members = NewcoData.get('members') || [];
            const transactions = NewcoData.get('transactions') || [];
            const rewardsTransactions = NewcoData.get('rewardsTransactions') || [];
            const staff = NewcoData.get('staff') || [];
            const activityLog = NewcoData.get('activityLog') || [];

            if (members.length === 0 && transactions.length === 0 && rewardsTransactions.length === 0) {
                showModal({
                    title: '⚠️ No Data',
                    message: 'There is no data to export yet. Try again after some activity has been recorded.',
                    type: 'warning'
                });
                return;
            }

            // Create summary report CSV
            const summary = [
                'NewCo Admin - System Summary Report',
                `Generated: ${new Date().toLocaleString()}`,
                '',
                'Category,Count,Details',
                `Members,${members.length},"Active users in the system"`,
                `Staff,${staff.length},"Team members with access"`,
                `Transactions,${transactions.length},"All purchase transactions"`,
                `Rewards Transactions,${rewardsTransactions.length},"Loyalty point activities"`,
                `Activity Log Entries,${activityLog.length},"Admin actions tracked"`,
                '',
                'Member Statistics',
                'Metric,Value',
                `Total Members,${members.length}`,
                `Average Loyalty Points,${members.length > 0 ? (members.reduce((sum, m) => sum + (m.loyaltyPoints || m.points || 0), 0) / members.length).toFixed(2) : 0}`,
                `Total Lifetime Spend,$${members.reduce((sum, m) => sum + (m.lifetimeSpend || 0), 0).toFixed(2)}`
            ].join('\n');

            const blob = new Blob([summary], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `newco_summary_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showModal({
                title: '📥 Export Complete',
                message: `Summary report exported with data from ${members.length} members, ${transactions.length} transactions, and ${rewardsTransactions.length} rewards activities.`,
                type: 'success'
            });
        }
        
        function viewSavedReport(reportId) {
            showModal({
                title: '📄 View Report',
                message: 'Opening saved report #' + reportId + '...',
                type: 'info'
            });
        }
        
        function downloadReport(reportId) {
            showModal({
                title: '⬇️ Download Report',
                message: 'Downloading report #' + reportId + ' as PDF...',
                type: 'success'
            });
        }
        
        // Email Section Functions
        function loadEmails() {
            // Update email stats
            updateEmailStats();
        }
        
        function updateEmailStats() {
            // Could fetch real stats from backend
            console.log('Email stats loaded');
        }
        
        function testEmailSetup() {
            showModal({
                title: '🧪 Test Email Setup',
                message: 'Sending test email to your configured address... Check your inbox!',
                type: 'info'
            });
        }
        
        function createEmailCampaign() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = 'Create Email Campaign';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Campaign Name</label>
                    <input type="text" class="form-input" id="campaignName" placeholder="e.g., Holiday Special Announcement">
                </div>
                <div class="form-group">
                    <label class="form-label">Subject Line</label>
                    <input type="text" class="form-input" id="campaignSubject" placeholder="e.g., 🎄 Special Holiday Bingo Events!">
                </div>
                <div class="form-group">
                    <label class="form-label">Recipients</label>
                    <select class="form-select" id="campaignRecipients">
                        <option value="all">All Members (1,247)</option>
                        <option value="active">Active Members (892)</option>
                        <option value="vip">VIP Members (124)</option>
                        <option value="new">New Members (47)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Send Time</label>
                    <select class="form-select" id="campaignSendTime">
                        <option value="now">Send Now</option>
                        <option value="scheduled">Schedule for Later</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-input" id="campaignMessage" rows="6" placeholder="Enter your email message here..."></textarea>
                </div>
            `;
            
            modalSaveBtn.onclick = () => {
                showSuccess('Email campaign created successfully!');
                closeModal();
            };
            
            modal.classList.add('active');
        }
        
        function editEmailTemplate(templateType) {
            showModal({
                title: '✏️ Edit ' + templateType.charAt(0).toUpperCase() + templateType.slice(1) + ' Email Template',
                message: 'Email template editor will open here with rich text formatting options.',
                type: 'info'
            });
        }
        
        function previewEmail(templateType) {
            showModal({
                title: '👁️ Preview ' + templateType.charAt(0).toUpperCase() + templateType.slice(1) + ' Email',
                message: 'Email preview will show here with your branding and content.',
                type: 'info'
            });
        }
        
        function sendTestEmail(templateType) {
            showModal({
                title: '📧 Send Test Email',
                message: 'Test email sent! Check your inbox for the ' + templateType + ' email template.',
                type: 'success'
            });
        }
        
        function viewCampaignStats(campaignId) {
            showModal({
                title: '📊 Campaign Statistics',
                message: 'Detailed stats for campaign #' + campaignId + ' including open rates, click-through rates, and conversions.',
                type: 'info'
            });
        }
        
        function duplicateCampaign(campaignId) {
            showModal({
                title: '📋 Duplicate Campaign',
                message: 'Campaign #' + campaignId + ' duplicated. You can now edit and send it.',
                type: 'success'
            });
        }
        
        function editCampaign(campaignId) {
            createEmailCampaign(); // Reuse the create function for editing
        }
        
        function cancelCampaign(campaignId) {
            showConfirm(
                'Are you sure you want to cancel this scheduled campaign?',
                () => {
                    showSuccess('Campaign cancelled successfully');
                }
            );
        }
        
        function saveEmailSettings() {
            const settings = {
                fromName: document.getElementById('emailFromName').value,
                fromAddress: document.getElementById('emailFromAddress').value,
                replyTo: document.getElementById('emailReplyTo').value,
                footer: document.getElementById('emailFooter').value
            };
            
            NewcoData.set('emailSettings', settings);
            showSuccess('Email settings saved successfully!');
        }
        
        function sendCampaign(campaignId) {
            showConfirm(
                'Are you sure you want to send this campaign now? This action cannot be undone.',
                () => {
                    showSuccess('Campaign is being sent to recipients...');
                    // Update the campaign status in the table
                    setTimeout(() => {
                        const row = document.querySelector(`#emailCampaignsTableBody tr:nth-child(${campaignId})`);
                        if (row) {
                            const statusCell = row.cells[1];
                            statusCell.innerHTML = '<span style="background: var(--info); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sending...</span>';
                            
                            setTimeout(() => {
                                statusCell.innerHTML = '<span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>';
                                showSuccess('Campaign sent successfully!');
                            }, 2000);
                        }
                    }, 500);
                },
                'Send Campaign'
            );
        }
        
        function editRecurring(campaignId) {
            showModal({
                title: '🎯 Edit Recurring Campaign',
                message: 'Recurring campaign settings: Weekly Game Schedule<br><br>Frequency: Every Monday at 9:00 AM<br>Recipients: All Active Members<br><br>This feature will allow you to edit the schedule and content.',
                type: 'info'
            });
        }
        
        function pauseRecurring(campaignId) {
            showConfirm(
                'Pause the weekly game schedule emails?',
                () => {
                    const row = document.querySelector(`#emailCampaignsTableBody tr:nth-child(${campaignId})`);
                    if (row) {
                        const actionsCell = row.cells[5];
                        actionsCell.innerHTML = `
                            <button class="btn btn-sm btn-secondary" onclick="editRecurring(${campaignId})">Edit</button>
                            <button class="btn btn-sm btn-success" onclick="resumeRecurring(${campaignId})">Resume</button>
                        `;
                    }
                    showSuccess('Recurring campaign paused');
                }
            );
        }
        
        function resumeRecurring(campaignId) {
            const row = document.querySelector(`#emailCampaignsTableBody tr:nth-child(${campaignId})`);
            if (row) {
                const actionsCell = row.cells[5];
                actionsCell.innerHTML = `
                    <button class="btn btn-sm btn-secondary" onclick="editRecurring(${campaignId})">Edit</button>
                    <button class="btn btn-sm btn-outline" onclick="pauseRecurring(${campaignId})">Pause</button>
                `;
            }
            showSuccess('Recurring campaign resumed');
        }
        
        // Helper functions for welcome email in staff member modal
        function toggleWelcomeEmailOptions(checkbox) {
            const options = document.getElementById('welcomeEmailOptions');
            if (options) {
                options.style.display = checkbox.checked ? 'block' : 'none';
            }
        }
        
        function updateWelcomePreview() {
            const template = document.getElementById('welcomeEmailTemplate').value;
            const preview = document.getElementById('welcomeEmailPreview');
            const customGroup = document.getElementById('customWelcomeGroup');
            
            if (!preview) return;
            
            if (template === 'custom') {
                customGroup.style.display = 'block';
                const customText = document.getElementById('customWelcomeText').value || 
                    'Welcome to our team! We\'re excited to have you join us...';
                preview.innerHTML = `
                    Subject: Welcome to Santa Clara Bingo!<br>
                    <br>
                    ${customText.replace(/{name}/g, 'John Doe')
                                .replace(/{role}/g, 'Staff Member')
                                .replace(/{email}/g, 'john@example.com')
                                .replace(/{organization}/g, 'Santa Clara Bingo')
                                .replace(/{loginUrl}/g, 'https://portal.santaclarabingo.com')}
                `;
            } else {
                customGroup.style.display = 'none';
                
                const templates = {
                    standard: `
                        Subject: Welcome to Santa Clara Bingo!<br>
                        <br>
                        Dear {name},<br>
                        <br>
                        Welcome to Santa Clara Bingo! You've been added as a {role}.<br>
                        <br>
                        We're thrilled to have you join our team. You'll find everything you need to get started in our staff portal.<br>
                        <br>
                        Your login credentials will be sent in a separate email.
                    `,
                    admin: `
                        Subject: Admin Access Granted - Santa Clara Bingo<br>
                        <br>
                        Dear {name},<br>
                        <br>
                        You've been granted Admin access to Santa Clara Bingo's management system.<br>
                        <br>
                        As an administrator, you have full access to:<br>
                        • Staff management<br>
                        • Financial reports<br>
                        • Game configuration<br>
                        • Member database<br>
                        <br>
                        Please review our admin guide at: {loginUrl}/admin-guide<br>
                        <br>
                        Your credentials will follow in a secure email.
                    `,
                    floor: `
                        Subject: Welcome to the Team - Santa Clara Bingo<br>
                        <br>
                        Hello {name}!<br>
                        <br>
                        Welcome aboard as our new {role}!<br>
                        <br>
                        Your first shift details:<br>
                        • Check the schedule portal for your assigned shifts<br>
                        • Arrive 15 minutes early for orientation<br>
                        • Uniform will be provided on your first day<br>
                        <br>
                        Portal access: {loginUrl}<br>
                        Your login details will be sent separately.
                    `
                };
                
                preview.innerHTML = templates[template] || templates.standard;
            }
        }
        
        window.toggleWelcomeEmailOptions = toggleWelcomeEmailOptions;
        window.updateWelcomePreview = updateWelcomePreview;
        
        // ═══════════════════════════════════════════════════════════════════
        // ACTIONS LOG FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let currentActionsPage = 1;
        let actionsSortBy = 'timestamp';
        let actionsSortOrder = 'desc';
        let actionsFilters = {
            user: 'all',
            actionType: 'all',
            dateRange: 'today',
            search: ''
        };
        
        function loadActionsLog() {
            const actionsLog = NewcoData.get('activityLog') || [];

            // Populate user filter
            const users = [...new Set(actionsLog.map(a => a.user))];
            const userFilter = document.getElementById('filterActionUser');
            if (userFilter) {
                userFilter.innerHTML = '<option value="all">All Users</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userFilter.appendChild(option);
                });
            }

            filterActionsLog();
        }

        function filterActionsLog() {
            const actionsLog = NewcoData.get('activityLog') || [];
            const today = new Date();
            
            actionsFilters.user = document.getElementById('filterActionUser')?.value || 'all';
            actionsFilters.actionType = document.getElementById('filterActionType')?.value || 'all';
            actionsFilters.dateRange = document.getElementById('filterActionDate')?.value || 'today';
            actionsFilters.search = document.getElementById('searchActionDetails')?.value?.toLowerCase() || '';
            
            let filtered = actionsLog.filter(action => {
                // User filter
                if (actionsFilters.user !== 'all' && action.user !== actionsFilters.user) {
                    return false;
                }

                // Action type filter (skip this filter for now as activity log doesn't have actionType)
                // if (actionsFilters.actionType !== 'all' && action.actionType !== actionsFilters.actionType) {
                //     return false;
                // }

                // Date range filter
                const actionDate = new Date(action.timestamp);
                if (actionsFilters.dateRange === 'today') {
                    if (actionDate.toDateString() !== today.toDateString()) return false;
                } else if (actionsFilters.dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(today.getDate() - 7);
                    if (actionDate < weekAgo) return false;
                } else if (actionsFilters.dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(today.getMonth() - 1);
                    if (actionDate < monthAgo) return false;
                }

                // Search filter
                const actionText = action.action || action.details || '';
                if (actionsFilters.search && !actionText.toLowerCase().includes(actionsFilters.search)) {
                    return false;
                }

                return true;
            });
            
            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;
                
                switch(actionsSortBy) {
                    case 'timestamp':
                        aVal = new Date(a.timestamp);
                        bVal = new Date(b.timestamp);
                        break;
                    case 'user':
                        aVal = a.user || '';
                        bVal = b.user || '';
                        break;
                    case 'action':
                        aVal = a.actionType || '';
                        bVal = b.actionType || '';
                        break;
                    case 'section':
                        aVal = a.section || '';
                        bVal = b.section || '';
                        break;
                    default:
                        aVal = new Date(a.timestamp);
                        bVal = new Date(b.timestamp);
                }
                
                if (actionsSortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Paginate
            const perPage = 50;
            const startIndex = (currentActionsPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageActions = filtered.slice(startIndex, endIndex);
            const totalPages = Math.ceil(filtered.length / perPage) || 1;
            
            // Update table
            const tbody = document.getElementById('actionsLogTableBody');
            if (tbody) {
                if (pageActions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--gray);">No actions found</td></tr>';
                } else {
                    tbody.innerHTML = pageActions.map(action => {
                        const date = new Date(action.timestamp);
                        const actionText = action.action || action.details || '';
                        const sectionName = action.sectionName || action.section || '';

                        // Display user name or email, never just "Admin"
                        const displayUser = action.user || action.userEmail || 'Unknown';
                        const userRole = action.userRole || '';
                        const saveCount = action.changes || 1;

                        // Determine action type from text or use 'save' if changes > 1
                        let actionType = 'other';
                        if (actionText.toLowerCase().includes('created') || actionText.toLowerCase().includes('added')) {
                            actionType = 'create';
                        } else if (actionText.toLowerCase().includes('updated') || actionText.toLowerCase().includes('changed')) {
                            actionType = 'update';
                        } else if (actionText.toLowerCase().includes('deleted') || actionText.toLowerCase().includes('removed')) {
                            actionType = 'delete';
                        } else if (actionText.toLowerCase().includes('saved') || saveCount > 1) {
                            actionType = 'save';
                        }

                        const actionColor = {
                            create: '#28a745',
                            update: '#007bff',
                            delete: '#dc3545',
                            save: '#17a2b8'
                        }[actionType] || '#6c757d';

                        // Show role badge color
                        const roleColor = userRole === 'Super Admin' ? '#9c27b0' : userRole === 'Admin' ? '#ff5722' : '#607d8b';

                        return `
                            <tr style="border-bottom: 1px solid var(--gray-light);">
                                <td style="padding: 1rem;">
                                    <div>
                                        <div style="font-weight: 500;">${date.toLocaleDateString()}</div>
                                        <div style="font-size: 0.875rem; color: var(--gray);">${date.toLocaleTimeString()}</div>
                                    </div>
                                </td>
                                <td style="padding: 1rem; font-weight: 600;">${displayUser}</td>
                                <td style="padding: 1rem;">
                                    ${userRole ? `<span style="background: ${roleColor}20; color: ${roleColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                        ${userRole}
                                    </span>` : '-'}
                                </td>
                                <td style="padding: 1rem;">
                                    <span style="background: ${actionColor}20; color: ${actionColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                        ${actionType}
                                    </span>
                                </td>
                                <td style="padding: 1rem; color: var(--gray-dark);">${actionText}</td>
                                <td style="padding: 1rem;">
                                    <span style="background: var(--gray-lighter); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                        ${sectionName}
                                    </span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    ${saveCount > 1 ? `<span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 50%; font-size: 0.75rem; font-weight: 600; min-width: 24px; display: inline-block;">${saveCount}</span>` : '-'}
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            // Update count
            const countEl = document.getElementById('actionsCount');
            if (countEl) {
                countEl.textContent = `Showing ${pageActions.length} of ${filtered.length} actions`;
            }
            
            // Update pagination
            const pageInfo = document.getElementById('actionsPageInfo');
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentActionsPage} of ${totalPages}`;
            }
        }
        
        function sortActionsLog(field) {
            if (actionsSortBy === field) {
                actionsSortOrder = actionsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                actionsSortBy = field;
                actionsSortOrder = field === 'timestamp' ? 'desc' : 'asc';
            }
            
            // Update arrows
            ['timestamp', 'user', 'action', 'section'].forEach(f => {
                const arrow = document.getElementById(`sortArrowAction${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (arrow) {
                    if (f === field) {
                        arrow.textContent = actionsSortOrder === 'asc' ? '↑' : '↓';
                    } else {
                        arrow.textContent = '↕️';
                    }
                }
            });
            
            filterActionsLog();
        }
        
        function loadActionsPage(direction) {
            const actionsLog = NewcoData.get('actionsLog') || [];
            const totalPages = Math.ceil(actionsLog.length / 50) || 1;
            
            if (direction === 'prev' && currentActionsPage > 1) {
                currentActionsPage--;
            } else if (direction === 'next' && currentActionsPage < totalPages) {
                currentActionsPage++;
            }
            
            filterActionsLog();
        }
        
        function clearActionsLog() {
            if (confirm('Are you sure you want to clear all action logs? This cannot be undone.')) {
                NewcoData.set('actionsLog', [], true); // Skip logging this action
                loadActionsLog();
                showSuccess('Actions log cleared');
            }
        }
        
        function exportActionsLog() {
            const actionsLog = NewcoData.get('activityLog') || [];

            if (actionsLog.length === 0) {
                showModal({
                    title: '⚠️ No Data',
                    message: 'There are no actions to export yet.',
                    type: 'warning'
                });
                return;
            }

            const headers = ['Timestamp', 'User', 'Email', 'Role', 'Action', 'Section', 'Saves Count'];
            const csvContent = [
                headers.join(','),
                ...actionsLog.map(a => {
                    const actionText = (a.action || a.details || '').replace(/"/g, '""');
                    return [
                        new Date(a.timestamp).toISOString(),
                        `"${(a.user || 'Unknown').replace(/"/g, '""')}"`,
                        a.userEmail || '',
                        a.userRole || '',
                        `"${actionText}"`,
                        a.sectionName || a.section || '',
                        a.changes || 1
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `actions_log_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSuccess(`Exported ${actionsLog.length} actions to CSV`);
        }
        
        // Add drag start listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.drag-component').forEach(component => {
                component.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.component);
                });
            });
            
            // Initialize Start Here indicators
            initStartHereIndicators();
        });
        
        function addComponentToBuilder(componentType, yPosition) {
            const canvas = document.getElementById('builderCanvas');
            const placeholder = document.getElementById('canvasPlaceholder');
            
            // Hide placeholder
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            const componentId = Date.now().toString();
            const component = createBuilderComponent(componentType, componentId);
            
            // Store component data
            builderComponents.push({
                id: componentId,
                type: componentType,
                element: component
            });
            
            canvas.appendChild(component);
            selectBuilderComponent(componentId);
        }
        
        function createBuilderComponent(type, id) {
            const div = document.createElement('div');
            div.className = 'builder-component';
            div.dataset.componentId = id;
            div.style.cssText = `
                margin: 1rem 0;
                padding: 1rem;
                border: 2px solid transparent;
                border-radius: 8px;
                background: var(--gray-lighter);
                position: relative;
                cursor: pointer;
                transition: all 0.2s;
            `;
            
            div.onclick = () => selectBuilderComponent(id);
            
            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '✕';
            removeBtn.style.cssText = `
                position: absolute;
                top: -8px;
                right: -8px;
                width: 20px;
                height: 20px;
                border: none;
                border-radius: 50%;
                background: var(--danger);
                color: white;
                font-size: 12px;
                cursor: pointer;
                display: none;
            `;
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeBuilderComponent(id);
            };
            
            div.onmouseover = () => removeBtn.style.display = 'block';
            div.onmouseout = () => removeBtn.style.display = 'none';
            
            div.appendChild(removeBtn);
            
            // Component content
            const content = getBuilderComponentContent(type);
            div.innerHTML += content;
            
            return div;
        }
        
        function getBuilderComponentContent(type) {
            const templates = {
                header: `
                    <div style="text-align: center; padding: 2rem;">
                        <h1 style="font-size: 2.5rem; margin: 0 0 0.5rem; color: var(--primary);">Welcome to Bingo Night</h1>
                        <p style="font-size: 1.2rem; color: var(--gray); margin: 0;">Book your session and win big!</p>
                    </div>
                `,
                'session-selector': `
                    <div style="text-align: center; padding: 1.5rem;">
                        <h3 style="margin: 0 0 1rem;">Select Your Session</h3>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-outline">📅 Tonight 7PM</button>
                            <button class="btn btn-outline">📅 Saturday 2PM</button>
                            <button class="btn btn-primary">📅 Sunday 6PM</button>
                        </div>
                    </div>
                `,
                'package-cards': `
                    <div style="padding: 1.5rem;">
                        <h3 style="text-align: center; margin: 0 0 1.5rem;">Choose Your Package</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 0.5rem;">Basic Package</h4>
                                <p style="color: var(--gray); margin: 0 0 1rem;">6 cards, daubers included</p>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">$15</div>
                            </div>
                            <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid var(--primary);">
                                <h4 style="margin: 0 0 0.5rem;">Premium Package</h4>
                                <p style="color: var(--gray); margin: 0 0 1rem;">12 cards, snacks, drinks</p>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">$25</div>
                            </div>
                        </div>
                    </div>
                `,
                'seat-selector': `
                    <div style="text-align: center; padding: 1.5rem;">
                        <h3 style="margin: 0 0 1rem;">Select Your Seats</h3>
                        <div style="background: white; border-radius: 8px; padding: 1rem; display: inline-block;">
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                                ${Array(12).fill().map((_, i) => 
                                    `<div style="width: 30px; height: 30px; border-radius: 4px; background: ${i < 3 ? 'var(--success)' : 'var(--gray-light)'}; cursor: pointer;"></div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `,
                pricing: `
                    <div style="background: white; border-radius: 8px; padding: 2rem; margin: 1rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span>Premium Package</span>
                            <span style="font-weight: bold;">$25.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: var(--gray);">
                            <span>Processing Fee</span>
                            <span>$2.50</span>
                        </div>
                        <div style="border-top: 1px solid var(--gray-light); padding-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.2rem; font-weight: bold;">Total</span>
                            <span style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">$27.50</span>
                        </div>
                    </div>
                `,
                checkout: `
                    <div style="background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1.5rem;">Complete Your Booking</h3>
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" placeholder="Enter your name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" placeholder="Enter your email">
                        </div>
                        <button class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                            Complete Booking - $27.50
                        </button>
                    </div>
                `,
                text: `
                    <div style="padding: 1rem;">
                        <h3 style="margin: 0 0 1rem;">Your Custom Text</h3>
                        <p style="color: var(--gray); line-height: 1.6;">
                            Add your custom text here. You can include information about your bingo hall, 
                            special promotions, rules, or any other content you'd like your visitors to see.
                        </p>
                    </div>
                `,
                image: `
                    <div style="text-align: center; padding: 2rem; background: var(--gray-lighter);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🖼️</div>
                        <h4 style="margin: 0 0 0.5rem;">Image Placeholder</h4>
                        <p style="color: var(--gray); margin: 0;">Click to upload an image</p>
                    </div>
                `,
                divider: `
                    <div style="padding: 2rem 0;">
                        <hr style="border: none; height: 2px; background: linear-gradient(to right, transparent, var(--primary), transparent);">
                    </div>
                `
            };
            
            return templates[type] || '<p>Unknown component</p>';
        }
        
        function selectBuilderComponent(componentId) {
            // Remove previous selection
            document.querySelectorAll('.builder-component').forEach(comp => {
                comp.style.border = '2px solid transparent';
            });
            
            // Select new component
            const component = document.querySelector(`[data-component-id="${componentId}"]`);
            if (component) {
                component.style.border = '2px solid var(--primary)';
                selectedBuilderComponent = componentId;
                showComponentProperties(componentId);
            }
        }
        
        function showComponentProperties(componentId) {
            const component = builderComponents.find(c => c.id === componentId);
            const panel = document.getElementById('builderPropertyPanel');
            
            if (!component || !panel) return;
            
            const properties = getComponentProperties(component.type);
            panel.innerHTML = properties;
        }
        
        function getComponentProperties(type) {
            const properties = {
                header: `
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" value="Welcome to Bingo Night" onchange="updateComponentProperty('title', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subtitle</label>
                        <input type="text" class="form-input" value="Book your session and win big!" onchange="updateComponentProperty('subtitle', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Text Align</label>
                        <select class="form-select" onchange="updateComponentProperty('align', this.value)">
                            <option value="center" selected>Center</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                `,
                text: `
                    <div class="form-group">
                        <label class="form-label">Heading</label>
                        <input type="text" class="form-input" value="Your Custom Text" onchange="updateComponentProperty('heading', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Content</label>
                        <textarea class="form-input" rows="4" onchange="updateComponentProperty('content', this.value)">Add your custom text here...</textarea>
                    </div>
                `,
                image: `
                    <div class="form-group">
                        <label class="form-label">Image Source</label>
                        <input type="file" class="form-input" accept="image/*" onchange="updateComponentProperty('image', this.files[0])">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Alt Text</label>
                        <input type="text" class="form-input" placeholder="Description of image" onchange="updateComponentProperty('alt', this.value)">
                    </div>
                `
            };
            
            return properties[type] || '<p style="color: var(--gray); font-size: 0.875rem;">No properties available for this component.</p>';
        }
        
        function updateComponentProperty(property, value) {
            if (!selectedBuilderComponent) return;
            
            const component = document.querySelector(`[data-component-id="${selectedBuilderComponent}"]`);
            if (component) {
                // Update component based on property
                // This would be expanded in a real implementation
                console.log(`Updating ${property} to ${value}`);
            }
        }
        
        function removeBuilderComponent(componentId) {
            const component = document.querySelector(`[data-component-id="${componentId}"]`);
            if (component) {
                component.remove();
                builderComponents = builderComponents.filter(c => c.id !== componentId);
                
                // Show placeholder if no components left
                if (builderComponents.length === 0) {
                    document.getElementById('canvasPlaceholder').style.display = 'block';
                }
                
                // Clear properties panel
                document.getElementById('builderPropertyPanel').innerHTML = `
                    <p style="color: var(--gray); font-size: 0.875rem;">
                        Select a component to edit its properties
                    </p>
                `;
            }
        }
        
        function previewBuiltPage() {
            const canvas = document.getElementById('builderCanvas');
            const content = canvas.innerHTML;
            
            const previewWindow = window.open('', 'builderPreview', 'width=1200,height=800');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Page Builder Preview</title>
                    <style>
                        body { 
                            font-family: Inter, sans-serif; 
                            margin: 0; 
                            padding: 0;
                            background: #f5f5f5;
                        }
                        .builder-component { 
                            margin: 0; 
                            background: white;
                        }
                        .builder-component:hover { border: none !important; }
                        button { display: none; }
                        :root {
                            --primary: #3b82f6;
                            --success: #10b981;
                            --gray: #6b7280;
                            --gray-light: #d1d5db;
                            --gray-lighter: #f9fafb;
                        }
                        .btn {
                            padding: 0.5rem 1rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            background: white;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
                        .btn-outline { background: transparent; color: var(--primary); border-color: var(--primary); }
                        .form-input, .form-select {
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 1rem;
                        }
                        .form-label {
                            display: block;
                            margin-bottom: 0.5rem;
                            font-weight: 600;
                        }
                        .form-group {
                            margin-bottom: 1rem;
                        }
                    </style>
                </head>
                <body>
                    ${content.replace(/<button[^>]*class="[^"]*remove[^"]*"[^>]*>.*?<\/button>/g, '')}
                </body>
                </html>
            `);
        }
        
        function exportBuiltPage() {
            const canvas = document.getElementById('builderCanvas');
            const components = canvas.querySelectorAll('.builder-component');
            
            let html = generateBuiltPageHTML(components);
            
            // Download as HTML file
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'custom-booking-page.html';
            a.click();
            
            URL.revokeObjectURL(url);
            
            showModal({
                title: '📥 Export Complete',
                message: 'Your custom booking page has been exported as an HTML file.',
                type: 'success'
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // START HERE INDICATOR FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function initStartHereIndicators() {
            const clickedIndicators = NewcoData.get('clickedStartHereIndicators') || [];
            
            // Add click listeners to all nav items with Start Here indicators
            document.querySelectorAll('.nav-item').forEach(navItem => {
                const indicator = navItem.querySelector('.start-here-indicator');
                if (indicator) {
                    const section = navItem.getAttribute('data-section');
                    
                    // Hide if already clicked
                    if (clickedIndicators.includes(section)) {
                        indicator.style.display = 'none';
                    }
                    
                    // Add click listener
                    navItem.addEventListener('click', function() {
                        if (!clickedIndicators.includes(section)) {
                            indicator.classList.add('clicked');
                            clickedIndicators.push(section);
                            NewcoData.set('clickedStartHereIndicators', clickedIndicators);
                            
                            // Remove after animation
                            setTimeout(() => {
                                indicator.style.display = 'none';
                            }, 500);
                        }
                    });
                }
            });
        }

        function generateBuiltPageHTML(components) {
            return '<html><head><title>Booking Page</title></head><body><h1>Booking Page</h1></body></html>';
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // SOCIAL MEDIA FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        // Social Media Functions
        function refreshSocialStats() {
            showModal({
                title: '🔄 Refreshing Stats',
                message: 'Fetching latest Twitter analytics data...',
                type: 'info'
            });
            
            // Simulate refresh with new random data
            setTimeout(() => {
                document.getElementById('twitterTotalPosts').textContent = Math.floor(Math.random() * 50 + 230);
                document.getElementById('twitterAvgEngagement').textContent = (Math.random() * 2 + 3.5).toFixed(1) + '%';
                document.getElementById('twitterImpressions').textContent = (Math.random() * 20 + 45).toFixed(1) + 'K';
                document.getElementById('twitterNewFollowers').textContent = Math.floor(Math.random() * 50 + 150);
                
                showModal({
                    title: '✅ Stats Updated',
                    message: 'Twitter analytics have been refreshed with the latest data.',
                    type: 'success'
                });
            }, 1500);
        }

        function schedulePost() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            
            modalTitle.textContent = '📅 Schedule Social Media Post';
            modalBody.innerHTML = `
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Platform</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" checked> 
                                <span style="color: #1DA1F2;">🐦 Twitter</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox"> 
                                <span style="color: #1877f2;">📘 Facebook</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox"> 
                                <span style="color: #E4405F;">📷 Instagram</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Schedule Date</label>
                        <input type="date" class="form-input" id="postDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Schedule Time</label>
                        <input type="time" class="form-input" id="postTime" value="10:00">
                    </div>
                    
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Post Content</label>
                        <textarea class="form-input" id="postContent" rows="4" placeholder="What's happening at the bingo hall?" style="resize: vertical;"></textarea>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                            <span>Character count: <span id="charCount">0</span>/280</span>
                            <span>Add: 📷 🎥 📊 🔗</span>
                        </div>
                    </div>
                    
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Add Promotion</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="form-select" id="postPromotion" style="flex: 1;">
                                <option value="">No promotion</option>
                                <option value="promo1">🎉 Friday Night Special - 20% off all packages</option>
                                <option value="promo2">🎂 Birthday Month - Free dauber set</option>
                                <option value="promo3">💰 Mega Jackpot - $10,000 prize pool</option>
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="insertPromotion()">
                                Insert
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label class="form-label">Hashtags</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="postHashtags" placeholder="#bingo #jackpot #winners" value="${NewcoData.get('socialHashtags')?.default || '#bingo #vanguardbingo'}" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="applyHashtagPreset('default')">Default</button>
                            <button type="button" class="btn btn-secondary" onclick="applyHashtagPreset('promotion')">Promo</button>
                            <button type="button" class="btn btn-secondary" onclick="applyHashtagPreset('event')">Event</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Character counter
            const contentField = document.getElementById('postContent');
            const charCount = document.getElementById('charCount');
            contentField.addEventListener('input', () => {
                charCount.textContent = contentField.value.length;
                charCount.style.color = contentField.value.length > 280 ? 'var(--danger)' : 'var(--gray)';
            });
            
            modalSaveBtn.textContent = 'Schedule Post';
            modalSaveBtn.onclick = () => {
                const content = document.getElementById('postContent').value;
                const date = document.getElementById('postDate').value;
                const time = document.getElementById('postTime').value;
                
                if (!content) {
                    showModal({
                        title: '⚠️ Missing Content',
                        message: 'Please enter post content before scheduling.',
                        type: 'warning'
                    });
                    return;
                }
                
                // Save scheduled post
                const scheduledPosts = NewcoData.get('scheduledPosts') || [];
                scheduledPosts.push({
                    id: Date.now().toString(),
                    content: content,
                    date: date,
                    time: time,
                    platforms: ['twitter'],
                    status: 'scheduled'
                });
                NewcoData.set('scheduledPosts', scheduledPosts);
                
                closeModal();
                showModal({
                    title: '✅ Post Scheduled',
                    message: `Your post has been scheduled for ${date} at ${time}.`,
                    type: 'success'
                });
                
                // Refresh scheduled posts display
                loadScheduledPosts();
            };
            
            modal.classList.add('active');
        }

        function addScheduledPost() {
            schedulePost();
        }

        function editScheduledPost(id) {
            showModal({
                title: '✏️ Edit Scheduled Post',
                message: 'Edit functionality would open the post editor with existing content.',
                type: 'info'
            });
        }

        function deleteScheduledPost(id) {
            showModal({
                type: 'confirm',
                title: '🗑️ Delete Scheduled Post',
                message: 'Are you sure you want to delete this scheduled post?',
                confirmText: 'Delete',
                cancelText: 'Cancel',
                onConfirm: () => {
                    showModal({
                        title: '✅ Post Deleted',
                        message: 'The scheduled post has been removed.',
                        type: 'success'
                    });
                }
            });
        }

        function updateTwitterTimeframe(days) {
            // Update stats based on timeframe
            refreshSocialStats();
        }

        function updateTopPostsTimeframe(period) {
            // Update top posts based on period
            showModal({
                title: '📊 Updating Top Posts',
                message: `Loading top performing posts for: ${period}`,
                type: 'info'
            });
        }

        function exportTwitterHistory() {
            showModal({
                title: '📥 Export Twitter History',
                message: 'Your Twitter post history has been exported to CSV format.',
                type: 'success'
            });
        }

        function loadScheduledPosts() {
            const scheduledPosts = NewcoData.get('scheduledPosts') || [];
            // Update the scheduled posts display
            // This would refresh the scheduledPostsContainer with latest data
        }
        
        function saveHashtags() {
            const hashtags = {
                default: document.getElementById('defaultHashtags').value,
                promotion: document.getElementById('promotionHashtags').value,
                event: document.getElementById('eventHashtags').value
            };
            NewcoData.set('socialHashtags', hashtags);
            showModal({
                title: '✅ Hashtags Saved',
                message: 'Your hashtag presets have been saved.',
                type: 'success'
            });
        }
        
        function applyHashtagPreset(type) {
            const hashtags = NewcoData.get('socialHashtags') || {
                default: '#bingo #vanguardbingo',
                promotion: '#special #promotion',
                event: '#jackpot #tournament'
            };
            
            const hashtagField = document.getElementById('postHashtags');
            if (hashtagField) {
                const currentTags = hashtagField.value;
                const newTags = hashtags[type] || '';
                
                // Add to existing tags if not already present
                const combinedTags = [...new Set([...currentTags.split(' '), ...newTags.split(' ')])].join(' ');
                hashtagField.value = combinedTags;
            }
        }
        
        function insertPromotion() {
            const promotionSelect = document.getElementById('postPromotion');
            const contentField = document.getElementById('postContent');
            
            if (promotionSelect && contentField && promotionSelect.value) {
                // Get promotion text
                const selectedOption = promotionSelect.options[promotionSelect.selectedIndex];
                const promotionText = selectedOption.text.replace(/^[^\s]+ /, ''); // Remove emoji
                
                // Add to content
                if (contentField.value) {
                    contentField.value += '\n\n🎊 ' + promotionText;
                } else {
                    contentField.value = '🎊 ' + promotionText;
                }
                
                // Update character count
                const charCount = document.getElementById('charCount');
                if (charCount) {
                    charCount.textContent = contentField.value.length;
                    charCount.style.color = contentField.value.length > 280 ? 'var(--danger)' : 'var(--gray)';
                }
                
                // Add promotion hashtags
                applyHashtagPreset('promotion');
                
                // Reset selection
                promotionSelect.value = '';
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // UNIFIED NOTIFICATION SYSTEM - Beautiful modals and toasts
        // ═══════════════════════════════════════════════════════════════════
        
        const notify = (function() {
            let stylesInitialized = false;
            
            function initStyles() {
                if (stylesInitialized) return;
                stylesInitialized = true;
                
                const styles = `
                    /* Modal Styles */
                    .notify-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.6);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: notifyFadeIn 0.2s ease-out;
                        backdrop-filter: blur(4px);
                    }
                    
                    .notify-modal {
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        max-width: 500px;
                        width: 90%;
                        max-height: 90vh;
                        overflow: hidden;
                        animation: notifySlideUp 0.3s ease-out;
                    }
                    
                    .notify-modal-header {
                        padding: 1.5rem;
                        border-bottom: 1px solid #e5e7eb;
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                    }
                    
                    .notify-modal-icon {
                        width: 24px;
                        height: 24px;
                        flex-shrink: 0;
                    }
                    
                    .notify-modal-title {
                        font-size: 1.25rem;
                        font-weight: 600;
                        color: #111827;
                        margin: 0;
                        flex: 1;
                    }
                    
                    .notify-modal-close {
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        color: #6b7280;
                        cursor: pointer;
                        padding: 0;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 6px;
                        transition: all 0.2s;
                    }
                    
                    .notify-modal-close:hover {
                        background: #f3f4f6;
                        color: #111827;
                    }
                    
                    .notify-modal-body {
                        padding: 1.5rem;
                        color: #4b5563;
                        line-height: 1.6;
                        max-height: 60vh;
                        overflow-y: auto;
                    }
                    
                    .notify-modal-footer {
                        padding: 1rem 1.5rem;
                        border-top: 1px solid #e5e7eb;
                        display: flex;
                        gap: 0.75rem;
                        justify-content: flex-end;
                    }
                    
                    .notify-btn {
                        padding: 0.625rem 1.25rem;
                        border-radius: 8px;
                        font-size: 0.875rem;
                        font-weight: 500;
                        border: none;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-family: inherit;
                    }
                    
                    .notify-btn-primary {
                        background: #2ea3f2;
                        color: white;
                    }
                    
                    .notify-btn-primary:hover {
                        background: #1e8ed8;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(46, 163, 242, 0.3);
                    }
                    
                    .notify-btn-secondary {
                        background: #f3f4f6;
                        color: #4b5563;
                    }
                    
                    .notify-btn-secondary:hover {
                        background: #e5e7eb;
                    }
                    
                    .notify-btn-danger {
                        background: #ef4444;
                        color: white;
                    }
                    
                    .notify-btn-danger:hover {
                        background: #dc2626;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                    }
                    
                    /* Toast Styles */
                    .notify-toast-container {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10001;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        pointer-events: none;
                    }
                    
                    .notify-toast {
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
                        padding: 1rem 1.25rem;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        min-width: 320px;
                        max-width: 420px;
                        animation: notifySlideIn 0.3s ease-out;
                        pointer-events: all;
                        border-left: 4px solid;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    
                    .notify-toast:hover {
                        transform: translateX(-5px);
                        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.18);
                    }
                    
                    .notify-toast.removing {
                        animation: notifySlideOut 0.3s ease-in;
                    }
                    
                    .notify-toast-success {
                        border-left-color: #10b981;
                    }
                    
                    .notify-toast-error {
                        border-left-color: #ef4444;
                    }
                    
                    .notify-toast-warning {
                        border-left-color: #f59e0b;
                    }
                    
                    .notify-toast-info {
                        border-left-color: #3b82f6;
                    }
                    
                    .notify-toast-icon {
                        width: 20px;
                        height: 20px;
                        flex-shrink: 0;
                    }
                    
                    .notify-toast-content {
                        flex: 1;
                    }
                    
                    .notify-toast-title {
                        font-weight: 600;
                        color: #111827;
                        margin-bottom: 0.125rem;
                        font-size: 0.95rem;
                    }
                    
                    .notify-toast-message {
                        color: #6b7280;
                        font-size: 0.875rem;
                        line-height: 1.4;
                    }
                    
                    .notify-toast-close {
                        width: 20px;
                        height: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #9ca3af;
                        cursor: pointer;
                        border-radius: 4px;
                        transition: all 0.2s;
                        flex-shrink: 0;
                    }
                    
                    .notify-toast-close:hover {
                        background: #f3f4f6;
                        color: #4b5563;
                    }
                    
                    /* Icons */
                    .notify-icon-success {
                        color: #10b981;
                    }
                    
                    .notify-icon-error {
                        color: #ef4444;
                    }
                    
                    .notify-icon-warning {
                        color: #f59e0b;
                    }
                    
                    .notify-icon-info {
                        color: #3b82f6;
                    }
                    
                    /* Animations */
                    @keyframes notifyFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes notifySlideUp {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    
                    @keyframes notifySlideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    @keyframes notifySlideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                    
                    /* Responsive */
                    @media (max-width: 640px) {
                        .notify-toast-container {
                            left: 10px;
                            right: 10px;
                            top: 10px;
                        }
                        
                        .notify-toast {
                            min-width: auto;
                            max-width: 100%;
                        }
                        
                        .notify-modal {
                            width: 95%;
                            margin: 1rem;
                        }
                    }
                `;
                
                const styleSheet = document.createElement('style');
                styleSheet.textContent = styles;
                document.head.appendChild(styleSheet);
            }
            
            // Icons as SVG strings
            const icons = {
                success: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
                error: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>',
                warning: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
                info: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>',
                close: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>'
            };
            
            let toastContainer = null;
            
            function getToastContainer() {
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'notify-toast-container';
                    document.body.appendChild(toastContainer);
                }
                return toastContainer;
            }
            
            function showToast(type, message, title = null, duration = 4000) {
                initStyles();
                
                const toast = document.createElement('div');
                toast.className = `notify-toast notify-toast-${type}`;
                
                const iconClass = `notify-icon-${type}`;
                const defaultTitles = {
                    success: 'Success',
                    error: 'Error',
                    warning: 'Warning',
                    info: 'Info'
                };
                
                toast.innerHTML = `
                    <div class="notify-toast-icon ${iconClass}">
                        ${icons[type]}
                    </div>
                    <div class="notify-toast-content">
                        ${title || defaultTitles[type] ? `<div class="notify-toast-title">${title || defaultTitles[type]}</div>` : ''}
                        <div class="notify-toast-message">${message}</div>
                    </div>
                    <div class="notify-toast-close">
                        ${icons.close}
                    </div>
                `;
                
                const container = getToastContainer();
                container.appendChild(toast);
                
                let removeTimeout;
                const removeToast = () => {
                    toast.classList.add('removing');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                };
                
                removeTimeout = setTimeout(removeToast, duration);
                
                toast.addEventListener('click', () => {
                    clearTimeout(removeTimeout);
                    removeToast();
                });
                
                return toast;
            }
            
            function showModal(options) {
                initStyles();
                
                const overlay = document.createElement('div');
                overlay.className = 'notify-overlay';
                
                const modal = document.createElement('div');
                modal.className = 'notify-modal';
                
                let modalHTML = '';
                
                if (options.title) {
                    const iconHTML = options.icon ? `
                        <div class="notify-modal-icon notify-icon-${options.type || 'info'}">
                            ${icons[options.type] || icons.info}
                        </div>
                    ` : '';
                    
                    modalHTML += `
                        <div class="notify-modal-header">
                            ${iconHTML}
                            <h2 class="notify-modal-title">${options.title}</h2>
                            ${options.closeButton !== false ? `
                                <button class="notify-modal-close">
                                    ${icons.close}
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                modalHTML += `
                    <div class="notify-modal-body">
                        ${options.content || options.message || ''}
                    </div>
                `;
                
                if (options.buttons || options.onConfirm) {
                    modalHTML += '<div class="notify-modal-footer">';
                    
                    if (options.buttons) {
                        options.buttons.forEach(button => {
                            modalHTML += `
                                <button class="notify-btn notify-btn-${button.type || 'secondary'}" 
                                        data-action="${button.action}">
                                    ${button.text}
                                </button>
                            `;
                        });
                    } else if (options.onConfirm) {
                        modalHTML += `
                            <button class="notify-btn notify-btn-secondary" data-action="cancel">
                                ${options.cancelText || 'Cancel'}
                            </button>
                            <button class="notify-btn notify-btn-${options.confirmType || 'primary'}" data-action="confirm">
                                ${options.confirmText || 'Confirm'}
                            </button>
                        `;
                    }
                    
                    modalHTML += '</div>';
                }
                
                modal.innerHTML = modalHTML;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                const closeModal = () => {
                    overlay.style.animation = 'notifyFadeIn 0.2s ease-out reverse';
                    modal.style.animation = 'notifySlideUp 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 200);
                };
                
                const closeBtn = modal.querySelector('.notify-modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeModal);
                }
                
                modal.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        
                        if (action === 'cancel') {
                            if (options.onCancel) options.onCancel();
                            closeModal();
                        } else if (action === 'confirm') {
                            if (options.onConfirm) options.onConfirm();
                            closeModal();
                        } else if (options.buttons) {
                            const button = options.buttons.find(b => b.action === action);
                            if (button && button.handler) {
                                button.handler();
                            }
                            if (button && button.close !== false) {
                                closeModal();
                            }
                        }
                    });
                });
                
                if (options.closeOnOverlay !== false) {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            closeModal();
                        }
                    });
                }
                
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                return { overlay, modal, close: closeModal };
            }
            
            return {
                success(message, title) {
                    return showToast('success', message, title);
                },
                
                error(message, title) {
                    return showToast('error', message, title);
                },
                
                warning(message, title) {
                    return showToast('warning', message, title);
                },
                
                info(message, title) {
                    return showToast('info', message, title);
                },
                
                toast(type, message, title, duration) {
                    return showToast(type, message, title, duration);
                },
                
                modal(options) {
                    return showModal(options);
                },
                
                confirm(message, onConfirm, onCancel, options = {}) {
                    return showModal({
                        title: options.title || 'Confirm',
                        message,
                        type: 'warning',
                        icon: true,
                        onConfirm,
                        onCancel,
                        confirmText: options.confirmText,
                        cancelText: options.cancelText,
                        confirmType: options.dangerous ? 'danger' : 'primary'
                    });
                },
                
                alert(message, title = 'Alert', type = 'info') {
                    return showModal({
                        title,
                        message,
                        type,
                        icon: true,
                        buttons: [
                            { text: 'OK', type: 'primary', action: 'ok' }
                        ]
                    });
                }
            };
        })();
        
        // Replace old notification functions with new ones
        window.showSuccess = (msg) => notify.success(msg);
        window.showError = (msg) => notify.error(msg);
        window.showWarning = (msg) => notify.warning(msg);
        window.showInfo = (msg) => notify.info(msg);
        window.showAlert = (msg, type) => {
            if (type === 'success') notify.success(msg);
            else if (type === 'error') notify.error(msg);
            else if (type === 'warning') notify.warning(msg);
            else notify.info(msg);
        };
        
        // Update showConfirm to use new system but keep compatibility
        const oldShowConfirm = window.showConfirm;
        window.showConfirm = (msg, onYes, title) => {
            notify.confirm(msg, onYes, null, { title });
        };

        // ═══════════════════════════════════════════════════════════
        // [ADMIN-AUTH] - Password Protection
        // ═══════════════════════════════════════════════════════════

        async function checkAdminPassword(event) {
            event.preventDefault();

            const email = document.getElementById('adminEmailInput').value.trim().toLowerCase();
            const password = document.getElementById('adminPasswordInput').value;
            const customerId = NewcoData.get('customerId') || new URLSearchParams(window.location.search).get('customer');

            // Get admin users object (stores passwords per email)
            const adminUsers = NewcoData.get('adminUsers') || {};

            let isValidPassword = false;
            let isSuperAdmin = false;
            let isFirstLogin = false;
            let superAdminEmail = null;

            // Check Master Portal admin credentials first (NewCo employees)
            // Master Portal stores admins in 'staff' array with role 'master-admin'
            const allStaff = NewcoData.get('staff') || [];
            const masterAdmin = allStaff.find(s => s.email && s.email.toLowerCase() === email && s.role === 'master-admin');

            if (masterAdmin) {
                // Check password - first try adminUsers object, then user's password property
                const storedPassword = adminUsers[email] || masterAdmin.password;
                if (storedPassword && password === storedPassword) {
                    isValidPassword = true;
                    isSuperAdmin = true; // Grant super admin access to all client portals
                }
            }

            // Check Super Admin from Supabase
            try {
                const accountResponse = await fetch(
                    `${NewcoData.supabaseUrl}/rest/v1/accounts?customer_id=eq.${customerId}&select=email,organization_name,password_hash`,
                    {
                        headers: {
                            'apikey': NewcoData.supabaseKey,
                            'Authorization': `Bearer ${NewcoData.supabaseKey}`
                        }
                    }
                );
                const accounts = await accountResponse.json();

                if (accounts && accounts.length > 0) {
                    superAdminEmail = accounts[0].email.toLowerCase();
                    const passwordHash = accounts[0].password_hash;

                    // Check if this is the super admin logging in
                    if (email === superAdminEmail) {
                        isSuperAdmin = true;

                        // Check password from Supabase first (set during account creation)
                        if (passwordHash) {
                            const enteredPasswordHash = btoa(password);
                            if (enteredPasswordHash === passwordHash) {
                                isValidPassword = true;
                            }
                        }
                        // Check if super admin has set a password in localStorage
                        else if (adminUsers[email]) {
                            // Use their custom password
                            if (password === adminUsers[email]) {
                                isValidPassword = true;
                            }
                        } else {
                            // First login: email as password (case-insensitive)
                            if (password.toLowerCase() === superAdminEmail) {
                                isValidPassword = true;
                                isFirstLogin = true;
                            }
                        }
                    }
                }
            } catch (err) {
                console.error('Error checking super admin:', err);
            }

            // If not super admin, check if they're in the staff list
            if (!isSuperAdmin) {
                const staff = NewcoData.get('staff') || [];
                console.log('DEBUG: Checking staff list. Total staff:', staff.length);
                console.log('DEBUG: Looking for email:', email);
                console.log('DEBUG: Staff full objects:', staff);
                console.log('DEBUG: Staff emails:', staff.map(s => s.email));

                const staffMember = staff.find(s => s.email && s.email.toLowerCase() === email);

                if (staffMember) {
                    console.log('DEBUG: Found staff member:', staffMember.name);
                    console.log('DEBUG: adminUsers:', adminUsers);
                    console.log('DEBUG: Has custom password?', !!adminUsers[email]);

                    // Check if staff member has set a password
                    if (adminUsers[email]) {
                        // Use their custom password
                        if (password === adminUsers[email]) {
                            isValidPassword = true;
                        }
                    } else {
                        // First login: email as password (case-insensitive)
                        console.log('DEBUG: Checking first login. Password entered:', password);
                        console.log('DEBUG: Email to match:', email);
                        if (password.toLowerCase() === email) {
                            isValidPassword = true;
                            isFirstLogin = true;
                        }
                    }
                } else {
                    console.log('DEBUG: Staff member NOT found in staff list');
                }
            }

            if (isValidPassword) {
                // Store auth session
                sessionStorage.setItem('newco_admin_authenticated', 'true');
                sessionStorage.setItem('newco_admin_email', email);

                // Update last_login timestamp in Supabase if this is the super admin
                if (isSuperAdmin) {
                    try {
                        await fetch(
                            `${NewcoData.supabaseUrl}/rest/v1/accounts?customer_id=eq.${customerId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': NewcoData.supabaseKey,
                                    'Authorization': `Bearer ${NewcoData.supabaseKey}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify({ last_login: new Date().toISOString() })
                            }
                        );
                    } catch (err) {
                        console.error('Error updating last login:', err);
                    }
                }

                // Update user info display in top bar
                const staff = NewcoData.get('staff') || [];
                const staffMember = staff.find(s => s.email && s.email.toLowerCase() === email);

                let displayName = 'Admin';
                let displayRole = 'Super Admin';
                let initials = 'A';

                if (isSuperAdmin) {
                    // Super admin - use email if no name available
                    displayRole = 'Super Admin';
                    displayName = email.split('@')[0];
                    initials = displayName.substring(0, 2).toUpperCase();
                    sessionStorage.setItem('newco_is_super_admin', 'true');
                    sessionStorage.setItem('newco_admin_role', 'Super Admin');
                } else if (staffMember) {
                    // Staff member - use name if available, otherwise email
                    displayName = staffMember.name || email.split('@')[0];
                    displayRole = staffMember.role || 'Staff';
                    initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    sessionStorage.setItem('newco_is_super_admin', 'false');
                    sessionStorage.setItem('newco_admin_role', displayRole);
                }

                // If first login, prompt for password change
                if (isFirstLogin) {
                    showPasswordChangeModal(email);
                } else {
                    // Hide login, show admin panel
                    document.getElementById('adminLoginScreen').style.display = 'none';
                    document.getElementById('adminMainPanel').style.display = 'flex';

                    // Load dashboard data
                    setTimeout(() => loadDashboard(), 100);
                }

                return false;
            } else {
                // Show error
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'Invalid email or password. Please try again.';
                errorDiv.style.display = 'block';

                // Clear password field
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();

                return false;
            }
        }

        function showPasswordChangeModal(userEmail) {
            // Hide login screen
            document.getElementById('adminLoginScreen').style.display = 'none';

            // Create password change modal
            const modal = document.createElement('div');
            modal.id = 'passwordChangeModal';
            modal.style.cssText = 'display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;';

            modal.innerHTML = `
                <div style="background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 100%;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🔐</div>
                        <h1 style="margin: 0; font-size: 1.75rem; color: #1f2937;">Set Your Admin Password</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #6b7280;">This is your first login. Please set a secure password.</p>
                    </div>
                    <form id="passwordChangeForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">New Password</label>
                            <input
                                type="password"
                                id="newPassword"
                                placeholder="Enter new password"
                                style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-light); border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                                required
                                autofocus
                                minlength="8"
                            >
                            <small style="color: #6b7280; font-size: 0.75rem;">Minimum 8 characters</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Confirm Password</label>
                            <input
                                type="password"
                                id="confirmPassword"
                                placeholder="Confirm new password"
                                style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-light); border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                                required
                                minlength="8"
                            >
                        </div>
                        <div id="passwordChangeError" style="color: #dc2626; font-size: 0.875rem; text-align: center; display: none;"></div>
                        <button
                            type="submit"
                            style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 0.875rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                            onmouseover="this.style.transform='translateY(-2px)'"
                            onmouseout="this.style.transform='translateY(0)'"
                        >
                            Set Password
                        </button>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('passwordChangeForm').onsubmit = function(e) {
                e.preventDefault();

                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const errorDiv = document.getElementById('passwordChangeError');

                if (newPassword.length < 8) {
                    errorDiv.textContent = 'Password must be at least 8 characters.';
                    errorDiv.style.display = 'block';
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'Passwords do not match.';
                    errorDiv.style.display = 'block';
                    return false;
                }

                // Save new password for this specific user
                const adminUsers = NewcoData.get('adminUsers') || {};
                adminUsers[userEmail] = newPassword;
                NewcoData.set('adminUsers', adminUsers);

                // Remove modal
                modal.remove();

                // Show admin panel
                document.getElementById('adminMainPanel').style.display = 'flex';

                // Load dashboard data
                setTimeout(() => loadDashboard(), 100);

                // Show success notification
                if (window.notify) {
                    notify.success('Password successfully set!');
                }

                return false;
            };
        }

        // Check if already authenticated and load organization name
        window.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = sessionStorage.getItem('newco_admin_authenticated');
            const customerId = NewcoData.get('customerId') || new URLSearchParams(window.location.search).get('customer');

            // Load and display organization name
            try {
                const accountResponse = await fetch(
                    `${NewcoData.supabaseUrl}/rest/v1/accounts?customer_id=eq.${customerId}&select=organization_name`,
                    {
                        headers: {
                            'apikey': NewcoData.supabaseKey,
                            'Authorization': `Bearer ${NewcoData.supabaseKey}`
                        }
                    }
                );
                const accounts = await accountResponse.json();

                if (accounts && accounts.length > 0 && accounts[0].organization_name) {
                    document.getElementById('orgNameDisplay').textContent = accounts[0].organization_name;
                } else {
                    document.getElementById('orgNameDisplay').textContent = 'Admin Portal';
                }
            } catch (err) {
                document.getElementById('orgNameDisplay').textContent = 'Admin Portal';
            }

            if (isAuthenticated === 'true') {
                // Already logged in
                document.getElementById('adminLoginScreen').style.display = 'none';
                document.getElementById('adminMainPanel').style.display = 'flex';

                // Load dashboard data on initial page load - wait for NewcoData to be ready
                const waitForData = setInterval(async () => {
                    // Check if organization data has been loaded
                    const testData = NewcoData.get('organization');
                    if (testData && testData.name) {
                        clearInterval(waitForData);
                        await applyBrandingColors();
                        loadDashboard();
                    }
                }, 50);
            } else {
                // Check if any users have passwords set
                const adminUsers = NewcoData.get('adminUsers') || {};
                const hasAnyPasswords = Object.keys(adminUsers).length > 0;

                if (!hasAnyPasswords) {
                    // No passwords set yet - show first-time hint
                    document.getElementById('firstTimeHint').style.display = 'block';
                    document.getElementById('passwordHint').style.display = 'block';
                }
            }
        });

        // Add logout function
        window.logoutAdmin = function() {
            sessionStorage.removeItem('newco_admin_authenticated');
            document.getElementById('adminLoginScreen').style.display = 'flex';
            document.getElementById('adminMainPanel').style.display = 'none';
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        };

        // ═══════════════════════════════════════════════════════════════════
        // INTEGRATIONS FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════

        // Show/hide Important badge on Integrations nav
        function dismissIntegrationsNotice() {
            localStorage.setItem('newco_integrations_viewed', 'true');
            const badge = document.getElementById('integrationsImportantBadge');
            if (badge) {
                badge.style.display = 'none';
            }
        }

        // Check if user has viewed integrations (conditional on if any integration is enabled)
        function checkIntegrationsNotice() {
            const viewed = localStorage.getItem('newco_integrations_viewed');
            const badge = document.getElementById('integrationsImportantBadge');

            if (!badge) return;

            // Check if ANY integration is enabled
            const integrations = NewcoData.get('integrations') || {};
            const hasAnyIntegration =
                integrations.paymentProcessing?.enabled ||
                integrations.quickbooks?.enabled ||
                integrations.sar?.enabled;

            // Show badge if: (1) user hasn't viewed integrations AND (2) at least one integration is enabled
            if (!viewed && hasAnyIntegration) {
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Payment Processing Toggle
        function togglePaymentProcessing() {
            const toggle = document.getElementById('paymentProcessingToggle');
            const marketing = document.getElementById('paymentProcessingMarketing');
            const config = document.getElementById('paymentProcessingConfig');

            if (toggle.checked) {
                marketing.style.display = 'none';
                config.style.display = 'block';
                // Load terminals when opening config
                loadTerminals();
            } else {
                marketing.style.display = 'block';
                config.style.display = 'none';
            }

            // Save state
            const integrations = NewcoData.get('integrations') || {};
            integrations.paymentProcessing = { enabled: toggle.checked };
            NewcoData.set('integrations', integrations);
        }

        // Show Payment Tab (Web or Terminal)
        function showPaymentTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.payment-tab-btn').forEach(btn => {
                const btnTab = btn.getAttribute('data-tab');
                if (btnTab === tab) {
                    btn.classList.add('active');
                    btn.style.borderBottomColor = '#4caf50';
                    btn.style.color = '#4caf50';
                } else {
                    btn.classList.remove('active');
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = '#666';
                }
            });

            // Update tab content
            document.querySelectorAll('.payment-tab-content').forEach(content => {
                content.style.display = 'none';
            });

            if (tab === 'web') {
                document.getElementById('webPaymentTab').style.display = 'block';
            } else if (tab === 'terminal') {
                document.getElementById('terminalPaymentTab').style.display = 'block';
                loadTerminals();
            }
        }

        // Load Terminals List
        function loadTerminals() {
            const terminalsList = document.getElementById('terminalsList');
            if (!terminalsList) return;

            const integrations = NewcoData.get('integrations') || {};
            const terminals = integrations.terminals || [];

            if (terminals.length === 0) {
                terminalsList.innerHTML = `
                    <div style="background: white; border: 2px dashed #e0e0e0; border-radius: 12px; padding: 2rem; text-align: center; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🏪</div>
                        <p style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #333;">No Terminals Configured</p>
                        <p style="margin: 0.5rem 0 0; font-size: 0.95rem;">Add your first payment terminal to get started</p>
                    </div>
                `;
                return;
            }

            terminalsList.innerHTML = terminals.map(terminal => `
                <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                ${terminal.name || 'Unnamed Terminal'}
                                <span style="background: ${terminal.status === 'active' ? '#4caf50' : '#f44336'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                    ${terminal.status === 'active' ? 'ACTIVE' : 'OFFLINE'}
                                </span>
                            </h3>
                            <div style="color: #666; font-size: 0.9rem; line-height: 1.6;">
                                <div style="margin: 0.25rem 0;"><strong>Brand:</strong> ${terminal.brand}</div>
                                <div style="margin: 0.25rem 0;"><strong>Model:</strong> ${terminal.model || 'N/A'}</div>
                                <div style="margin: 0.25rem 0;"><strong>Terminal ID:</strong> ${terminal.terminalId || 'N/A'}</div>
                                <div style="margin: 0.25rem 0;"><strong>Location:</strong> ${terminal.location || 'N/A'}</div>
                                ${terminal.lastTransaction ? `<div style="margin: 0.25rem 0;"><strong>Last Transaction:</strong> ${terminal.lastTransaction}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="editTerminal('${terminal.id}')" style="padding: 0.35rem 0.75rem; font-size: 0.8rem;">⚙️ Edit</button>
                            <button class="btn btn-secondary btn-sm" onclick="testTerminal('${terminal.id}')" style="padding: 0.35rem 0.75rem; font-size: 0.8rem;">🔧 Test</button>
                            <button class="btn btn-danger btn-sm" onclick="removeTerminal('${terminal.id}')" style="padding: 0.35rem 0.75rem; font-size: 0.8rem;">🗑️ Remove</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show Add Terminal Modal
        function showAddTerminalModal(editingTerminal = null) {
            const isEditing = editingTerminal !== null;

            const modal = document.createElement('div');
            modal.id = 'addTerminalModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">${isEditing ? '✏️ Edit Terminal' : '➕ Add New Terminal'}</h2>
                        <button onclick="closeAddTerminalModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Terminal Name *</label>
                        <input type="text" class="form-input" id="terminalName" placeholder="e.g., Main Hall - POS Terminal 1" value="${editingTerminal?.name || ''}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Device Brand *</label>
                        <select class="form-select" id="terminalBrand" onchange="updateTerminalModels()">
                            <option value="">Select Brand...</option>
                            <option value="Dejavoo" ${editingTerminal?.brand === 'Dejavoo' ? 'selected' : ''}>Dejavoo</option>
                            <option value="PAX" ${editingTerminal?.brand === 'PAX' ? 'selected' : ''}>PAX</option>
                            <option value="Ingenico" ${editingTerminal?.brand === 'Ingenico' ? 'selected' : ''}>Ingenico</option>
                            <option value="Verifone" ${editingTerminal?.brand === 'Verifone' ? 'selected' : ''}>Verifone</option>
                            <option value="Clover" ${editingTerminal?.brand === 'Clover' ? 'selected' : ''}>Clover</option>
                            <option value="Square" ${editingTerminal?.brand === 'Square' ? 'selected' : ''}>Square</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <select class="form-select" id="terminalModel">
                            <option value="">Select Model...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Terminal ID *</label>
                        <input type="text" class="form-input" id="terminalId" placeholder="e.g., DJV-1234567" value="${editingTerminal?.terminalId || ''}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="terminalLocation" placeholder="e.g., Front Desk" value="${editingTerminal?.location || ''}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Connection Type</label>
                        <select class="form-select" id="terminalConnectionType">
                            <option value="ethernet" ${editingTerminal?.connectionType === 'ethernet' ? 'selected' : ''}>Ethernet</option>
                            <option value="wifi" ${editingTerminal?.connectionType === 'wifi' ? 'selected' : ''}>WiFi</option>
                            <option value="cellular" ${editingTerminal?.connectionType === 'cellular' ? 'selected' : ''}>Cellular</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">IP Address (if applicable)</label>
                        <input type="text" class="form-input" id="terminalIpAddress" placeholder="e.g., 192.168.1.100" value="${editingTerminal?.ipAddress || ''}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">API Key / Credentials</label>
                        <input type="password" class="form-input" id="terminalApiKey" placeholder="Enter API key or credentials" value="${editingTerminal?.apiKey || ''}">
                        <small style="color: var(--gray); display: block; margin-top: 0.25rem;">Provided by your terminal provider</small>
                    </div>

                    <div style="display: flex; gap: 0.75rem; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="${isEditing ? `updateTerminal('${editingTerminal.id}')` : 'saveNewTerminal()'}">
                            ${isEditing ? 'Update Terminal' : 'Add Terminal'}
                        </button>
                        <button class="btn btn-secondary" onclick="closeAddTerminalModal()">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Load models for current brand if editing
            if (isEditing && editingTerminal.brand) {
                setTimeout(() => {
                    updateTerminalModels();
                    document.getElementById('terminalModel').value = editingTerminal.model || '';
                }, 100);
            }
        }

        // Update Terminal Models based on Brand
        function updateTerminalModels() {
            const brand = document.getElementById('terminalBrand').value;
            const modelSelect = document.getElementById('terminalModel');

            const models = {
                'Dejavoo': ['Z6', 'Z8', 'Z9', 'Z11', 'P3', 'QD2', 'QD4'],
                'PAX': ['S80', 'S90', 'S300', 'A920', 'A920 Pro', 'S920', 'IM30'],
                'Ingenico': ['Move 5000', 'Desk 5000', 'Link 2500', 'iCT250', 'iWL250'],
                'Verifone': ['VX 520', 'VX 680', 'VX 820', 'P400', 'E355'],
                'Clover': ['Mini', 'Flex', 'Station', 'Station Pro'],
                'Square': ['Terminal', 'Register', 'Stand']
            };

            modelSelect.innerHTML = '<option value="">Select Model...</option>';

            if (brand && models[brand]) {
                models[brand].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
        }

        // Close Add Terminal Modal
        function closeAddTerminalModal() {
            const modal = document.getElementById('addTerminalModal');
            if (modal) modal.remove();
        }

        // Save New Terminal
        async function saveNewTerminal() {
            const name = document.getElementById('terminalName').value.trim();
            const brand = document.getElementById('terminalBrand').value;
            const model = document.getElementById('terminalModel').value;
            const terminalId = document.getElementById('terminalId').value.trim();
            const location = document.getElementById('terminalLocation').value.trim();
            const connectionType = document.getElementById('terminalConnectionType').value;
            const ipAddress = document.getElementById('terminalIpAddress').value.trim();
            const apiKey = document.getElementById('terminalApiKey').value.trim();

            if (!name || !brand || !terminalId) {
                showModal({
                    title: '❌ Missing Information',
                    message: 'Please fill in all required fields (Name, Brand, Terminal ID).',
                    type: 'error'
                });
                return;
            }

            const newTerminal = {
                id: 'term_' + Date.now(),
                name,
                brand,
                model,
                terminalId,
                location,
                connectionType,
                ipAddress,
                apiKey,
                status: 'active',
                createdAt: new Date().toISOString(),
                lastTransaction: null
            };

            try {
                const integrations = NewcoData.get('integrations') || {};
                integrations.terminals = integrations.terminals || [];
                integrations.terminals.push(newTerminal);

                await NewcoData.set('integrations', integrations);

                showModal({
                    title: '✅ Terminal Added',
                    message: `${name} has been successfully added to your payment terminals.`,
                    type: 'success'
                });

                closeAddTerminalModal();
                loadTerminals();
            } catch (error) {
                console.error('Error saving terminal:', error);
                showModal({
                    title: '❌ Error',
                    message: 'Failed to save terminal. Please try again.',
                    type: 'error'
                });
            }
        }

        // Edit Terminal
        function editTerminal(terminalId) {
            const integrations = NewcoData.get('integrations') || {};
            const terminals = integrations.terminals || [];
            const terminal = terminals.find(t => t.id === terminalId);

            if (terminal) {
                showAddTerminalModal(terminal);
            }
        }

        // Update Terminal
        async function updateTerminal(terminalId) {
            const name = document.getElementById('terminalName').value.trim();
            const brand = document.getElementById('terminalBrand').value;
            const model = document.getElementById('terminalModel').value;
            const terminalIdValue = document.getElementById('terminalId').value.trim();
            const location = document.getElementById('terminalLocation').value.trim();
            const connectionType = document.getElementById('terminalConnectionType').value;
            const ipAddress = document.getElementById('terminalIpAddress').value.trim();
            const apiKey = document.getElementById('terminalApiKey').value.trim();

            if (!name || !brand || !terminalIdValue) {
                showModal({
                    title: '❌ Missing Information',
                    message: 'Please fill in all required fields (Name, Brand, Terminal ID).',
                    type: 'error'
                });
                return;
            }

            try {
                const integrations = NewcoData.get('integrations') || {};
                const terminals = integrations.terminals || [];
                const terminalIndex = terminals.findIndex(t => t.id === terminalId);

                if (terminalIndex !== -1) {
                    terminals[terminalIndex] = {
                        ...terminals[terminalIndex],
                        name,
                        brand,
                        model,
                        terminalId: terminalIdValue,
                        location,
                        connectionType,
                        ipAddress,
                        apiKey,
                        updatedAt: new Date().toISOString()
                    };

                    integrations.terminals = terminals;
                    await NewcoData.set('integrations', integrations);

                    showModal({
                        title: '✅ Terminal Updated',
                        message: `${name} has been successfully updated.`,
                        type: 'success'
                    });

                    closeAddTerminalModal();
                    loadTerminals();
                }
            } catch (error) {
                console.error('Error updating terminal:', error);
                showModal({
                    title: '❌ Error',
                    message: 'Failed to update terminal. Please try again.',
                    type: 'error'
                });
            }
        }

        // Test Terminal
        function testTerminal(terminalId) {
            const integrations = NewcoData.get('integrations') || {};
            const terminals = integrations.terminals || [];
            const terminal = terminals.find(t => t.id === terminalId);

            if (!terminal) return;

            showModal({
                title: '🔧 Testing Terminal',
                message: `Testing connection to ${terminal.name}...\n\nBrand: ${terminal.brand}\nModel: ${terminal.model}\nTerminal ID: ${terminal.terminalId}\n\nThis would send a test transaction to verify the terminal is responding.`,
                type: 'info'
            });

            // TODO: Implement actual terminal testing when API integration is ready
        }

        // Remove Terminal
        async function removeTerminal(terminalId) {
            const integrations = NewcoData.get('integrations') || {};
            const terminals = integrations.terminals || [];
            const terminal = terminals.find(t => t.id === terminalId);

            if (!terminal) return;

            showConfirm(
                `Are you sure you want to remove ${terminal.name}?\n\nThis will disconnect the terminal from your system.`,
                async () => {
                    try {
                        integrations.terminals = terminals.filter(t => t.id !== terminalId);
                        await NewcoData.set('integrations', integrations);

                        showModal({
                            title: '✅ Terminal Removed',
                            message: `${terminal.name} has been removed from your payment terminals.`,
                            type: 'success'
                        });

                        loadTerminals();
                    } catch (error) {
                        console.error('Error removing terminal:', error);
                        showModal({
                            title: '❌ Error',
                            message: 'Failed to remove terminal. Please try again.',
                            type: 'error'
                        });
                    }
                }
            );
        }

        // Activate Sandbox Mode
        async function activateSandbox() {
            const integrations = NewcoData.get('integrations') || {};
            integrations.authorizeNet = integrations.authorizeNet || {};
            integrations.authorizeNet.activeEnvironment = 'sandbox';

            await NewcoData.set('integrations', integrations);

            // Update UI
            updateEnvironmentUI('sandbox');

            // Update connection status
            document.getElementById('authorizeNetStatus').style.background = '#4caf50';
            document.getElementById('authorizeNetStatusText').textContent = 'Sandbox Connected';
            document.getElementById('authorizeNetStatusText').style.color = '#4caf50';

            showModal({
                title: '✅ Sandbox Activated',
                message: 'Payment processor is now in sandbox mode. No real charges will be made.',
                type: 'success'
            });
        }

        // Activate Production Mode
        async function activateProduction() {
            const integrations = NewcoData.get('integrations') || {};
            const authNet = integrations.authorizeNet;

            if (!authNet || !authNet.productionCredentials) {
                showModal({
                    title: '❌ No Production Credentials',
                    message: 'Please save your production credentials first.',
                    type: 'error'
                });
                return;
            }

            integrations.authorizeNet.activeEnvironment = 'production';
            await NewcoData.set('integrations', integrations);

            // Update UI
            updateEnvironmentUI('production');

            // Update connection status
            document.getElementById('authorizeNetStatus').style.background = '#d32f2f';
            document.getElementById('authorizeNetStatusText').textContent = 'Connected & Live';
            document.getElementById('authorizeNetStatusText').style.color = '#d32f2f';

            showModal({
                title: '✅ Production Activated',
                message: 'Payment processor is now in LIVE mode. Real charges will be processed!',
                type: 'warning'
            });
        }

        // Update Environment UI
        function updateEnvironmentUI(environment) {
            const sandboxBtn = document.getElementById('activateSandboxBtn');
            const productionBtn = document.getElementById('activateProductionBtn');
            const indicator = document.getElementById('activeEnvironmentIndicator');

            const sandboxTooltip = "Sandbox mode uses test credentials. No real charges will be made. Perfect for testing your payment flow.";
            const productionTooltip = "This button will become available when your account credentials are saved. Once clicked it will activate all of your payment processing elements.";

            if (environment === 'sandbox') {
                // Sandbox is active
                indicator.style.background = '#e8f5e9';
                indicator.style.borderLeftColor = '#4caf50';
                indicator.innerHTML = `
                    <div>
                        <strong style="color: #2e7d32; font-size: 1rem;">SANDBOX</strong>
                        <p style="margin: 0.25rem 0 0; font-size: 0.875rem; color: #555;">Test mode - No real charges</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="activateSandboxBtn" class="btn btn-success" onclick="activateSandbox()" title="${sandboxTooltip}">Sandbox</button>
                        <button id="activateProductionBtn" class="btn" style="background: #9e9e9e; color: white; ${productionBtn.style.display}" onclick="activateProduction()" ${productionBtn.disabled ? 'disabled' : ''} title="${productionTooltip}">Production</button>
                    </div>
                `;
            } else {
                // Production is active
                indicator.style.background = '#ffebee';
                indicator.style.borderLeftColor = '#d32f2f';
                indicator.innerHTML = `
                    <div>
                        <strong style="color: #c62828; font-size: 1rem;">PRODUCTION</strong>
                        <p style="margin: 0.25rem 0 0; font-size: 0.875rem; color: #555;">⚠️ Live mode - Real charges!</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="activateSandboxBtn" class="btn" style="background: #9e9e9e; color: white;" onclick="activateSandbox()" title="${sandboxTooltip}">Sandbox</button>
                        <button id="activateProductionBtn" class="btn btn-danger" onclick="activateProduction()" title="${productionTooltip}">Production</button>
                    </div>
                `;
            }
        }

        // Save Authorize.Net Production Credentials
        async function saveAuthorizeNetCredentials() {
            const apiLogin = document.getElementById('authorizeNetApiLogin').value.trim();
            const transactionKey = document.getElementById('authorizeNetTransactionKey').value.trim();
            const publicKey = document.getElementById('authorizeNetPublicKey').value.trim();

            if (!apiLogin || apiLogin.length < 8) {
                showModal({
                    title: '❌ Invalid API Login ID',
                    message: 'API Login ID must be at least 8 characters long.',
                    type: 'error'
                });
                return;
            }

            if (!transactionKey || transactionKey.length !== 16) {
                showModal({
                    title: '❌ Invalid Transaction Key',
                    message: 'Transaction Key must be exactly 16 characters long.',
                    type: 'error'
                });
                return;
            }

            if (!publicKey) {
                showModal({
                    title: '❌ Missing Public Client Key',
                    message: 'Public Client Key is required for payment processing.',
                    type: 'error'
                });
                return;
            }

            showLoading('Saving credentials...');

            const integrations = NewcoData.get('integrations') || {};
            integrations.authorizeNet = integrations.authorizeNet || {};
            integrations.authorizeNet.productionCredentials = {
                apiLoginId: apiLogin,
                transactionKey: transactionKey,
                publicClientKey: publicKey,
                connected: true,
                lastUpdated: new Date().toISOString()
            };

            // Keep sandbox as default until user activates production
            if (!integrations.authorizeNet.activeEnvironment) {
                integrations.authorizeNet.activeEnvironment = 'sandbox';
            }

            await NewcoData.set('integrations', integrations);

            // Update status
            document.getElementById('authorizeNetStatus').style.background = '#4caf50';
            document.getElementById('authorizeNetStatusText').textContent = 'Connected';
            document.getElementById('authorizeNetStatusText').style.color = '#4caf50';

            // Show production button now that credentials are saved
            const productionBtn = document.getElementById('activateProductionBtn');
            productionBtn.style.display = 'block';
            productionBtn.disabled = false;
            productionBtn.style.background = '#9e9e9e';

            hideLoading();
            showModal({
                title: '✅ Production Credentials Saved',
                message: 'Your production credentials have been saved. You can now activate production mode when ready to accept real payments.',
                type: 'success'
            });
        }

        // Test Authorize.Net Connection
        async function testAuthorizeNetConnection() {
            const integrations = NewcoData.get('integrations') || {};
            const authNet = integrations.authorizeNet;
            const activeEnv = authNet?.activeEnvironment || 'sandbox';

            // Check credentials based on active environment
            if (activeEnv === 'sandbox') {
                // Sandbox always has hardcoded credentials, so it's always ready
                showLoading('Testing sandbox connection...');

                setTimeout(() => {
                    hideLoading();
                    showModal({
                        title: '✅ Sandbox Connection Ready',
                        message: 'Sandbox mode is active with test credentials. You can test payments with card number 4111111111111111.',
                        type: 'success'
                    });
                }, 1000);
            } else {
                // Production requires saved credentials
                if (!authNet?.productionCredentials || !authNet.productionCredentials.apiLoginId || !authNet.productionCredentials.transactionKey) {
                    showModal({
                        title: '❌ No Production Credentials',
                        message: 'Please save your production credentials first.',
                        type: 'error'
                    });
                    return;
                }

                showLoading('Testing production connection...');

                // Note: Actual API test would go here
                // For now, we'll simulate a test
                setTimeout(() => {
                    hideLoading();
                    showModal({
                        title: '✅ Production Connection Successful',
                        message: 'Successfully connected to Authorize.Net production environment. Your credentials are valid.',
                        type: 'success'
                    });
                }, 1500);
            }
        }

        // QuickBooks Toggle
        function toggleQuickBooks() {
            const toggle = document.getElementById('quickbooksToggle');
            const marketing = document.getElementById('quickbooksMarketing');
            const config = document.getElementById('quickbooksConfig');

            if (toggle.checked) {
                marketing.style.display = 'none';
                config.style.display = 'block';
            } else {
                marketing.style.display = 'block';
                config.style.display = 'none';
            }

            const integrations = NewcoData.get('integrations') || {};
            integrations.quickbooks = { enabled: toggle.checked };
            NewcoData.set('integrations', integrations);
        }

        // Connect QuickBooks (OAuth flow)
        function connectQuickBooks() {
            showModal({
                title: '🔗 Connect to QuickBooks',
                message: 'QuickBooks OAuth integration will be implemented here. This will open a QuickBooks login window where you authorize NewCo to access your accounting data.',
                type: 'info'
            });

            // TODO: Implement actual QuickBooks OAuth flow
            // This would typically:
            // 1. Open OAuth popup
            // 2. User logs into QuickBooks
            // 3. User authorizes the app
            // 4. Callback returns access token
            // 5. Store token in NewcoData

            // For now, simulate connection
            setTimeout(() => {
                const integrations = NewcoData.get('integrations') || {};
                integrations.quickbooks = {
                    enabled: true,
                    connected: true,
                    companyName: 'Demo Company',
                    connectedAt: new Date().toISOString()
                };
                NewcoData.set('integrations', integrations);

                document.getElementById('quickbooksConnectionStatus').style.background = '#4caf50';
                document.getElementById('quickbooksConnectionText').textContent = 'Connected to Demo Company';
                document.getElementById('quickbooksConnectionText').style.color = '#4caf50';
                document.getElementById('quickbooksSettingsBtn').style.display = 'inline-block';
                document.getElementById('quickbooksDisconnectBtn').style.display = 'inline-block';

                showModal({
                    title: '✅ Connected',
                    message: 'Successfully connected to QuickBooks.',
                    type: 'success'
                });
            }, 2000);
        }

        // Disconnect QuickBooks
        function disconnectQuickBooks() {
            showConfirm('Are you sure you want to disconnect QuickBooks? Transaction syncing will stop.', () => {
                const integrations = NewcoData.get('integrations') || {};
                integrations.quickbooks = { enabled: false, connected: false };
                NewcoData.set('integrations', integrations);

                document.getElementById('quickbooksConnectionStatus').style.background = '#ff9800';
                document.getElementById('quickbooksConnectionText').textContent = 'Not Connected';
                document.getElementById('quickbooksConnectionText').style.color = '#ff9800';
                document.getElementById('quickbooksSettingsBtn').style.display = 'none';
                document.getElementById('quickbooksDisconnectBtn').style.display = 'none';

                showModal({
                    title: '✅ Disconnected',
                    message: 'QuickBooks has been disconnected.',
                    type: 'success'
                });
            });
        }

        // QuickBooks Settings
        function showQuickBooksSettings() {
            showModal({
                title: '⚙️ QuickBooks Settings',
                message: 'Configure sync settings, account mappings, and tax categories here.',
                type: 'info'
            });
        }

        // SAR Toggle
        function toggleSAR() {
            const toggle = document.getElementById('sarToggle');
            const marketing = document.getElementById('sarMarketing');
            const config = document.getElementById('sarConfig');
            const emailGroup = document.getElementById('sarEmailGroup');

            if (toggle.checked) {
                marketing.style.display = 'none';
                config.style.display = 'block';
            } else {
                marketing.style.display = 'block';
                config.style.display = 'none';
            }

            const integrations = NewcoData.get('integrations') || {};
            integrations.sar = { enabled: toggle.checked };
            NewcoData.set('integrations', integrations);

            // Show/hide email group based on auto-export checkbox
            const autoExport = document.getElementById('sarAutoExport');
            if (autoExport) {
                emailGroup.style.display = autoExport.checked ? 'block' : 'none';
            }
        }

        // Save SAR Settings
        function saveSARSettings() {
            const frequency = document.getElementById('sarReportFrequency').value;
            const autoExport = document.getElementById('sarAutoExport').checked;
            const emailRecipients = document.getElementById('sarEmailRecipients').value;
            const emailGroup = document.getElementById('sarEmailGroup');

            // Show/hide email input based on checkbox
            emailGroup.style.display = autoExport ? 'block' : 'none';

            const integrations = NewcoData.get('integrations') || {};
            integrations.sar = {
                enabled: true,
                reportFrequency: frequency,
                autoExport: autoExport,
                emailRecipients: emailRecipients
            };
            NewcoData.set('integrations', integrations);

            showAutoSave();
        }

        // View SAR Reports
        function viewSARReports() {
            showSection('reports');
            showModal({
                title: '📊 SAR Reports',
                message: 'Session analytics and reports are available in the Reports section.',
                type: 'info'
            });
        }

        // Load integration settings on page load
        function loadIntegrationSettings() {
            const integrations = NewcoData.get('integrations') || {};

            // Payment Processing
            if (integrations.paymentProcessing?.enabled) {
                document.getElementById('paymentProcessingToggle').checked = true;
                togglePaymentProcessing();
            } else {
                // Show marketing box by default when toggle is off
                document.getElementById('paymentProcessingMarketing').style.display = 'block';
                document.getElementById('paymentProcessingConfig').style.display = 'none';
            }

            // Authorize.Net
            if (integrations.authorizeNet?.productionCredentials) {
                document.getElementById('authorizeNetApiLogin').value = integrations.authorizeNet.productionCredentials.apiLoginId || '';
                document.getElementById('authorizeNetTransactionKey').value = '••••••••••••••••';
                document.getElementById('authorizeNetPublicKey').value = integrations.authorizeNet.productionCredentials.publicClientKey || '';

                // Show production button since credentials are saved
                const productionBtn = document.getElementById('activateProductionBtn');
                productionBtn.style.display = 'block';
                productionBtn.disabled = false;
            }

            // Restore active environment (default to sandbox)
            const activeEnv = integrations.authorizeNet?.activeEnvironment || 'sandbox';
            updateEnvironmentUI(activeEnv);

            // Set connection status based on active environment
            if (activeEnv === 'production') {
                document.getElementById('authorizeNetStatus').style.background = '#d32f2f';
                document.getElementById('authorizeNetStatusText').textContent = 'Connected & Live';
                document.getElementById('authorizeNetStatusText').style.color = '#d32f2f';
            } else {
                document.getElementById('authorizeNetStatus').style.background = '#4caf50';
                document.getElementById('authorizeNetStatusText').textContent = 'Sandbox Connected';
                document.getElementById('authorizeNetStatusText').style.color = '#4caf50';
            }

            // QuickBooks
            if (integrations.quickbooks?.enabled) {
                document.getElementById('quickbooksToggle').checked = true;
                toggleQuickBooks();
            } else {
                // Show marketing box by default when toggle is off
                document.getElementById('quickbooksMarketing').style.display = 'block';
                document.getElementById('quickbooksConfig').style.display = 'none';
            }
            if (integrations.quickbooks?.connected) {
                document.getElementById('quickbooksConnectionStatus').style.background = '#4caf50';
                document.getElementById('quickbooksConnectionText').textContent = 'Connected to ' + (integrations.quickbooks.companyName || 'QuickBooks');
                document.getElementById('quickbooksConnectionText').style.color = '#4caf50';
                document.getElementById('quickbooksSettingsBtn').style.display = 'inline-block';
                document.getElementById('quickbooksDisconnectBtn').style.display = 'inline-block';
            }

            // SAR
            if (integrations.sar?.enabled) {
                document.getElementById('sarToggle').checked = true;
                toggleSAR();
                document.getElementById('sarReportFrequency').value = integrations.sar.reportFrequency || 'daily';
                document.getElementById('sarAutoExport').checked = integrations.sar.autoExport || false;
                document.getElementById('sarEmailRecipients').value = integrations.sar.emailRecipients || '';
                document.getElementById('sarEmailGroup').style.display = integrations.sar.autoExport ? 'block' : 'none';
            } else {
                // Show marketing box by default when toggle is off
                document.getElementById('sarMarketing').style.display = 'block';
                document.getElementById('sarConfig').style.display = 'none';
            }
        }
    </script>
    </div> <!-- Close adminMainPanel -->

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; display: none;">
        <div style="text-align: center; color: white;">
            <div class="spinner" style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <div id="loadingMessage" style="font-size: 1.125rem; font-weight: 500;">Processing...</div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingOverlay.active {
            display: flex !important;
        }
    </style>

    <script>
        // Loading overlay functions
        function showLoading(message = 'Processing...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            messageEl.textContent = message;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }
    </script>
</body>
</html>