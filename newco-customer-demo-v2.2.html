<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa Clara Bingo</title>
    
    <!-- 
    ╔═══════════════════════════════════════════════════════════════════╗
    ║              NEWCO CUSTOMER DEMO - PUBLIC FACING WEBSITE            ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║ FILE: newco-customer-demo.html                                      ║
    ║ PURPOSE: Customer-facing bingo hall website with purchasing       ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║                                                                   ║
    ║ SYSTEM INTERCONNECTIONS:                                         ║
    ║ • READS FROM:                                                     ║
    ║   - newco_organization (branding, settings)                   ║
    ║   - newco_sessions (available sessions)                       ║
    ║   - newco_packages (pricing, packages)                        ║
    ║   - newco_members (customer data)                             ║
    ║   - newco_rewards (loyalty points)                            ║
    ║                                                                   ║
    ║ • WRITES TO:                                                      ║
    ║   - newco_transactions (purchase records)                     ║
    ║   - newco_members (updates points/visits)                     ║
    ║   - newco_cart (temporary cart data)                          ║
    ║                                                                   ║
    ║ • INTEGRATES WITH:                                                ║
    ║   - newco-admin.html (configuration source)                    ║
    ║   - newco-redemption.html (point redemption)                       ║
    ║   - newco-floor-runner-vanguard.html (in-person sales)             ║
    ║                                                                   ║
    ║ KEY SECTIONS (use Ctrl+F):                                       ║
    ║ • [CART-SYSTEM]     - Shopping cart management                   ║
    ║ • [CHECKOUT]        - Payment processing                         ║
    ║ • [MEMBER-AUTH]     - Member login/registration                  ║
    ║ • [SESSION-DISPLAY] - Session calendar & selection               ║
    ║ • [PACKAGE-SELECT]  - Package selection UI                       ║
    ║ • [LOYALTY-POINTS]  - Points earning/display                     ║
    ║ • [SEAT-SELECTION]  - Interactive seat picker                    ║
    ║                                                                   ║
    ║ TECHNICAL NOTES:                                                 ║
    ║ • Uses NewcoData for all data operations                      ║
    ║ • Cart persists in sessionStorage during checkout                ║
    ║ • Transactions marked as source: 'website'                       ║
    ║ • Points calculated using org.rewards.pointsConfig               ║
    ║                                                                   ║
    ║ SECURITY CONSIDERATIONS:                                         ║
    ║ • No payment processing (placeholder only)                       ║
    ║ • Member passwords not implemented (email-only)                  ║
    ║ • All data client-side (localStorage)                            ║
    ║                                                                   ║
    ║ DEPLOYMENT:                                                       ║
    ║ • Standalone HTML - no build process                             ║
    ║ • Requires newco-admin.html to configure data                  ║
    ║ • Mobile responsive design included                              ║
    ╚═══════════════════════════════════════════════════════════════════╝
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--primary-color, #6c5ce7);
            border-bottom: 2px solid var(--primary-dark, #5a4fd8);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .login-btn {
            background: white;
            color: var(--primary-color, #6c5ce7);
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }

        .login-btn:hover {
            background: #5f4dd8;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Main Content Area */
        .content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 2rem;
            text-align: center;
        }

        /* Package Grid */
        .packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .package-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 420px;
        }

        .package-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            transition: all 0.2s;
        }

        .best-value-badge {
            position: absolute;
            top: -10px;
            right: 10px;
            background: #f39c12;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: bold;
        }

        .package-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .package-price {
            font-size: 2rem;
            font-weight: bold;
            color: #6c5ce7;
            margin-bottom: 0.5rem;
        }

        .package-points {
            color: #27ae60;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .package-items {
            color: #666;
            font-size: 0.875rem;
            line-height: 1.6;
            margin: 1rem 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .add-to-cart-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: auto;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            width: 100%;
        }

        .add-to-cart-btn:hover {
            background: #5f4dd8;
        }

        /* Cart Sidebar */
        .cart-sidebar {
            width: 350px;
            background: white;
            border-left: 2px solid #e0e0e0;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        }

        .cart-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .cart-empty {
            color: #999;
            text-align: center;
            padding: 2rem;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
        }

        .cart-footer {
            border-top: 2px solid #e0e0e0;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.25rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
        }

        .checkout-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: bold;
            width: 100%;
        }

        .checkout-btn:hover {
            background: #219a52;
        }

        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Additional Items Section */
        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .item-card {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 180px;
            align-items: center;
            text-align: center;
        }

        .item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .item-price {
            color: #6c5ce7;
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .add-item-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .add-item-btn:hover {
            background: #5f4dd8;
        }
        .package-btn, .item-btn, .add-item-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }
        
        .package-btn:hover, .item-btn:hover, .add-item-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .package-btn:active, .item-btn:active, .add-item-btn:active {
            transform: translateY(0);
        }
    </style>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Milpitas Grid-Based Seat Map -->
    <script src="milpitas-grid-map.js"></script>

    <!-- Supabase NewcoData Integration -->
    <script src="newco-supabase.js"></script>
    <script>
        // Initialize NewcoData with customer ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const customer = urlParams.get('customer') || 'demo';

        // Initialize asynchronously and wait for it to complete
        (async () => {
            await NewcoData.init(customer);
            console.log('Customer Demo initialized for:', customer);

            // Load organization data after init completes
            loadOrganization();
            loadSessions();
            loadCartFromSession();
            checkLoggedInMember();
            loadSocialMediaButton();
            showWelcomePopupIfNeeded();
        })();
    </script>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">🎯 <span id="orgName">Santa Clara Bingo</span></div>
        </div>
        <div class="header-right">
            <div id="socialMediaButton" style="display: none; margin-right: 1rem;">
                <!-- Social media button will be injected here -->
            </div>
            <div id="memberInfo" style="display: inline-flex; align-items: center; gap: 1rem;">
                <button class="login-btn" onclick="showLogin()">Login / Register</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Main Content -->
        <div class="content">
            <!-- Event Selection (shown first) -->
            <div id="eventSelection" style="display: block;">
                <h1 class="page-title" style="text-align: center;" id="welcomeTitle">Welcome!</h1>
                <p class="page-subtitle" style="text-align: center;">Select your session to get started</p>
                
                <div style="margin: 2rem 0;">
                    <h2 style="margin-bottom: 1.5rem; color: #333;">Available Sessions</h2>
                    <div id="sessionsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                        <!-- Sessions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Package Selection (hidden initially) -->
            <div id="packageSelection" style="display: none;">
                <div style="background: #f0f4f8; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; color: #333; font-size: 1.25rem;" id="selectedSessionTitle">Selected Session</h2>
                        <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.875rem;" id="selectedSessionDetails">Details</p>
                    </div>
                    <button onclick="changeSession()" style="background: #6c5ce7; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Change Session</button>
                </div>

                <h2 class="page-title">Select Your Package</h2>
                
                <!-- Packages Grid -->
                <div class="packages-grid" id="packagesGrid">
                    <!-- Packages will be loaded here -->
                </div>

                <!-- Additional Items -->
                <h2 class="section-title">Additional Items</h2>
                <div class="items-grid" id="itemsGrid">
                    <!-- Items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Cart Sidebar (Right) -->
        <div class="cart-sidebar">
            <h2 class="cart-title">🛒 Your Cart</h2>
            <div id="cartSessionInfo" style="display: none; background: #f0f4f8; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem;">
                <div style="font-weight: 600; color: #6c5ce7;" id="cartSessionName"></div>
                <div style="color: #666;" id="cartSessionDetails"></div>
            </div>
            <div class="cart-items" id="cartItems">
                <div class="cart-empty">Your cart is empty</div>
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cartTotal">$0.00</span>
                </div>
                <button class="checkout-btn" disabled onclick="checkout()">Checkout</button>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════
        // [INITIALIZATION] - System Setup & Data Management
        // ═══════════════════════════════════════════════════════════

        // Stripe initialization (test mode)
        const STRIPE_TEST_MODE = true; // Set to false for live mode
        const stripe = Stripe('pk_test_51QYOPdP3mMHdPznB5zNxrkSMCbZ1jPvmcLBKq1lQTJjnJuGOvADqh5nANhYLa1YC4dg5Nn8G3Tst9OBmN9kNNY5N00oE7r9Zy1');
        let elements, cardElement;

        /*
        // Simple NewcoData reader - REPLACED WITH SUPABASE VERSION
        window.NewcoData = {
            get(key) {
                try {
                    const data = localStorage.getItem('newco_' + key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Error reading from localStorage:', error);
                    return null;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem('newco_' + key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error('Error writing to localStorage:', error);
                    return false;
                }
            }
        };
        */

        // ═══════════════════════════════════════════════════════════
        // [CART-SYSTEM] - Shopping Cart Management
        // ═══════════════════════════════════════════════════════════
        
        let cart = {
            sessionId: null,
            sessionName: null,
            sessionDate: null,
            sessionTime: null,
            items: [],
            subtotal: 0,
            tax: 0,
            total: 0
        };

        // ═══════════════════════════════════════════════════════════
        // [ORGANIZATION-LOADER] - Branding & Configuration
        // ═══════════════════════════════════════════════════════════
        
        function loadOrganization() {
            const org = NewcoData.get('organization');
            console.log('Organization data:', org);
            if (org && org.name) {
                document.getElementById('orgName').textContent = org.name;
                document.title = org.name;
                // Update welcome title
                const welcomeTitle = document.getElementById('welcomeTitle');
                if (welcomeTitle) {
                    welcomeTitle.textContent = `Welcome to ${org.name}!`;
                }
            } else {
                console.log('No organization name found, using default');
                // Set default welcome title
                const welcomeTitle = document.getElementById('welcomeTitle');
                if (welcomeTitle) {
                    welcomeTitle.textContent = 'Welcome!';
                }
            }
            
            // Apply brand colors
            if (org && org.colors) {
                const root = document.documentElement;
                if (org.colors.primary) {
                    // Update CSS variables
                    root.style.setProperty('--primary-color', org.colors.primary);
                    
                    // Update header background
                    const header = document.querySelector('.header');
                    if (header) {
                        header.style.background = org.colors.primary;
                    }
                    
                    // Update button colors
                    const style = document.createElement('style');
                    style.textContent = `
                        .package-price { color: ${org.colors.primary} !important; }
                        .add-btn { background: ${org.colors.primary} !important; }
                        .add-btn:hover { opacity: 0.9 !important; }
                        .checkout-btn { background: ${org.colors.primary} !important; }
                    `;
                    document.head.appendChild(style);
                }
                
                if (org.colors.secondary) {
                    root.style.setProperty('--secondary-color', org.colors.secondary);
                }
            }
        }

        // ═══════════════════════════════════════════════════════════
        // [PACKAGE-SELECT] - Package Loading & Display
        // ═══════════════════════════════════════════════════════════
        
        function loadPackages() {
            // Force fresh read from localStorage
            const packagesRaw = localStorage.getItem('newco_packages');
            console.log('Raw packages data:', packagesRaw);

            const allPackages = packagesRaw ? JSON.parse(packagesRaw) : [];
            const salesItems = NewcoData.get('salesItems') || [];
            const container = document.getElementById('packagesGrid');

            // Filter packages by current day
            const currentDay = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][new Date().getDay()];
            const packages = allPackages.filter(pkg => {
                // If package has validDays, check if current day is included
                if (pkg.validDays && pkg.validDays.length > 0) {
                    return pkg.validDays.includes(currentDay);
                }
                // If no validDays set, show package
                return true;
            });

            console.log(`Filtered packages for ${currentDay}:`, packages.length, 'of', allPackages.length);
            console.log('Loading packages:', packages.length, 'packages found');
            console.log('Packages:', packages);

            if (!packages || packages.length === 0) {
                container.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: #999;">No packages available for ${currentDay}. Please check back on a different day.</p>`;
                return;
            }

            container.innerHTML = packages.map(pkg => {
                // Build items list - handle both new schema (objects) and legacy (IDs)
                let itemsList = '';
                if (pkg.items && pkg.items.length > 0) {
                    itemsList = pkg.items.map(item => {
                        // Handle new schema: items are objects with {itemId, itemName, quantity}
                        if (typeof item === 'object' && item.itemName) {
                            return `• ${item.itemName}${item.quantity > 1 ? ' x' + item.quantity : ''}`;
                        }
                        // Legacy: items are strings (IDs or 'custom')
                        if (item === 'custom') {
                            return `• ${pkg.customLineText || 'Special selection'}`;
                        }
                        const salesItem = salesItems.find(si => si.id === item);
                        return salesItem ? `• ${salesItem.name}` : `• Item included`;
                    }).join('<br>');
                } else {
                    itemsList = 'Complete package';
                }

                return `
                    <div class="package-card">
                        ${pkg.bestValue ? '<span class="best-value-badge">BEST VALUE!</span>' : ''}
                        <div style="flex: 0;">
                            <div class="package-name">${pkg.name}</div>
                            <div class="package-price">$${pkg.price}</div>
                            ${pkg.canBuyWithLoyalty ? `<div class="package-points">or ${pkg.loyaltyPointsCost || 0} ${NewcoData.get('settings')?.pointsCurrencyName?.toLowerCase() || 'points'}</div>` : '<div style="height: 21px;"></div>'}
                        </div>
                        <div class="package-items">
                            ${itemsList}
                        </div>
                        <div style="margin-top: auto;">
                            <button class="add-to-cart-btn" onclick="addPackageToCart('${pkg.id}')">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load additional items from admin
        function loadItems() {
            const items = NewcoData.get('salesItems') || [];
            const container = document.getElementById('itemsGrid');
            
            if (items.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No additional items available.</p>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="item-card">
                    <div style="flex: 0;">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">$${item.price}</div>
                    </div>
                    <div style="flex: 1;"></div>
                    <div style="margin-top: auto;">
                        <button class="add-item-btn" onclick="addItemToCart('${item.id}')">
                            Add to Cart
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Cart functions
        window.addPackageToCart = function(packageId) {
            const packages = NewcoData.get('packages') || [];
            const pkg = packages.find(p => p.id === packageId);
            if (pkg) {
                addToCart('package', pkg.id, pkg.name, pkg.price, pkg.seatSelection);
            }
        }

        window.addItemToCart = function(itemId) {
            const items = NewcoData.get('salesItems') || [];
            const item = items.find(i => i.id === itemId);
            if (item) {
                addToCart('item', item.id, item.name, item.price, false);
            }
        }

        function addToCart(type, id, name, price, requiresSeat) {
            // Check if item already in cart
            const existingItem = cart.items.find(i => i.id === id && i.type === type);
            
            if (existingItem) {
                // Check if there's a limit per customer
                let limitPerCustomer = 0;
                
                if (type === 'package') {
                    const packages = NewcoData.get('packages') || [];
                    const pkg = packages.find(p => p.id === id);
                    limitPerCustomer = pkg ? (pkg.limitPerCustomer || 0) : 0;
                } else if (type === 'item') {
                    const salesItems = NewcoData.get('salesItems') || [];
                    const salesItem = salesItems.find(si => si.id === id);
                    limitPerCustomer = salesItem ? (salesItem.limitPerCustomer || 0) : 0;
                }
                
                if (limitPerCustomer > 0 && existingItem.quantity >= limitPerCustomer) {
                    notify.warning(`Sorry, this item is limited to ${limitPerCustomer} per customer.`);
                    return;
                }
                
                existingItem.quantity++;
            } else {
                cart.items.push({
                    id: id,
                    type: type,
                    name: name,
                    price: price,
                    quantity: 1,
                    requiresSeat: requiresSeat || false
                });
            }
            
            updateCartDisplay();
            saveCartToSession();
        }

        window.removeFromCart = function(itemId, type) {
            cart.items = cart.items.filter(i => !(i.id === itemId && i.type === type));
            updateCartDisplay();
            saveCartToSession();
        }

        window.updateQuantity = function(itemId, type, delta) {
            const item = cart.items.find(i => i.id === itemId && i.type === type);
            if (item) {
                // Check if increasing quantity
                if (delta > 0) {
                    // Get the limit for this item
                    let limitPerCustomer = 0;
                    
                    if (type === 'package') {
                        const packages = NewcoData.get('packages') || [];
                        const pkg = packages.find(p => p.id === itemId);
                        limitPerCustomer = pkg ? (pkg.limitPerCustomer || 0) : 0;
                    } else if (type === 'item') {
                        const salesItems = NewcoData.get('salesItems') || [];
                        const salesItem = salesItems.find(si => si.id === itemId);
                        limitPerCustomer = salesItem ? (salesItem.limitPerCustomer || 0) : 0;
                    }
                    
                    // Check if limit is set and would be exceeded
                    if (limitPerCustomer > 0 && (item.quantity + delta) > limitPerCustomer) {
                        notify.warning(`Limit of ${limitPerCustomer} per customer for ${item.name}`);
                        return;
                    }
                }
                
                item.quantity += delta;
                if (item.quantity <= 0) {
                    removeFromCart(itemId, type);
                } else {
                    updateCartDisplay();
                    saveCartToSession();
                }
            }
        }

        function updateCartDisplay() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartTotalSpan = document.getElementById('cartTotal');
            const checkoutBtn = document.querySelector('.checkout-btn');
            const sessionInfo = document.getElementById('cartSessionInfo');
            const sessionName = document.getElementById('cartSessionName');
            const sessionDetails = document.getElementById('cartSessionDetails');
            
            // Show session info if cart has a session
            if (cart.sessionId) {
                sessionInfo.style.display = 'block';
                sessionName.textContent = cart.sessionName;
                sessionDetails.textContent = `${cart.sessionDate} • ${cart.sessionTime}`;
            } else {
                sessionInfo.style.display = 'none';
            }
            
            if (cart.items.length === 0) {
                cartItemsDiv.innerHTML = '<div class="cart-empty">Your cart is empty</div>';
                checkoutBtn.disabled = true;
            } else {
                let html = '';
                cart.subtotal = 0;
                
                cart.items.forEach(item => {
                    const itemTotal = (item.price || 0) * item.quantity;
                    cart.subtotal += itemTotal;
                    
                    // Different display for reward items
                    if (item.type === 'reward') {
                        html += `
                            <div style="background: linear-gradient(135deg, #fff9e6, #fffbf0); padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid #ffc107;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333;">${item.name}</div>
                                        <div style="color: #f39c12; font-size: 0.875rem; margin-top: 0.25rem; font-weight: 600;">
                                            🎁 Redeemed for ${item.pointsCost} points
                                        </div>
                                    </div>
                                    <button onclick="removeFromCart('${item.id}', '${item.type}')" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.25rem;">&times;</button>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                    <div style="color: #666; font-size: 0.875rem;">Qty: ${item.quantity}</div>
                                    <div style="font-weight: 600; color: #27ae60;">FREE</div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="background: #f9f9f9; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333;">${item.name}</div>
                                        <div style="color: #666; font-size: 0.875rem; margin-top: 0.25rem;">$${(item.price || 0).toFixed(2)} each</div>
                                    </div>
                                    <button onclick="removeFromCart('${item.id}', '${item.type}')" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.25rem;">&times;</button>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <button onclick="updateQuantity('${item.id}', '${item.type}', -1)" style="background: #ddd; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer;">-</button>
                                        <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
                                        <button onclick="updateQuantity('${item.id}', '${item.type}', 1)" style="background: #ddd; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer;">+</button>
                                    </div>
                                    <div style="font-weight: 600; color: #6c5ce7;">$${itemTotal.toFixed(2)}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                // Calculate tax using settings and exemptions
                const settings = NewcoData.get('settings') || {};
                const taxRate = (settings.taxRate || 8.75) / 100;
                
                // Calculate taxable amount based on exemptions
                let taxableAmount = 0;
                cart.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    // Check if item type is tax exempt
                    if (item.type === 'package' && settings.taxExemptPackages === false) {
                        taxableAmount += itemTotal;
                    } else if (item.type === 'item' && settings.taxExemptItems === false) {
                        taxableAmount += itemTotal;
                    } else if (item.type === 'reward' && settings.taxExemptRewards === false) {
                        taxableAmount += itemTotal;
                    }
                    // If type is merchandise or other, it's taxable
                    else if (item.type === 'merchandise' || item.type === 'concession') {
                        taxableAmount += itemTotal;
                    }
                });
                
                cart.tax = taxableAmount * taxRate;
                
                // Apply any percentage discounts from rewards
                let discountAmount = 0;
                cart.items.forEach(item => {
                    if (item.type === 'reward' && item.data) {
                        // Check if this is a percentage discount reward
                        if (item.data.name && item.data.name.includes('%')) {
                            // Extract percentage (e.g., "25% Discount" -> 25)
                            const match = item.data.name.match(/(\d+)%/);
                            if (match) {
                                const percentage = parseInt(match[1]) / 100;
                                discountAmount = cart.subtotal * percentage;
                            }
                        }
                    }
                });
                
                cart.discount = discountAmount;
                cart.total = cart.subtotal + cart.tax - discountAmount;
                
                // Add subtotal and tax display
                html += `
                    <div style="border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Subtotal:</span>
                            <span>$${cart.subtotal.toFixed(2)}</span>
                        </div>
                        ${cart.discount > 0 ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #27ae60;">
                                <span>Reward Discount:</span>
                                <span>-$${cart.discount.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Tax:</span>
                            <span>$${cart.tax.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                
                cartItemsDiv.innerHTML = html;
                checkoutBtn.disabled = false;
            }
            
            cartTotalSpan.textContent = `$${cart.total.toFixed(2)}`;
        }

        function saveCartToSession() {
            sessionStorage.setItem('newco_cart', JSON.stringify(cart));
        }

        // ═══════════════════════════════════════════════════════════
        // [CART-PERSISTENCE] - Session Storage Management
        // ═══════════════════════════════════════════════════════════
        
        function loadCartFromSession() {
            const saved = sessionStorage.getItem('newco_cart');
            const savedSession = sessionStorage.getItem('selectedSession');

            if (saved) {
                cart = JSON.parse(saved);

                // Migration: if cart has old sessionDay field, rename it to sessionDate
                if (cart.sessionDay !== undefined && cart.sessionDate === undefined) {
                    cart.sessionDate = cart.sessionDay;
                    delete cart.sessionDay;
                    sessionStorage.setItem('newco_cart', JSON.stringify(cart));
                }

                updateCartDisplay();
            }
            
            // Restore selected session if available
            if (savedSession) {
                selectedSession = JSON.parse(savedSession);
                // If we have a saved session, go directly to package selection
                if (selectedSession) {
                    document.getElementById('eventSelection').style.display = 'none';
                    document.getElementById('packageSelection').style.display = 'block';
                    document.getElementById('selectedSessionTitle').textContent = selectedSession.name;
                    document.getElementById('selectedSessionDetails').textContent = 
                        `${selectedSession.day} • ${selectedSession.startTime} - ${selectedSession.endTime}`;
                    
                    // Load packages for this session
                    loadFilteredPackages();
                    loadFilteredItems();
                }
            }
        }

        // Login/Register Modal Functions
        // ═══════════════════════════════════════════════════════════
        // [MEMBER-AUTH] - Member Login/Registration System
        // ═══════════════════════════════════════════════════════════
        
        window.showLogin = function() {
            const modal = document.createElement('div');
            modal.id = 'authModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; width: 90%; max-width: 400px; position: relative;">
                    <button onclick="closeAuthModal()" style="position: absolute; right: 1rem; top: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    
                    <div id="authContent">
                        <!-- Login Form -->
                        <div id="loginForm">
                            <h2 style="margin: 0 0 1.5rem 0; color: #333;">Member Login</h2>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Email or Member ID</label>
                                <input type="text" id="loginUsername" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Password</label>
                                <input type="password" id="loginPassword" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <button onclick="doLogin()" style="width: 100%; padding: 0.75rem; background: #6c5ce7; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-bottom: 1rem;">
                                Login
                            </button>
                            
                            <div style="text-align: center;">
                                <span style="color: #666;">Not a member?</span>
                                <a href="#" onclick="showRegisterForm(); return false;" style="color: #6c5ce7; text-decoration: none; font-weight: 600;">Register</a>
                            </div>
                        </div>
                        
                        <!-- Register Form (hidden initially) -->
                        <div id="registerForm" style="display: none;">
                            <h2 style="margin: 0 0 1.5rem 0; color: #333;">Create Account</h2>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #666;">First Name <span style="color: #e74c3c;">*</span></label>
                                    <input type="text" id="regFirstName" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #666;">Last Name <span style="color: #e74c3c;">*</span></label>
                                    <input type="text" id="regLastName" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Email <span style="color: #e74c3c;">*</span></label>
                                <input type="email" id="regEmail" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                                <div id="emailError" style="color: #e74c3c; font-size: 0.875rem; margin-top: 0.25rem; display: none;"></div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Phone (Optional)</label>
                                <input type="tel" id="regPhone" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Password <span style="color: #e74c3c;">*</span></label>
                                <input type="password" id="regPassword" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                                <div style="color: #999; font-size: 0.75rem; margin-top: 0.25rem;">Minimum 6 characters</div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Date of Birth (Optional)</label>
                                <input type="date" id="regDOB" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <div id="registerError" style="background: #fee; color: #e74c3c; padding: 0.75rem; border-radius: 8px; display: none;"></div>
                            </div>
                            
                            <button onclick="doRegister()" style="width: 100%; padding: 0.75rem; background: #6c5ce7; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-bottom: 1rem;">
                                Create Account
                            </button>
                            
                            <div style="text-align: center;">
                                <span style="color: #666;">Already have an account?</span>
                                <a href="#" onclick="showLoginForm(); return false;" style="color: #6c5ce7; text-decoration: none; font-weight: 600;">Login</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        window.closeAuthModal = function() {
            const modal = document.getElementById('authModal');
            if (modal) {
                modal.remove();
            }
        }
        
        window.showRegisterForm = function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            
            // Clear any errors when switching forms
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('emailError').style.display = 'none';
            ['regFirstName', 'regLastName', 'regEmail', 'regPassword'].forEach(id => {
                document.getElementById(id).style.border = '1px solid #ddd';
            });
        }
        
        window.showLoginForm = function() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            
            // Clear register form errors
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('emailError').style.display = 'none';
            ['regFirstName', 'regLastName', 'regEmail', 'regPassword'].forEach(id => {
                document.getElementById(id).style.border = '1px solid #ddd';
            });
        }
        
        window.doLogin = async function() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                notify.error('Please enter email/member ID and password');
                return;
            }

            // Refresh members from Supabase first
            const custData = await NewcoData.read_cust();
            if (custData.members) {
                NewcoData.cache.members = custData.members;
            }

            // Check against stored members
            const members = NewcoData.get('members') || [];
            const member = members.find(m => 
                (m.email === username || m.memberId === username) && 
                m.password === password
            );
            
            if (member) {
                // Update login tracking
                member.logins = (member.logins || 0) + 1;
                member.lastLogin = new Date().toISOString();

                // Save updated member back to database
                const memberIndex = members.findIndex(m => m.id === member.id || m.memberId === member.memberId);
                if (memberIndex !== -1) {
                    members[memberIndex] = member;
                    await NewcoData.set('members', members);
                }

                // Store logged in member
                sessionStorage.setItem('newco_current_member', JSON.stringify(member));

                // Check if loyalty program is enabled
                const rewards = NewcoData.get('rewards') || {};
                const wizardData = NewcoData.get('wizardData') || {};
                const loyaltyEnabled = rewards.enabled !== undefined ? rewards.enabled : (wizardData.rewards?.enabled !== undefined ? wizardData.rewards.enabled : true);

                // Get points currency name from rewards config
                const rewardsConfig = NewcoData.get('rewardsConfig') || {};
                const pointsCurrencyName = rewardsConfig.basicSettings?.pointsCurrencyName || 'Loyalty Points';

                // Normalize points field
                const points = member.currentPoints || member.loyaltyPoints || 0;

                // Update UI
                document.getElementById('memberInfo').innerHTML = `
                    <div style="display: flex; align-items: center; gap: ${loyaltyEnabled ? '3rem' : '2rem'};">
                        <span style="color: white; font-weight: 600; font-size: 1.1rem; ${loyaltyEnabled ? 'padding-right: 1rem; border-right: 1px solid rgba(255,255,255,0.3);' : ''}">Welcome, ${member.firstName}!</span>
                        ${loyaltyEnabled ? `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);">
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.875rem;">${pointsCurrencyName}:</span>
                            <span style="color: white; font-weight: 700; font-size: 1.1rem;">${points.toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                    <button onclick="showHistory()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; margin: 0 0.5rem;">History</button>
                    ${loyaltyEnabled ? `<button onclick="showRewardsStore()" style="background: #ffc107; border: none; color: #333; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-weight: 600;">🎁 Store</button>` : ''}
                    <button onclick="logout()" style="background: white; border: 1px solid white; color: var(--primary-color, #6c5ce7); padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-weight: 500;">Logout</button>
                `;
                
                closeAuthModal();
                
                // Show welcome message with member ID
                notify.modal({
                    title: 'Welcome Back!',
                    message: `Welcome ${member.firstName}!<br><br>Your Member ID is: <strong>${member.id || member.memberId || 'M' + Date.now()}</strong>`,
                    type: 'success',
                    buttons: [
                        { text: 'OK', type: 'primary', action: 'ok' }
                    ]
                });
                
                // Show event selection if no session selected
                if (!selectedSession) {
                    document.getElementById('eventSelection').style.display = 'block';
                    document.getElementById('packagesSection').style.display = 'none';
                } else {
                    // Reload packages to show loyalty pricing if applicable
                    loadPackages();
                }
            } else {
                notify.error('Invalid login credentials');
            }
        }
        
        window.doRegister = async function() {
            // Clear previous errors if they exist
            const registerError = document.getElementById('registerError');
            const emailError = document.getElementById('emailError');
            
            if (registerError) registerError.style.display = 'none';
            if (emailError) emailError.style.display = 'none';
            
            // Reset field borders
            ['regFirstName', 'regLastName', 'regEmail', 'regPassword'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.border = '1px solid #ddd';
            });
            
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;
            const dob = document.getElementById('regDOB').value;
            
            // Validation with visual feedback
            let hasErrors = false;
            let errorMessages = [];
            
            if (!firstName) {
                const field = document.getElementById('regFirstName');
                if (field) field.style.border = '1px solid #e74c3c';
                errorMessages.push('First name is required');
                hasErrors = true;
            }
            
            if (!lastName) {
                const field = document.getElementById('regLastName');
                if (field) field.style.border = '1px solid #e74c3c';
                errorMessages.push('Last name is required');
                hasErrors = true;
            }
            
            if (!email) {
                const field = document.getElementById('regEmail');
                if (field) field.style.border = '1px solid #e74c3c';
                errorMessages.push('Email is required');
                hasErrors = true;
            } else if (!email.includes('@') || !email.includes('.')) {
                const field = document.getElementById('regEmail');
                if (field) field.style.border = '1px solid #e74c3c';
                const errorEl = document.getElementById('emailError');
                if (errorEl) {
                    errorEl.textContent = 'Please enter a valid email address';
                    errorEl.style.display = 'block';
                }
                hasErrors = true;
            }
            
            if (!password) {
                const field = document.getElementById('regPassword');
                if (field) field.style.border = '1px solid #e74c3c';
                errorMessages.push('Password is required');
                hasErrors = true;
            } else if (password.length < 6) {
                const field = document.getElementById('regPassword');
                if (field) field.style.border = '1px solid #e74c3c';
                errorMessages.push('Password must be at least 6 characters');
                hasErrors = true;
            }
            
            if (hasErrors) {
                if (errorMessages.length > 0) {
                    const errorEl = document.getElementById('registerError');
                    if (errorEl) {
                        errorEl.textContent = errorMessages.join('. ');
                        errorEl.style.display = 'block';
                    } else {
                        notify.error(errorMessages.join('. '));
                    }
                }
                return;
            }
            
            try {
                // Check if email already exists
                const existingMembers = NewcoData.get('members') || [];
                if (existingMembers.find(m => m.email === email)) {
                    notify.error('An account with this email already exists');
                    return;
                }
                
                // Generate member ID
                const timestamp = Date.now();

                // Get rewards config from admin to determine welcome bonus
                const rewardsConfig = NewcoData.get('rewardsConfig') || {};
                let welcomeBonus = 0;

                // Only give welcome bonus if rewards are enabled
                if (rewardsConfig.rewardType && rewardsConfig.rewardType !== 'none') {
                    // Check if there's a specific welcome bonus amount, otherwise default to 0
                    welcomeBonus = rewardsConfig.welcomeBonus || 0;
                }

                // Generate UUID for member ID (Supabase requires UUID format)
                const memberId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                const newMember = {
                    id: memberId,
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: phone || '',
                    password: password,
                    dateOfBirth: dob || '',
                    address: {
                        street: '',
                        city: '',
                        state: '',
                        zip: ''
                    },
                    tier: 'bronze',
                    lifetimePoints: welcomeBonus,
                    currentPoints: welcomeBonus,
                    lifetimeSpend: 0,
                    barcode: 'MEMBER' + timestamp.toString().padStart(13, '0'),
                    status: 'active',
                    preferredHall: null,
                    emailOptIn: true,
                    smsOptIn: false,
                    notes: 'Registered online',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastVisit: new Date().toISOString()
                };
                
                // Add to existing members array
                existingMembers.push(newMember);

                // Save to Supabase using NewcoData
                const saved = await NewcoData.set('members', existingMembers);

                if (!saved) {
                    notify.error('Error saving member data. Please try again.');
                    return;
                }
                
                // Create reward transaction for welcome bonus if points were given
                if (welcomeBonus > 0) {
                    const rewardTransactions = NewcoData.get('rewardsTransactions') || [];
                    rewardTransactions.push({
                        id: 'reward_' + timestamp + '_welcome',
                        date: new Date().toISOString(),
                        memberId: newMember.id,
                        memberName: newMember.firstName + ' ' + newMember.lastName,
                        type: 'earned',
                        source: 'registration',
                        description: 'Welcome bonus for new member',
                        points: welcomeBonus,
                        balance: welcomeBonus,
                        transactionId: null
                    });
                    NewcoData.set('rewardsTransactions', rewardTransactions);
                }
                
                // Auto-login
                sessionStorage.setItem('newco_current_member', JSON.stringify(newMember));

                // Check if loyalty program is enabled
                const rewards = NewcoData.get('rewards') || {};
                const wizData = NewcoData.get('wizardData') || {};
                const loyaltyEnabled = rewards.enabled !== undefined ? rewards.enabled : (wizData.rewards?.enabled !== undefined ? wizData.rewards.enabled : true);

                // Update UI
                const pointsCurrencyName = rewardsConfig.basicSettings?.pointsCurrencyName || 'Loyalty Points';
                const points = newMember.currentPoints || newMember.loyaltyPoints || 0;
                document.getElementById('memberInfo').innerHTML = `
                    <div style="display: flex; align-items: center; gap: ${loyaltyEnabled ? '3rem' : '2rem'};">
                        <span style="color: white; font-weight: 600; font-size: 1.1rem; ${loyaltyEnabled ? 'padding-right: 1rem; border-right: 1px solid rgba(255,255,255,0.3);' : ''}">Welcome, ${newMember.firstName}!</span>
                        ${loyaltyEnabled ? `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);">
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.875rem;">${pointsCurrencyName}:</span>
                            <span style="color: white; font-weight: 700; font-size: 1.1rem;">${points.toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                    <button onclick="showHistory()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; margin: 0 0.5rem;">History</button>
                    ${loyaltyEnabled ? `<button onclick="showRewardsStore()" style="background: #ffc107; border: none; color: #333; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-weight: 600;">🎁 Store</button>` : ''}
                    <button onclick="logout()" style="background: white; border: 1px solid white; color: var(--primary-color, #6c5ce7); padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-weight: 500;">Logout</button>
                `;
                
                closeAuthModal();
                
                // Show welcome modal with member ID
                let welcomeMsg = `Welcome ${firstName}!<br><br>Your Member ID is: <strong>${memberId}</strong>`;
                if (welcomeBonus > 0) {
                    welcomeMsg = `Welcome ${firstName}!<br><br>You've received <strong>${welcomeBonus} loyalty points</strong> as a welcome bonus!<br><br>Your Member ID is: <strong>${memberId}</strong>`;
                }
                
                notify.modal({
                    title: 'Registration Successful!',
                    message: welcomeMsg,
                    type: 'success',
                    buttons: [
                        { text: 'OK', type: 'primary', action: 'ok' }
                    ]
                });
                
                // Show event selection for new user if elements exist
                const eventSelection = document.getElementById('eventSelection');
                const packagesSection = document.getElementById('packagesSection');
                if (eventSelection) eventSelection.style.display = 'block';
                if (packagesSection) packagesSection.style.display = 'none';
                
                // Clear any previous session selection
                selectedSession = null;
                
                console.log('Member registered successfully:', newMember);
                console.log('Total members now:', existingMembers.length);
                
            } catch (error) {
                console.error('Registration error:', error);
                notify.error('An error occurred during registration. Please try again.');
            }
        }
        
        window.logout = function() {
            sessionStorage.removeItem('newco_current_member');
            
            // Clear cart on logout
            cart = {
                items: [],
                subtotal: 0,
                tax: 0,
                total: 0
            };
            sessionStorage.removeItem('newco_cart');
            updateCartDisplay();
            
            document.getElementById('memberInfo').innerHTML = `
                <button class="login-btn" onclick="showLogin()">Login / Register</button>
            `;
            // Reload packages to hide loyalty pricing
            loadPackages();
        }

        // Seat reservation functions
        function getMaxSeatsPerUser() {
            // Get the max seats setting from venue config or default to 1
            const venueSettings = NewcoData.get('venueSettings') || {};
            return venueSettings.maxSeatsPerUser || 1;
        }
        
        function getReservedSeatsForSession(sessionKey) {
            const transactions = NewcoData.get('transactions') || [];
            const seatReservations = NewcoData.get('seatReservations') || {};
            const reservedSeats = new Set();

            // Get seats from completed transactions for this session and day
            transactions.forEach(trans => {
                const transKey = `${trans.sessionId}_${trans.sessionDate}`;
                if (transKey === sessionKey && trans.selectedSeat) {
                    reservedSeats.add(trans.selectedSeat);
                }
                // Also check if seats array exists (for multiple seats per transaction)
                if (transKey === sessionKey && trans.selectedSeats) {
                    if (Array.isArray(trans.selectedSeats)) {
                        trans.selectedSeats.forEach(seatId => reservedSeats.add(seatId));
                    }
                }
            });

            // Also check seat reservations storage for this session/day
            if (seatReservations[sessionKey]) {
                seatReservations[sessionKey].forEach(seatId => reservedSeats.add(seatId));
            }

            return reservedSeats;
        }
        
        function getUserSeatsForSession(sessionKey, memberId) {
            if (!memberId) return new Set();

            const transactions = NewcoData.get('transactions') || [];
            const userSeats = new Set();

            // Get seats this user has already purchased for this session and day
            transactions.forEach(trans => {
                const transKey = `${trans.sessionId}_${trans.sessionDate}`;
                if (transKey === sessionKey && trans.memberId === memberId) {
                    if (trans.selectedSeat) {
                        userSeats.add(trans.selectedSeat);
                    }
                    if (trans.selectedSeats && Array.isArray(trans.selectedSeats)) {
                        trans.selectedSeats.forEach(seatId => userSeats.add(seatId));
                    }
                }
            });

            return userSeats;
        }
        
        function getUserSeatCountForSession(sessionKey, memberId) {
            // Returns the number of seats this user has for this session/day
            const userSeats = getUserSeatsForSession(sessionKey, memberId);
            return userSeats.size;
        }
        
        function canUserSelectMoreSeats(sessionKey, memberId) {
            // Check if user can select more seats for this session/day
            const maxSeats = getMaxSeatsPerUser();
            const currentSeats = getUserSeatCountForSession(sessionKey, memberId);
            return currentSeats < maxSeats;
        }
        
        // ═══════════════════════════════════════════════════════════
        // [CHECKOUT] - Payment Processing & Order Completion
        // ═══════════════════════════════════════════════════════════
        
        window.checkout = async function() {
            // Check if cart is empty
            if (cart.items.length === 0) {
                notify.warning('Your cart is empty');
                return;
            }

            // Check if session is selected
            if (!cart.sessionId || !cart.sessionDate) {
                notify.warning('Please select a session first');
                return;
            }

            // Check if user is logged in
            const memberData = sessionStorage.getItem('newco_current_member');
            if (!memberData) {
                notify.info('Please login or register to checkout');
                showLogin();
                return;
            }

            // Refresh data from Supabase to get latest seat reservations
            const custData = await NewcoData.read_cust();
            if (custData.seatReservations) {
                NewcoData.cache.seatReservations = custData.seatReservations;
            }
            if (custData.transactions) {
                NewcoData.cache.transactions = custData.transactions;
            }

            const member = JSON.parse(memberData);
            const settings = NewcoData.get('settings') || {};
            
            // Debug log settings to see what's actually loaded
            console.log('Full settings object:', settings);
            console.log('Payment Card enabled:', settings.paymentCard);
            console.log('Payment Cash enabled:', settings.paymentCash);
            console.log('Type of paymentCard:', typeof settings.paymentCard);
            console.log('Type of paymentCash:', typeof settings.paymentCash);
            
            // If settings exist but both are false, at least enable one
            if (settings.paymentCard === false && settings.paymentCash === false && settings.paymentCheck !== true) {
                console.log('All payment methods disabled, enabling card as fallback');
                settings.paymentCard = true;
            }
            
            // If no settings exist at all, default to card
            if (settings.paymentCard === undefined && settings.paymentCash === undefined && settings.paymentCheck === undefined) {
                console.log('No payment methods configured, defaulting to card enabled');
                settings.paymentCard = true;
            }
            
            // Create checkout modal
            const modal = document.createElement('div');
            modal.id = 'checkoutModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                overflow-y: auto;
            `;
            
            // Check if any packages need seat selection
            const packagesNeedingSeats = cart.items.filter(item => 
                item.type === 'package' && item.requiresSeat
            );
            
            // Check if user already has max seats for this session/day
            const sessionKey = `${cart.sessionId}_${cart.sessionDate}`;
            const userCanSelectSeats = canUserSelectMoreSeats(sessionKey, member.id);
            const userCurrentSeats = getUserSeatsForSession(sessionKey, member.id);
            const maxSeats = getMaxSeatsPerUser();
            const currentSeatCount = userCurrentSeats.size;
            
            // If packages need seats but user is at max, show their existing seat(s)
            const showSeatSelection = packagesNeedingSeats.length > 0 && userCanSelectSeats;
            const showExistingSeats = packagesNeedingSeats.length > 0 && !userCanSelectSeats && currentSeatCount > 0;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; width: 95%; max-width: 1800px; max-height: 95vh; overflow-y: auto; position: relative;">
                    <button onclick="closeCheckoutModal()" style="position: absolute; right: 1rem; top: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>

                    <h2 style="margin: 0 0 1.5rem 0; color: #333;">Checkout</h2>
                    
                    <!-- Seat Selection (if needed and allowed) -->
                    ${showSeatSelection ? `
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #2196f3;">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1976d2;">Select Your Seat</h3>
                            <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                You have ${currentSeatCount} of ${maxSeats} allowed seat(s) for this session.
                            </div>
                            <div id="seatMapContainer" style="background: white; padding: 0; border-radius: 8px; overflow: hidden;">
                                <!-- Hardcoded map will be loaded here -->
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Show existing seats if at max -->
                    ${showExistingSeats ? `
                        <div style="background: #c8e6c9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #4caf50;">
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; color: #2e7d32;">Your Seat is Already Reserved</h3>
                            <div style="color: #1b5e20; font-weight: 600;">
                                Seat(s): ${Array.from(userCurrentSeats).join(', ')}
                            </div>
                            <div style="color: #666; font-size: 0.875rem; margin-top: 0.5rem;">
                                You have reached the maximum of ${maxSeats} seat(s) for this session.
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Order Summary -->
                    <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem;">Order Summary</h3>
                        ${cart.items.map(item => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>${item.name} x${item.quantity}</span>
                                <span>$${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        <div style="border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Subtotal:</span>
                                <span>$${cart.subtotal.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Tax:</span>
                                <span>$${cart.tax.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.125rem;">
                                <span>Total:</span>
                                <span>$${cart.total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem;">Payment Method</h3>
                        <div style="display: grid; gap: 1rem;">
                            ${settings.paymentCard ? `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="paymentMethod" value="card" checked onchange="selectPaymentMethod('card')">
                                    <span>Credit/Debit Card</span>
                                </label>
                            ` : ''}
                            ${settings.paymentCash ? `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="paymentMethod" value="cash" ${!settings.paymentCard ? 'checked' : ''} onchange="selectPaymentMethod('cash')">
                                    <span>Cash at Hall</span>
                                </label>
                            ` : ''}
                            ${!settings.paymentCard && !settings.paymentCash ? `
                                <div style="padding: 1rem; background: #f5f5f5; border-radius: 8px; color: #666;">
                                    <p style="margin: 0;">No payment methods are enabled. Please contact the administrator.</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Card Details (shown only if card payment is selected) -->
                    <div id="cardDetails" style="margin-bottom: 1.5rem; ${!settings.paymentCard ? 'display: none;' : ''}">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.125rem;">
                                Card Details <span style="color: #dc3545;">*</span>
                            </h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 25'%3E%3Cpath fill='%23635bff' d='M59.64 14.28h-8.06c.19 1.93 1.6 2.55 3.2 2.55 1.64 0 2.96-.37 4.05-.95v3.32a8.33 8.33 0 01-4.56 1.1c-4.01 0-6.83-2.5-6.83-7.48 0-4.19 2.39-7.52 6.3-7.52 3.92 0 5.96 3.28 5.96 7.5 0 .4-.04 1.26-.06 1.48zm-5.92-5.62c-1.03 0-2.17.73-2.17 2.58h4.25c0-1.85-1.07-2.58-2.08-2.58zM40.95 20.3c-1.44 0-2.32-.6-2.9-1.04l-.02 4.63-4.12.87V5.57h3.76l.08 1.02a4.7 4.7 0 013.23-1.29c2.9 0 5.62 2.6 5.62 7.4 0 5.23-2.7 7.6-5.65 7.6zM40 8.95c-.95 0-1.54.34-1.97.81l.02 6.12c.4.44.98.78 1.95.78 1.52 0 2.54-1.65 2.54-3.87 0-2.15-1.04-3.84-2.54-3.84zM28.24 5.57h4.13v14.44h-4.13V5.57zm0-4.7L32.37 0v3.36l-4.13.88V.88zm-4.32 9.35v9.79H19.8V5.57h3.7l.12 1.22c1-1.77 3.07-1.41 3.62-1.22v3.79c-.52-.17-2.29-.43-3.32.86zm-8.55 4.72c0 2.43 2.6 1.68 3.12 1.46v3.36c-.55.3-1.54.54-2.89.54a4.15 4.15 0 01-4.27-4.24l.01-13.17 4.02-.86v3.54h3.14V9.1h-3.13v5.85zm-4.91.7c0 2.97-2.31 4.66-5.73 4.66a11.2 11.2 0 01-4.46-.93v-3.93c1.38.75 3.1 1.31 4.46 1.31.92 0 1.53-.24 1.53-1C6.26 13.77 0 14.51 0 9.95 0 7.04 2.28 5.3 5.62 5.3c1.36 0 2.72.2 4.09.75v3.88a9.23 9.23 0 00-4.1-1.06c-.86 0-1.44.25-1.44.9 0 1.85 6.29.97 6.29 5.88z'/%3E%3C/svg%3E" alt="Stripe" style="height: 20px;">
                                ${STRIPE_TEST_MODE ? `<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">TEST MODE</span>` : ''}
                            </div>
                        </div>

                        ${STRIPE_TEST_MODE ? `
                            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                <div style="color: #856404; font-size: 0.875rem; margin-bottom: 0.75rem;">
                                    ⓘ This is a test Stripe integration. No real charges will be made. This will switch to live mode when you upgrade from trial.
                                </div>
                                <button onclick="fillTestCardData()" type="button" style="background: #6c5ce7; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">
                                    Fill Details
                                </button>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">
                                Card Information <span style="color: #dc3545;">*</span>
                            </label>
                            ${STRIPE_TEST_MODE ? `
                                <!-- Fake Stripe look for test mode -->
                                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: white;">
                                    <input type="text" id="fakeCardNumber" placeholder="1234 1234 1234 1234" maxlength="19" style="width: 100%; border: none; outline: none; font-size: 1rem; margin-bottom: 0.75rem;" oninput="formatCardNumber(this)">
                                    <div style="display: flex; gap: 1rem;">
                                        <input type="text" id="fakeCardExpiry" placeholder="MM / YY" maxlength="7" style="flex: 1; border: none; outline: none; font-size: 1rem; border-top: 1px solid #e0e0e0; padding-top: 0.75rem;" oninput="formatExpiry(this)">
                                        <input type="text" id="fakeCardCVC" placeholder="CVC" maxlength="3" style="flex: 1; border: none; outline: none; font-size: 1rem; border-top: 1px solid #e0e0e0; padding-top: 0.75rem;">
                                    </div>
                                </div>
                            ` : `
                                <!-- Real Stripe Elements for live mode -->
                                <div id="card-element" style="padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white;"></div>
                            `}
                            <div id="card-errors" role="alert" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.5rem;"></div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">
                                Cardholder Name <span style="color: #dc3545;">*</span>
                            </label>
                            <input type="text" id="cardholderName" placeholder="Name on card" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">
                                Billing ZIP Code <span style="color: #dc3545;">*</span>
                            </label>
                            <input type="text" id="billingZip" placeholder="ZIP Code" maxlength="10" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                    </div>
                    
                    <!-- Final Total -->
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: bold;">
                            <span>Amount to Pay:</span>
                            <span id="finalTotal">$${cart.total.toFixed(2)}</span>
                        </div>
                        <div id="pointsDiscount" style="display: none; color: #27ae60; margin-top: 0.5rem;">
                            <span>Loyalty Discount: -$<span id="discountAmount">0.00</span></span>
                        </div>
                    </div>
                    
                    <!-- Place Order Button -->
                    <button id="placeOrderBtn" onclick="placeOrder()" style="width: 100%; padding: 1rem; background: ${(settings.paymentCard || settings.paymentCash) ? '#27ae60' : '#ccc'}; color: white; border: none; border-radius: 8px; font-size: 1.125rem; font-weight: bold; cursor: ${(settings.paymentCard || settings.paymentCash) ? 'pointer' : 'not-allowed'};" ${!(settings.paymentCard || settings.paymentCash) ? 'disabled' : ''}>
                        Place Order
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Initialize Stripe Elements ONLY in live mode
            if (settings.paymentCard && !STRIPE_TEST_MODE) {
                setTimeout(() => {
                    if (!cardElement) {
                        elements = stripe.elements();
                        cardElement = elements.create('card', {
                            style: {
                                base: {
                                    fontSize: '16px',
                                    color: '#32325d',
                                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                                    '::placeholder': {
                                        color: '#aab7c4'
                                    }
                                },
                                invalid: {
                                    color: '#dc3545'
                                }
                            }
                        });
                        cardElement.mount('#card-element');

                        // Handle real-time validation errors
                        cardElement.on('change', (event) => {
                            const displayError = document.getElementById('card-errors');
                            if (displayError) {
                                if (event.error) {
                                    displayError.textContent = event.error.message;
                                } else {
                                    displayError.textContent = '';
                                }
                            }
                        });
                    }
                }, 100);
            }

            // Load Milpitas grid-based seat map if seat selection is shown
            // Load appropriate seat map based on hall configuration
            if (showSeatSelection) {
                const halls = NewcoData.get('halls') || [];
                const hall = halls[0]; // Single hall
                const seatingType = hall?.seatingMapType || 'none';

                setTimeout(() => {
                    const container = document.getElementById('seatMapContainer');

                    if (seatingType === 'prebuilt' && hall?.prebuiltMapCode && hall?.prebuiltMapFunction) {
                        // Load prebuilt map
                        try {
                            eval(hall.prebuiltMapCode);
                            if (window[hall.prebuiltMapFunction]) {
                                window[hall.prebuiltMapFunction]('seatMapContainer');
                                // Mark reserved seats only for prebuilt maps (they use data-seat attribute)
                                markReservedSeats();
                            }
                        } catch (error) {
                            console.error('Error loading prebuilt map:', error);
                            container.innerHTML = '<div style="color: #999; text-align: center; padding: 2rem;">Error loading seat map</div>';
                        }
                    } else if (seatingType === 'manual' && hall?.layout) {
                        // Render manual grid layout (already handles reserved seats during rendering)
                        container.innerHTML = renderSeatMap();
                    } else {
                        // No seating map configured
                        container.innerHTML = '<div style="color: #999; text-align: center; padding: 2rem;">No seating map configured</div>';
                    }
                }, 100);
            }

            // Store checkout data globally for access
            window.checkoutData = {
                member: member,
                paymentMethod: 'card',
                loyaltyPointsUsed: 0,
                selectedSeat: null // Single seat selection
            };
        }
        
        // ═══════════════════════════════════════════════════════════
        // [SEAT-SELECTION] - Interactive Seat Selection System
        // ═══════════════════════════════════════════════════════════
        
        function renderSeatMap() {
            // Get the hall layout (single hall only)
            const halls = NewcoData.get('halls') || [];
            const hall = halls[0];

            if (!hall || !hall.layout) {
                return '<div style="color: #999; text-align: center; padding: 2rem;">Hall layout not configured</div>';
            }
            
            const layout = hall.layout;
            const rows = layout.rows || layout.height || 10;
            const cols = layout.cols || layout.width || 10;
            const cells = layout.cells || {};
            
            // Get reserved seats for this session INCLUDING the day
            const sessionKey = `${cart.sessionId}_${cart.sessionDate}`;
            const reservedSeats = getReservedSeatsForSession(sessionKey);
            const memberData = sessionStorage.getItem('newco_current_member');
            const member = memberData ? JSON.parse(memberData) : null;
            const userSeats = member ? getUserSeatsForSession(sessionKey, member.id) : new Set();
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                    <strong>STAGE / CALLER</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(${cols}, 45px); gap: 2px; justify-content: center;">
            `;
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cellKey = `${r}-${c}`;
                    const cellData = cells[cellKey] || { type: 'empty' };
                    
                    if (cellData.type === 'table' && cellData.tableNumber) {
                        // Each square is an individual seat - use row/column position
                        const seatId = `R${r+1}C${c+1}`;
                        const tableNum = cellData.tableNumber;
                        const isReserved = reservedSeats.has(seatId);
                        const isUserSeat = userSeats.has(seatId);
                        const isDisabled = isReserved && !isUserSeat;
                        const isSelected = window.checkoutData && window.checkoutData.selectedSeat === seatId;
                        
                        // Determine seat background color with proper priority
                        let bgColor = '#ffffff'; // Default: available
                        if (isUserSeat) {
                            bgColor = '#4caf50'; // Green: user's seat
                        } else if (isReserved) {
                            bgColor = '#e91e63'; // Pink/Red: reserved by others
                        } else if (isSelected) {
                            bgColor = '#1976d2'; // Blue: currently selected
                        }
                        
                        html += `
                            <button 
                                id="seat_${seatId}"
                                class="seat-btn"
                                onclick="selectSeat('${seatId}')"
                                style="
                                    width: 45px;
                                    height: 45px;
                                    padding: 2px;
                                    border: 2px solid ${isSelected ? '#1976d2' : (isReserved ? '#e91e63' : '#ddd')};
                                    background: ${bgColor};
                                    color: ${isUserSeat || isReserved || isSelected ? 'white' : '#333'};
                                    border-radius: 4px;
                                    cursor: ${isDisabled ? 'not-allowed' : 'pointer'};
                                    font-size: 10px;
                                    font-weight: bold;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    justify-content: center;
                                    line-height: 1;
                                    opacity: ${isDisabled ? '0.6' : '1'};
                                "
                                ${isDisabled ? 'disabled' : ''}
                                title="${isUserSeat ? 'Your seat' : (isReserved ? 'Reserved - Not Available' : `Table ${tableNum}, Row ${r+1}, Col ${c+1}`)}"
                            >
                                <div>T${tableNum}</div>
                                <div style="font-size: 8px; margin-top: 2px;">S${(r*cols + c + 1)}</div>
                            </button>
                        `;
                    } else if (cellData.type === 'blocked') {
                        html += '<div style="width: 45px; height: 45px; background: #333;"></div>';
                    } else if (cellData.type === 'entrance') {
                        // Don't show entrance in order view
                        html += '<div style="width: 45px; height: 45px;"></div>';
                    } else if (cellData.type === 'restroom') {
                        html += '<div style="width: 45px; height: 45px; background: #2196f3; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: white;">🚻</div>';
                    } else if (cellData.type === 'vip') {
                        html += '<div style="width: 45px; height: 45px; background: #ffd700; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">⭐</div>';
                    } else if (cellData.type === 'caller') {
                        // Don't show caller station in order view
                        html += '<div style="width: 45px; height: 45px;"></div>';
                    } else {
                        html += '<div style="width: 45px; height: 45px;"></div>'; // Empty cell
                    }
                }
            }
            
            html += `
                </div>
                <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 2rem; font-size: 0.875rem;">
                    <div><span style="display: inline-block; width: 20px; height: 20px; background: #ffffff; border: 1px solid #ddd; vertical-align: middle;"></span> Available</div>
                    <div><span style="display: inline-block; width: 20px; height: 20px; background: #1976d2; border: 1px solid #1976d2; vertical-align: middle;"></span> Selected</div>
                    <div><span style="display: inline-block; width: 20px; height: 20px; background: #e91e63; border: 1px solid #e91e63; vertical-align: middle;"></span> Reserved</div>
                    <div><span style="display: inline-block; width: 20px; height: 20px; background: #4caf50; border: 1px solid #4caf50; vertical-align: middle;"></span> Your Seat</div>
                </div>
                <div id="selectedSeatDisplay" style="margin-top: 1rem; font-weight: 600; color: #1976d2;">
                    Selected: None (Choose 1 seat)
                </div>
            `;
            
            return html;
        }
        
        window.selectSeat = function(seatId) {
            const seatBtn = document.getElementById(`seat_${seatId}`);
            if (!seatBtn || seatBtn.disabled) return;
            
            // Check if user can select more seats
            const sessionKey = `${cart.sessionId}_${cart.sessionDate}`;
            const member = JSON.parse(sessionStorage.getItem('newco_current_member') || '{}');
            
            if (!canUserSelectMoreSeats(sessionKey, member.id)) {
                notify.warning(`You have reached the maximum of ${getMaxSeatsPerUser()} seat(s) for this session.`);
                return;
            }
            
            // Check if this seat is already selected
            if (window.checkoutData.selectedSeat === seatId) {
                // Deselect seat
                window.checkoutData.selectedSeat = null;
                seatBtn.style.background = '#ffffff';
                seatBtn.style.color = '#333';
                seatBtn.style.border = '2px solid #ddd';
                
                // Update display
                const displayDiv = document.getElementById('selectedSeatDisplay');
                if (displayDiv) {
                    displayDiv.innerHTML = 'Selected: None (Choose 1 seat)';
                    displayDiv.style.color = '#1976d2';
                }
            } else {
                // Deselect any previously selected seat
                if (window.checkoutData.selectedSeat) {
                    const prevSeatBtn = document.getElementById(`seat_${window.checkoutData.selectedSeat}`);
                    if (prevSeatBtn && !prevSeatBtn.disabled) {
                        prevSeatBtn.style.background = '#ffffff';
                        prevSeatBtn.style.color = '#333';
                        prevSeatBtn.style.border = '2px solid #ddd';
                    }
                }
                
                // Select this seat
                window.checkoutData.selectedSeat = seatId;
                seatBtn.style.background = '#1976d2';
                seatBtn.style.color = 'white';
                seatBtn.style.border = '2px solid #1976d2';
                
                // Update display
                const displayDiv = document.getElementById('selectedSeatDisplay');
                if (displayDiv) {
                    displayDiv.innerHTML = `Selected: ${seatId} ✓`;
                    displayDiv.style.color = '#1976d2';
                }
            }
        }
        
        window.closeCheckoutModal = function() {
            const modal = document.getElementById('checkoutModal');
            if (modal) {
                modal.remove();
            }
            window.checkoutData = null;
        }

        // Handler for prebuilt map seat selection (called by prebuilt maps like milpitas-grid-map.js)
        window.handleSeatSelection = function(seatNumber, isSelected) {
            if (!window.checkoutData) return;

            if (isSelected) {
                // Deselect any previously selected seat
                document.querySelectorAll('.seat-btn.selected').forEach(btn => {
                    if (btn.dataset.seat !== seatNumber) {
                        btn.classList.remove('selected');
                    }
                });

                // Store selected seat
                window.checkoutData.selectedSeat = seatNumber;

                // Update display
                const displayDiv = document.getElementById('selectedSeatDisplay');
                if (displayDiv) {
                    displayDiv.innerHTML = `Selected: ${seatNumber} ✓`;
                    displayDiv.style.color = '#4CAF50';
                }
            } else {
                // Deselect
                window.checkoutData.selectedSeat = null;
                const displayDiv = document.getElementById('selectedSeatDisplay');
                if (displayDiv) {
                    displayDiv.innerHTML = 'No seat selected';
                    displayDiv.style.color = '#999';
                }
            }
        }

        // Handler for manual grid seat selection (called by renderSeatMap)
        window.selectSeat = function(seatId) {
            if (!window.checkoutData) return;

            const seatBtn = document.getElementById(`seat_${seatId}`);
            if (!seatBtn || seatBtn.disabled) return;

            // Check if this seat is already selected
            const isCurrentlySelected = window.checkoutData.selectedSeat === seatId;

            // Deselect all seats first
            document.querySelectorAll('.seat-btn').forEach(btn => {
                const btnSeatId = btn.id.replace('seat_', '');
                if (btn.id.startsWith('seat_') && btnSeatId !== seatId) {
                    btn.style.background = '#ffffff';
                    btn.style.border = '2px solid #ddd';
                    btn.style.color = '#333';
                }
            });

            if (isCurrentlySelected) {
                // Deselect this seat
                window.checkoutData.selectedSeat = null;
                seatBtn.style.background = '#ffffff';
                seatBtn.style.border = '2px solid #ddd';
                seatBtn.style.color = '#333';
            } else {
                // Select this seat
                window.checkoutData.selectedSeat = seatId;
                seatBtn.style.background = '#1976d2';
                seatBtn.style.border = '2px solid #1976d2';
                seatBtn.style.color = 'white';
            }
        }

        // Mark already reserved seats on the hardcoded map
        function markReservedSeats() {
            if (!cart.sessionId || !cart.sessionDate) {
                return;
            }

            const sessionKey = `${cart.sessionId}_${cart.sessionDate}`;
            const reservedSeatsForSession = getReservedSeatsForSession(sessionKey);

            // Mark all reserved seats
            reservedSeatsForSession.forEach(seatId => {
                const seatBtn = document.querySelector(`[data-seat="${seatId}"]`);
                if (seatBtn) {
                    seatBtn.classList.add('reserved');
                    seatBtn.disabled = true;
                }
            });

            // If user already has a seat, pre-select it
            if (window.checkoutData && window.checkoutData.member) {
                const userSeats = getUserSeatsForSession(sessionKey, window.checkoutData.member.id);
                userSeats.forEach(seatId => {
                    const seatBtn = document.querySelector(`[data-seat="${seatId}"]`);
                    if (seatBtn) {
                        seatBtn.classList.remove('reserved');
                        seatBtn.classList.add('selected');
                        seatBtn.disabled = false;
                        window.checkoutData.selectedSeat = seatId;

                        const displayDiv = document.getElementById('selectedSeatDisplay');
                        if (displayDiv) {
                            displayDiv.innerHTML = `Selected: ${seatId} ✓`;
                            displayDiv.style.color = '#4CAF50';
                        }
                    }
                });
            }
        }
        
        // ═══════════════════════════════════════════════════════════
        // [LOYALTY-POINTS] - Points System & Redemption
        // ═══════════════════════════════════════════════════════════
        
        window.toggleLoyaltyPoints = function() {
            const checkbox = document.getElementById('useLoyaltyPoints');
            const input = document.getElementById('loyaltyPointsInput');
            
            if (checkbox.checked) {
                input.style.display = 'block';
                // Suggest using points to cover total or all available points
                const memberPoints = window.checkoutData.member.currentPoints || window.checkoutData.member.loyaltyPoints || 0;
                const maxPoints = Math.min(memberPoints, Math.floor(cart.total * 100));
                document.getElementById('pointsToUse').value = maxPoints;
                updateCheckoutTotal();
            } else {
                input.style.display = 'none';
                document.getElementById('pointsToUse').value = 0;
                updateCheckoutTotal();
            }
        }

        window.formatCardNumber = function(input) {
            let value = input.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            input.value = formattedValue;
        }

        window.formatExpiry = function(input) {
            let value = input.value.replace(/\s/g, '').replace(/\//g, '');
            if (value.length >= 2) {
                input.value = value.slice(0, 2) + ' / ' + value.slice(2, 4);
            } else {
                input.value = value;
            }
        }

        window.fillTestCardData = function() {
            // Fill test card data
            if (STRIPE_TEST_MODE) {
                document.getElementById('fakeCardNumber').value = '4242 4242 4242 4242';
                document.getElementById('fakeCardExpiry').value = '12 / 25';
                document.getElementById('fakeCardCVC').value = '123';
            }
            document.getElementById('cardholderName').value = 'Test User';
            document.getElementById('billingZip').value = '12345';
        }

        window.updateCheckoutTotal = function() {
            const pointsToUse = parseInt(document.getElementById('pointsToUse').value) || 0;
            const memberPoints = window.checkoutData.member.currentPoints || window.checkoutData.member.loyaltyPoints || 0;
            const maxPoints = Math.min(memberPoints, Math.floor(cart.total * 100));
            
            if (pointsToUse > maxPoints) {
                document.getElementById('pointsToUse').value = maxPoints;
                window.checkoutData.loyaltyPointsUsed = maxPoints;
            } else {
                window.checkoutData.loyaltyPointsUsed = pointsToUse;
            }
            
            const discount = window.checkoutData.loyaltyPointsUsed / 100;
            const finalTotal = Math.max(0, cart.total - discount);
            
            document.getElementById('finalTotal').textContent = `$${finalTotal.toFixed(2)}`;
            
            if (discount > 0) {
                document.getElementById('pointsDiscount').style.display = 'block';
                document.getElementById('discountAmount').textContent = discount.toFixed(2);
            } else {
                document.getElementById('pointsDiscount').style.display = 'none';
            }
        }
        
        window.selectPaymentMethod = function(method) {
            window.checkoutData.paymentMethod = method;
            const cardDetails = document.getElementById('cardDetails');

            if (method === 'cash') {
                cardDetails.style.display = 'none';
            } else {
                cardDetails.style.display = 'block';
                // Card element is already initialized when modal opened
            }
        }
        
        window.placeOrder = async function() {
            // Check if payment method is selected
            if (!window.checkoutData || !window.checkoutData.paymentMethod) {
                notify.warning('Please select a payment method');
                return;
            }

            // If card payment, validate fields
            if (window.checkoutData.paymentMethod === 'card') {
                // Validate required fields
                const cardholderName = document.getElementById('cardholderName')?.value.trim();
                const billingZip = document.getElementById('billingZip')?.value.trim();

                if (!cardholderName) {
                    notify.error('Please enter the cardholder name');
                    document.getElementById('cardholderName')?.focus();
                    return;
                }

                if (!billingZip) {
                    notify.error('Please enter the billing ZIP code');
                    document.getElementById('billingZip')?.focus();
                    return;
                }

                // Validate card fields based on mode
                if (STRIPE_TEST_MODE) {
                    // Test mode - validate fake fields
                    const cardNumber = document.getElementById('fakeCardNumber')?.value.trim();
                    const cardExpiry = document.getElementById('fakeCardExpiry')?.value.trim();
                    const cardCVC = document.getElementById('fakeCardCVC')?.value.trim();

                    if (!cardNumber) {
                        notify.error('Please enter a card number');
                        document.getElementById('fakeCardNumber')?.focus();
                        return;
                    }
                    if (!cardExpiry) {
                        notify.error('Please enter the expiry date');
                        document.getElementById('fakeCardExpiry')?.focus();
                        return;
                    }
                    if (!cardCVC) {
                        notify.error('Please enter the CVC');
                        document.getElementById('fakeCardCVC')?.focus();
                        return;
                    }

                    // Store test payment info
                    window.checkoutData.stripePaymentMethodId = 'pm_test_' + Date.now();
                } else {
                    // Live mode - process with real Stripe
                    if (!cardElement) {
                        notify.error('Card details not loaded. Please try again.');
                        return;
                    }

                    const discount = window.checkoutData.loyaltyPointsUsed / 100;
                    const finalTotal = Math.max(0, cart.total - discount);

                    try {
                        const {paymentMethod, error} = await stripe.createPaymentMethod({
                            type: 'card',
                            card: cardElement,
                            billing_details: {
                                name: cardholderName,
                                email: window.checkoutData.member.email,
                                address: {
                                    postal_code: billingZip
                                }
                            }
                        });

                        if (error) {
                            notify.error(error.message);
                            return;
                        }

                        // Store payment method ID for transaction record
                        window.checkoutData.stripePaymentMethodId = paymentMethod.id;
                        console.log('Stripe payment method created:', paymentMethod.id);
                    } catch (error) {
                        notify.error('Payment processing failed: ' + error.message);
                        return;
                    }
                }
            }
            
            // Check if seats need to be selected
            const packagesNeedingSeats = cart.items.filter(item => 
                item.type === 'package' && item.requiresSeat
            );
            
            // Get user's current seat status
            const sessionKey = `${cart.sessionId}_${cart.sessionDate}`;
            const userCanSelectSeats = canUserSelectMoreSeats(sessionKey, window.checkoutData.member.id);
            
            // Validate seat selection only if user can select more seats
            if (packagesNeedingSeats.length > 0 && userCanSelectSeats && !window.checkoutData.selectedSeat) {
                notify.warning('Please select a seat');
                return;
            }
            
            // If user is at max seats, use their existing seat
            if (packagesNeedingSeats.length > 0 && !userCanSelectSeats) {
                const existingSeats = getUserSeatsForSession(sessionKey, window.checkoutData.member.id);
                if (existingSeats.size > 0) {
                    // Use the first existing seat (since usually max is 1)
                    window.checkoutData.selectedSeat = Array.from(existingSeats)[0];
                    console.log('Using existing seat:', window.checkoutData.selectedSeat);
                }
            }
            
            // Calculate final amount
            const discount = window.checkoutData.loyaltyPointsUsed / 100;
            const finalTotal = Math.max(0, cart.total - discount);
            
            // Store selected seat (simple - just one seat per user)
            const selectedSeat = window.checkoutData.selectedSeat;
            
            // Create transaction record matching schema
            const transaction = {
                id: 'txn_' + Date.now(),
                type: 'purchase',
                date: new Date().toISOString(),
                memberId: window.checkoutData.member.id,
                memberName: `${window.checkoutData.member.firstName} ${window.checkoutData.member.lastName}`,
                memberEmail: window.checkoutData.member.email,
                sessionId: cart.sessionId,
                sessionName: cart.sessionName,
                sessionDate: cart.sessionDate, // Day of week (e.g., "Friday")
                items: cart.items,
                selectedSeat: selectedSeat,
                subtotal: cart.subtotal,
                tax: cart.tax,
                loyaltyDiscount: discount,
                finalTotal: finalTotal,
                loyaltyPointsUsed: window.checkoutData.loyaltyPointsUsed,
                loyaltyPointsEarned: 0, // Will be updated after calculation
                paymentMethod: window.checkoutData.paymentMethod,
                stripePaymentMethodId: window.checkoutData.stripePaymentMethodId || null,
                isTestTransaction: STRIPE_TEST_MODE && window.checkoutData.paymentMethod === 'card',
                status: window.checkoutData.paymentMethod === 'card' ? 'purchased' : 'pending',
                source: 'website',
                salesperson: 'Online',
                notes: '',
                timestamp: new Date().toISOString(),
                processedAt: new Date().toISOString()
            };
            
            // Update member's loyalty points
            const members = NewcoData.get('members') || [];
            const memberIndex = members.findIndex(m => m.id === window.checkoutData.member.id);
            
            let pointsEarned = 0;
            if (memberIndex !== -1) {
                // Deduct used points (from currentPoints)
                members[memberIndex].currentPoints = (members[memberIndex].currentPoints || 0) - window.checkoutData.loyaltyPointsUsed;

                // Update lifetimeSpend
                members[memberIndex].lifetimeSpend = (members[memberIndex].lifetimeSpend || 0) + finalTotal;

                // Add points earned from this purchase (only if rewards are enabled)
                const rewardsConfig = NewcoData.get('rewardsConfig') || {};
                if (rewardsConfig.rewardType && rewardsConfig.rewardType !== 'none') {
                    const pointsPerDollar = rewardsConfig.basicSettings?.webPointsPerDollar || rewardsConfig.webPointsPerDollar || 10;
                    pointsEarned = Math.floor(finalTotal * pointsPerDollar);
                    members[memberIndex].currentPoints += pointsEarned;
                    members[memberIndex].lifetimePoints = (members[memberIndex].lifetimePoints || 0) + pointsEarned;

                    // Update transaction with points earned
                    transaction.loyaltyPointsEarned = pointsEarned;
                }
                
                // Update spending stats
                members[memberIndex].totalSpent = (members[memberIndex].totalSpent || 0) + finalTotal;
                members[memberIndex].visits = (members[memberIndex].visits || 0) + 1;
                members[memberIndex].lastVisit = new Date().toISOString();
                
                NewcoData.set('members', members);

                // Update session
                window.checkoutData.member.currentPoints = members[memberIndex].currentPoints;
                sessionStorage.setItem('newco_current_member', JSON.stringify(window.checkoutData.member));
            }
            
            // Save transaction with updated loyaltyPointsEarned
            try {
                const transactions = NewcoData.get('transactions') || [];
                transactions.push(transaction);
                await NewcoData.set('transactions', transactions);
                
                // Also update seat reservations for this session/day in database
                if (transaction.selectedSeat) {
                    const seatReservations = NewcoData.get('seatReservations') || {};
                    const sessionKey = `${transaction.sessionId}_${transaction.sessionDate}`;

                    if (!seatReservations[sessionKey]) {
                        seatReservations[sessionKey] = [];
                    }

                    // Add the seat to reservations if not already there
                    if (!seatReservations[sessionKey].includes(transaction.selectedSeat)) {
                        seatReservations[sessionKey].push(transaction.selectedSeat);
                        await NewcoData.set('seatReservations', seatReservations);
                    }
                }
            } catch (error) {
                console.error('Error saving transaction:', error);
                notify.error('Error saving transaction: ' + error.message);
            }
            
            // Create reward transactions
            const rewardTransactions = NewcoData.get('rewardsTransactions') || [];

            // If points were redeemed
            if (window.checkoutData.loyaltyPointsUsed > 0) {
                rewardTransactions.push({
                    id: 'reward_' + Date.now() + '_redeem',
                    date: new Date().toISOString(),
                    memberId: window.checkoutData.member.id,
                    memberName: window.checkoutData.member.firstName + ' ' + window.checkoutData.member.lastName,
                    type: 'redemption',
                    source: 'website',
                    description: 'Points used for purchase',
                    points: -window.checkoutData.loyaltyPointsUsed,
                    balance: members[memberIndex]?.currentPoints || 0,
                    transactionId: transaction.id
                });
            }

            // If points were earned
            if (pointsEarned > 0) {
                rewardTransactions.push({
                    id: 'reward_' + Date.now() + '_earn',
                    date: new Date().toISOString(),
                    memberId: window.checkoutData.member.id,
                    memberName: window.checkoutData.member.firstName + ' ' + window.checkoutData.member.lastName,
                    type: 'earned',
                    source: 'website',
                    description: 'Points earned from purchase',
                    points: pointsEarned,
                    balance: members[memberIndex]?.currentPoints || 0,
                    transactionId: transaction.id
                });
            }

            NewcoData.set('rewardsTransactions', rewardTransactions);
            
            // Clear cart
            cart = {
                items: [],
                subtotal: 0,
                tax: 0,
                total: 0
            };
            sessionStorage.removeItem('newco_cart');
            updateCartDisplay();
            
            // Close modal and show success
            closeCheckoutModal();

            notify.success(`Transaction ID: ${transaction.id}<br>${pointsEarned ? `You earned ${pointsEarned} loyalty points!` : ''}`, 'Order Placed Successfully!');
            
            // Refresh member info in header
            checkLoggedInMember();
        }

        // Debug function to check localStorage
        function debugStorage() {
            console.log('=== LOCALSTORAGE DEBUG ===');
            const vanguardKeys = Object.keys(localStorage).filter(k => k.startsWith('newco_'));
            console.log('Vanguard keys found:', vanguardKeys);
            
            vanguardKeys.forEach(key => {
                const value = localStorage.getItem(key);
                try {
                    const parsed = JSON.parse(value);
                    console.log(key + ':', parsed);
                } catch(e) {
                    console.log(key + ':', value);
                }
            });
            
            // Specifically check packages
            const packagesData = localStorage.getItem('newco_packages');
            if (packagesData) {
                const packages = JSON.parse(packagesData);
                notify.info(`Found ${packages.length} packages in localStorage.\n\nFirst package: ${packages[0]?.name || 'none'}\n\nCheck console for details.`);
            } else {
                notify.warning('No packages found in localStorage!\n\nMake sure to create packages in the admin panel first.');
            }
        }

        // Clear packages for testing
        function clearPackages() {
            notify.confirm('This will delete ALL packages. Are you sure?', () => {
                localStorage.removeItem('newco_packages');
                notify.info('Packages cleared from localStorage');
                location.reload();
            });
        }

        // Show transaction history
        window.showHistory = function() {
            const memberData = sessionStorage.getItem('newco_current_member');
            if (!memberData) {
                notify.info('Please login to view history');
                return;
            }
            
            const member = JSON.parse(memberData);
            const transactions = NewcoData.get('transactions') || [];
            const rewardTransactions = NewcoData.get('rewardsTransactions') || [];
            
            // Filter for this member's transactions
            const memberTransactions = transactions.filter(t => t.memberId === member.id);

            // Sort transactions by date (newest first)
            memberTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Build comprehensive points history from all sources
            const pointsHistory = [];
            
            // Points history now comes only from rewards transactions to avoid duplicates
            
            // Add points from rewards transactions
            const memberRewards = rewardTransactions.filter(t => t.memberId === member.id);
            memberRewards.forEach(r => {
                pointsHistory.push({
                    date: r.date,
                    description: r.description || 'Reward Activity',
                    points: r.points,
                    type: r.points > 0 ? 'earned' : 'used',
                    balance: r.balance
                });
            });
            
            // Sort by date (newest first)
            pointsHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const modal = document.createElement('div');
            modal.id = 'historyModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <button onclick="closeHistoryModal()" style="position: absolute; right: 1rem; top: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    
                    <h2 style="margin: 0 0 1.5rem 0; color: #333;">Transaction History</h2>
                    
                    <!-- Current Balance -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Current Balance</div>
                        <div style="font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0;">${(member.currentPoints || member.loyaltyPoints || 0).toLocaleString()} ${NewcoData.get('rewardsConfig')?.basicSettings?.pointsCurrencyName || 'Loyalty Points'}</div>
                    </div>
                    
                    <!-- Tabs -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid #eee;">
                        <button onclick="showHistoryTab('purchases')" id="purchasesTab" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid #6c5ce7; color: #6c5ce7; font-weight: 600; cursor: pointer;">Purchases</button>
                        <button onclick="showHistoryTab('points')" id="pointsTab" style="padding: 0.75rem 1.5rem; background: none; border: none; color: #666; cursor: pointer;">${NewcoData.get('rewardsConfig')?.basicSettings?.pointsCurrencyName || 'Loyalty Points'} History</button>
                    </div>
                    
                    <!-- Purchases Tab -->
                    <div id="purchasesContent">
                        ${memberTransactions.length === 0 ? 
                            '<p style="text-align: center; color: #999; padding: 2rem;">No purchases yet</p>' :
                            memberTransactions.map(t => `
                                <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <div>
                                            <strong>Order #${t.id}</strong>
                                            <div style="color: #666; font-size: 0.875rem;">${new Date(t.date).toLocaleDateString()} ${new Date(t.date).toLocaleTimeString()}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 1.25rem; font-weight: bold; color: #333;">$${(t.finalTotal || t.total).toFixed(2)}</div>
                                            ${t.loyaltyPointsUsed > 0 ? `<div style="color: #e74c3c; font-size: 0.875rem;">-${t.loyaltyPointsUsed} pts used</div>` : ''}
                                        </div>
                                    </div>
                                    <div style="border-top: 1px solid #ddd; padding-top: 0.5rem; margin-top: 0.5rem;">
                                        ${t.items.map(item => `
                                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #666;">
                                                <span>${item.name} x${item.quantity}</span>
                                                <span>$${(item.price * item.quantity).toFixed(2)}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${t.selectedSeats && Object.keys(t.selectedSeats).length > 0 ? `
                                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #ddd; font-size: 0.875rem; color: #666;">
                                            Seats: ${Object.values(t.selectedSeats).flat().join(', ')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')
                        }
                    </div>
                    
                    <!-- Points History Tab (hidden initially) -->
                    <div id="pointsContent" style="display: none;">
                        ${pointsHistory.length === 0 ? 
                            '<p style="text-align: center; color: #999; padding: 2rem;">No points activity yet</p>' :
                            pointsHistory.map(p => `
                                <div style="display: flex; justify-content: space-between; padding: 1rem; border-bottom: 1px solid #eee;">
                                    <div>
                                        <div style="font-weight: 600;">${p.description}</div>
                                        <div style="color: #666; font-size: 0.875rem;">${new Date(p.date).toLocaleDateString()}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: ${p.points > 0 ? '#27ae60' : '#e74c3c'};">
                                            ${p.points > 0 ? '+' : ''}${p.points} pts
                                        </div>
                                        ${p.balance ? `<div style="color: #666; font-size: 0.875rem;">Balance: ${p.balance}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        window.closeHistoryModal = function() {
            const modal = document.getElementById('historyModal');
            if (modal) modal.remove();
        }
        
        window.showHistoryTab = function(tab) {
            if (tab === 'purchases') {
                document.getElementById('purchasesContent').style.display = 'block';
                document.getElementById('pointsContent').style.display = 'none';
                document.getElementById('purchasesTab').style.borderBottom = '3px solid #6c5ce7';
                document.getElementById('purchasesTab').style.color = '#6c5ce7';
                document.getElementById('pointsTab').style.borderBottom = 'none';
                document.getElementById('pointsTab').style.color = '#666';
            } else {
                document.getElementById('purchasesContent').style.display = 'none';
                document.getElementById('pointsContent').style.display = 'block';
                document.getElementById('pointsTab').style.borderBottom = '3px solid #6c5ce7';
                document.getElementById('pointsTab').style.color = '#6c5ce7';
                document.getElementById('purchasesTab').style.borderBottom = 'none';
                document.getElementById('purchasesTab').style.color = '#666';
            }
        }
        
        // Show rewards store
        window.showRewardsStore = function() {
            const memberData = sessionStorage.getItem('newco_current_member');
            if (!memberData) {
                notify.info('Please login to view rewards store');
                return;
            }
            
            const member = JSON.parse(memberData);
            // Get loyalty items (rewards) - changed from 'rewards' to 'loyaltyItems' to match admin
            let rewardsData = NewcoData.get('loyaltyItems');
            
            // Debug logging
            console.log('Raw rewards data:', rewardsData);
            
            // Handle various data types
            if (!rewardsData) {
                rewardsData = [];
            } else if (typeof rewardsData === 'object' && !Array.isArray(rewardsData)) {
                // If it's an object with values, convert to array
                rewardsData = Object.values(rewardsData);
            }
            
            // Ensure it's an array
            const rewards = Array.isArray(rewardsData) ? rewardsData : [];

            // Normalize points field
            if (!member.currentPoints && member.loyaltyPoints !== undefined) {
                member.currentPoints = member.loyaltyPoints;
            }
            const points = member.currentPoints || member.loyaltyPoints || 0;

            const modal = document.createElement('div');
            modal.id = 'rewardsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column; position: relative;">
                    <button onclick="closeRewardsModal()" style="position: absolute; right: 1.5rem; top: 1.5rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; z-index: 1001;">&times;</button>

                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%); padding: 2rem; border-radius: 12px 12px 0 0;">
                        <h2 style="margin: 0; color: #333;">🎁 Rewards Store</h2>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.875rem; color: #666;">Your ${NewcoData.get('rewardsConfig')?.basicSettings?.pointsCurrencyName || 'Loyalty Points'} Balance</div>
                            <div style="font-size: 2.5rem; font-weight: bold; color: #333;">${points.toLocaleString()} ${NewcoData.get('rewardsConfig')?.basicSettings?.pointsCurrencyName || 'Loyalty Points'}</div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                        ${rewards.length === 0 ? `
                            <div style="text-align: center; padding: 4rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">🎁</div>
                                <h3 style="color: #666;">No Rewards Available</h3>
                                <p style="color: #999;">Check back soon for exciting rewards!</p>
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                                ${rewards.map(reward => {
                                    const canAfford = points >= reward.pointsCost;
                                    return `
                                        <div style="background: white; border: 2px solid ${canAfford ? '#e0e0e0' : '#ffebee'}; border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; position: relative; transition: transform 0.2s, box-shadow 0.2s;" 
                                             onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)';" 
                                             onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                            ${reward.featured ? '<span style="position: absolute; top: -10px; right: 10px; background: #ff4757; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">FEATURED</span>' : ''}
                                            
                                            <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">
                                                ${reward.icon || '🎁'}
                                            </div>
                                            
                                            <h3 style="margin: 0 0 0.5rem 0; color: #333;">${reward.name}</h3>
                                            <p style="color: #666; font-size: 0.875rem; flex: 1;">${reward.description || 'Amazing reward waiting for you!'}</p>
                                            
                                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                                    <span style="font-weight: bold; color: #6c5ce7; font-size: 1.25rem;">${reward.pointsCost} pts</span>
                                                </div>
                                                
                                                <button 
                                                    onclick="${canAfford ? `redeemReward('${reward.id}')` : ''}"
                                                    style="width: 100%; padding: 0.75rem; background: ${canAfford ? '#6c5ce7' : '#ccc'}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: ${canAfford ? 'pointer' : 'not-allowed'};"
                                                    ${!canAfford ? 'disabled' : ''}>
                                                    ${canAfford ? 'Redeem' : `Need ${reward.pointsCost - member.currentPoints} more pts`}
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        window.closeRewardsModal = function() {
            const modal = document.getElementById('rewardsModal');
            if (modal) modal.remove();
        }
        
        window.redeemReward = function(rewardId) {
            const memberData = sessionStorage.getItem('newco_current_member');
            if (!memberData) return;
            
            const member = JSON.parse(memberData);
            const rewards = NewcoData.get('loyaltyItems') || [];
            const reward = rewards.find(r => r.id === rewardId);
            
            if (!reward) {
                notify.error('Reward not found');
                return;
            }

            const memberPoints = member.currentPoints || member.loyaltyPoints || 0;
            if (memberPoints < reward.pointsCost) {
                notify.error('Insufficient points for this reward');
                return;
            }
            
            // Add reward to cart as a special item with 0 price (paid with points)
            const rewardItem = {
                id: reward.id,
                type: 'reward',
                name: `🎁 ${reward.name}`,
                price: 0, // Free in cart since paid with points
                quantity: 1,
                pointsCost: reward.pointsCost, // Track points used
                data: reward
            };
            
            // Check if already in cart
            const existingItem = cart.items.find(i => i.id === reward.id && i.type === 'reward');
            if (existingItem) {
                notify.warning('This reward is already in your cart');
                return;
            }
            
            // Deduct points immediately and add to cart
            cart.items.push(rewardItem);
            
            // Update member points locally (will be finalized at checkout)
            member.currentPoints -= reward.pointsCost;
            
            // Save updated member
            const members = NewcoData.get('members') || [];
            const memberIndex = members.findIndex(m => m.id === member.id);
            if (memberIndex !== -1) {
                members[memberIndex].loyaltyPoints = member.currentPoints;
                NewcoData.set('members', members);
            }
            
            sessionStorage.setItem('newco_current_member', JSON.stringify(member));
            
            // Create reward transaction for redemption
            const rewardTransactions = NewcoData.get('rewardsTransactions') || [];
            rewardTransactions.push({
                id: 'reward_redeem_' + Date.now(),
                date: new Date().toISOString(),
                memberId: member.id,
                memberName: member.firstName + ' ' + member.lastName,
                type: 'redeemed',
                source: 'website',
                description: `Redeemed: ${reward.name}`,
                points: -reward.pointsCost,
                balance: member.currentPoints,
                rewardId: reward.id,
                rewardName: reward.name
            });
            NewcoData.set('rewardsTransactions', rewardTransactions);
            
            updateCartDisplay();
            saveCartToSession();
            closeRewardsModal();
            
            notify.success(`${reward.name} added to cart!<br>${reward.pointsCost} points deducted from your balance.`);
            
            // Refresh member display
            checkLoggedInMember();
        }
        
        // Check for logged in member on load
        function checkLoggedInMember() {
            const memberData = sessionStorage.getItem('newco_current_member');
            if (memberData) {
                try {
                    const member = JSON.parse(memberData);
                    // Check if loyalty program is enabled
                    const rewards = NewcoData.get('rewards') || {};
                    const wizardData = NewcoData.get('wizardData') || {};
                    const loyaltyEnabled = rewards.enabled !== undefined ? rewards.enabled : (wizardData.rewards?.enabled !== undefined ? wizardData.rewards.enabled : true);

                    // Normalize points field - use loyaltyPoints if currentPoints not set
                    if (!member.currentPoints && member.loyaltyPoints !== undefined) {
                        member.currentPoints = member.loyaltyPoints;
                    }
                    const points = member.currentPoints || member.loyaltyPoints || 0;

                    // Build member info HTML with conditional loyalty points display
                    document.getElementById('memberInfo').innerHTML = `
                        <div style="display: flex; align-items: center; gap: 2rem;">
                            <span style="color: white; font-weight: 600; font-size: 1.1rem;">Welcome, ${member.firstName}!</span>
                            ${loyaltyEnabled ? `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);">
                                <span style="color: rgba(255,255,255,0.8); font-size: 0.875rem;">${NewcoData.get('rewardsConfig')?.basicSettings?.pointsCurrencyName || 'Loyalty Points'}:</span>
                                <span style="color: white; font-weight: 700; font-size: 1.1rem;">${points.toLocaleString()}</span>
                            </div>
                            ` : ''}
                        </div>
                        <button onclick="showHistory()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; margin: 0 0.5rem;">History</button>
                        ${loyaltyEnabled ? `<button onclick="showRewardsStore()" style="background: #ffc107; border: none; color: #333; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-weight: 600;">🎁 Store</button>` : ''}
                        <button onclick="logout()" style="background: white; border: 1px solid white; color: var(--primary-color, #6c5ce7); padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-weight: 500;">Logout</button>
                    `;
                } catch (e) {
                    console.error('Error loading member data:', e);
                    sessionStorage.removeItem('newco_current_member');
                }
            }
        }

        // Initialize on load
        // Global variable to store selected session
        let selectedSession = null;
        
        // ═══════════════════════════════════════════════════════════
        // [SESSION-DISPLAY] - Session Calendar & Management
        // ═══════════════════════════════════════════════════════════
        
        function loadSessions() {
            const halls = NewcoData.get('halls') || [];
            const schedules = NewcoData.get('schedules') || {};
            const schedule = NewcoData.get('schedule') || {}; // Support both singular and plural
            const sessionsData = NewcoData.get('sessions') || []; // Get session names
            const container = document.getElementById('sessionsGrid');

            console.log('loadSessions - halls:', halls);
            console.log('loadSessions - schedules:', schedules);
            console.log('loadSessions - schedule:', schedule);
            console.log('loadSessions - sessionsData:', sessionsData);

            // Create default Hall 1 if none exists
            if (halls.length === 0) {
                const defaultHall = {
                    id: 'hall-1',
                    name: 'Hall 1',
                    address: '',
                    capacity: 100,
                    layout: { rows: 10, cols: 10, cells: {} }
                };
                halls.push(defaultHall);
                NewcoData.set('halls', [defaultHall]);
            }

            // Get Hall 1 (first hall)
            const hall = halls[0];
            const hallSchedule = schedules[hall.id] || {};
            const globalWeekly = schedule.weekly || {};

            // Generate sessions from hall schedule
            const sessions = [];
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            days.forEach((day, index) => {
                let daySessions = hallSchedule[day] || globalWeekly[day];

                // Handle both single session (object) and multiple sessions (array)
                if (!daySessions) {
                    daySessions = {
                        open: ['wednesday', 'friday', 'saturday', 'sunday'].includes(day),
                        doors: '17:00',
                        early: '18:00',
                        regular: '18:30',
                        closing: '21:00'
                    };
                }

                // Convert to array if it's a single object
                let sessionsArray = Array.isArray(daySessions) ? daySessions : [daySessions];

                // If sessions come from JSON (have sessionId), ensure they have 'open' flag and populate sessionName
                sessionsArray = sessionsArray.map(s => {
                    if (s.sessionId && s.open === undefined) {
                        // Find session details from sessions table
                        const sessionData = sessionsData.find(sess => sess.id === s.sessionId);
                        return {
                            ...s,
                            open: true,
                            sessionName: sessionData ? sessionData.name : s.sessionName
                        };
                    }
                    return s;
                });

                // Create session for each time slot
                sessionsArray.forEach((daySchedule, sessionIndex) => {
                    if (daySchedule.open) {
                        const sessionSuffix = daySchedule.suffix ? `-${daySchedule.suffix}` : (sessionIndex > 0 ? `-${sessionIndex}` : '');

                        // Build session name - prefer sessionName, fallback to constructing from suffix
                        let sessionName;
                        if (daySchedule.sessionName) {
                            sessionName = daySchedule.sessionName;
                        } else if (daySchedule.suffix) {
                            sessionName = `${dayNames[index]} - ${daySchedule.suffix.charAt(0).toUpperCase() + daySchedule.suffix.slice(1)}`;
                        } else if (sessionIndex > 0) {
                            sessionName = `${dayNames[index]} - Session ${sessionIndex + 1}`;
                        } else {
                            sessionName = `${dayNames[index]} Session`;
                        }

                        const session = {
                            id: `${hall.id}-${day}${sessionSuffix}`,
                            name: sessionName,
                            hallId: hall.id,
                            hallName: hall.name,
                            day: dayNames[index],
                            suffix: daySchedule.suffix || null,
                            startTime: daySchedule.doors || daySchedule.startTime || '17:00',
                            endTime: daySchedule.closing || daySchedule.endTime || '21:00',
                            earlyBird: daySchedule.early || daySchedule.earlyBird || '18:00',
                            regularTime: daySchedule.regular || daySchedule.regularTime || '18:30'
                        };

                        console.log('Created session:', session);
                        sessions.push(session);
                    }
                });
            });
            
            if (sessions.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No sessions scheduled. Please configure the hall schedule in the admin panel.</p>';
                return;
            }
            
            container.innerHTML = sessions.map(session => {
                // Format times for display
                const formatTime = (time) => {
                    if (!time) return '';
                    const [hours, minutes] = time.split(':');
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    return `${displayHour}:${minutes} ${ampm}`;
                };
                
                return `
                    <div onclick="selectSession('${session.id}', ${JSON.stringify(session).replace(/"/g, '&quot;')})" style="
                        background: white;
                        border: 2px solid #e0e0e0;
                        border-radius: 12px;
                        padding: 1.5rem;
                        cursor: pointer;
                        transition: all 0.3s;
                        text-align: center;
                    " onmouseover="this.style.borderColor='#6c5ce7'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(108,92,231,0.2)';" 
                       onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform=''; this.style.boxShadow='';">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🎱</div>
                        <h3 style="margin: 0 0 0.5rem 0; color: #333;">${session.name}</h3>
                        <p style="margin: 0.25rem 0; color: #6c5ce7; font-weight: 600; font-size: 0.875rem;">📍 ${session.hallName || 'Hall 1'}</p>
                        <p style="margin: 0.25rem 0; color: #666; font-weight: 600;">${session.day}</p>
                        <p style="margin: 0.25rem 0; color: #999; font-size: 0.875rem;">
                            Doors: ${formatTime(session.startTime)} • Ends: ${formatTime(session.endTime)}
                        </p>
                        ${session.earlyBird ? `<p style="margin: 0.25rem 0; color: #27ae60; font-size: 0.75rem;">Early Bird: ${formatTime(session.earlyBird)}</p>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        window.selectSession = function(sessionId, sessionData) {
            // If sessionData is passed as string, parse it
            if (typeof sessionData === 'string') {
                selectedSession = JSON.parse(sessionData.replace(/&quot;/g, '"'));
            } else if (sessionData) {
                selectedSession = sessionData;
            } else {
                // Fallback - regenerate session from schedule
                const halls = NewcoData.get('halls') || [];
                const schedules = NewcoData.get('schedules') || {};
                const hall = halls[0];
                if (hall) {
                    // Parse sessionId: hall_id-day or hall_id-day-suffix
                    const parts = sessionId.split('-');
                    const day = parts[parts.length - 2]; // Second to last is always the day
                    const suffix = parts[parts.length - 1] !== day ? parts[parts.length - 1] : null;

                    let daySchedule = schedules[hall.id]?.[day];

                    // Handle array of sessions
                    if (Array.isArray(daySchedule)) {
                        // Find the specific session by suffix
                        daySchedule = daySchedule.find(s => s.suffix === suffix) || daySchedule[0];
                    }

                    if (daySchedule) {
                        selectedSession = {
                            id: sessionId,
                            hallId: hall.id,
                            hallName: hall.name,
                            day: day.charAt(0).toUpperCase() + day.slice(1),
                            suffix: daySchedule.suffix || null,
                            startTime: daySchedule.doors,
                            endTime: daySchedule.closing
                        };
                    }
                }
            }
            
            if (selectedSession) {
                // Clear cart if switching sessions or if this is first session selection
                if (!cart.sessionId || cart.sessionId !== selectedSession.id) {
                    if (cart.items.length > 0 && cart.sessionId) {
                        // Only confirm if there's an existing session with items
                        notify.confirm('Changing sessions will clear your cart. Continue?', () => {
                            // Continue with session change
                        }, () => {
                            return;
                        })
                    }
                    // Clear cart and reset with new session info
                    cart = {
                        sessionId: selectedSession.id,
                        sessionName: selectedSession.name || `${selectedSession.hallName} - ${selectedSession.day}`,
                        sessionDate: selectedSession.day, // Day of week (e.g., "Friday")
                        sessionTime: `${selectedSession.startTime} - ${selectedSession.endTime}`,
                        items: [],
                        subtotal: 0,
                        tax: 0,
                        total: 0
                    };
                    updateCartDisplay();
                    sessionStorage.setItem('newco_cart', JSON.stringify(cart));
                }
                
                // Update UI  
                document.getElementById('selectedSessionTitle').textContent = cart.sessionName;
                document.getElementById('selectedSessionDetails').textContent = 
                    `${selectedSession.date ? new Date(selectedSession.date).toLocaleDateString() : selectedSession.day} • ${cart.sessionTime}`;
                
                // Hide event selection, show package selection
                document.getElementById('eventSelection').style.display = 'none';
                document.getElementById('packageSelection').style.display = 'block';
                
                // Load filtered packages and items
                loadFilteredPackages();
                loadFilteredItems();
                
                // Save session to storage
                sessionStorage.setItem('selectedSession', JSON.stringify(selectedSession));
            }
        }
        
        window.changeSession = function() {
            // Clear cart when changing session
            cart = {
                sessionId: null,
                sessionName: null,
                sessionDate: null,
                sessionTime: null,
                items: [],
                subtotal: 0,
                tax: 0,
                total: 0
            };
            updateCartDisplay();
            sessionStorage.removeItem('newco_cart');
            
            document.getElementById('eventSelection').style.display = 'block';
            document.getElementById('packageSelection').style.display = 'none';
            selectedSession = null;
            sessionStorage.removeItem('selectedSession');
        }
        
        function loadFilteredPackages() {
            const packages = NewcoData.get('packages') || [];
            const salesItems = NewcoData.get('salesItems') || [];
            const container = document.getElementById('packagesGrid');
            
            // Filter packages based on selected session
            const filteredPackages = packages.filter(pkg => {
                // Check validDays
                const packageDays = pkg.validDays || [];

                // If package has no day restrictions, it's always available
                if (!packageDays || packageDays.length === 0) {
                    // Unless it has a specific date requirement
                    if (pkg.dateEligibility && selectedSession.date !== pkg.dateEligibility) {
                        return false;
                    }
                    return true;
                }

                // If days are specified, only show on those specific days
                if (packageDays.length > 0) {
                    if (!selectedSession.day || !packageDays.includes(selectedSession.day.toLowerCase())) {
                        return false;
                    }
                }

                // Check specific date if set
                if (pkg.dateEligibility && selectedSession.date !== pkg.dateEligibility) {
                    return false;
                }

                return true;
            });
            
            if (filteredPackages.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No packages available for this session.</p>';
                return;
            }
            
            // Use existing package display logic with filtered packages
            loadPackagesWithData(filteredPackages, salesItems);
        }
        
        function loadFilteredItems() {
            const items = NewcoData.get('salesItems') || [];
            const container = document.getElementById('itemsGrid');
            
            // Filter items based on selected session
            const filteredItems = items.filter(item => {
                // If item has no eligibility settings (no days checked), it's always available
                if (!item.dayEligibility || item.dayEligibility.length === 0) {
                    // Unless it has a specific date requirement
                    if (item.dateEligibility && selectedSession.date !== item.dateEligibility) {
                        return false;
                    }
                    return true;
                }
                
                // If days are checked, only show on those specific days
                if (item.dayEligibility && item.dayEligibility.length > 0) {
                    if (!selectedSession.day || !item.dayEligibility.includes(selectedSession.day)) {
                        return false;
                    }
                }
                
                // Check specific date if set
                if (item.dateEligibility && selectedSession.date !== item.dateEligibility) {
                    return false;
                }
                
                return true;
            });
            
            if (filteredItems.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No additional items available for this session.</p>';
                return;
            }
            
            // Use existing item display logic with filtered items
            loadItemsWithData(filteredItems);
        }
        
        function loadPackagesWithData(packages, salesItems) {
            const container = document.getElementById('packagesGrid');
            
            container.innerHTML = packages.map(pkg => {
                // Build items list - handle both new schema (objects) and legacy (IDs)
                let itemsList = '';
                if (pkg.items && pkg.items.length > 0) {
                    itemsList = pkg.items.map(item => {
                        // Handle new schema: items are objects with {itemId, itemName, quantity}
                        if (typeof item === 'object' && item.itemName) {
                            return `<li>${item.itemName}${item.quantity > 1 ? ' x' + item.quantity : ''}</li>`;
                        }
                        // Legacy: items are strings (IDs)
                        const salesItem = salesItems.find(si => si.id === item);
                        return salesItem ? `<li>${salesItem.name}</li>` : `<li>${item}</li>`;
                    }).join('');
                }
                
                if (pkg.customItems && pkg.customItems.trim()) {
                    itemsList += `<li>${pkg.customItems}</li>`;
                }
                
                return `
                    <div class="package-card">
                        ${pkg.bestValue ? '<span class="best-value-badge">BEST VALUE</span>' : ''}
                        <div style="flex: 0;">
                            <div class="package-name">${pkg.name}</div>
                            <div class="package-price">$${pkg.price.toFixed(2)}</div>
                            ${pkg.description ? `<div class="package-description">${pkg.description}</div>` : ''}
                        </div>
                        <div class="package-items">
                            ${itemsList ? `<strong>Includes:</strong><ul>${itemsList}</ul>` : ''}
                        </div>
                        <div style="margin-top: auto;">
                            <button class="package-btn" onclick="addToCart('package', '${pkg.id}', '${pkg.name}', ${pkg.price}, ${pkg.seatSelection || false})">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadItemsWithData(items) {
            const container = document.getElementById('itemsGrid');
            
            container.innerHTML = items.map(item => `
                <div class="item-card">
                    <div style="flex: 0;">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">$${item.price ? item.price.toFixed(2) : 'Package Only'}</div>
                    </div>
                    <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        ${item.description ? `<div class="item-description">${item.description}</div>` : ''}
                    </div>
                    <div style="margin-top: auto;">
                        <button class="item-btn" onclick="addToCart('item', '${item.id}', '${item.name}', ${item.price})">
                            Add to Cart
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Social Media Button Functions
        function loadSocialMediaButton() {
            const settings = NewcoData.get('socialMediaSettings');

            if (!settings || !settings.enabled) {
                return;
            }

            const container = document.getElementById('socialMediaButton');
            if (!container) return;

            container.innerHTML = `
                <button onclick="showSocialMediaModal()" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.5);
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 0.9rem;
                    transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    ${settings.buttonText || '📱 GET UPDATES!'}
                </button>
            `;
            container.style.display = 'block';
        }

        // Welcome Popup Functions
        function showWelcomePopupIfNeeded() {
            const settings = NewcoData.get('welcomePopupSettings');

            if (!settings || !settings.enabled || !settings.image) return;

            // Check frequency setting
            const frequency = settings.frequency || 'once-per-session';
            const storageKey = 'bms_welcome_popup_shown';

            if (frequency === 'once-per-session') {
                if (sessionStorage.getItem(storageKey)) return;
                sessionStorage.setItem(storageKey, 'true');
            } else if (frequency === 'once-per-day') {
                const lastShown = localStorage.getItem(storageKey);
                const today = new Date().toDateString();
                if (lastShown === today) return;
                localStorage.setItem(storageKey, today);
            }
            // If frequency is 'every-visit', always show

            showWelcomePopupModal(settings);
        }

        function showWelcomePopupModal(settings) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const textPosition = settings.textPosition || 'bottom';
            let textOverlay = '';

            if (textPosition === 'bottom' && settings.message) {
                textOverlay = `
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 1.5rem; text-align: center; font-size: 1.25rem; font-weight: 600;">
                        ${settings.message}
                    </div>
                `;
            } else if (textPosition === 'diagonal' && settings.message) {
                textOverlay = `
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <div style="
                            transform: rotate(-25deg);
                            background: rgba(255,0,0,0.9);
                            color: white;
                            padding: 1.5rem 4rem;
                            font-size: 3rem;
                            font-weight: 900;
                            text-transform: uppercase;
                            letter-spacing: 0.1em;
                            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                            border: 4px solid white;
                            white-space: nowrap;
                            max-width: 90%;
                        ">
                            ${settings.message}
                        </div>
                    </div>
                `;
            }

            modal.innerHTML = `
                <div style="max-width: 800px; width: 90%; position: relative; cursor: default;">
                    <button onclick="event.stopPropagation(); this.closest('div[style*=fixed]').remove();" style="
                        position: absolute;
                        right: -10px;
                        top: -10px;
                        background: #dc3545;
                        border: 2px solid white;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        font-size: 1.5rem;
                        cursor: pointer;
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        font-weight: bold;
                        line-height: 1;
                        z-index: 1;
                    ">&times;</button>

                    <div style="position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                        <img src="${settings.image}" style="width: 100%; display: block; max-height: 600px; object-fit: contain; background: white;" />
                        ${textOverlay}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Auto-close after 3 seconds
            const autoCloseTimer = setTimeout(() => {
                modal.remove();
            }, 3000);

            // Close on click anywhere
            modal.addEventListener('click', (e) => {
                clearTimeout(autoCloseTimer);
                modal.remove();
            });

            // Stop propagation on content div to prevent immediate close when clicking image
            modal.querySelector('div[style*="max-width"]').addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    e.stopPropagation();
                    clearTimeout(autoCloseTimer);
                    modal.remove();
                }
            });
        }

        window.showSocialMediaModal = function() {
            const settings = NewcoData.get('socialMediaSettings');
            if (!settings) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; position: relative;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; right: 1rem; top: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>

                    <h2 style="margin: 0 0 1.5rem 0; color: #333;">${settings.modalTitle || 'GET UPDATES!'}</h2>

                    <div style="white-space: pre-line; line-height: 1.6; color: #666; margin-bottom: 1.5rem;">
                        ${settings.message || ''}
                    </div>

                    ${settings.smsKeyword && settings.smsNumber ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; color: white;">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Text this keyword:</div>
                            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">${settings.smsKeyword}</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">to</div>
                            <div style="font-size: 2rem; font-weight: bold;">${settings.smsNumber}</div>
                        </div>
                    ` : ''}

                    ${(settings.twitterLink || settings.facebookLink || settings.instagramLink) ? `
                        <div style="border-top: 1px solid #eee; padding-top: 1.5rem;">
                            <div style="font-size: 0.875rem; color: #999; margin-bottom: 1rem; text-align: center;">Follow us on social media:</div>
                            <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                                ${settings.twitterLink ? `<a href="${settings.twitterLink}" target="_blank" style="background: #1DA1F2; color: white; padding: 0.75rem 1.25rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.875rem;">🐦 Twitter/X</a>` : ''}
                                ${settings.facebookLink ? `<a href="${settings.facebookLink}" target="_blank" style="background: #4267B2; color: white; padding: 0.75rem 1.25rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.875rem;">📘 Facebook</a>` : ''}
                                ${settings.instagramLink ? `<a href="${settings.instagramLink}" target="_blank" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color: white; padding: 0.75rem 1.25rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.875rem;">📷 Instagram</a>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };

        // ═══════════════════════════════════════════════════════════════════
        // UNIFIED NOTIFICATION SYSTEM - Beautiful modals and toasts
        // ═══════════════════════════════════════════════════════════════════
        
        const notify = (function() {
            let stylesInitialized = false;
            
            function initStyles() {
                if (stylesInitialized) return;
                stylesInitialized = true;
                
                const styles = `
                    /* Modal Styles */
                    .notify-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.6);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: notifyFadeIn 0.2s ease-out;
                        backdrop-filter: blur(4px);
                    }
                    
                    .notify-modal {
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        max-width: 500px;
                        width: 90%;
                        max-height: 90vh;
                        overflow: hidden;
                        animation: notifySlideUp 0.3s ease-out;
                    }
                    
                    .notify-modal-header {
                        padding: 1.5rem;
                        border-bottom: 1px solid #e5e7eb;
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                    }
                    
                    .notify-modal-icon {
                        width: 24px;
                        height: 24px;
                        flex-shrink: 0;
                    }
                    
                    .notify-modal-title {
                        font-size: 1.25rem;
                        font-weight: 600;
                        color: #111827;
                        margin: 0;
                        flex: 1;
                    }
                    
                    .notify-modal-close {
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        color: #6b7280;
                        cursor: pointer;
                        padding: 0;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 6px;
                        transition: all 0.2s;
                    }
                    
                    .notify-modal-close:hover {
                        background: #f3f4f6;
                        color: #111827;
                    }
                    
                    .notify-modal-body {
                        padding: 1.5rem;
                        color: #4b5563;
                        line-height: 1.6;
                        max-height: 60vh;
                        overflow-y: auto;
                    }
                    
                    .notify-modal-footer {
                        padding: 1rem 1.5rem;
                        border-top: 1px solid #e5e7eb;
                        display: flex;
                        gap: 0.75rem;
                        justify-content: flex-end;
                    }
                    
                    .notify-btn {
                        padding: 0.625rem 1.25rem;
                        border-radius: 8px;
                        font-size: 0.875rem;
                        font-weight: 500;
                        border: none;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-family: inherit;
                    }
                    
                    .notify-btn-primary {
                        background: #6c5ce7;
                        color: white;
                    }
                    
                    .notify-btn-primary:hover {
                        background: #5a4fd8;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
                    }
                    
                    .notify-btn-secondary {
                        background: #f3f4f6;
                        color: #4b5563;
                    }
                    
                    .notify-btn-secondary:hover {
                        background: #e5e7eb;
                    }
                    
                    .notify-btn-danger {
                        background: #ef4444;
                        color: white;
                    }
                    
                    .notify-btn-danger:hover {
                        background: #dc2626;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                    }
                    
                    /* Toast Styles */
                    .notify-toast-container {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10001;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        pointer-events: none;
                    }
                    
                    .notify-toast {
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
                        padding: 1rem 1.25rem;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        min-width: 320px;
                        max-width: 420px;
                        animation: notifySlideIn 0.3s ease-out;
                        pointer-events: all;
                        border-left: 4px solid;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    
                    .notify-toast:hover {
                        transform: translateX(-5px);
                        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.18);
                    }
                    
                    .notify-toast.removing {
                        animation: notifySlideOut 0.3s ease-in;
                    }
                    
                    .notify-toast-success {
                        border-left-color: #10b981;
                    }
                    
                    .notify-toast-error {
                        border-left-color: #ef4444;
                    }
                    
                    .notify-toast-warning {
                        border-left-color: #f59e0b;
                    }
                    
                    .notify-toast-info {
                        border-left-color: #3b82f6;
                    }
                    
                    .notify-toast-icon {
                        width: 20px;
                        height: 20px;
                        flex-shrink: 0;
                    }
                    
                    .notify-toast-content {
                        flex: 1;
                    }
                    
                    .notify-toast-title {
                        font-weight: 600;
                        color: #111827;
                        margin-bottom: 0.125rem;
                        font-size: 0.95rem;
                    }
                    
                    .notify-toast-message {
                        color: #6b7280;
                        font-size: 0.875rem;
                        line-height: 1.4;
                    }
                    
                    .notify-toast-close {
                        width: 20px;
                        height: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #9ca3af;
                        cursor: pointer;
                        border-radius: 4px;
                        transition: all 0.2s;
                        flex-shrink: 0;
                    }
                    
                    .notify-toast-close:hover {
                        background: #f3f4f6;
                        color: #4b5563;
                    }
                    
                    /* Icons */
                    .notify-icon-success {
                        color: #10b981;
                    }
                    
                    .notify-icon-error {
                        color: #ef4444;
                    }
                    
                    .notify-icon-warning {
                        color: #f59e0b;
                    }
                    
                    .notify-icon-info {
                        color: #3b82f6;
                    }
                    
                    /* Animations */
                    @keyframes notifyFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes notifySlideUp {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    
                    @keyframes notifySlideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    @keyframes notifySlideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                    
                    /* Responsive */
                    @media (max-width: 640px) {
                        .notify-toast-container {
                            left: 10px;
                            right: 10px;
                            top: 10px;
                        }
                        
                        .notify-toast {
                            min-width: auto;
                            max-width: 100%;
                        }
                        
                        .notify-modal {
                            width: 95%;
                            margin: 1rem;
                        }
                    }
                `;
                
                const styleSheet = document.createElement('style');
                styleSheet.textContent = styles;
                document.head.appendChild(styleSheet);
            }
            
            // Icons as SVG strings
            const icons = {
                success: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
                error: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>',
                warning: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
                info: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>',
                close: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>'
            };
            
            let toastContainer = null;
            
            function getToastContainer() {
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'notify-toast-container';
                    document.body.appendChild(toastContainer);
                }
                return toastContainer;
            }
            
            function showToast(type, message, title = null, duration = 4000) {
                initStyles();
                
                const toast = document.createElement('div');
                toast.className = `notify-toast notify-toast-${type}`;
                
                const iconClass = `notify-icon-${type}`;
                const defaultTitles = {
                    success: 'Success',
                    error: 'Error',
                    warning: 'Warning',
                    info: 'Info'
                };
                
                toast.innerHTML = `
                    <div class="notify-toast-icon ${iconClass}">
                        ${icons[type]}
                    </div>
                    <div class="notify-toast-content">
                        ${title || defaultTitles[type] ? `<div class="notify-toast-title">${title || defaultTitles[type]}</div>` : ''}
                        <div class="notify-toast-message">${message}</div>
                    </div>
                    <div class="notify-toast-close">
                        ${icons.close}
                    </div>
                `;
                
                const container = getToastContainer();
                container.appendChild(toast);
                
                let removeTimeout;
                const removeToast = () => {
                    toast.classList.add('removing');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                };
                
                removeTimeout = setTimeout(removeToast, duration);
                
                toast.addEventListener('click', () => {
                    clearTimeout(removeTimeout);
                    removeToast();
                });
                
                return toast;
            }
            
            function showModal(options) {
                initStyles();
                
                const overlay = document.createElement('div');
                overlay.className = 'notify-overlay';
                
                const modal = document.createElement('div');
                modal.className = 'notify-modal';
                
                let modalHTML = '';
                
                if (options.title) {
                    const iconHTML = options.icon ? `
                        <div class="notify-modal-icon notify-icon-${options.type || 'info'}">
                            ${icons[options.type] || icons.info}
                        </div>
                    ` : '';
                    
                    modalHTML += `
                        <div class="notify-modal-header">
                            ${iconHTML}
                            <h2 class="notify-modal-title">${options.title}</h2>
                            ${options.closeButton !== false ? `
                                <button class="notify-modal-close">
                                    ${icons.close}
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                modalHTML += `
                    <div class="notify-modal-body">
                        ${options.content || options.message || ''}
                    </div>
                `;
                
                if (options.buttons || options.onConfirm) {
                    modalHTML += '<div class="notify-modal-footer">';
                    
                    if (options.buttons) {
                        options.buttons.forEach(button => {
                            modalHTML += `
                                <button class="notify-btn notify-btn-${button.type || 'secondary'}" 
                                        data-action="${button.action}">
                                    ${button.text}
                                </button>
                            `;
                        });
                    } else if (options.onConfirm) {
                        modalHTML += `
                            <button class="notify-btn notify-btn-secondary" data-action="cancel">
                                ${options.cancelText || 'Cancel'}
                            </button>
                            <button class="notify-btn notify-btn-${options.confirmType || 'primary'}" data-action="confirm">
                                ${options.confirmText || 'Confirm'}
                            </button>
                        `;
                    }
                    
                    modalHTML += '</div>';
                }
                
                modal.innerHTML = modalHTML;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                const closeModal = () => {
                    overlay.style.animation = 'notifyFadeIn 0.2s ease-out reverse';
                    modal.style.animation = 'notifySlideUp 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 200);
                };
                
                const closeBtn = modal.querySelector('.notify-modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeModal);
                }
                
                modal.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        
                        if (action === 'cancel') {
                            if (options.onCancel) options.onCancel();
                            closeModal();
                        } else if (action === 'confirm') {
                            if (options.onConfirm) options.onConfirm();
                            closeModal();
                        } else if (options.buttons) {
                            const button = options.buttons.find(b => b.action === action);
                            if (button && button.handler) {
                                button.handler();
                            }
                            if (button && button.close !== false) {
                                closeModal();
                            }
                        }
                    });
                });
                
                if (options.closeOnOverlay !== false) {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            closeModal();
                        }
                    });
                }
                
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                return { overlay, modal, close: closeModal };
            }
            
            return {
                success(message, title) {
                    return showToast('success', message, title);
                },
                
                error(message, title) {
                    return showToast('error', message, title);
                },
                
                warning(message, title) {
                    return showToast('warning', message, title);
                },
                
                info(message, title) {
                    return showToast('info', message, title);
                },
                
                toast(type, message, title, duration) {
                    return showToast(type, message, title, duration);
                },
                
                modal(options) {
                    return showModal(options);
                },
                
                confirm(message, onConfirm, onCancel, options = {}) {
                    return showModal({
                        title: options.title || 'Confirm',
                        message,
                        type: 'warning',
                        icon: true,
                        onConfirm,
                        onCancel,
                        confirmText: options.confirmText,
                        cancelText: options.cancelText,
                        confirmType: options.dangerous ? 'danger' : 'primary'
                    });
                },
                
                alert(message, title = 'Alert', type = 'info') {
                    return showModal({
                        title,
                        message,
                        type,
                        icon: true,
                        buttons: [
                            { text: 'OK', type: 'primary', action: 'ok' }
                        ]
                    });
                }
            };
        })();
        
        // Marketing Alerts System
        const MarketingAlerts = {
            enabled: false,
            timeOnScreen: 3000,
            delayBetween: 6000,
            currentIndex: 0,
            interval: null,
            customMessages: [],
            
            defaultMessages: [
                "Feel that tingle? Your winning moment is coming...",
                "The air is electric tonight - someone's life is about to change!",
                "That flutter in your chest? It's your lucky numbers calling",
                "Can you feel it? Tonight's energy is different",
                "Your heart knows before your mind - THIS is your night",
                "Something magical is about to happen...",
                "The next call could change everything",
                "Goosebumps? That's your fortune arriving",
                "Lightning strikes twice here - especially for you",
                "Your pulse quickens because winning is near",
                "You're not just a player, you're family here",
                "Where everybody knows your name and celebrates your wins",
                "This is YOUR place, YOUR people, YOUR moment",
                "Home is where your lucky seat is",
                "Together we win, together we celebrate",
                "Your bingo family is waiting for you",
                "Where strangers become sisters",
                "You belong here, among winners",
                "Your chair misses you when you're gone",
                "Friends who dab together, win together",
                "Swerte mo ngayong araw!",
                "Panalo ka na!",
                "Biyaya at saya dito",
                "Para sa iyo ang jackpot",
                "Pamilya, Pagkakaibigan, Panalo",
                "Maswerte ka, mahal",
                "Ang gabi mo ito!",
                "Salamat at swerte",
                "Tara na, panalo tayo!",
                "Dito ang swerte mo",
                "Remember your first big win? That feeling never gets old",
                "Just like grandma's kitchen - warm, welcoming, lucky",
                "Some things never change - friendship, laughter, and B-I-N-G-O",
                "The same lucky charm, the same lucky seat, brand new possibilities",
                "Where memories are made, one call at a time",
                "Like coming home to fortune",
                "Your comfort zone is a winning zone",
                "Familiar faces, extraordinary wins",
                "The good old days are happening right now",
                "Timeless joy, modern jackpots",
                "今天是你的幸运日",
                "好运来了",
                "福气满满",
                "大奖等着你",
                "恭喜发财",
                "幸运女神在这里",
                "今晚必胜",
                "财运亨通",
                "金玉满堂",
                "吉星高照",
                "Today, you write your own fortune",
                "Queens don't wait for luck - they create it",
                "Your moment. Your game. Your destiny.",
                "Strong women win big - and you're the strongest",
                "Fortune favors the bold - and darling, you're fearless",
                "You're not here by accident - you're here to win",
                "Powerful women play powerful games",
                "Your success story starts now",
                "Born to win, destined to celebrate",
                "Lady Luck? No - you make your own luck",
                "Every card holds a thousand possibilities",
                "Dreams don't have expiration dates",
                "One call away from changing everything",
                "Believe in magic - it happens here every day",
                "Your ship isn't coming in - it's already docked",
                "Hope has an address - you're sitting in it",
                "Where wishes become winning numbers",
                "Dreams come true, one ball at a time",
                "Your miracle is in tonight's lineup",
                "Faith, hope, and B-I-N-G-O",
                "Trust that feeling - your numbers are whispering",
                "Something special is in the air tonight...",
                "The universe is aligning - can you feel it?",
                "Your guardian angel has a winning number for you",
                "Listen to your heart - it knows which cards to choose",
                "The stars have spoken - tonight you shine",
                "Your sixth sense says 'stay for one more game'",
                "Fate brought you here for a reason",
                "The lucky spirits are dancing around you",
                "Your ancestors are smiling - they know what's coming",
                "Life's too short for ordinary - make it SPECTACULAR!",
                "Happiness isn't just winning - but winning sure helps!",
                "Where every small win feels like a million bucks",
                "The best therapy has daubers and friends",
                "Laughter, friendship, and jackpots - the perfect prescription",
                "Joy multiplied by jackpots equals tonight",
                "Celebrate like nobody's watching - win like everybody is",
                "Your smile is your lucky charm",
                "Dancing in your seat? That's the winning spirit!",
                "Pure joy has a sound - 'BINGO!'",
                "Lucky lady! Maswerte! 幸运!",
                "Tonight's the night - Ito na! 就是现在!",
                "Blessed and winning - Pinagpala - 有福气",
                "Family • Pamilya • 家人 • Fortune",
                "Your moment is NOW - Ngayon na! 现在!",
                "Over $1 million paid this year - you're next",
                "Where millionaires are made, one game at a time",
                "Your story is being written in winning numbers",
                "This feeling? It's called 'about to win big'",
                "Welcome home, winner - we've been expecting you"
            ],
            
            customMessages: [],
            
            init() {
                this.loadSettings();
                if (this.enabled) {
                    this.start();
                }
                
                // Add styles for flashy alerts
                const style = document.createElement('style');
                style.textContent = `
                    .flashy-alert {
                        position: fixed;
                        top: 20%;
                        left: 50%;
                        transform: translate(-50%, -50%) scale(0.9);
                        background: #1a1a2e;
                        color: #eee;
                        padding: 1rem 1.75rem;
                        border-radius: 8px;
                        border: 2px solid #f39c12;
                        box-shadow: 0 0 30px rgba(243, 156, 18, 0.5);
                        z-index: 9999;
                        opacity: 0;
                        transition: all 0.4s ease;
                        max-width: 500px;
                        min-width: 280px;
                        text-align: center;
                        pointer-events: none;
                    }
                    
                    .flashy-alert.active {
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1);
                    }
                    
                    .flashy-content {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .flashy-message {
                        font-size: 1.1rem;
                        font-weight: 600;
                        line-height: 1.5;
                    }
                `;
                document.head.appendChild(style);
            },
            
            loadSettings() {
                const settings = NewcoData.get('marketingAlerts') || {};
                this.enabled = settings.enabled === true; // Explicitly check for true
                this.timeOnScreen = settings.timeOnScreen || 3000;
                this.delayBetween = settings.delayBetween || 6000;
                
                // Use custom messages if configured, otherwise use defaults
                if (settings.messageSource === 'custom' && settings.customMessages && settings.customMessages.length > 0) {
                    this.customMessages = settings.customMessages;
                } else {
                    this.customMessages = []; // Will use defaultMessages
                }
            },
            
            start() {
                if (this.interval) {
                    clearInterval(this.interval);
                }
                
                // Show first message after delay
                setTimeout(() => {
                    this.showNextMessage();
                    
                    // Then repeat
                    this.interval = setInterval(() => {
                        this.showNextMessage();
                    }, this.timeOnScreen + this.delayBetween);
                }, this.delayBetween);
            },
            
            stop() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            },
            
            showNextMessage() {
                const messages = this.customMessages.length > 0 ? 
                    this.customMessages : this.defaultMessages;
                
                // Randomize message selection
                const randomIndex = Math.floor(Math.random() * messages.length);
                const message = messages[randomIndex];
                
                this.showFlashyAlert(message);
            },
            
            showFlashyAlert(message) {
                // Create flashy alert element
                const alert = document.createElement('div');
                alert.className = 'flashy-alert';
                alert.innerHTML = `
                    <div class="flashy-content">
                        <div class="flashy-message">${message}</div>
                    </div>
                `;
                
                document.body.appendChild(alert);
                
                // Animate in
                setTimeout(() => {
                    alert.classList.add('active');
                }, 100);
                
                // Remove after duration
                setTimeout(() => {
                    alert.classList.remove('active');
                    setTimeout(() => {
                        alert.remove();
                    }, 500);
                }, this.timeOnScreen);
            }
        };
        
        // Initialize marketing alerts when page loads
        document.addEventListener('DOMContentLoaded', () => {
            MarketingAlerts.init();
        });
    </script>
</body>
</html>