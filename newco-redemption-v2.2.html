<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewCo Apps - Redemption & Desktop</title>
    
    <!-- 
    ╔═══════════════════════════════════════════════════════════════════╗
    ║         NEWCO REDEMPTION - IN-STORE POS & REWARDS SYSTEM           ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║ FILE: newco-redemption.html                                         ║
    ║ PURPOSE: Staff-facing POS for in-person sales & redemptions      ║
    ╠═══════════════════════════════════════════════════════════════════╣
    ║                                                                   ║
    ║ FUNCTIONALITY:                                                    ║
    ║ • In-person package/session sales                                ║
    ║ • Points redemption for rewards                                  ║
    ║ • Hybrid payment (points + cash)                                 ║
    ║ • Member lookup via barcode/search                               ║
    ║ • Real-time seat selection                                       ║
    ║ • Receipt printing support                                       ║
    ║                                                                   ║
    ║ SYSTEM INTERCONNECTIONS:                                         ║
    ║ • READS FROM:                                                     ║
    ║   - newco_organization (settings, branding)                   ║
    ║   - newco_sessions (availability, pricing)                    ║
    ║   - newco_packages (products for sale)                        ║
    ║   - newco_members (points balance, history)                   ║
    ║   - newco_rewards (available rewards catalog)                 ║
    ║   - newco_halls (seat availability)                           ║
    ║                                                                   ║
    ║ • WRITES TO:                                                      ║
    ║   - newco_transactions (all sales records)                    ║
    ║   - newco_members (points deduction/addition)                 ║
    ║   - newco_sessions (seat reservations)                        ║
    ║                                                                   ║
    ║ • STAFF ACCESS:                                                   ║
    ║   - No login required (assumes staff terminal)                   ║
    ║   - All transactions tagged with terminal ID                     ║
    ║   - Manager functions via special keys                           ║
    ║                                                                   ║
    ║ KEY SECTIONS (use Ctrl+F):                                       ║
    ║ • [MEMBER-LOOKUP]   - Barcode scan & search                      ║
    ║ • [CART-MANAGEMENT] - Add/remove items                           ║
    ║ • [PAYMENT-CALC]    - Points/cash calculation                    ║
    ║ • [SEAT-PICKER]     - Interactive seat selection                 ║
    ║ • [RECEIPT-GEN]     - Receipt formatting                         ║
    ║ • [REWARDS-CATALOG] - Browse redeemable items                    ║
    ║                                                                   ║
    ║ TRANSACTION FLOW:                                                ║
    ║ 1. Scan/search member → Load balance                            ║
    ║ 2. Add items to cart (sessions/packages/rewards)                 ║
    ║ 3. Select seats if required                                      ║
    ║ 4. Choose payment method (cash/points/mixed)                     ║
    ║ 5. Complete sale → Update all systems                            ║
    ║                                                                   ║
    ║ INTEGRATIONS:                                                     ║
    ║ • Works alongside newco-floor-runner for cash rewards              ║
    ║ • Shares transaction format with newco-customer-demo               ║
    ║ • Uses same member database as all systems                       ║
    ║                                                                   ║
    ║ TECHNICAL NOTES:                                                 ║
    ║ • Transactions marked as source: 'floor'                         ║
    ║ • Points redemption creates negative point transaction           ║
    ║ • Supports offline mode with sync later                          ║
    ║ • Print CSS for receipt formatting                               ║
    ║                                                                   ║
    ║ DEPLOYMENT:                                                       ║
    ║ • Intended for tablet/desktop staff terminals                    ║
    ║ • Requires barcode scanner integration                           ║
    ║ • Should be on secure staff network only                         ║
    ╚═══════════════════════════════════════════════════════════════════╝
    -->
    <style>
        :root {
            /* Modern Color Palette */
            --primary: #7c3aed;
            --primary-light: #a78bfa;
            --primary-dark: #5b21b6;
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
            --danger: #ef4444;
            --pending: #ec4899;
            --dark: #1f2937;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            --gray-lighter: #f3f4f6;
            --light: #f9fafb;
            --white: #ffffff;

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-purple: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login Screen - Enhanced */
        .login-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: 100%;
            max-width: 420px;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .login-header h1 {
            font-size: 2.25rem;
            background: var(--gradient-purple);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .login-header p {
            color: var(--gray);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            background: var(--gradient-purple);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.0625rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        /* Main App */
        .app-container {
            display: none;
            width: 100vw;
            height: 100vh;
            background: var(--light);
            flex-direction: column;
        }

        .app-header {
            background: rgba(124, 58, 237, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .app-title h1 {
            font-size: 1.5rem;
            color: white;
        }

        .app-mode {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-details {
            text-align: right;
        }

        .user-role {
            font-weight: 600;
            color: white;
            font-size: 1rem;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }


        /* Main Content */
        .app-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Search Bar */
        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .search-input {
            padding: 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn-search {
            padding: 0.75rem 2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .payment-method-btn {
            flex: 1;
            padding: 1rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .payment-method-btn:hover {
            border-color: var(--primary);
        }
        
        .payment-method-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .member-result-card {
            padding: 1rem;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .member-result-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Transaction Cards */
        .transactions-grid {
            display: grid;
            gap: 1rem;
        }

        .transaction-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.5rem;
            align-items: center;
            transition: all 0.3s;
        }

        .transaction-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .status-indicator {
            width: 80px;
            padding: 0.5rem;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-purchased {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-received {
            background: #e8f5e9;
            color: #388e3c;
        }

        .transaction-details h3 {
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .transaction-meta {
            display: flex;
            gap: 2rem;
            color: var(--gray);
            font-size: 0.875rem;
        }

        .transaction-items {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .item-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .transaction-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn-action {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-receive {
            background: var(--success);
            color: white;
        }

        .btn-process {
            background: var(--primary);
            color: white;
        }

        .btn-cancel {
            background: white;
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        /* Create Transaction Form */
        .create-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        /* POS Package Grid - Enhanced */
        #packagesList button {
            background: white;
            border: 2px solid var(--gray-lighter);
            border-radius: 16px;
            padding: 1.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--dark);
            box-shadow: var(--shadow-sm);
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        #packagesList button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-purple);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        #packagesList button:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        #packagesList button:hover::before {
            opacity: 1;
        }

        #packagesList button:hover * {
            color: white;
            z-index: 1;
            position: relative;
        }

        #packagesList button:active {
            transform: translateY(-1px);
        }

        /* Cart Summary - Enhanced */
        #cartSummary {
            background: white;
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-lighter);
        }

        #cartSummary h3 {
            color: var(--dark);
            font-size: 1.125rem;
            margin-bottom: 1.25rem;
        }

        .cart-item {
            padding: 0.875rem;
            background: var(--gray-lighter);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .cart-item:hover {
            background: var(--gray-light);
            transform: translateX(4px);
        }

        /* Member Badge - Enhanced */
        #selectedMemberBadge, #guestModeBadge {
            background: var(--gradient-purple) !important;
            border-radius: 16px !important;
            box-shadow: var(--shadow-md) !important;
            animation: slideIn 0.3s ease !important;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Quick Sale Button - Enhanced */
        .quick-sale-btn {
            width: 100%;
            margin-bottom: 1.5rem;
            padding: 1.25rem 1.5rem;
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.0625rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .quick-sale-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .quick-sale-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
        }

        .quick-sale-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .quick-sale-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .quick-sale-icon {
            font-size: 1.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        /* Modal Styles - Enhanced */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 0;
            max-width: 480px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 2rem 2rem 1.5rem;
            border-bottom: 1px solid var(--gray-lighter);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.75rem;
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--gray-lighter);
            display: flex;
            gap: 1rem;
            background: var(--gray-lighter);
            border-radius: 0 0 24px 24px;
        }

        .btn-primary {
            flex: 1;
            padding: 1rem;
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            flex: 1;
            padding: 1rem;
            background: white;
            color: var(--gray);
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--gray-lighter);
            border-color: var(--gray);
        }

        .quick-sale-amount-input {
            font-size: 2rem !important;
            font-weight: 700 !important;
            text-align: center;
            color: var(--primary) !important;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .transaction-card {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .app-header {
                padding: 1rem;
            }

            .app-content {
                padding: 1rem;
            }

            /* Mobile POS - Touch friendly buttons */
            #packagesList {
                grid-template-columns: repeat(3, 1fr) !important;
            }

            #packagesList button {
                min-height: 100px !important;
                font-size: 1rem !important;
            }

            .payment-method-btn {
                padding: 1.25rem !important;
                font-size: 1.1rem !important;
            }
        }

        /* Print Receipt Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #receiptToPrint, #receiptToPrint * {
                visibility: visible;
            }
            #receiptToPrint {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
        }

        .receipt {
            font-family: 'Courier New', monospace;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .receipt-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .receipt-total {
            border-top: 2px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-header">
            <h1 id="orgName">NewCo Apps</h1>
            <p>Staff Portal</p>
        </div>
        
        <div class="error-message" id="loginError"></div>
        
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="text" class="form-input" id="username" placeholder="Enter your email address">
        </div>
        
        <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="password" placeholder="Enter your password">
            <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                If no password was set, use your email address
            </small>
        </div>
        
        <button class="btn" onclick="login()">Sign In</button>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appScreen">
        <!-- Header -->
        <div class="app-header">
            <div class="app-title">
                <h1 id="appOrgName">NewCo Apps</h1>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="app-mode" id="appModeLabel">Redemption</span>
                    <span id="modeBubble" onclick="toggleMode()" style="
                        background: rgba(255, 255, 255, 0.2);
                        color: white;
                        padding: 0.35rem 0.75rem;
                        border-radius: 12px;
                        font-size: 0.8rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                        border: 1px solid rgba(255, 255, 255, 0.3);
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                        Switch to Purchasing
                    </span>
                </div>
            </div>

            <div class="user-info">
                <div class="user-details">
                    <div class="user-role" id="userInfo">Admin</div>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="app-content">
            <!-- Create Transaction (Purchases Mode Only) -->
            <div class="create-section" id="createSection">
                <!-- Expandable Header Section -->
                <div style="margin-bottom: 1rem;">
                    <button onclick="toggleHeaderSection()" style="width: 100%; padding: 0.75rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; font-weight: 600; color: #333;">
                        <span>📊 Stats & Member Lookup</span>
                        <span id="headerToggleIcon">▼</span>
                    </button>
                </div>

                <!-- Collapsible Header Content -->
                <div id="headerSection" style="display: none; margin-bottom: 1.5rem;">
                    <!-- Stats -->
                    <div class="stats-grid" style="margin-bottom: 1.5rem;">
                        <div class="stat-card">
                            <div class="stat-label">Pending</div>
                            <div class="stat-value" id="pendingCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Purchased</div>
                            <div class="stat-value" id="purchasedCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Today's Received</div>
                            <div class="stat-value" id="receivedCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Value</div>
                            <div class="stat-value" id="totalValue">$0</div>
                        </div>
                    </div>

                    <!-- Transaction Search Bar -->
                    <div class="search-section" style="margin-bottom: 1.5rem;">
                        <div class="search-grid">
                            <input type="text" class="search-input" id="searchName" placeholder="Search by member name...">
                            <input type="text" class="search-input" id="searchId" placeholder="Transaction ID or scan barcode...">
                            <button class="btn-search" onclick="searchTransactions()">Search</button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <button class="btn" onclick="toggleMemberLookup()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); flex-shrink: 0;">
                            👤 Member Lookup
                        </button>
                        <div id="selectedMemberBadge" style="display: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; flex: 1; display: flex; align-items: center; gap: 1rem;">
                            <div>
                                <strong id="selectedMemberNameBadge"></strong>
                                <div style="font-size: 0.875rem; opacity: 0.9;" id="selectedMemberPointsBadge"></div>
                            </div>
                            <button onclick="clearSelectedMember()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">✕</button>
                        </div>
                    </div>

                    <!-- Member Search Section (Hidden by default) -->
                    <div class="search-section" id="memberSearchSection" style="display: none; margin-bottom: 1rem; padding: 1.5rem; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1rem 0;">Search for Member</h3>
                        <div class="search-grid">
                            <input type="text" class="search-input" id="memberSearchName" placeholder="Search by member name..." onkeypress="if(event.key==='Enter') searchMembersForPurchase()">
                            <input type="text" class="search-input" id="memberSearchId" placeholder="Member ID or scan barcode..." onkeypress="if(event.key==='Enter') searchMembersForPurchase()">
                            <button class="btn-search" onclick="searchMembersForPurchase()">Search</button>
                        </div>
                        <!-- Search Results -->
                        <div id="memberSearchResults" style="display: none; margin-top: 1rem;">
                            <div id="memberResultsList">
                                <!-- Results will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Two-Column Layout: Packages (Left) | Cart (Right) -->
                <div style="display: grid; grid-template-columns: 1fr 350px; gap: 1.5rem;">
                    <!-- Left Column: Packages & Items -->
                    <div>
                        <!-- Purchasing Options Grid (6x5) -->
                        <div id="purchasingGrid" style="margin-bottom: 1.5rem;">
                            <div id="packagesList" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem; max-width: 100%;">
                                <!-- Purchasing options will load here -->
                            </div>
                        </div>

                        <!-- Hidden: Sales Items (keeping for compatibility) -->
                        <div id="salesItems" style="display: none; margin: 2rem 0;">
                            <h2 style="margin-bottom: 1.5rem; color: #333; font-size: 1.75rem; font-weight: 600;">Additional Items</h2>
                            <div id="itemsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem;">
                                <!-- Items will load here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Cart Summary -->
                    <div id="cartSummary" style="padding: 1.5rem; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 1rem;">
                        <!-- Quick Sale Button -->
                        <button onclick="showQuickSaleModal()" class="quick-sale-btn">
                            <span class="quick-sale-icon">💵</span>
                            <span>Quick Sale</span>
                        </button>

                        <h3 style="margin: 0 0 1rem 0;">Cart Summary</h3>
                        <div id="cartItems" style="min-height: 50px;">
                            <p style="color: #999;">No items in cart</p>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">
                                <span>Total:</span>
                                <span id="cartTotal" style="color: #2ea3f2;">$0.00</span>
                            </div>

                            <!-- Payment Methods -->
                            <div style="margin: 1rem 0;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: #666;">Payment Method:</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="payment-method-btn active" data-method="cash" onclick="selectPaymentMethod('cash')" style="flex: 1; padding: 0.75rem; background: var(--success); color: white; border: 2px solid var(--success); border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                        💵 Cash
                                    </button>
                                    <button class="payment-method-btn" data-method="card" onclick="selectPaymentMethod('card')" style="flex: 1; padding: 0.75rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                        💳 Card
                                    </button>
                                    <button class="payment-method-btn" data-method="split" onclick="selectPaymentMethod('split')" style="flex: 1; padding: 0.75rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                        🔄 Split
                                    </button>
                                </div>
                            </div>

                            <!-- Split Payment Details (Hidden by default) -->
                            <div id="splitPaymentSection" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="display: block; font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">💵 Cash Amount:</label>
                                    <input type="number" id="cashAmount" step="0.01" min="0" value="0" onchange="updateSplitPayment()" style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                                </div>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="display: block; font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">💳 Card Amount:</label>
                                    <input type="number" id="cardAmount" step="0.01" min="0" value="0" readonly style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; background: #f0f0f0;">
                                </div>
                                <div id="splitPaymentWarning" style="display: none; color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem;">
                                    ⚠️ Cash + Card must equal total
                                </div>
                            </div>

                            <!-- Cash Received Calculator (for cash payments) -->
                            <div id="cashCalculator" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="display: block; font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">💵 Cash Received:</label>
                                    <input type="number" id="cashReceived" step="0.01" min="0" value="0" onchange="calculateChange()" style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: 600; color: #333; font-size: 1.1rem;">
                                    <span>Change:</span>
                                    <span id="changeAmount" style="color: var(--success);">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="checkoutAndPrint()" style="width: 100%; margin-top: 1.5rem; padding: 1rem; font-size: 1.1rem;" id="checkoutBtn">
                            💳 Complete & Print Receipt
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Section (for Redemption mode) -->
            <div class="search-section" id="transactionSearchSection" style="display: none;">
                <div class="search-grid">
                    <input type="text" class="search-input" id="searchNameRedemption" placeholder="Search by member name...">
                    <input type="text" class="search-input" id="searchIdRedemption" placeholder="Transaction ID or scan barcode...">
                    <button class="btn-search" onclick="searchTransactions()">Search</button>
                </div>
            </div>

            <!-- Transactions List -->
            <div class="transactions-grid" id="transactionsList">
                <div class="loading">Loading transactions...</div>
            </div>
        </div>
    </div>

    <!-- Quick Sale Modal - Enhanced -->
    <div id="quickSaleModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💵 Quick Sale</h2>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Item Description (Optional)</label>
                    <input type="text" id="quickSaleDescription" class="form-input" placeholder="e.g., Concessions, Misc Item">
                </div>

                <div class="form-group">
                    <label class="form-label">Amount ($) *</label>
                    <input type="number" id="quickSaleAmount" step="0.01" min="0.01" placeholder="0.00" class="form-input quick-sale-amount-input" autofocus>
                </div>
            </div>

            <div class="modal-footer">
                <button onclick="closeQuickSaleModal()" class="btn-secondary">
                    Cancel
                </button>
                <button onclick="addQuickSaleToCart()" class="btn-primary">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Receipt Template for Printing -->
    <div id="receiptToPrint" style="display: none;">
        <div class="receipt">
            <div class="receipt-header">
                <h2 id="receiptOrgName" style="margin: 0; font-size: 1.5em;">BINGO HALL</h2>
                <div id="receiptOrgAddress" style="font-size: 0.9em; margin: 5px 0;">123 Main St, City, ST 12345</div>
                <div id="receiptOrgPhone" style="font-size: 0.9em; margin: 5px 0;">(555) 123-4567</div>
            </div>
            <div style="margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Date:</span>
                    <span id="receiptDate"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Time:</span>
                    <span id="receiptTime"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Transaction:</span>
                    <span id="receiptTxnId"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Cashier:</span>
                    <span id="receiptCashier"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Customer:</span>
                    <span id="receiptCustomer"></span>
                </div>
            </div>
            <div style="border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px;">
                <div style="font-weight: bold; margin-bottom: 10px;">ITEMS:</div>
                <div id="receiptItems"></div>
            </div>
            <div style="border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Subtotal:</span>
                    <span id="receiptSubtotal"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0; font-weight: bold; font-size: 1.2em;">
                    <span>TOTAL:</span>
                    <span id="receiptTotal"></span>
                </div>
            </div>
            <div id="receiptPaymentDetails" style="border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px;">
                <!-- Payment method details will go here -->
            </div>
            <div id="receiptPointsSection" style="display: none; border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Points Earned:</span>
                    <span id="receiptPointsEarned"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>New Balance:</span>
                    <span id="receiptPointsBalance"></span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px; font-size: 0.9em;">
                <div>Thank you for your purchase!</div>
                <div style="margin-top: 10px;">Good Luck!</div>
            </div>
        </div>
    </div>

    <!-- Supabase NewcoData Integration -->
    <script src="newco-supabase.js"></script>

    <script>
        // Initialize NewcoData with customer ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const customer = urlParams.get('customer') || 'demo';

        // Initialize asynchronously and wait for it to complete
        (async () => {
            await NewcoData.init(customer);
            console.log('Redemption App initialized for:', customer);

            // Initialize master admin user if not exists
            const staff = NewcoData.get('staff') || [];
            const masterAdminExists = staff.some(s => s.role === 'master-admin');

            if (!masterAdminExists) {
                // Create initial master admin
                staff.push({
                    id: 'master_admin_' + Date.now(),
                    name: 'Master Admin',
                    email: 'admin@newco.com',
                    role: 'master-admin',
                    status: 'Active',
                    permissions: ['all'],
                    createdAt: new Date().toISOString(),
                    password: 'admin123'
                });
                NewcoData.set('staff', staff);
            }

            // Load app after data is ready
            checkForExistingSession();
        })();

        // Current user session
        let currentUser = null;
        let currentMode = 'redemption';

        // Check for existing session on load
        function checkForExistingSession() {
            // Check URL parameters for mode
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');

            // Set initial mode based on URL parameter
            if (modeParam === 'purchasing') {
                currentMode = 'purchasing';
            } else if (modeParam === 'redemption') {
                currentMode = 'redemption';
            }
            // Default to redemption if no mode specified

            // Load organization branding
            const org = NewcoData.get('organization') || {};
            if (org.name) {
                document.getElementById('orgName').textContent = org.name;
            }
            
            // Apply organization colors
            if (org.colors) {
                const root = document.documentElement;
                if (org.colors.primary) {
                    root.style.setProperty('--primary', org.colors.primary);
                    // Update gradient background
                    document.body.style.background = `linear-gradient(135deg, ${org.colors.primary} 0%, ${org.colors.secondary || org.colors.accent || '#764ba2'} 100%)`;
                }
                if (org.colors.secondary || org.colors.accent) {
                    root.style.setProperty('--primary-dark', org.colors.secondary || org.colors.accent);
                }
            }
            
            const session = sessionStorage.getItem('newco_app_user');
            if (session) {
                currentUser = JSON.parse(session);
                showApp();
            }
        };

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                showError('Please enter username/email and password');
                return;
            }

            // Get staff data
            const staff = NewcoData.get('staff') || [];

            // Get customer ID from URL to look up super admin from accounts table (single source of truth)
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer') || 'demo';

            console.log('Checking login for:', username);

            let user = null;
            let superAdmin = null;

            // Check newco_staff table for Master Portal Admin (like master portal does)
            try {
                const staffQueryUrl = `${NewcoData.supabaseUrl}/rest/v1/newco_staff?email=eq.${encodeURIComponent(username)}&select=*`;
                console.log('[DEBUG] Querying newco_staff table:', staffQueryUrl);
                console.log('[DEBUG] Email to search:', username);
                console.log('[DEBUG] Password hash (base64):', btoa(password));

                const staffResponse = await fetch(staffQueryUrl, {
                    headers: {
                        'apikey': NewcoData.supabaseKey,
                        'Authorization': `Bearer ${NewcoData.supabaseKey}`
                    }
                });

                console.log('[DEBUG] Response status:', staffResponse.status);
                const staffUsers = await staffResponse.json();
                console.log('[DEBUG] Staff users found:', staffUsers);

                if (staffUsers && staffUsers.length > 0) {
                    const staffUser = staffUsers[0];
                    console.log('Found staff user:', staffUser.email, 'Role:', staffUser.role);
                    console.log('[DEBUG] Staff user password_hash:', staffUser.password_hash);

                    // Verify password (base64 encoded like master portal)
                    const passwordHash = btoa(password);
                    console.log('[DEBUG] Comparing:', passwordHash, '===', staffUser.password_hash);

                    if (staffUser.password_hash === passwordHash) {
                        superAdmin = {
                            email: staffUser.email,
                            name: staffUser.name || staffUser.email.split('@')[0],
                            role: staffUser.role
                        };
                        console.log('✓ Staff user password verified');
                    } else {
                        console.log('✗ Staff user password incorrect');
                    }
                } else {
                    console.log('[DEBUG] No staff users found for email:', username);
                }
            } catch (err) {
                console.error('Error checking newco_staff:', err);
            }

            // If found in newco_staff, use that
            if (superAdmin) {
                user = {
                    email: superAdmin.email,
                    name: superAdmin.name || 'Administrator',
                    role: 'Admin', // Map to local role
                    username: superAdmin.email.split('@')[0]
                };
                console.log('Master Portal Admin login successful');
            }
            // Otherwise check staff array
            else {
                user = staff.find(u => {
                    if (u.email !== username) return false;
                    
                    // Check password - if no password field, use email as password
                    if (u.password) {
                        return u.password === password;
                    } else {
                        // No password set - use email as default password
                        return u.email === password;
                    }
                });
            }

            // Debug logging
            console.log('Login attempt:', {
                username,
                superAdminFound: !!superAdmin,
                superAdminEmail: superAdmin?.email,
                userFound: !!user,
                staffCount: staff.length
            });

            if (user) {
                console.log('✓ Login successful for:', user.email, 'Role:', user.role);

                // Update lastActive timestamp for this staff member
                if (user.email !== superAdmin?.email) {
                    // This is a regular staff member, update their lastActive
                    const staffIndex = staff.findIndex(s => s.email === user.email);
                    if (staffIndex !== -1) {
                        staff[staffIndex].lastActive = new Date().toISOString();
                        NewcoData.set('staff', staff);
                    }
                }

                // Check URL parameters for mode
                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode');

                // Check permissions based on mode
                const redemptionSettings = NewcoData.get('redemptionSettings') || {};
                const purchasingSettings = NewcoData.get('purchasingSettings') || {};
                
                // Define role hierarchy
                const roleHierarchy = {
                    'Cashier': 1,
                    'Staff': 2,
                    'Manager': 3,
                    'Admin': 4,
                    'Owner': 5
                };
                
                const userRoleLevel = roleHierarchy[user.role] || 0;
                
                // Check redemption permissions
                if (modeParam === 'redemption' && redemptionSettings.enabled) {
                    const requiredLevel = roleHierarchy[redemptionSettings.permissionLevel] || 2;
                    if (userRoleLevel < requiredLevel) {
                        showError(`Redemption requires ${redemptionSettings.permissionLevel} role or higher`);
                        return;
                    }
                }
                
                // Check purchasing permissions
                if (modeParam === 'purchasing' && purchasingSettings.enabled) {
                    const requiredLevel = roleHierarchy[purchasingSettings.permissionLevel] || 1;
                    if (userRoleLevel < requiredLevel) {
                        showError(`Purchasing requires ${purchasingSettings.permissionLevel} role or higher`);
                        return;
                    }
                }
                

                // Save session
                currentUser = user;
                sessionStorage.setItem('newco_app_user', JSON.stringify(user));
                
                // Show app
                showApp();
            } else {
                showError('Invalid username or password');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'flex';

            // Load organization info for app header
            const org = NewcoData.get('organization') || {};
            document.getElementById('appOrgName').textContent = org.name || 'NewCo Apps';

            // Apply organization color to header
            if (org.colors && org.colors.primary) {
                document.querySelector('.app-header').style.background = org.colors.primary;
            }

            // Update user info - combine username and role
            let displayName = currentUser.name || currentUser.username || currentUser.email;
            // If it's the admin and name is "Administrator", use email username instead
            if (currentUser.role === 'Admin' && displayName === 'Administrator' && currentUser.username) {
                displayName = currentUser.username;
            }
            document.getElementById('userInfo').textContent = `${displayName} • ${currentUser.role}`;

            // Check URL and feature settings for initial mode
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');
            const purchasingSettings = NewcoData.get('purchasingSettings') || {};
            const redemptionSettings = NewcoData.get('redemptionSettings') || {};

            // Show mode toggle only if both purchasing and redemption are enabled
            const bothEnabled = purchasingSettings.enabled && redemptionSettings.enabled;

            // Update mode label and bubble
            document.getElementById('appModeLabel').textContent =
                currentMode === 'redemption' ? 'Redemption' : 'Purchasing';

            // Show or hide mode toggle based on whether both features are enabled
            const modeBubble = document.getElementById('modeBubble');
            if (bothEnabled) {
                modeBubble.style.display = 'inline-block';
                modeBubble.textContent = currentMode === 'redemption' ? 'Switch to Purchasing' : 'Switch to Redemption';
            } else {
                modeBubble.style.display = 'none';
            }

            if (currentMode === 'purchasing') {
                document.getElementById('createSection').style.display = 'block';
                document.getElementById('transactionSearchSection').style.display = 'none';
                // Load packages immediately
                loadPackagesAndItems();
            } else {
                // Redemption mode
                document.getElementById('createSection').style.display = 'none';
                document.getElementById('transactionSearchSection').style.display = 'block';
                // Load transactions in redemption mode
                loadTransactions();
            }
        }
        
        function loadMembers() {
            const members = NewcoData.get('members') || [];
            const select = document.getElementById('createMember');
            
            if (select) {
                select.innerHTML = '<option value="">Select Member...</option>';
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.firstName} ${member.lastName} (${member.email})`;
                    select.appendChild(option);
                });
            }
        }

        function logout() {
            sessionStorage.removeItem('newco_app_user');
            currentUser = null;
            location.reload();
        }

        function toggleMode() {
            // Toggle between redemption and purchasing
            const newMode = currentMode === 'redemption' ? 'purchasing' : 'redemption';
            switchMode(newMode);
        }

        function switchMode(mode) {
            currentMode = mode;

            // Update mode label and bubble
            document.getElementById('appModeLabel').textContent =
                mode === 'redemption' ? 'Redemption' : 'Purchasing';

            // Only update bubble text, don't change visibility (set in showApp)
            const modeBubble = document.getElementById('modeBubble');
            if (modeBubble.style.display !== 'none') {
                modeBubble.textContent = mode === 'redemption' ? 'Switch to Purchasing' : 'Switch to Redemption';
            }

            // Show/hide sections based on mode
            const createSection = document.getElementById('createSection');
            const transactionSearchSection = document.getElementById('transactionSearchSection');

            if (mode === 'purchasing' || mode === 'desktop') {
                createSection.style.display = 'block';
                transactionSearchSection.style.display = 'none';
                // Load packages when switching to purchasing
                if (mode === 'purchasing') {
                    clearSelectedMember();
                    loadPackagesAndItems();
                }
            } else {
                createSection.style.display = 'none';
                transactionSearchSection.style.display = 'block';
            }

            // Only load transactions if in redemption mode
            if (mode === 'redemption') {
                loadTransactions();
            } else {
                // Clear transactions list in purchasing mode
                document.getElementById('transactionsList').innerHTML = '';
            }
        }

        function loadTransactions() {
            const transactions = NewcoData.get('transactions') || [];
            const container = document.getElementById('transactionsList');
            
            console.log('Loading transactions:', transactions.length, 'total');
            console.log('Current mode:', currentMode);
            
            // Filter based on mode
            let filtered = transactions;
            if (currentMode === 'redemption') {
                // Show Purchased and Pending only
                filtered = transactions.filter(t => 
                    t.status === 'Purchased' || t.status === 'Pending'
                );
            }
            
            // Sort by date
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update stats
            updateStats(transactions);
            
            // Display transactions
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No transactions to display</div>';
                return;
            }
            
            container.innerHTML = filtered.map(t => createTransactionCard(t)).join('');
        }

        function createTransactionCard(transaction) {
            // Handle old transactions with 'completed' status
            if (transaction.status === 'completed') {
                transaction.status = 'Received';
            }
            
            const statusClass = `status-${transaction.status.toLowerCase()}`;
            const date = new Date(transaction.date);
            
            let actions = '';
            if (transaction.status === 'Purchased') {
                actions = '<button class="btn-action btn-receive" onclick="markReceived(\'' + transaction.id + '\')">Mark Received</button>';
            } else if (transaction.status === 'Pending') {
                actions = `
                    <button class="btn-action btn-process" onclick="processCashPayment('${transaction.id}')">Process Payment</button>
                    <button class="btn-action btn-receive" onclick="markReceived('${transaction.id}')">Mark Received</button>
                `;
            }
            
            const items = transaction.items.map(item => 
                `<div class="item-line">
                    <span>${item.quantity}x ${item.name}</span>
                    <span>$${(item.price * item.quantity).toFixed(2)}</span>
                </div>`
            ).join('');
            
            return `
                <div class="transaction-card">
                    <div class="status-indicator ${statusClass}">
                        ${transaction.status}
                    </div>
                    
                    <div class="transaction-details">
                        <h3>${transaction.memberName || 'Guest'}</h3>
                        <div class="transaction-meta">
                            <span>ID: ${transaction.id}</span>
                            <span>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
                            <span>${transaction.paymentMethod?.toUpperCase() || 'CASH'}</span>
                            <span style="font-weight: 600;">$${transaction.finalTotal?.toFixed(2) || transaction.total?.toFixed(2)}</span>
                        </div>
                        <div class="transaction-items">
                            ${items}
                        </div>
                    </div>
                    
                    <div class="transaction-actions">
                        ${actions}
                    </div>
                </div>
            `;
        }

        function updateStats(transactions) {
            const today = new Date().toDateString();
            
            const pending = transactions.filter(t => t.status === 'Pending').length;
            const purchased = transactions.filter(t => t.status === 'Purchased').length;
            const received = transactions.filter(t => 
                t.status === 'Received' && 
                new Date(t.receivedDate || t.date).toDateString() === today
            ).length;
            
            const total = transactions.reduce((sum, t) => 
                sum + (t.finalTotal || t.total || 0), 0
            );
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('purchasedCount').textContent = purchased;
            document.getElementById('receivedCount').textContent = received;
            document.getElementById('totalValue').textContent = '$' + total.toFixed(2);
        }

        function markReceived(transactionId) {
            const transactions = NewcoData.get('transactions') || [];
            const index = transactions.findIndex(t => t.id === transactionId);
            
            if (index !== -1) {
                const memberName = transactions[index].memberName || 'Customer';
                transactions[index].status = 'Received';
                transactions[index].receivedDate = new Date().toISOString();
                transactions[index].receivedBy = currentUser.email || currentUser.username;
                
                NewcoData.set('transactions', transactions);
                loadTransactions();
                
                // Show success message
                showSuccessMessage(`✓ ${memberName}'s order marked as received`);
            }
        }
        
        function showSuccessMessage(message) {
            // Create or update success popup
            let popup = document.getElementById('successPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'successPopup';
                popup.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--success);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 9999;
                    font-weight: 500;
                    animation: slideIn 0.3s ease;
                `;
                document.body.appendChild(popup);
            }
            
            popup.textContent = message;
            popup.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        function processCashPayment(transactionId) {
            const transactions = NewcoData.get('transactions') || [];
            const index = transactions.findIndex(t => t.id === transactionId);
            
            if (index !== -1) {
                const memberName = transactions[index].memberName || 'Customer';
                transactions[index].status = 'Purchased';
                transactions[index].paidDate = new Date().toISOString();
                transactions[index].processedBy = currentUser.email || currentUser.username;
                
                NewcoData.set('transactions', transactions);
                loadTransactions();
                
                // Show success message
                showSuccessMessage(`✓ ${memberName}'s payment processed`);
            }
        }

        function searchTransactions() {
            const nameSearch = document.getElementById('searchName').value.toLowerCase();
            const idSearch = document.getElementById('searchId').value.toLowerCase();
            
            const transactions = NewcoData.get('transactions') || [];
            let filtered = transactions;
            
            if (nameSearch) {
                filtered = filtered.filter(t => 
                    t.memberName?.toLowerCase().includes(nameSearch)
                );
            }
            
            if (idSearch) {
                filtered = filtered.filter(t => 
                    t.id?.toLowerCase().includes(idSearch)
                );
            }
            
            // Apply mode filter
            if (currentMode === 'redemption') {
                filtered = filtered.filter(t => 
                    t.status === 'Purchased' || t.status === 'Pending'
                );
            }
            
            // Display results
            const container = document.getElementById('transactionsList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No transactions found</div>';
            } else {
                container.innerHTML = filtered.map(t => createTransactionCard(t)).join('');
            }
        }

        // Cart state for purchases mode
        let purchaseCart = {
            items: [],
            subtotal: 0
        };

        // Global variables for purchasing
        let selectedMember = null;
        let selectedPaymentMethod = 'cash';
        
        // ═══════════════════════════════════════════════════════════
        // [MEMBER-LOOKUP] - Barcode Scan & Member Search
        // ═══════════════════════════════════════════════════════════
        
        function searchMembersForPurchase() {
            const nameSearch = document.getElementById('memberSearchName').value.trim().toLowerCase();
            const idSearch = document.getElementById('memberSearchId').value.trim().toLowerCase();
            
            if (!nameSearch && !idSearch) {
                notify.error('Please enter a name or ID to search');
                return;
            }
            
            const members = NewcoData.get('members') || [];
            
            // Search by name, ID, or barcode
            const results = members.filter(member => {
                if (nameSearch) {
                    const fullName = `${member.firstName} ${member.lastName}`.toLowerCase();
                    if (!fullName.includes(nameSearch)) return false;
                }
                
                if (idSearch) {
                    const memberId = (member.id || '').toLowerCase();
                    const barcode = (member.barcode || '').toLowerCase();
                    const email = (member.email || '').toLowerCase();
                    
                    if (!memberId.includes(idSearch) && 
                        barcode !== idSearch && 
                        !email.includes(idSearch)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            displayMemberSearchResults(results);
        }
        
        function displayMemberSearchResults(results) {
            const resultsSection = document.getElementById('memberSearchResults');
            const resultsList = document.getElementById('memberResultsList');
            
            if (results.length === 0) {
                resultsList.innerHTML = '<div class="loading">No members found</div>';
                resultsSection.style.display = 'block';
            } else if (results.length === 1) {
                // Auto-select if only one result
                selectMember(results[0].id);
                resultsSection.style.display = 'none';
                return;
            } else {
                resultsList.innerHTML = results.map(member => `
                    <div class="transaction-card" onclick="selectMember('${member.id}')" style="cursor: pointer;">
                        <div class="transaction-header">
                            <div class="transaction-info">
                                <div class="transaction-id">${member.firstName} ${member.lastName}</div>
                                <div class="transaction-date">ID: ${member.id} • ${member.email || 'No email'}</div>
                            </div>
                            <div class="transaction-status">
                                <div style="font-size: 0.875rem; color: #666;">Loyalty Points</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary);">${(member.loyaltyPoints || 0).toLocaleString()}</div>
                            </div>
                        </div>
                        ${member.barcode ? `<div style="padding: 0.5rem 1rem; color: #666; font-size: 0.875rem;">Barcode: ${member.barcode}</div>` : ''}
                    </div>
                `).join('');
                resultsSection.style.display = 'block';
            }
        }
        
        function toggleHeaderSection() {
            const headerSection = document.getElementById('headerSection');
            const icon = document.getElementById('headerToggleIcon');
            if (headerSection.style.display === 'none') {
                headerSection.style.display = 'block';
                icon.textContent = '▲';
            } else {
                headerSection.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        function toggleMemberLookup() {
            const searchSection = document.getElementById('memberSearchSection');
            searchSection.style.display = searchSection.style.display === 'none' ? 'block' : 'none';
        }

        function selectMember(memberId) {
            const members = NewcoData.get('members') || [];

            // Always expect member ID as string
            selectedMember = members.find(m => m.id === memberId);

            if (!selectedMember) {
                showError('Member not found');
                return;
            }

            // Hide search section and show badge
            document.getElementById('memberSearchSection').style.display = 'none';
            document.getElementById('memberSearchResults').style.display = 'none';
            document.getElementById('selectedMemberBadge').style.display = 'flex';

            // Update badge
            document.getElementById('selectedMemberNameBadge').textContent = `${selectedMember.firstName} ${selectedMember.lastName}`;
            document.getElementById('selectedMemberPointsBadge').textContent = `${(selectedMember.loyaltyPoints || 0).toLocaleString()} points`;

            showSuccess('Member selected: ' + selectedMember.firstName + ' ' + selectedMember.lastName);
        }

        function clearSelectedMember() {
            selectedMember = null;
            document.getElementById('memberSearchSection').style.display = 'none';
            document.getElementById('selectedMemberBadge').style.display = 'none';
            document.getElementById('memberSearchName').value = '';
            document.getElementById('memberSearchId').value = '';
            document.getElementById('memberSearchResults').style.display = 'none';
            document.getElementById('memberResultsList').innerHTML = '';
        }
        
        // ═══════════════════════════════════════════════════════════
        // [PAYMENT-CALC] - Payment Method & Points Calculation
        // ═══════════════════════════════════════════════════════════

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;

            // Update button states
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#333';
                btn.style.borderColor = '#e0e0e0';
            });

            const activeBtn = document.querySelector(`.payment-method-btn[data-method="${method}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (method === 'cash') {
                    activeBtn.style.background = 'var(--success)';
                    activeBtn.style.color = 'white';
                    activeBtn.style.borderColor = 'var(--success)';
                } else if (method === 'card') {
                    activeBtn.style.background = 'var(--primary)';
                    activeBtn.style.color = 'white';
                    activeBtn.style.borderColor = 'var(--primary)';
                } else if (method === 'split') {
                    activeBtn.style.background = 'var(--warning)';
                    activeBtn.style.color = 'white';
                    activeBtn.style.borderColor = 'var(--warning)';
                }
            }

            // Show/hide relevant sections
            const splitSection = document.getElementById('splitPaymentSection');
            const cashSection = document.getElementById('cashCalculator');

            if (method === 'split') {
                splitSection.style.display = 'block';
                cashSection.style.display = 'none';
                // Initialize split amounts
                const total = purchaseCart.subtotal;
                document.getElementById('cashAmount').value = '0.00';
                document.getElementById('cardAmount').value = total.toFixed(2);
            } else if (method === 'cash') {
                splitSection.style.display = 'none';
                cashSection.style.display = 'block';
                document.getElementById('cashReceived').value = purchaseCart.subtotal.toFixed(2);
                calculateChange();
            } else {
                splitSection.style.display = 'none';
                cashSection.style.display = 'none';
            }
        }

        function updateSplitPayment() {
            const total = purchaseCart.subtotal;
            const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
            const cardAmount = total - cashAmount;

            document.getElementById('cardAmount').value = cardAmount.toFixed(2);

            // Show warning if amounts don't match total
            const warning = document.getElementById('splitPaymentWarning');
            if (Math.abs((cashAmount + cardAmount) - total) > 0.01) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        function calculateChange() {
            const total = purchaseCart.subtotal;
            const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
            const change = cashReceived - total;

            const changeEl = document.getElementById('changeAmount');
            if (change >= 0) {
                changeEl.textContent = '$' + change.toFixed(2);
                changeEl.style.color = 'var(--success)';
            } else {
                changeEl.textContent = '-$' + Math.abs(change).toFixed(2);
                changeEl.style.color = 'var(--danger)';
            }
        }
        
        function loadTodaySessionInfo() {
            const today = new Date();
            const dayName = today.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
            const schedules = NewcoData.get('schedules') || {};
            const halls = NewcoData.get('halls') || [];
            
            let sessionInfo = '';
            let hasSession = false;
            
            for (const hall of halls) {
                const hallSchedule = schedules[hall.id]?.[dayName];
                if (hallSchedule?.open) {
                    hasSession = true;
                    sessionInfo += `
                        <div style="margin-bottom: 0.5rem;">
                            <strong>${hall.name}</strong> - 
                            Doors: ${hallSchedule.doors || '5:00 PM'} | 
                            Early Bird: ${hallSchedule.early || '6:00 PM'} | 
                            Regular: ${hallSchedule.regular || '6:30 PM'}
                        </div>
                    `;
                }
            }
            
            const sessionDetails = document.getElementById('sessionDetails');
            if (!hasSession) {
                sessionDetails.innerHTML = '<span style="color: #dc2626;">No sessions scheduled for today</span>';
            } else {
                sessionDetails.innerHTML = sessionInfo;
            }
        }
        
        // ═══════════════════════════════════════════════════════════
        // [REWARDS-CATALOG] - Package & Rewards Display
        // ═══════════════════════════════════════════════════════════
        
        function loadPackagesAndItems() {
            // Load packages and sales items
            const packages = NewcoData.get('packages') || [];
            const salesItems = NewcoData.get('salesItems') || [];
            const packagesList = document.getElementById('packagesList');

            // Combine packages and sales items (up to 30 total)
            const allItems = [];

            // Add packages (only if they have valid prices)
            packages.forEach(pkg => {
                if (pkg.price != null && pkg.price !== undefined) {
                    allItems.push({
                        id: pkg.id,
                        type: 'package',
                        name: pkg.name,
                        price: parseFloat(pkg.price) || 0
                    });
                }
            });

            // Add sales items (only if they have valid prices)
            salesItems.forEach(item => {
                if (item.price != null && item.price !== undefined) {
                    allItems.push({
                        id: item.id,
                        type: 'item',
                        name: item.name,
                        price: parseFloat(item.price) || 0
                    });
                }
            });

            // Limit to 30 items
            const displayItems = allItems.slice(0, 30);

            // Color palette for top bars (matching reference image)
            const colors = [
                '#f39c12', // orange
                '#e74c3c', // pink/red
                '#e67e22', // coral
                '#9b59b6', // purple
                '#7f8c8d', // gray
                '#3498db'  // blue
            ];

            if (packagesList) {
                if (displayItems.length === 0) {
                    packagesList.innerHTML = '<div style="color: #666; grid-column: 1 / -1; text-align: center; padding: 2rem;">No packages or items available</div>';
                } else {
                    packagesList.innerHTML = displayItems.map((item, index) => {
                        const colorIndex = index % colors.length;
                        const barColor = colors[colorIndex];
                        const clickHandler = item.type === 'package'
                            ? `addPackageToCart('${item.id}')`
                            : `addItemToCart('${item.id}')`;

                        return `
                        <button onclick="${clickHandler}" style="
                            background: white;
                            border: 1px solid #e0e0e0;
                            border-radius: 6px;
                            padding: 0;
                            cursor: pointer;
                            transition: all 0.2s;
                            overflow: hidden;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 80px;
                            text-align: center;
                            position: relative;
                        " onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                            <div style="width: 100%; height: 6px; background: ${barColor}; position: absolute; top: 0; left: 0;"></div>
                            <div style="padding: 1rem 0.75rem; padding-top: 1.25rem; width: 100%;">
                                <div style="font-weight: 600; color: #333; font-size: 0.95rem; margin-bottom: 0.25rem; line-height: 1.2;">
                                    ${item.name}
                                </div>
                                <div style="font-weight: 700; color: #2c3e50; font-size: 0.9rem;">
                                    $${item.price.toFixed(2)}
                                </div>
                            </div>
                        </button>
                    `;
                    }).join('');
                }
            }
        }

        // ═══════════════════════════════════════════════════════════
        // [CART-MANAGEMENT] - Shopping Cart Operations
        // ═══════════════════════════════════════════════════════════
        
        function addPackageToCart(packageId) {
            const packages = NewcoData.get('packages') || [];
            const pkg = packages.find(p => p.id === packageId);
            if (pkg) {
                const existingItem = purchaseCart.items.find(i => i.id === packageId && i.type === 'package');
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    purchaseCart.items.push({
                        id: packageId,
                        type: 'package',
                        name: pkg.name,
                        price: pkg.price,
                        quantity: 1,
                        requiresSeat: pkg.seatSelection || false
                    });
                }
                updatePurchaseCartDisplay();
            }
        }

        function addItemToCart(itemId) {
            const salesItems = NewcoData.get('salesItems') || [];
            const item = salesItems.find(i => i.id === itemId);
            if (item) {
                const existingItem = purchaseCart.items.find(i => i.id === itemId && i.type === 'item');
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    purchaseCart.items.push({
                        id: itemId,
                        type: 'item',
                        name: item.name,
                        price: item.price,
                        quantity: 1
                    });
                }
                updatePurchaseCartDisplay();
            }
        }

        function updatePurchaseCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (purchaseCart.items.length === 0) {
                cartItems.innerHTML = '<p style="color: #999;">No items in cart</p>';
                purchaseCart.subtotal = 0;
                if (checkoutBtn) checkoutBtn.disabled = true;
            } else {
                purchaseCart.subtotal = 0;
                cartItems.innerHTML = purchaseCart.items.map(item => {
                    const itemTotal = item.price * item.quantity;
                    purchaseCart.subtotal += itemTotal;
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333;">${item.name}</div>
                                <div style="color: #666; font-size: 0.875rem; margin-top: 0.25rem;">${item.quantity}x @ $${item.price.toFixed(2)}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-weight: 600; color: #333;">$${itemTotal.toFixed(2)}</span>
                                <button onclick="removeFromPurchaseCart('${item.id}', '${item.type}')" style="background: #dc3545; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">× Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
                if (checkoutBtn) checkoutBtn.disabled = false;
            }
            
            cartTotal.textContent = `$${purchaseCart.subtotal.toFixed(2)}`;
        }

        function removeFromPurchaseCart(itemId, type) {
            purchaseCart.items = purchaseCart.items.filter(i => !(i.id === itemId && i.type === type));
            updatePurchaseCartDisplay();
        }

        // ═══════════════════════════════════════════════════════════
        // [QUICK-SALE] - Custom $ Amount Sales
        // ═══════════════════════════════════════════════════════════

        function showQuickSaleModal() {
            const modal = document.getElementById('quickSaleModal');
            modal.style.display = 'flex';

            // Clear previous values
            document.getElementById('quickSaleDescription').value = '';
            document.getElementById('quickSaleAmount').value = '';

            // Focus on amount field
            setTimeout(() => {
                document.getElementById('quickSaleAmount').focus();
            }, 100);
        }

        function closeQuickSaleModal() {
            document.getElementById('quickSaleModal').style.display = 'none';
        }

        function addQuickSaleToCart() {
            const description = document.getElementById('quickSaleDescription').value.trim() || 'Quick Sale';
            const amount = parseFloat(document.getElementById('quickSaleAmount').value);

            // Validate amount
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }

            // Add custom sale item to cart
            const quickSaleId = 'quicksale_' + Date.now();
            purchaseCart.items.push({
                id: quickSaleId,
                type: 'quicksale',
                name: description,
                price: amount,
                quantity: 1
            });

            updatePurchaseCartDisplay();
            closeQuickSaleModal();
            showSuccessMessage(`✓ Added ${description} - $${amount.toFixed(2)}`);
        }

        // Allow Enter key to submit in quick sale modal
        document.addEventListener('DOMContentLoaded', function() {
            const quickSaleAmount = document.getElementById('quickSaleAmount');
            if (quickSaleAmount) {
                quickSaleAmount.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addQuickSaleToCart();
                    }
                });
            }
        });

        // ═══════════════════════════════════════════════════════════
        // [PAYMENT-PROCESSOR] - Custom Payment Processor Integration
        // ═══════════════════════════════════════════════════════════

        /**
         * CUSTOM PAYMENT PROCESSOR INTEGRATION POINT
         *
         * This is the main entry point for your custom payment processor.
         * Replace the placeholder implementation below with your actual API calls.
         *
         * INTEGRATION REQUIREMENTS:
         *
         * 1. API ENDPOINT:
         *    - Replace PAYMENT_PROCESSOR_API_URL with your processor's endpoint
         *    - Add authentication headers/tokens as needed
         *
         * 2. REQUEST FORMAT:
         *    Your processor should receive:
         *    - amount: decimal (e.g., 25.50)
         *    - currency: string (e.g., "USD")
         *    - description: string (e.g., "POS Sale - Transaction TXN-123456")
         *    - metadata: object with transaction details
         *
         * 3. RESPONSE FORMAT:
         *    Your processor should return:
         *    {
         *      success: boolean,
         *      transactionId: string,
         *      amount: number,
         *      timestamp: ISO date string,
         *      last4: string (optional - last 4 of card),
         *      cardBrand: string (optional - Visa, MasterCard, etc.),
         *      authCode: string (optional - authorization code),
         *      errorMessage: string (if success = false)
         *    }
         *
         * 4. ERROR HANDLING:
         *    Handle these scenarios:
         *    - Network failures
         *    - Declined cards
         *    - Insufficient funds
         *    - Invalid card data
         *    - API timeouts
         */

        // Payment Processor Configuration
        const PAYMENT_CONFIG = {
            // TODO: Add your payment processor configuration
            apiUrl: 'https://your-payment-processor.com/api/v1/charge',
            apiKey: 'YOUR_API_KEY_HERE',
            merchantId: 'YOUR_MERCHANT_ID_HERE',
            timeout: 30000, // 30 seconds
            retryAttempts: 2
        };

        /**
         * Process Card Payment
         * @param {number} amount - Amount to charge in dollars
         * @param {object} metadata - Additional transaction data
         * @returns {Promise<object>} Payment result
         */
        async function processCardPayment(amount, metadata = {}) {
            console.log('[PAYMENT PROCESSOR] Initiating card payment:', {
                amount,
                metadata
            });

            // ============================================================
            // TODO: REPLACE THIS SECTION WITH YOUR ACTUAL API INTEGRATION
            // ============================================================

            try {
                // PLACEHOLDER IMPLEMENTATION - Replace with actual API call
                const response = await simulatePaymentProcessorAPI(amount, metadata);

                /*
                // EXAMPLE: Real payment processor integration
                const response = await fetch(PAYMENT_CONFIG.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${PAYMENT_CONFIG.apiKey}`,
                        'X-Merchant-ID': PAYMENT_CONFIG.merchantId
                    },
                    body: JSON.stringify({
                        amount: Math.round(amount * 100), // Convert to cents
                        currency: 'USD',
                        description: `POS Sale - ${metadata.transactionId || 'N/A'}`,
                        metadata: {
                            source: 'pos',
                            cashier: metadata.cashier || 'Unknown',
                            transactionId: metadata.transactionId,
                            customerId: metadata.customerId,
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Payment API error: ${response.status}`);
                }

                const data = await response.json();

                return {
                    success: data.status === 'approved' || data.success === true,
                    transactionId: data.transaction_id || data.id,
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    last4: data.card?.last4,
                    cardBrand: data.card?.brand,
                    authCode: data.authorization_code,
                    errorMessage: data.error_message
                };
                */

                return response;

            } catch (error) {
                console.error('[PAYMENT PROCESSOR] Error:', error);

                return {
                    success: false,
                    transactionId: null,
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    errorMessage: error.message || 'Payment processing failed'
                };
            }
        }

        /**
         * TEMPORARY PLACEHOLDER - Simulates payment processor API
         * DELETE THIS FUNCTION when implementing real payment processor
         */
        async function simulatePaymentProcessorAPI(amount, metadata) {
            console.log('[SIMULATOR] Simulating payment processor API call...');

            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Simulate 95% success rate for testing
            const isApproved = Math.random() > 0.05;

            if (isApproved) {
                return {
                    success: true,
                    transactionId: 'CARD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    last4: '4242',
                    cardBrand: 'Visa',
                    authCode: 'AUTH' + Math.floor(Math.random() * 999999)
                };
            } else {
                return {
                    success: false,
                    transactionId: null,
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    errorMessage: 'Card declined - Insufficient funds'
                };
            }
        }

        /**
         * Process Refund
         * @param {string} originalTransactionId - Original transaction ID to refund
         * @param {number} amount - Amount to refund
         * @returns {Promise<object>} Refund result
         */
        async function processRefund(originalTransactionId, amount) {
            console.log('[PAYMENT PROCESSOR] Processing refund:', {
                originalTransactionId,
                amount
            });

            // TODO: Implement refund API call
            // Similar structure to processCardPayment

            return {
                success: true,
                refundId: 'REFUND-' + Date.now(),
                originalTransactionId: originalTransactionId,
                amount: amount,
                timestamp: new Date().toISOString()
            };
        }

        /**
         * Void Transaction (same-day cancellation)
         * @param {string} transactionId - Transaction ID to void
         * @returns {Promise<object>} Void result
         */
        async function voidTransaction(transactionId) {
            console.log('[PAYMENT PROCESSOR] Voiding transaction:', transactionId);

            // TODO: Implement void API call

            return {
                success: true,
                voidId: 'VOID-' + Date.now(),
                originalTransactionId: transactionId,
                timestamp: new Date().toISOString()
            };
        }

        // ═══════════════════════════════════════════════════════════
        // [RECEIPT-GEN] - Transaction Processing & Receipt
        // ═══════════════════════════════════════════════════════════

        async function checkoutAndPrint() {
            // Validate cart
            if (purchaseCart.items.length === 0) {
                showError('Please add items to the cart');
                return;
            }

            // No validation needed - if no member, automatically treat as guest

            // Process payment based on method
            let paymentDetails = {};
            let paymentSuccess = false;

            try {
                // Create transaction ID early for payment processor metadata
                const transactionId = 'TXN-' + Date.now();

                if (selectedPaymentMethod === 'card') {
                    // Process card payment with metadata
                    const paymentMetadata = {
                        transactionId: transactionId,
                        cashier: currentUser.name || currentUser.email || currentUser.username,
                        customerId: selectedMember?.id || null,
                        customerName: selectedMember ? `${selectedMember.firstName} ${selectedMember.lastName}` : 'Guest',
                        itemCount: purchaseCart.items.length
                    };

                    const result = await processCardPayment(purchaseCart.subtotal, paymentMetadata);

                    if (result.success) {
                        paymentSuccess = true;
                        paymentDetails = {
                            method: 'card',
                            cardTransactionId: result.transactionId,
                            amount: purchaseCart.subtotal,
                            last4: result.last4,
                            cardBrand: result.cardBrand,
                            authCode: result.authCode
                        };
                    } else {
                        showError(result.errorMessage || 'Card payment failed');
                        return;
                    }
                } else if (selectedPaymentMethod === 'split') {
                    // Process split payment
                    const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
                    const cardAmount = parseFloat(document.getElementById('cardAmount').value) || 0;

                    // Validate split amounts
                    if (Math.abs((cashAmount + cardAmount) - purchaseCart.subtotal) > 0.01) {
                        showError('Split payment amounts must equal total');
                        return;
                    }

                    // Process card portion with metadata
                    if (cardAmount > 0) {
                        const paymentMetadata = {
                            transactionId: transactionId,
                            cashier: currentUser.name || currentUser.email || currentUser.username,
                            customerId: selectedMember?.id || null,
                            customerName: selectedMember ? `${selectedMember.firstName} ${selectedMember.lastName}` : 'Guest',
                            itemCount: purchaseCart.items.length,
                            paymentType: 'split'
                        };

                        const result = await processCardPayment(cardAmount, paymentMetadata);

                        if (!result.success) {
                            showError(result.errorMessage || 'Card payment failed');
                            return;
                        }
                        paymentDetails = {
                            method: 'split',
                            cashAmount: cashAmount,
                            cardAmount: cardAmount,
                            cardTransactionId: result.transactionId,
                            last4: result.last4,
                            cardBrand: result.cardBrand,
                            authCode: result.authCode
                        };
                    } else {
                        paymentDetails = {
                            method: 'split',
                            cashAmount: cashAmount,
                            cardAmount: 0
                        };
                    }
                    paymentSuccess = true;
                } else {
                    // Cash payment
                    paymentDetails = {
                        method: 'cash',
                        amount: purchaseCart.subtotal,
                        received: parseFloat(document.getElementById('cashReceived').value) || 0,
                        change: (parseFloat(document.getElementById('cashReceived').value) || 0) - purchaseCart.subtotal
                    };
                    paymentSuccess = true;
                }

                if (!paymentSuccess) {
                    showError('Payment processing failed');
                    return;
                }

                // Create transaction (use pre-generated ID)
                const transaction = {
                    id: transactionId,
                    date: new Date().toISOString(),
                    memberName: selectedMember ? `${selectedMember.firstName} ${selectedMember.lastName}` : 'Guest',
                    memberEmail: selectedMember?.email || null,
                    memberId: selectedMember?.id || null,
                    items: purchaseCart.items,
                    subtotal: purchaseCart.subtotal,
                    tax: 0,
                    finalTotal: purchaseCart.subtotal,
                    paymentMethod: selectedPaymentMethod,
                    paymentDetails: paymentDetails,
                    status: 'Received',
                    source: 'pos',
                    salesperson: currentUser.name || currentUser.email || currentUser.username,
                    loyaltyPointsEarned: 0
                };

                // Calculate loyalty points if member (not guest)
                if (selectedMember) {
                    const rewardsConfig = NewcoData.get('rewardsConfig') || {};
                    if (rewardsConfig.rewardType && rewardsConfig.basicSettings) {
                        const pointsPerDollar = rewardsConfig.basicSettings.floorPointsPerDollar || 10;
                        transaction.loyaltyPointsEarned = Math.floor(transaction.finalTotal * pointsPerDollar);

                        // Update member points
                        selectedMember.loyaltyPoints = (selectedMember.loyaltyPoints || 0) + transaction.loyaltyPointsEarned;
                        selectedMember.lifetimePoints = (selectedMember.lifetimePoints || 0) + transaction.loyaltyPointsEarned;

                        const members = NewcoData.get('members') || [];
                        const updatedMembers = members.map(m => m.id === selectedMember.id ? selectedMember : m);
                        NewcoData.set('members', updatedMembers);
                    }
                }

                // Save transaction
                const transactions = NewcoData.get('transactions') || [];
                transactions.push(transaction);
                NewcoData.set('transactions', transactions);

                // Generate and print receipt
                generateReceipt(transaction);

                // Print receipt
                setTimeout(() => {
                    window.print();
                }, 100);

                // Clear cart and reset
                purchaseCart = { items: [], subtotal: 0 };
                updatePurchaseCartDisplay();
                clearSelectedMember();
                selectedPaymentMethod = 'cash';
                selectPaymentMethod('cash');

                // Show success
                const customerName = selectedMember ? selectedMember.firstName + ' ' + selectedMember.lastName : 'Guest';
                showSuccessMessage(`✓ Sale completed for ${customerName}! Receipt printing...`);

            } catch (error) {
                console.error('Checkout error:', error);
                showError('Checkout failed: ' + error.message);
            }
        }

        function generateReceipt(transaction) {
            const org = NewcoData.get('organization') || {};

            // Fill in organization details
            document.getElementById('receiptOrgName').textContent = org.name || 'BINGO HALL';
            document.getElementById('receiptOrgAddress').textContent = org.address || '';
            document.getElementById('receiptOrgPhone').textContent = org.phone || '';

            // Fill in transaction details
            const date = new Date(transaction.date);
            document.getElementById('receiptDate').textContent = date.toLocaleDateString();
            document.getElementById('receiptTime').textContent = date.toLocaleTimeString();
            document.getElementById('receiptTxnId').textContent = transaction.id;
            document.getElementById('receiptCashier').textContent = transaction.salesperson || 'Staff';
            document.getElementById('receiptCustomer').textContent = transaction.memberName || 'Guest';

            // Fill in items
            const itemsHtml = transaction.items.map(item => `
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                    <span>${item.quantity}x ${item.name}</span>
                    <span>$${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('receiptItems').innerHTML = itemsHtml;

            // Fill in totals
            document.getElementById('receiptSubtotal').textContent = '$' + transaction.subtotal.toFixed(2);
            document.getElementById('receiptTotal').textContent = '$' + transaction.finalTotal.toFixed(2);

            // Fill in payment details
            let paymentHtml = '';
            if (transaction.paymentMethod === 'cash') {
                paymentHtml = `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Payment Method:</span>
                        <span>CASH</span>
                    </div>
                `;
                if (transaction.paymentDetails.change > 0) {
                    paymentHtml += `
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span>Cash Received:</span>
                            <span>$${transaction.paymentDetails.received.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span>Change:</span>
                            <span>$${transaction.paymentDetails.change.toFixed(2)}</span>
                        </div>
                    `;
                }
            } else if (transaction.paymentMethod === 'card') {
                paymentHtml = `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Payment Method:</span>
                        <span>CARD</span>
                    </div>
                    ${transaction.paymentDetails.cardBrand && transaction.paymentDetails.last4 ? `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Card:</span>
                        <span>${transaction.paymentDetails.cardBrand} ****${transaction.paymentDetails.last4}</span>
                    </div>
                    ` : ''}
                    ${transaction.paymentDetails.authCode ? `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Auth Code:</span>
                        <span>${transaction.paymentDetails.authCode}</span>
                    </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Transaction ID:</span>
                        <span style="font-size: 0.75em;">${transaction.paymentDetails.cardTransactionId}</span>
                    </div>
                `;
            } else if (transaction.paymentMethod === 'split') {
                paymentHtml = `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Payment Method:</span>
                        <span>SPLIT</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Cash:</span>
                        <span>$${transaction.paymentDetails.cashAmount.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Card:</span>
                        <span>$${transaction.paymentDetails.cardAmount.toFixed(2)}</span>
                    </div>
                    ${transaction.paymentDetails.cardBrand && transaction.paymentDetails.last4 ? `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Card Used:</span>
                        <span>${transaction.paymentDetails.cardBrand} ****${transaction.paymentDetails.last4}</span>
                    </div>
                    ` : ''}
                    ${transaction.paymentDetails.cardTransactionId ? `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Card Transaction:</span>
                        <span style="font-size: 0.75em;">${transaction.paymentDetails.cardTransactionId}</span>
                    </div>
                    ` : ''}
                `;
            }
            document.getElementById('receiptPaymentDetails').innerHTML = paymentHtml;

            // Fill in loyalty points (if applicable)
            if (transaction.loyaltyPointsEarned > 0) {
                document.getElementById('receiptPointsSection').style.display = 'block';
                document.getElementById('receiptPointsEarned').textContent = transaction.loyaltyPointsEarned.toLocaleString();
                document.getElementById('receiptPointsBalance').textContent = (selectedMember?.loyaltyPoints || 0).toLocaleString();
            } else {
                document.getElementById('receiptPointsSection').style.display = 'none';
            }
        }

        // Legacy function for compatibility
        function createTransaction() {
            checkoutAndPrint();
        }

        // Helper notification functions
        function showSuccess(message) {
            showSuccessMessage('✓ ' + message);
        }

        function showError(message) {
            let popup = document.getElementById('errorPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'errorPopup';
                popup.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--danger);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 9999;
                    font-weight: 500;
                    animation: slideIn 0.3s ease;
                `;
                document.body.appendChild(popup);
            }

            popup.textContent = '⚠️ ' + message;
            popup.style.display = 'block';

            // Auto-hide after 4 seconds
            setTimeout(() => {
                popup.style.display = 'none';
            }, 4000);
        }

        // Auto refresh every 30 seconds (only for redemption mode)
        setInterval(() => {
            if (currentUser && currentMode === 'redemption') {
                loadTransactions();
            }
        }, 30000);

        // Listen for Enter key on login
        document.getElementById('password')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Make functions available globally for onclick handlers
        window.selectMember = selectMember;
        window.clearSelectedMember = clearSelectedMember;
        window.selectPaymentMethod = selectPaymentMethod;
        window.updateSplitPayment = updateSplitPayment;
        window.calculateChange = calculateChange;
        window.searchMembersForPurchase = searchMembersForPurchase;
        window.addPackageToCart = addPackageToCart;
        window.addItemToCart = addItemToCart;
        window.removeFromPurchaseCart = removeFromPurchaseCart;
        window.showQuickSaleModal = showQuickSaleModal;
        window.closeQuickSaleModal = closeQuickSaleModal;
        window.addQuickSaleToCart = addQuickSaleToCart;
        window.createTransaction = createTransaction;
        window.checkoutAndPrint = checkoutAndPrint;
        window.searchTransactions = searchTransactions;
        window.switchMode = switchMode;
        window.toggleMode = toggleMode;
        window.toggleHeaderSection = toggleHeaderSection;
        window.toggleMemberLookup = toggleMemberLookup;
        window.logout = logout;
        window.markReceived = markReceived;
        window.processCashPayment = processCashPayment;
    </script>
</body>
</html>